rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Allow users to read basic info of other users (for messaging, etc.)
      allow read: if request.auth != null
        && resource.data.keys().hasOnly(['displayName', 'email', 'photoURL', 'accountType', 'isActive']);
    }

    // Students collection - students can read/write their own profile
    match /students/{studentId} {
      // Students can read and write their own profile
      allow read, write: if request.auth != null && request.auth.uid == studentId;

      // Allow counselors to read student profiles they're assigned to
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'counselor' &&
        resource.data.counselorId == request.auth.uid;

      // Allow parents to read their children's profiles
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'parent' &&
        resource.data.parentId == request.auth.uid;

      // Allow institutions to read basic student info for applications
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'institution' &&
        resource.data.keys().hasOnly(['firstName', 'lastName', 'email', 'educationLevel', 'interests', 'active']);

      // Create validation - students can create their own profile during onboarding
      allow create: if request.auth != null
        && request.auth.uid == studentId
        && validateStudentData(request.resource.data);

      // Update validation - students can update their own profile
      allow update: if request.auth != null
        && request.auth.uid == studentId
        && validateStudentUpdate(request.resource.data, resource.data);
    }

    // Applications collection
    match /applications/{applicationId} {
      // Students can read/write their own applications
      allow read, write: if request.auth != null && request.auth.uid == resource.data.studentId;
      
      // Institutions can read applications targeted to them
      allow read: if request.auth != null && request.auth.uid == resource.data.targetInstitutionId;
      
      // Counselors can read applications of their students
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(resource.data.studentId)) &&
        get(/databases/$(database)/documents/users/$(resource.data.studentId)).data.counselorId == request.auth.uid;
      
      // Parents can read applications of their children
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(resource.data.studentId)) &&
        get(/databases/$(database)/documents/users/$(resource.data.studentId)).data.parentId == request.auth.uid;

      // Create validation
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.studentId
        && validateApplicationData(request.resource.data);
        
      // Update validation
      allow update: if request.auth != null 
        && request.auth.uid == resource.data.studentId
        && validateApplicationUpdate(request.resource.data, resource.data);
    }

    // Programs collection
    match /programs/{programId} {
      // Anyone can read active programs
      allow read: if resource.data.isActive == true;
      
      // Institutions can manage their own programs
      allow read, write: if request.auth != null && request.auth.uid == resource.data.institutionId;
      
      // Create validation for institutions
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.institutionId
        && validateProgramData(request.resource.data);
    }

    // Messages collection
    match /messages/{messageId} {
      // Users can read messages sent to them or by them
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.recipientId);
      
      // Users can create messages (send)
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.senderId
        && validateMessageData(request.resource.data);
      
      // Users can update messages they received (mark as read)
      allow update: if request.auth != null 
        && request.auth.uid == resource.data.recipientId
        && validateMessageUpdate(request.resource.data, resource.data);
    }

    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Users can update their own notifications (mark as read)
      allow update: if request.auth != null 
        && request.auth.uid == resource.data.userId
        && validateNotificationUpdate(request.resource.data, resource.data);
      
      // System can create notifications (handled by Cloud Functions)
      allow create: if false; // Only Cloud Functions should create notifications
    }

    // Documents collection
    match /documents/{documentId} {
      // Users can read/write their own documents
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Allow institutions to read documents in applications they're reviewing
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/applications/$(resource.data.applicationId)) &&
        get(/databases/$(database)/documents/applications/$(resource.data.applicationId)).data.targetInstitutionId == request.auth.uid;

      // Create validation
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.userId
        && validateDocumentData(request.resource.data);
    }

    // Analytics collection (read-only for users)
    match /analytics/{analyticsId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Recommendation requests collection
    match /recommendation_requests/{requestId} {
      // Students can create and read their own requests
      allow read, write: if request.auth != null && request.auth.uid == resource.data.studentId;
      
      // Recommenders can read and update requests assigned to them
      allow read, update: if request.auth != null && request.auth.uid == resource.data.recommenderId;
      
      // Create validation
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.studentId
        && validateRecommendationRequest(request.resource.data);
    }

    // Global functions for validation
    function validateApplicationData(data) {
      return data.keys().hasAll(['studentId', 'targetInstitutionId', 'programId', 'status']) &&
        data.studentId is string &&
        data.targetInstitutionId is string &&
        data.programId is string &&
        data.status in ['draft', 'submitted', 'under_review', 'accepted', 'rejected'] &&
        data.createdAt == request.time &&
        data.updatedAt == request.time;
    }

    function validateApplicationUpdate(newData, oldData) {
      return newData.studentId == oldData.studentId &&
        newData.targetInstitutionId == oldData.targetInstitutionId &&
        newData.updatedAt == request.time;
    }

    function validateProgramData(data) {
      return data.keys().hasAll(['institutionId', 'name', 'isActive']) &&
        data.institutionId is string &&
        data.name is string &&
        data.isActive is bool &&
        data.createdAt == request.time &&
        data.updatedAt == request.time;
    }

    function validateMessageData(data) {
      return data.keys().hasAll(['senderId', 'recipientId', 'content', 'type', 'read']) &&
        data.senderId is string &&
        data.recipientId is string &&
        data.content is string &&
        data.type in ['text', 'file', 'system'] &&
        data.read == false &&
        data.createdAt == request.time;
    }

    function validateMessageUpdate(newData, oldData) {
      return newData.senderId == oldData.senderId &&
        newData.recipientId == oldData.recipientId &&
        newData.content == oldData.content &&
        (newData.read != oldData.read || newData.readAt != oldData.readAt);
    }

    function validateNotificationUpdate(newData, oldData) {
      return newData.userId == oldData.userId &&
        newData.title == oldData.title &&
        newData.message == oldData.message &&
        (newData.read != oldData.read || newData.readAt != oldData.readAt);
    }

    function validateDocumentData(data) {
      return data.keys().hasAll(['userId', 'fileName', 'storagePath', 'downloadURL']) &&
        data.userId is string &&
        data.fileName is string &&
        data.storagePath is string &&
        data.downloadURL is string &&
        data.createdAt == request.time &&
        data.updatedAt == request.time;
    }

    function validateRecommendationRequest(data) {
      return data.keys().hasAll(['studentId', 'recommenderId', 'status']) &&
        data.studentId is string &&
        data.recommenderId is string &&
        data.status in ['pending', 'accepted', 'completed', 'declined'] &&
        data.createdAt == request.time &&
        data.updatedAt == request.time;
    }

    function validateStudentData(data) {
      return data.keys().hasAll(['userId', 'email', 'userType']) &&
        data.userId is string &&
        data.email is string &&
        data.userType == 'student' &&
        data.userId == request.auth.uid &&
        // Optional fields validation
        ((!('firstName' in data)) || data.firstName is string) &&
        ((!('lastName' in data)) || data.lastName is string) &&
        ((!('dateOfBirth' in data)) || data.dateOfBirth is string) &&
        ((!('country' in data)) || data.country is string) &&
        ((!('city' in data)) || data.city is string) &&
        ((!('educationLevel' in data)) || data.educationLevel is string) &&
        ((!('interests' in data)) || data.interests is list) &&
        ((!('language' in data)) || data.language is string) &&
        ((!('active' in data)) || data.active is bool) &&
        ((!('onboardingComplete' in data)) || data.onboardingComplete is bool) &&
        ((!('profileComplete' in data)) || data.profileComplete is bool) &&
        ((!('emailVerified' in data)) || data.emailVerified is bool);
    }

    function validateStudentUpdate(newData, oldData) {
      return newData.userId == oldData.userId &&
        newData.email == oldData.email &&
        newData.userType == oldData.userType &&
        newData.userId == request.auth.uid;
    }
  }
}