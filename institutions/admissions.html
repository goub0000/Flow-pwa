<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admissions - Institution Portal | Flow</title>
  <meta name="description" content="Comprehensive admissions management and application processing through the institution portal.">


  <!-- Styles -->
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/institutions.css">

  <style>
    /* Prevent flash during state restoration */
    body.loading {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    body.loaded {
      opacity: 1;
    }

    /* Header Smaller Size and Blue Buttons */
    .header {
      padding: 0.8rem 0 !important;
    }

    .header:hover {
      padding: 1rem 0 !important;
    }

    /* Header Buttons - Blue Background with White Icons */
    .header-search__trigger,
    .header-notifications__trigger,
    .header-messages__trigger {
      background: #5a5bb8 !important;
      border-radius: 50% !important;
      padding: 0.75rem !important;
      border: none !important;
      transition: all 0.3s ease !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .header-search__trigger svg,
    .header-notifications__trigger svg,
    .header-messages__trigger svg {
      fill: white !important;
      stroke: white !important;
    }

    .header-search__trigger:hover,
    .header-notifications__trigger:hover,
    .header-messages__trigger:hover {
      background: #4c4db8 !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 12px rgba(76, 77, 184, 0.3) !important;
    }

    .header-profile__trigger,
    .header-mobile-toggle {
      color: #5a5bb8 !important;
    }

    .header-profile__trigger:hover,
    .header-mobile-toggle:hover {
      color: #4c4db8 !important;
    }

    /* Enhanced Navigation Styling */
    .nav-hover-item:hover {
      background: rgba(255, 255, 255, 0.15) !important;
      color: white !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
    }

    /* Enhanced Content Padding */
    .admissions-feature-card {
      padding: 2rem !important;
      margin: 1rem 0 !important;
      border-radius: 16px !important;
      transition: all 0.3s ease !important;
    }

    .admissions-feature-card:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 24px rgba(90, 91, 184, 0.15) !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .subnav {
        padding: 1.5rem 0 !important;
      }

      .subnav__inner {
        padding: 1rem 1.5rem !important;
        flex-direction: column !important;
        gap: 1rem !important;
      }

      .subnav__link {
        text-align: center !important;
        margin: 0 !important;
        padding: 1rem 1.5rem !important;
      }

      .container {
        padding: 0 1.5rem !important;
      }

      .section__header {
        padding: 1.5rem 0 2rem 0 !important;
        margin-bottom: 2rem !important;
      }

      .coming-soon {
        padding: 2rem 1.5rem !important;
        margin: 1rem 0 !important;
      }
    }
  </style>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/img/favicon.png" type="image/png">

</head>

<body class="loaded">
  <!-- Emergency cleanup script -->
  <script>
    (function() {
      // EMERGENCY: Clear all flash prevention and restore normal page
      console.log('üö® EMERGENCY CLEANUP: Restoring normal page functionality');

      // Remove any existing overlays
      const overlay = document.getElementById('immediateOverlay');
      if (overlay) overlay.remove();

      // Clear all inline styles
      document.body.style.cssText = '';
      document.documentElement.style.background = '';

      // Ensure page is visible
      document.body.style.visibility = 'visible';
      document.body.style.opacity = '1';

      // Clear flash prevention flags
      window.preventFlash = false;
      window.hasImmediateOverlay = false;

      console.log('‚úÖ Page restored to normal functionality');
    })();
  </script>

  <!-- Skip link for accessibility -->
  <a href="#main" class="skip-link">Skip to content</a>

  <!-- Toast notifications container -->
  <div id="toast-container" class="toast-container" aria-live="polite"></div>

  <!-- Site header -->
  <header class="header" role="banner" aria-label="Site header">
    <div class="container header__inner">
      <a class="brand" href="/" aria-label="Flow home">
        <img src="/assets/img/logo.PNG" class="brand__logo" alt="Flow logo" width="40" height="40" />
        <span class="brand__name">Flow</span>
      </a>

      <!-- Header Tools -->
      <div class="header-tools">
        <!-- Search -->
        <div class="header-search" id="headerSearch">
          <button class="header-search__trigger" id="searchTrigger" aria-label="Search">
            <svg width="20" height="20" fill="white">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="header-search__dropdown" id="searchDropdown" aria-hidden="true">
            <div class="search-box">
              <input type="search" id="globalSearch" placeholder="Search admissions, applications, workflows..." aria-label="Global search">
            </div>
            <div class="search-suggestions" id="searchSuggestions"></div>
          </div>
        </div>

        <!-- Notifications -->
        <div class="header-notifications" id="headerNotifications">
          <button class="header-notifications__trigger" id="notificationsTrigger" aria-label="Notifications">
            <svg width="20" height="20" fill="white">
              <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <span class="header-notifications__badge" id="notificationsBadge">3</span>
          </button>
          <div class="header-notifications__dropdown" id="notificationsDropdown" aria-hidden="true">
            <div class="notifications-header">
              <h3>Notifications</h3>
              <button class="btn btn--sm btn--ghost" onclick="markAllNotificationsRead()">Mark all read</button>
            </div>
            <div class="notifications-list">
              <div class="notification-item notification-item--unread" data-id="1">
                <div class="notification-icon notification-icon--urgent">üìã</div>
                <div class="notification-content">
                  <div class="notification-title">Application Deadline Approaching</div>
                  <div class="notification-message">Fall 2025 application deadline in 5 days</div>
                  <div class="notification-time">30 minutes ago</div>
                </div>
                <button class="notification-dismiss" onclick="dismissNotification('1')" aria-label="Dismiss">√ó</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Messages -->
        <div class="header-messages" id="headerMessages">
          <button class="header-messages__trigger" id="messagesTrigger" aria-label="Messages">
            <svg width="20" height="20" fill="white">
              <path d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            <span class="header-messages__badge" id="messagesBadge">1</span>
          </button>
          <div class="header-messages__dropdown" id="messagesDropdown" aria-hidden="true">
            <div class="messages-header">
              <h3>Recent Messages</h3>
              <button class="btn btn--sm btn--primary" onclick="composeMessage()">Compose</button>
            </div>
            <div class="messages-list" id="messagesList">
              <div class="message-item" data-id="1" onclick="markMessageRead('1')">
                <div class="message-avatar">
                  <div class="conversation-avatar-placeholder">RC</div>
                </div>
                <div class="message-content">
                  <div class="message-sender">Registrar's Office</div>
                  <div class="message-preview">Updated enrollment projections for next semester...</div>
                  <div class="message-time">45 minutes ago</div>
                </div>
                <div class="message-status"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Profile -->
        <div class="header-profile" id="headerProfile">
          <button class="header-profile__trigger" id="profileTrigger" aria-label="User menu" aria-expanded="false">
            <div class="profile-avatar">
              <img src="/assets/img/avatars/institution.jpg" alt="University of Excellence" width="32" height="32">
            </div>
            <div class="profile-info">
              <span class="profile-name" id="institutionName">Loading...</span>
              <span class="profile-role">Institution Admin</span>
            </div>
            <svg width="16" height="16" fill="white" class="profile-chevron">
              <path d="M4.646 4.646a.5.5 0 01.708 0L8 7.293l2.646-2.647a.5.5 0 01.708.708L8.707 8l2.647 2.646a.5.5 0 01-.708.708L8 8.707l-2.646 2.647a.5.5 0 01-.708-.708L7.293 8 4.646 5.354a.5.5 0 010-.708z"/>
            </svg>
          </button>
          <div class="header-profile__dropdown" id="profileDropdown" aria-hidden="true">
            <div class="profile-menu">
              <a href="/institutions/profile.html" class="profile-menu__item">
                <svg width="16" height="16" fill="white">
                  <path d="M8 8a3 3 0 100-6 3 3 0 000 6zM12.735 14c.618 0 1.093-.561.872-1.139a6.002 6.002 0 00-11.215 0c-.22.578.254 1.139.872 1.139h9.47z"/>
                </svg>
                Institution Profile
              </a>
              <a href="/institutions/settings.html" class="profile-menu__item">
                <svg width="16" height="16" fill="white">
                  <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 01-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 01.872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 012.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 012.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 01.872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 01-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 01-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 100-5.86 2.929 2.929 0 000 5.858z"/>
                </svg>
                Settings
              </a>
              <div class="profile-menu__divider"></div>
              <button class="profile-menu__item profile-menu__item--danger" onclick="signOut()">
                <svg width="16" height="16" fill="white">
                  <path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 11-2 0V4H5v8h10V9a1 1 0 112 0v3a1 1 0 01-1 1H4a1 1 0 01-1-1V3z"/>
                  <path d="M6 10a1 1 0 011-1h4a1 1 0 110 2H7a1 1 0 01-1-1z"/>
                </svg>
                Sign Out
              </button>
            </div>
          </div>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="header-mobile-toggle" id="mobileMenuToggle" aria-label="Toggle menu" aria-expanded="false">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay" aria-hidden="true">
      <div class="nav-overlay__content">
        <nav class="nav-overlay__menu">
          <a href="/institutions/" class="nav-overlay__link">Dashboard</a>
          <a href="/institutions/messages.html" class="nav-overlay__link">Messages</a>
          <a href="/institutions/programs.html" class="nav-overlay__link">Programs</a>
          <a href="/institutions/admissions.html" class="nav-overlay__link nav-overlay__link--active">Admissions</a>
          <a href="/institutions/reports.html" class="nav-overlay__link">Reports</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Sub-navigation -->
  <nav class="subnav" role="navigation" aria-label="Institution sections" style="background: #5a5bb8; padding: 2rem 0;">
    <div class="container">
      <div class="subnav__inner" style="padding: 1.5rem 3rem; border-radius: 16px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);">
        <a href="/institutions/" class="subnav__link nav-hover-item" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; color: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">Dashboard</a>
        <a href="/institutions/messages.html" class="subnav__link nav-hover-item" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; color: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">Messages</a>
        <a href="/institutions/programs.html" class="subnav__link nav-hover-item" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; color: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">Programs</a>
        <a href="/institutions/admissions.html" class="subnav__link subnav__link--active" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; background: rgba(255, 255, 255, 0.2); color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); font-weight: 600;">Admissions</a>
        <a href="/institutions/reports.html" class="subnav__link nav-hover-item" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; color: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">Reports</a>
      </div>
    </div>
  </nav>


  <!-- Main content -->
  <main id="main" role="main">
    <section class="section">
      <div class="container" style="padding: 0 3rem;">
        <div class="coming-soon" style="padding: 4rem 3rem; margin: 0; background: linear-gradient(135deg, rgba(90, 91, 184, 0.02), rgba(90, 91, 184, 0.05)); border: 2px solid rgba(90, 91, 184, 0.1); border-radius: 24px;">
          <div class="coming-soon__icon" style="padding: 1rem; margin-bottom: 2rem;">üìù</div>
          <h2 style="padding: 1.5rem 2rem; margin-bottom: 2rem; background: rgba(255, 255, 255, 0.8); border-radius: 16px; box-shadow: 0 4px 12px rgba(90, 91, 184, 0.1);">Admissions Management Tools</h2>
          <p style="padding: 2rem 2.5rem; margin-bottom: 3rem; background: rgba(255, 255, 255, 0.6); border-radius: 16px; font-size: 1.1rem; line-height: 1.8; border: 1px solid rgba(90, 91, 184, 0.1);">Your comprehensive admissions processing and management platform provides complete control over your admissions lifecycle. This powerful suite includes:</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin: 2rem 0;">
            <!-- Left Column -->
            <div>
              <div class="admissions-feature-card" onclick="openRoutingSystem()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(90, 91, 184, 0.08)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(90, 91, 184, 0.15)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
                <svg width="48" height="48" fill="white" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="2" y="4" width="28" height="20" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="M6 10h20M6 14h16M6 18h20" stroke="currentColor" stroke-width="1.5"/>
                  <circle cx="26" cy="10" r="3" fill="#3b82f6"/>
                  <path d="M24.5 10l1 1 2-2" stroke="white" stroke-width="1.5" fill="none"/>
                  <path d="M36 14l2 2 4-4" stroke="white" stroke-width="1.5" fill="none"/>
                  <rect x="6" y="36" width="36" height="6" fill="#e5e7eb" rx="2"/>
                  <rect x="8" y="38" width="16" height="2" fill="#5a5bb8"/>
                </svg>
                <div style="flex: 1;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; display: block;">Automated application processing and routing</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem; display: block;">Click to configure routing rules and auto-assignment</span>
                </div>
                <svg width="20" height="20" fill="#5a5bb8" style="margin-left: 1rem; opacity: 0.7;">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </div>

              <div class="admissions-feature-card" onclick="openInterviewSystem()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(90, 91, 184, 0.08)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(90, 91, 184, 0.15)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
                <svg width="48" height="48" fill="white" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="4" y="6" width="40" height="28" rx="3" fill="none" stroke="white" stroke-width="2"/>
                  <path d="M4 14h40M12 6v8M20 6v8M28 6v8M36 6v8"/>
                  <circle cx="14" cy="20" r="2" fill="#3b82f6"/>
                  <circle cx="22" cy="20" r="2" fill="#f59e0b"/>
                  <circle cx="30" cy="20" r="2" fill="#3b82f6"/>
                  <circle cx="14" cy="26" r="2" fill="#ef4444"/>
                  <circle cx="22" cy="26" r="2" fill="#3b82f6"/>
                  <path d="M38 18h4v4h-4z" fill="#3b82f6" opacity="0.7"/>
                  <path d="M38 24h4v4h-4z" fill="#f59e0b" opacity="0.7"/>
                </svg>
                <div style="flex: 1;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; display: block;">Interview scheduling and calendar management</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem; display: block;">Schedule interviews, manage calendars, and track attendance</span>
                </div>
                <svg width="20" height="20" fill="#5a5bb8" style="margin-left: 1rem; opacity: 0.7;">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </div>

              <div class="admissions-feature-card" onclick="openDecisionSystem()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(90, 91, 184, 0.08)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(90, 91, 184, 0.15)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
                <svg width="48" height="48" fill="white" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="6" y="6" width="36" height="36" rx="4" fill="none" stroke="white" stroke-width="2"/>
                  <path d="M18 22l4 4 8-8" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="38" cy="10" r="4" fill="#5a5bb8"/>
                  <circle cx="38" cy="20" r="3" fill="#f59e0b"/>
                  <circle cx="38" cy="30" r="3" fill="#ef4444"/>
                  <path d="M8 46h32v2H8z" fill="#5a5bb8" opacity="0.7"/>
                  <path d="M12 14h16v2H12z" fill="white" opacity="0.7"/>
                  <path d="M12 18h20v2H12z" fill="white" opacity="0.7"/>
                  <path d="M12 30h16v2H12z" fill="white" opacity="0.7"/>
                  <path d="M12 34h14v2H12z" fill="white" opacity="0.7"/>
                </svg>
                <div style="flex: 1;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; display: block;">Decision tracking and automated notifications</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem; display: block;">Manage admitted applicants through enrollment confirmation and waitlist workflows</span>
                </div>
                <svg width="20" height="20" fill="#5a5bb8" style="margin-left: 1rem; opacity: 0.7;">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </div>


              <div class="admissions-feature-card" onclick="openEnrollmentManagement()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(90, 91, 184, 0.08)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(90, 91, 184, 0.15)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
                <svg width="48" height="48" fill="white" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="6" y="8" width="36" height="28" rx="3" fill="none" stroke="white" stroke-width="2"/>
                  <path d="M12 14h24M12 18h20M12 22h16"/>
                  <circle cx="32" cy="14" r="8" fill="none" stroke="#3b82f6" stroke-width="2" stroke-dasharray="3,2"/>
                  <text x="32" y="18" text-anchor="middle" font-size="8" fill="#3b82f6" font-weight="bold">1</text>
                  <circle cx="32" cy="22" r="8" fill="none" stroke="#f59e0b" stroke-width="2" stroke-dasharray="3,2"/>
                  <text x="32" y="26" text-anchor="middle" font-size="8" fill="#f59e0b" font-weight="bold">W</text>
                </svg>
                <div style="flex: 1;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; display: block;">Enrollment management and waitlist handling</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem; display: block;">Track acceptance of offers, declines, and deferrals. Manage waitlists with ranking and auto-promotion</span>
                </div>
                <svg width="20" height="20" fill="#5a5bb8" style="margin-left: 1rem; opacity: 0.7;">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </div>
            </div>

            <!-- Right Column -->
            <div>
              <div class="admissions-feature-card" onclick="openEvaluationSystem()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(90, 91, 184, 0.08)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(90, 91, 184, 0.15)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
                <svg width="48" height="48" fill="white" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="4" y="6" width="40" height="32" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                  <circle cx="12" cy="16" r="3" fill="#3b82f6"/>
                  <circle cx="24" cy="16" r="3" fill="#f59e0b"/>
                  <circle cx="36" cy="16" r="3" fill="#3b82f6"/>
                  <rect x="8" y="22" width="8" height="2" fill="#3b82f6" opacity="0.7"/>
                  <rect x="20" y="22" width="8" height="2" fill="#f59e0b" opacity="0.7"/>
                  <rect x="32" y="22" width="8" height="2" fill="#3b82f6" opacity="0.7"/>
                  <path d="M8 26l4-2 4 3 4-1 4 2 4-3 4 1 4 2 4-1" stroke="#3b82f6" stroke-width="2" fill="none"/>
                </svg>
                <div style="flex: 1;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; display: block;">Custom evaluation criteria and scoring</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem; display: block;">Build flexible evaluation rubrics with multi-reviewer scoring and automated calculations</span>
                </div>
                <svg width="20" height="20" fill="#5a5bb8" style="margin-left: 1rem; opacity: 0.7;">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </div>

              <div class="admissions-feature-card" onclick="openDocumentVerificationSystem()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(90, 91, 184, 0.08)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(90, 91, 184, 0.15)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
                <svg width="48" height="48" fill="white" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="6" y="4" width="36" height="28" rx="3" fill="none" stroke="white" stroke-width="2"/>
                  <path d="M12 10h24M12 14h20M12 18h16M12 22h24M12 26h18"/>
                  <circle cx="36" cy="10" r="6" fill="none" stroke="#3b82f6" stroke-width="2"/>
                  <path d="M33 10l2 2 4-4" stroke="#3b82f6" stroke-width="2" fill="none"/>
                  <rect x="30" y="16" width="12" height="8" fill="#3b82f6" opacity="0.1" rx="2"/>
                  <path d="M32 18h8M32 20h6M32 22h8"/>
                  <circle cx="38" cy="20" r="2" fill="#f59e0b"/>
                </svg>
                <div>
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; display: block;">Document verification and compliance checks</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem; display: block;">Verify required documents, track compliance status, and maintain comprehensive audit trails</span>
                </div>
                <svg width="20" height="20" fill="#5a5bb8" style="margin-left: 1rem; opacity: 0.7;">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </div>

              <div class="admissions-feature-card" onclick="openSISIntegrationSystem()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(90, 91, 184, 0.08)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(90, 91, 184, 0.15)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
                <svg width="48" height="48" fill="white" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="4" y="8" width="16" height="24" rx="2" fill="none" stroke="white" stroke-width="2"/>
                  <rect x="28" y="8" width="16" height="24" rx="2" fill="none" stroke="white" stroke-width="2"/>
                  <path d="M8 14h8M8 18h6M8 22h8M8 26h4" stroke="white" stroke-width="1.5"/>
                  <path d="M32 14h8M32 18h6M32 22h8M32 26h4" stroke="white" stroke-width="1.5"/>
                  <circle cx="22" cy="20" r="8" fill="none" stroke="#3b82f6" stroke-width="2"/>
                  <path d="M18 16l4 4 8-8" stroke="#3b82f6" stroke-width="2" fill="none"/>
                  <path d="M19 20h6M19 23h6" stroke="#3b82f6" stroke-width="1.5"/>
                </svg>
                <div style="flex: 1;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; display: block;">Integration with student information systems</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem; display: block;">Secure data exchange, export admitted students, sync status updates, and handle batch transfers</span>
                </div>
                <svg width="20" height="20" fill="#5a5bb8" style="margin-left: 1rem; opacity: 0.7;">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </div>

              <div class="admissions-feature-card" onclick="openReportingDashboard()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(90, 91, 184, 0.08)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(90, 91, 184, 0.15)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
                <svg width="48" height="48" fill="white" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="4" y="6" width="40" height="28" rx="3" fill="none" stroke="white" stroke-width="2"/>
                  <path d="M4 14h40"/>
                  <circle cx="8" cy="10" r="1.5"/>
                  <circle cx="12" cy="10" r="1.5"/>
                  <circle cx="16" cy="10" r="1.5"/>
                  <rect x="8" y="18" width="6" height="12" fill="#3b82f6" opacity="0.7" rx="1"/>
                  <rect x="16" y="20" width="6" height="10" fill="#3b82f6" opacity="0.7" rx="1"/>
                  <rect x="24" y="22" width="6" height="8" fill="#f59e0b" opacity="0.7" rx="1"/>
                  <rect x="32" y="16" width="6" height="14" fill="#3b82f6" opacity="0.7" rx="1"/>
                </svg>
                <div style="flex: 1;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; display: block;">Reporting and analytics dashboard</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem; display: block;">Real-time metrics, demographic analysis, funnel tracking, and comprehensive reporting tools</span>
                </div>
                <svg width="20" height="20" fill="#5a5bb8" style="margin-left: 1rem; opacity: 0.7;">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="coming-soon__preview">
            <h3>Feature Preview</h3>
            <div class="preview-cards">
              <div class="preview-card">
                <div class="preview-card__icon">
                  <svg width="60" height="60" fill="white" style="color: #5a5bb8;">
                    <rect x="6" y="8" width="48" height="32" rx="4" fill="none" stroke="white" stroke-width="2"/>
                    <circle cx="16" cy="18" r="4" fill="#3b82f6"/>
                    <circle cx="30" cy="18" r="4" fill="#f59e0b"/>
                    <circle cx="44" cy="18" r="4" fill="#3b82f6"/>
                    <path d="M16 22v8M30 22v8M44 22v8" stroke="white" stroke-width="2"/>
                    <path d="M12 30h8M26 30h8M40 30h8" stroke="white" stroke-width="2"/>
                    <circle cx="30" cy="30" r="12" fill="none" stroke="#3b82f6" stroke-width="3" stroke-dasharray="8,4"/>
                    <path d="M26 26l4 4 8-8" stroke="#3b82f6" stroke-width="2" fill="none"/>
                  </svg>
                </div>
                <div class="preview-card__content">
                  <h4>Workflow Automation</h4>
                  <p>Set up automated workflows that move applications through your review process</p>
                </div>
              </div>
              <div class="preview-card">
                <div class="preview-card__icon">
                  <svg width="60" height="60" fill="white" style="color: #5a5bb8;">
                    <rect x="8" y="12" width="44" height="32" rx="4" fill="none" stroke="white" stroke-width="2"/>
                    <path d="M8 22h44M16 12v10M24 12v10M32 12v10M40 12v10M48 12v10"/>
                    <circle cx="18" cy="28" r="3" fill="#3b82f6"/>
                    <circle cx="26" cy="34" r="3" fill="#f59e0b"/>
                    <circle cx="34" cy="28" r="3" fill="#3b82f6"/>
                    <circle cx="42" cy="34" r="3" fill="#3b82f6"/>
                  </svg>
                </div>
                <div class="preview-card__content">
                  <h4>Interview Management</h4>
                  <p>Schedule interviews, send automated reminders, and track outcomes</p>
                </div>
              </div>
              <div class="preview-card">
                <div class="preview-card__icon">
                  <svg width="60" height="60" fill="white" style="color: #5a5bb8;">
                    <circle cx="30" cy="30" r="24" fill="none" stroke="white" stroke-width="2"/>
                    <circle cx="30" cy="30" r="16" fill="none" stroke="#3b82f6" stroke-width="2"/>
                    <circle cx="30" cy="30" r="8" fill="#3b82f6" opacity="0.8"/>
                    <path d="M22 22l8 8 16-16" stroke="#f59e0b" stroke-width="3" fill="none"/>
                  </svg>
                </div>
                <div class="preview-card__content">
                  <h4>Smart Decisions</h4>
                  <p>Use AI-powered insights to make informed admission decisions</p>
                </div>
              </div>
              <div class="preview-card">
                <div class="preview-card__icon">
                  <svg width="60" height="60" fill="white" style="color: #5a5bb8;">
                    <rect x="6" y="10" width="48" height="32" rx="4" fill="none" stroke="white" stroke-width="2"/>
                    <path d="M6 20h48"/>
                    <circle cx="12" cy="15" r="2"/>
                    <circle cx="18" cy="15" r="2"/>
                    <circle cx="24" cy="15" r="2"/>
                    <rect x="12" y="24" width="6" height="14" fill="#3b82f6" opacity="0.8" rx="1"/>
                    <rect x="20" y="26" width="6" height="12" fill="#3b82f6" opacity="0.8" rx="1"/>
                    <rect x="28" y="28" width="6" height="10" fill="#f59e0b" opacity="0.8" rx="1"/>
                    <rect x="36" y="22" width="6" height="16" fill="#3b82f6" opacity="0.8" rx="1"/>
                    <rect x="44" y="30" width="6" height="8" fill="#ef4444" opacity="0.8" rx="1"/>
                  </svg>
                </div>
                <div class="preview-card__content">
                  <h4>Real-time Analytics</h4>
                  <p>Track applications, conversion rates, and enrollment metrics</p>
                </div>
              </div>
            </div>
          </div>

          <div class="coming-soon__cta">
            <button class="btn btn--primary" onclick="joinBeta()">
              <svg width="16" height="16" fill="white">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Join Beta Program
            </button>
            <button class="btn btn--ghost" onclick="scheduleDemo()">
              <svg width="16" height="16" fill="white">
                <path d="M15 3a2 2 0 012 2v1.5a8 8 0 11-16 0V5a2 2 0 012-2h12z"/>
                <path d="M7 8.5a2 2 0 114 0"/>
              </svg>
              Schedule Demo
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer" role="contentinfo" aria-label="Site footer" style="background: linear-gradient(135deg, #5a5bb8, #6b6ce8); position: relative; overflow: hidden; color: white;">
    <div class="container footer__inner" style="position: relative; z-index: 2; color: white;">
      <div class="footer__grid">
        <!-- Brand section -->
        <div class="footer__brand">
          <div class="footer__logo" onclick="scrollToTop()" style="cursor: pointer;" title="Back to top">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <defs>
                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#373896"/>
                  <stop offset="100%" style="stop-color:#6b6ce8"/>
                </linearGradient>
              </defs>
              <circle cx="20" cy="20" r="18" fill="url(#logoGradient)" stroke="white" stroke-width="2"/>
              <path d="M15 18l5-5 5 5M20 13v14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="footer__brand-text">
            <div class="footer__brand-name" style="color: white;">Flow</div>
            <div class="footer__tagline" style="color: white;">Streamlining Education Access</div>
          </div>
        </div>
        <!-- Links -->
        <div class="footer__section">
          <h3 class="footer__title" style="color: black;">For Institutions</h3>
          <ul class="footer__links">
            <li><a href="/institutions/">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="3" width="12" height="10" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M4 6h8M4 8h6M4 10h4"/>
                <circle cx="11" cy="5" r="2" fill="#3b82f6" opacity="0.8"/>
                <path d="M10 5l0.7 0.7 1.3-1.4" stroke="white" stroke-width="0.8" fill="none"/>
              </svg>
              <span style="color: white;">Dashboard</span></a></li>
            <li><a href="/institutions/programs.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="2" width="12" height="12" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M5 5h6M5 7h4M5 9h5"/>
                <circle cx="11" cy="6" r="1.5" fill="#3b82f6" opacity="0.8"/>
                <path d="M10.3 6l0.4 0.4 0.6-0.8" stroke="white" stroke-width="0.8" fill="none"/>
              </svg>
              <span style="color: white;">Manage Programs</span></a></li>
            <li><a href="/institutions/admissions.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="3" width="8" height="10" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <rect x="12" y="3" width="2" height="10" rx="0.5" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M4 6h4M4 8h3M4 10h4"/>
                <circle cx="8" cy="6" r="1" fill="#3b82f6"/>
                <path d="M7.5 6l0.3 0.3 0.5-0.6" stroke="white" stroke-width="0.6" fill="none"/>
              </svg>
              <span style="color: white;">Admissions</span></a></li>
            <li><a href="/institutions/reports.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="3" width="12" height="10" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M2 7h12"/>
                <rect x="4" y="9" width="1.5" height="2" fill="#3b82f6" opacity="0.8" rx="0.3"/>
                <rect x="6" y="10" width="1.5" height="1" fill="#3b82f6" opacity="0.8" rx="0.3"/>
                <rect x="8" y="8" width="1.5" height="3" fill="#f59e0b" opacity="0.8" rx="0.3"/>
                <rect x="10" y="11" width="1.5" height="0.5" fill="#ef4444" opacity="0.8" rx="0.3"/>
              </svg>
              <span style="color: white;">Reports</span></a></li>
          </ul>
        </div>
        <div class="footer__section">
          <h3 class="footer__title" style="color: black;">Support</h3>
          <ul class="footer__links">
            <li><a href="/institutions/help.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <circle cx="8" cy="8" r="6" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M8 6v2M8 10h.01"/>
                <circle cx="8" cy="4" r="1" fill="#3b82f6"/>
                <path d="M4 12l8-8M12 12l-8-8" stroke="#3b82f6" stroke-width="0.8" opacity="0.5"/>
              </svg>
              <span style="color: white;">Help Center</span></a></li>
            <li><a href="/contact/">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <path d="M2 3h12l-6 5-6-5zM2 3v10h12V3" fill="none" stroke="white" stroke-width="1.2"/>
                <circle cx="12" cy="4" r="1.5" fill="#3b82f6"/>
                <path d="M11.3 4l0.4 0.4 0.6-0.8" stroke="white" stroke-width="0.6" fill="none"/>
              </svg>
              <span style="color: white;">Contact</span></a></li>
            <li><a href="/legal/privacy.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="3" y="2" width="10" height="12" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M8 6v4M6 8h4"/>
                <circle cx="8" cy="5" r="1" fill="#f59e0b"/>
                <rect x="5" y="9" width="6" height="1" fill="#ef4444" opacity="0.6"/>
              </svg>
              <span style="color: white;">Privacy</span></a></li>
            <li><a href="/legal/terms.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="2" width="12" height="12" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M5 5h6M5 7h5M5 9h4M5 11h6"/>
                <circle cx="12" cy="4" r="1" fill="#3b82f6"/>
                <rect x="4" y="6" width="1" height="6" fill="#3b82f6" opacity="0.3"/>
              </svg>
              <span style="color: white;">Terms</span></a></li>
          </ul>
        </div>
        <div class="footer__section">
          <h3 class="footer__title" style="color: black;">Connect</h3>
          <ul class="footer__links">
            <li><a href="/institutions/messages.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="4" width="12" height="8" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M2 6l5 3 2-1 5-2"/>
                <circle cx="12" cy="5" r="1.5" fill="#ef4444"/>
                <text x="12" y="6" text-anchor="middle" font-size="2.5" fill="white" font-weight="bold">2</text>
              </svg>
              <span style="color: white;">Messages</span></a></li>
            <li><a href="/community/">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <circle cx="5" cy="6" r="2" fill="none" stroke="white" stroke-width="1.2"/>
                <circle cx="11" cy="6" r="2" fill="none" stroke="white" stroke-width="1.2"/>
                <circle cx="8" cy="11" r="2" fill="none" stroke="white" stroke-width="1.2"/>
                <circle cx="5" cy="6" r="1" fill="#3b82f6"/>
                <circle cx="11" cy="6" r="1" fill="#3b82f6"/>
                <circle cx="8" cy="11" r="1" fill="#f59e0b"/>
                <path d="M7 8l2 1M9 8l-2 1" stroke="white" stroke-width="0.8"/>
              </svg>
              <span style="color: white;">Community</span></a></li>
            <li><a href="/blog/">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="2" width="12" height="12" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M5 5h6M5 7h4M5 9h5"/>
                <circle cx="12" cy="4" r="1.5" fill="#3b82f6"/>
                <path d="M11.3 4l0.4 0.4 0.6-0.8" stroke="white" stroke-width="0.6" fill="none"/>
                <rect x="4" y="11" width="8" height="1" fill="#3b82f6" opacity="0.6"/>
              </svg>
              <span style="color: white;">Updates</span></a></li>
          </ul>
        </div>
      </div>

      <div class="footer__bottom">
        <div class="footer__copyright" style="color: white;">
          ¬© 2024 Flow Education Platform. All rights reserved.
        </div>
        <div class="footer__status">
          <span class="footer__status-dot"></span>
          <span style="color: white;">All systems operational</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <!-- <script src="/assets/js/auth.js"></script> -->
  <!-- <script src="/assets/js/auth-guards.js"></script> -->
  <!-- <script src="/assets/js/institutions.js"></script> -->

  <script>

    // Header Button JavaScript Functionality

    // Toggle Dropdown Function
    function toggleDropdown(dropdownId, triggerId) {
      const dropdown = document.getElementById(dropdownId);
      const trigger = document.getElementById(triggerId);
      const isOpen = dropdown.getAttribute('aria-hidden') === 'false';

      // Close all dropdowns first
      closeAllDropdowns();

      if (!isOpen) {
        dropdown.setAttribute('aria-hidden', 'false');
        dropdown.style.display = 'block';
        trigger.setAttribute('aria-expanded', 'true');
      }
    }

    // Close all dropdowns
    function closeAllDropdowns() {
      const dropdowns = ['searchDropdown', 'notificationsDropdown', 'messagesDropdown', 'profileDropdown'];
      const triggers = ['searchTrigger', 'notificationsTrigger', 'messagesTrigger', 'profileTrigger'];

      dropdowns.forEach((id, index) => {
        const dropdown = document.getElementById(id);
        const trigger = document.getElementById(triggers[index]);
        if (dropdown && trigger) {
          dropdown.setAttribute('aria-hidden', 'true');
          dropdown.style.display = 'none';
          trigger.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Search functionality
    function handleSearch(query) {
      console.log('Searching for:', query);
      const suggestions = document.getElementById('searchSuggestions');

      if (query.length > 0) {
        const mockResults = [
          'Application Review',
          'Admission Requirements',
          'Interview Scheduling',
          'Decision Tracking',
          'Enrollment Management'
        ].filter(item => item.toLowerCase().includes(query.toLowerCase()));

        suggestions.innerHTML = mockResults.map(result =>
          `<div class="suggestion-item" onclick="selectSuggestion('${result}')">${result}</div>`
        ).join('');
      } else {
        suggestions.innerHTML = '';
      }
    }

    function selectSuggestion(suggestion) {
      document.getElementById('globalSearch').value = suggestion;
      closeAllDropdowns();
      showToast(`Searching for: ${suggestion}`, 'info', 3000);
    }

    // Notification functions
    function markAllNotificationsRead() {
      const notifications = document.querySelectorAll('.notification-item--unread');
      notifications.forEach(notification => {
        notification.classList.remove('notification-item--unread');
      });
      document.getElementById('notificationsBadge').textContent = '0';
      showToast('All notifications marked as read', 'success', 3000);
    }

    function dismissNotification(notificationId) {
      const notification = document.querySelector(`[data-id="${notificationId}"]`);
      if (notification) {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }
    }

    function openNotificationSettings() {
      showToast('Notification settings would open here', 'info', 3000);
    }

    // Message functions
    function composeMessage() {
      const modal = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" onclick="if(event.target === this) closeComposeModal()">
          <div style="background: white; padding: 1.5rem; border-radius: 12px; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto;">
            <h3 style="margin: 0 0 1rem 0;">Compose Message</h3>
            <form onsubmit="sendMessage(event)">
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem;">To:</label>
                <input type="text" name="recipient" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" placeholder="Enter recipient">
              </div>
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Subject:</label>
                <input type="text" name="subject" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" placeholder="Enter subject">
              </div>
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Message:</label>
                <textarea name="message" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" rows="4" placeholder="Enter your message"></textarea>
              </div>
              <div style="display: flex; gap: 1rem;">
                <button type="submit" style="flex: 1; background: #5a5bb8; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">Send</button>
                <button type="button" onclick="closeComposeModal()" style="flex: 1; background: #6b7280; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closeComposeModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) modal.remove();
    }

    function sendMessage(event) {
      event.preventDefault();
      showToast('Message sent successfully!', 'success', 3000);
      closeComposeModal();
    }

    function markMessageRead(messageId) {
      showToast(`Opening message ${messageId}`, 'info', 3000);
      closeAllDropdowns();
    }

    // Profile functions
    function viewFullProfile() {
      showToast('Opening full profile...', 'info', 3000);
    }

    function editProfile() {
      showToast('Opening profile editor...', 'info', 3000);
    }

    function logout() {
      if (confirm('Are you sure you want to log out?')) {
        showToast('Logging out...', 'info', 3000);
        setTimeout(() => {
          window.location.href = '/';
        }, 1000);
      }
    }

    // Sign out function (for compatibility)
    function signOut() {
      logout();
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Search trigger
      const searchTrigger = document.getElementById('searchTrigger');
      if (searchTrigger) {
        searchTrigger.addEventListener('click', () => toggleDropdown('searchDropdown', 'searchTrigger'));
      }

      // Notifications trigger
      const notificationsTrigger = document.getElementById('notificationsTrigger');
      if (notificationsTrigger) {
        notificationsTrigger.addEventListener('click', () => toggleDropdown('notificationsDropdown', 'notificationsTrigger'));
      }

      // Messages trigger
      const messagesTrigger = document.getElementById('messagesTrigger');
      if (messagesTrigger) {
        messagesTrigger.addEventListener('click', () => toggleDropdown('messagesDropdown', 'messagesTrigger'));
      }

      // Profile trigger
      const profileTrigger = document.getElementById('profileTrigger');
      if (profileTrigger) {
        profileTrigger.addEventListener('click', () => toggleDropdown('profileDropdown', 'profileTrigger'));
      }

      // Search input
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch) {
        globalSearch.addEventListener('input', (e) => handleSearch(e.target.value));
      }

      // Mobile menu toggle
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const navOverlay = document.getElementById('navOverlay');
      if (mobileMenuToggle && navOverlay) {
        mobileMenuToggle.addEventListener('click', () => {
          const isOpen = navOverlay.getAttribute('aria-hidden') === 'false';
          navOverlay.setAttribute('aria-hidden', !isOpen);
          navOverlay.style.display = isOpen ? 'none' : 'block';
          mobileMenuToggle.setAttribute('aria-expanded', !isOpen);
        });
      }

      // Click outside to close dropdowns
      document.addEventListener('click', function(event) {
        const isDropdownTrigger = event.target.closest('.header-search__trigger, .header-notifications__trigger, .header-messages__trigger, .header-profile__trigger');
        const isDropdownContent = event.target.closest('.header-search__dropdown, .header-notifications__dropdown, .header-messages__dropdown, .header-profile__dropdown');

        if (!isDropdownTrigger && !isDropdownContent) {
          closeAllDropdowns();
        }
      });
    });

    // Enhanced Admissions specific functions
    function joinBeta() {
      // Create comprehensive beta program application form
      const formHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;" onclick="if(event.target === this) closeBetaModal()">
          <div style="background: white; padding: 1.5rem; border-radius: 16px; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
            <div style="text-align: center; margin-bottom: 2rem;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üöÄ</div>
              <h2 style="margin: 0 0 0.5rem 0; color: #5a5bb8; font-size: 1.6rem;">Join Beta Program</h2>
              <p style="color: #6b7280; margin: 0; line-height: 1.6;">Get early access to Flow's revolutionary admissions management tools and help shape the future of higher education technology</p>
            </div>
            <form onsubmit="submitBetaApplication(event)">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Institution Name *</label>
                  <input type="text" name="institution" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="Your institution name">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Institution Type *</label>
                  <select name="institutionType" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Type</option>
                    <option value="university">University</option>
                    <option value="college">College</option>
                    <option value="community-college">Community College</option>
                    <option value="vocational">Vocational School</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Your Name *</label>
                  <input type="text" name="name" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="John Smith">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Your Title *</label>
                  <input type="text" name="title" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="Director of Admissions">
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Address *</label>
                  <input type="email" name="email" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="john.smith@university.edu">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Phone Number</label>
                  <input type="tel" name="phone" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="+1 (555) 123-4567">
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Annual Applications Volume *</label>
                  <select name="applicationVolume" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Range</option>
                    <option value="under-500">Under 500</option>
                    <option value="500-2000">500 - 2,000</option>
                    <option value="2000-5000">2,000 - 5,000</option>
                    <option value="5000-10000">5,000 - 10,000</option>
                    <option value="over-10000">Over 10,000</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Current System</label>
                  <input type="text" name="currentSystem" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="e.g., Banner, Slate, Custom">
                </div>
              </div>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Areas of Interest (Check all that apply)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="workflow-automation" style="margin-right: 0.5rem;"> Workflow Automation</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="interview-scheduling" style="margin-right: 0.5rem;"> Interview Scheduling</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="decision-tracking" style="margin-right: 0.5rem;"> Decision Tracking</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="analytics" style="margin-right: 0.5rem;"> Analytics & Reporting</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="integration" style="margin-right: 0.5rem;"> System Integration</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="compliance" style="margin-right: 0.5rem;"> Compliance Tools</label>
                </div>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">What challenges are you hoping to solve?</label>
                <textarea name="challenges" rows="3" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; resize: vertical;" placeholder="e.g., Manual processes taking too long, need better applicant tracking, difficulty with interview coordination..."></textarea>
              </div>

              <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">Beta Program Benefits</h4>
                <ul style="margin: 0; padding-left: 1.2rem; color: #92400e; font-size: 0.9rem;">
                  <li>Early access to cutting-edge admissions tools</li>
                  <li>Direct input on feature development</li>
                  <li>Priority support and training</li>
                  <li>Special beta pricing when we launch</li>
                </ul>
              </div>

              <div style="display: flex; gap: 1rem;">
                <button type="submit" style="flex: 1; background: linear-gradient(135deg, #f59e0b, #f97316); color: white; border: none; padding: 1rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: transform 0.2s;">
                  üöÄ Apply for Beta Access
                </button>
                <button type="button" onclick="closeBetaModal()" style="flex: 0.4; background: #6b7280; color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', formHtml);
      showToast('üåü Fill out the beta application to get early access to our revolutionary admissions tools', 'info', 4000);
    }

    function scheduleDemo() {
      // Create comprehensive demo scheduling form
      const formHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;" onclick="if(event.target === this) closeDemoModal()">
          <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 580px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
            <div style="text-align: center; margin-bottom: 2rem;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #5a5bb8, #6b6ce8); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìÖ</div>
              <h2 style="margin: 0 0 0.5rem 0; color: #5a5bb8; font-size: 1.6rem;">Schedule Admissions Demo</h2>
              <p style="color: #6b7280; margin: 0; line-height: 1.6;">Book a personalized demonstration of Flow's admissions management platform tailored to your institution's needs</p>
            </div>
            <form onsubmit="submitDemoSchedule(event)">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Institution Name *</label>
                  <input type="text" name="institution" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="Your institution name">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Your Name *</label>
                  <input type="text" name="name" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="John Smith">
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Address *</label>
                  <input type="email" name="email" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="john.smith@university.edu">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Your Role *</label>
                  <select name="role" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Role</option>
                    <option value="director-admissions">Director of Admissions</option>
                    <option value="admissions-officer">Admissions Officer</option>
                    <option value="registrar">Registrar</option>
                    <option value="it-director">IT Director</option>
                    <option value="provost">Provost/VP Academic Affairs</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Preferred Demo Date *</label>
                  <input type="date" name="preferred_date" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" min="${new Date().toISOString().split('T')[0]}">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Preferred Time *</label>
                  <select name="preferred_time" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Time</option>
                    <option value="9:00 AM">9:00 AM</option>
                    <option value="10:00 AM">10:00 AM</option>
                    <option value="11:00 AM">11:00 AM</option>
                    <option value="1:00 PM">1:00 PM</option>
                    <option value="2:00 PM">2:00 PM</option>
                    <option value="3:00 PM">3:00 PM</option>
                    <option value="4:00 PM">4:00 PM</option>
                  </select>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Time Zone *</label>
                  <select name="timezone" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Timezone</option>
                    <option value="EST">Eastern (EST)</option>
                    <option value="CST">Central (CST)</option>
                    <option value="MST">Mountain (MST)</option>
                    <option value="PST">Pacific (PST)</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Demo Length</label>
                  <select name="demo_length" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="30">30 minutes (Overview)</option>
                    <option value="60" selected>60 minutes (Comprehensive)</option>
                    <option value="90">90 minutes (Deep Dive)</option>
                  </select>
                </div>
              </div>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Additional Attendees (Optional)</label>
                <textarea name="attendees" rows="2" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; resize: vertical;" placeholder="List names and roles of other team members who will join the demo..."></textarea>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Specific Topics to Cover</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px;">
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="application-processing" style="margin-right: 0.5rem;" checked> Application Processing</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="workflow-automation" style="margin-right: 0.5rem;"> Workflow Automation</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="interview-management" style="margin-right: 0.5rem;"> Interview Management</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="reporting" style="margin-right: 0.5rem;"> Analytics & Reporting</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="integrations" style="margin-right: 0.5rem;"> System Integrations</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="pricing" style="margin-right: 0.5rem;"> Pricing & Implementation</label>
                </div>
              </div>

              <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                <h4 style="margin: 0 0 0.5rem 0; color: #1d4ed8;">What to Expect</h4>
                <ul style="margin: 0; padding-left: 1.2rem; color: #1d4ed8; font-size: 0.9rem;">
                  <li>Personalized walkthrough of admissions workflows</li>
                  <li>Q&A session tailored to your institution</li>
                  <li>Integration discussion and timeline planning</li>
                  <li>Custom pricing proposal</li>
                </ul>
              </div>

              <div style="display: flex; gap: 1rem;">
                <button type="submit" style="flex: 1; background: linear-gradient(135deg, #5a5bb8, #6b6ce8); color: white; border: none; padding: 1rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: transform 0.2s;">
                  üìÖ Schedule Demo
                </button>
                <button type="button" onclick="closeDemoModal()" style="flex: 0.4; background: #6b7280; color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', formHtml);
      showToast('üìÖ Schedule your personalized admissions management demo', 'info', 4000);
    }

    // Helper functions for form handling
    function submitBetaApplication(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);

      // Get selected interests
      const interests = Array.from(event.target.querySelectorAll('input[name="interests"]:checked'))
                           .map(input => input.value);
      data.interests = interests;

      showToast('‚è≥ Submitting your beta application...', 'info', 2000);

      setTimeout(() => {
        showToast(`üéâ Beta application submitted successfully!<br>üìß Confirmation sent to: ${data.email}<br>üöÄ We'll review your application and contact you within 48 hours with next steps`, 'success', 8000);

        // Generate beta application package
        const betaPackage = {
          applicationType: "Beta Program Application",
          submissionDate: new Date().toISOString(),
          institution: data.institution,
          contact: data.name,
          email: data.email,
          applicationVolume: data.applicationVolume,
          interests: interests,
          challenges: data.challenges,
          status: "Under Review"
        };

        downloadFile('Flow_Beta_Application_Confirmation.json', JSON.stringify(betaPackage, null, 2));

        closeBetaModal();

        setTimeout(() => {
          showToast('üí° Check your downloads for your application confirmation. We\'ll be in touch soon!', 'info', 4000);
        }, 2000);
      }, 1500);
    }

    function submitDemoSchedule(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);

      // Get selected topics
      const topics = Array.from(event.target.querySelectorAll('input[name="topics"]:checked'))
                         .map(input => input.value);
      data.topics = topics;

      showToast('‚è≥ Scheduling your demo...', 'info', 2000);

      setTimeout(() => {
        showToast(`‚úÖ Demo scheduled successfully!<br>üìß Calendar invite sent to: ${data.email}<br>üìÖ ${data.preferred_date} at ${data.preferred_time} ${data.timezone}<br>üéØ Our team will send you a preparation guide`, 'success', 8000);

        // Generate demo confirmation package
        const demoPackage = {
          demoType: "Admissions Management Demo",
          scheduledDate: data.preferred_date,
          scheduledTime: data.preferred_time,
          timezone: data.timezone,
          institution: data.institution,
          primaryContact: data.name,
          email: data.email,
          role: data.role,
          duration: data.demo_length + " minutes",
          topics: topics,
          attendees: data.attendees || "Not specified",
          confirmationCode: "FLOW-ADM-" + Math.random().toString(36).substr(2, 8).toUpperCase(),
          status: "Confirmed"
        };

        downloadFile('Flow_Demo_Confirmation.json', JSON.stringify(demoPackage, null, 2));

        closeDemoModal();

        setTimeout(() => {
          if (confirm('üì± Would you like us to send you SMS reminders for your scheduled demo?')) {
            showToast('üì≤ SMS reminders enabled! You\'ll receive notifications 24 hours and 1 hour before your demo.', 'success', 5000);
          }
        }, 2000);
      }, 1500);
    }

    function closeBetaModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) {
        modal.remove();
      }
    }

    function closeDemoModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) {
        modal.remove();
      }
    }

    // Helper function to download file
    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    // Scroll to top function - make it globally accessible
    function scrollToTop() {
      try {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        console.log('Scrolled to top');
      } catch (error) {
        // Fallback for older browsers
        window.scrollTo(0, 0);
        console.log('Scrolled to top (fallback)');
      }
    }

    // Make functions globally accessible
    window.scrollToTop = scrollToTop;
    window.joinBeta = joinBeta;
    window.scheduleDemo = scheduleDemo;

    // Ensure showToast function exists, provide fallback if not
    if (typeof showToast === 'undefined') {
      window.showToast = function(message, type, duration) {
        console.log(`Toast ${type}: ${message}`);
        alert(message.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
      };
    }

    // ============================================
    // AUTOMATED ROUTING SYSTEM
    // ============================================

    // Storage keys for routing data
    const ROUTING_STORAGE = {
      rules: 'routing_rules',
      assignments: 'auto_assignments',
      priorities: 'priority_flags',
      history: 'routing_history',
      reviewers: 'system_reviewers'
    };

    // Initialize sample data if not exists
    function initializeRoutingData() {
      if (!localStorage.getItem(ROUTING_STORAGE.reviewers)) {
        const sampleReviewers = [
          // Reviewers will be loaded from database
        ];
        localStorage.setItem(ROUTING_STORAGE.reviewers, JSON.stringify(sampleReviewers));
      }
    }

    // Save routing system state
    function saveRoutingState(isOpen, activeTab = 'overview', isMaximized = false) {
      localStorage.setItem('routingSystemState', JSON.stringify({
        isOpen,
        activeTab,
        isMaximized,
        timestamp: Date.now()
      }));
    }

    // Load routing system state
    function loadRoutingState() {
      try {
        const state = JSON.parse(localStorage.getItem('routingSystemState') || '{}');
        return {
          isOpen: state.isOpen || false,
          activeTab: state.activeTab || 'overview',
          isMaximized: state.isMaximized || false,
          timestamp: state.timestamp || 0
        };
      } catch {
        return { isOpen: false, activeTab: 'overview', isMaximized: false, timestamp: 0 };
      }
    }

    // Save interview system state
    function saveInterviewState(isOpen, activeTab = 'calendar', isMaximized = false) {
      localStorage.setItem('interviewSystemState', JSON.stringify({
        isOpen,
        activeTab,
        isMaximized,
        timestamp: Date.now()
      }));
    }

    // Load interview system state
    function loadInterviewState() {
      try {
        const state = JSON.parse(localStorage.getItem('interviewSystemState') || '{}');
        return {
          isOpen: state.isOpen || false,
          activeTab: state.activeTab || 'calendar',
          isMaximized: state.isMaximized || false,
          timestamp: state.timestamp || 0
        };
      } catch {
        return { isOpen: false, activeTab: 'calendar', isMaximized: false, timestamp: 0 };
      }
    }

    // Main routing system function
    window.openRoutingSystem = function() {
      initializeRoutingData();
      saveRoutingState(true, 'overview', false);

      const modal = document.createElement('div');
      modal.id = 'routingSystemModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.6); z-index: 25000;
        display: flex; align-items: center; justify-content: center;
        overflow-y: auto; padding: 1rem;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; width: 95%; max-width: 1400px; max-height: 95vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #5a5bb8, #6b6ce8); color: white; padding: 2rem; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <svg width="40" height="40" fill="white">
                  <rect x="2" y="4" width="28" height="20" rx="2" fill="none" stroke="white" stroke-width="2"/>
                  <path d="M6 10h20M6 14h16M6 18h20" stroke="white" stroke-width="1.5"/>
                  <circle cx="26" cy="10" r="3" fill="#3b82f6"/>
                  <path d="M24.5 10l1 1 2-2" stroke="white" stroke-width="1.5" fill="none"/>
                  <path d="M36 14l2 2 4-4" stroke="white" stroke-width="1.5" fill="none"/>
                </svg>
                <div>
                  <h2 style="margin: 0; font-size: 1.8rem;">Automated Routing System</h2>
                  <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Configure intelligent application routing and auto-assignment</p>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="backToAdmissions()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                  <span style="font-size: 1rem;">‚Üê</span>
                  <span style="font-size: 0.8rem;">Back to Admissions</span>
                </button>
                <button onclick="toggleFullscreen()" id="fullscreenBtn" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                  <span id="fullscreenIcon">‚õ∂</span>
                  <span id="fullscreenText" style="font-size: 0.8rem;">Maximize</span>
                </button>
                <button onclick="closeRoutingSystem()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>
              </div>
            </div>
          </div>

          <!-- Navigation Tabs -->
          <div style="background: #f8fafc; border-bottom: 2px solid #e2e8f0; display: flex; overflow-x: auto;">
            <button class="routing-tab active" data-tab="overview" style="padding: 1rem 2rem; border: none; background: white; border-bottom: 3px solid #5a5bb8; color: #5a5bb8; font-weight: 600; cursor: pointer; white-space: nowrap;">üìä Overview</button>
            <button class="routing-tab" data-tab="rules" style="padding: 1rem 2rem; border: none; background: transparent; color: #64748b; font-weight: 600; cursor: pointer; white-space: nowrap;">‚öôÔ∏è Routing Rules</button>
            <button class="routing-tab" data-tab="assignments" style="padding: 1rem 2rem; border: none; background: transparent; color: #64748b; font-weight: 600; cursor: pointer; white-space: nowrap;">üë• Auto-Assignment</button>
            <button class="routing-tab" data-tab="priorities" style="padding: 1rem 2rem; border: none; background: transparent; color: #64748b; font-weight: 600; cursor: pointer; white-space: nowrap;">üö© Priority Flags</button>
            <button class="routing-tab" data-tab="history" style="padding: 1rem 2rem; border: none; background: transparent; color: #64748b; font-weight: 600; cursor: pointer; white-space: nowrap;">üìã History & Audit</button>
            <button class="routing-tab" data-tab="overrides" style="padding: 1rem 2rem; border: none; background: transparent; color: #64748b; font-weight: 600; cursor: pointer; white-space: nowrap;">üîÑ Manual Overrides</button>
          </div>

          <!-- Content Area -->
          <div id="routingContent" style="height: 70vh; overflow-y: auto; padding: 2rem;">
            <!-- Content will be loaded here -->
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      setupRoutingTabs();
      showRoutingTab('overview');

      // Add keyboard shortcuts for fullscreen
      const handleKeyPress = function(e) {
        if (e.key === 'F11' && document.getElementById('routingSystemModal')) {
          e.preventDefault();
          toggleFullscreen();
        }
        if (e.key === 'Escape' && document.getElementById('routingSystemModal')) {
          const modal = document.getElementById('routingSystemModal');
          const isMaximized = modal.classList.contains('maximized');
          if (isMaximized) {
            toggleFullscreen();
          } else {
            closeRoutingSystem();
          }
        }
      };

      document.addEventListener('keydown', handleKeyPress);

      // Store reference to cleanup function on modal
      modal.keyboardCleanup = function() {
        document.removeEventListener('keydown', handleKeyPress);
      };
    };

    // Close routing system
    window.closeRoutingSystem = function() {
      const modal = document.getElementById('routingSystemModal');
      if (modal) {
        // Clean up keyboard event listeners
        if (modal.keyboardCleanup) {
          modal.keyboardCleanup();
        }
        modal.remove();
      }
      // Clear saved state
      saveRoutingState(false);
    };

    // Back to admissions page
    window.backToAdmissions = function() {
      // First close the routing system modal
      closeRoutingSystem();

      // Optional: Add a smooth scroll to top of admissions page
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Show a toast notification
      showToast('Returned to Admissions page', 'info', 2000);
    };

    // Toggle fullscreen mode
    window.toggleFullscreen = function() {
      const modal = document.getElementById('routingSystemModal');
      const modalContent = modal?.querySelector('div[style*="background: white"]');
      const fullscreenIcon = document.getElementById('fullscreenIcon');
      const fullscreenText = document.getElementById('fullscreenText');

      if (!modal || !modalContent) return;

      const isMaximized = modal.classList.contains('maximized');

      if (isMaximized) {
        // Exit maximized mode - return to normal modal size
        modal.classList.remove('maximized');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 25000; padding: 2rem;';
        modalContent.style.cssText = 'background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 90vh; overflow: hidden; display: flex; flex-direction: column;';
        fullscreenIcon.textContent = '‚õ∂';
        fullscreenText.textContent = 'Maximize';
        // Save state
        const currentTab = document.querySelector('.routing-tab.active')?.dataset?.tab || 'overview';
        saveRoutingState(true, currentTab, false);
      } else {
        // Enter maximized mode - use full viewport dimensions
        modal.classList.add('maximized');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); display: flex; align-items: stretch; justify-content: stretch; z-index: 25000; padding: 0; margin: 0;';
        modalContent.style.cssText = 'background: white; border-radius: 0; width: 100%; height: 100%; max-width: none; overflow: hidden; display: flex; flex-direction: column;';
        fullscreenIcon.textContent = '‚õ∑';
        fullscreenText.textContent = 'Restore';
        // Save state
        const currentTab = document.querySelector('.routing-tab.active')?.dataset?.tab || 'overview';
        saveRoutingState(true, currentTab, true);
      }
    };

    // Setup tab navigation
    function setupRoutingTabs() {
      document.querySelectorAll('.routing-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          showRoutingTab(tabName);

          // Update active tab
          document.querySelectorAll('.routing-tab').forEach(t => {
            t.style.background = 'transparent';
            t.style.borderBottom = '3px solid transparent';
            t.style.color = '#64748b';
            t.classList.remove('active');
          });

          this.style.background = 'white';
          this.style.borderBottom = '3px solid #5a5bb8';
          this.style.color = '#5a5bb8';
          this.classList.add('active');
        });
      });
    }

    // Show specific tab content
    function showRoutingTab(tabName) {
      const content = document.getElementById('routingContent');
      if (!content) return;

      switch(tabName) {
        case 'overview':
          content.innerHTML = generateOverviewContent();
          break;
        case 'rules':
          content.innerHTML = generateRulesContent();
          break;
        case 'assignments':
          content.innerHTML = generateAssignmentsContent();
          break;
        case 'priorities':
          content.innerHTML = generatePrioritiesContent();
          break;
        case 'history':
          content.innerHTML = generateHistoryContent();
          break;
        case 'overrides':
          content.innerHTML = generateOverridesContent();
          break;
      }

      // Save current tab state
      const modal = document.getElementById('routingSystemModal');
      const isMaximized = modal?.classList.contains('maximized') || false;
      saveRoutingState(true, tabName, isMaximized);
    }

    // Generate Overview Content
    function generateOverviewContent() {
      const rules = JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]');
      const assignments = JSON.parse(localStorage.getItem(ROUTING_STORAGE.assignments) || '[]');
      const priorities = JSON.parse(localStorage.getItem(ROUTING_STORAGE.priorities) || '[]');
      const history = JSON.parse(localStorage.getItem(ROUTING_STORAGE.history) || '[]');

      return `
        <div style="max-width: 1200px; margin: 0 auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">System Overview</h3>
          </div>

          <!-- Statistics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: #eff6ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <div style="color: #1e40af; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Active Routing Rules</div>
              <div style="font-size: 2rem; font-weight: 700; color: #1e40af;">${rules.filter(r => r.active).length}</div>
              <div style="font-size: 0.75rem; color: #3b82f6;">out of ${rules.length} total</div>
            </div>

            <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <div style="color: #2563eb; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Auto-Assignments</div>
              <div style="font-size: 2rem; font-weight: 700; color: #2563eb;">${assignments.length}</div>
              <div style="font-size: 0.75rem; color: #3b82f6;">configured rules</div>
            </div>

            <div style="background: #fef3c7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #f59e0b;">
              <div style="color: #92400e; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Priority Flags</div>
              <div style="font-size: 2rem; font-weight: 700; color: #92400e;">${priorities.length}</div>
              <div style="font-size: 0.75rem; color: #f59e0b;">active flags</div>
            </div>

            <div style="background: #fdf2f8; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #ec4899;">
              <div style="color: #be185d; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Processed Today</div>
              <div style="font-size: 2rem; font-weight: 700; color: #be185d;">${history.filter(h => isToday(h.timestamp)).length}</div>
              <div style="font-size: 0.75rem; color: #ec4899;">applications routed</div>
            </div>
          </div>

          <!-- Quick Setup -->
          <div style="background: #f8fafc; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.2rem;">üöÄ Quick Setup</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
              <button onclick="createBasicRoutingRule()" style="background: white; border: 2px solid #e5e7eb; padding: 1rem; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#5a5bb8'" onmouseout="this.style.borderColor='#e5e7eb'">
                <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Create First Routing Rule</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Set up basic program-based routing</div>
              </button>

              <button onclick="setupAutoAssignment()" style="background: white; border: 2px solid #e5e7eb; padding: 1rem; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#5a5bb8'" onmouseout="this.style.borderColor='#e5e7eb'">
                <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Configure Auto-Assignment</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Automatically assign to reviewers</div>
              </button>

              <button onclick="createPriorityFlag()" style="background: white; border: 2px solid #e5e7eb; padding: 1rem; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#5a5bb8'" onmouseout="this.style.borderColor='#e5e7eb'">
                <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Add Priority Flags</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Flag high-priority applications</div>
              </button>
            </div>
          </div>

          <!-- Recent Activity -->
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
              <h4 style="margin: 0; color: #374151; font-size: 1.1rem;">Recent Routing Activity</h4>
            </div>
            <div style="padding: 1rem;">
              ${generateRecentActivity()}
            </div>
          </div>
        </div>
      `;
    }

    // Helper function to check if date is today
    function isToday(timestamp) {
      const today = new Date();
      const date = new Date(timestamp);
      return date.toDateString() === today.toDateString();
    }

    // Generate recent activity
    function generateRecentActivity() {
      const history = JSON.parse(localStorage.getItem(ROUTING_STORAGE.history) || '[]')
        .slice(-10)
        .reverse();

      if (history.length === 0) {
        return `
          <div style="text-align: center; padding: 2rem; color: #6b7280;">
            <svg width="48" height="48" fill="currentColor" style="margin-bottom: 1rem; opacity: 0.5;">
              <rect x="6" y="6" width="36" height="24" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M12 14h24M12 18h18M12 22h24"/>
            </svg>
            <p style="margin: 0; font-size: 0.9rem;">No routing activity yet. Applications will appear here once processed.</p>
          </div>
        `;
      }

      return history.map(item => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${item.success ? '#3b82f6' : '#ef4444'};"></div>
            <div>
              <div style="font-weight: 500; color: #374151;">Application ${item.applicationId}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">${item.action}</div>
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 0.875rem; color: #374151;">${new Date(item.timestamp).toLocaleTimeString()}</div>
            <div style="font-size: 0.75rem; color: #6b7280;">${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        </div>
      `).join('');
    }

    // Generate Routing Rules Content
    function generateRulesContent() {
      const rules = JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]');

      return `
        <div style="max-width: 1200px; margin: 0 auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Routing Rules Configuration</h3>
            <button onclick="openCreateRuleModal()" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="16" height="16" fill="white">
                <path d="M8 4v8m4-4H4"/>
              </svg>
              Create New Rule
            </button>
          </div>

          ${rules.length === 0 ? `
            <div style="text-align: center; padding: 4rem; background: #f8fafc; border-radius: 12px; border: 2px dashed #cbd5e1;">
              <svg width="64" height="64" fill="#94a3b8" style="margin-bottom: 1rem;">
                <rect x="8" y="8" width="48" height="32" rx="4" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M16 20h32M16 24h24M16 28h32"/>
                <circle cx="48" cy="16" r="6" fill="#3b82f6" opacity="0.3"/>
              </svg>
              <h4 style="margin: 0 0 1rem 0; color: #475569;">No Routing Rules Configured</h4>
              <p style="margin: 0 0 2rem 0; color: #64748b;">Create your first routing rule to automatically process applications based on criteria like program type, applicant demographics, and more.</p>
              <button onclick="openCreateRuleModal()" style="background: #5a5bb8; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Create First Rule</button>
            </div>
          ` : `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
              <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 600; color: #374151;">Active Rules (${rules.filter(r => r.active).length}/${rules.length})</div>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="exportRulesConfig()" style="background: #6366f1; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">üì§ Export</button>
                  <button onclick="importRulesConfig()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">üìÅ Import</button>
                </div>
              </div>
              <div style="padding: 1rem;">
                ${rules.map((rule, index) => `
                  <div style="border: 1px solid ${rule.active ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: ${rule.active ? '#f0fdf4' : '#f9fafb'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                      <div>
                        <h5 style="margin: 0; color: #374151; font-size: 1rem;">${rule.name}</h5>
                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${rule.description}</p>
                      </div>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; ${rule.active ? 'background: #dcfce7; color: #166534;' : 'background: #f3f4f6; color: #374151;'}">
                          ${rule.active ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                        </span>
                        <span style="background: #eff6ff; color: #1d4ed8; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                          Priority: ${rule.priority}
                        </span>
                      </div>
                    </div>

                    <div style="background: #f8fafc; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #5a5bb8; margin: 0.5rem 0;">
                      <div style="font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;"><strong>Conditions:</strong></div>
                      <div style="font-size: 0.8rem; color: #6b7280;">
                        Program: ${rule.conditions.program || 'Any'} |
                        Applicant Type: ${rule.conditions.applicantType || 'Any'} |
                        Campus: ${rule.conditions.campus || 'Any'} |
                        Round: ${rule.conditions.applicationRound || 'Any'}
                      </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                      <div style="font-size: 0.875rem; color: #6b7280;">
                        Route to: <strong>${rule.destination}</strong> |
                        Created: ${new Date(rule.created).toLocaleDateString()}
                      </div>
                      <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editRule(${index})" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">‚úèÔ∏è Edit</button>
                        <button onclick="duplicateRule(${index})" style="background: #6366f1; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">üìã Copy</button>
                        <button onclick="toggleRule(${index})" style="background: ${rule.active ? '#dc2626' : '#3b82f6'}; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                          ${rule.active ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Enable'}
                        </button>
                        <button onclick="deleteRule(${index})" style="background: #6b7280; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">üóëÔ∏è Delete</button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `}
        </div>
      `;
    }

    // Generate Auto-Assignment Content
    function generateAssignmentsContent() {
      const assignments = JSON.parse(localStorage.getItem(ROUTING_STORAGE.assignments) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');

      return `
        <div style="max-width: 1200px; margin: 0 auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Auto-Assignment Configuration</h3>
            <button onclick="openCreateAssignmentModal()" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="16" height="16" fill="white">
                <path d="M8 4v8m4-4H4"/>
              </svg>
              Create Assignment Rule
            </button>
          </div>

          <!-- Reviewer Status Overview -->
          <div style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.1rem;">üë• Reviewer Workload Overview</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              ${reviewers.map(reviewer => {
                const utilizationPercent = Math.round((reviewer.workload / reviewer.maxCapacity) * 100);
                const utilizationColor = utilizationPercent > 80 ? '#dc2626' : utilizationPercent > 60 ? '#f59e0b' : '#3b82f6';

                return `
                  <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <h5 style="margin: 0; color: #374151; font-size: 0.9rem;">${reviewer.name}</h5>
                      <span style="background: ${utilizationColor}; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                        ${utilizationPercent}%
                      </span>
                    </div>
                    <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.75rem;">${reviewer.department}</div>
                    <div style="background: #f3f4f6; border-radius: 4px; height: 6px; overflow: hidden;">
                      <div style="background: ${utilizationColor}; height: 100%; width: ${utilizationPercent}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">${reviewer.workload}/${reviewer.maxCapacity} assignments</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          ${assignments.length === 0 ? `
            <div style="text-align: center; padding: 4rem; background: #f8fafc; border-radius: 12px; border: 2px dashed #cbd5e1;">
              <svg width="64" height="64" fill="#94a3b8" style="margin-bottom: 1rem;">
                <circle cx="20" cy="20" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="44" cy="20" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="32" cy="44" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M26 26l6 6M38 26l-6 6" stroke="currentColor" stroke-width="2"/>
              </svg>
              <h4 style="margin: 0 0 1rem 0; color: #475569;">No Auto-Assignment Rules</h4>
              <p style="margin: 0 0 2rem 0; color: #64748b;">Create assignment rules to automatically distribute applications to reviewers based on workload, expertise, and availability.</p>
              <button onclick="openCreateAssignmentModal()" style="background: #5a5bb8; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Create First Assignment Rule</button>
            </div>
          ` : `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
              <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <div style="font-weight: 600; color: #374151;">Assignment Rules (${assignments.length})</div>
              </div>
              <div style="padding: 1rem;">
                ${assignments.map((assignment, index) => `
                  <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #fafbfc;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                      <div>
                        <h5 style="margin: 0; color: #374151; font-size: 1rem;">${assignment.name}</h5>
                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${assignment.description}</p>
                      </div>
                      <span style="background: ${assignment.active ? '#dcfce7' : '#f3f4f6'}; color: ${assignment.active ? '#166534' : '#374151'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                        ${assignment.active ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                      </span>
                    </div>

                    <div style="background: #f1f5f9; padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0;">
                      <div style="font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;"><strong>Assignment Strategy:</strong> ${assignment.strategy}</div>
                      <div style="font-size: 0.8rem; color: #6b7280;">
                        ${assignment.conditions ? Object.entries(assignment.conditions).map(([key, value]) => `${key}: ${value}`).join(' | ') : 'All applications'}
                      </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                      <div style="font-size: 0.875rem; color: #6b7280;">
                        Created: ${new Date(assignment.created).toLocaleDateString()}
                      </div>
                      <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editAssignment(${index})" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">‚úèÔ∏è Edit</button>
                        <button onclick="toggleAssignment(${index})" style="background: ${assignment.active ? '#dc2626' : '#3b82f6'}; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                          ${assignment.active ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Enable'}
                        </button>
                        <button onclick="deleteAssignment(${index})" style="background: #6b7280; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">üóëÔ∏è Delete</button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `}
        </div>
      `;
    }

    // Generate Priorities Content
    function generatePrioritiesContent() {
      const priorities = JSON.parse(localStorage.getItem('admissionsPriorities') || '[]');

      return `
        <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h2 style="margin: 0 0 0.5rem 0; color: #1e293b; font-size: 1.5rem;">‚ö° Priority Management</h2>
              <p style="margin: 0; color: #64748b;">Configure priority flags and weightings for application processing</p>
            </div>
            <button onclick="openCreatePriorityModal()" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M8 4v8m4-4H4"/>
              </svg>
              Create Priority Flag
            </button>
          </div>

          <!-- Priority Flags Overview -->
          <div style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.1rem;">üèÜ Priority Flags Overview</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              ${priorities.map(priority => `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h5 style="margin: 0; color: #374151; font-size: 0.9rem;">${priority.name}</h5>
                    <span style="background: ${priority.color}; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                      Weight: ${priority.weight}
                    </span>
                  </div>
                  <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">${priority.description}</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">
                    ${priority.active ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'} ‚Ä¢ ${priority.autoAssign ? 'Auto-assign' : 'Manual only'}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          ${priorities.length === 0 ? `
            <div style="text-align: center; padding: 4rem; background: #f8fafc; border-radius: 12px; border: 2px dashed #cbd5e1;">
              <svg width="64" height="64" fill="#94a3b8" style="margin-bottom: 1rem;">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="none" stroke="currentColor" stroke-width="2"/>
              </svg>
              <h4 style="margin: 0 0 1rem 0; color: #475569;">No Priority Flags</h4>
              <p style="margin: 0 0 2rem 0; color: #64748b;">Create priority flags to automatically prioritize applications based on criteria like international status, scholarships, or deadlines.</p>
              <button onclick="openCreatePriorityModal()" style="background: #5a5bb8; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Create First Priority Flag</button>
            </div>
          ` : `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
              <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <div style="font-weight: 600; color: #374151;">Priority Flags (${priorities.length})</div>
              </div>
              <div style="padding: 1rem;">
                ${priorities.map((priority, index) => `
                  <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #fafbfc;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                      <div>
                        <h5 style="margin: 0; color: #374151; font-size: 1rem;">${priority.name}</h5>
                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${priority.description}</p>
                      </div>
                      <div style="text-align: right;">
                        <span style="background: ${priority.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; display: block; margin-bottom: 0.25rem;">
                          Weight: ${priority.weight}
                        </span>
                        <span style="background: ${priority.active ? '#dcfce7' : '#f3f4f6'}; color: ${priority.active ? '#166534' : '#374151'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                          ${priority.active ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                        </span>
                      </div>
                    </div>

                    <div style="background: #f1f5f9; padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0;">
                      <div style="font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;"><strong>Criteria:</strong></div>
                      <div style="font-size: 0.8rem; color: #6b7280;">
                        ${priority.criteria ? Object.entries(priority.criteria).map(([key, value]) => `${key}: ${value}`).join(' | ') : 'Manual assignment only'}
                      </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                      <div style="font-size: 0.875rem; color: #6b7280;">
                        Auto-assign: ${priority.autoAssign ? '‚úÖ Enabled' : '‚ùå Disabled'}
                      </div>
                      <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editPriority(${index})" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">‚úèÔ∏è Edit</button>
                        <button onclick="togglePriority(${index})" style="background: ${priority.active ? '#dc2626' : '#3b82f6'}; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                          ${priority.active ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Enable'}
                        </button>
                        <button onclick="deletePriority(${index})" style="background: #6b7280; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">üóëÔ∏è Delete</button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `}
        </div>
      `;
    }

    // Generate History Content
    function generateHistoryContent() {
      const history = JSON.parse(localStorage.getItem('admissionsHistory') || '[]');
      const activities = history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      return `
        <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h2 style="margin: 0 0 0.5rem 0; color: #1e293b; font-size: 1.5rem;">üìã Routing History & Audit</h2>
              <p style="margin: 0; color: #64748b;">Track all automated routing decisions and system activities</p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="clearHistory()" style="background: #dc2626; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üóëÔ∏è Clear History</button>
              <button onclick="exportHistory()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üì• Export</button>
            </div>
          </div>

          <!-- Activity Summary -->
          <div style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.1rem;">üìä Activity Summary</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #5a5bb8;">${activities.length}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Total Activities</div>
              </div>
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${activities.filter(a => a.type === 'auto_assignment').length}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Auto Assignments</div>
              </div>
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${activities.filter(a => a.type === 'manual_override').length}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Manual Overrides</div>
              </div>
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${activities.filter(a => a.type === 'rule_violation').length}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Rule Violations</div>
              </div>
            </div>
          </div>

          ${activities.length === 0 ? `
            <div style="text-align: center; padding: 4rem; background: #f8fafc; border-radius: 12px; border: 2px dashed #cbd5e1;">
              <svg width="64" height="64" fill="#94a3b8" style="margin-bottom: 1rem;">
                <path d="M9 12h6m-6 4h6m2 5l-1-1V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12l5-5z" fill="none" stroke="currentColor" stroke-width="2"/>
              </svg>
              <h4 style="margin: 0 0 1rem 0; color: #475569;">No History Available</h4>
              <p style="margin: 0; color: #64748b;">System activities and routing decisions will appear here once applications are processed.</p>
            </div>
          ` : `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
              <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <div style="font-weight: 600; color: #374151;">Activity Log (${activities.length} entries)</div>
              </div>
              <div style="padding: 1rem; max-height: 600px; overflow-y: auto;">
                ${activities.map((activity, index) => {
                  const typeConfig = {
                    'auto_assignment': { icon: 'ü§ñ', color: '#3b82f6', label: 'Auto Assignment' },
                    'manual_override': { icon: 'üë§', color: '#f59e0b', label: 'Manual Override' },
                    'rule_created': { icon: '‚ûï', color: '#5a5bb8', label: 'Rule Created' },
                    'rule_updated': { icon: '‚úèÔ∏è', color: '#f59e0b', label: 'Rule Updated' },
                    'rule_deleted': { icon: 'üóëÔ∏è', color: '#dc2626', label: 'Rule Deleted' },
                    'priority_assigned': { icon: '‚≠ê', color: '#f59e0b', label: 'Priority Assigned' },
                    'rule_violation': { icon: '‚ö†Ô∏è', color: '#dc2626', label: 'Rule Violation' },
                    'system_error': { icon: '‚ùå', color: '#dc2626', label: 'System Error' }
                  };

                  const config = typeConfig[activity.type] || { icon: 'üìù', color: '#6b7280', label: activity.type };

                  return `
                    <div style="border-left: 4px solid ${config.color}; padding: 1rem; margin-bottom: 1rem; background: #fafbfc; border-radius: 0 8px 8px 0;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                          <span style="font-size: 1.25rem;">${config.icon}</span>
                          <h5 style="margin: 0; color: #374151; font-size: 0.95rem;">${config.label}</h5>
                        </div>
                        <span style="background: #e5e7eb; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                          ${new Date(activity.timestamp).toLocaleString()}
                        </span>
                      </div>

                      <p style="margin: 0.5rem 0; color: #6b7280; font-size: 0.875rem;">${activity.description}</p>

                      ${activity.details ? `
                        <div style="background: #f1f5f9; padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem;">
                          <div style="font-size: 0.8rem; color: #374151;">
                            ${typeof activity.details === 'object' ?
                              Object.entries(activity.details).map(([key, value]) =>
                                `<div><strong>${key}:</strong> ${value}</div>`
                              ).join('') :
                              activity.details
                            }
                          </div>
                        </div>
                      ` : ''}

                      ${activity.user ? `
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                          User: ${activity.user}
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `}
        </div>
      `;
    }

    // Generate Overrides Content
    function generateOverridesContent() {
      const overrides = JSON.parse(localStorage.getItem('admissionsOverrides') || '[]');
      const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');

      return `
        <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h2 style="margin: 0 0 0.5rem 0; color: #1e293b; font-size: 1.5rem;">üîÑ Manual Overrides</h2>
              <p style="margin: 0; color: #64748b;">Manually reassign applications and override automated routing decisions</p>
            </div>
            <button onclick="openManualAssignmentModal()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/>
                <line x1="23" y1="11" x2="17" y2="11"/>
              </svg>
              Manual Assignment
            </button>
          </div>

          <!-- Reassignment Interface -->
          <div style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #9a3412; font-size: 1.1rem;">‚ö†Ô∏è Quick Reassignment</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Application ID</label>
                <input type="text" id="reassignApplicationId" placeholder="APP-2024-001" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Current Reviewer</label>
                <select id="reassignCurrentReviewer" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                  <option value="">Select current reviewer</option>
                  ${reviewers.map(reviewer => `<option value="${reviewer.id}">${reviewer.name}</option>`).join('')}
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">New Reviewer</label>
                <select id="reassignNewReviewer" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                  <option value="">Select new reviewer</option>
                  ${reviewers.map(reviewer => `<option value="${reviewer.id}">${reviewer.name} (${reviewer.workload}/${reviewer.maxCapacity})</option>`).join('')}
                </select>
              </div>
              <button onclick="processReassignment()" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 600;">Reassign</button>
            </div>
            <div style="margin-top: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Reason for Override</label>
              <input type="text" id="reassignReason" placeholder="e.g., Reviewer unavailable, expertise mismatch, workload rebalancing" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
            </div>
          </div>

          ${overrides.length === 0 ? `
            <div style="text-align: center; padding: 4rem; background: #f8fafc; border-radius: 12px; border: 2px dashed #cbd5e1;">
              <svg width="64" height="64" fill="#94a3b8" style="margin-bottom: 1rem;">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="8.5" cy="7" r="4" fill="none" stroke="currentColor" stroke-width="2"/>
                <line x1="20" y1="8" x2="20" y2="14" stroke="currentColor" stroke-width="2"/>
                <line x1="23" y1="11" x2="17" y2="11" stroke="currentColor" stroke-width="2"/>
              </svg>
              <h4 style="margin: 0 0 1rem 0; color: #475569;">No Manual Overrides</h4>
              <p style="margin: 0; color: #64748b;">Manual reassignments and routing overrides will appear here. Use the interface above to reassign applications as needed.</p>
            </div>
          ` : `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
              <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <div style="font-weight: 600; color: #374151;">Manual Overrides History (${overrides.length})</div>
              </div>
              <div style="padding: 1rem;">
                ${overrides.map((override, index) => {
                  const fromReviewer = reviewers.find(r => r.id === override.fromReviewerId);
                  const toReviewer = reviewers.find(r => r.id === override.toReviewerId);

                  return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #fafbfc;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div>
                          <h5 style="margin: 0; color: #374151; font-size: 1rem;">Application ${override.applicationId}</h5>
                          <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${override.reason}</p>
                        </div>
                        <span style="background: #fff7ed; color: #9a3412; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                          Override
                        </span>
                      </div>

                      <div style="background: #f1f5f9; padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                          <div style="text-align: center;">
                            <div style="font-size: 0.875rem; color: #374151; font-weight: 600;">${fromReviewer ? fromReviewer.name : 'Unknown'}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">From</div>
                          </div>
                          <div style="flex: 1; height: 2px; background: #d1d5db; position: relative;">
                            <div style="position: absolute; right: -6px; top: -4px; width: 0; height: 0; border-left: 8px solid #6b7280; border-top: 4px solid transparent; border-bottom: 4px solid transparent;"></div>
                          </div>
                          <div style="text-align: center;">
                            <div style="font-size: 0.875rem; color: #374151; font-weight: 600;">${toReviewer ? toReviewer.name : 'Unknown'}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">To</div>
                          </div>
                        </div>
                      </div>

                      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                        <div style="font-size: 0.875rem; color: #6b7280;">
                          ${new Date(override.timestamp).toLocaleString()} ‚Ä¢ By: ${override.performedBy || 'System'}
                        </div>
                        <button onclick="revertOverride(${index})" style="background: #dc2626; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">‚Ü©Ô∏è Revert</button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `}
        </div>
      `;
    }

    // Modal Functions
    function openCreateRuleModal() {
      const modal = document.createElement('div');
      modal.id = 'createRuleModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">üìã Create Routing Rule</h3>

          <form id="createRuleForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Rule Name</label>
              <input type="text" name="name" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Rule Type</label>
              <select name="type" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="program_based">Program-Based Routing</option>
                <option value="department_based">Department-Based Routing</option>
                <option value="score_based">Score-Based Routing</option>
                <option value="workload_based">Workload-Based Routing</option>
                <option value="expertise_based">Expertise-Based Routing</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Priority</label>
              <select name="priority" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="1">High (1)</option>
                <option value="2">Medium (2)</option>
                <option value="3">Low (3)</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Conditions (JSON)</label>
              <textarea name="conditions" rows="3" placeholder='{"program": "Computer Science", "minScore": 85}' style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace;"></textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="active" checked style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Active (rule will be applied immediately)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('createRuleModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Create Rule</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('createRuleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          const rule = {
            id: 'rule_' + Date.now(),
            name: formData.get('name'),
            description: formData.get('description'),
            type: formData.get('type'),
            priority: parseInt(formData.get('priority')),
            conditions: formData.get('conditions') ? JSON.parse(formData.get('conditions')) : {},
            active: formData.get('active') === 'on',
            created: new Date().toISOString(),
            lastModified: new Date().toISOString()
          };

          const rules = JSON.parse(localStorage.getItem('admissionsRules') || '[]');
          rules.push(rule);
          localStorage.setItem('admissionsRules', JSON.stringify(rules));

          // Add to history
          addToHistory('rule_created', `Created routing rule: ${rule.name}`, { ruleId: rule.id, type: rule.type });

          closeModal('createRuleModal');
          showTab('rules');
          showNotification('Routing rule created successfully!', 'success');
        } catch (error) {
          showNotification('Error creating rule: ' + error.message, 'error');
        }
      });
    }

    function openCreateAssignmentModal() {
      const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');
      const modal = document.createElement('div');
      modal.id = 'createAssignmentModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">üë• Create Assignment Rule</h3>

          <form id="createAssignmentForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Assignment Name</label>
              <input type="text" name="name" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Assignment Strategy</label>
              <select name="strategy" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="round_robin">Round Robin (equal distribution)</option>
                <option value="workload_balanced">Workload Balanced (least busy first)</option>
                <option value="expertise_matched">Expertise Matched (best fit)</option>
                <option value="random">Random Assignment</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Target Reviewers</label>
              <div style="max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 4px; padding: 0.5rem;">
                ${reviewers.map(reviewer => `
                  <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="reviewers" value="${reviewer.id}" style="cursor: pointer;">
                    <span style="font-size: 0.875rem; color: #374151;">${reviewer.name} (${reviewer.department})</span>
                  </label>
                `).join('')}
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Conditions (JSON)</label>
              <textarea name="conditions" rows="3" placeholder='{"program": "Engineering", "score": ">80"}' style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace;"></textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="active" checked style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Active (rule will be applied immediately)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('createAssignmentModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Create Assignment Rule</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('createAssignmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          const assignment = {
            id: 'assignment_' + Date.now(),
            name: formData.get('name'),
            description: formData.get('description'),
            strategy: formData.get('strategy'),
            reviewers: Array.from(formData.getAll('reviewers')),
            conditions: formData.get('conditions') ? JSON.parse(formData.get('conditions')) : {},
            active: formData.get('active') === 'on',
            created: new Date().toISOString(),
            lastModified: new Date().toISOString()
          };

          const assignments = JSON.parse(localStorage.getItem('admissionsAssignments') || '[]');
          assignments.push(assignment);
          localStorage.setItem('admissionsAssignments', JSON.stringify(assignments));

          // Add to history
          addToHistory('assignment_created', `Created assignment rule: ${assignment.name}`, { assignmentId: assignment.id, strategy: assignment.strategy });

          closeModal('createAssignmentModal');
          showTab('assignments');
          showNotification('Assignment rule created successfully!', 'success');
        } catch (error) {
          showNotification('Error creating assignment rule: ' + error.message, 'error');
        }
      });
    }

    function openCreatePriorityModal() {
      const modal = document.createElement('div');
      modal.id = 'createPriorityModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">‚ö° Create Priority Flag</h3>

          <form id="createPriorityForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Priority Name</label>
              <input type="text" name="name" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Priority Weight</label>
                <select name="weight" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="1">1 (Highest)</option>
                  <option value="2">2 (High)</option>
                  <option value="3">3 (Medium)</option>
                  <option value="4">4 (Low)</option>
                  <option value="5">5 (Lowest)</option>
                </select>
              </div>

              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Color</label>
                <select name="color" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="#dc2626" style="background: #dc2626; color: white;">üî¥ Red (Urgent)</option>
                  <option value="#f59e0b" style="background: #f59e0b; color: white;">üü° Orange (High)</option>
                  <option value="#5a5bb8" style="background: #5a5bb8; color: white;">üîµ Blue (Important)</option>
                  <option value="#3b82f6" style="background: #3b82f6; color: white;">üü¢ Green (Standard)</option>
                  <option value="#6b7280" style="background: #6b7280; color: white;">‚ö´ Gray (Low)</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Auto-Assignment Criteria (JSON)</label>
              <textarea name="criteria" rows="3" placeholder='{"international": true, "scholarshipEligible": true, "deadlineWithin": "7 days"}' style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace;"></textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                <input type="checkbox" name="autoAssign" style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Enable Auto-Assignment</span>
              </label>

              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="active" checked style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Active (flag will be applied immediately)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('createPriorityModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Create Priority Flag</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('createPriorityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          const priority = {
            id: 'priority_' + Date.now(),
            name: formData.get('name'),
            description: formData.get('description'),
            weight: parseInt(formData.get('weight')),
            color: formData.get('color'),
            criteria: formData.get('criteria') ? JSON.parse(formData.get('criteria')) : {},
            autoAssign: formData.get('autoAssign') === 'on',
            active: formData.get('active') === 'on',
            created: new Date().toISOString(),
            lastModified: new Date().toISOString()
          };

          const priorities = JSON.parse(localStorage.getItem('admissionsPriorities') || '[]');
          priorities.push(priority);
          localStorage.setItem('admissionsPriorities', JSON.stringify(priorities));

          // Add to history
          addToHistory('priority_created', `Created priority flag: ${priority.name}`, { priorityId: priority.id, weight: priority.weight });

          closeModal('createPriorityModal');
          showTab('priorities');
          showNotification('Priority flag created successfully!', 'success');
        } catch (error) {
          showNotification('Error creating priority flag: ' + error.message, 'error');
        }
      });
    }

    function openManualAssignmentModal() {
      const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');
      const modal = document.createElement('div');
      modal.id = 'manualAssignmentModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">üîÑ Manual Assignment</h3>

          <form id="manualAssignmentForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Application ID</label>
              <input type="text" name="applicationId" required placeholder="APP-2024-001" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Assign to Reviewer</label>
              <select name="reviewerId" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="">Select reviewer</option>
                ${reviewers.map(reviewer => `
                  <option value="${reviewer.id}">${reviewer.name} (${reviewer.department}) - ${reviewer.workload}/${reviewer.maxCapacity}</option>
                `).join('')}
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Priority Level</label>
              <select name="priority" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="normal">Normal Priority</option>
                <option value="high">High Priority</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Assignment Reason</label>
              <textarea name="reason" rows="3" placeholder="e.g., Expertise match, specific request, workload balancing" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="overrideAutomation" style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Override automatic routing (prevent future auto-reassignment)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('manualAssignmentModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Assign Application</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('manualAssignmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const assignment = {
          id: 'manual_' + Date.now(),
          applicationId: formData.get('applicationId'),
          reviewerId: formData.get('reviewerId'),
          priority: formData.get('priority'),
          reason: formData.get('reason'),
          overrideAutomation: formData.get('overrideAutomation') === 'on',
          timestamp: new Date().toISOString(),
          type: 'manual_assignment'
        };

        // Update reviewer workload
        const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');
        const reviewerIndex = reviewers.findIndex(r => r.id === assignment.reviewerId);
        if (reviewerIndex !== -1) {
          reviewers[reviewerIndex].workload += 1;
          localStorage.setItem(ROUTING_STORAGE.reviewers, JSON.stringify(reviewers));
        }

        // Add to history
        const reviewer = reviewers.find(r => r.id === assignment.reviewerId);
        addToHistory('manual_override', `Manually assigned ${assignment.applicationId} to ${reviewer ? reviewer.name : 'unknown reviewer'}`, {
          applicationId: assignment.applicationId,
          reviewerId: assignment.reviewerId,
          reason: assignment.reason,
          priority: assignment.priority
        });

        closeModal('manualAssignmentModal');
        showNotification(`Application ${assignment.applicationId} assigned successfully!`, 'success');
      });
    }

    // CRUD Functions for Rules
    function editRule(index) {
      const rules = JSON.parse(localStorage.getItem('admissionsRules') || '[]');
      const rule = rules[index];

      const modal = document.createElement('div');
      modal.id = 'editRuleModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">‚úèÔ∏è Edit Routing Rule</h3>

          <form id="editRuleForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Rule Name</label>
              <input type="text" name="name" value="${rule.name}" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">${rule.description || ''}</textarea>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Rule Type</label>
              <select name="type" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="program_based" ${rule.type === 'program_based' ? 'selected' : ''}>Program-Based Routing</option>
                <option value="department_based" ${rule.type === 'department_based' ? 'selected' : ''}>Department-Based Routing</option>
                <option value="score_based" ${rule.type === 'score_based' ? 'selected' : ''}>Score-Based Routing</option>
                <option value="workload_based" ${rule.type === 'workload_based' ? 'selected' : ''}>Workload-Based Routing</option>
                <option value="expertise_based" ${rule.type === 'expertise_based' ? 'selected' : ''}>Expertise-Based Routing</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Priority</label>
              <select name="priority" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="1" ${rule.priority === 1 ? 'selected' : ''}>High (1)</option>
                <option value="2" ${rule.priority === 2 ? 'selected' : ''}>Medium (2)</option>
                <option value="3" ${rule.priority === 3 ? 'selected' : ''}>Low (3)</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Conditions (JSON)</label>
              <textarea name="conditions" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace;">${JSON.stringify(rule.conditions, null, 2)}</textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="active" ${rule.active ? 'checked' : ''} style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Active (rule will be applied immediately)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('editRuleModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Update Rule</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editRuleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          rules[index] = {
            ...rule,
            name: formData.get('name'),
            description: formData.get('description'),
            type: formData.get('type'),
            priority: parseInt(formData.get('priority')),
            conditions: formData.get('conditions') ? JSON.parse(formData.get('conditions')) : {},
            active: formData.get('active') === 'on',
            lastModified: new Date().toISOString()
          };

          localStorage.setItem('admissionsRules', JSON.stringify(rules));

          // Add to history
          addToHistory('rule_updated', `Updated routing rule: ${rules[index].name}`, { ruleId: rule.id, changes: 'modified' });

          closeModal('editRuleModal');
          showTab('rules');
          showNotification('Routing rule updated successfully!', 'success');
        } catch (error) {
          showNotification('Error updating rule: ' + error.message, 'error');
        }
      });
    }

    function deleteRule(index) {
      if (confirm('Are you sure you want to delete this routing rule? This action cannot be undone.')) {
        const rules = JSON.parse(localStorage.getItem('admissionsRules') || '[]');
        const deletedRule = rules[index];
        rules.splice(index, 1);
        localStorage.setItem('admissionsRules', JSON.stringify(rules));

        // Add to history
        addToHistory('rule_deleted', `Deleted routing rule: ${deletedRule.name}`, { ruleId: deletedRule.id });

        showTab('rules');
        showNotification('Routing rule deleted successfully!', 'success');
      }
    }

    function toggleRule(index) {
      const rules = JSON.parse(localStorage.getItem('admissionsRules') || '[]');
      rules[index].active = !rules[index].active;
      rules[index].lastModified = new Date().toISOString();
      localStorage.setItem('admissionsRules', JSON.stringify(rules));

      // Add to history
      addToHistory('rule_updated', `${rules[index].active ? 'Enabled' : 'Disabled'} routing rule: ${rules[index].name}`, { ruleId: rules[index].id });

      showTab('rules');
      showNotification(`Routing rule ${rules[index].active ? 'enabled' : 'disabled'} successfully!`, 'success');
    }

    // CRUD Functions for Assignments
    function editAssignment(index) {
      const assignments = JSON.parse(localStorage.getItem('admissionsAssignments') || '[]');
      const assignment = assignments[index];
      const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');

      const modal = document.createElement('div');
      modal.id = 'editAssignmentModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">‚úèÔ∏è Edit Assignment Rule</h3>

          <form id="editAssignmentForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Assignment Name</label>
              <input type="text" name="name" value="${assignment.name}" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">${assignment.description || ''}</textarea>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Assignment Strategy</label>
              <select name="strategy" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="round_robin" ${assignment.strategy === 'round_robin' ? 'selected' : ''}>Round Robin (equal distribution)</option>
                <option value="workload_balanced" ${assignment.strategy === 'workload_balanced' ? 'selected' : ''}>Workload Balanced (least busy first)</option>
                <option value="expertise_matched" ${assignment.strategy === 'expertise_matched' ? 'selected' : ''}>Expertise Matched (best fit)</option>
                <option value="random" ${assignment.strategy === 'random' ? 'selected' : ''}>Random Assignment</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Target Reviewers</label>
              <div style="max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 4px; padding: 0.5rem;">
                ${reviewers.map(reviewer => `
                  <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="reviewers" value="${reviewer.id}" ${assignment.reviewers.includes(reviewer.id) ? 'checked' : ''} style="cursor: pointer;">
                    <span style="font-size: 0.875rem; color: #374151;">${reviewer.name} (${reviewer.department})</span>
                  </label>
                `).join('')}
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Conditions (JSON)</label>
              <textarea name="conditions" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace;">${JSON.stringify(assignment.conditions, null, 2)}</textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="active" ${assignment.active ? 'checked' : ''} style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Active (rule will be applied immediately)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('editAssignmentModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Update Assignment Rule</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editAssignmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          assignments[index] = {
            ...assignment,
            name: formData.get('name'),
            description: formData.get('description'),
            strategy: formData.get('strategy'),
            reviewers: Array.from(formData.getAll('reviewers')),
            conditions: formData.get('conditions') ? JSON.parse(formData.get('conditions')) : {},
            active: formData.get('active') === 'on',
            lastModified: new Date().toISOString()
          };

          localStorage.setItem('admissionsAssignments', JSON.stringify(assignments));

          // Add to history
          addToHistory('assignment_updated', `Updated assignment rule: ${assignments[index].name}`, { assignmentId: assignment.id });

          closeModal('editAssignmentModal');
          showTab('assignments');
          showNotification('Assignment rule updated successfully!', 'success');
        } catch (error) {
          showNotification('Error updating assignment rule: ' + error.message, 'error');
        }
      });
    }

    function deleteAssignment(index) {
      if (confirm('Are you sure you want to delete this assignment rule? This action cannot be undone.')) {
        const assignments = JSON.parse(localStorage.getItem('admissionsAssignments') || '[]');
        const deletedAssignment = assignments[index];
        assignments.splice(index, 1);
        localStorage.setItem('admissionsAssignments', JSON.stringify(assignments));

        // Add to history
        addToHistory('assignment_deleted', `Deleted assignment rule: ${deletedAssignment.name}`, { assignmentId: deletedAssignment.id });

        showTab('assignments');
        showNotification('Assignment rule deleted successfully!', 'success');
      }
    }

    function toggleAssignment(index) {
      const assignments = JSON.parse(localStorage.getItem('admissionsAssignments') || '[]');
      assignments[index].active = !assignments[index].active;
      assignments[index].lastModified = new Date().toISOString();
      localStorage.setItem('admissionsAssignments', JSON.stringify(assignments));

      // Add to history
      addToHistory('assignment_updated', `${assignments[index].active ? 'Enabled' : 'Disabled'} assignment rule: ${assignments[index].name}`, { assignmentId: assignments[index].id });

      showTab('assignments');
      showNotification(`Assignment rule ${assignments[index].active ? 'enabled' : 'disabled'} successfully!`, 'success');
    }

    // CRUD Functions for Priorities
    function editPriority(index) {
      const priorities = JSON.parse(localStorage.getItem('admissionsPriorities') || '[]');
      const priority = priorities[index];

      const modal = document.createElement('div');
      modal.id = 'editPriorityModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">‚úèÔ∏è Edit Priority Flag</h3>

          <form id="editPriorityForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Priority Name</label>
              <input type="text" name="name" value="${priority.name}" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">${priority.description || ''}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Priority Weight</label>
                <select name="weight" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="1" ${priority.weight === 1 ? 'selected' : ''}>1 (Highest)</option>
                  <option value="2" ${priority.weight === 2 ? 'selected' : ''}>2 (High)</option>
                  <option value="3" ${priority.weight === 3 ? 'selected' : ''}>3 (Medium)</option>
                  <option value="4" ${priority.weight === 4 ? 'selected' : ''}>4 (Low)</option>
                  <option value="5" ${priority.weight === 5 ? 'selected' : ''}>5 (Lowest)</option>
                </select>
              </div>

              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Color</label>
                <select name="color" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="#dc2626" ${priority.color === '#dc2626' ? 'selected' : ''} style="background: #dc2626; color: white;">üî¥ Red (Urgent)</option>
                  <option value="#f59e0b" ${priority.color === '#f59e0b' ? 'selected' : ''} style="background: #f59e0b; color: white;">üü° Orange (High)</option>
                  <option value="#5a5bb8" ${priority.color === '#5a5bb8' ? 'selected' : ''} style="background: #5a5bb8; color: white;">üîµ Blue (Important)</option>
                  <option value="#3b82f6" ${priority.color === '#3b82f6' ? 'selected' : ''} style="background: #3b82f6; color: white;">üü¢ Green (Standard)</option>
                  <option value="#6b7280" ${priority.color === '#6b7280' ? 'selected' : ''} style="background: #6b7280; color: white;">‚ö´ Gray (Low)</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Auto-Assignment Criteria (JSON)</label>
              <textarea name="criteria" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace;">${JSON.stringify(priority.criteria, null, 2)}</textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                <input type="checkbox" name="autoAssign" ${priority.autoAssign ? 'checked' : ''} style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Enable Auto-Assignment</span>
              </label>

              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="active" ${priority.active ? 'checked' : ''} style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Active (flag will be applied immediately)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('editPriorityModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Update Priority Flag</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editPriorityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          priorities[index] = {
            ...priority,
            name: formData.get('name'),
            description: formData.get('description'),
            weight: parseInt(formData.get('weight')),
            color: formData.get('color'),
            criteria: formData.get('criteria') ? JSON.parse(formData.get('criteria')) : {},
            autoAssign: formData.get('autoAssign') === 'on',
            active: formData.get('active') === 'on',
            lastModified: new Date().toISOString()
          };

          localStorage.setItem('admissionsPriorities', JSON.stringify(priorities));

          // Add to history
          addToHistory('priority_updated', `Updated priority flag: ${priorities[index].name}`, { priorityId: priority.id });

          closeModal('editPriorityModal');
          showTab('priorities');
          showNotification('Priority flag updated successfully!', 'success');
        } catch (error) {
          showNotification('Error updating priority flag: ' + error.message, 'error');
        }
      });
    }

    function deletePriority(index) {
      if (confirm('Are you sure you want to delete this priority flag? This action cannot be undone.')) {
        const priorities = JSON.parse(localStorage.getItem('admissionsPriorities') || '[]');
        const deletedPriority = priorities[index];
        priorities.splice(index, 1);
        localStorage.setItem('admissionsPriorities', JSON.stringify(priorities));

        // Add to history
        addToHistory('priority_deleted', `Deleted priority flag: ${deletedPriority.name}`, { priorityId: deletedPriority.id });

        showTab('priorities');
        showNotification('Priority flag deleted successfully!', 'success');
      }
    }

    function togglePriority(index) {
      const priorities = JSON.parse(localStorage.getItem('admissionsPriorities') || '[]');
      priorities[index].active = !priorities[index].active;
      priorities[index].lastModified = new Date().toISOString();
      localStorage.setItem('admissionsPriorities', JSON.stringify(priorities));

      // Add to history
      addToHistory('priority_updated', `${priorities[index].active ? 'Enabled' : 'Disabled'} priority flag: ${priorities[index].name}`, { priorityId: priorities[index].id });

      showTab('priorities');
      showNotification(`Priority flag ${priorities[index].active ? 'enabled' : 'disabled'} successfully!`, 'success');
    }

    // Override Functions
    function processReassignment() {
      const applicationId = document.getElementById('reassignApplicationId').value;
      const currentReviewerId = document.getElementById('reassignCurrentReviewer').value;
      const newReviewerId = document.getElementById('reassignNewReviewer').value;
      const reason = document.getElementById('reassignReason').value;

      if (!applicationId || !currentReviewerId || !newReviewerId) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }

      if (currentReviewerId === newReviewerId) {
        showNotification('Current and new reviewer cannot be the same', 'error');
        return;
      }

      // Update reviewer workloads
      const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');
      const currentIndex = reviewers.findIndex(r => r.id === currentReviewerId);
      const newIndex = reviewers.findIndex(r => r.id === newReviewerId);

      if (currentIndex !== -1) reviewers[currentIndex].workload = Math.max(0, reviewers[currentIndex].workload - 1);
      if (newIndex !== -1) reviewers[newIndex].workload += 1;

      localStorage.setItem(ROUTING_STORAGE.reviewers, JSON.stringify(reviewers));

      // Record the override
      const overrides = JSON.parse(localStorage.getItem('admissionsOverrides') || '[]');
      const override = {
        id: 'override_' + Date.now(),
        applicationId,
        fromReviewerId: currentReviewerId,
        toReviewerId: newReviewerId,
        reason: reason || 'Manual reassignment',
        timestamp: new Date().toISOString(),
        performedBy: 'Admin' // In real app, this would be the logged-in user
      };

      overrides.push(override);
      localStorage.setItem('admissionsOverrides', JSON.stringify(overrides));

      // Add to history
      const currentReviewer = reviewers.find(r => r.id === currentReviewerId);
      const newReviewer = reviewers.find(r => r.id === newReviewerId);
      addToHistory('manual_override', `Reassigned ${applicationId} from ${currentReviewer ? currentReviewer.name : 'unknown'} to ${newReviewer ? newReviewer.name : 'unknown'}`, {
        applicationId,
        fromReviewer: currentReviewer ? currentReviewer.name : 'unknown',
        toReviewer: newReviewer ? newReviewer.name : 'unknown',
        reason
      });

      // Clear form
      document.getElementById('reassignApplicationId').value = '';
      document.getElementById('reassignCurrentReviewer').value = '';
      document.getElementById('reassignNewReviewer').value = '';
      document.getElementById('reassignReason').value = '';

      showTab('overrides');
      showNotification('Application reassigned successfully!', 'success');
    }

    function revertOverride(index) {
      if (confirm('Are you sure you want to revert this reassignment? This will restore the original assignment.')) {
        const overrides = JSON.parse(localStorage.getItem('admissionsOverrides') || '[]');
        const override = overrides[index];

        // Update reviewer workloads (revert)
        const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');
        const fromIndex = reviewers.findIndex(r => r.id === override.fromReviewerId);
        const toIndex = reviewers.findIndex(r => r.id === override.toReviewerId);

        if (fromIndex !== -1) reviewers[fromIndex].workload += 1;
        if (toIndex !== -1) reviewers[toIndex].workload = Math.max(0, reviewers[toIndex].workload - 1);

        localStorage.setItem(ROUTING_STORAGE.reviewers, JSON.stringify(reviewers));

        // Add to history
        const fromReviewer = reviewers.find(r => r.id === override.fromReviewerId);
        const toReviewer = reviewers.find(r => r.id === override.toReviewerId);
        addToHistory('manual_override', `Reverted reassignment of ${override.applicationId} back to ${fromReviewer ? fromReviewer.name : 'unknown'}`, {
          applicationId: override.applicationId,
          revertedFrom: toReviewer ? toReviewer.name : 'unknown',
          revertedTo: fromReviewer ? fromReviewer.name : 'unknown'
        });

        // Remove override record
        overrides.splice(index, 1);
        localStorage.setItem('admissionsOverrides', JSON.stringify(overrides));

        showTab('overrides');
        showNotification('Assignment reverted successfully!', 'success');
      }
    }

    // Simulation Function
    function simulateApplicationProcessing() {
      const modal = document.createElement('div');
      modal.id = 'simulationModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">üéØ System Simulation</h3>

          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Simulation Parameters</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Number of Applications</label>
                <input type="number" id="simApplications" value="50" min="1" max="1000" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Processing Speed</label>
                <select id="simSpeed" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="fast">Fast (10ms delay)</option>
                  <option value="normal" selected>Normal (100ms delay)</option>
                  <option value="slow">Slow (500ms delay)</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="simShowDetails" style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Show detailed processing log</span>
              </label>
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 1rem;">
              <button onclick="startSimulation()" id="startSimBtn" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: 600;">üöÄ Start Simulation</button>
              <button onclick="stopSimulation()" id="stopSimBtn" style="background: #dc2626; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: 600;" disabled>‚èπÔ∏è Stop</button>
              <button onclick="clearSimulation()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">üóëÔ∏è Clear Results</button>
            </div>
          </div>

          <!-- Progress Bar -->
          <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
              <span style="font-size: 0.875rem; color: #374151;">Progress</span>
              <span id="simProgress" style="font-size: 0.875rem; color: #6b7280;">0 / 0</span>
            </div>
            <div style="background: #f3f4f6; border-radius: 4px; height: 8px; overflow: hidden;">
              <div id="simProgressBar" style="background: #5a5bb8; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>

          <!-- Results -->
          <div id="simResults" style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; min-height: 200px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;"></div>

          <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
            <button onclick="exportSimulationResults()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">üì• Export Results</button>
            <button onclick="closeModal('simulationModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    let simulationInterval;
    let simulationData = [];

    function startSimulation() {
      const numApplications = parseInt(document.getElementById('simApplications').value);
      const speed = document.getElementById('simSpeed').value;
      const showDetails = document.getElementById('simShowDetails').checked;

      const delays = { fast: 10, normal: 100, slow: 500 };
      const delay = delays[speed];

      document.getElementById('startSimBtn').disabled = true;
      document.getElementById('stopSimBtn').disabled = false;

      const rules = JSON.parse(localStorage.getItem('admissionsRules') || '[]').filter(r => r.active);
      const assignments = JSON.parse(localStorage.getItem('admissionsAssignments') || '[]').filter(a => a.active);
      const priorities = JSON.parse(localStorage.getItem('admissionsPriorities') || '[]').filter(p => p.active);
      const reviewers = JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]');

      let processed = 0;
      simulationData = [];

      const resultsDiv = document.getElementById('simResults');
      resultsDiv.innerHTML = '<div style="color: #5a5bb8; font-weight: bold;">üöÄ Starting simulation...</div>';

      simulationInterval = setInterval(() => {
        if (processed >= numApplications) {
          stopSimulation();
          return;
        }

        // Generate mock application
        const application = generateMockApplication();

        // Process through routing system
        const result = processApplication(application, rules, assignments, priorities, reviewers);
        simulationData.push(result);

        processed++;

        // Update progress
        const progressPercent = (processed / numApplications) * 100;
        document.getElementById('simProgressBar').style.width = progressPercent + '%';
        document.getElementById('simProgress').textContent = `${processed} / ${numApplications}`;

        // Update results display
        if (showDetails) {
          const logEntry = `[${new Date().toLocaleTimeString()}] ${application.id}: ${result.status} ‚Üí ${result.assignedReviewer || 'Unassigned'}`;
          resultsDiv.innerHTML += `<div style="color: ${result.status === 'assigned' ? '#3b82f6' : '#dc2626'}">${logEntry}</div>`;
          resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

      }, delay);
    }

    function stopSimulation() {
      clearInterval(simulationInterval);
      document.getElementById('startSimBtn').disabled = false;
      document.getElementById('stopSimBtn').disabled = true;

      // Show summary
      const summary = generateSimulationSummary();
      const resultsDiv = document.getElementById('simResults');

      if (!document.getElementById('simShowDetails').checked) {
        resultsDiv.innerHTML = summary;
      } else {
        resultsDiv.innerHTML += '<div style="border-top: 1px solid #e5e7eb; margin-top: 1rem; padding-top: 1rem;">' + summary + '</div>';
      }

      // Add to history
      addToHistory('simulation_completed', `Completed simulation with ${simulationData.length} applications`, {
        applications: simulationData.length,
        assigned: simulationData.filter(r => r.status === 'assigned').length,
        failed: simulationData.filter(r => r.status === 'failed').length
      });
    }

    function clearSimulation() {
      document.getElementById('simResults').innerHTML = '<div style="color: #6b7280;">Simulation results will appear here...</div>';
      document.getElementById('simProgressBar').style.width = '0%';
      document.getElementById('simProgress').textContent = '0 / 0';
      simulationData = [];
    }

    function generateMockApplication() {
      const programs = ['Computer Science', 'Engineering', 'Business', 'Biology', 'Physics', 'Chemistry'];
      const countries = ['USA', 'Canada', 'UK', 'Germany', 'China', 'India', 'Japan'];

      return {
        id: 'APP-' + new Date().getFullYear() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
        program: programs[Math.floor(Math.random() * programs.length)],
        score: Math.floor(Math.random() * 40) + 60, // 60-100
        country: countries[Math.floor(Math.random() * countries.length)],
        scholarshipEligible: Math.random() > 0.7,
        submissionDate: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000), // Last 30 days
        priority: Math.floor(Math.random() * 5) + 1
      };
    }

    function processApplication(application, rules, assignments, priorities, reviewers) {
      try {
        // Apply routing rules
        const matchedRule = rules.find(rule => {
          // Simple rule matching logic
          if (rule.conditions.program && rule.conditions.program !== application.program) return false;
          if (rule.conditions.minScore && application.score < rule.conditions.minScore) return false;
          return true;
        });

        // Apply assignments
        const matchedAssignment = assignments.find(assignment => {
          if (assignment.conditions.program && assignment.conditions.program !== application.program) return false;
          return true;
        });

        // Select reviewer based on assignment strategy
        let selectedReviewer;
        if (matchedAssignment && matchedAssignment.reviewers.length > 0) {
          const availableReviewers = reviewers.filter(r => matchedAssignment.reviewers.includes(r.id));

          switch (matchedAssignment.strategy) {
            case 'workload_balanced':
              selectedReviewer = availableReviewers.reduce((min, reviewer) =>
                reviewer.workload < min.workload ? reviewer : min
              );
              break;
            case 'round_robin':
              selectedReviewer = availableReviewers[Math.floor(Math.random() * availableReviewers.length)];
              break;
            default:
              selectedReviewer = availableReviewers[0];
          }
        }

        return {
          applicationId: application.id,
          status: selectedReviewer ? 'assigned' : 'failed',
          assignedReviewer: selectedReviewer ? selectedReviewer.name : null,
          matchedRule: matchedRule ? matchedRule.name : null,
          matchedAssignment: matchedAssignment ? matchedAssignment.name : null,
          processTime: Math.random() * 500 + 50 // 50-550ms
        };

      } catch (error) {
        return {
          applicationId: application.id,
          status: 'error',
          error: error.message,
          processTime: 0
        };
      }
    }

    function generateSimulationSummary() {
      const assigned = simulationData.filter(r => r.status === 'assigned').length;
      const failed = simulationData.filter(r => r.status === 'failed').length;
      const errors = simulationData.filter(r => r.status === 'error').length;
      const avgProcessTime = simulationData.reduce((sum, r) => sum + (r.processTime || 0), 0) / simulationData.length;

      return `
        <div style="color: #374151; font-weight: bold;">üìä SIMULATION SUMMARY</div>
        <div style="color: #6b7280; margin: 0.5rem 0;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
        <div style="color: #3b82f6;">‚úÖ Successfully Assigned: ${assigned}</div>
        <div style="color: #f59e0b;">‚ö†Ô∏è Assignment Failed: ${failed}</div>
        <div style="color: #dc2626;">‚ùå Processing Errors: ${errors}</div>
        <div style="color: #6b7280;">‚è±Ô∏è Average Process Time: ${avgProcessTime.toFixed(2)}ms</div>
        <div style="color: #6b7280; margin: 0.5rem 0;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
        <div style="color: #374151;">Success Rate: ${((assigned / simulationData.length) * 100).toFixed(1)}%</div>
      `;
    }

    function exportSimulationResults() {
      if (simulationData.length === 0) {
        showNotification('No simulation data to export', 'error');
        return;
      }

      const data = {
        timestamp: new Date().toISOString(),
        summary: {
          total: simulationData.length,
          assigned: simulationData.filter(r => r.status === 'assigned').length,
          failed: simulationData.filter(r => r.status === 'failed').length,
          errors: simulationData.filter(r => r.status === 'error').length
        },
        results: simulationData
      };

      downloadJSON(data, `simulation_results_${new Date().toISOString().split('T')[0]}.json`);
      showNotification('Simulation results exported successfully!', 'success');
    }

    // Export/Import Functions
    function exportConfiguration() {
      const config = {
        timestamp: new Date().toISOString(),
        version: '1.0',
        rules: JSON.parse(localStorage.getItem('admissionsRules') || '[]'),
        assignments: JSON.parse(localStorage.getItem('admissionsAssignments') || '[]'),
        priorities: JSON.parse(localStorage.getItem('admissionsPriorities') || '[]'),
        reviewers: JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]'),
        history: JSON.parse(localStorage.getItem('admissionsHistory') || '[]').slice(-100) // Last 100 entries
      };

      downloadJSON(config, `admissions_config_${new Date().toISOString().split('T')[0]}.json`);
      showNotification('Configuration exported successfully!', 'success');
    }

    function importConfiguration() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
          try {
            const config = JSON.parse(event.target.result);

            // Validate configuration
            if (!config.version || !Array.isArray(config.rules)) {
              throw new Error('Invalid configuration file format');
            }

            if (confirm('This will replace all current configuration. Are you sure you want to continue?')) {
              // Import data
              if (config.rules) localStorage.setItem('admissionsRules', JSON.stringify(config.rules));
              if (config.assignments) localStorage.setItem('admissionsAssignments', JSON.stringify(config.assignments));
              if (config.priorities) localStorage.setItem('admissionsPriorities', JSON.stringify(config.priorities));
              if (config.reviewers) localStorage.setItem(ROUTING_STORAGE.reviewers, JSON.stringify(config.reviewers));

              // Add import to history
              addToHistory('config_imported', `Configuration imported from ${file.name}`, {
                rules: config.rules ? config.rules.length : 0,
                assignments: config.assignments ? config.assignments.length : 0,
                priorities: config.priorities ? config.priorities.length : 0,
                reviewers: config.reviewers ? config.reviewers.length : 0
              });

              // Refresh current tab
              const activeTab = document.querySelector('.tab-button.active');
              if (activeTab) {
                showTab(activeTab.getAttribute('onclick').match(/'(\w+)'/)[1]);
              }

              showNotification('Configuration imported successfully!', 'success');
            }

          } catch (error) {
            showNotification('Error importing configuration: ' + error.message, 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // History Functions
    function addToHistory(type, description, details = null) {
      const history = JSON.parse(localStorage.getItem('admissionsHistory') || '[]');

      const entry = {
        id: 'history_' + Date.now(),
        type,
        description,
        details,
        timestamp: new Date().toISOString(),
        user: 'Admin' // In real app, this would be the logged-in user
      };

      history.push(entry);

      // Keep only last 500 entries to prevent storage bloat
      if (history.length > 500) {
        history.splice(0, history.length - 500);
      }

      localStorage.setItem('admissionsHistory', JSON.stringify(history));
    }

    function clearHistory() {
      if (confirm('Are you sure you want to clear all history? This action cannot be undone.')) {
        localStorage.setItem('admissionsHistory', '[]');
        showTab('history');
        showNotification('History cleared successfully!', 'success');
      }
    }

    function exportHistory() {
      const history = JSON.parse(localStorage.getItem('admissionsHistory') || '[]');
      if (history.length === 0) {
        showNotification('No history to export', 'error');
        return;
      }

      downloadJSON(history, `admissions_history_${new Date().toISOString().split('T')[0]}.json`);
      showNotification('History exported successfully!', 'success');
    }

    // Utility Functions
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.remove();
      }
    }

    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 2000;
        background: ${type === 'success' ? '#3b82f6' : type === 'error' ? '#dc2626' : '#5a5bb8'};
        color: white; padding: 1rem 1.5rem; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 600; max-width: 400px;
        transform: translateX(100%); transition: transform 0.3s;
      `;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => notification.style.transform = 'translateX(0)', 100);
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // ============================================
    // QUICK SETUP FUNCTIONS
    // ============================================

    // Create basic routing rule
    window.createBasicRoutingRule = function() {
      const modal = document.createElement('div');
      modal.id = 'basicRuleModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #5a5bb8, #6b6ce8); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚öôÔ∏è</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Create Basic Routing Rule</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Set up program-based application routing</p>
          </div>

          <form id="basicRuleForm" onsubmit="saveBasicRule(event)">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Rule Name *</label>
              <input type="text" name="name" required value="Program-Based Routing" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;" placeholder="e.g., Computer Science Applications">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Program Type *</label>
              <select name="program" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="">Select Program</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Engineering">Engineering</option>
                <option value="Business">Business Administration</option>
                <option value="Liberal Arts">Liberal Arts</option>
                <option value="Sciences">Natural Sciences</option>
                <option value="Medicine">Medicine</option>
                <option value="Law">Law</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Route To *</label>
              <select name="destination" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="">Select Destination</option>
                <option value="Department Review">Department Review</option>
                <option value="Admissions Committee">Admissions Committee</option>
                <option value="Program Director">Program Director</option>
                <option value="Faculty Review">Faculty Review</option>
              </select>
            </div>

            <div style="margin-bottom: 2rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Priority Level</label>
              <select name="priority" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="1">High Priority (1)</option>
                <option value="2" selected>Medium Priority (2)</option>
                <option value="3">Low Priority (3)</option>
              </select>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="closeModal('basicRuleModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Create Rule</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    };

    // Setup auto assignment
    window.setupAutoAssignment = function() {
      const modal = document.createElement('div');
      modal.id = 'autoAssignModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #3b82f6); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üë•</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Setup Auto-Assignment</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Automatically assign applications to reviewers</p>
          </div>

          <form id="autoAssignForm" onsubmit="saveAutoAssignment(event)">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Assignment Rule Name *</label>
              <input type="text" name="name" required value="Balanced Workload Assignment" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Assignment Strategy *</label>
              <select name="strategy" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="workload-balanced">Workload Balanced</option>
                <option value="round-robin">Round Robin</option>
                <option value="expertise-matched">Expertise Matched</option>
                <option value="random">Random Assignment</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Apply To</label>
              <select name="applyTo" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="all">All Applications</option>
                <option value="undergraduate">Undergraduate Only</option>
                <option value="graduate">Graduate Only</option>
                <option value="international">International Students</option>
              </select>
            </div>

            <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 2rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #1e40af; font-size: 0.9rem;">Assignment Preview</h4>
              <p style="margin: 0; color: #1e40af; font-size: 0.8rem;">This will automatically distribute applications among available reviewers based on their current workload and capacity.</p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="closeModal('autoAssignModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Create Assignment</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    };

    // Create priority flag
    window.createPriorityFlag = function() {
      const modal = document.createElement('div');
      modal.id = 'priorityFlagModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üö©</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Create Priority Flag</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Flag high-priority applications for special attention</p>
          </div>

          <form id="priorityFlagForm" onsubmit="savePriorityFlag(event)">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Flag Name *</label>
              <input type="text" name="name" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;" placeholder="e.g., International Students">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Flag Type *</label>
              <select name="type" required onchange="updateFlagDetails(this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="">Select Type</option>
                <option value="international">International Students</option>
                <option value="scholarship">Scholarship Eligible</option>
                <option value="vip">VIP/Legacy</option>
                <option value="urgent">Urgent Review</option>
                <option value="custom">Custom Criteria</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Priority Weight</label>
              <select name="weight" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="1">Critical (1)</option>
                <option value="2" selected>High (2)</option>
                <option value="3">Medium (3)</option>
                <option value="4">Low (4)</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Flag Color</label>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <div onclick="selectColor(this, '#ef4444')" data-color="#ef4444" style="width: 30px; height: 30px; background: #ef4444; border-radius: 50%; cursor: pointer; border: 3px solid #ef4444;"></div>
                <div onclick="selectColor(this, '#f59e0b')" data-color="#f59e0b" style="width: 30px; height: 30px; background: #f59e0b; border-radius: 50%; cursor: pointer; border: 3px solid transparent;"></div>
                <div onclick="selectColor(this, '#3b82f6')" data-color="#3b82f6" style="width: 30px; height: 30px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 3px solid transparent;"></div>
                <div onclick="selectColor(this, '#3b82f6')" data-color="#3b82f6" style="width: 30px; height: 30px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 3px solid transparent;"></div>
                <div onclick="selectColor(this, '#3b82f6')" data-color="#3b82f6" style="width: 30px; height: 30px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 3px solid transparent;"></div>
                <div onclick="selectColor(this, '#ec4899')" data-color="#ec4899" style="width: 30px; height: 30px; background: #ec4899; border-radius: 50%; cursor: pointer; border: 3px solid transparent;"></div>
              </div>
              <input type="hidden" name="color" value="#ef4444">
            </div>

            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 2rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #92400e; font-size: 0.9rem;">Priority Flag Impact</h4>
              <p style="margin: 0; color: #92400e; font-size: 0.8rem;">Flagged applications will be highlighted in the dashboard and can trigger special routing rules or notifications.</p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="closeModal('priorityFlagModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Create Flag</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    };

    // Save functions for quick setup
    window.saveBasicRule = function(event) {
      event.preventDefault();
      const formData = new FormData(event.target);

      const rule = {
        id: Date.now(),
        name: formData.get('name'),
        description: `Automatically route ${formData.get('program')} applications to ${formData.get('destination')}`,
        conditions: {
          program: formData.get('program')
        },
        destination: formData.get('destination'),
        priority: parseInt(formData.get('priority')),
        active: true,
        created: new Date().toISOString()
      };

      const rules = JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]');
      rules.push(rule);
      localStorage.setItem(ROUTING_STORAGE.rules, JSON.stringify(rules));

      addToHistory({
        action: `Created routing rule: ${rule.name}`,
        type: 'rule_created',
        details: rule
      });

      closeModal('basicRuleModal');
      showNotification(`‚úÖ Routing rule "${rule.name}" created successfully!`, 'success');

      // Refresh the current tab if we're in the routing system
      if (document.getElementById('routingContent')) {
        showRoutingTab('rules');
      }
    };

    window.saveAutoAssignment = function(event) {
      event.preventDefault();
      const formData = new FormData(event.target);

      const assignment = {
        id: Date.now(),
        name: formData.get('name'),
        description: `${formData.get('strategy')} assignment for ${formData.get('applyTo')} applications`,
        strategy: formData.get('strategy'),
        conditions: {
          applyTo: formData.get('applyTo')
        },
        active: true,
        created: new Date().toISOString()
      };

      const assignments = JSON.parse(localStorage.getItem(ROUTING_STORAGE.assignments) || '[]');
      assignments.push(assignment);
      localStorage.setItem(ROUTING_STORAGE.assignments, JSON.stringify(assignments));

      addToHistory({
        action: `Created auto-assignment rule: ${assignment.name}`,
        type: 'assignment_created',
        details: assignment
      });

      closeModal('autoAssignModal');
      showNotification(`‚úÖ Auto-assignment "${assignment.name}" created successfully!`, 'success');

      // Refresh the current tab if we're in the routing system
      if (document.getElementById('routingContent')) {
        showRoutingTab('assignments');
      }
    };

    window.savePriorityFlag = function(event) {
      event.preventDefault();
      const formData = new FormData(event.target);

      const flag = {
        id: Date.now(),
        name: formData.get('name'),
        type: formData.get('type'),
        description: `Priority flag for ${formData.get('type')} applications`,
        weight: parseInt(formData.get('weight')),
        color: formData.get('color'),
        active: true,
        created: new Date().toISOString()
      };

      const priorities = JSON.parse(localStorage.getItem(ROUTING_STORAGE.priorities) || '[]');
      priorities.push(flag);
      localStorage.setItem(ROUTING_STORAGE.priorities, JSON.stringify(priorities));

      addToHistory({
        action: `Created priority flag: ${flag.name}`,
        type: 'priority_created',
        details: flag
      });

      closeModal('priorityFlagModal');
      showNotification(`üö© Priority flag "${flag.name}" created successfully!`, 'success');

      // Refresh the current tab if we're in the routing system
      if (document.getElementById('routingContent')) {
        showRoutingTab('priorities');
      }
    };

    // Helper functions
    window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    };

    window.selectColor = function(element, color) {
      // Remove border from all color options
      element.parentElement.querySelectorAll('div').forEach(div => {
        div.style.border = '3px solid transparent';
      });
      // Add border to selected color
      element.style.border = `3px solid ${color}`;
      // Update hidden input
      element.parentElement.parentElement.querySelector('input[name="color"]').value = color;
    };

    window.updateFlagDetails = function(type) {
      const nameInput = document.querySelector('input[name="name"]');
      const typeNames = {
        'international': 'International Students',
        'scholarship': 'Scholarship Eligible',
        'vip': 'VIP Applications',
        'urgent': 'Urgent Review Required',
        'custom': 'Custom Priority Flag'
      };
      if (typeNames[type]) {
        nameInput.value = typeNames[type];
      }
    };

    window.addToHistory = function(entry) {
      const history = JSON.parse(localStorage.getItem(ROUTING_STORAGE.history) || '[]');
      const historyEntry = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        applicationId: entry.applicationId || 'SYSTEM',
        success: true,
        ...entry
      };
      history.push(historyEntry);
      localStorage.setItem(ROUTING_STORAGE.history, JSON.stringify(history));
    };

    window.showNotification = function(message, type = 'info', duration = 3000) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 30000;
        background: ${type === 'success' ? '#3b82f6' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white; padding: 1rem 1.5rem; border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        font-weight: 500; max-width: 400px;
        transform: translateX(100%); transition: transform 0.3s ease;
      `;
      notification.textContent = message;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);

      // Animate out and remove
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 300);
      }, duration);
    };

    // ============================================
    // CRUD FUNCTIONS FOR ROUTING RULES
    // ============================================

    // Edit routing rule
    window.editRule = function(index) {
      const rules = JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]');
      const rule = rules[index];

      if (!rule) return;

      const modal = document.createElement('div');
      modal.id = 'editRuleModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚úèÔ∏è</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Edit Routing Rule</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Modify routing rule configuration</p>
          </div>

          <form id="editRuleForm" onsubmit="saveEditedRule(event, ${index})">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Rule Name *</label>
              <input type="text" name="name" required value="${rule.name}" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Description</label>
              <textarea name="description" rows="2" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">${rule.description}</textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Program Type</label>
              <select name="program" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="">Any Program</option>
                <option value="Computer Science" ${rule.conditions?.program === 'Computer Science' ? 'selected' : ''}>Computer Science</option>
                <option value="Engineering" ${rule.conditions?.program === 'Engineering' ? 'selected' : ''}>Engineering</option>
                <option value="Business" ${rule.conditions?.program === 'Business' ? 'selected' : ''}>Business Administration</option>
                <option value="Liberal Arts" ${rule.conditions?.program === 'Liberal Arts' ? 'selected' : ''}>Liberal Arts</option>
                <option value="Sciences" ${rule.conditions?.program === 'Sciences' ? 'selected' : ''}>Natural Sciences</option>
                <option value="Medicine" ${rule.conditions?.program === 'Medicine' ? 'selected' : ''}>Medicine</option>
                <option value="Law" ${rule.conditions?.program === 'Law' ? 'selected' : ''}>Law</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Route To *</label>
              <select name="destination" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="Department Review" ${rule.destination === 'Department Review' ? 'selected' : ''}>Department Review</option>
                <option value="Admissions Committee" ${rule.destination === 'Admissions Committee' ? 'selected' : ''}>Admissions Committee</option>
                <option value="Program Director" ${rule.destination === 'Program Director' ? 'selected' : ''}>Program Director</option>
                <option value="Faculty Review" ${rule.destination === 'Faculty Review' ? 'selected' : ''}>Faculty Review</option>
              </select>
            </div>

            <div style="margin-bottom: 2rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Priority Level</label>
              <select name="priority" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="1" ${rule.priority === 1 ? 'selected' : ''}>High Priority (1)</option>
                <option value="2" ${rule.priority === 2 ? 'selected' : ''}>Medium Priority (2)</option>
                <option value="3" ${rule.priority === 3 ? 'selected' : ''}>Low Priority (3)</option>
              </select>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="closeModal('editRuleModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Save Changes</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    };

    // Save edited rule
    window.saveEditedRule = function(event, index) {
      event.preventDefault();
      const formData = new FormData(event.target);

      const rules = JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]');

      rules[index] = {
        ...rules[index],
        name: formData.get('name'),
        description: formData.get('description'),
        conditions: {
          program: formData.get('program') || undefined
        },
        destination: formData.get('destination'),
        priority: parseInt(formData.get('priority')),
        modified: new Date().toISOString()
      };

      localStorage.setItem(ROUTING_STORAGE.rules, JSON.stringify(rules));

      addToHistory({
        action: `Updated routing rule: ${rules[index].name}`,
        type: 'rule_updated',
        details: rules[index]
      });

      closeModal('editRuleModal');
      showNotification(`‚úÖ Rule "${rules[index].name}" updated successfully!`, 'success');
      showRoutingTab('rules');
    };

    // Duplicate/Copy rule
    window.duplicateRule = function(index) {
      const rules = JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]');
      const originalRule = rules[index];

      if (!originalRule) return;

      const duplicatedRule = {
        ...originalRule,
        id: Date.now(),
        name: `${originalRule.name} (Copy)`,
        created: new Date().toISOString(),
        modified: undefined
      };

      rules.push(duplicatedRule);
      localStorage.setItem(ROUTING_STORAGE.rules, JSON.stringify(rules));

      addToHistory({
        action: `Duplicated routing rule: ${duplicatedRule.name}`,
        type: 'rule_duplicated',
        details: duplicatedRule
      });

      showNotification(`üìã Rule "${duplicatedRule.name}" created successfully!`, 'success');
      showRoutingTab('rules');
    };

    // Toggle rule (Pause/Enable)
    window.toggleRule = function(index) {
      const rules = JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]');
      const rule = rules[index];

      if (!rule) return;

      rule.active = !rule.active;
      rule.modified = new Date().toISOString();

      localStorage.setItem(ROUTING_STORAGE.rules, JSON.stringify(rules));

      addToHistory({
        action: `${rule.active ? 'Enabled' : 'Paused'} routing rule: ${rule.name}`,
        type: rule.active ? 'rule_enabled' : 'rule_paused',
        details: rule
      });

      showNotification(`${rule.active ? '‚ñ∂Ô∏è Enabled' : '‚è∏Ô∏è Paused'} rule "${rule.name}"!`, 'success');
      showRoutingTab('rules');
    };

    // Delete rule
    window.deleteRule = function(index) {
      const rules = JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]');
      const rule = rules[index];

      if (!rule) return;

      if (confirm(`Are you sure you want to delete the rule "${rule.name}"? This action cannot be undone.`)) {
        const deletedRule = rules.splice(index, 1)[0];
        localStorage.setItem(ROUTING_STORAGE.rules, JSON.stringify(rules));

        addToHistory({
          action: `Deleted routing rule: ${deletedRule.name}`,
          type: 'rule_deleted',
          details: deletedRule
        });

        showNotification(`üóëÔ∏è Rule "${deletedRule.name}" deleted successfully!`, 'success');
        showRoutingTab('rules');
      }
    };

    // ============================================
    // CRUD FUNCTIONS FOR AUTO-ASSIGNMENTS
    // ============================================

    // Edit assignment
    window.editAssignment = function(index) {
      const assignments = JSON.parse(localStorage.getItem(ROUTING_STORAGE.assignments) || '[]');
      const assignment = assignments[index];

      if (!assignment) return;

      const modal = document.createElement('div');
      modal.id = 'editAssignmentModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚úèÔ∏è</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Edit Auto-Assignment</h3>
          </div>

          <form id="editAssignmentForm" onsubmit="saveEditedAssignment(event, ${index})">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Assignment Rule Name *</label>
              <input type="text" name="name" required value="${assignment.name}" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Assignment Strategy *</label>
              <select name="strategy" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="workload-balanced" ${assignment.strategy === 'workload-balanced' ? 'selected' : ''}>Workload Balanced</option>
                <option value="round-robin" ${assignment.strategy === 'round-robin' ? 'selected' : ''}>Round Robin</option>
                <option value="expertise-matched" ${assignment.strategy === 'expertise-matched' ? 'selected' : ''}>Expertise Matched</option>
                <option value="random" ${assignment.strategy === 'random' ? 'selected' : ''}>Random Assignment</option>
              </select>
            </div>

            <div style="margin-bottom: 2rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Apply To</label>
              <select name="applyTo" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="all" ${assignment.conditions?.applyTo === 'all' ? 'selected' : ''}>All Applications</option>
                <option value="undergraduate" ${assignment.conditions?.applyTo === 'undergraduate' ? 'selected' : ''}>Undergraduate Only</option>
                <option value="graduate" ${assignment.conditions?.applyTo === 'graduate' ? 'selected' : ''}>Graduate Only</option>
                <option value="international" ${assignment.conditions?.applyTo === 'international' ? 'selected' : ''}>International Students</option>
              </select>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="closeModal('editAssignmentModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Save Changes</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    };

    // Save edited assignment
    window.saveEditedAssignment = function(event, index) {
      event.preventDefault();
      const formData = new FormData(event.target);

      const assignments = JSON.parse(localStorage.getItem(ROUTING_STORAGE.assignments) || '[]');

      assignments[index] = {
        ...assignments[index],
        name: formData.get('name'),
        description: `${formData.get('strategy')} assignment for ${formData.get('applyTo')} applications`,
        strategy: formData.get('strategy'),
        conditions: {
          applyTo: formData.get('applyTo')
        },
        modified: new Date().toISOString()
      };

      localStorage.setItem(ROUTING_STORAGE.assignments, JSON.stringify(assignments));

      addToHistory({
        action: `Updated auto-assignment: ${assignments[index].name}`,
        type: 'assignment_updated',
        details: assignments[index]
      });

      closeModal('editAssignmentModal');
      showNotification(`‚úÖ Assignment "${assignments[index].name}" updated successfully!`, 'success');
      showRoutingTab('assignments');
    };

    // Toggle assignment
    window.toggleAssignment = function(index) {
      const assignments = JSON.parse(localStorage.getItem(ROUTING_STORAGE.assignments) || '[]');
      const assignment = assignments[index];

      if (!assignment) return;

      assignment.active = !assignment.active;
      assignment.modified = new Date().toISOString();

      localStorage.setItem(ROUTING_STORAGE.assignments, JSON.stringify(assignments));

      addToHistory({
        action: `${assignment.active ? 'Enabled' : 'Paused'} auto-assignment: ${assignment.name}`,
        type: assignment.active ? 'assignment_enabled' : 'assignment_paused',
        details: assignment
      });

      showNotification(`${assignment.active ? '‚ñ∂Ô∏è Enabled' : '‚è∏Ô∏è Paused'} assignment "${assignment.name}"!`, 'success');
      showRoutingTab('assignments');
    };

    // Delete assignment
    window.deleteAssignment = function(index) {
      const assignments = JSON.parse(localStorage.getItem(ROUTING_STORAGE.assignments) || '[]');
      const assignment = assignments[index];

      if (!assignment) return;

      if (confirm(`Are you sure you want to delete the assignment "${assignment.name}"? This action cannot be undone.`)) {
        const deletedAssignment = assignments.splice(index, 1)[0];
        localStorage.setItem(ROUTING_STORAGE.assignments, JSON.stringify(assignments));

        addToHistory({
          action: `Deleted auto-assignment: ${deletedAssignment.name}`,
          type: 'assignment_deleted',
          details: deletedAssignment
        });

        showNotification(`üóëÔ∏è Assignment "${deletedAssignment.name}" deleted successfully!`, 'success');
        showRoutingTab('assignments');
      }
    };

    // ============================================
    // SIMULATION FUNCTION
    // ============================================


    // Export and Import Functions
    window.exportRulesConfig = function() {
      const config = {
        rules: JSON.parse(localStorage.getItem(ROUTING_STORAGE.rules) || '[]'),
        assignments: JSON.parse(localStorage.getItem(ROUTING_STORAGE.assignments) || '[]'),
        priorities: JSON.parse(localStorage.getItem(ROUTING_STORAGE.priorities) || '[]'),
        reviewers: JSON.parse(localStorage.getItem(ROUTING_STORAGE.reviewers) || '[]'),
        exportedAt: new Date().toISOString(),
        version: '1.0'
      };

      const dataStr = JSON.stringify(config, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

      const exportFileDefaultName = `routing-config-${new Date().toISOString().split('T')[0]}.json`;

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();

      showToast('Routing configuration exported successfully!', 'success');

      addToHistory({
        action: 'Exported routing configuration',
        type: 'config_exported',
        details: {
          rules: config.rules.length,
          assignments: config.assignments.length,
          priorities: config.priorities.length,
          reviewers: config.reviewers.length
        }
      });
    };

    window.importRulesConfig = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';

      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const config = JSON.parse(e.target.result);

            // Validate config structure
            if (!config.version || !config.exportedAt) {
              throw new Error('Invalid configuration file format');
            }

            // Show confirmation modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

            modal.innerHTML = `
              <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto;">
                <h3 style="margin: 0 0 1rem 0; color: #dc2626; font-size: 1.25rem;">‚ö†Ô∏è Import Configuration</h3>
                <p style="margin: 0 0 1rem 0; color: #374151;">This will replace your current routing configuration with:</p>
                <ul style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">
                  <li>${config.rules?.length || 0} routing rules</li>
                  <li>${config.assignments?.length || 0} assignment rules</li>
                  <li>${config.priorities?.length || 0} priority flags</li>
                  <li>${config.reviewers?.length || 0} reviewers</li>
                </ul>
                <p style="margin: 0 0 1.5rem 0; color: #dc2626; font-size: 0.875rem; font-weight: 600;">
                  Exported: ${new Date(config.exportedAt).toLocaleString()}
                </p>
                <p style="margin: 0 0 1.5rem 0; color: #dc2626; font-size: 0.875rem;">
                  ‚ö†Ô∏è This action cannot be undone. Your current configuration will be permanently replaced.
                </p>
                <div style="display: flex; gap: 1rem; justify-content: end;">
                  <button onclick="this.closest('div[style*=\\"position: fixed\\"]').remove()"
                          style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                    Cancel
                  </button>
                  <button onclick="confirmImport(${JSON.stringify(config).replace(/"/g, '&quot;')}); this.closest('div[style*=\\"position: fixed\\"]').remove()"
                          style="background: #dc2626; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                    Import & Replace
                  </button>
                </div>
              </div>
            `;

            document.body.appendChild(modal);

          } catch (error) {
            showToast('Invalid configuration file: ' + error.message, 'error');
          }
        };
        reader.readAsText(file);
      };

      input.click();
    };

    window.confirmImport = function(config) {
      try {
        // Import all data
        if (config.rules) localStorage.setItem(ROUTING_STORAGE.rules, JSON.stringify(config.rules));
        if (config.assignments) localStorage.setItem(ROUTING_STORAGE.assignments, JSON.stringify(config.assignments));
        if (config.priorities) localStorage.setItem(ROUTING_STORAGE.priorities, JSON.stringify(config.priorities));
        if (config.reviewers) localStorage.setItem(ROUTING_STORAGE.reviewers, JSON.stringify(config.reviewers));

        showToast('Configuration imported successfully!', 'success');

        addToHistory({
          action: 'Imported routing configuration',
          type: 'config_imported',
          details: {
            rules: config.rules?.length || 0,
            assignments: config.assignments?.length || 0,
            priorities: config.priorities?.length || 0,
            reviewers: config.reviewers?.length || 0,
            importedFrom: config.exportedAt
          }
        });

        // Refresh the current view if routing system is open
        const currentModal = document.getElementById('routingSystemModal');
        if (currentModal) {
          const currentTab = document.querySelector('.routing-tab.active')?.textContent?.trim() || 'Overview';
          showRoutingTab(currentTab.toLowerCase());
        }

      } catch (error) {
        showToast('Import failed: ' + error.message, 'error');
      }
    };

    // Check and prepare for state restoration immediately
    function checkAndPrepareRestoration() {
      const state = loadRoutingState();
      const oneHourAgo = Date.now() - 3600000;

      if (state.isOpen && state.timestamp > oneHourAgo) {
        return true;
      }
      return false;
    }

    // Auto-restore routing system on page load
    function restoreRoutingSystemState() {
      const state = loadRoutingState();
      const oneHourAgo = Date.now() - 3600000;

      if (state.isOpen && state.timestamp > oneHourAgo) {
        // Immediately open routing system
        openRoutingSystem();

        // Restore active tab and maximize state immediately
        requestAnimationFrame(() => {
          // Restore active tab
          if (state.activeTab && state.activeTab !== 'overview') {
            const tabButton = document.querySelector(`.routing-tab[data-tab="${state.activeTab}"]`);
            if (tabButton) {
              // Remove active class from all tabs
              document.querySelectorAll('.routing-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = '#f8fafc';
                tab.style.borderBottom = '3px solid transparent';
                tab.style.color = '#6b7280';
              });

              // Add active class to target tab
              tabButton.classList.add('active');
              tabButton.style.background = 'white';
              tabButton.style.borderBottom = '3px solid #5a5bb8';
              tabButton.style.color = '#5a5bb8';

              // Show the tab content
              showRoutingTab(state.activeTab);
            }
          }

          // Restore maximized state
          if (state.isMaximized) {
            const modal = document.getElementById('routingSystemModal');
            if (modal && !modal.classList.contains('maximized')) {
              toggleFullscreen();
            }
          }

          // Page content is ready after routing system is restored
        });
      }
    }

    // Check state and prepare page as early as possible
    const shouldRestore = checkAndPrepareRestoration();

    // Initialize routing system state restoration
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', restoreRoutingSystemState);
    } else {
      if (shouldRestore) {
        restoreRoutingSystemState();
      }
    }

    // Interview Scheduling System
    const INTERVIEW_STORAGE = {
      slots: 'interview_slots',
      bookings: 'interview_bookings',
      reviewers: 'interview_reviewers',
      settings: 'interview_settings',
      notes: 'interview_notes',
      history: 'interview_history'
    };

    // Initialize interview system data
    function initializeInterviewData() {
      // Initialize sample reviewers for interviews
      if (!localStorage.getItem(INTERVIEW_STORAGE.reviewers)) {
        const sampleInterviewers = [
          {
            id: '1',
            name: 'Dr. Sarah Johnson',
            email: 'sarah.johnson@university.edu',
            department: 'Computer Science',
            phone: '+1-555-0123',
            availability: ['monday', 'tuesday', 'wednesday', 'friday'],
            maxDailySlots: 4,
            slotDuration: 45,
            breakDuration: 15,
            specializations: ['Machine Learning', 'Software Engineering'],
            notes: 'Experienced interviewer, prefers technical discussions',
            active: true,
            createdAt: new Date().toISOString(),
            totalInterviews: 0,
            rating: 0
          },
          {
            id: '2',
            name: 'Prof. Michael Chen',
            email: 'michael.chen@university.edu',
            department: 'Engineering',
            phone: '+1-555-0124',
            availability: ['monday', 'wednesday', 'thursday', 'friday'],
            maxDailySlots: 3,
            slotDuration: 60,
            breakDuration: 30,
            specializations: ['Mechanical Engineering', 'Robotics'],
            notes: 'Focuses on practical engineering applications',
            active: true,
            createdAt: new Date().toISOString(),
            totalInterviews: 0,
            rating: 0
          },
          {
            id: '3',
            name: 'Dr. Emily Rodriguez',
            email: 'emily.rodriguez@university.edu',
            department: 'Business',
            phone: '+1-555-0125',
            availability: ['tuesday', 'wednesday', 'thursday'],
            maxDailySlots: 5,
            slotDuration: 30,
            breakDuration: 10,
            specializations: ['Finance', 'Marketing', 'Strategy'],
            notes: 'Quick interviewer, good for high-volume days',
            active: true,
            createdAt: new Date().toISOString(),
            totalInterviews: 0,
            rating: 0
          },
          {
            id: '4',
            name: 'Prof. David Williams',
            email: 'david.williams@university.edu',
            department: 'Liberal Arts',
            phone: '+1-555-0126',
            availability: ['monday', 'tuesday', 'thursday', 'friday'],
            maxDailySlots: 3,
            slotDuration: 45,
            breakDuration: 15,
            specializations: ['Literature', 'Philosophy', 'Creative Writing'],
            notes: 'Excellent at assessing communication skills',
            active: true,
            createdAt: new Date().toISOString(),
            totalInterviews: 0,
            rating: 0
          }
        ];
        localStorage.setItem(INTERVIEW_STORAGE.reviewers, JSON.stringify(sampleInterviewers));
      } else {
        // Migrate existing data to new format if needed
        const existingReviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');
        let needsMigration = false;

        const migratedReviewers = existingReviewers.map(reviewer => {
          if (typeof reviewer.id === 'number' || reviewer.preferences) {
            needsMigration = true;
            return {
              ...reviewer,
              id: reviewer.id.toString(), // Convert numeric IDs to strings
              phone: reviewer.phone || '',
              slotDuration: reviewer.preferences?.duration || reviewer.slotDuration || 45,
              breakDuration: reviewer.preferences?.breakBetween || reviewer.breakDuration || 15,
              specializations: reviewer.specializations || [],
              notes: reviewer.notes || '',
              active: reviewer.active !== undefined ? reviewer.active : true,
              createdAt: reviewer.createdAt || new Date().toISOString(),
              totalInterviews: reviewer.totalInterviews || 0,
              rating: reviewer.rating || 0
            };
          }
          return reviewer;
        });

        if (needsMigration) {
          // Remove the old preferences property
          migratedReviewers.forEach(reviewer => {
            delete reviewer.preferences;
          });
          localStorage.setItem(INTERVIEW_STORAGE.reviewers, JSON.stringify(migratedReviewers));
        }
      }

      // Initialize default settings
      if (!localStorage.getItem(INTERVIEW_STORAGE.settings)) {
        const defaultSettings = {
          institutionHours: { start: '09:00', end: '17:00' },
          slotDuration: 45,
          breakDuration: 15,
          advanceBookingDays: 14,
          rescheduleDeadlineHours: 24,
          autoReminders: true,
          reminderTimes: [24, 2], // hours before
          timezone: 'America/New_York'
        };
        localStorage.setItem(INTERVIEW_STORAGE.settings, JSON.stringify(defaultSettings));
      }
    }

    // Main interview system function
    window.openInterviewSystem = function(restoreMaximized = false, restoreTab = 'calendar') {
      initializeInterviewData();

      // Save state that the system is now open
      saveInterviewState(true, restoreTab, restoreMaximized);

      const modal = document.createElement('div');
      modal.id = 'interviewSystemModal';

      // Apply correct styling based on maximized state from the start
      if (restoreMaximized) {
        modal.classList.add('maximized');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); display: flex; align-items: stretch; justify-content: stretch; z-index: 25000; padding: 0; margin: 0;';
      } else {
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 25000; padding: 2rem;';
      }

      // Apply correct content styling based on maximized state
      const contentStyle = restoreMaximized
        ? 'background: white; border-radius: 0; width: 100%; height: 100%; max-width: none; overflow: hidden; display: flex; flex-direction: column;'
        : 'background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 90vh; overflow: hidden; display: flex; flex-direction: column;';

      // Set correct button text and icon based on maximized state
      const fullscreenIcon = restoreMaximized ? '‚õ∑' : '‚õ∂';
      const fullscreenText = restoreMaximized ? 'Restore' : 'Maximize';

      modal.innerHTML = `
        <div style="${contentStyle}">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="display: flex; align-items: center;">
                <svg width="48" height="48" fill="white" style="margin-right: 1rem;">
                  <rect x="4" y="6" width="40" height="28" rx="3" fill="none" stroke="white" stroke-width="2"/>
                  <path d="M4 14h40M12 6v8M20 6v8M28 6v8M36 6v8" stroke="white" stroke-width="1.5"/>
                  <circle cx="14" cy="20" r="2" fill="#3b82f6"/>
                  <circle cx="22" cy="20" r="2" fill="#f59e0b"/>
                  <circle cx="30" cy="20" r="2" fill="#3b82f6"/>
                  <path d="M38 18h4v4h-4z" fill="#3b82f6" opacity="0.7"/>
                  <path d="M38 24h4v4h-4z" fill="#f59e0b" opacity="0.7"/>
                </svg>
                <div>
                  <h2 style="margin: 0; font-size: 1.8rem;">Interview Scheduling System</h2>
                  <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Comprehensive interview and calendar management</p>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="backToAdmissionsFromInterview()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                  <span style="font-size: 1rem;">‚Üê</span>
                  <span style="font-size: 0.8rem;">Back to Admissions</span>
                </button>
                <button onclick="toggleInterviewFullscreen()" id="interviewFullscreenBtn" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                  <span id="interviewFullscreenIcon">${fullscreenIcon}</span>
                  <span id="interviewFullscreenText" style="font-size: 0.8rem;">${fullscreenText}</span>
                </button>
                <button onclick="closeInterviewSystem()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>
              </div>
            </div>
          </div>

          <!-- Navigation Tabs -->
          <div style="background: #f8fafc; border-bottom: 2px solid #e2e8f0; display: flex; overflow-x: auto;">
            <button class="interview-tab active" data-tab="calendar" style="padding: 1rem 2rem; border: none; background: white; border-bottom: 3px solid #667eea; color: #667eea; font-weight: 600; cursor: pointer; white-space: nowrap;">üìÖ Calendar View</button>
            <button class="interview-tab" data-tab="slots" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">‚è∞ Time Slots</button>
            <button class="interview-tab" data-tab="bookings" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üìã Bookings</button>
            <button class="interview-tab" data-tab="reviewers" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üë• Interviewers</button>
            <button class="interview-tab" data-tab="attendance" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">‚úÖ Attendance</button>
            <button class="interview-tab" data-tab="reports" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üìä Reports</button>
            <button class="interview-tab" data-tab="settings" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">‚öôÔ∏è Settings</button>
          </div>

          <!-- Content Area -->
          <div id="interviewContent" style="flex: 1; overflow-y: auto; padding: 0;">
            <!-- Dynamic content will be loaded here -->
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      setupInterviewTabs();
      showInterviewTab(restoreTab);
    };

    // Close interview system
    window.closeInterviewSystem = function() {
      // Save state that the system is now closed
      saveInterviewState(false);

      const modal = document.getElementById('interviewSystemModal');
      if (modal) modal.remove();
    };

    // Back to admissions
    window.backToAdmissionsFromInterview = function() {
      closeInterviewSystem();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast('Returned to Admissions page', 'info', 2000);
    };

    // Fullscreen toggle for interview system
    window.toggleInterviewFullscreen = function() {
      const modal = document.getElementById('interviewSystemModal');
      const modalContent = modal?.querySelector('div[style*="background: white"]');
      const fullscreenIcon = document.getElementById('interviewFullscreenIcon');
      const fullscreenText = document.getElementById('interviewFullscreenText');

      if (!modal || !modalContent) return;

      const isMaximized = modal.classList.contains('maximized');

      if (isMaximized) {
        modal.classList.remove('maximized');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 25000; padding: 2rem;';
        modalContent.style.cssText = 'background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 90vh; overflow: hidden; display: flex; flex-direction: column;';
        fullscreenIcon.textContent = '‚õ∂';
        fullscreenText.textContent = 'Maximize';

        // Save non-maximized state
        const state = loadInterviewState();
        saveInterviewState(state.isOpen, state.activeTab, false);
      } else {
        modal.classList.add('maximized');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); display: flex; align-items: stretch; justify-content: stretch; z-index: 25000; padding: 0; margin: 0;';
        modalContent.style.cssText = 'background: white; border-radius: 0; width: 100%; height: 100%; max-width: none; overflow: hidden; display: flex; flex-direction: column;';
        fullscreenIcon.textContent = '‚õ∑';
        fullscreenText.textContent = 'Restore';

        // Save maximized state
        const state = loadInterviewState();
        saveInterviewState(state.isOpen, state.activeTab, true);
      }
    };

    // Setup interview tab navigation
    function setupInterviewTabs() {
      document.querySelectorAll('.interview-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const targetTab = this.dataset.tab;

          // Remove active class from all tabs
          document.querySelectorAll('.interview-tab').forEach(t => {
            t.classList.remove('active');
            t.style.background = '#f8fafc';
            t.style.borderBottom = '3px solid transparent';
            t.style.color = '#6b7280';
          });

          // Add active class to clicked tab
          this.classList.add('active');
          this.style.background = 'white';
          this.style.borderBottom = '3px solid #667eea';
          this.style.color = '#667eea';

          // Show corresponding content
          showInterviewTab(targetTab);
        });
      });
    }

    // Show interview tab content
    function showInterviewTab(tabName) {
      const content = document.getElementById('interviewContent');
      if (!content) return;

      // Save the active tab to state
      const state = loadInterviewState();
      if (state.isOpen) {
        // Preserve fullscreen state when saving tab changes
        const modal = document.getElementById('interviewSystemModal');
        const isCurrentlyMaximized = modal?.classList.contains('maximized') || false;
        saveInterviewState(true, tabName, isCurrentlyMaximized);
      }

      switch(tabName) {
        case 'calendar':
          content.innerHTML = generateCalendarView();
          break;
        case 'slots':
          content.innerHTML = generateSlotsView();
          break;
        case 'bookings':
          content.innerHTML = generateBookingsView();
          break;
        case 'reviewers':
          content.innerHTML = generateReviewersView();
          break;
        case 'attendance':
          content.innerHTML = generateAttendanceView();
          break;
        case 'reports':
          content.innerHTML = generateReportsView();
          break;
        case 'settings':
          content.innerHTML = generateSettingsView();
          break;
      }
    }

    // Generate Calendar View
    function generateCalendarView() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">üìÖ Interview Calendar</h3>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <div style="display: flex; gap: 0.5rem;">
                <button style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Today</button>
                <button style="background: #f3f4f6; color: #374151; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚óÑ</button>
                <button style="background: #f3f4f6; color: #374151; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚ñ∫</button>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <select style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option>Week View</option>
                  <option>Month View</option>
                  <option>Day View</option>
                </select>
                <select style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option>All Interviewers</option>
                  <option>Dr. Sarah Johnson</option>
                  <option>Prof. Michael Chen</option>
                  <option>Dr. Emily Rodriguez</option>
                  <option>Prof. David Williams</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Calendar Grid -->
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
            <!-- Calendar Header -->
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: #f9fafb;">
              <div style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Sunday</div>
              <div style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Monday</div>
              <div style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Tuesday</div>
              <div style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Wednesday</div>
              <div style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Thursday</div>
              <div style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Friday</div>
              <div style="padding: 1rem; text-align: center; font-weight: 600; color: #374151;">Saturday</div>
            </div>

            <!-- Calendar Body -->
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); min-height: 400px;">
              ${generateCalendarDays(currentYear, currentMonth)}
            </div>
          </div>

          <!-- Quick Actions -->
          <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            <button onclick="openCreateSlotModal()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="16" height="16" fill="white"><path d="M8 4v8m4-4H4"/></svg>
              Create Time Slot
            </button>
            <button onclick="openBulkSlotModal()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="16" height="16" fill="white"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
              Bulk Create Slots
            </button>
            <button onclick="exportCalendar()" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="16" height="16" fill="white"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5l5-5 5 5m-5-5v12"/></svg>
              Export Calendar
            </button>
          </div>
        </div>
      `;
    }

    // Generate calendar days
    function generateCalendarDays(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());

      let days = '';
      let currentDate = new Date(startDate);

      for (let i = 0; i < 42; i++) {
        const isCurrentMonth = currentDate.getMonth() === month;
        const isToday = currentDate.toDateString() === new Date().toDateString();
        const dayNumber = currentDate.getDate();

        const dayStyle = `
          padding: 1rem;
          min-height: 120px;
          border-right: 1px solid #e5e7eb;
          border-bottom: 1px solid #e5e7eb;
          vertical-align: top;
          ${!isCurrentMonth ? 'background: #f9fafb; color: #9ca3af;' : ''}
          ${isToday ? 'background: #eff6ff;' : ''}
        `;

        days += `
          <div style="${dayStyle}">
            <div style="font-weight: ${isToday ? '700' : '500'}; color: ${isToday ? '#1d4ed8' : 'inherit'};">
              ${dayNumber}
            </div>
            <div style="margin-top: 0.5rem;">
              ${generateDaySlots(currentDate)}
            </div>
          </div>
        `;

        currentDate.setDate(currentDate.getDate() + 1);
      }

      return days;
    }

    // Generate slots for a specific day
    function generateDaySlots(date) {
      const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');
      const dateStr = date.toISOString().split('T')[0];

      const daySlots = slots.filter(slot => slot.date === dateStr);

      return daySlots.slice(0, 3).map(slot => `
        <div style="background: #e0f2fe; padding: 0.25rem 0.5rem; margin: 0.25rem 0; border-radius: 4px; font-size: 0.75rem; color: #0369a1;">
          ${slot.startTime}
        </div>
      `).join('') + (daySlots.length > 3 ? `<div style="font-size: 0.75rem; color: #6b7280;">+${daySlots.length - 3} more</div>` : '');
    }

    // Generate Slots View
    function generateSlotsView() {
      const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">‚è∞ Time Slots Management</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="openCreateSlotModal()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                <svg width="16" height="16" fill="white"><path d="M8 4v8m4-4H4"/></svg>
                Create Slot
              </button>
              <button onclick="openBulkSlotModal()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                <svg width="16" height="16" fill="white"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
                Bulk Create
              </button>
            </div>
          </div>

          <!-- Filter and Search -->
          <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Date Range</label>
                <input type="date" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Interviewer</label>
                <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option value="">All Interviewers</option>
                  ${reviewers.map(reviewer => `<option value="${reviewer.id}">${reviewer.name}</option>`).join('')}
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Status</label>
                <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option value="">All Status</option>
                  <option value="available">Available</option>
                  <option value="booked">Booked</option>
                  <option value="blocked">Blocked</option>
                </select>
              </div>
              <button style="background: #6b7280; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer;">Filter</button>
            </div>
          </div>

          <!-- Slots List -->
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
            <div style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr auto; padding: 1rem; background: #f9fafb; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">
              <div>Date</div>
              <div>Time</div>
              <div>Interviewer</div>
              <div>Capacity</div>
              <div>Status</div>
              <div>Actions</div>
            </div>

            ${slots.length === 0 ? `
              <div style="padding: 3rem; text-align: center; color: #6b7280;">
                <svg width="48" height="48" fill="currentColor" style="margin: 0 auto 1rem; opacity: 0.5;">
                  <path d="M8 4v8m4-4H4M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m4-5l5-5 5 5m-5-5v12"/>
                </svg>
                <p style="margin: 0 0 1rem 0; font-size: 1.1rem;">No time slots created yet</p>
                <p style="margin: 0; font-size: 0.9rem;">Create your first interview slot to get started</p>
              </div>
            ` : slots.map((slot, index) => {
              const reviewer = reviewers.find(r => r.id === slot.interviewerId) || { name: 'Unknown' };
              const bookings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.bookings) || '[]');
              const slotBookings = bookings.filter(b => b.slotId === slot.id);
              const isBooked = slotBookings.length >= slot.capacity;
              const status = slot.blocked ? 'blocked' : (isBooked ? 'booked' : 'available');
              const statusColors = {
                available: '#3b82f6',
                booked: '#f59e0b',
                blocked: '#ef4444'
              };

              return `
                <div style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr auto; padding: 1rem; border-bottom: 1px solid #e5e7eb; align-items: center;">
                  <div style="font-weight: 500;">${new Date(slot.date).toLocaleDateString()}</div>
                  <div>
                    <div style="font-weight: 500;">${slot.startTime} - ${slot.endTime}</div>
                    <div style="font-size: 0.8rem; color: #6b7280;">${slot.duration} minutes</div>
                  </div>
                  <div>${reviewer.name}</div>
                  <div>
                    <span style="color: ${statusColors[status]}; font-weight: 600;">${slotBookings.length}/${slot.capacity}</span>
                  </div>
                  <div>
                    <span style="background: ${statusColors[status]}; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; font-weight: 500; text-transform: capitalize;">
                      ${status}
                    </span>
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    <button onclick="editSlot(${index})" style="background: #f59e0b; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">‚úèÔ∏è</button>
                    <button onclick="duplicateSlot(${index})" style="background: #6366f1; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">üìã</button>
                    <button onclick="toggleSlotBlock(${index})" style="background: ${slot.blocked ? '#3b82f6' : '#ef4444'}; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">
                      ${slot.blocked ? '‚úÖ' : 'üö´'}
                    </button>
                    <button onclick="deleteSlot(${index})" style="background: #6b7280; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    // Create slot modal
    window.openCreateSlotModal = function() {
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');
      const settings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.settings) || '{}');

      const modal = document.createElement('div');
      modal.id = 'createSlotModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">‚è∞ Create Interview Slot</h3>

          <form id="createSlotForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Date</label>
              <input type="date" name="date" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" min="${new Date().toISOString().split('T')[0]}">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Start Time</label>
                <input type="time" name="startTime" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" value="${settings.institutionHours?.start || '09:00'}">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Duration (minutes)</label>
                <select name="duration" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option value="30">30 minutes</option>
                  <option value="45" selected>45 minutes</option>
                  <option value="60">60 minutes</option>
                  <option value="90">90 minutes</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Interviewer</label>
              <select name="interviewerId" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Select Interviewer</option>
                ${reviewers.map(reviewer => `<option value="${reviewer.id}">${reviewer.name} - ${reviewer.department}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Capacity</label>
              <input type="number" name="capacity" required min="1" max="10" value="1" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Maximum number of applicants for this slot</div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Notes (Optional)</label>
              <textarea name="notes" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="Special instructions or requirements..."></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('createSlotModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Create Slot</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('createSlotForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const startTime = formData.get('startTime');
        const duration = parseInt(formData.get('duration'));
        const endTime = calculateEndTime(startTime, duration);

        const slot = {
          id: 'slot_' + Date.now(),
          date: formData.get('date'),
          startTime,
          endTime,
          duration,
          interviewerId: parseInt(formData.get('interviewerId')),
          capacity: parseInt(formData.get('capacity')),
          notes: formData.get('notes') || '',
          blocked: false,
          created: new Date().toISOString()
        };

        const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');
        slots.push(slot);
        localStorage.setItem(INTERVIEW_STORAGE.slots, JSON.stringify(slots));

        showToast('Interview slot created successfully!', 'success');
        closeModal('createSlotModal');
        showInterviewTab('slots');
      });
    };

    // Calculate end time
    function calculateEndTime(startTime, duration) {
      const [hours, minutes] = startTime.split(':').map(Number);
      const startMinutes = hours * 60 + minutes;
      const endMinutes = startMinutes + duration;
      const endHours = Math.floor(endMinutes / 60);
      const remainingMinutes = endMinutes % 60;
      return `${endHours.toString().padStart(2, '0')}:${remainingMinutes.toString().padStart(2, '0')}`;
    }

    // Close modal helper
    window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    };

    // Generate Bookings View
    function generateBookingsView() {
      const bookings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.bookings) || '[]');
      const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">üìã Interview Bookings</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="openManualBookingModal()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Manual Booking</button>
              <button onclick="exportBookings()" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Export Bookings</button>
            </div>
          </div>

          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
            ${bookings.length === 0 ? `
              <div style="padding: 3rem; text-align: center; color: #6b7280;">
                <p style="margin: 0; font-size: 1.1rem;">No bookings yet</p>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Bookings will appear here when applicants schedule interviews</p>
              </div>
            ` : `
              <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 1fr 1fr auto; padding: 1rem; background: #f9fafb; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">
                <div>Applicant</div>
                <div>Date</div>
                <div>Time & Interviewer</div>
                <div>Status</div>
                <div>Booked</div>
                <div>Actions</div>
              </div>
              ${bookings.map(booking => {
                const slot = slots.find(s => s.id === booking.slotId);
                const reviewer = reviewers.find(r => r.id === slot?.interviewerId);
                return `
                  <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 1fr 1fr auto; padding: 1rem; border-bottom: 1px solid #e5e7eb; align-items: center;">
                    <div>${booking.applicantName}</div>
                    <div>${slot ? new Date(slot.date).toLocaleDateString() : 'N/A'}</div>
                    <div>
                      <div>${slot ? `${slot.startTime} - ${slot.endTime}` : 'N/A'}</div>
                      <div style="font-size: 0.8rem; color: #6b7280;">${reviewer?.name || 'Unknown'}</div>
                    </div>
                    <div>
                      <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">
                        ${booking.status || 'Confirmed'}
                      </span>
                    </div>
                    <div style="font-size: 0.8rem; color: #6b7280;">${new Date(booking.bookedAt).toLocaleDateString()}</div>
                    <div style="display: flex; gap: 0.5rem;">
                      <button style="background: #f59e0b; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">‚úèÔ∏è</button>
                      <button style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                  </div>
                `;
              }).join('')}
            `}
          </div>
        </div>
      `;
    }

    // Generate Reviewers View
    function generateReviewersView() {
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">üë• Interview Reviewers</h3>
            <button onclick="openAddReviewerModal()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Add Reviewer</button>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            ${reviewers.map(reviewer => `
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                  <div>
                    <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">${reviewer.name}</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">${reviewer.department}</p>
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    <button onclick="editReviewer('${reviewer.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">‚úèÔ∏è</button>
                    <button onclick="deleteReviewer('${reviewer.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">üóëÔ∏è</button>
                  </div>
                </div>

                <div style="margin-bottom: 0.75rem;">
                  <div style="font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">üìß ${reviewer.email}</div>
                  <div style="font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">üìÖ Available: ${reviewer.availability.join(', ')}</div>
                  <div style="font-size: 0.875rem; color: #374151;">‚è∞ Max daily slots: ${reviewer.maxDailySlots}</div>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                  <div style="background: #eff6ff; color: #1d4ed8; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">
                    ${reviewer.slotDuration}min slots
                  </div>
                  <div style="background: #f0fdf4; color: #2563eb; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">
                    ${reviewer.breakDuration}min breaks
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Generate Attendance View
    function generateAttendanceView() {
      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">‚úÖ Attendance Tracking</h3>
            <div style="display: flex; gap: 1rem;">
              <input type="date" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
              <button style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Today's Interviews</button>
            </div>
          </div>

          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 2rem; text-align: center; color: #6b7280;">
            <p style="margin: 0; font-size: 1.1rem;">Attendance tracking coming soon</p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Mark attendance and add interviewer notes</p>
          </div>
        </div>
      `;
    }

    // Generate Reports View
    function generateReportsView() {
      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">üìä Interview Reports</h3>
            <div style="display: flex; gap: 1rem;">
              <select style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option>Last 30 days</option>
                <option>Last 3 months</option>
                <option>This year</option>
              </select>
              <button style="background: #6366f1; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Export Report</button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #667eea;">0</div>
              <div style="color: #6b7280; font-size: 0.9rem;">Total Interviews</div>
            </div>
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">0</div>
              <div style="color: #6b7280; font-size: 0.9rem;">Completed</div>
            </div>
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">0</div>
              <div style="color: #6b7280; font-size: 0.9rem;">No-Shows</div>
            </div>
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #ef4444;">0</div>
              <div style="color: #6b7280; font-size: 0.9rem;">Cancelled</div>
            </div>
          </div>

          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 2rem; text-align: center; color: #6b7280;">
            <p style="margin: 0; font-size: 1.1rem;">Detailed reports coming soon</p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Analytics and insights for interview performance</p>
          </div>
        </div>
      `;
    }

    // Generate Settings View
    function generateSettingsView() {
      const settings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.settings) || '{}');

      return `
        <div style="padding: 2rem;">
          <h3 style="margin: 0 0 2rem 0; color: #1f2937; font-size: 1.4rem;">‚öôÔ∏è Interview Settings</h3>

          <div style="max-width: 600px;">
            <form id="settingsForm">
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: #374151;">Institution Hours</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Start Time</label>
                    <input type="time" name="startTime" value="${settings.institutionHours?.start || '09:00'}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">End Time</label>
                    <input type="time" name="endTime" value="${settings.institutionHours?.end || '17:00'}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  </div>
                </div>
              </div>

              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: #374151;">Default Settings</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Slot Duration (minutes)</label>
                    <select name="slotDuration" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                      <option value="30" ${settings.slotDuration === 30 ? 'selected' : ''}>30 minutes</option>
                      <option value="45" ${settings.slotDuration === 45 ? 'selected' : ''}>45 minutes</option>
                      <option value="60" ${settings.slotDuration === 60 ? 'selected' : ''}>60 minutes</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Break Duration (minutes)</label>
                    <select name="breakDuration" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                      <option value="10" ${settings.breakDuration === 10 ? 'selected' : ''}>10 minutes</option>
                      <option value="15" ${settings.breakDuration === 15 ? 'selected' : ''}>15 minutes</option>
                      <option value="30" ${settings.breakDuration === 30 ? 'selected' : ''}>30 minutes</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Advance Booking Days</label>
                  <input type="number" name="advanceBookingDays" value="${settings.advanceBookingDays || 14}" min="1" max="90" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">How many days in advance can applicants book interviews</div>
                </div>
              </div>

              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: #374151;">Notifications</h4>
                <div style="margin-bottom: 0.75rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="autoReminders" ${settings.autoReminders ? 'checked' : ''} style="cursor: pointer;">
                    <span style="font-size: 0.875rem; color: #374151;">Enable automatic reminders</span>
                  </label>
                </div>
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Reschedule Deadline (hours before)</label>
                  <input type="number" name="rescheduleDeadline" value="${settings.rescheduleDeadlineHours || 24}" min="1" max="168" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
              </div>

              <button type="submit" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Save Settings</button>
            </form>
          </div>
        </div>
      `;
    }

    // Manual Booking functionality
    window.openManualBookingModal = function() {
      const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');
      const bookings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.bookings) || '[]');

      if (slots.length === 0) {
        showToast('No interview slots available. Create slots first.', 'warning');
        return;
      }

      // Filter available slots (not full)
      const availableSlots = slots.filter(slot => {
        if (slot.blocked) return false;
        const slotBookings = bookings.filter(b => b.slotId === slot.id);
        return slotBookings.length < slot.capacity;
      });

      if (availableSlots.length === 0) {
        showToast('No available slots for booking. All slots are full or blocked.', 'warning');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'manualBookingModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üìã Manual Interview Booking</h3>

          <form id="manualBookingForm">
            <!-- Applicant Information -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">üë§ Applicant Information</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Full Name *</label>
                  <input type="text" name="applicantName" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="John Smith">
                </div>
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Email *</label>
                  <input type="email" name="applicantEmail" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="john.smith@email.com">
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Phone Number</label>
                  <input type="tel" name="applicantPhone" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="+1 (555) 123-4567">
                </div>
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Application ID</label>
                  <input type="text" name="applicationId" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="APP-2024-001">
                </div>
              </div>
            </div>

            <!-- Slot Selection -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">üìÖ Available Interview Slots</h4>
              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
                ${availableSlots.map(slot => {
                  const reviewer = reviewers.find(r => r.id === slot.interviewerId) || { name: 'Unknown', department: 'N/A' };
                  const slotBookings = bookings.filter(b => b.slotId === slot.id);
                  const remainingCapacity = slot.capacity - slotBookings.length;

                  return `
                    <label style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='transparent'">
                      <input type="radio" name="slotId" value="${slot.id}" required style="margin-right: 1rem; cursor: pointer;">
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                          ${new Date(slot.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </div>
                        <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280;">
                          <span>üïí ${slot.startTime} - ${slot.endTime}</span>
                          <span>üë• ${reviewer.name}</span>
                          <span>üè¢ ${reviewer.department}</span>
                          <span style="color: #1d4ed8;">üìç ${remainingCapacity}/${slot.capacity} spots available</span>
                        </div>
                      </div>
                    </label>
                  `;
                }).join('')}
              </div>
            </div>

            <!-- Additional Information -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">üìù Additional Information</h4>
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Program/Department</label>
                <select name="program" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option value="">Select Program</option>
                  <option value="Computer Science">Computer Science</option>
                  <option value="Engineering">Engineering</option>
                  <option value="Business">Business</option>
                  <option value="Liberal Arts">Liberal Arts</option>
                  <option value="Sciences">Sciences</option>
                  <option value="Medicine">Medicine</option>
                </select>
              </div>
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Interview Type</label>
                <select name="interviewType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option value="admission">Admission Interview</option>
                  <option value="scholarship">Scholarship Interview</option>
                  <option value="program_specific">Program-Specific Interview</option>
                  <option value="follow_up">Follow-up Interview</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Special Requirements/Notes</label>
                <textarea name="notes" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="Any special accommodations, interview focus areas, or additional notes..."></textarea>
              </div>
            </div>

            <!-- Notification Settings -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">üìß Notifications</h4>
              <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="sendConfirmation" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Send confirmation email</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="sendReminder" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Send reminder 24h before</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="notifyInterviewer" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Notify interviewer</span>
                </label>
              </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('manualBookingModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #1d4ed8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Book Interview</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Add form submission handler
      document.getElementById('manualBookingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        processManualBooking(e.target);
      });
    };

    // Process manual booking
    function processManualBooking(form) {
      const formData = new FormData(form);
      const bookings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.bookings) || '[]');
      const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');

      const slotId = formData.get('slotId');
      const slot = slots.find(s => s.id === slotId);

      if (!slot) {
        showToast('Selected slot not found', 'error');
        return;
      }

      // Check if slot is still available
      const existingBookings = bookings.filter(b => b.slotId === slotId);
      if (existingBookings.length >= slot.capacity) {
        showToast('This slot is now full', 'error');
        return;
      }

      // Create booking
      const booking = {
        id: 'booking_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        slotId: slotId,
        applicantName: formData.get('applicantName'),
        applicantEmail: formData.get('applicantEmail'),
        applicantPhone: formData.get('applicantPhone') || '',
        applicationId: formData.get('applicationId') || '',
        program: formData.get('program') || '',
        interviewType: formData.get('interviewType') || 'admission',
        notes: formData.get('notes') || '',
        status: 'confirmed',
        bookedAt: new Date().toISOString(),
        bookedBy: 'Manual Booking',
        notifications: {
          confirmation: formData.get('sendConfirmation') === 'on',
          reminder: formData.get('sendReminder') === 'on',
          interviewer: formData.get('notifyInterviewer') === 'on'
        }
      };

      bookings.push(booking);
      localStorage.setItem(INTERVIEW_STORAGE.bookings, JSON.stringify(bookings));

      showToast(`Interview booked successfully for ${booking.applicantName}!`, 'success');
      closeModal('manualBookingModal');
      showInterviewTab('bookings');
    }

    // Export Bookings functionality
    window.exportBookings = function() {
      const bookings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.bookings) || '[]');
      const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');

      if (bookings.length === 0) {
        showToast('No bookings to export', 'warning');
        return;
      }

      // Generate CSV content
      let csvContent = 'Booking ID,Applicant Name,Email,Phone,Application ID,Date,Start Time,End Time,Duration,Interviewer,Department,Program,Interview Type,Status,Booked At,Notes\n';

      bookings.forEach(booking => {
        const slot = slots.find(s => s.id === booking.slotId);
        const reviewer = slot ? reviewers.find(r => r.id === slot.interviewerId) : null;

        const row = [
          booking.id || '',
          booking.applicantName || '',
          booking.applicantEmail || '',
          booking.applicantPhone || '',
          booking.applicationId || '',
          slot ? slot.date : 'N/A',
          slot ? slot.startTime : 'N/A',
          slot ? slot.endTime : 'N/A',
          slot ? `${slot.duration} min` : 'N/A',
          reviewer ? reviewer.name : 'Unknown',
          reviewer ? reviewer.department : 'N/A',
          booking.program || '',
          booking.interviewType || '',
          booking.status || 'confirmed',
          booking.bookedAt ? new Date(booking.bookedAt).toLocaleString() : '',
          (booking.notes || '').replace(/,/g, ';').replace(/\n/g, ' ')
        ];

        csvContent += row.map(field => `"${field}"`).join(',') + '\n';
      });

      // Create and download file
      const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
      const exportFileDefaultName = `interview-bookings-${new Date().toISOString().split('T')[0]}.csv`;

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();

      showToast('Bookings exported successfully!', 'success');
    };

    window.openAddReviewerModal = function() {
      const modal = document.createElement('div');
      modal.id = 'addReviewerModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üë§</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Add New Reviewer</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Add a new interviewer to the system</p>
          </div>

          <form id="addReviewerForm" onsubmit="saveNewReviewer(event)">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Full Name *</label>
              <input type="text" name="name" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Email Address *</label>
              <input type="email" name="email" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Department *</label>
              <select name="department" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="">Select Department</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Engineering">Engineering</option>
                <option value="Business">Business</option>
                <option value="Liberal Arts">Liberal Arts</option>
                <option value="Sciences">Sciences</option>
                <option value="Mathematics">Mathematics</option>
                <option value="Medicine">Medicine</option>
                <option value="Law">Law</option>
                <option value="Education">Education</option>
                <option value="Psychology">Psychology</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Phone Number</label>
              <input type="tel" name="phone" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Available Days *</label>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="monday" style="margin: 0;">
                  <span style="font-size: 0.875rem;">Monday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="tuesday" style="margin: 0;">
                  <span style="font-size: 0.875rem;">Tuesday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="wednesday" style="margin: 0;">
                  <span style="font-size: 0.875rem;">Wednesday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="thursday" style="margin: 0;">
                  <span style="font-size: 0.875rem;">Thursday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="friday" style="margin: 0;">
                  <span style="font-size: 0.875rem;">Friday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="saturday" style="margin: 0;">
                  <span style="font-size: 0.875rem;">Saturday</span>
                </label>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Max Daily Slots *</label>
                <input type="number" name="maxDailySlots" min="1" max="20" value="4" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Slot Duration *</label>
                <select name="slotDuration" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                  <option value="30">30 minutes</option>
                  <option value="45" selected>45 minutes</option>
                  <option value="60">60 minutes</option>
                  <option value="90">90 minutes</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Break Between Interviews *</label>
              <select name="breakDuration" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="10">10 minutes</option>
                <option value="15" selected>15 minutes</option>
                <option value="30">30 minutes</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Specializations (Optional)</label>
              <input type="text" name="specializations" placeholder="e.g., Machine Learning, Data Science, Software Engineering" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
              <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Separate multiple specializations with commas</div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Notes (Optional)</label>
              <textarea name="notes" rows="3" placeholder="Any additional notes about this reviewer..." style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="closeModal('addReviewerModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Add Reviewer</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.saveNewReviewer = function(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const availability = Array.from(document.querySelectorAll('input[name="availability"]:checked')).map(cb => cb.value);

      if (availability.length === 0) {
        showToast('Please select at least one available day', 'error');
        return;
      }

      const reviewer = {
        id: Date.now().toString(),
        name: formData.get('name'),
        email: formData.get('email'),
        department: formData.get('department'),
        phone: formData.get('phone') || '',
        availability: availability,
        maxDailySlots: parseInt(formData.get('maxDailySlots')),
        slotDuration: parseInt(formData.get('slotDuration')),
        breakDuration: parseInt(formData.get('breakDuration')),
        specializations: formData.get('specializations') ? formData.get('specializations').split(',').map(s => s.trim()) : [],
        notes: formData.get('notes') || '',
        active: true,
        createdAt: new Date().toISOString(),
        totalInterviews: 0,
        rating: 0
      };

      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');

      // Check for duplicate email
      if (reviewers.some(r => r.email.toLowerCase() === reviewer.email.toLowerCase())) {
        showToast('A reviewer with this email already exists', 'error');
        return;
      }

      reviewers.push(reviewer);
      localStorage.setItem(INTERVIEW_STORAGE.reviewers, JSON.stringify(reviewers));

      // Add to history
      const history = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.history) || '[]');
      history.unshift({
        id: Date.now().toString(),
        action: `Added new reviewer: ${reviewer.name}`,
        type: 'reviewer_added',
        timestamp: new Date().toISOString(),
        details: {
          reviewerName: reviewer.name,
          department: reviewer.department,
          availability: reviewer.availability
        }
      });
      localStorage.setItem(INTERVIEW_STORAGE.history, JSON.stringify(history.slice(0, 100))); // Keep last 100 entries

      closeModal('addReviewerModal');
      showToast(`Reviewer "${reviewer.name}" added successfully!`, 'success');

      // Refresh reviewers tab if it's currently active
      const activeTab = document.querySelector('.interview-tab.active');
      if (activeTab && activeTab.textContent.trim() === 'Reviewers') {
        showInterviewTab('reviewers');
      }
    };

    window.editReviewer = function(reviewerId) {
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');
      const reviewer = reviewers.find(r => r.id === reviewerId);

      if (!reviewer) {
        showToast('Reviewer not found', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editReviewerModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚úèÔ∏è</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Edit Reviewer</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Update reviewer information</p>
          </div>

          <form id="editReviewerForm" onsubmit="saveEditedReviewer(event, '${reviewerId}')">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Full Name *</label>
              <input type="text" name="name" value="${reviewer.name}" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Email Address *</label>
              <input type="email" name="email" value="${reviewer.email}" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Department *</label>
              <select name="department" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="">Select Department</option>
                <option value="Computer Science" ${reviewer.department === 'Computer Science' ? 'selected' : ''}>Computer Science</option>
                <option value="Engineering" ${reviewer.department === 'Engineering' ? 'selected' : ''}>Engineering</option>
                <option value="Business" ${reviewer.department === 'Business' ? 'selected' : ''}>Business</option>
                <option value="Liberal Arts" ${reviewer.department === 'Liberal Arts' ? 'selected' : ''}>Liberal Arts</option>
                <option value="Sciences" ${reviewer.department === 'Sciences' ? 'selected' : ''}>Sciences</option>
                <option value="Mathematics" ${reviewer.department === 'Mathematics' ? 'selected' : ''}>Mathematics</option>
                <option value="Medicine" ${reviewer.department === 'Medicine' ? 'selected' : ''}>Medicine</option>
                <option value="Law" ${reviewer.department === 'Law' ? 'selected' : ''}>Law</option>
                <option value="Education" ${reviewer.department === 'Education' ? 'selected' : ''}>Education</option>
                <option value="Psychology" ${reviewer.department === 'Psychology' ? 'selected' : ''}>Psychology</option>
                <option value="Other" ${reviewer.department === 'Other' ? 'selected' : ''}>Other</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Phone Number</label>
              <input type="tel" name="phone" value="${reviewer.phone || ''}" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Available Days *</label>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="monday" ${reviewer.availability.includes('monday') ? 'checked' : ''} style="margin: 0;">
                  <span style="font-size: 0.875rem;">Monday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="tuesday" ${reviewer.availability.includes('tuesday') ? 'checked' : ''} style="margin: 0;">
                  <span style="font-size: 0.875rem;">Tuesday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="wednesday" ${reviewer.availability.includes('wednesday') ? 'checked' : ''} style="margin: 0;">
                  <span style="font-size: 0.875rem;">Wednesday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="thursday" ${reviewer.availability.includes('thursday') ? 'checked' : ''} style="margin: 0;">
                  <span style="font-size: 0.875rem;">Thursday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="friday" ${reviewer.availability.includes('friday') ? 'checked' : ''} style="margin: 0;">
                  <span style="font-size: 0.875rem;">Friday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" name="availability" value="saturday" ${reviewer.availability.includes('saturday') ? 'checked' : ''} style="margin: 0;">
                  <span style="font-size: 0.875rem;">Saturday</span>
                </label>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Max Daily Slots *</label>
                <input type="number" name="maxDailySlots" min="1" max="20" value="${reviewer.maxDailySlots}" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Slot Duration *</label>
                <select name="slotDuration" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                  <option value="30" ${reviewer.slotDuration === 30 ? 'selected' : ''}>30 minutes</option>
                  <option value="45" ${reviewer.slotDuration === 45 ? 'selected' : ''}>45 minutes</option>
                  <option value="60" ${reviewer.slotDuration === 60 ? 'selected' : ''}>60 minutes</option>
                  <option value="90" ${reviewer.slotDuration === 90 ? 'selected' : ''}>90 minutes</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Break Between Interviews *</label>
              <select name="breakDuration" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="10" ${reviewer.breakDuration === 10 ? 'selected' : ''}>10 minutes</option>
                <option value="15" ${reviewer.breakDuration === 15 ? 'selected' : ''}>15 minutes</option>
                <option value="30" ${reviewer.breakDuration === 30 ? 'selected' : ''}>30 minutes</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Specializations (Optional)</label>
              <input type="text" name="specializations" value="${reviewer.specializations ? reviewer.specializations.join(', ') : ''}" placeholder="e.g., Machine Learning, Data Science, Software Engineering" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
              <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Separate multiple specializations with commas</div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Notes (Optional)</label>
              <textarea name="notes" rows="3" placeholder="Any additional notes about this reviewer..." style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; resize: vertical;">${reviewer.notes || ''}</textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="closeModal('editReviewerModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Save Changes</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.saveEditedReviewer = function(event, reviewerId) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const availability = Array.from(document.querySelectorAll('#editReviewerModal input[name="availability"]:checked')).map(cb => cb.value);

      if (availability.length === 0) {
        showToast('Please select at least one available day', 'error');
        return;
      }

      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');
      const reviewerIndex = reviewers.findIndex(r => r.id === reviewerId);

      if (reviewerIndex === -1) {
        showToast('Reviewer not found', 'error');
        return;
      }

      // Check for duplicate email (excluding current reviewer)
      const newEmail = formData.get('email').toLowerCase();
      if (reviewers.some((r, index) => index !== reviewerIndex && r.email.toLowerCase() === newEmail)) {
        showToast('A reviewer with this email already exists', 'error');
        return;
      }

      // Update reviewer data
      reviewers[reviewerIndex] = {
        ...reviewers[reviewerIndex],
        name: formData.get('name'),
        email: formData.get('email'),
        department: formData.get('department'),
        phone: formData.get('phone') || '',
        availability: availability,
        maxDailySlots: parseInt(formData.get('maxDailySlots')),
        slotDuration: parseInt(formData.get('slotDuration')),
        breakDuration: parseInt(formData.get('breakDuration')),
        specializations: formData.get('specializations') ? formData.get('specializations').split(',').map(s => s.trim()) : [],
        notes: formData.get('notes') || '',
        updatedAt: new Date().toISOString()
      };

      localStorage.setItem(INTERVIEW_STORAGE.reviewers, JSON.stringify(reviewers));

      // Add to history
      const history = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.history) || '[]');
      history.unshift({
        id: Date.now().toString(),
        action: `Updated reviewer: ${reviewers[reviewerIndex].name}`,
        type: 'reviewer_updated',
        timestamp: new Date().toISOString(),
        details: {
          reviewerName: reviewers[reviewerIndex].name,
          department: reviewers[reviewerIndex].department
        }
      });
      localStorage.setItem(INTERVIEW_STORAGE.history, JSON.stringify(history.slice(0, 100)));

      closeModal('editReviewerModal');
      showToast(`Reviewer "${reviewers[reviewerIndex].name}" updated successfully!`, 'success');

      // Refresh reviewers tab
      showInterviewTab('reviewers');
    };

    window.deleteReviewer = function(reviewerId) {
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');
      const reviewer = reviewers.find(r => r.id === reviewerId);

      if (!reviewer) {
        showToast('Reviewer not found', 'error');
        return;
      }

      if (confirm(`Are you sure you want to delete "${reviewer.name}"? This action cannot be undone and will affect all existing interview slots assigned to this reviewer.`)) {
        // Remove reviewer from array
        const updatedReviewers = reviewers.filter(r => r.id !== reviewerId);
        localStorage.setItem(INTERVIEW_STORAGE.reviewers, JSON.stringify(updatedReviewers));

        // Also remove reviewer from any existing slots
        const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');
        const updatedSlots = slots.filter(slot => slot.reviewerId !== reviewerId);
        localStorage.setItem(INTERVIEW_STORAGE.slots, JSON.stringify(updatedSlots));

        // Remove reviewer from any bookings
        const bookings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.bookings) || '[]');
        const updatedBookings = bookings.filter(booking => booking.reviewerId !== reviewerId);
        localStorage.setItem(INTERVIEW_STORAGE.bookings, JSON.stringify(updatedBookings));

        // Add to history
        const history = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.history) || '[]');
        history.unshift({
          id: Date.now().toString(),
          action: `Deleted reviewer: ${reviewer.name}`,
          type: 'reviewer_deleted',
          timestamp: new Date().toISOString(),
          details: {
            reviewerName: reviewer.name,
            department: reviewer.department
          }
        });
        localStorage.setItem(INTERVIEW_STORAGE.history, JSON.stringify(history.slice(0, 100)));

        showToast(`Reviewer "${reviewer.name}" deleted successfully!`, 'success');

        // Refresh reviewers tab
        showInterviewTab('reviewers');
      }
    };

    window.openBulkSlotModal = function() {
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');
      const settings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.settings) || '{}');

      const modal = document.createElement('div');
      modal.id = 'bulkSlotModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üîÑ Bulk Create Interview Slots</h3>

          <form id="bulkSlotForm">
            <!-- Date Range -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">üìÖ Date Range</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Start Date</label>
                  <input type="date" name="startDate" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" min="${new Date().toISOString().split('T')[0]}">
                </div>
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">End Date</label>
                  <input type="date" name="endDate" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" min="${new Date().toISOString().split('T')[0]}">
                </div>
              </div>
            </div>

            <!-- Days of Week -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">üìÜ Days of Week</h4>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <input type="checkbox" name="days" value="monday" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Monday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <input type="checkbox" name="days" value="tuesday" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Tuesday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <input type="checkbox" name="days" value="wednesday" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Wednesday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <input type="checkbox" name="days" value="thursday" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Thursday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <input type="checkbox" name="days" value="friday" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Friday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <input type="checkbox" name="days" value="saturday" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Saturday</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <input type="checkbox" name="days" value="sunday" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Sunday</span>
                </label>
              </div>
            </div>

            <!-- Time Settings -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">‚è∞ Time Configuration</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Start Time</label>
                  <input type="time" name="startTime" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" value="${settings.institutionHours?.start || '09:00'}">
                </div>
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">End Time</label>
                  <input type="time" name="endTime" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" value="${settings.institutionHours?.end || '17:00'}">
                </div>
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Duration (min)</label>
                  <select name="duration" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="30">30 minutes</option>
                    <option value="45" selected>45 minutes</option>
                    <option value="60">60 minutes</option>
                    <option value="90">90 minutes</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Interviewer Selection -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">üë• Interviewer Assignment</h4>
              <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="assignmentMode" value="single" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Single Interviewer</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="assignmentMode" value="rotate" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Rotate Interviewers</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="assignmentMode" value="all" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">All Interviewers</span>
                </label>
              </div>
              <div id="singleInterviewerSelect">
                <select name="interviewerId" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option value="">Select Interviewer</option>
                  ${reviewers.map(reviewer => `<option value="${reviewer.id}">${reviewer.name} - ${reviewer.department}</option>`).join('')}
                </select>
              </div>
            </div>

            <!-- Additional Settings -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">‚öôÔ∏è Additional Settings</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Capacity per Slot</label>
                  <input type="number" name="capacity" required min="1" max="10" value="1" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div>
                  <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Break Between (min)</label>
                  <select name="breakDuration" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="0">No Break</option>
                    <option value="10">10 minutes</option>
                    <option value="15" selected>15 minutes</option>
                    <option value="30">30 minutes</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Preview -->
            <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
              <div style="font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">üìã Preview:</div>
              <div id="bulkPreview" style="font-size: 0.8rem; color: #6b7280;">Configure settings above to see preview</div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('bulkSlotModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Create Slots</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Add form submission handler
      document.getElementById('bulkSlotForm').addEventListener('submit', function(e) {
        e.preventDefault();
        processBulkSlotCreation(e.target);
      });

      // Add preview update listeners
      const form = document.getElementById('bulkSlotForm');
      form.addEventListener('change', updateBulkPreview);
      form.addEventListener('input', updateBulkPreview);
    };

    // Update bulk preview
    function updateBulkPreview() {
      const form = document.getElementById('bulkSlotForm');
      if (!form) return;

      const formData = new FormData(form);
      const startDate = formData.get('startDate');
      const endDate = formData.get('endDate');
      const selectedDays = formData.getAll('days');
      const startTime = formData.get('startTime');
      const endTime = formData.get('endTime');
      const duration = parseInt(formData.get('duration'));
      const breakDuration = parseInt(formData.get('breakDuration'));

      if (!startDate || !endDate || !startTime || !endTime || selectedDays.length === 0) {
        document.getElementById('bulkPreview').textContent = 'Configure settings above to see preview';
        return;
      }

      const dayNames = {
        sunday: 0, monday: 1, tuesday: 2, wednesday: 3,
        thursday: 4, friday: 5, saturday: 6
      };

      let totalSlots = 0;
      let workingDays = 0;

      // Calculate slots per day
      const startMinutes = timeToMinutes(startTime);
      const endMinutes = timeToMinutes(endTime);
      const totalMinutes = endMinutes - startMinutes;
      const slotWithBreak = duration + breakDuration;
      const slotsPerDay = Math.floor(totalMinutes / slotWithBreak);

      // Count working days in range
      const start = new Date(startDate);
      const end = new Date(endDate);

      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dayName = Object.keys(dayNames).find(key => dayNames[key] === d.getDay());
        if (selectedDays.includes(dayName)) {
          workingDays++;
          totalSlots += slotsPerDay;
        }
      }

      document.getElementById('bulkPreview').innerHTML = `
        <div>üìä <strong>${totalSlots}</strong> slots will be created</div>
        <div>üìÖ <strong>${workingDays}</strong> working days</div>
        <div>‚è∞ <strong>${slotsPerDay}</strong> slots per day</div>
        <div>üïí ${startTime} - ${endTime} (${duration}min slots + ${breakDuration}min breaks)</div>
      `;
    }

    // Process bulk slot creation
    function processBulkSlotCreation(form) {
      const formData = new FormData(form);
      const startDate = formData.get('startDate');
      const endDate = formData.get('endDate');
      const selectedDays = formData.getAll('days');
      const startTime = formData.get('startTime');
      const endTime = formData.get('endTime');
      const duration = parseInt(formData.get('duration'));
      const breakDuration = parseInt(formData.get('breakDuration'));
      const capacity = parseInt(formData.get('capacity'));
      const assignmentMode = formData.get('assignmentMode');
      const interviewerId = formData.get('interviewerId');

      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');
      const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');

      const dayNames = {
        sunday: 0, monday: 1, tuesday: 2, wednesday: 3,
        thursday: 4, friday: 5, saturday: 6
      };

      let createdCount = 0;
      let reviewerIndex = 0;

      // Generate slots for each day in range
      const start = new Date(startDate);
      const end = new Date(endDate);

      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dayName = Object.keys(dayNames).find(key => dayNames[key] === d.getDay());

        if (selectedDays.includes(dayName)) {
          const dateStr = d.toISOString().split('T')[0];

          // Generate time slots for this day
          const startMinutes = timeToMinutes(startTime);
          const endMinutes = timeToMinutes(endTime);
          const slotWithBreak = duration + breakDuration;

          let currentTime = startMinutes;

          while (currentTime + duration <= endMinutes) {
            const slotStartTime = minutesToTime(currentTime);
            const slotEndTime = minutesToTime(currentTime + duration);

            // Determine interviewer
            let selectedInterviewerId;
            if (assignmentMode === 'single') {
              selectedInterviewerId = parseInt(interviewerId);
            } else if (assignmentMode === 'rotate') {
              selectedInterviewerId = reviewers[reviewerIndex % reviewers.length]?.id;
              reviewerIndex++;
            } else if (assignmentMode === 'all') {
              // Create slots for all reviewers
              reviewers.forEach(reviewer => {
                const slot = {
                  id: 'slot_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                  date: dateStr,
                  startTime: slotStartTime,
                  endTime: slotEndTime,
                  duration,
                  interviewerId: reviewer.id,
                  capacity,
                  notes: '',
                  blocked: false,
                  created: new Date().toISOString()
                };
                slots.push(slot);
                createdCount++;
              });
              currentTime += slotWithBreak;
              continue;
            }

            if (selectedInterviewerId) {
              const slot = {
                id: 'slot_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                date: dateStr,
                startTime: slotStartTime,
                endTime: slotEndTime,
                duration,
                interviewerId: selectedInterviewerId,
                capacity,
                notes: '',
                blocked: false,
                created: new Date().toISOString()
              };
              slots.push(slot);
              createdCount++;
            }

            currentTime += slotWithBreak;
          }
        }
      }

      // Save updated slots
      localStorage.setItem(INTERVIEW_STORAGE.slots, JSON.stringify(slots));

      showToast(`Successfully created ${createdCount} interview slots!`, 'success');
      closeModal('bulkSlotModal');
      showInterviewTab('slots');
    }

    // Helper functions
    function timeToMinutes(time) {
      const [hours, minutes] = time.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function minutesToTime(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }

    // Export Calendar functionality
    window.exportCalendar = function() {
      const slots = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.slots) || '[]');
      const bookings = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.bookings) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(INTERVIEW_STORAGE.reviewers) || '[]');

      if (slots.length === 0) {
        showToast('No interview slots to export', 'warning');
        return;
      }

      // Generate CSV content
      let csvContent = 'Date,Start Time,End Time,Duration,Interviewer,Department,Capacity,Booked,Status\n';

      slots.forEach(slot => {
        const reviewer = reviewers.find(r => r.id === slot.interviewerId) || { name: 'Unknown', department: 'N/A' };
        const slotBookings = bookings.filter(b => b.slotId === slot.id);
        const status = slot.blocked ? 'Blocked' : (slotBookings.length >= slot.capacity ? 'Full' : 'Available');

        csvContent += [
          slot.date,
          slot.startTime,
          slot.endTime,
          `${slot.duration} min`,
          reviewer.name,
          reviewer.department,
          slot.capacity,
          slotBookings.length,
          status
        ].join(',') + '\n';
      });

      // Create and download file
      const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
      const exportFileDefaultName = `interview-calendar-${new Date().toISOString().split('T')[0]}.csv`;

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();

      showToast('Calendar exported successfully!', 'success');
    };

    // ============================================
    // DECISION TRACKING SYSTEM
    // ============================================

    // Simple decision system
    // Decision system storage keys
    const DECISION_STORAGE = {
      decisions: 'decision_tracking_decisions',
      templates: 'decision_tracking_templates',
      notifications: 'decision_tracking_notifications',
      settings: 'decision_tracking_settings',
      history: 'decision_tracking_history',
      scheduled: 'decision_tracking_scheduled',
      systemState: 'decision_tracking_system_state'
    };

    // Initialize decision system data
    function initializeDecisionData() {
      if (!localStorage.getItem(DECISION_STORAGE.decisions)) {
        const sampleDecisions = [
          {
            id: '1',
            applicantId: 'APP-2025-001',
            applicantName: 'Sarah Johnson',
            email: 'sarah.johnson@email.com',
            program: 'Computer Science',
            level: 'Undergraduate',
            status: 'admitted',
            decision: 'Admission Offer',
            decisionDate: '2025-01-15',
            notificationSent: true,
            notificationDate: '2025-01-15T10:30:00',
            notes: 'Excellent academic record and strong portfolio',
            decidedBy: 'Dr. Michael Chen',
            scheduledRelease: null,
            language: 'english',
            history: [
              { date: '2025-01-10', action: 'Application reviewed', user: 'Dr. Michael Chen' },
              { date: '2025-01-15', action: 'Admission decision made', user: 'Dr. Michael Chen' },
              { date: '2025-01-15', action: 'Notification sent', user: 'System' }
            ]
          },
          {
            id: '2',
            applicantId: 'APP-2025-002',
            applicantName: 'David Williams',
            email: 'david.williams@email.com',
            program: 'Business Administration',
            level: 'Graduate',
            status: 'waitlisted',
            decision: 'Waitlist',
            decisionDate: '2025-01-16',
            notificationSent: false,
            scheduledRelease: '2025-01-20T15:00:00',
            notes: 'Strong candidate, competitive pool',
            decidedBy: 'Dr. Sarah Martinez',
            language: 'english',
            history: [
              { date: '2025-01-12', action: 'Application reviewed', user: 'Dr. Sarah Martinez' },
              { date: '2025-01-16', action: 'Waitlist decision made', user: 'Dr. Sarah Martinez' }
            ]
          }
        ];
        localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(sampleDecisions));
      }

      if (!localStorage.getItem(DECISION_STORAGE.templates)) {
        const defaultTemplates = {
          admission: {
            english: {
              subject: 'Congratulations! Admission Decision for {{applicantName}}',
              body: `Dear {{applicantName}},

Congratulations! We are pleased to inform you that you have been admitted to the {{program}} program at our institution.

Your application was thoroughly reviewed by our admissions committee, and we were impressed by your academic achievements and qualifications.

Next Steps:
- Please confirm your enrollment by {{confirmationDeadline}}
- Complete your enrollment deposit of {{depositAmount}}
- Attend our orientation session on {{orientationDate}}

We look forward to welcoming you to our academic community.

Best regards,
{{admissionsOfficer}}
{{institutionName}}`,
              footer: 'This is an automated message. Please do not reply directly to this email.'
            },
            spanish: {
              subject: '¬°Felicitaciones! Decisi√≥n de Admisi√≥n para {{applicantName}}',
              body: `Estimado/a {{applicantName}},

¬°Felicitaciones! Nos complace informarle que ha sido admitido/a al programa de {{program}} en nuestra instituci√≥n.

Su solicitud fue revisada minuciosamente por nuestro comit√© de admisiones, y quedamos impresionados por sus logros acad√©micos y calificaciones.

Pr√≥ximos pasos:
- Por favor confirme su inscripci√≥n antes del {{confirmationDeadline}}
- Complete su dep√≥sito de inscripci√≥n de {{depositAmount}}
- Asista a nuestra sesi√≥n de orientaci√≥n el {{orientationDate}}

Esperamos darle la bienvenida a nuestra comunidad acad√©mica.

Cordialmente,
{{admissionsOfficer}}
{{institutionName}}`,
              footer: 'Este es un mensaje automatizado. Por favor no responda directamente a este correo.'
            }
          },
          rejection: {
            english: {
              subject: 'Application Decision for {{applicantName}}',
              body: `Dear {{applicantName}},

Thank you for your interest in the {{program}} program at {{institutionName}}.

After careful consideration of your application, we regret to inform you that we are unable to offer you admission for the {{academicYear}} academic year.

We received an exceptionally large number of qualified applications this year, making the selection process highly competitive.

We encourage you to continue pursuing your academic goals and wish you success in your future endeavors.

Sincerely,
{{admissionsOfficer}}
{{institutionName}}`,
              footer: 'This is an automated message. Please do not reply directly to this email.'
            },
            spanish: {
              subject: 'Decisi√≥n de Solicitud para {{applicantName}}',
              body: `Estimado/a {{applicantName}},

Gracias por su inter√©s en el programa de {{program}} en {{institutionName}}.

Despu√©s de una cuidadosa consideraci√≥n de su solicitud, lamentamos informarle que no podemos ofrecerle admisi√≥n para el a√±o acad√©mico {{academicYear}}.

Este a√±o recibimos un n√∫mero excepcionalmente grande de solicitudes calificadas, lo que hizo que el proceso de selecci√≥n fuera altamente competitivo.

Le animamos a continuar persiguiendo sus metas acad√©micas y le deseamos √©xito en sus futuros esfuerzos.

Atentamente,
{{admissionsOfficer}}
{{institutionName}}`,
              footer: 'Este es un mensaje automatizado. Por favor no responda directamente a este correo.'
            }
          },
          waitlist: {
            english: {
              subject: 'Waitlist Decision for {{applicantName}}',
              body: `Dear {{applicantName}},

Thank you for your application to the {{program}} program at {{institutionName}}.

We have placed your application on our waitlist. This means that while we were impressed with your qualifications, we do not have space available at this time.

You will be notified if a spot becomes available. We expect to have updates by {{updateDate}}.

If you have any questions, please contact our admissions office.

Best regards,
{{admissionsOfficer}}
{{institutionName}}`,
              footer: 'This is an automated message. Please do not reply directly to this email.'
            },
            spanish: {
              subject: 'Decisi√≥n de Lista de Espera para {{applicantName}}',
              body: `Estimado/a {{applicantName}},

Gracias por su solicitud al programa de {{program}} en {{institutionName}}.

Hemos colocado su solicitud en nuestra lista de espera. Esto significa que aunque estuvimos impresionados con sus calificaciones, no tenemos espacio disponible en este momento.

Se le notificar√° si un lugar se vuelve disponible. Esperamos tener actualizaciones para el {{updateDate}}.

Si tiene alguna pregunta, por favor contacte a nuestra oficina de admisiones.

Cordialmente,
{{admissionsOfficer}}
{{institutionName}}`,
              footer: 'Este es un mensaje automatizado. Por favor no responda directamente a este correo.'
            }
          },
          conditional: {
            english: {
              subject: 'Conditional Admission Decision for {{applicantName}}',
              body: `Dear {{applicantName}},

We are pleased to offer you conditional admission to the {{program}} program at {{institutionName}}.

Your admission is contingent upon meeting the following requirements:
{{conditions}}

Please ensure all conditions are met by {{conditionDeadline}}.

Upon successful completion of these requirements, your admission will be confirmed.

Best regards,
{{admissionsOfficer}}
{{institutionName}}`,
              footer: 'This is an automated message. Please do not reply directly to this email.'
            },
            spanish: {
              subject: 'Decisi√≥n de Admisi√≥n Condicional para {{applicantName}}',
              body: `Estimado/a {{applicantName}},

Nos complace ofrecerle admisi√≥n condicional al programa de {{program}} en {{institutionName}}.

Su admisi√≥n est√° sujeta a cumplir con los siguientes requisitos:
{{conditions}}

Por favor aseg√∫rese de que todos los requisitos se cumplan antes del {{conditionDeadline}}.

Una vez completados exitosamente estos requisitos, su admisi√≥n ser√° confirmada.

Cordialmente,
{{admissionsOfficer}}
{{institutionName}}`,
              footer: 'Este es un mensaje automatizado. Por favor no responda directamente a este correo.'
            }
          }
        };
        localStorage.setItem(DECISION_STORAGE.templates, JSON.stringify(defaultTemplates));
      }
    }

    window.openDecisionSystem = function() {
      initializeDecisionData();

      const modal = document.createElement('div');
      modal.id = 'decisionSystemModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 25000; padding: 2rem;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 95vh; overflow: hidden; display: flex; flex-direction: column;">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #5a5bb8 0%, #4a4b98 100%); color: white; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h2 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Decision Tracking & Notifications</h2>
                <p style="margin: 0.5rem 0 0 0; font-size: 1rem; opacity: 0.9;">Record decisions, manage communications, and track applicant status</p>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button id="fullscreenToggle" onclick="toggleFullscreen()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                  <span id="fullscreenIcon">‚õ∂</span>
                  <span id="fullscreenText">Fullscreen</span>
                </button>
                <button onclick="backToAdmissionsFromDecision()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                  <span>‚Üê</span>
                  <span>Back to Admissions</span>
                </button>
                <button onclick="closeDecisionSystem()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>
              </div>
            </div>
          </div>

          <!-- Navigation Tabs -->
          <div style="background: #f8fafc; border-bottom: 2px solid #e2e8f0; display: flex; overflow-x: auto;">
            <button class="decision-tab active" data-tab="decisions" style="padding: 1rem 2rem; border: none; background: white; border-bottom: 3px solid #5a5bb8; color: #5a5bb8; font-weight: 600; cursor: pointer; white-space: nowrap;">üìã Decisions</button>
            <button class="decision-tab" data-tab="templates" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üìù Templates</button>
            <button class="decision-tab" data-tab="notifications" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üìß Notifications</button>
            <button class="decision-tab" data-tab="scheduled" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">‚è∞ Scheduled</button>
            <button class="decision-tab" data-tab="analytics" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üìä Analytics</button>
            <button class="decision-tab" data-tab="settings" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">‚öôÔ∏è Settings</button>
            <button class="decision-tab" data-tab="history" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üìà History</button>
          </div>

          <!-- Content Area -->
          <div id="decisionContent" style="flex: 1; overflow-y: auto; padding: 0;">
            <!-- Dynamic content will be loaded here -->
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      setupDecisionTabs();
      showDecisionTab('decisions');

      // Initialize all enhanced features
      setupKeyboardShortcuts();
      startAutoSave();

      // Mark system as open for refresh detection
      markSystemAsOpen();

      // Load saved state
      setTimeout(() => loadDecisionSystemState(), 300);
    };

    window.closeDecisionSystem = function() {
      const modal = document.getElementById('decisionSystemModal');
      if (modal) {
        // Save current state before closing
        saveDecisionSystemState();
        stopAutoSave();

        // Mark system as properly closed (not a refresh)
        markSystemAsClosed();

        modal.remove();
      }
    };

    window.backToAdmissionsFromDecision = function() {
      const modal = document.getElementById('decisionSystemModal');
      if (modal) {
        // Save current state before closing Decision system
        saveDecisionSystemState();
        stopAutoSave();
        markSystemAsClosed();
        modal.remove();
      }

      // Return to main admissions page
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showNotification('Returned to Admissions page', 'info');
    };

    // Fullscreen functionality
    window.toggleFullscreen = function() {
      const modal = document.getElementById('decisionSystemModal');
      const icon = document.getElementById('fullscreenIcon');
      const text = document.getElementById('fullscreenText');
      const isFullscreen = modal.classList.contains('fullscreen-mode');

      if (isFullscreen) {
        // Exit fullscreen
        modal.classList.remove('fullscreen-mode');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';
        icon.textContent = '‚õ∂';
        text.textContent = 'Fullscreen';

        // Restore the inner container
        const innerContainer = modal.querySelector('div:first-child');
        innerContainer.style.cssText = 'background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 95vh; overflow: hidden; display: flex; flex-direction: column;';
      } else {
        // Enter fullscreen
        modal.classList.add('fullscreen-mode');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 25000;';
        icon.textContent = '‚õó';
        text.textContent = 'Exit Fullscreen';

        // Make inner container fullscreen
        const innerContainer = modal.querySelector('div:first-child');
        innerContainer.style.cssText = 'background: white; border-radius: 0; width: 100%; height: 100%; overflow: hidden; display: flex; flex-direction: column;';
      }

      // Save fullscreen state
      saveDecisionSystemState();
    };

    // State persistence functions
    window.saveDecisionSystemState = function() {
      const modal = document.getElementById('decisionSystemModal');
      if (!modal) return;

      // Preserve existing state data
      const existingState = JSON.parse(localStorage.getItem(DECISION_STORAGE.systemState) || '{}');

      const state = {
        ...existingState,
        isFullscreen: modal.classList.contains('fullscreen-mode'),
        activeTab: document.querySelector('.decision-tab.active')?.getAttribute('data-tab') || 'decisions',
        timestamp: Date.now()
      };

      localStorage.setItem(DECISION_STORAGE.systemState, JSON.stringify(state));
    };

    window.loadDecisionSystemState = function() {
      const savedState = localStorage.getItem(DECISION_STORAGE.systemState);
      if (!savedState) return;

      try {
        const state = JSON.parse(savedState);

        // Apply fullscreen state if it was saved
        if (state.isFullscreen) {
          setTimeout(() => toggleFullscreen(), 100);
        }

        // Restore active tab
        if (state.activeTab && state.activeTab !== 'decisions') {
          setTimeout(() => showDecisionTab(state.activeTab), 200);
        }
      } catch (error) {
        console.error('Error loading decision system state:', error);
      }
    };

    // Enhanced state persistence for forms and interactions
    window.saveFormState = function(formId, formData) {
      const state = JSON.parse(localStorage.getItem(DECISION_STORAGE.systemState) || '{}');
      if (!state.forms) state.forms = {};
      state.forms[formId] = formData;
      localStorage.setItem(DECISION_STORAGE.systemState, JSON.stringify(state));
    };

    window.loadFormState = function(formId) {
      const state = JSON.parse(localStorage.getItem(DECISION_STORAGE.systemState) || '{}');
      return state.forms?.[formId] || {};
    };

    // Auto-save form data every 30 seconds
    let autoSaveInterval;
    window.startAutoSave = function() {
      if (autoSaveInterval) clearInterval(autoSaveInterval);
      autoSaveInterval = setInterval(() => {
        const modal = document.getElementById('decisionSystemModal');
        if (modal) {
          saveDecisionSystemState();

          // Auto-save any forms that are currently open
          const forms = modal.querySelectorAll('form, .form-container');
          forms.forEach((form, index) => {
            const formData = {};
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
              if (input.name || input.id) {
                const key = input.name || input.id;
                formData[key] = input.type === 'checkbox' ? input.checked : input.value;
              }
            });
            if (Object.keys(formData).length > 0) {
              saveFormState(`auto_form_${index}`, formData);
            }
          });
        }
      }, 30000); // Every 30 seconds
    };

    window.stopAutoSave = function() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
      }
    };

    // Keyboard shortcuts for common actions
    window.setupKeyboardShortcuts = function() {
      document.addEventListener('keydown', (e) => {
        const modal = document.getElementById('decisionSystemModal');
        if (!modal) return;

        // Only activate shortcuts when modal is open
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'f':
              e.preventDefault();
              toggleFullscreen();
              break;
            case 's':
              e.preventDefault();
              saveDecisionSystemState();
              showNotification('State saved manually');
              break;
            case '1':
              e.preventDefault();
              showDecisionTab('decisions');
              break;
            case '2':
              e.preventDefault();
              showDecisionTab('templates');
              break;
            case '3':
              e.preventDefault();
              showDecisionTab('notifications');
              break;
            case '4':
              e.preventDefault();
              showDecisionTab('history');
              break;
            case '5':
              e.preventDefault();
              showDecisionTab('analytics');
              break;
            case '6':
              e.preventDefault();
              showDecisionTab('settings');
              break;
            case 'Escape':
              e.preventDefault();
              closeDecisionSystem();
              break;
          }
        }
      });
    };

    // Page refresh detection and auto-restoration
    window.markSystemAsOpen = function() {
      const state = JSON.parse(localStorage.getItem(DECISION_STORAGE.systemState) || '{}');
      state.wasOpen = true;
      state.lastOpenTime = Date.now();
      localStorage.setItem(DECISION_STORAGE.systemState, JSON.stringify(state));
    };

    window.markSystemAsClosed = function() {
      const state = JSON.parse(localStorage.getItem(DECISION_STORAGE.systemState) || '{}');
      state.wasOpen = false;
      localStorage.setItem(DECISION_STORAGE.systemState, JSON.stringify(state));
    };

    window.checkAndRestoreSystem = function() {
      const state = JSON.parse(localStorage.getItem(DECISION_STORAGE.systemState) || '{}');

      // Check if system was open and refresh happened recently (within 5 seconds)
      if (state.wasOpen && state.lastOpenTime) {
        const timeDiff = Date.now() - state.lastOpenTime;
        // If less than 5 seconds, likely a page refresh
        if (timeDiff < 5000) {
          console.log('Detected page refresh - restoring Decision Tracking system...');

          // Check for overlay existence
          const hasOverlay = document.getElementById('restorationOverlay');

          setTimeout(() => {
            openDecisionSystem();
          }, hasOverlay ? 100 : 500);
          return true;
        }
      }
      return false;
    };

    // DISABLED: Page lifecycle management for flash prevention
    window.addEventListener('beforeunload', function() {
      const modal = document.getElementById('decisionSystemModal');
      if (modal) {
        // Only save decision system state, no flash prevention flags
        saveDecisionSystemState();
      }
    });

    // DISABLED: Immediate restoration check
    // Flash prevention has been disabled for now

    // DISABLED: Flash prevention restoration logic
    document.addEventListener('DOMContentLoaded', function() {
      // EMERGENCY: Ensure page is always visible
      document.body.style.visibility = 'visible';
      document.body.style.opacity = '1';
      document.body.style.background = '';
      document.documentElement.style.background = '';

      console.log('‚úÖ Normal page load - flash prevention disabled');

      // Original restoration logic is disabled for now
      // TODO: Re-implement simpler restoration without flash prevention
    });

    // Also check when page becomes visible (in case of tab switching)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // Page became visible, check if we need to restore
        setTimeout(() => {
          checkAndRestoreSystem();
        }, 500);
      }
    });

    // Tab management
    function setupDecisionTabs() {
      const tabs = document.querySelectorAll('.decision-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.getAttribute('data-tab');
          showDecisionTab(tabName);
        });
      });
    }

    function showDecisionTab(tabName) {
      const content = document.getElementById('decisionContent');
      const tabs = document.querySelectorAll('.decision-tab');

      // Update tab appearance
      tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = '#f8fafc';
        tab.style.borderBottom = '3px solid transparent';
        tab.style.color = '#6b7280';
      });

      const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.background = 'white';
        activeTab.style.borderBottom = '3px solid #5a5bb8';
        activeTab.style.color = '#5a5bb8';
      }

      // Load content based on tab
      switch (tabName) {
        case 'decisions':
          content.innerHTML = generateDecisionsTab();
          break;
        case 'templates':
          content.innerHTML = generateTemplatesTab();
          break;
        case 'notifications':
          content.innerHTML = generateNotificationsTab();
          break;
        case 'scheduled':
          content.innerHTML = generateScheduledTab();
          break;
        case 'history':
          content.innerHTML = generateHistoryTab();
          break;
        case 'analytics':
          content.innerHTML = generateAnalyticsTab();
          break;
        case 'settings':
          content.innerHTML = generateSettingsTab();
          setupSettingsTabs();
          break;
        default:
          content.innerHTML = generateDecisionsTab();
      }

      // Save current tab state
      saveDecisionSystemState();
    }

    // Analytics calculation functions
    function calculateAdvancedAnalytics(decisions) {
      const now = new Date();
      const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

      // Basic metrics
      const totalDecisions = decisions.length;
      const thisMonthDecisions = decisions.filter(d => new Date(d.decisionDate) >= thisMonth);
      const lastMonthDecisions = decisions.filter(d => new Date(d.decisionDate) >= lastMonth && new Date(d.decisionDate) < thisMonth);
      const decisionsGrowth = lastMonthDecisions.length > 0 ? Math.round(((thisMonthDecisions.length - lastMonthDecisions.length) / lastMonthDecisions.length) * 100) : 100;

      // Decision breakdown
      const decisionBreakdown = {
        admitted: decisions.filter(d => d.status === 'admitted').length,
        denied: decisions.filter(d => d.status === 'denied').length,
        waitlisted: decisions.filter(d => d.status === 'waitlisted').length,
        conditional: decisions.filter(d => d.status === 'conditional').length
      };

      // Rates and metrics
      const acceptanceRate = totalDecisions > 0 ? Math.round((decisionBreakdown.admitted / totalDecisions) * 100) : 0;
      const notificationsSent = decisions.filter(d => d.notificationSent).length;
      const notificationRate = totalDecisions > 0 ? Math.round((notificationsSent / totalDecisions) * 100) : 0;
      const pendingNotifications = decisions.filter(d => !d.notificationSent && !d.scheduledRelease).length;

      // Processing time calculation
      const processingTimes = decisions.map(d => {
        const decisionDate = new Date(d.decisionDate);
        // Assume application was submitted 7-30 days before decision
        const submissionDate = new Date(decisionDate.getTime() - (Math.random() * 23 + 7) * 24 * 60 * 60 * 1000);
        return Math.round((decisionDate - submissionDate) / (24 * 60 * 60 * 1000));
      });
      const avgProcessingTime = processingTimes.length > 0 ? Math.round(processingTimes.reduce((a, b) => a + b, 0) / processingTimes.length) : 0;

      // Program statistics
      const programStats = {};
      decisions.forEach(d => {
        if (!programStats[d.program]) {
          programStats[d.program] = { total: 0, admitted: 0 };
        }
        programStats[d.program].total++;
        if (d.status === 'admitted') {
          programStats[d.program].admitted++;
        }
      });

      // Time series data (last 30 days)
      const timeSeriesData = [];
      for (let i = 29; i >= 0; i--) {
        const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        const dayDecisions = decisions.filter(d =>
          new Date(d.decisionDate).toDateString() === date.toDateString()
        );
        timeSeriesData.push({
          date: date.toLocaleDateString(),
          decisions: dayDecisions.length,
          admitted: dayDecisions.filter(d => d.status === 'admitted').length
        });
      }

      // AI-powered insights
      const insights = generateInsights(decisions, decisionBreakdown, acceptanceRate);

      return {
        totalDecisions,
        decisionsGrowth,
        acceptanceRate,
        industryBenchmark: 65, // Mock industry benchmark
        avgProcessingTime,
        notificationRate,
        pendingNotifications,
        decisionBreakdown,
        programStats,
        timeSeriesData,
        insights
      };
    }

    function generateInsights(decisions, breakdown, acceptanceRate) {
      const insights = [];

      // Acceptance rate insight with predictive analytics
      if (acceptanceRate > 75) {
        insights.push({
          icon: 'üìà',
          title: 'High Acceptance Rate Alert',
          description: `Your acceptance rate of ${acceptanceRate}% is above industry average. Based on current trends, this may impact institutional ranking and selectivity perception.`,
          action: 'reviewCriteria()',
          actionText: 'Review Criteria',
          priority: 'high',
          type: 'warning'
        });
      } else if (acceptanceRate < 40) {
        insights.push({
          icon: 'üìâ',
          title: 'Highly Selective Admissions',
          description: `Your acceptance rate of ${acceptanceRate}% suggests strong selectivity. Predictive models indicate potential for yield management optimization.`,
          action: 'checkYieldRates()',
          actionText: 'Optimize Yield',
          priority: 'medium',
          type: 'success'
        });
      }

      // Advanced waitlist analytics
      if (breakdown.waitlisted > breakdown.admitted * 0.3) {
        const waitlistConversionRate = Math.round((breakdown.admitted / breakdown.waitlisted) * 100);
        insights.push({
          icon: '‚è≥',
          title: 'Waitlist Strategy Optimization',
          description: `${breakdown.waitlisted} waitlisted candidates with ${waitlistConversionRate}% historical conversion rate. AI suggests optimizing waitlist size for better yield management.`,
          action: 'manageWaitlist()',
          actionText: 'Optimize Waitlist',
          priority: 'medium',
          type: 'info'
        });
      }

      // Notification efficiency tracking
      const pendingNotifications = decisions.filter(d => !d.notificationSent && !d.scheduledRelease).length;
      if (pendingNotifications > 5) {
        const avgResponseTime = decisions.filter(d => d.notificationSent).length > 0 ?
          Math.round(Math.random() * 5 + 2) : 3; // Simulated response time
        insights.push({
          icon: 'üìß',
          title: 'Communication Pipeline Alert',
          description: `${pendingNotifications} notifications pending. Current avg response time: ${avgResponseTime} days. Faster communication correlates with 23% higher yield rates.`,
          action: 'sendBulkNotifications()',
          actionText: 'Send All Pending',
          priority: 'high',
          type: 'warning'
        });
      }

      // Predictive enrollment modeling
      const currentMonth = new Date().getMonth();
      if (currentMonth >= 2 && currentMonth <= 4) { // March-May
        const predictedYield = Math.round(65 + (acceptanceRate > 50 ? -10 : 5) + Math.random() * 10);
        insights.push({
          icon: 'üå∏',
          title: 'Peak Decision Season - Yield Prediction',
          description: `Peak decision period active. AI predicts ${predictedYield}% yield rate based on current patterns. Monitor deposit deadlines closely.`,
          action: 'viewPredictions()',
          actionText: 'View Predictions',
          priority: 'medium',
          type: 'info'
        });
      }

      // Application volume trend analysis
      const recentDecisions = decisions.filter(d => {
        const decisionDate = new Date(d.decisionDate);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return decisionDate >= thirtyDaysAgo;
      });

      const previousDecisions = decisions.filter(d => {
        const decisionDate = new Date(d.decisionDate);
        const sixtyDaysAgo = new Date();
        const thirtyDaysAgo = new Date();
        sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return decisionDate >= sixtyDaysAgo && decisionDate < thirtyDaysAgo;
      });

      const trendPercentage = previousDecisions.length > 0 ?
        Math.round(((recentDecisions.length - previousDecisions.length) / previousDecisions.length) * 100) : 0;

      if (Math.abs(trendPercentage) > 20) {
        insights.push({
          icon: trendPercentage > 0 ? 'üìä' : 'üìâ',
          title: `Application Volume ${trendPercentage > 0 ? 'Surge' : 'Decline'}`,
          description: `${Math.abs(trendPercentage)}% ${trendPercentage > 0 ? 'increase' : 'decrease'} in application volume over last 30 days. AI recommends ${trendPercentage > 0 ? 'scaling review capacity' : 'targeted recruitment'}.`,
          action: trendPercentage > 0 ? 'scaleCapacity()' : 'boostRecruitment()',
          actionText: trendPercentage > 0 ? 'Scale Capacity' : 'Boost Recruitment',
          priority: 'high',
          type: trendPercentage > 0 ? 'warning' : 'error'
        });
      }

      // Decision timeline efficiency
      const avgDecisionTime = decisions.length > 0 ? decisions.reduce((sum, d) => {
        const submissionDate = new Date(d.submissionDate || d.decisionDate);
        const decisionDate = new Date(d.decisionDate);
        const diffDays = (decisionDate - submissionDate) / (1000 * 60 * 60 * 24);
        return sum + (isNaN(diffDays) ? 14 : Math.max(0, diffDays));
      }, 0) / decisions.length : 14;

      if (avgDecisionTime > 21) {
        insights.push({
          icon: '‚è±Ô∏è',
          title: 'Decision Timeline Optimization',
          description: `Average decision time: ${Math.round(avgDecisionTime)} days. Industry benchmark: 14 days. Streamlining process could improve applicant satisfaction by 31%.`,
          action: 'optimizeWorkflow()',
          actionText: 'Optimize Workflow',
          priority: 'medium',
          type: 'warning'
        });
      } else if (avgDecisionTime <= 10) {
        insights.push({
          icon: '‚ö°',
          title: 'Exceptional Processing Speed',
          description: `Outstanding ${Math.round(avgDecisionTime)}-day average decision time! This efficiency correlates with higher applicant satisfaction and institutional reputation.`,
          action: null,
          actionText: null,
          priority: 'low',
          type: 'success'
        });
      }

      // Data quality and completeness check
      if (decisions.length >= 50) {
        const dataCompleteness = decisions.filter(d => d.program && d.email && d.applicantName).length / decisions.length;
        if (dataCompleteness < 0.9) {
          insights.push({
            icon: 'üîç',
            title: 'Data Quality Enhancement',
            description: `${Math.round(dataCompleteness * 100)}% data completeness detected. Improving data quality enables advanced AI features and better insights.`,
            action: 'cleanupData()',
            actionText: 'Clean Data',
            priority: 'medium',
            type: 'info'
          });
        } else {
          insights.push({
            icon: 'ü§ñ',
            title: 'AI-Ready Dataset',
            description: `Excellent data quality (${Math.round(dataCompleteness * 100)}%) with ${decisions.length} records. Your dataset is ready for advanced AI features like automated screening and predictive modeling.`,
            action: 'enableAI()',
            actionText: 'Enable AI Features',
            priority: 'low',
            type: 'success'
          });
        }
      }

      // Sort insights by priority and return top 6
      const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
      return insights
        .sort((a, b) => (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0))
        .slice(0, 6);
    }

    function generatePieChart(data) {
      const total = Object.values(data).reduce((a, b) => a + b, 0);
      if (total === 0) {
        return '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280;">No data available</div>';
      }

      let currentAngle = 0;
      const radius = 80;
      const centerX = 125;
      const centerY = 125;

      const slices = Object.entries(data).map(([status, count]) => {
        const percentage = count / total;
        const startAngle = currentAngle;
        const endAngle = currentAngle + (percentage * 360);
        currentAngle = endAngle;

        const color = getStatusColor(status);

        // Convert to radians
        const startRad = (startAngle - 90) * Math.PI / 180;
        const endRad = (endAngle - 90) * Math.PI / 180;

        const x1 = centerX + radius * Math.cos(startRad);
        const y1 = centerY + radius * Math.sin(startRad);
        const x2 = centerX + radius * Math.cos(endRad);
        const y2 = centerY + radius * Math.sin(endRad);

        const largeArc = percentage > 0.5 ? 1 : 0;

        return `<path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}" stroke="white" stroke-width="2"/>`;
      }).join('');

      return `
        <svg width="250" height="250" style="margin: 0 auto; display: block;">
          ${slices}
        </svg>
      `;
    }

    function generateTimeSeriesChart(data) {
      if (data.length === 0) {
        return '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280;">No data available</div>';
      }

      const maxValue = Math.max(...data.map(d => d.decisions));
      const width = 100;
      const height = 80;

      const points = data.map((d, i) => {
        const x = (i / (data.length - 1)) * width;
        const y = height - (d.decisions / maxValue) * height;
        return `${x},${y}`;
      }).join(' ');

      return `
        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" style="border: 1px solid #e2e8f0; border-radius: 8px;">
          <polyline points="${points}" fill="none" stroke="#5a5bb8" stroke-width="2"/>
          ${data.map((d, i) => {
            const x = (i / (data.length - 1)) * width;
            const y = height - (d.decisions / maxValue) * height;
            return `<circle cx="${x}" cy="${y}" r="2" fill="#5a5bb8"/>`;
          }).join('')}
        </svg>
        <div style="margin-top: 1rem; font-size: 0.75rem; color: #6b7280; text-align: center;">
          Showing daily decision volume trend
        </div>
      `;
    }

    function getStatusColor(status) {
      const colors = {
        admitted: '#3b82f6',
        denied: '#ef4444',
        waitlisted: '#f59e0b',
        conditional: '#3b82f6'
      };
      return colors[status] || '#6b7280';
    }

    // Settings functions
    function generateSettingsContent(category, settings) {
      switch (category) {
        case 'general':
          return generateGeneralSettings(settings);
        case 'notifications':
          return generateNotificationSettings(settings);
        case 'security':
          return generateSecuritySettings(settings);
        case 'automation':
          return generateAutomationSettings(settings);
        case 'integration':
          return generateIntegrationSettings(settings);
        case 'advanced':
          return generateAdvancedSettings(settings);
        default:
          return generateGeneralSettings(settings);
      }
    }

    function generateGeneralSettings(settings) {
      return `
        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 2rem;">
          <h4 style="margin: 0 0 1.5rem 0; color: #1f2937;">üèõÔ∏è Institution Settings</h4>

          <div style="display: grid; gap: 1.5rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Institution Name</label>
              <input type="text" value="${settings.institutionName || 'Flow University'}" onchange="updateSetting('institutionName', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Academic Year</label>
                <input type="text" value="${settings.academicYear || '2025-2026'}" onchange="updateSetting('academicYear', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Time Zone</label>
                <select onchange="updateSetting('timeZone', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="EST" ${settings.timeZone === 'EST' ? 'selected' : ''}>Eastern (EST)</option>
                  <option value="CST" ${settings.timeZone === 'CST' ? 'selected' : ''}>Central (CST)</option>
                  <option value="MST" ${settings.timeZone === 'MST' ? 'selected' : ''}>Mountain (MST)</option>
                  <option value="PST" ${settings.timeZone === 'PST' ? 'selected' : ''}>Pacific (PST)</option>
                </select>
              </div>
            </div>

            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Default Language</label>
              <select onchange="updateSetting('defaultLanguage', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                <option value="english" ${settings.defaultLanguage === 'english' ? 'selected' : ''}>üá∫üá∏ English</option>
                <option value="spanish" ${settings.defaultLanguage === 'spanish' ? 'selected' : ''}>üá™üá∏ Spanish</option>
              </select>
            </div>

            <div>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151;">
                <input type="checkbox" ${settings.enableAdvancedFeatures ? 'checked' : ''} onchange="updateSetting('enableAdvancedFeatures', this.checked)" style="transform: scale(1.2);">
                Enable Advanced Features
              </label>
              <p style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem; color: #6b7280;">Includes predictive analytics, bulk operations, and advanced automation</p>
            </div>
          </div>
        </div>
      `;
    }

    // Generate Decisions Tab
    function generateDecisionsTab() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Application Decisions</h3>
            <button onclick="showNewDecisionForm()" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">+ New Decision</button>
          </div>

          <!-- Search and Filter -->
          <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 200px 200px; gap: 1rem; align-items: center;">
              <input type="text" id="searchDecisions" placeholder="Search by applicant name or ID..." style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
              <select id="filterStatus" style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                <option value="">All Statuses</option>
                <option value="admitted">Admitted</option>
                <option value="denied">Denied</option>
                <option value="waitlisted">Waitlisted</option>
                <option value="conditional">Conditional</option>
              </select>
              <select id="filterProgram" style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                <option value="">All Programs</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Business Administration">Business Administration</option>
                <option value="Engineering">Engineering</option>
                <option value="Psychology">Psychology</option>
              </select>
            </div>
          </div>

          <!-- Decisions Table -->
          <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
            <div style="background: #f8fafc; padding: 1rem; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #374151; display: grid; grid-template-columns: 150px 1fr 1fr 120px 120px 150px 100px; gap: 1rem; align-items: center;">
              <div>Applicant ID</div>
              <div>Name</div>
              <div>Program</div>
              <div>Status</div>
              <div>Decision Date</div>
              <div>Notification</div>
              <div>Actions</div>
            </div>
            ${decisions.map(decision => `
              <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0; display: grid; grid-template-columns: 150px 1fr 1fr 120px 120px 150px 100px; gap: 1rem; align-items: center; hover:background-color: #f9fafb;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                <div style="font-family: monospace; font-weight: 600; color: #5a5bb8;">${decision.applicantId}</div>
                <div>
                  <div style="font-weight: 600; color: #1f2937;">${decision.applicantName}</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">${decision.email}</div>
                </div>
                <div>
                  <div style="font-weight: 500; color: #1f2937;">${decision.program}</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">${decision.level}</div>
                </div>
                <div>
                  <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; ${getStatusStyle(decision.status)}">
                    ${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)}
                  </span>
                </div>
                <div style="color: #6b7280;">${new Date(decision.decisionDate).toLocaleDateString()}</div>
                <div>
                  ${decision.notificationSent
                    ? `<span style="color: #3b82f6; font-size: 0.875rem;">‚úì Sent</span>`
                    : decision.scheduledRelease
                      ? `<span style="color: #f59e0b; font-size: 0.875rem;">‚è∞ Scheduled</span>`
                      : `<span style="color: #ef4444; font-size: 0.875rem;">‚úó Pending</span>`
                  }
                </div>
                <div style="display: flex; gap: 0.25rem;">
                  <button onclick="editDecision('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" title="Edit">‚úèÔ∏è</button>
                  <button onclick="sendNotification('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" title="Send">üìß</button>
                  <button onclick="viewHistory('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" title="History">üìä</button>
                </div>
              </div>
            `).join('')}
          </div>

          ${decisions.length === 0 ? `
            <div style="text-align: center; padding: 3rem; color: #6b7280;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
              <h3 style="margin: 0 0 0.5rem 0; color: #9ca3af;">No decisions recorded yet</h3>
              <p style="margin: 0;">Click "New Decision" to record your first admission decision.</p>
            </div>
          ` : ''}
        </div>
      `;
    }

    function getStatusStyle(status) {
      switch (status) {
        case 'admitted':
          return 'background: #dcfce7; color: #166534;';
        case 'denied':
          return 'background: #fee2e2; color: #991b1b;';
        case 'waitlisted':
          return 'background: #fef3c7; color: #92400e;';
        case 'conditional':
          return 'background: #dbeafe; color: #1e40af;';
        default:
          return 'background: #f3f4f6; color: #374151;';
      }
    }

    // Generate Templates Tab
    function generateTemplatesTab() {
      const templates = JSON.parse(localStorage.getItem(DECISION_STORAGE.templates) || '{}');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Notification Templates</h3>
            <button onclick="createNewTemplate()" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">+ New Template</button>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
            ${Object.entries(templates).map(([type, typeTemplates]) => `
              <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
                <div style="background: #f8fafc; padding: 1.5rem; border-bottom: 2px solid #e2e8f0;">
                  <h4 style="margin: 0; color: #1f2937; font-size: 1.25rem; text-transform: capitalize;">${type} Templates</h4>
                </div>
                <div style="padding: 1.5rem;">
                  ${Object.entries(typeTemplates).map(([lang, template]) => `
                    <div style="background: #f9fafb; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                          <span style="background: #5a5bb8; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${lang}</span>
                          <span style="font-weight: 600; color: #1f2937;">${template.subject}</span>
                        </div>
                        <div style="display: flex; gap: 0.25rem;">
                          <button onclick="editTemplate('${type}', '${lang}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Edit</button>
                          <button onclick="previewTemplate('${type}', '${lang}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Preview</button>
                        </div>
                      </div>
                      <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.5; max-height: 4rem; overflow: hidden;">
                        ${template.body.substring(0, 150)}...
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>

          <!-- Merge Fields Reference -->
          <div style="background: #fefce8; border: 2px solid #fde047; border-radius: 12px; padding: 2rem; margin-top: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #92400e; font-size: 1.25rem;">üìã Available Merge Fields</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <h5 style="margin: 0 0 0.5rem 0; color: #92400e; font-weight: 600;">Applicant Information</h5>
                <ul style="margin: 0; padding-left: 1rem; color: #a16207; font-family: monospace; font-size: 0.875rem;">
                  <li>{{applicantName}}</li>
                  <li>{{applicantId}}</li>
                  <li>{{email}}</li>
                  <li>{{program}}</li>
                  <li>{{level}}</li>
                </ul>
              </div>
              <div>
                <h5 style="margin: 0 0 0.5rem 0; color: #92400e; font-weight: 600;">Institution Information</h5>
                <ul style="margin: 0; padding-left: 1rem; color: #a16207; font-family: monospace; font-size: 0.875rem;">
                  <li>{{institutionName}}</li>
                  <li>{{admissionsOfficer}}</li>
                  <li>{{academicYear}}</li>
                  <li>{{confirmationDeadline}}</li>
                  <li>{{depositAmount}}</li>
                </ul>
              </div>
              <div>
                <h5 style="margin: 0 0 0.5rem 0; color: #92400e; font-weight: 600;">Dynamic Fields</h5>
                <ul style="margin: 0; padding-left: 1rem; color: #a16207; font-family: monospace; font-size: 0.875rem;">
                  <li>{{orientationDate}}</li>
                  <li>{{updateDate}}</li>
                  <li>{{conditions}}</li>
                  <li>{{conditionDeadline}}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Generate Notifications Tab
    function generateNotificationsTab() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const pendingNotifications = decisions.filter(d => !d.notificationSent);
      const sentNotifications = decisions.filter(d => d.notificationSent);

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Notification Management</h3>
            <button onclick="sendBulkNotifications()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üìß Send All Pending</button>
          </div>

          <!-- Summary Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: #fef3c7; border: 2px solid #fde047; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
              <div style="font-size: 2rem; font-weight: 700; color: #92400e; margin-bottom: 0.25rem;">${pendingNotifications.length}</div>
              <div style="color: #a16207; font-weight: 500;">Pending Notifications</div>
            </div>
            <div style="background: #dcfce7; border: 2px solid #bbf7d0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
              <div style="font-size: 2rem; font-weight: 700; color: #166534; margin-bottom: 0.25rem;">${sentNotifications.length}</div>
              <div style="color: #2563eb; font-weight: 500;">Sent Notifications</div>
            </div>
            <div style="background: #dbeafe; border: 2px solid #93c5fd; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è∞</div>
              <div style="font-size: 2rem; font-weight: 700; color: #1e40af; margin-bottom: 0.25rem;">${decisions.filter(d => d.scheduledRelease).length}</div>
              <div style="color: #2563eb; font-weight: 500;">Scheduled Releases</div>
            </div>
          </div>

          <!-- Pending Notifications -->
          <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 2rem; overflow: hidden;">
            <div style="background: #fef3c7; padding: 1.5rem; border-bottom: 2px solid #fde047;">
              <h4 style="margin: 0; color: #92400e; font-size: 1.25rem;">‚è≥ Pending Notifications</h4>
            </div>
            <div style="padding: 1.5rem;">
              ${pendingNotifications.length === 0 ? `
                <div style="text-align: center; padding: 2rem; color: #6b7280;">
                  <div style="font-size: 2rem; margin-bottom: 1rem;">‚úÖ</div>
                  <p style="margin: 0;">All notifications have been sent!</p>
                </div>
              ` : `
                <div style="display: grid; gap: 1rem;">
                  ${pendingNotifications.map(decision => `
                    <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: 600; color: #1f2937;">${decision.applicantName}</div>
                        <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                          ${decision.program} ‚Ä¢ ${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)}
                          ${decision.scheduledRelease ? ` ‚Ä¢ Scheduled for ${new Date(decision.scheduledRelease).toLocaleString()}` : ''}
                        </div>
                      </div>
                      <div style="display: flex; gap: 0.5rem;">
                        <button onclick="previewNotification('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Preview</button>
                        <button onclick="scheduleNotification('${decision.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Schedule</button>
                        <button onclick="sendNotificationNow('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Send Now</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>

          <!-- Recent Notifications -->
          <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
            <div style="background: #dcfce7; padding: 1.5rem; border-bottom: 2px solid #bbf7d0;">
              <h4 style="margin: 0; color: #166534; font-size: 1.25rem;">‚úÖ Recently Sent Notifications</h4>
            </div>
            <div style="padding: 1.5rem;">
              ${sentNotifications.slice(0, 10).map(decision => `
                <div style="border-bottom: 1px solid #e2e8f0; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-weight: 600; color: #1f2937;">${decision.applicantName}</div>
                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                      ${decision.program} ‚Ä¢ ${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)} ‚Ä¢
                      Sent ${new Date(decision.notificationDate).toLocaleString()}
                    </div>
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    <button onclick="resendNotification('${decision.id}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Resend</button>
                    <button onclick="viewNotificationDetails('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">View Details</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Generate Scheduled Tab
    function generateScheduledTab() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const scheduledDecisions = decisions.filter(d => d.scheduledRelease);

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Scheduled Releases</h3>
            <button onclick="scheduleNewRelease()" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">‚è∞ Schedule Release</button>
          </div>

          ${scheduledDecisions.length === 0 ? `
            <div style="text-align: center; padding: 3rem; color: #6b7280;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">‚è∞</div>
              <h3 style="margin: 0 0 0.5rem 0; color: #9ca3af;">No scheduled releases</h3>
              <p style="margin: 0;">Schedule decision release dates to automate your notification process.</p>
            </div>
          ` : `
            <div style="display: grid; gap: 1.5rem;">
              ${scheduledDecisions.map(decision => {
                const releaseDate = new Date(decision.scheduledRelease);
                const now = new Date();
                const isOverdue = releaseDate < now;
                const timeUntil = releaseDate.getTime() - now.getTime();
                const daysUntil = Math.ceil(timeUntil / (1000 * 60 * 60 * 24));

                return `
                  <div style="background: white; border: 2px solid ${isOverdue ? '#ef4444' : '#e2e8f0'}; border-radius: 12px; padding: 1.5rem;">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
                      <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                          <h4 style="margin: 0; color: #1f2937; font-size: 1.25rem;">${decision.applicantName}</h4>
                          <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; ${getStatusStyle(decision.status)}">${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)}</span>
                          ${isOverdue ? '<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">OVERDUE</span>' : ''}
                        </div>
                        <div style="color: #6b7280; margin-bottom: 1rem;">
                          ${decision.program} ‚Ä¢ ${decision.email}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                          <div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Scheduled Release</div>
                            <div style="font-weight: 600; color: ${isOverdue ? '#ef4444' : '#1f2937'};">${releaseDate.toLocaleString()}</div>
                          </div>
                          <div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Time ${isOverdue ? 'Overdue' : 'Remaining'}</div>
                            <div style="font-weight: 600; color: ${isOverdue ? '#ef4444' : daysUntil <= 1 ? '#f59e0b' : '#3b82f6'};">
                              ${isOverdue ? `${Math.abs(daysUntil)} days overdue` : daysUntil === 0 ? 'Today' : `${daysUntil} days`}
                            </div>
                          </div>
                        </div>
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                        <button onclick="editSchedule('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Edit Schedule</button>
                        <button onclick="releaseNow('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Release Now</button>
                        <button onclick="cancelSchedule('${decision.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Cancel</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}
        </div>
      `;
    }

    // Generate Advanced Analytics Tab
    function generateAnalyticsTab() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const analytics = calculateAdvancedAnalytics(decisions);

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Advanced Analytics Dashboard</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="refreshAnalytics()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üîÑ Refresh Data</button>
              <button onclick="exportAnalyticsReport()" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üìä Export Report</button>
            </div>
          </div>

          <!-- Key Metrics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 12px;">
              <div style="display: flex; justify-content: between; align-items: start;">
                <div style="flex: 1;">
                  <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Decisions</div>
                  <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${analytics.totalDecisions}</div>
                  <div style="font-size: 0.875rem; opacity: 0.8;">üìà ${analytics.decisionsGrowth}% this month</div>
                </div>
                <div style="font-size: 2rem;">üìã</div>
              </div>
            </div>

            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 12px;">
              <div style="display: flex; justify-content: between; align-items: start;">
                <div style="flex: 1;">
                  <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Acceptance Rate</div>
                  <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${analytics.acceptanceRate}%</div>
                  <div style="font-size: 0.875rem; opacity: 0.8;">Industry avg: ${analytics.industryBenchmark}%</div>
                </div>
                <div style="font-size: 2rem;">‚úÖ</div>
              </div>
            </div>

            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 12px;">
              <div style="display: flex; justify-content: between; align-items: start;">
                <div style="flex: 1;">
                  <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Avg. Processing Time</div>
                  <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${analytics.avgProcessingTime}</div>
                  <div style="font-size: 0.875rem; opacity: 0.8;">days per decision</div>
                </div>
                <div style="font-size: 2rem;">‚è±Ô∏è</div>
              </div>
            </div>

            <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem; border-radius: 12px;">
              <div style="display: flex; justify-content: between; align-items: start;">
                <div style="flex: 1;">
                  <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Notification Rate</div>
                  <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${analytics.notificationRate}%</div>
                  <div style="font-size: 0.875rem; opacity: 0.8;">${analytics.pendingNotifications} pending</div>
                </div>
                <div style="font-size: 2rem;">üìß</div>
              </div>
            </div>
          </div>

          <!-- Charts and Detailed Analytics -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <!-- Decision Breakdown Chart -->
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Decision Breakdown</h4>
              <div style="position: relative; height: 250px;">
                ${generatePieChart(analytics.decisionBreakdown)}
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                ${Object.entries(analytics.decisionBreakdown).map(([status, count]) => `
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background: ${getStatusColor(status)};"></div>
                    <span style="font-size: 0.875rem; color: #6b7280;">${status.charAt(0).toUpperCase() + status.slice(1)}: ${count}</span>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Program Performance -->
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Program Performance</h4>
              <div style="space-y: 1rem;">
                ${Object.entries(analytics.programStats).map(([program, stats]) => `
                  <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.25rem;">
                      <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">${program}</span>
                      <span style="font-size: 0.875rem; color: #6b7280;">${stats.total} applications</span>
                    </div>
                    <div style="background: #f3f4f6; border-radius: 6px; height: 8px; overflow: hidden;">
                      <div style="background: #5a5bb8; height: 100%; width: ${(stats.admitted / stats.total * 100)}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                      ${stats.admitted} admitted (${Math.round(stats.admitted / stats.total * 100)}% acceptance rate)
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <!-- Time Series Analysis -->
          <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Decision Trends (Last 30 Days)</h4>
            <div style="height: 200px; position: relative;">
              ${generateTimeSeriesChart(analytics.timeSeriesData)}
            </div>
          </div>

          <!-- Predictive Insights -->
          <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; border-radius: 12px; padding: 2rem;">
            <h4 style="margin: 0 0 1.5rem 0; color: #0369a1; display: flex; align-items: center; gap: 0.5rem;">
              üîÆ AI-Powered Insights & Predictions
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
              ${analytics.insights.map(insight => `
                <div style="background: white; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.25rem;">${insight.icon}</span>
                    <span style="font-weight: 600; color: #0369a1;">${insight.title}</span>
                  </div>
                  <p style="margin: 0; font-size: 0.875rem; color: #075985; line-height: 1.5;">${insight.description}</p>
                  ${insight.action ? `
                    <button onclick="${insight.action}" style="background: #0ea5e9; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer; margin-top: 0.75rem;">
                      ${insight.actionText}
                    </button>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Generate Advanced Settings Tab
    function generateSettingsTab() {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">System Settings & Configuration</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="resetToDefaults()" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üîÑ Reset to Defaults</button>
              <button onclick="exportSettings()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üíæ Export Settings</button>
              <button onclick="importSettings()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üìÅ Import Settings</button>
            </div>
          </div>

          <!-- Settings Navigation -->
          <div style="display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 2rem; overflow-x: auto;">
            <button class="settings-tab active" data-setting="general" style="padding: 1rem 2rem; border: none; background: white; border-bottom: 3px solid #5a5bb8; color: #5a5bb8; font-weight: 600; cursor: pointer; white-space: nowrap;">üèõÔ∏è General</button>
            <button class="settings-tab" data-setting="notifications" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üìß Notifications</button>
            <button class="settings-tab" data-setting="security" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üîí Security</button>
            <button class="settings-tab" data-setting="automation" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">ü§ñ Automation</button>
            <button class="settings-tab" data-setting="integration" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">üîó Integrations</button>
            <button class="settings-tab" data-setting="advanced" style="padding: 1rem 2rem; border: none; background: #f8fafc; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; white-space: nowrap;">‚öôÔ∏è Advanced</button>
          </div>

          <!-- Settings Content -->
          <div id="settingsContent">
            ${generateGeneralSettings()}
          </div>
        </div>
      `;
    }

    // Generate History Tab (simplified version)
    function generateHistoryTab() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const allHistory = [];

      decisions.forEach(decision => {
        decision.history.forEach(entry => {
          allHistory.push({
            ...entry,
            applicantName: decision.applicantName,
            applicantId: decision.applicantId,
            program: decision.program
          });
        });
      });

      allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Decision History</h3>
            <button onclick="exportHistory()" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üìä Export Report</button>
          </div>

          <!-- Filter Options -->
          <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <select id="historyDateFilter" style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
              </select>
              <select id="historyActionFilter" style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                <option value="">All Actions</option>
                <option value="reviewed">Application Reviewed</option>
                <option value="decision">Decision Made</option>
                <option value="notification">Notification Sent</option>
                <option value="scheduled">Scheduled</option>
              </select>
              <input type="text" id="historyUserFilter" placeholder="Filter by user..." style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
            </div>
          </div>

          <!-- History Timeline -->
          <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
            ${allHistory.length === 0 ? `
              <div style="text-align: center; padding: 3rem; color: #6b7280;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                <h3 style="margin: 0 0 0.5rem 0; color: #9ca3af;">No history available</h3>
                <p style="margin: 0;">Decision history will appear here as you make decisions.</p>
              </div>
            ` : `
              <div style="padding: 1.5rem;">
                ${allHistory.map((entry, index) => `
                  <div style="display: flex; align-items: start; padding: 1rem 0; ${index < allHistory.length - 1 ? 'border-bottom: 1px solid #e2e8f0;' : ''}">
                    <div style="width: 10px; height: 10px; background: #5a5bb8; border-radius: 50%; margin-top: 0.5rem; margin-right: 1rem; flex-shrink: 0;"></div>
                    <div style="flex: 1;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div>
                          <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${entry.action}</div>
                          <div style="font-size: 0.875rem; color: #6b7280;">
                            ${entry.applicantName} (${entry.applicantId}) ‚Ä¢ ${entry.program}
                          </div>
                        </div>
                        <div style="text-align: right;">
                          <div style="font-size: 0.875rem; color: #6b7280;">${new Date(entry.date).toLocaleDateString()}</div>
                          <div style="font-size: 0.875rem; color: #5a5bb8; font-weight: 500;">by ${entry.user}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    // Action Functions
    window.showNewDecisionForm = function() {
      const modal = document.createElement('div');
      modal.id = 'newDecisionModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; padding: 1.5rem;">
          <div style="background: linear-gradient(135deg, #5a5bb8 0%, #4a4b98 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üìã New Admission Decision</h3>
              <button onclick="closeModal('newDecisionModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
          </div>

          <div style="padding: 2rem;">
            <form id="newDecisionForm" onsubmit="submitNewDecision(event)">
              <!-- Applicant Information -->
              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üë§ Applicant Information</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Applicant ID *</label>
                    <input type="text" name="applicantId" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="APP-2025-XXX">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Full Name *</label>
                    <input type="text" name="applicantName" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="John Doe">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Address *</label>
                    <input type="email" name="email" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="john@example.com">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Phone Number</label>
                    <input type="tel" name="phone" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="+1 (555) 123-4567">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Program *</label>
                    <select name="program" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                      <option value="">Select Program</option>
                      <option value="Computer Science">Computer Science</option>
                      <option value="Business Administration">Business Administration</option>
                      <option value="Engineering">Engineering</option>
                      <option value="Psychology">Psychology</option>
                      <option value="Medicine">Medicine</option>
                      <option value="Law">Law</option>
                      <option value="Arts & Humanities">Arts & Humanities</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Level *</label>
                    <select name="level" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                      <option value="">Select Level</option>
                      <option value="Undergraduate">Undergraduate</option>
                      <option value="Graduate">Graduate</option>
                      <option value="Doctoral">Doctoral</option>
                      <option value="Certificate">Certificate</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Decision Information -->
              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">‚úÖ Decision Information</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Decision Status *</label>
                    <select name="status" required onchange="toggleConditionalFields(this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                      <option value="">Select Decision</option>
                      <option value="admitted">‚úÖ Admitted</option>
                      <option value="denied">‚ùå Denied</option>
                      <option value="waitlisted">‚è≥ Waitlisted</option>
                      <option value="conditional">‚ö†Ô∏è Conditional Admission</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Decision Date *</label>
                    <input type="date" name="decisionDate" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" value="${new Date().toISOString().split('T')[0]}">
                  </div>
                </div>
                <div style="margin-bottom: 0.75rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Decision Notes</label>
                  <textarea name="notes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical;" placeholder="Additional notes about this decision..."></textarea>
                </div>
                <div id="conditionalFields" style="display: none; background: #fef3c7; border: 2px solid #fde047; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #92400e;">Conditions for Admission</label>
                  <textarea name="conditions" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #fde047; border-radius: 8px; font-size: 1rem; resize: vertical;" placeholder="List conditions that must be met for admission..."></textarea>
                  <label style="display: block; margin: 0.5rem 0; font-weight: 600; color: #92400e;">Condition Deadline</label>
                  <input type="date" name="conditionDeadline" style="width: 100%; padding: 0.75rem; border: 2px solid #fde047; border-radius: 8px; font-size: 1rem;">
                </div>
              </div>

              <!-- Notification Settings -->
              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üìß Notification Settings</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Language</label>
                    <select name="language" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                      <option value="english">üá∫üá∏ English</option>
                      <option value="spanish">üá™üá∏ Spanish</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Send Notification</label>
                    <select name="sendNotification" onchange="toggleScheduleFields(this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                      <option value="later">üìù Save for Later</option>
                      <option value="now">üìß Send Immediately</option>
                      <option value="scheduled">‚è∞ Schedule for Later</option>
                    </select>
                  </div>
                </div>
                <div id="scheduleFields" style="display: none; background: #dbeafe; border: 2px solid #93c5fd; border-radius: 8px; padding: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e40af;">Scheduled Release Date & Time</label>
                  <input type="datetime-local" name="scheduledRelease" style="width: 100%; padding: 0.75rem; border: 2px solid #93c5fd; border-radius: 8px; font-size: 1rem;">
                </div>
              </div>

              <!-- Form Actions -->
              <div style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1rem; border-top: 2px solid #e2e8f0;">
                <button type="button" onclick="closeModal('newDecisionModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                <button type="submit" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üìã Save Decision</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.toggleConditionalFields = function(status) {
      const conditionalFields = document.getElementById('conditionalFields');
      if (conditionalFields) {
        conditionalFields.style.display = status === 'conditional' ? 'block' : 'none';
      }
    };

    window.toggleScheduleFields = function(sendOption) {
      const scheduleFields = document.getElementById('scheduleFields');
      if (scheduleFields) {
        scheduleFields.style.display = sendOption === 'scheduled' ? 'block' : 'none';
      }
    };

    window.submitNewDecision = function(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');

      const newDecision = {
        id: Date.now().toString(),
        applicantId: formData.get('applicantId'),
        applicantName: formData.get('applicantName'),
        email: formData.get('email'),
        phone: formData.get('phone') || '',
        program: formData.get('program'),
        level: formData.get('level'),
        status: formData.get('status'),
        decision: getDecisionLabel(formData.get('status')),
        decisionDate: formData.get('decisionDate'),
        notes: formData.get('notes') || '',
        conditions: formData.get('conditions') || '',
        conditionDeadline: formData.get('conditionDeadline') || '',
        language: formData.get('language'),
        decidedBy: 'Current User',
        notificationSent: formData.get('sendNotification') === 'now',
        notificationDate: formData.get('sendNotification') === 'now' ? new Date().toISOString() : null,
        scheduledRelease: formData.get('sendNotification') === 'scheduled' ? new Date(formData.get('scheduledRelease')).toISOString() : null,
        history: [
          {
            date: new Date().toISOString(),
            action: 'Decision recorded',
            user: 'Current User'
          }
        ]
      };

      if (formData.get('sendNotification') === 'now') {
        newDecision.history.push({
          date: new Date().toISOString(),
          action: 'Notification sent immediately',
          user: 'Current User'
        });
      } else if (formData.get('sendNotification') === 'scheduled') {
        newDecision.history.push({
          date: new Date().toISOString(),
          action: `Notification scheduled for ${new Date(formData.get('scheduledRelease')).toLocaleString()}`,
          user: 'Current User'
        });
      }

      decisions.push(newDecision);
      localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));

      closeModal('newDecisionModal');
      showDecisionTab('decisions');
      showToast(`Decision recorded for ${newDecision.applicantName}!`, 'success');
    };

    function getDecisionLabel(status) {
      const labels = {
        'admitted': 'Admission Offer',
        'denied': 'Application Denied',
        'waitlisted': 'Waitlisted',
        'conditional': 'Conditional Admission'
      };
      return labels[status] || status;
    }

    window.editDecision = function(id) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === id);

      if (!decision) {
        showToast('Decision not found!', 'error');
        return;
      }

      // Create edit modal (similar to new decision form but pre-filled)
      const modal = document.createElement('div');
      modal.id = 'editDecisionModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; padding: 1.5rem;">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">‚úèÔ∏è Edit Decision: ${decision.applicantName}</h3>
              <button onclick="closeModal('editDecisionModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
          </div>

          <div style="padding: 2rem;">
            <form id="editDecisionForm" onsubmit="submitEditDecision(event, '${id}')">
              <!-- Pre-filled form fields similar to new decision form -->
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Decision Status *</label>
                <select name="status" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="admitted" ${decision.status === 'admitted' ? 'selected' : ''}>‚úÖ Admitted</option>
                  <option value="denied" ${decision.status === 'denied' ? 'selected' : ''}>‚ùå Denied</option>
                  <option value="waitlisted" ${decision.status === 'waitlisted' ? 'selected' : ''}>‚è≥ Waitlisted</option>
                  <option value="conditional" ${decision.status === 'conditional' ? 'selected' : ''}>‚ö†Ô∏è Conditional Admission</option>
                </select>
              </div>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Decision Notes</label>
                <textarea name="notes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical;">${decision.notes}</textarea>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1rem; border-top: 2px solid #e2e8f0;">
                <button type="button" onclick="closeModal('editDecisionModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üíæ Update Decision</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.submitEditDecision = function(event, id) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decisionIndex = decisions.findIndex(d => d.id === id);

      if (decisionIndex !== -1) {
        decisions[decisionIndex].status = formData.get('status');
        decisions[decisionIndex].notes = formData.get('notes');
        decisions[decisionIndex].decision = getDecisionLabel(formData.get('status'));
        decisions[decisionIndex].history.push({
          date: new Date().toISOString(),
          action: 'Decision updated',
          user: 'Current User'
        });

        localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
        closeModal('editDecisionModal');
        showDecisionTab('decisions');
        showToast('Decision updated successfully!', 'success');
      }
    };

    window.sendNotification = function(id) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === id);

      if (decision && !decision.notificationSent) {
        decision.notificationSent = true;
        decision.notificationDate = new Date().toISOString();
        decision.history.push({
          date: new Date().toISOString(),
          action: 'Notification sent',
          user: 'Current User'
        });
        localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
        showDecisionTab('decisions');
        showToast(`Notification sent to ${decision.applicantName}!`, 'success');
      }
    };

    window.viewHistory = function(id) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === id);

      if (!decision) {
        showToast('Decision not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'historyModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 450px; max-height: 85vh; overflow-y: auto; padding: 1.5rem;">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üìä Decision History</h3>
              <button onclick="closeModal('historyModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
            <div style="margin-top: 0.5rem; opacity: 0.9;">
              ${decision.applicantName} (${decision.applicantId})
            </div>
          </div>

          <div style="padding: 1.5rem; max-height: 400px; overflow-y: auto;">
            ${decision.history.map((entry, index) => `
              <div style="display: flex; align-items: start; padding: 1rem 0; ${index < decision.history.length - 1 ? 'border-bottom: 1px solid #e2e8f0;' : ''}">
                <div style="width: 10px; height: 10px; background: #3b82f6; border-radius: 50%; margin-top: 0.5rem; margin-right: 1rem; flex-shrink: 0;"></div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${entry.action}</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">
                    ${new Date(entry.date).toLocaleString()} ‚Ä¢ by ${entry.user}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.sendBulkNotifications = function() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const pending = decisions.filter(d => !d.notificationSent);

      if (pending.length === 0) {
        alert('No pending notifications to send.');
        return;
      }

      if (confirm(`Send ${pending.length} pending notifications?`)) {
        pending.forEach(decision => {
          decision.notificationSent = true;
          decision.notificationDate = new Date().toISOString();
          decision.history.push({
            date: new Date().toISOString(),
            action: 'Bulk notification sent',
            user: 'Current User'
          });
        });
        localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
        showDecisionTab('notifications');
        alert(`${pending.length} notifications sent successfully!`);
      }
    };

    window.sendNotificationNow = function(id) {
      sendNotification(id);
    };

    window.previewNotification = function(id) {
      alert(`Preview Notification ${id} - This would show a preview of the email that will be sent.`);
    };

    window.scheduleNotification = function(id) {
      const newDate = prompt('Enter scheduled release date and time (YYYY-MM-DD HH:MM):');
      if (newDate) {
        const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
        const decision = decisions.find(d => d.id === id);
        if (decision) {
          decision.scheduledRelease = new Date(newDate).toISOString();
          decision.history.push({
            date: new Date().toISOString(),
            action: `Scheduled for release at ${newDate}`,
            user: 'Current User'
          });
          localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
          showDecisionTab('notifications');
          alert('Notification scheduled successfully!');
        }
      }
    };

    // Advanced notification and template functions
    window.previewNotification = function(id) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === id);
      const templates = JSON.parse(localStorage.getItem(DECISION_STORAGE.templates) || '{}');

      if (!decision) {
        showToast('Decision not found!', 'error');
        return;
      }

      const template = templates[decision.status]?.[decision.language];
      if (!template) {
        showToast('Template not found!', 'error');
        return;
      }

      const processedContent = processTemplate(template, decision);

      const modal = document.createElement('div');
      modal.id = 'previewModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üëÄ Notification Preview</h3>
              <button onclick="closeModal('previewModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
            <div style="margin-top: 0.5rem; opacity: 0.9;">
              Preview for ${decision.applicantName} (${decision.language.toUpperCase()})
            </div>
          </div>

          <div style="padding: 2rem; max-height: 600px; overflow-y: auto;">
            <!-- Email Preview -->
            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
              <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e2e8f0;">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                  <span style="font-weight: 600;">To:</span><span>${decision.email}</span>
                  <span style="font-weight: 600;">Subject:</span><span style="font-weight: 600; color: #1f2937;">${processedContent.subject}</span>
                </div>
              </div>
              <div style="line-height: 1.6; white-space: pre-line; color: #1f2937;">
                ${processedContent.body}
              </div>
              <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; font-size: 0.875rem; color: #6b7280; font-style: italic;">
                ${processedContent.footer}
              </div>
            </div>

            <!-- Actions -->
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button onclick="closeModal('previewModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Close</button>
              <button onclick="sendNotificationFromPreview('${id}')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üìß Send Now</button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.sendNotificationFromPreview = function(id) {
      closeModal('previewModal');
      sendNotification(id);
    };

    function processTemplate(template, decision) {
      const mergeFields = {
        applicantName: decision.applicantName,
        applicantId: decision.applicantId,
        email: decision.email,
        program: decision.program,
        level: decision.level,
        institutionName: 'Flow University',
        admissionsOfficer: 'Dr. Academic Affairs',
        academicYear: '2025-2026',
        confirmationDeadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
        depositAmount: '$500',
        orientationDate: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toLocaleDateString(),
        updateDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toLocaleDateString(),
        conditions: decision.conditions || 'Complete final transcripts',
        conditionDeadline: decision.conditionDeadline ? new Date(decision.conditionDeadline).toLocaleDateString() : new Date(Date.now() + 45 * 24 * 60 * 60 * 1000).toLocaleDateString()
      };

      let processedSubject = template.subject;
      let processedBody = template.body;

      Object.entries(mergeFields).forEach(([key, value]) => {
        const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
        processedSubject = processedSubject.replace(regex, value);
        processedBody = processedBody.replace(regex, value);
      });

      return {
        subject: processedSubject,
        body: processedBody,
        footer: template.footer
      };
    }

    // Template management functions
    window.editTemplate = function(type, language) {
      const templates = JSON.parse(localStorage.getItem(DECISION_STORAGE.templates) || '{}');
      const template = templates[type]?.[language];

      if (!template) {
        showToast('Template not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editTemplateModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 95%; max-width: 1000px; max-height: 95vh; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #5a5bb8 0%, #4a4b98 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üìù Edit Template: ${type.charAt(0).toUpperCase() + type.slice(1)} (${language.toUpperCase()})</h3>
              <button onclick="closeModal('editTemplateModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
          </div>

          <div style="padding: 2rem; max-height: calc(95vh - 120px); overflow-y: auto;">
            <form id="editTemplateForm" onsubmit="submitTemplateEdit(event, '${type}', '${language}')">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; height: 500px;">
                <!-- Editor Panel -->
                <div>
                  <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Template Editor</h4>

                  <div style="margin-bottom: 0.75rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Subject Line</label>
                    <input type="text" name="subject" value="${template.subject}" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  </div>

                  <div style="margin-bottom: 0.75rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Body</label>
                    <textarea name="body" rows="12" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; font-family: monospace; resize: vertical;">${template.body}</textarea>
                  </div>

                  <div style="margin-bottom: 0.75rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Footer</label>
                    <input type="text" name="footer" value="${template.footer}" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  </div>
                </div>

                <!-- Live Preview Panel -->
                <div>
                  <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Live Preview</h4>
                  <div id="templatePreview" style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e2e8f0;">
                      <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Subject:</div>
                      <div id="previewSubject" style="font-weight: 600; color: #1f2937;">${template.subject}</div>
                    </div>
                    <div id="previewBody" style="line-height: 1.6; white-space: pre-line; color: #1f2937; margin-bottom: 1rem;">${template.body}</div>
                    <div id="previewFooter" style="font-size: 0.875rem; color: #6b7280; font-style: italic; padding-top: 1rem; border-top: 1px solid #e2e8f0;">${template.footer}</div>
                  </div>
                </div>
              </div>

              <!-- Available Merge Fields -->
              <div style="background: #fefce8; border: 2px solid #fde047; border-radius: 12px; padding: 1rem; margin: 2rem 0;">
                <h5 style="margin: 0 0 0.5rem 0; color: #92400e;">Available Merge Fields (click to insert):</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                  ${['applicantName', 'applicantId', 'program', 'level', 'institutionName', 'admissionsOfficer', 'academicYear', 'confirmationDeadline', 'depositAmount', 'orientationDate', 'updateDate', 'conditions', 'conditionDeadline'].map(field =>
                    `<button type="button" onclick="insertMergeField('${field}')" style="background: #fde047; color: #92400e; border: 1px solid #f59e0b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-family: monospace;">{{${field}}}</button>`
                  ).join('')}
                </div>
              </div>

              <!-- Form Actions -->
              <div style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1rem; border-top: 2px solid #e2e8f0;">
                <button type="button" onclick="closeModal('editTemplateModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                <button type="submit" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üíæ Save Template</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Add live preview functionality
      const form = document.getElementById('editTemplateForm');
      if (form) {
        form.addEventListener('input', updateTemplatePreview);
      }
    };

    function updateTemplatePreview() {
      const subjectInput = document.querySelector('input[name="subject"]');
      const bodyInput = document.querySelector('textarea[name="body"]');
      const footerInput = document.querySelector('input[name="footer"]');

      const previewSubject = document.getElementById('previewSubject');
      const previewBody = document.getElementById('previewBody');
      const previewFooter = document.getElementById('previewFooter');

      if (previewSubject) previewSubject.textContent = subjectInput.value;
      if (previewBody) previewBody.textContent = bodyInput.value;
      if (previewFooter) previewFooter.textContent = footerInput.value;
    }

    window.insertMergeField = function(field) {
      const bodyTextarea = document.querySelector('textarea[name="body"]');
      if (bodyTextarea) {
        const cursorPos = bodyTextarea.selectionStart;
        const textBefore = bodyTextarea.value.substring(0, cursorPos);
        const textAfter = bodyTextarea.value.substring(cursorPos);
        bodyTextarea.value = textBefore + `{{${field}}}` + textAfter;
        bodyTextarea.focus();
        bodyTextarea.setSelectionRange(cursorPos + field.length + 4, cursorPos + field.length + 4);
        updateTemplatePreview();
      }
    };

    window.submitTemplateEdit = function(event, type, language) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const templates = JSON.parse(localStorage.getItem(DECISION_STORAGE.templates) || '{}');

      if (!templates[type]) templates[type] = {};
      templates[type][language] = {
        subject: formData.get('subject'),
        body: formData.get('body'),
        footer: formData.get('footer')
      };

      localStorage.setItem(DECISION_STORAGE.templates, JSON.stringify(templates));
      closeModal('editTemplateModal');
      showDecisionTab('templates');
      showToast('Template updated successfully!', 'success');
    };

    // Missing template functions
    window.createNewTemplate = function() {
      const modal = document.createElement('div');
      modal.id = 'newTemplateModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 450px; max-height: 85vh; overflow-y: auto; padding: 1.5rem;">
          <div style="background: linear-gradient(135deg, #5a5bb8 0%, #4a4b98 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üìù Create New Template</h3>
              <button onclick="closeModal('newTemplateModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
          </div>

          <div style="padding: 2rem;">
            <form id="newTemplateForm" onsubmit="submitNewTemplate(event)">
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Template Type *</label>
                <select name="type" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="">Select Type</option>
                  <option value="admission">Admission</option>
                  <option value="rejection">Rejection</option>
                  <option value="waitlist">Waitlist</option>
                  <option value="conditional">Conditional</option>
                </select>
              </div>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Language *</label>
                <select name="language" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="">Select Language</option>
                  <option value="english">üá∫üá∏ English</option>
                  <option value="spanish">üá™üá∏ Spanish</option>
                </select>
              </div>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Subject Line *</label>
                <input type="text" name="subject" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="Email subject line">
              </div>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Body *</label>
                <textarea name="body" rows="8" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; font-family: monospace; resize: vertical;" placeholder="Email content..."></textarea>
              </div>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Footer</label>
                <input type="text" name="footer" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="Email footer text">
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1rem; border-top: 2px solid #e2e8f0;">
                <button type="button" onclick="closeModal('newTemplateModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                <button type="submit" style="background: #5a5bb8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">üìù Create Template</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.submitNewTemplate = function(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const templates = JSON.parse(localStorage.getItem(DECISION_STORAGE.templates) || '{}');

      const type = formData.get('type');
      const language = formData.get('language');

      if (!templates[type]) templates[type] = {};
      templates[type][language] = {
        subject: formData.get('subject'),
        body: formData.get('body'),
        footer: formData.get('footer') || 'This is an automated message.'
      };

      localStorage.setItem(DECISION_STORAGE.templates, JSON.stringify(templates));
      closeModal('newTemplateModal');
      showDecisionTab('templates');
      showToast('New template created successfully!', 'success');
    };

    window.previewTemplate = function(type, language) {
      const templates = JSON.parse(localStorage.getItem(DECISION_STORAGE.templates) || '{}');
      const template = templates[type]?.[language];

      if (!template) {
        showToast('Template not found!', 'error');
        return;
      }

      // Create a sample decision for preview
      const sampleDecision = {
        applicantName: 'John Sample',
        applicantId: 'APP-2025-SAMPLE',
        email: 'john.sample@email.com',
        program: 'Computer Science',
        level: 'Undergraduate',
        conditions: 'Complete final transcripts and maintain GPA above 3.0',
        conditionDeadline: new Date(Date.now() + 45 * 24 * 60 * 60 * 1000).toISOString()
      };

      const processedContent = processTemplate(template, sampleDecision);

      const modal = document.createElement('div');
      modal.id = 'templatePreviewModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üëÄ Template Preview</h3>
              <button onclick="closeModal('templatePreviewModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
            <div style="margin-top: 0.5rem; opacity: 0.9;">
              ${type.charAt(0).toUpperCase() + type.slice(1)} Template (${language.toUpperCase()}) - Sample Preview
            </div>
          </div>

          <div style="padding: 2rem; max-height: 600px; overflow-y: auto;">
            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
              <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e2e8f0;">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                  <span style="font-weight: 600;">To:</span><span>${sampleDecision.email}</span>
                  <span style="font-weight: 600;">Subject:</span><span style="font-weight: 600; color: #1f2937;">${processedContent.subject}</span>
                </div>
              </div>
              <div style="line-height: 1.6; white-space: pre-line; color: #1f2937;">
                ${processedContent.body}
              </div>
              <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; font-size: 0.875rem; color: #6b7280; font-style: italic;">
                ${processedContent.footer}
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
              <button onclick="closeModal('templatePreviewModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Close</button>
              <button onclick="editTemplate('${type}', '${language}'); closeModal('templatePreviewModal');" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">‚úèÔ∏è Edit Template</button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    // Missing notification functions
    window.resendNotification = function(id) {
      if (confirm('Resend notification to this applicant?')) {
        const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
        const decision = decisions.find(d => d.id === id);

        if (decision) {
          decision.notificationDate = new Date().toISOString();
          decision.history.push({
            date: new Date().toISOString(),
            action: 'Notification resent',
            user: 'Current User'
          });

          localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
          showDecisionTab('notifications');
          showToast(`Notification resent to ${decision.applicantName}!`, 'success');
        }
      }
    };

    window.viewNotificationDetails = function(id) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === id);

      if (!decision) {
        showToast('Decision not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'notificationDetailsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 480px; max-height: 85vh; overflow-y: auto; padding: 1.5rem;">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üìß Notification Details</h3>
              <button onclick="closeModal('notificationDetailsModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
            <div style="margin-top: 0.5rem; opacity: 0.9;">
              ${decision.applicantName} (${decision.applicantId})
            </div>
          </div>

          <div style="padding: 2rem; max-height: 500px; overflow-y: auto;">
            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Notification Summary</h4>
              <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; font-size: 0.875rem;">
                <span style="font-weight: 600; color: #374151;">Status:</span>
                <span style="color: ${decision.notificationSent ? '#3b82f6' : '#ef4444'};">
                  ${decision.notificationSent ? '‚úì Sent' : '‚úó Not Sent'}
                </span>
                <span style="font-weight: 600; color: #374151;">Decision Type:</span>
                <span>${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)}</span>
                <span style="font-weight: 600; color: #374151;">Language:</span>
                <span>${decision.language.toUpperCase()}</span>
                ${decision.notificationSent ? `
                  <span style="font-weight: 600; color: #374151;">Sent Date:</span>
                  <span>${new Date(decision.notificationDate).toLocaleString()}</span>
                ` : ''}
                ${decision.scheduledRelease ? `
                  <span style="font-weight: 600; color: #374151;">Scheduled:</span>
                  <span>${new Date(decision.scheduledRelease).toLocaleString()}</span>
                ` : ''}
              </div>
            </div>

            <div style="background: #fefce8; border: 2px solid #fde047; border-radius: 12px; padding: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #92400e;">üìù Template Used</h4>
              <div style="font-size: 0.875rem; color: #a16207;">
                ${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)} template in ${decision.language}
              </div>
              <button onclick="previewNotification('${decision.id}'); closeModal('notificationDetailsModal');" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer; margin-top: 1rem;">üëÄ Preview Email</button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    // Utility functions
    window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    };

    window.showToast = function(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 35000;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        ${type === 'success' ? 'background: #3b82f6;' :
          type === 'error' ? 'background: #ef4444;' :
          type === 'warning' ? 'background: #f59e0b;' :
          'background: #3b82f6;'}
      `;
      toast.textContent = message;

      document.body.appendChild(toast);

      // Slide in
      setTimeout(() => {
        toast.style.transform = 'translateX(0)';
      }, 100);

      // Slide out and remove
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
      }, duration);
    };

    // Search and Filter functionality
    function setupSearchAndFilter() {
      const searchInput = document.getElementById('searchDecisions');
      const statusFilter = document.getElementById('filterStatus');
      const programFilter = document.getElementById('filterProgram');

      if (searchInput) {
        searchInput.addEventListener('input', filterDecisions);
      }
      if (statusFilter) {
        statusFilter.addEventListener('change', filterDecisions);
      }
      if (programFilter) {
        programFilter.addEventListener('change', filterDecisions);
      }
    }

    function filterDecisions() {
      const searchTerm = document.getElementById('searchDecisions')?.value.toLowerCase() || '';
      const statusFilter = document.getElementById('filterStatus')?.value || '';
      const programFilter = document.getElementById('filterProgram')?.value || '';

      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');

      const filteredDecisions = decisions.filter(decision => {
        const matchesSearch =
          decision.applicantName.toLowerCase().includes(searchTerm) ||
          decision.applicantId.toLowerCase().includes(searchTerm) ||
          decision.email.toLowerCase().includes(searchTerm);

        const matchesStatus = !statusFilter || decision.status === statusFilter;
        const matchesProgram = !programFilter || decision.program === programFilter;

        return matchesSearch && matchesStatus && matchesProgram;
      });

      updateDecisionsTable(filteredDecisions);
    }

    function updateDecisionsTable(decisions) {
      const content = document.getElementById('decisionContent');
      if (!content) return;

      // Find the table body and update it
      const tableHTML = decisions.map(decision => `
        <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0; display: grid; grid-template-columns: 150px 1fr 1fr 120px 120px 150px 100px; gap: 1rem; align-items: center; hover:background-color: #f9fafb;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
          <div style="font-family: monospace; font-weight: 600; color: #5a5bb8;">${decision.applicantId}</div>
          <div>
            <div style="font-weight: 600; color: #1f2937;">${decision.applicantName}</div>
            <div style="font-size: 0.875rem; color: #6b7280;">${decision.email}</div>
          </div>
          <div>
            <div style="font-weight: 500; color: #1f2937;">${decision.program}</div>
            <div style="font-size: 0.875rem; color: #6b7280;">${decision.level}</div>
          </div>
          <div>
            <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; ${getStatusStyle(decision.status)}">
              ${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)}
            </span>
          </div>
          <div style="color: #6b7280;">${new Date(decision.decisionDate).toLocaleDateString()}</div>
          <div>
            ${decision.notificationSent
              ? `<span style="color: #3b82f6; font-size: 0.875rem;">‚úì Sent</span>`
              : decision.scheduledRelease
                ? `<span style="color: #f59e0b; font-size: 0.875rem;">‚è∞ Scheduled</span>`
                : `<span style="color: #ef4444; font-size: 0.875rem;">‚úó Pending</span>`
            }
          </div>
          <div style="display: flex; gap: 0.25rem;">
            <button onclick="editDecision('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" title="Edit">‚úèÔ∏è</button>
            <button onclick="sendNotification('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" title="Send">üìß</button>
            <button onclick="viewHistory('${decision.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" title="History">üìä</button>
          </div>
        </div>
      `).join('');

      // Update the decisions tab content with filtered results
      setTimeout(() => {
        const tableContainer = content.querySelector('div[style*="grid-template-columns: 150px 1fr 1fr 120px 120px 150px 100px"]')?.parentElement;
        if (tableContainer) {
          const header = tableContainer.querySelector('div[style*="background: #f8fafc"]');
          tableContainer.innerHTML = '';
          tableContainer.appendChild(header);

          const resultsDiv = document.createElement('div');
          resultsDiv.innerHTML = tableHTML;
          tableContainer.appendChild(resultsDiv);
        }
      }, 100);
    }

    // Advanced scheduling functions
    window.scheduleNewRelease = function() {
      const modal = document.createElement('div');
      modal.id = 'scheduleReleaseModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const unscheduledDecisions = decisions.filter(d => !d.scheduledRelease && !d.notificationSent);

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">‚è∞ Schedule Release</h3>
              <button onclick="closeModal('scheduleReleaseModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
          </div>

          <div style="padding: 2rem;">
            <form id="scheduleReleaseForm" onsubmit="submitScheduleRelease(event)">
              <div style="margin-bottom: 2rem;">
                <label style="display: block; margin-bottom: 1rem; font-weight: 600; color: #374151;">Select Decisions to Schedule:</label>
                <div style="max-height: 300px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                  ${unscheduledDecisions.length === 0 ? `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                      <p>No unscheduled decisions available.</p>
                    </div>
                  ` : `
                    <div style="margin-bottom: 0.75rem;">
                      <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #5a5bb8;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="transform: scale(1.2);">
                        Select All (${unscheduledDecisions.length} decisions)
                      </label>
                    </div>
                    ${unscheduledDecisions.map(decision => `
                      <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 6px; hover:background-color: #f9fafb; margin-bottom: 0.5rem;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                        <input type="checkbox" name="selectedDecisions" value="${decision.id}" class="decision-checkbox" style="transform: scale(1.1);">
                        <div style="flex: 1;">
                          <div style="font-weight: 600; color: #1f2937;">${decision.applicantName}</div>
                          <div style="font-size: 0.875rem; color: #6b7280;">${decision.program} ‚Ä¢ ${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)}</div>
                        </div>
                      </label>
                    `).join('')}
                  `}
                </div>
              </div>

              ${unscheduledDecisions.length > 0 ? `
                <div style="margin-bottom: 2rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Release Date & Time *</label>
                  <input type="datetime-local" name="releaseDateTime" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>

                <div style="margin-bottom: 2rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Batch Notes (Optional)</label>
                  <textarea name="batchNotes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical;" placeholder="Notes about this batch release..."></textarea>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1rem; border-top: 2px solid #e2e8f0;">
                  <button type="button" onclick="closeModal('scheduleReleaseModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                  <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">‚è∞ Schedule Selected</button>
                </div>
              ` : ''}
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.toggleSelectAll = function() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.decision-checkbox');

      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
      });
    };

    window.submitScheduleRelease = function(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const selectedIds = formData.getAll('selectedDecisions');
      const releaseDateTime = formData.get('releaseDateTime');
      const batchNotes = formData.get('batchNotes');

      if (selectedIds.length === 0) {
        showToast('Please select at least one decision to schedule.', 'warning');
        return;
      }

      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');

      selectedIds.forEach(id => {
        const decision = decisions.find(d => d.id === id);
        if (decision) {
          decision.scheduledRelease = new Date(releaseDateTime).toISOString();
          decision.history.push({
            date: new Date().toISOString(),
            action: `Scheduled for batch release at ${new Date(releaseDateTime).toLocaleString()}${batchNotes ? ` - ${batchNotes}` : ''}`,
            user: 'Current User'
          });
        }
      });

      localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
      closeModal('scheduleReleaseModal');
      showDecisionTab('scheduled');
      showToast(`${selectedIds.length} decision(s) scheduled for ${new Date(releaseDateTime).toLocaleString()}!`, 'success');
    };

    window.editSchedule = function(id) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === id);

      if (!decision) {
        showToast('Decision not found!', 'error');
        return;
      }

      const currentDate = new Date(decision.scheduledRelease).toISOString().slice(0, 16);
      const newDate = prompt('Enter new scheduled release date and time:', currentDate.replace('T', ' '));

      if (newDate && newDate !== currentDate.replace('T', ' ')) {
        decision.scheduledRelease = new Date(newDate).toISOString();
        decision.history.push({
          date: new Date().toISOString(),
          action: `Schedule updated to ${new Date(newDate).toLocaleString()}`,
          user: 'Current User'
        });

        localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
        showDecisionTab('scheduled');
        showToast('Schedule updated successfully!', 'success');
      }
    };

    window.releaseNow = function(id) {
      if (confirm('Release this notification immediately?')) {
        const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
        const decision = decisions.find(d => d.id === id);

        if (decision) {
          decision.notificationSent = true;
          decision.notificationDate = new Date().toISOString();
          decision.scheduledRelease = null;
          decision.history.push({
            date: new Date().toISOString(),
            action: 'Released immediately (unscheduled)',
            user: 'Current User'
          });

          localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
          showDecisionTab('scheduled');
          showToast(`Notification released to ${decision.applicantName}!`, 'success');
        }
      }
    };

    window.cancelSchedule = function(id) {
      if (confirm('Cancel the scheduled release for this decision?')) {
        const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
        const decision = decisions.find(d => d.id === id);

        if (decision) {
          decision.scheduledRelease = null;
          decision.history.push({
            date: new Date().toISOString(),
            action: 'Scheduled release cancelled',
            user: 'Current User'
          });

          localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
          showDecisionTab('scheduled');
          showToast('Schedule cancelled successfully!', 'success');
        }
      }
    };

    // Export functionality
    window.exportHistory = function() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');

      const modal = document.createElement('div');
      modal.id = 'exportModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 450px; max-height: 85vh; overflow-y: auto; padding: 1.5rem;">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üìä Export Report</h3>
              <button onclick="closeModal('exportModal')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>
          </div>

          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Select Export Format:</h4>
              <div style="display: grid; gap: 1rem;">
                <button onclick="exportToCSV()" style="background: #3b82f6; color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                  üìä Export as CSV (Excel Compatible)
                </button>
                <button onclick="exportToJSON()" style="background: #3b82f6; color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                  üíæ Export as JSON (Data Backup)
                </button>
                <button onclick="exportToPDF()" style="background: #ef4444; color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                  üìÑ Export as PDF Report
                </button>
              </div>
            </div>

            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
              <h5 style="margin: 0 0 0.5rem 0; color: #1f2937;">Export Summary:</h5>
              <div style="font-size: 0.875rem; color: #6b7280;">
                ‚Ä¢ ${decisions.length} total decisions<br>
                ‚Ä¢ ${decisions.filter(d => d.notificationSent).length} notifications sent<br>
                ‚Ä¢ ${decisions.filter(d => d.scheduledRelease).length} scheduled releases<br>
                ‚Ä¢ Generated on ${new Date().toLocaleString()}
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.exportToCSV = function() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');

      const headers = ['Applicant ID', 'Name', 'Email', 'Program', 'Level', 'Status', 'Decision Date', 'Notification Sent', 'Notification Date', 'Scheduled Release', 'Notes', 'Decided By'];

      const csvContent = [
        headers.join(','),
        ...decisions.map(d => [
          d.applicantId,
          `"${d.applicantName}"`,
          d.email,
          `"${d.program}"`,
          d.level,
          d.status,
          d.decisionDate,
          d.notificationSent ? 'Yes' : 'No',
          d.notificationDate || '',
          d.scheduledRelease || '',
          `"${d.notes || ''}"`,
          `"${d.decidedBy}"`
        ].join(','))
      ].join('\\n');

      downloadFile(csvContent, 'admissions-decisions.csv', 'text/csv');
      closeModal('exportModal');
      showToast('CSV export downloaded successfully!', 'success');
    };

    window.exportToJSON = function() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const templates = JSON.parse(localStorage.getItem(DECISION_STORAGE.templates) || '{}');

      const exportData = {
        exportDate: new Date().toISOString(),
        summary: {
          totalDecisions: decisions.length,
          notificationsSent: decisions.filter(d => d.notificationSent).length,
          scheduledReleases: decisions.filter(d => d.scheduledRelease).length
        },
        decisions,
        templates
      };

      downloadFile(JSON.stringify(exportData, null, 2), 'admissions-data-backup.json', 'application/json');
      closeModal('exportModal');
      showToast('JSON backup downloaded successfully!', 'success');
    };

    window.exportToPDF = function() {
      closeModal('exportModal');
      showToast('PDF export feature would integrate with a PDF library like jsPDF in a production environment.', 'info', 5000);
    };

    function downloadFile(content, filename, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // Enhanced tab switching with search/filter setup
    const originalShowDecisionTab = showDecisionTab;
    showDecisionTab = function(tabName) {
      originalShowDecisionTab(tabName);

      // Setup search and filter after tab content is loaded
      setTimeout(() => {
        if (tabName === 'decisions') {
          setupSearchAndFilter();
        }
      }, 100);
    };

    // ============================================
    // ADVANCED SETTINGS FUNCTIONS
    // ============================================

    // Generate individual settings tabs
    function generateGeneralSettings() {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      const general = settings.general || {};

      return `
        <div style="padding: 1.5rem;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.2rem;">General Settings</h3>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Institution Name</label>
            <input type="text" id="institutionName" value="${general.institutionName || 'University of Excellence'}" onchange="updateSettingValue('general', 'institutionName', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Academic Year</label>
            <input type="text" id="academicYear" value="${general.academicYear || '2025-2026'}" onchange="updateSettingValue('general', 'academicYear', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Default Decision Timeline</label>
            <select id="decisionTimeline" onchange="updateSettingValue('general', 'decisionTimeline', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="30" ${general.decisionTimeline == 30 ? 'selected' : ''}>30 days</option>
              <option value="45" ${general.decisionTimeline == 45 ? 'selected' : ''}>45 days</option>
              <option value="60" ${general.decisionTimeline == 60 ? 'selected' : ''}>60 days</option>
              <option value="90" ${general.decisionTimeline == 90 ? 'selected' : ''}>90 days</option>
            </select>
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Time Zone</label>
            <select id="timeZone" onchange="updateSettingValue('general', 'timeZone', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="EST" ${general.timeZone === 'EST' ? 'selected' : ''}>Eastern (EST)</option>
              <option value="CST" ${general.timeZone === 'CST' ? 'selected' : ''}>Central (CST)</option>
              <option value="MST" ${general.timeZone === 'MST' ? 'selected' : ''}>Mountain (MST)</option>
              <option value="PST" ${general.timeZone === 'PST' ? 'selected' : ''}>Pacific (PST)</option>
            </select>
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Default Language</label>
            <select id="defaultLanguage" onchange="updateSettingValue('general', 'defaultLanguage', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="english" ${general.defaultLanguage === 'english' ? 'selected' : ''}>üá∫üá∏ English</option>
              <option value="spanish" ${general.defaultLanguage === 'spanish' ? 'selected' : ''}>üá™üá∏ Spanish</option>
              <option value="french" ${general.defaultLanguage === 'french' ? 'selected' : ''}>üá´üá∑ French</option>
            </select>
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Auto-Archive Decisions</label>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="autoArchive" ${general.autoArchive ? 'checked' : ''} onchange="updateSettingValue('general', 'autoArchive', this.checked)">
              <label for="autoArchive" style="color: #6b7280;">Automatically archive decisions after 1 year</label>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Enable Advanced Features</label>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="enableAdvancedFeatures" ${general.enableAdvancedFeatures ? 'checked' : ''} onchange="updateSettingValue('general', 'enableAdvancedFeatures', this.checked)">
              <label for="enableAdvancedFeatures" style="color: #6b7280;">Enable AI insights, predictive analytics, and advanced automation</label>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Dashboard Theme</label>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
              <div onclick="updateSettingValue('general', 'theme', 'light'); selectThemeVisual(this)" style="padding: 1rem; border: 2px solid ${general.theme === 'light' ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; text-align: center; cursor: pointer; background: #f8fafc;">
                <div style="width: 30px; height: 20px; background: linear-gradient(135deg, #ffffff, #f1f5f9); border-radius: 4px; margin: 0 auto 0.5rem;"></div>
                <span style="font-size: 0.875rem; color: #374151;">Light</span>
              </div>
              <div onclick="updateSettingValue('general', 'theme', 'dark'); selectThemeVisual(this)" style="padding: 1rem; border: 2px solid ${general.theme === 'dark' ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; text-align: center; cursor: pointer;">
                <div style="width: 30px; height: 20px; background: linear-gradient(135deg, #1f2937, #374151); border-radius: 4px; margin: 0 auto 0.5rem;"></div>
                <span style="font-size: 0.875rem; color: #374151;">Dark</span>
              </div>
              <div onclick="updateSettingValue('general', 'theme', 'auto'); selectThemeVisual(this)" style="padding: 1rem; border: 2px solid ${general.theme === 'auto' ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; text-align: center; cursor: pointer;">
                <div style="width: 30px; height: 20px; background: linear-gradient(135deg, #ffffff 50%, #1f2937 50%); border-radius: 4px; margin: 0 auto 0.5rem;"></div>
                <span style="font-size: 0.875rem; color: #374151;">Auto</span>
              </div>
            </div>
          </div>

          <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 2rem;">
            <p style="margin: 0; color: #166534; font-size: 0.875rem;">üí° Settings are automatically saved when changed. No need to click a save button!</p>
          </div>
        </div>
      `;
    }

    function generateNotificationSettings() {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      const notifications = settings.notifications || {};

      return `
        <div style="padding: 1.5rem;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.2rem;">Notification Settings</h3>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Email Notifications</h4>
            <div style="space-y: 1rem;">
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
                <div>
                  <div style="font-weight: 600; color: #374151;">New Applications</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Notify when new applications are submitted</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                  <input type="checkbox" ${notifications.newApplications ? 'checked' : ''} onchange="updateSettingValue('notifications', 'newApplications', this.checked)" style="opacity: 0; width: 0; height: 0;">
                  <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${notifications.newApplications ? '#3b82f6' : '#9ca3af'}; border-radius: 24px; transition: 0.4s;"></span>
                </label>
              </div>

              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
                <div>
                  <div style="font-weight: 600; color: #374151;">Decision Updates</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Notify when decisions are made or updated</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                  <input type="checkbox" ${notifications.decisionUpdates ? 'checked' : ''} onchange="updateSettingValue('notifications', 'decisionUpdates', this.checked)" style="opacity: 0; width: 0; height: 0;">
                  <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${notifications.decisionUpdates ? '#3b82f6' : '#9ca3af'}; border-radius: 24px; transition: 0.4s;"></span>
                </label>
              </div>

              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
                <div>
                  <div style="font-weight: 600; color: #374151;">Deadline Reminders</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Notify about approaching deadlines</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                  <input type="checkbox" ${notifications.deadlineReminders ? 'checked' : ''} onchange="updateSettingValue('notifications', 'deadlineReminders', this.checked)" style="opacity: 0; width: 0; height: 0;">
                  <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${notifications.deadlineReminders ? '#3b82f6' : '#9ca3af'}; border-radius: 24px; transition: 0.4s;"></span>
                </label>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Notification Frequency</h4>
            <select onchange="updateSettingValue('notifications', 'frequency', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="immediate" ${notifications.frequency === 'immediate' ? 'selected' : ''}>Immediate</option>
              <option value="daily" ${notifications.frequency === 'daily' ? 'selected' : ''}>Daily Digest</option>
              <option value="weekly" ${notifications.frequency === 'weekly' ? 'selected' : ''}>Weekly Summary</option>
            </select>
          </div>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Notification Recipients</h4>
            <textarea placeholder="Enter email addresses separated by commas" onchange="updateSettingValue('notifications', 'recipients', this.value)" style="width: 100%; height: 100px; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${notifications.recipients || 'admin@university.edu, admissions@university.edu'}</textarea>
          </div>

          <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 2rem;">
            <p style="margin: 0; color: #166534; font-size: 0.875rem;">üí° Notification settings are saved automatically when changed.</p>
          </div>
        </div>
      `;
    }

    function generateSecuritySettings() {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      const security = settings.security || {};

      return `
        <div style="padding: 1.5rem;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.2rem;">Security Settings</h3>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Access Control</h4>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Session Timeout</label>
              <select onchange="updateSettingValue('security', 'sessionTimeout', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="30" ${security.sessionTimeout == 30 ? 'selected' : ''}>30 minutes</option>
                <option value="60" ${security.sessionTimeout == 60 ? 'selected' : ''}>1 hour</option>
                <option value="120" ${security.sessionTimeout == 120 ? 'selected' : ''}>2 hours</option>
                <option value="480" ${security.sessionTimeout == 480 ? 'selected' : ''}>8 hours</option>
              </select>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="checkbox" id="requireMFA" ${security.requireMFA ? 'checked' : ''} onchange="updateSettingValue('security', 'requireMFA', this.checked)">
              <label for="requireMFA" style="color: #374151; font-weight: 600;">Require Multi-Factor Authentication</label>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="auditLog" ${security.auditLog ? 'checked' : ''} onchange="updateSettingValue('security', 'auditLog', this.checked)">
              <label for="auditLog" style="color: #374151; font-weight: 600;">Enable Audit Logging</label>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Data Protection</h4>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Data Retention Period</label>
              <select style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="1">1 year</option>
                <option value="3">3 years</option>
                <option value="5" selected>5 years</option>
                <option value="7">7 years</option>
                <option value="permanent">Permanent</option>
              </select>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="checkbox" id="encryptData" checked>
              <label for="encryptData" style="color: #374151; font-weight: 600;">Encrypt Sensitive Data</label>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="backupData" checked>
              <label for="backupData" style="color: #374151; font-weight: 600;">Automatic Data Backup</label>
            </div>
          </div>

          <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #dc2626; font-size: 0.9rem;">Security Notice</h4>
            <p style="margin: 0; color: #dc2626; font-size: 0.8rem;">Changes to security settings may require administrator approval and could affect user access.</p>
          </div>

          <button onclick="saveSecuritySettings()" style="background: #dc2626; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Update Security Settings</button>
        </div>
      `;
    }

    function generateAutomationSettings() {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      const automation = settings.automation || {};

      return `
        <div style="padding: 1.5rem;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.2rem;">Automation Settings</h3>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Workflow Automation</h4>
            <div style="margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f0f9ff; border-radius: 8px; margin-bottom: 1rem;">
                <div>
                  <div style="font-weight: 600; color: #374151;">Auto-Route Applications</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Automatically route applications based on program type</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                  <input type="checkbox" ${automation.autoRoute ? 'checked' : ''} onchange="updateSettingValue('automation', 'autoRoute', this.checked)" style="opacity: 0; width: 0; height: 0;">
                  <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${automation.autoRoute ? '#3b82f6' : '#9ca3af'}; border-radius: 24px; transition: 0.4s;"></span>
                </label>
              </div>

              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f0f9ff; border-radius: 8px; margin-bottom: 1rem;">
                <div>
                  <div style="font-weight: 600; color: #374151;">Auto-Send Acknowledgments</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Send confirmation emails when applications are received</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                  <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                  <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #3b82f6; border-radius: 24px; transition: 0.4s;"></span>
                </label>
              </div>

              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f0f9ff; border-radius: 8px;">
                <div>
                  <div style="font-weight: 600; color: #374151;">Smart Prioritization</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Use AI to prioritize applications based on criteria</div>
                </div>
                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                  <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                  <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #9ca3af; border-radius: 24px; transition: 0.4s;"></span>
                </label>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Decision Automation</h4>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Auto-Decision Threshold</label>
              <select style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="disabled" selected>Disabled</option>
                <option value="90">90% confidence</option>
                <option value="95">95% confidence</option>
                <option value="99">99% confidence</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Review Period Before Auto-Decision</label>
              <select style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="7">7 days</option>
                <option value="14" selected>14 days</option>
                <option value="30">30 days</option>
              </select>
            </div>
          </div>

          <div style="background: #fffbeb; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #d97706; font-size: 0.9rem;">Automation Guidelines</h4>
            <p style="margin: 0; color: #d97706; font-size: 0.8rem;">Automated decisions still require human oversight. Critical applications will always be flagged for manual review.</p>
          </div>

          <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
            <p style="margin: 0; color: #166534; font-size: 0.875rem;">üí° Automation settings are saved automatically when changed.</p>
          </div>
        </div>
      `;
    }

    function generateIntegrationSettings() {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      const integration = settings.integration || {};

      return `
        <div style="padding: 1.5rem;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.2rem;">Integration Settings</h3>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">External Systems</h4>
            <div style="space-y: 1rem;">
              <div style="padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                  <h5 style="margin: 0; color: #374151; font-weight: 600;">Student Information System (SIS)</h5>
                  <span id="sisStatus" style="background: ${integration.sisConnected ? '#dcfce7' : '#fee2e2'}; color: ${integration.sisConnected ? '#166534' : '#991b1b'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${integration.sisConnected ? 'Connected' : 'Disconnected'}</span>
                </div>
                <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">Sync student data and enrollment information</p>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="testSISConnection()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Test Connection</button>
                  <button onclick="configureSIS()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Configure</button>
                </div>
              </div>

              <div style="padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                  <h5 style="margin: 0; color: #374151; font-weight: 600;">Email Service</h5>
                  <span id="emailStatus" style="background: ${integration.emailConnected ? '#dcfce7' : integration.emailPending ? '#fef3c7' : '#fee2e2'}; color: ${integration.emailConnected ? '#166534' : integration.emailPending ? '#92400e' : '#991b1b'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${integration.emailConnected ? 'Connected' : integration.emailPending ? 'Pending' : 'Disconnected'}</span>
                </div>
                <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">Send automated emails and notifications</p>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="setupEmailService()" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Setup</button>
                  <button onclick="testEmailService()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Test</button>
                </div>
              </div>

              <div style="padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                  <h5 style="margin: 0; color: #374151; font-weight: 600;">Document Management</h5>
                  <span id="docStatus" style="background: ${integration.documentsConnected ? '#dcfce7' : '#fee2e2'}; color: ${integration.documentsConnected ? '#166534' : '#991b1b'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${integration.documentsConnected ? 'Connected' : 'Disconnected'}</span>
                </div>
                <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">Store and manage application documents</p>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="connectDocumentSystem()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Connect</button>
                  <button onclick="configureDocumentSystem()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Configure</button>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">API Configuration</h4>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">API Rate Limit</label>
              <select onchange="updateSettingValue('integration', 'apiRateLimit', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="100" ${integration.apiRateLimit == 100 ? 'selected' : ''}>100 requests/minute</option>
                <option value="500" ${integration.apiRateLimit == 500 ? 'selected' : ''}>500 requests/minute</option>
                <option value="1000" ${integration.apiRateLimit == 1000 ? 'selected' : ''}>1000 requests/minute</option>
                <option value="unlimited" ${integration.apiRateLimit == 'unlimited' ? 'selected' : ''}>Unlimited</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">API Key Management</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;" readonly>
                <button onclick="regenerateAPIKey()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Regenerate</button>
                <button onclick="copyAPIKey()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Copy</button>
              </div>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="checkbox" id="enableWebhooks" ${integration.enableWebhooks ? 'checked' : ''} onchange="updateSettingValue('integration', 'enableWebhooks', this.checked)">
              <label for="enableWebhooks" style="color: #374151; font-weight: 600;">Enable Webhook Notifications</label>
            </div>

            <div style="display: flex; gap: 0.5rem;">
              <button onclick="testAPIConnection()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Test API</button>
              <button onclick="viewAPILogs()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">View Logs</button>
            </div>
          </div>

          <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
            <p style="margin: 0; color: #166534; font-size: 0.875rem;">üí° Integration settings are saved automatically when changed.</p>
          </div>
        </div>
      `;
    }

    function generateAdvancedSettings() {
      return `
        <div style="padding: 1.5rem;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.2rem;">Advanced Settings</h3>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Performance Optimization</h4>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Cache Duration</label>
              <select style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="5">5 minutes</option>
                <option value="15" selected>15 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Data Sync Frequency</label>
              <select style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="realtime">Real-time</option>
                <option value="5min" selected>Every 5 minutes</option>
                <option value="15min">Every 15 minutes</option>
                <option value="1hour">Every hour</option>
              </select>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="enableCompression" checked>
              <label for="enableCompression" style="color: #374151; font-weight: 600;">Enable Data Compression</label>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Development & Debug</h4>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Log Level</label>
              <select style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="error" selected>Error Only</option>
                <option value="warning">Warning & Error</option>
                <option value="info">Info, Warning & Error</option>
                <option value="debug">All (Debug Mode)</option>
              </select>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="checkbox" id="enableDebugMode">
              <label for="enableDebugMode" style="color: #374151; font-weight: 600;">Enable Debug Mode</label>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="enablePerformanceMetrics">
              <label for="enablePerformanceMetrics" style="color: #374151; font-weight: 600;">Collect Performance Metrics</label>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">System Maintenance</h4>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button onclick="clearCache()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; cursor: pointer;">Clear Cache</button>
              <button onclick="optimizeDatabase()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; cursor: pointer;">Optimize Database</button>
              <button onclick="generateReport()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; cursor: pointer;">Generate System Report</button>
              <button onclick="exportData()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; cursor: pointer;">Export All Data</button>
            </div>
          </div>

          <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #dc2626; font-size: 0.9rem;">‚ö†Ô∏è Advanced Settings Warning</h4>
            <p style="margin: 0; color: #dc2626; font-size: 0.8rem;">These settings affect core system functionality. Changes should only be made by experienced administrators.</p>
          </div>

          <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
            <p style="margin: 0; color: #166534; font-size: 0.875rem;">üí° Advanced settings are saved automatically when changed.</p>
          </div>
        </div>
      `;
    }

    // Settings tab management
    function setupSettingsTabs() {
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Update tab appearance
          document.querySelectorAll('.settings-tab').forEach(t => {
            t.classList.remove('active');
            t.style.background = '#f8fafc';
            t.style.borderBottom = '3px solid transparent';
            t.style.color = '#6b7280';
            t.style.fontWeight = '500';
          });

          this.classList.add('active');
          this.style.background = 'white';
          this.style.borderBottom = '3px solid #5a5bb8';
          this.style.color = '#5a5bb8';
          this.style.fontWeight = '600';

          const tabId = this.dataset.setting;  // Fixed: was dataset.tab, now dataset.setting
          document.getElementById('settingsContent').innerHTML = getSettingsContent(tabId);
        });
      });
    }

    function getSettingsContent(tabId) {
      switch(tabId) {
        case 'general': return generateGeneralSettings();
        case 'notifications': return generateNotificationSettings();
        case 'security': return generateSecuritySettings();
        case 'automation': return generateAutomationSettings();
        case 'integration': return generateIntegrationSettings();
        case 'advanced': return generateAdvancedSettings();
        default: return generateGeneralSettings();
      }
    }

    // Settings management functions
    function updateSetting(category, key, value) {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      if (!settings[category]) settings[category] = {};
      settings[category][key] = value;
      localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(settings));
      showNotification(`Setting updated: ${key}`);
    }

    // Individual settings save functions
    function saveGeneralSettings() {
      updateSetting('general', 'institutionName', document.querySelector('input[value="University of Excellence"]').value);
      showNotification('General settings saved successfully!');
    }

    function saveNotificationSettings() {
      updateSetting('notifications', 'emailEnabled', true);
      showNotification('Notification settings saved successfully!');
    }

    function saveSecuritySettings() {
      updateSetting('security', 'sessionTimeout', 60);
      showNotification('Security settings updated successfully!');
    }

    function saveAutomationSettings() {
      updateSetting('automation', 'autoRoute', true);
      showNotification('Automation settings configured successfully!');
    }

    function saveIntegrationSettings() {
      updateSetting('integration', 'sisEnabled', true);
      showNotification('Integration settings saved successfully!');
    }

    function saveAdvancedSettings() {
      updateSetting('advanced', 'cacheEnabled', true);
      showNotification('Advanced settings applied successfully!');
    }

    // System maintenance functions
    function clearCache() {
      if (confirm('Are you sure you want to clear the system cache?')) {
        localStorage.removeItem('decision_cache');
        showNotification('System cache cleared successfully!');
      }
    }

    function optimizeDatabase() {
      showNotification('Database optimization started... This may take a few minutes.');
      setTimeout(() => {
        showNotification('Database optimization completed successfully!');
      }, 3000);
    }

    function generateReport() {
      showNotification('Generating system report... Download will start shortly.');
      setTimeout(() => {
        showNotification('System report generated and downloaded successfully!');
      }, 2000);
    }

    function exportData() {
      const data = {
        decisions: JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]'),
        templates: JSON.parse(localStorage.getItem(DECISION_STORAGE.templates) || '[]'),
        settings: JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}')
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `admissions-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('Data export completed successfully!');
    }

    // ============================================
    // ENROLLMENT MANAGEMENT SYSTEM
    // ============================================

    // Storage keys for enrollment system
    const ENROLLMENT_STORAGE = {
      applicants: 'enrollment_applicants',
      waitlists: 'enrollment_waitlists',
      programs: 'enrollment_programs',
      deposits: 'enrollment_deposits',
      settings: 'enrollment_settings'
    };

    window.openEnrollmentManagement = function() {
      // Initialize enrollment data
      initializeEnrollmentData();

      const modal = document.createElement('div');
      modal.id = 'enrollmentManagementModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 95vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 2rem; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="closeEnrollmentSystem()" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                  <svg width="16" height="16" fill="white" style="margin-right: 0.25rem;">
                    <path d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                  </svg>
                  Back to Admissions
                </button>
                <div>
                  <h2 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Enrollment Management & Waitlist</h2>
                  <p style="margin: 0.5rem 0 0 0; font-size: 1rem; opacity: 0.9;">Manage admitted applicants, track confirmations, and handle waitlists</p>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="toggleEnrollmentFullscreen()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                  <span id="enrollmentFullscreenIcon">‚õ∂</span>
                  <span id="enrollmentFullscreenText">Fullscreen</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Navigation Tabs -->
          <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-bottom: 1px solid rgba(59, 130, 246, 0.2); padding: 0 2rem; box-shadow: 0 1px 3px rgba(59, 130, 246, 0.1);">
            <div style="display: flex; gap: 2rem;">
              <button class="enrollment-tab active" data-tab="offers" onclick="showEnrollmentTab('offers')" style="background: white; color: #3b82f6; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid #3b82f6; font-weight: 600; cursor: pointer; border-radius: 8px 8px 0 0; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);">
                üìä Offer Tracking
              </button>
              <button class="enrollment-tab" data-tab="waitlist" onclick="showEnrollmentTab('waitlist')" style="background: rgba(59, 130, 246, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üìã Waitlist Management
              </button>
              <button class="enrollment-tab" data-tab="capacity" onclick="showEnrollmentTab('capacity')" style="background: rgba(59, 130, 246, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üìà Capacity & Yield
              </button>
              <button class="enrollment-tab" data-tab="deposits" onclick="showEnrollmentTab('deposits')" style="background: rgba(59, 130, 246, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üí∞ Deposits
              </button>
              <button class="enrollment-tab" data-tab="reports" onclick="showEnrollmentTab('reports')" style="background: rgba(59, 130, 246, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üìã Reports
              </button>
            </div>
          </div>

          <!-- Dynamic Content -->
          <div id="enrollmentContent" style="flex: 1; overflow-y: auto; padding: 0;">
            <!-- Dynamic content will be loaded here -->
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      setupEnrollmentTabs();
      showEnrollmentTab('offers');
    };

    function initializeEnrollmentData() {
      // Initialize sample applicant data if none exists
      if (!localStorage.getItem(ENROLLMENT_STORAGE.applicants)) {
        const sampleApplicants = [
          {
            id: 'ENR001',
            name: 'Sarah Johnson',
            email: 'sarah.johnson@email.com',
            program: 'Computer Science - BS',
            status: 'admitted',
            offerDate: '2024-03-15',
            responseDeadline: '2024-05-01',
            currentStatus: 'pending',
            gpa: 3.8,
            testScores: 'SAT: 1450',
            priority: 'high'
          },
          {
            id: 'ENR002',
            name: 'Michael Chen',
            email: 'michael.chen@email.com',
            program: 'Engineering - BS',
            status: 'admitted',
            offerDate: '2024-03-18',
            responseDeadline: '2024-05-01',
            currentStatus: 'confirmed',
            depositAmount: 500,
            depositDate: '2024-03-25',
            gpa: 3.9,
            testScores: 'SAT: 1520'
          },
          {
            id: 'ENR003',
            name: 'Emma Rodriguez',
            email: 'emma.rodriguez@email.com',
            program: 'Business Administration - BS',
            status: 'admitted',
            offerDate: '2024-03-20',
            responseDeadline: '2024-05-01',
            currentStatus: 'declined',
            declineReason: 'Accepted elsewhere',
            gpa: 3.7,
            testScores: 'ACT: 32'
          },
          {
            id: 'ENR004',
            name: 'David Park',
            email: 'david.park@email.com',
            program: 'Computer Science - BS',
            status: 'waitlisted',
            waitlistRank: 1,
            applicationDate: '2024-01-15',
            gpa: 3.6,
            testScores: 'SAT: 1380',
            priority: 'high'
          },
          {
            id: 'ENR005',
            name: 'Lisa Thompson',
            email: 'lisa.thompson@email.com',
            program: 'Engineering - BS',
            status: 'waitlisted',
            waitlistRank: 3,
            applicationDate: '2024-01-20',
            gpa: 3.5,
            testScores: 'ACT: 29'
          }
        ];
        localStorage.setItem(ENROLLMENT_STORAGE.applicants, JSON.stringify(sampleApplicants));
      }

      // Initialize program capacity data
      if (!localStorage.getItem(ENROLLMENT_STORAGE.programs)) {
        const programData = [
          {
            id: 'CS-BS-001',
            name: 'Computer Science - BS',
            degree: 'Bachelor of Science',
            department: 'Computer Science',
            capacity: 120,
            lastModified: new Date().toISOString()
          },
          {
            id: 'ENG-BS-001',
            name: 'Engineering - BS',
            degree: 'Bachelor of Science',
            department: 'Engineering',
            capacity: 100,
            lastModified: new Date().toISOString()
          },
          {
            id: 'BUS-BS-001',
            name: 'Business Administration - BS',
            degree: 'Bachelor of Science',
            department: 'Business',
            capacity: 200,
            lastModified: new Date().toISOString()
          }
        ];
        localStorage.setItem(ENROLLMENT_STORAGE.programs, JSON.stringify(programData));
      }

      // Initialize waitlist data
      if (!localStorage.getItem(ENROLLMENT_STORAGE.waitlists)) {
        const waitlistData = [
          {
            id: 'WL-CS-001',
            program: 'Computer Science - BS',
            capacity: 120,
            avgWaitDays: 45,
            promotionsThisMonth: 3,
            applicants: [
              {
                id: 'ENR004',
                name: 'David Park',
                email: 'david.park@email.com',
                waitDate: '2024-01-15',
                priorityScore: 85,
                gpa: 3.6,
                testScores: 'SAT: 1380'
              },
              {
                id: 'WL-006',
                name: 'Jennifer Liu',
                email: 'jennifer.liu@email.com',
                waitDate: '2024-01-22',
                priorityScore: 82,
                gpa: 3.5,
                testScores: 'SAT: 1350'
              },
              {
                id: 'WL-007',
                name: 'Ryan O\'Connor',
                email: 'ryan.oconnor@email.com',
                waitDate: '2024-02-01',
                priorityScore: 78,
                gpa: 3.4,
                testScores: 'ACT: 28'
              }
            ]
          },
          {
            id: 'WL-ENG-001',
            program: 'Engineering - BS',
            capacity: 100,
            avgWaitDays: 38,
            promotionsThisMonth: 2,
            applicants: [
              {
                id: 'ENR005',
                name: 'Lisa Thompson',
                email: 'lisa.thompson@email.com',
                waitDate: '2024-01-20',
                priorityScore: 80,
                gpa: 3.5,
                testScores: 'ACT: 29'
              },
              {
                id: 'WL-008',
                name: 'Alex Martinez',
                email: 'alex.martinez@email.com',
                waitDate: '2024-02-05',
                priorityScore: 75,
                gpa: 3.3,
                testScores: 'SAT: 1320'
              }
            ]
          },
          {
            id: 'WL-BUS-001',
            program: 'Business Administration - BS',
            capacity: 200,
            avgWaitDays: 52,
            promotionsThisMonth: 5,
            applicants: [
              {
                id: 'WL-009',
                name: 'Sophie Williams',
                email: 'sophie.williams@email.com',
                waitDate: '2024-01-18',
                priorityScore: 77,
                gpa: 3.4,
                testScores: 'ACT: 30'
              },
              {
                id: 'WL-010',
                name: 'Marcus Johnson',
                email: 'marcus.johnson@email.com',
                waitDate: '2024-01-25',
                priorityScore: 74,
                gpa: 3.2,
                testScores: 'SAT: 1290'
              },
              {
                id: 'WL-011',
                name: 'Isabella Garcia',
                email: 'isabella.garcia@email.com',
                waitDate: '2024-02-08',
                priorityScore: 72,
                gpa: 3.1,
                testScores: 'ACT: 27'
              }
            ]
          }
        ];
        localStorage.setItem(ENROLLMENT_STORAGE.waitlists, JSON.stringify(waitlistData));
      }
    }

    // Enrollment system core functions
    function setupEnrollmentTabs() {
      const tabs = document.querySelectorAll('.enrollment-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.getAttribute('data-tab');
          showEnrollmentTab(tabName);
        });
      });
    }

    function showEnrollmentTab(tabName) {
      const content = document.getElementById('enrollmentContent');
      const tabs = document.querySelectorAll('.enrollment-tab');

      // Update tab appearance
      tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = 'rgba(59, 130, 246, 0.05)';
        tab.style.borderBottom = '3px solid transparent';
        tab.style.color = '#64748b';
        tab.style.fontWeight = '500';
        tab.style.boxShadow = 'none';
      });

      const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.background = 'white';
        activeTab.style.borderBottom = '3px solid #3b82f6';
        activeTab.style.color = '#3b82f6';
        activeTab.style.fontWeight = '600';
        activeTab.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.1)';
      }

      // Load content based on tab
      switch (tabName) {
        case 'offers':
          content.innerHTML = generateOfferTrackingTab();
          break;
        case 'waitlist':
          content.innerHTML = generateWaitlistTab();
          break;
        case 'capacity':
          content.innerHTML = generateCapacityTab();
          break;
        case 'deposits':
          content.innerHTML = generateDepositsTab();
          break;
        case 'reports':
          content.innerHTML = generateReportsTab();
          break;
        default:
          content.innerHTML = generateOfferTrackingTab();
      }
    }

    function generateOfferTrackingTab() {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const admittedApplicants = applicants.filter(a => a.status === 'admitted');

      const statusCounts = {
        pending: admittedApplicants.filter(a => a.currentStatus === 'pending').length,
        confirmed: admittedApplicants.filter(a => a.currentStatus === 'confirmed').length,
        declined: admittedApplicants.filter(a => a.currentStatus === 'declined').length,
        deferred: admittedApplicants.filter(a => a.currentStatus === 'deferred').length
      };

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Offer Tracking Dashboard</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="sendOfferReminders()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üìß Send Reminders</button>
              <button onclick="bulkStatusUpdate()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üîÑ Bulk Update</button>
            </div>
          </div>

          <!-- Status Overview Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: #fef3c7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #f59e0b;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #92400e; font-size: 1.1rem;">Pending Responses</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #92400e;">${statusCounts.pending}</p>
                </div>
                <div style="font-size: 2rem;">‚è≥</div>
              </div>
            </div>

            <div style="background: #dcfce7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #166534; font-size: 1.1rem;">Confirmed</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #166534;">${statusCounts.confirmed}</p>
                </div>
                <div style="font-size: 2rem;">‚úÖ</div>
              </div>
            </div>

            <div style="background: #fee2e2; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #ef4444;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #991b1b; font-size: 1.1rem;">Declined</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #991b1b;">${statusCounts.declined}</p>
                </div>
                <div style="font-size: 2rem;">‚ùå</div>
              </div>
            </div>

            <div style="background: #e0e7ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #6366f1;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #4338ca; font-size: 1.1rem;">Deferred</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #4338ca;">${statusCounts.deferred}</p>
                </div>
                <div style="font-size: 2rem;">üìÖ</div>
              </div>
            </div>
          </div>

          <!-- Applicants Table -->
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <div style="background: #f9fafb; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
              <h4 style="margin: 0; color: #374151; font-size: 1.2rem;">Admitted Applicants (${admittedApplicants.length})</h4>
            </div>

            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Applicant</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Program</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Offer Date</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Deadline</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Status</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${admittedApplicants.map(applicant => `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                      <td style="padding: 1rem;">
                        <div>
                          <div style="font-weight: 600; color: #111827;">${applicant.name}</div>
                          <div style="font-size: 0.875rem; color: #6b7280;">${applicant.email}</div>
                          <div style="font-size: 0.875rem; color: #6b7280;">GPA: ${applicant.gpa} | ${applicant.testScores}</div>
                        </div>
                      </td>
                      <td style="padding: 1rem; color: #374151;">${applicant.program}</td>
                      <td style="padding: 1rem; color: #374151;">${new Date(applicant.offerDate).toLocaleDateString()}</td>
                      <td style="padding: 1rem;">
                        <span style="color: ${new Date(applicant.responseDeadline) < new Date() ? '#dc2626' : '#374151'};">
                          ${new Date(applicant.responseDeadline).toLocaleDateString()}
                        </span>
                      </td>
                      <td style="padding: 1rem;">
                        ${getStatusBadge(applicant.currentStatus)}
                      </td>
                      <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                          <button onclick="updateApplicantStatus('${applicant.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Update</button>
                          <button onclick="sendIndividualReminder('${applicant.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Remind</button>
                          <button onclick="viewApplicantDetails('${applicant.id}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Details</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function getStatusBadge(status) {
      const badges = {
        pending: '<span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">‚è≥ Pending</span>',
        confirmed: '<span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">‚úÖ Confirmed</span>',
        declined: '<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">‚ùå Declined</span>',
        deferred: '<span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">üìÖ Deferred</span>'
      };
      return badges[status] || badges.pending;
    }

    function generateWaitlistTab() {
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const programs = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.programs) || '[]');

      // Calculate waitlist statistics
      const totalWaitlisted = waitlists.reduce((sum, w) => sum + w.applicants.length, 0);
      const avgWaitTime = waitlists.length > 0 ? Math.round(waitlists.reduce((sum, w) => sum + (w.avgWaitDays || 0), 0) / waitlists.length) : 0;
      const promotionsThisMonth = waitlists.reduce((sum, w) => sum + (w.promotionsThisMonth || 0), 0);

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Waitlist Management</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="bulkPromoteWaitlist()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üìà Bulk Promote</button>
              <button onclick="reorderWaitlists()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üîÑ Reorder Lists</button>
            </div>
          </div>

          <!-- Waitlist Overview Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: #fef3c7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #f59e0b;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #92400e; font-size: 1.1rem;">Total Waitlisted</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #92400e;">${totalWaitlisted}</p>
                </div>
                <div style="font-size: 2rem;">üìã</div>
              </div>
            </div>

            <div style="background: #e0e7ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #6366f1;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #4338ca; font-size: 1.1rem;">Avg Wait Time</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #4338ca;">${avgWaitTime} days</p>
                </div>
                <div style="font-size: 2rem;">‚è±Ô∏è</div>
              </div>
            </div>

            <div style="background: #dcfce7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #166534; font-size: 1.1rem;">Promotions This Month</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #166534;">${promotionsThisMonth}</p>
                </div>
                <div style="font-size: 2rem;">üìà</div>
              </div>
            </div>
          </div>

          <!-- Waitlist by Program -->
          <div style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem;">
              <h4 style="margin: 0; font-size: 1.2rem;">Waitlists by Program</h4>
            </div>

            <div style="padding: 1.5rem;">
              ${waitlists.length === 0 ? `
                <div style="text-align: center; padding: 3rem; color: #6b7280;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                  <p style="margin: 0; font-size: 1.1rem;">No waitlists available</p>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">Waitlists will appear here when applicants are added</p>
                </div>
              ` : waitlists.map(waitlist => `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1.5rem; overflow: hidden;">
                  <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h5 style="margin: 0 0 0.25rem 0; color: #1f2937; font-size: 1.1rem;">${waitlist.program}</h5>
                      <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">${waitlist.applicants.length} applicants ‚Ä¢ Capacity: ${waitlist.capacity || 'N/A'}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                      <button onclick="manageWaitlistRanking('${waitlist.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Manage Ranking</button>
                      <button onclick="autoPromoteFromWaitlist('${waitlist.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Auto-Promote</button>
                    </div>
                  </div>

                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead style="background: #f9fafb;">
                        <tr>
                          <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Rank</th>
                          <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Name</th>
                          <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Wait Date</th>
                          <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Priority Score</th>
                          <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${waitlist.applicants.map((applicant, index) => `
                          <tr style="border-bottom: 1px solid #f3f4f6;">
                            <td style="padding: 1rem 0.75rem;">
                              <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="background: ${index < 5 ? '#fef3c7' : '#f3f4f6'}; color: ${index < 5 ? '#92400e' : '#6b7280'}; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 600; font-size: 0.875rem;">#${index + 1}</span>
                                ${index < 5 ? '<span style="color: #f59e0b;">‚≠ê</span>' : ''}
                              </div>
                            </td>
                            <td style="padding: 1rem 0.75rem;">
                              <div>
                                <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.name}</p>
                                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${applicant.email}</p>
                              </div>
                            </td>
                            <td style="padding: 1rem 0.75rem;">
                              <span style="color: #6b7280; font-size: 0.875rem;">${new Date(applicant.waitDate).toLocaleDateString()}</span>
                            </td>
                            <td style="padding: 1rem 0.75rem;">
                              <span style="background: #e0f2fe; color: #0369a1; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">${applicant.priorityScore || 'N/A'}</span>
                            </td>
                            <td style="padding: 1rem 0.75rem;">
                              <div style="display: flex; gap: 0.5rem;">
                                <button onclick="promoteApplicant('${waitlist.id}', '${applicant.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Promote</button>
                                <button onclick="editWaitlistRank('${waitlist.id}', '${applicant.id}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Edit Rank</button>
                              </div>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function generateCapacityTab() {
      const programs = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.programs) || '[]');
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');

      // Calculate program statistics
      const programStats = programs.map(program => {
        const programApplicants = applicants.filter(a => a.program === program.name);
        const admittedCount = programApplicants.filter(a => a.status === 'admitted').length;
        const confirmedCount = programApplicants.filter(a => a.currentStatus === 'confirmed').length;
        const waitlistCount = waitlists.find(w => w.program === program.name)?.applicants.length || 0;
        const yieldRate = admittedCount > 0 ? Math.round((confirmedCount / admittedCount) * 100) : 0;
        const capacityUsed = Math.round((confirmedCount / program.capacity) * 100);

        return {
          ...program,
          admittedCount,
          confirmedCount,
          waitlistCount,
          yieldRate,
          capacityUsed,
          remainingSpots: Math.max(0, program.capacity - confirmedCount)
        };
      });

      const totalCapacity = programs.reduce((sum, p) => sum + p.capacity, 0);
      const totalConfirmed = programStats.reduce((sum, p) => sum + p.confirmedCount, 0);
      const overallYield = programStats.length > 0 ? Math.round(programStats.reduce((sum, p) => sum + p.yieldRate, 0) / programStats.length) : 0;

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Capacity & Yield Tracking</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="exportCapacityReport()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üìä Export Report</button>
              <button onclick="updateCapacities()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">‚öôÔ∏è Update Capacities</button>
            </div>
          </div>

          <!-- Overall Statistics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: #dbeafe; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #1d4ed8; font-size: 1.1rem;">Total Capacity</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #1d4ed8;">${totalCapacity}</p>
                </div>
                <div style="font-size: 2rem;">üéØ</div>
              </div>
            </div>

            <div style="background: #dcfce7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #166534; font-size: 1.1rem;">Confirmed Enrollments</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #166534;">${totalConfirmed}</p>
                </div>
                <div style="font-size: 2rem;">‚úÖ</div>
              </div>
            </div>

            <div style="background: #f3e8ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #2563eb;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #7c2d12; font-size: 1.1rem;">Overall Yield Rate</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #7c2d12;">${overallYield}%</p>
                </div>
                <div style="font-size: 2rem;">üìà</div>
              </div>
            </div>
          </div>

          <!-- Program Details -->
          <div style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem;">
              <h4 style="margin: 0; font-size: 1.2rem;">Program Capacity Analysis</h4>
            </div>

            <div style="padding: 1.5rem;">
              ${programStats.length === 0 ? `
                <div style="text-align: center; padding: 3rem; color: #6b7280;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                  <p style="margin: 0; font-size: 1.1rem;">No programs configured</p>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">Add programs to see capacity tracking</p>
                </div>
              ` : `
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f9fafb;">
                      <tr>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Program</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Capacity</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Confirmed</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Remaining</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Waitlisted</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Yield Rate</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Capacity Used</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${programStats.map((program, index) => `
                        <tr style="border-bottom: 1px solid #f3f4f6;">
                          <td style="padding: 1rem 0.75rem;">
                            <div>
                              <p style="margin: 0; font-weight: 600; color: #1f2937;">${program.name}</p>
                              <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${program.degree}</p>
                            </div>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <span style="background: #dbeafe; color: #1d4ed8; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">${program.capacity}</span>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">${program.confirmedCount}</span>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <span style="background: ${program.remainingSpots > 10 ? '#dcfce7' : program.remainingSpots > 0 ? '#fef3c7' : '#fee2e2'}; color: ${program.remainingSpots > 10 ? '#166534' : program.remainingSpots > 0 ? '#92400e' : '#991b1b'}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">${program.remainingSpots}</span>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <span style="background: #f3e8ff; color: #7c2d12; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">${program.waitlistCount}</span>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <span style="background: ${program.yieldRate > 70 ? '#dcfce7' : program.yieldRate > 40 ? '#fef3c7' : '#fee2e2'}; color: ${program.yieldRate > 70 ? '#166534' : program.yieldRate > 40 ? '#92400e' : '#991b1b'}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">${program.yieldRate}%</span>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                              <div style="background: #f3f4f6; border-radius: 8px; height: 8px; width: 60px; overflow: hidden;">
                                <div style="background: ${program.capacityUsed > 90 ? '#ef4444' : program.capacityUsed > 70 ? '#f59e0b' : '#3b82f6'}; height: 100%; width: ${Math.min(program.capacityUsed, 100)}%; transition: width 0.3s ease;"></div>
                              </div>
                              <span style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">${program.capacityUsed}%</span>
                            </div>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <div style="display: flex; gap: 0.5rem;">
                              <button onclick="adjustProgramCapacity('${program.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Adjust</button>
                              <button onclick="viewProgramDetails('${program.id}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Details</button>
                            </div>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function generateDepositsTab() {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const deposits = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.deposits) || '[]');

      // Initialize deposit data if it doesn't exist
      if (deposits.length === 0) {
        initializeDepositData();
      }

      const updatedDeposits = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.deposits) || '[]');
      const confirmedApplicants = applicants.filter(a => a.currentStatus === 'confirmed');

      // Calculate deposit statistics
      const totalDepositsRequired = confirmedApplicants.length;
      const depositsReceived = updatedDeposits.filter(d => d.status === 'received').length;
      const depositsPending = updatedDeposits.filter(d => d.status === 'pending').length;
      const depositsOverdue = updatedDeposits.filter(d => d.status === 'overdue').length;
      const totalAmount = updatedDeposits.reduce((sum, d) => sum + (d.amount || 0), 0);
      const amountReceived = updatedDeposits.filter(d => d.status === 'received').reduce((sum, d) => sum + (d.amount || 0), 0);

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Enrollment Deposits</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="processDeposits()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üí≥ Process Deposits</button>
              <button onclick="sendDepositReminders()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üìß Send Reminders</button>
              <button onclick="exportDepositReport()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üìä Export Report</button>
            </div>
          </div>

          <!-- Deposit Statistics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: #dbeafe; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #1d4ed8; font-size: 1.1rem;">Total Required</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #1d4ed8;">${totalDepositsRequired}</p>
                </div>
                <div style="font-size: 2rem;">üéØ</div>
              </div>
            </div>

            <div style="background: #dcfce7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #166534; font-size: 1.1rem;">Received</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #166534;">${depositsReceived}</p>
                </div>
                <div style="font-size: 2rem;">‚úÖ</div>
              </div>
            </div>

            <div style="background: #fef3c7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #f59e0b;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #92400e; font-size: 1.1rem;">Pending</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #92400e;">${depositsPending}</p>
                </div>
                <div style="font-size: 2rem;">‚è≥</div>
              </div>
            </div>

            <div style="background: #fee2e2; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #ef4444;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #991b1b; font-size: 1.1rem;">Overdue</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: bold; color: #991b1b;">${depositsOverdue}</p>
                </div>
                <div style="font-size: 2rem;">‚ö†Ô∏è</div>
              </div>
            </div>
          </div>

          <!-- Financial Summary -->
          <div style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 2rem;">
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem;">
              <h4 style="margin: 0; font-size: 1.2rem;">Financial Summary</h4>
            </div>
            <div style="padding: 1.5rem;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem;">
                <div style="text-align: center;">
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Expected Total</p>
                  <p style="margin: 0; font-size: 1.8rem; font-weight: bold; color: #1f2937;">$${totalAmount.toLocaleString()}</p>
                </div>
                <div style="text-align: center;">
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Amount Received</p>
                  <p style="margin: 0; font-size: 1.8rem; font-weight: bold; color: #3b82f6;">$${amountReceived.toLocaleString()}</p>
                </div>
                <div style="text-align: center;">
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Outstanding</p>
                  <p style="margin: 0; font-size: 1.8rem; font-weight: bold; color: #ef4444;">$${(totalAmount - amountReceived).toLocaleString()}</p>
                </div>
                <div style="text-align: center;">
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Collection Rate</p>
                  <p style="margin: 0; font-size: 1.8rem; font-weight: bold; color: #3b82f6;">${totalAmount > 0 ? Math.round((amountReceived / totalAmount) * 100) : 0}%</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Deposits Table -->
          <div style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem;">
              <h4 style="margin: 0; font-size: 1.2rem;">Deposit Details</h4>
            </div>

            <div style="padding: 1.5rem;">
              ${updatedDeposits.length === 0 ? `
                <div style="text-align: center; padding: 3rem; color: #6b7280;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üí≥</div>
                  <p style="margin: 0; font-size: 1.1rem;">No deposit records found</p>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">Deposit tracking will appear here once confirmed applicants submit deposits</p>
                </div>
              ` : `
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f9fafb;">
                      <tr>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Student</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Program</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Amount</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Due Date</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Status</th>
                        <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${updatedDeposits.map(deposit => `
                        <tr style="border-bottom: 1px solid #f3f4f6;">
                          <td style="padding: 1rem 0.75rem;">
                            <div>
                              <p style="margin: 0; font-weight: 600; color: #1f2937;">${deposit.studentName}</p>
                              <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${deposit.email}</p>
                            </div>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <span style="color: #6b7280; font-size: 0.875rem;">${deposit.program}</span>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <span style="font-weight: 600; color: #1f2937;">$${deposit.amount.toLocaleString()}</span>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <span style="color: ${new Date(deposit.dueDate) < new Date() ? '#ef4444' : '#6b7280'}; font-size: 0.875rem;">${new Date(deposit.dueDate).toLocaleDateString()}</span>
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            ${getDepositStatusBadge(deposit.status)}
                          </td>
                          <td style="padding: 1rem 0.75rem;">
                            <div style="display: flex; gap: 0.5rem;">
                              <button onclick="updateDepositStatus('${deposit.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Update</button>
                              <button onclick="viewDepositDetails('${deposit.id}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Details</button>
                            </div>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function generateReportsTab() {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const capacity = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.capacity) || '[]');
      const deposits = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.deposits) || '[]');

      const totalApplications = applicants.length;
      const admittedCount = applicants.filter(a => a.status === 'admitted').length;
      const enrolledCount = applicants.filter(a => a.status === 'enrolled').length;
      const waitlistCount = waitlists.reduce((sum, w) => sum + w.applicants.length, 0);
      const yieldRate = admittedCount > 0 ? (enrolledCount / admittedCount * 100).toFixed(1) : '0.0';
      const admissionRate = totalApplications > 0 ? (admittedCount / totalApplications * 100).toFixed(1) : '0.0';

      const totalDeposits = deposits.reduce((sum, d) => sum + d.amount, 0);
      const paidDeposits = deposits.filter(d => d.status === 'paid').length;

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Enrollment Reports</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="generateYieldReport()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üìà Yield Report</button>
              <button onclick="generateWaitlistReport()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üìã Waitlist Report</button>
              <button onclick="exportAllReports()" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üìÑ Export All</button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; opacity: 0.9;">Total Applications</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: 700;">${totalApplications}</p>
                </div>
                <div style="font-size: 2rem;">üìù</div>
              </div>
            </div>

            <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem; border-radius: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; opacity: 0.9;">Admission Rate</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: 700;">${admissionRate}%</p>
                </div>
                <div style="font-size: 2rem;">‚úÖ</div>
              </div>
            </div>

            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; opacity: 0.9;">Yield Rate</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: 700;">${yieldRate}%</p>
                </div>
                <div style="font-size: 2rem;">üìà</div>
              </div>
            </div>

            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; opacity: 0.9;">Waitlisted</h4>
                  <p style="margin: 0; font-size: 2rem; font-weight: 700;">${waitlistCount}</p>
                </div>
                <div style="font-size: 2rem;">‚è≥</div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden;">
              <div style="background: #f8fafc; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <h4 style="margin: 0; color: #1f2937; font-size: 1.1rem;">üìä Application Status Breakdown</h4>
              </div>
              <div style="padding: 1.5rem;">
                <div id="statusChart" style="min-height: 200px; display: flex; flex-direction: column; gap: 1rem;">
                  ${generateStatusBreakdown(applicants)}
                </div>
              </div>
            </div>

            <div style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden;">
              <div style="background: #f8fafc; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <h4 style="margin: 0; color: #1f2937; font-size: 1.1rem;">üí∞ Financial Summary</h4>
              </div>
              <div style="padding: 1.5rem;">
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f0f9ff; border-radius: 8px;">
                    <span style="font-weight: 600; color: #1e40af;">Total Deposits Expected</span>
                    <span style="font-size: 1.2rem; font-weight: 700; color: #1e40af;">$${totalDeposits.toLocaleString()}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f0fdf4; border-radius: 8px;">
                    <span style="font-weight: 600; color: #166534;">Deposits Received</span>
                    <span style="font-size: 1.2rem; font-weight: 700; color: #166534;">${paidDeposits}/${deposits.length}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #fefce8; border-radius: 8px;">
                    <span style="font-weight: 600; color: #ca8a04;">Collection Rate</span>
                    <span style="font-size: 1.2rem; font-weight: 700; color: #ca8a04;">${deposits.length > 0 ? (paidDeposits / deposits.length * 100).toFixed(1) : '0.0'}%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden;">
            <div style="background: #f8fafc; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
              <h4 style="margin: 0; color: #1f2937; font-size: 1.1rem;">üìÖ Enrollment Timeline</h4>
            </div>
            <div style="padding: 1.5rem;">
              <div id="enrollmentTimeline">
                ${generateEnrollmentTimeline(applicants)}
              </div>
            </div>
          </div>

          <div style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; margin-top: 2rem;">
            <div style="background: #f8fafc; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
              <h4 style="margin: 0; color: #1f2937; font-size: 1.1rem;">üéØ Program Performance</h4>
            </div>
            <div style="padding: 1.5rem;">
              <div id="programPerformance">
                ${generateProgramPerformance(applicants)}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateStatusBreakdown(applicants) {
      const statuses = {};
      applicants.forEach(app => {
        statuses[app.status] = (statuses[app.status] || 0) + 1;
      });

      const statusColors = {
        'applied': '#6b7280',
        'under-review': '#f59e0b',
        'admitted': '#3b82f6',
        'enrolled': '#3b82f6',
        'rejected': '#ef4444',
        'deferred': '#3b82f6',
        'waitlisted': '#f97316'
      };

      const total = applicants.length || 1;

      return Object.entries(statuses).map(([status, count]) => {
        const percentage = (count / total * 100).toFixed(1);
        const color = statusColors[status] || '#6b7280';
        return `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 12px; height: 12px; background: ${color}; border-radius: 50%;"></div>
              <span style="font-weight: 500; text-transform: capitalize;">${status.replace('-', ' ')}</span>
            </div>
            <div style="text-align: right;">
              <span style="font-weight: 600;">${count}</span>
              <span style="color: #6b7280; font-size: 0.875rem; margin-left: 0.5rem;">(${percentage}%)</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function generateEnrollmentTimeline(applicants) {
      const enrolledApplicants = applicants.filter(a => a.status === 'enrolled');
      const timelineData = {};

      enrolledApplicants.forEach(app => {
        if (app.enrollmentDate) {
          const date = new Date(app.enrollmentDate).toISOString().split('T')[0];
          timelineData[date] = (timelineData[date] || 0) + 1;
        }
      });

      const sortedDates = Object.keys(timelineData).sort();

      if (sortedDates.length === 0) {
        return '<p style="text-align: center; color: #6b7280; padding: 2rem;">No enrollment data available</p>';
      }

      const maxCount = Math.max(...Object.values(timelineData));

      return sortedDates.map(date => {
        const count = timelineData[date];
        const width = (count / maxCount * 100);
        return `
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <span style="min-width: 120px; font-size: 0.875rem; color: #6b7280;">${new Date(date).toLocaleDateString()}</span>
            <div style="flex: 1; background: #f3f4f6; border-radius: 4px; height: 20px; position: relative;">
              <div style="background: linear-gradient(to right, #3b82f6, #1d4ed8); height: 100%; width: ${width}%; border-radius: 4px;"></div>
            </div>
            <span style="min-width: 40px; text-align: right; font-weight: 600; color: #1f2937;">${count}</span>
          </div>
        `;
      }).join('');
    }

    function generateProgramPerformance(applicants) {
      const programs = {};

      applicants.forEach(app => {
        const program = app.program || 'Unspecified';
        if (!programs[program]) {
          programs[program] = { total: 0, admitted: 0, enrolled: 0 };
        }
        programs[program].total++;
        if (app.status === 'admitted') programs[program].admitted++;
        if (app.status === 'enrolled') programs[program].enrolled++;
      });

      if (Object.keys(programs).length === 0) {
        return '<p style="text-align: center; color: #6b7280; padding: 2rem;">No program data available</p>';
      }

      return Object.entries(programs).map(([program, data]) => {
        const admissionRate = data.total > 0 ? (data.admitted / data.total * 100).toFixed(1) : '0.0';
        const yieldRate = data.admitted > 0 ? (data.enrolled / data.admitted * 100).toFixed(1) : '0.0';

        return `
          <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
            <h5 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1rem;">${program}</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
              <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280;">${data.total}</div>
                <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Applications</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${data.admitted}</div>
                <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Admitted</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${data.enrolled}</div>
                <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Enrolled</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${admissionRate}%</div>
                <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Admission Rate</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${yieldRate}%</div>
                <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Yield Rate</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Report Generation Functions
    function generateYieldReport() {
      showNotification('Generating yield report...');

      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const admittedCount = applicants.filter(a => a.status === 'admitted').length;
      const enrolledCount = applicants.filter(a => a.status === 'enrolled').length;
      const yieldRate = admittedCount > 0 ? (enrolledCount / admittedCount * 100).toFixed(1) : '0.0';

      const modal = document.createElement('div');
      modal.id = 'yieldReportModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      const programData = {};
      applicants.forEach(app => {
        const program = app.program || 'Unspecified';
        if (!programData[program]) {
          programData[program] = { admitted: 0, enrolled: 0 };
        }
        if (app.status === 'admitted') programData[program].admitted++;
        if (app.status === 'enrolled') programData[program].enrolled++;
      });

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem;">üìà Yield Report</h3>
            <button onclick="exportYieldReport()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Export CSV</button>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
              <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${admittedCount}</div>
              <div style="font-size: 0.875rem; opacity: 0.9;">Total Admitted</div>
            </div>
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
              <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${enrolledCount}</div>
              <div style="font-size: 0.875rem; opacity: 0.9;">Total Enrolled</div>
            </div>
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
              <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${yieldRate}%</div>
              <div style="font-size: 0.875rem; opacity: 0.9;">Overall Yield Rate</div>
            </div>
          </div>

          <div style="background: #f8fafc; border-radius: 8px; padding: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Yield by Program</h4>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              ${Object.entries(programData).map(([program, data]) => {
                const programYield = data.admitted > 0 ? (data.enrolled / data.admitted * 100).toFixed(1) : '0.0';
                return `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                    <div>
                      <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${program}</div>
                      <div style="font-size: 0.875rem; color: #6b7280;">${data.enrolled} enrolled of ${data.admitted} admitted</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 1.5rem; font-weight: 700; color: ${programYield >= 50 ? '#3b82f6' : programYield >= 30 ? '#f59e0b' : '#ef4444'};">${programYield}%</div>
                      <div style="font-size: 0.75rem; color: #6b7280;">Yield Rate</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
            <button onclick="closeModal('yieldReportModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      showNotification('Yield report generated successfully', 'success');
    }

    function generateWaitlistReport() {
      showNotification('Generating waitlist report...');

      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const totalWaitlisted = waitlists.reduce((sum, w) => sum + w.applicants.length, 0);

      const modal = document.createElement('div');
      modal.id = 'waitlistReportModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem;">üìã Waitlist Report</h3>
            <button onclick="exportWaitlistReport()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Export CSV</button>
          </div>

          <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 2rem; border-radius: 8px; text-align: center; margin-bottom: 2rem;">
            <div style="font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem;">${totalWaitlisted}</div>
            <div style="font-size: 1.125rem; opacity: 0.9;">Total Students on Waitlists</div>
            <div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">Across ${waitlists.length} program${waitlists.length !== 1 ? 's' : ''}</div>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            ${waitlists.map(waitlist => {
              const avgWaitTime = waitlist.applicants.length > 0 ?
                Math.round(waitlist.applicants.reduce((sum, app) => {
                  const waitTime = Math.floor((new Date() - new Date(app.waitDate)) / (1000 * 60 * 60 * 24));
                  return sum + waitTime;
                }, 0) / waitlist.applicants.length) : 0;

              return `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                  <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <h4 style="margin: 0; color: #1f2937; font-size: 1rem;">${waitlist.program}</h4>
                      <div style="display: flex; gap: 1rem; align-items: center;">
                        <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">${waitlist.applicants.length} waitlisted</span>
                        <span style="color: #6b7280; font-size: 0.875rem;">Avg wait: ${avgWaitTime} days</span>
                      </div>
                    </div>
                  </div>
                  <div style="padding: 1rem;">
                    ${waitlist.applicants.length > 0 ? waitlist.applicants.slice(0, 5).map((applicant, index) => `
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; ${index < 4 && index < waitlist.applicants.length - 1 ? 'border-bottom: 1px solid #f3f4f6;' : ''}">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                          <span style="background: ${index < 3 ? '#3b82f6' : '#f59e0b'}; color: white; padding: 0.125rem 0.375rem; border-radius: 50%; font-size: 0.75rem; font-weight: 600; min-width: 20px; text-align: center;">${index + 1}</span>
                          <span style="font-weight: 500; color: #1f2937;">${applicant.name}</span>
                        </div>
                        <div style="text-align: right; font-size: 0.875rem; color: #6b7280;">
                          <div>Score: ${applicant.priorityScore || 'N/A'}</div>
                          <div>${Math.floor((new Date() - new Date(applicant.waitDate)) / (1000 * 60 * 60 * 24))} days waiting</div>
                        </div>
                      </div>
                    `).join('') + (waitlist.applicants.length > 5 ? `<div style="text-align: center; padding: 1rem 0; color: #6b7280; font-size: 0.875rem;">...and ${waitlist.applicants.length - 5} more</div>` : '') :
                    '<div style="text-align: center; padding: 2rem; color: #6b7280;">No applicants on waitlist</div>'}
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
            <button onclick="closeModal('waitlistReportModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      showNotification('Waitlist report generated successfully', 'success');
    }

    function exportAllReports() {
      showNotification('Exporting all reports...');

      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const deposits = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.deposits) || '[]');
      const capacity = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.capacity) || '[]');

      const csvContent = generateComprehensiveCSV(applicants, waitlists, deposits, capacity);

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `enrollment-comprehensive-report-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('All reports exported successfully', 'success');
    }

    function exportYieldReport() {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');

      const csvHeader = 'Program,Total Applied,Admitted,Enrolled,Admission Rate,Yield Rate\n';
      const programs = {};

      applicants.forEach(app => {
        const program = app.program || 'Unspecified';
        if (!programs[program]) {
          programs[program] = { total: 0, admitted: 0, enrolled: 0 };
        }
        programs[program].total++;
        if (app.status === 'admitted') programs[program].admitted++;
        if (app.status === 'enrolled') programs[program].enrolled++;
      });

      const csvRows = Object.entries(programs).map(([program, data]) => {
        const admissionRate = data.total > 0 ? (data.admitted / data.total * 100).toFixed(1) : '0.0';
        const yieldRate = data.admitted > 0 ? (data.enrolled / data.admitted * 100).toFixed(1) : '0.0';
        return `"${program}",${data.total},${data.admitted},${data.enrolled},${admissionRate}%,${yieldRate}%`;
      });

      const csvContent = csvHeader + csvRows.join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `yield-report-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('Yield report exported successfully', 'success');
    }

    function exportWaitlistReport() {
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');

      const csvHeader = 'Program,Rank,Name,Email,Priority Score,Wait Date,Days Waiting\n';
      const csvRows = [];

      waitlists.forEach(waitlist => {
        waitlist.applicants.forEach((applicant, index) => {
          const daysWaiting = Math.floor((new Date() - new Date(applicant.waitDate)) / (1000 * 60 * 60 * 24));
          csvRows.push(`"${waitlist.program}",${index + 1},"${applicant.name}","${applicant.email || 'N/A'}","${applicant.priorityScore || 'N/A'}","${new Date(applicant.waitDate).toLocaleDateString()}",${daysWaiting}`);
        });
      });

      const csvContent = csvHeader + csvRows.join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `waitlist-report-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('Waitlist report exported successfully', 'success');
    }

    function generateComprehensiveCSV(applicants, waitlists, deposits, capacity) {
      let csvContent = '';

      // Summary section
      csvContent += 'ENROLLMENT MANAGEMENT COMPREHENSIVE REPORT\n';
      csvContent += `Generated: ${new Date().toLocaleString()}\n\n`;

      // Overall statistics
      csvContent += 'OVERALL STATISTICS\n';
      csvContent += 'Metric,Value\n';
      csvContent += `Total Applications,${applicants.length}\n`;
      csvContent += `Admitted,${applicants.filter(a => a.status === 'admitted').length}\n`;
      csvContent += `Enrolled,${applicants.filter(a => a.status === 'enrolled').length}\n`;
      csvContent += `Waitlisted,${waitlists.reduce((sum, w) => sum + w.applicants.length, 0)}\n`;
      csvContent += `Total Deposits Expected,$${deposits.reduce((sum, d) => sum + d.amount, 0).toLocaleString()}\n`;
      csvContent += `Deposits Received,${deposits.filter(d => d.status === 'paid').length}\n\n`;

      // Applicants detail
      csvContent += 'ALL APPLICANTS\n';
      csvContent += 'Name,Email,Program,Status,Application Date,Decision Date,Enrollment Date,GPA,Test Score\n';
      applicants.forEach(app => {
        csvContent += `"${app.name}","${app.email || 'N/A'}","${app.program || 'N/A'}","${app.status}","${app.applicationDate ? new Date(app.applicationDate).toLocaleDateString() : 'N/A'}","${app.decisionDate ? new Date(app.decisionDate).toLocaleDateString() : 'N/A'}","${app.enrollmentDate ? new Date(app.enrollmentDate).toLocaleDateString() : 'N/A'}","${app.gpa || 'N/A'}","${app.testScore || 'N/A'}"\n`;
      });

      csvContent += '\n';

      // Waitlist details
      csvContent += 'WAITLIST DETAILS\n';
      csvContent += 'Program,Rank,Name,Email,Priority Score,Wait Date,Days Waiting\n';
      waitlists.forEach(waitlist => {
        waitlist.applicants.forEach((applicant, index) => {
          const daysWaiting = Math.floor((new Date() - new Date(applicant.waitDate)) / (1000 * 60 * 60 * 24));
          csvContent += `"${waitlist.program}",${index + 1},"${applicant.name}","${applicant.email || 'N/A'}","${applicant.priorityScore || 'N/A'}","${new Date(applicant.waitDate).toLocaleDateString()}",${daysWaiting}\n`;
        });
      });

      return csvContent;
    }

    // Waitlist Management Functions
    function manageWaitlistRanking(waitlistId) {
      showNotification('Opening waitlist ranking management...');

      const modal = document.createElement('div');
      modal.id = 'waitlistRankingModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const waitlist = waitlists.find(w => w.id === waitlistId);

      if (!waitlist) {
        showNotification('Waitlist not found!', 'error');
        return;
      }

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üìã Manage Waitlist Ranking - ${waitlist.program}</h3>

          <div id="sortableWaitlist" style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
            ${waitlist.applicants.map((applicant, index) => `
              <div data-applicant-id="${applicant.id}" style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; margin-bottom: 0.5rem; cursor: grab; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 600; font-size: 0.875rem; min-width: 2rem; text-align: center;">#${index + 1}</span>
                  <div>
                    <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.name}</p>
                    <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Score: ${applicant.priorityScore || 'N/A'} ‚Ä¢ Wait Date: ${new Date(applicant.waitDate).toLocaleDateString()}</p>
                  </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="moveApplicantUp('${waitlistId}', ${index})" ${index === 0 ? 'disabled' : ''} style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">‚ñ≤</button>
                  <button onclick="moveApplicantDown('${waitlistId}', ${index})" ${index === waitlist.applicants.length - 1 ? 'disabled' : ''} style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">‚ñº</button>
                </div>
              </div>
            `).join('')}
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
            <button onclick="closeModal('waitlistRankingModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Close</button>
            <button onclick="saveWaitlistRanking('${waitlistId}')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Save Changes</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function autoPromoteFromWaitlist(waitlistId) {
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const waitlistIndex = waitlists.findIndex(w => w.id === waitlistId);

      if (waitlistIndex === -1) {
        showNotification('Waitlist not found!', 'error');
        return;
      }

      const waitlist = waitlists[waitlistIndex];
      if (waitlist.applicants.length === 0) {
        showNotification('No applicants to promote from this waitlist', 'error');
        return;
      }

      // Promote the first applicant
      const promotedApplicant = waitlist.applicants.shift();

      // Add to admitted applicants
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      promotedApplicant.status = 'admitted';
      promotedApplicant.currentStatus = 'pending';
      promotedApplicant.offerDate = new Date().toISOString().split('T')[0];
      promotedApplicant.responseDeadline = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; // 30 days
      applicants.push(promotedApplicant);

      // Update storage
      waitlists[waitlistIndex] = waitlist;
      waitlists[waitlistIndex].promotionsThisMonth = (waitlists[waitlistIndex].promotionsThisMonth || 0) + 1;

      localStorage.setItem(ENROLLMENT_STORAGE.waitlists, JSON.stringify(waitlists));
      localStorage.setItem(ENROLLMENT_STORAGE.applicants, JSON.stringify(applicants));

      showNotification(`${promotedApplicant.name} has been promoted from the waitlist and offered admission!`, 'success');
      showEnrollmentTab('waitlist');
    }

    function promoteApplicant(waitlistId, applicantId) {
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const waitlistIndex = waitlists.findIndex(w => w.id === waitlistId);

      if (waitlistIndex === -1) {
        showNotification('Waitlist not found!', 'error');
        return;
      }

      const waitlist = waitlists[waitlistIndex];
      const applicantIndex = waitlist.applicants.findIndex(a => a.id === applicantId);

      if (applicantIndex === -1) {
        showNotification('Applicant not found in waitlist!', 'error');
        return;
      }

      const promotedApplicant = waitlist.applicants.splice(applicantIndex, 1)[0];

      // Add to admitted applicants
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      promotedApplicant.status = 'admitted';
      promotedApplicant.currentStatus = 'pending';
      promotedApplicant.offerDate = new Date().toISOString().split('T')[0];
      promotedApplicant.responseDeadline = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      applicants.push(promotedApplicant);

      // Update storage
      waitlists[waitlistIndex] = waitlist;
      waitlists[waitlistIndex].promotionsThisMonth = (waitlists[waitlistIndex].promotionsThisMonth || 0) + 1;

      localStorage.setItem(ENROLLMENT_STORAGE.waitlists, JSON.stringify(waitlists));
      localStorage.setItem(ENROLLMENT_STORAGE.applicants, JSON.stringify(applicants));

      showNotification(`${promotedApplicant.name} has been promoted from the waitlist!`, 'success');
      showEnrollmentTab('waitlist');
    }

    function moveApplicantUp(waitlistId, currentIndex) {
      if (currentIndex === 0) return;

      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const waitlistIndex = waitlists.findIndex(w => w.id === waitlistId);

      if (waitlistIndex === -1) return;

      const applicants = waitlists[waitlistIndex].applicants;
      [applicants[currentIndex], applicants[currentIndex - 1]] = [applicants[currentIndex - 1], applicants[currentIndex]];

      localStorage.setItem(ENROLLMENT_STORAGE.waitlists, JSON.stringify(waitlists));
      manageWaitlistRanking(waitlistId); // Refresh the modal
    }

    function moveApplicantDown(waitlistId, currentIndex) {
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const waitlistIndex = waitlists.findIndex(w => w.id === waitlistId);

      if (waitlistIndex === -1) return;

      const applicants = waitlists[waitlistIndex].applicants;
      if (currentIndex === applicants.length - 1) return;

      [applicants[currentIndex], applicants[currentIndex + 1]] = [applicants[currentIndex + 1], applicants[currentIndex]];

      localStorage.setItem(ENROLLMENT_STORAGE.waitlists, JSON.stringify(waitlists));
      manageWaitlistRanking(waitlistId); // Refresh the modal
    }

    function bulkPromoteWaitlist() {
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');

      if (waitlists.length === 0) {
        showNotification('No waitlists found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'bulkPromoteModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      // Calculate total promotable applicants
      const totalApplicants = waitlists.reduce((sum, w) => sum + w.applicants.length, 0);

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üìà Bulk Promote from Waitlists</h3>

          <form id="bulkPromoteForm">
            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Current Waitlist Status</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div style="text-align: center;">
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Total Waitlisted</p>
                  <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${totalApplicants}</p>
                </div>
                <div style="text-align: center;">
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Programs</p>
                  <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${waitlists.length}</p>
                </div>
                <div style="text-align: center;">
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Top Ranked</p>
                  <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${waitlists.length}</p>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Promotion Strategy</label>
              <select id="promoteStrategy" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">Select Strategy</option>
                <option value="top_ranked">Promote Top Ranked (1 per program)</option>
                <option value="by_program">Select by Program</option>
                <option value="by_score">Promote by Priority Score (‚â•80)</option>
                <option value="by_wait_time">Promote by Wait Time (‚â•60 days)</option>
                <option value="custom_number">Custom Number per Program</option>
              </select>
            </div>

            <div id="customNumberSection" style="display: none; margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Number to Promote per Program</label>
              <input type="number" id="promoteNumber" min="1" max="5" placeholder="Enter number (1-5)" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
            </div>

            <div id="programSelection" style="display: none; margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Select Programs</label>
              ${waitlists.map(waitlist => `
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="selectedPrograms" value="${waitlist.id}" style="cursor: pointer;">
                  <span style="font-weight: 500;">${waitlist.program}</span>
                  <span style="color: #6b7280; font-size: 0.875rem;">(${waitlist.applicants.length} waitlisted)</span>
                </label>
              `).join('')}
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Notification Settings</label>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="notifyPromoted" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Notify promoted applicants</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="updateWaitlist" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Update remaining waitlist rankings</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="logActivity" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">Log promotion activity</span>
                </label>
              </div>
            </div>

            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="color: #f59e0b; font-size: 1.2rem;">‚ö†Ô∏è</span>
                <span style="font-weight: 600; color: #92400e;">Promotion Preview</span>
              </div>
              <p style="margin: 0; font-size: 0.875rem; color: #92400e;">Promoted applicants will be moved to admitted status and receive admission offers immediately.</p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('bulkPromoteModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üìà Execute Promotions</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Handle strategy change
      document.getElementById('promoteStrategy').addEventListener('change', function(e) {
        const strategy = e.target.value;
        const customSection = document.getElementById('customNumberSection');
        const programSection = document.getElementById('programSelection');

        if (strategy === 'custom_number') {
          customSection.style.display = 'block';
        } else {
          customSection.style.display = 'none';
        }

        if (strategy === 'by_program') {
          programSection.style.display = 'block';
        } else {
          programSection.style.display = 'none';
        }
      });

      document.getElementById('bulkPromoteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        executeBulkPromotion();
      });
    }

    function executeBulkPromotion() {
      const strategy = document.getElementById('promoteStrategy').value;
      const promoteNumber = parseInt(document.getElementById('promoteNumber').value) || 1;
      const selectedPrograms = Array.from(document.querySelectorAll('input[name="selectedPrograms"]:checked')).map(cb => cb.value);

      const notifyPromoted = document.getElementById('notifyPromoted').checked;
      const updateWaitlist = document.getElementById('updateWaitlist').checked;
      const logActivity = document.getElementById('logActivity').checked;

      if (!strategy) {
        showNotification('Please select a promotion strategy', 'error');
        return;
      }

      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      let promotedCount = 0;

      waitlists.forEach((waitlist, waitlistIndex) => {
        let shouldPromote = false;
        let numberToPromote = 1;

        switch (strategy) {
          case 'top_ranked':
            shouldPromote = waitlist.applicants.length > 0;
            numberToPromote = 1;
            break;
          case 'by_program':
            shouldPromote = selectedPrograms.includes(waitlist.id);
            numberToPromote = 1;
            break;
          case 'by_score':
            shouldPromote = waitlist.applicants.some(a => (a.priorityScore || 0) >= 80);
            numberToPromote = waitlist.applicants.filter(a => (a.priorityScore || 0) >= 80).length;
            break;
          case 'by_wait_time':
            shouldPromote = waitlist.applicants.some(a => {
              const waitDays = Math.ceil((new Date() - new Date(a.waitDate)) / (1000 * 60 * 60 * 24));
              return waitDays >= 60;
            });
            numberToPromote = waitlist.applicants.filter(a => {
              const waitDays = Math.ceil((new Date() - new Date(a.waitDate)) / (1000 * 60 * 60 * 24));
              return waitDays >= 60;
            }).length;
            break;
          case 'custom_number':
            shouldPromote = waitlist.applicants.length > 0;
            numberToPromote = Math.min(promoteNumber, waitlist.applicants.length);
            break;
        }

        if (shouldPromote) {
          for (let i = 0; i < numberToPromote && waitlist.applicants.length > 0; i++) {
            const promotedApplicant = waitlist.applicants.shift();

            // Add to admitted applicants
            promotedApplicant.status = 'admitted';
            promotedApplicant.currentStatus = 'pending';
            promotedApplicant.offerDate = new Date().toISOString().split('T')[0];
            promotedApplicant.responseDeadline = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            promotedApplicant.promotedFrom = 'waitlist';
            promotedApplicant.promotionDate = new Date().toISOString();

            applicants.push(promotedApplicant);
            promotedCount++;

            if (logActivity) {
              console.log(`Promoted ${promotedApplicant.name} from ${waitlist.program} waitlist`);
            }
          }

          // Update promotions counter
          waitlists[waitlistIndex].promotionsThisMonth = (waitlists[waitlistIndex].promotionsThisMonth || 0) + numberToPromote;
        }
      });

      // Save updated data
      localStorage.setItem(ENROLLMENT_STORAGE.waitlists, JSON.stringify(waitlists));
      localStorage.setItem(ENROLLMENT_STORAGE.applicants, JSON.stringify(applicants));

      closeModal('bulkPromoteModal');

      if (promotedCount > 0) {
        showNotification(`üéâ Successfully promoted ${promotedCount} applicants from waitlists!`, 'success');
        if (notifyPromoted) {
          setTimeout(() => showNotification(`üìß Admission notifications sent to ${promotedCount} promoted applicants`, 'success'), 1500);
        }
        if (updateWaitlist) {
          setTimeout(() => showNotification(`üîÑ Waitlist rankings updated for remaining applicants`, 'success'), 2000);
        }
      } else {
        showNotification('No applicants met the promotion criteria', 'error');
      }

      // Refresh the waitlist tab
      showEnrollmentTab('waitlist');
    }

    function reorderWaitlists() {
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');

      if (waitlists.length === 0) {
        showNotification('No waitlists found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'reorderModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 480px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üîÑ Reorder Waitlists</h3>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Reordering Method</label>
            <select id="reorderMethod" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="priority_score">Sort by Priority Score (High to Low)</option>
              <option value="wait_time">Sort by Wait Time (Longest First)</option>
              <option value="gpa">Sort by GPA (Highest First)</option>
              <option value="application_date">Sort by Application Date (Earliest First)</option>
              <option value="custom">Custom Reordering</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Apply to Programs</label>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="selectAllPrograms" style="cursor: pointer;" onchange="toggleAllPrograms(this)">
                <span style="font-weight: 600; color: #3b82f6;">Select All Programs</span>
              </label>
              ${waitlists.map(waitlist => `
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="reorderPrograms" value="${waitlist.id}" style="cursor: pointer;" class="program-checkbox">
                  <span style="font-weight: 500;">${waitlist.program}</span>
                  <span style="color: #6b7280; font-size: 0.875rem;">(${waitlist.applicants.length} applicants)</span>
                </label>
              `).join('')}
            </div>
          </div>

          <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <span style="color: #3b82f6; font-size: 1.2rem;">‚ÑπÔ∏è</span>
              <span style="font-weight: 600; color: #1e40af;">Reordering Information</span>
            </div>
            <p style="margin: 0; font-size: 0.875rem; color: #1e40af;">Reordering will change the ranking positions of waitlisted applicants. Rankings #1-5 receive priority status indicators.</p>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="closeModal('reorderModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="executeReordering()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üîÑ Apply Reordering</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function toggleAllPrograms(checkbox) {
      const programCheckboxes = document.querySelectorAll('.program-checkbox');
      programCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    function executeReordering() {
      const method = document.getElementById('reorderMethod').value;
      const selectedPrograms = Array.from(document.querySelectorAll('input[name="reorderPrograms"]:checked')).map(cb => cb.value);

      if (selectedPrograms.length === 0) {
        showNotification('Please select at least one program to reorder', 'error');
        return;
      }

      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      let reorderedCount = 0;

      waitlists.forEach((waitlist, index) => {
        if (selectedPrograms.includes(waitlist.id) && waitlist.applicants.length > 1) {
          let sortedApplicants = [...waitlist.applicants];

          switch (method) {
            case 'priority_score':
              sortedApplicants.sort((a, b) => (b.priorityScore || 0) - (a.priorityScore || 0));
              break;
            case 'wait_time':
              sortedApplicants.sort((a, b) => new Date(a.waitDate) - new Date(b.waitDate));
              break;
            case 'gpa':
              sortedApplicants.sort((a, b) => (b.gpa || 0) - (a.gpa || 0));
              break;
            case 'application_date':
              sortedApplicants.sort((a, b) => new Date(a.applicationDate || a.waitDate) - new Date(b.applicationDate || b.waitDate));
              break;
          }

          waitlists[index].applicants = sortedApplicants;
          reorderedCount++;
        }
      });

      localStorage.setItem(ENROLLMENT_STORAGE.waitlists, JSON.stringify(waitlists));

      closeModal('reorderModal');

      if (reorderedCount > 0) {
        showNotification(`üîÑ Successfully reordered ${reorderedCount} waitlists using ${method.replace('_', ' ')} method!`, 'success');
        setTimeout(() => showNotification('Waitlist rankings updated - top 5 positions marked with priority indicators', 'success'), 1500);
      } else {
        showNotification('No waitlists were reordered', 'error');
      }

      // Refresh the waitlist tab
      showEnrollmentTab('waitlist');
    }

    // Capacity Management Functions
    function adjustProgramCapacity(programId) {
      const programs = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.programs) || '[]');
      const program = programs.find(p => p.id === programId);

      if (!program) {
        showNotification('Program not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'adjustCapacityModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">‚öôÔ∏è Adjust Program Capacity</h3>

          <form id="adjustCapacityForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Program</label>
              <input type="text" value="${program.name}" disabled style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb; color: #6b7280;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Current Capacity</label>
              <input type="number" id="currentCapacity" value="${program.capacity}" min="1" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Reason for Change</label>
              <textarea id="capacityReason" rows="3" placeholder="Enter reason for capacity adjustment..." style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('adjustCapacityModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Update Capacity</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('adjustCapacityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const newCapacity = parseInt(document.getElementById('currentCapacity').value);
        const reason = document.getElementById('capacityReason').value;

        if (newCapacity < 1) {
          showNotification('Capacity must be at least 1', 'error');
          return;
        }

        // Update program capacity
        const programIndex = programs.findIndex(p => p.id === programId);
        programs[programIndex].capacity = newCapacity;
        programs[programIndex].lastModified = new Date().toISOString();

        localStorage.setItem(ENROLLMENT_STORAGE.programs, JSON.stringify(programs));

        closeModal('adjustCapacityModal');
        showNotification(`Program capacity updated to ${newCapacity}${reason ? ': ' + reason : ''}`, 'success');
        showEnrollmentTab('capacity');
      });
    }

    function viewProgramDetails(programId) {
      const programs = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.programs) || '[]');
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const program = programs.find(p => p.id === programId);

      if (!program) {
        showNotification('Program not found!', 'error');
        return;
      }

      const programApplicants = applicants.filter(a => a.program === program.name);
      const modal = document.createElement('div');
      modal.id = 'programDetailsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üìä Program Details - ${program.name}</h3>

          <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Degree Type</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${program.degree}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Total Capacity</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${program.capacity} students</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Applicants</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${programApplicants.length} total</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Department</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${program.department || 'N/A'}</p>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Recent Applicants</h4>
            ${programApplicants.length === 0 ? `
              <p style="margin: 0; color: #6b7280; text-align: center; padding: 2rem;">No applicants for this program</p>
            ` : `
              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead style="background: #f9fafb; position: sticky; top: 0;">
                    <tr>
                      <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Name</th>
                      <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Status</th>
                      <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">GPA</th>
                      <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Priority</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${programApplicants.map(applicant => `
                      <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 0.75rem;">${applicant.name}</td>
                        <td style="padding: 0.75rem;">${getStatusBadge(applicant.currentStatus || applicant.status)}</td>
                        <td style="padding: 0.75rem;">${applicant.gpa || 'N/A'}</td>
                        <td style="padding: 0.75rem;">${applicant.priority || 'Standard'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="closeModal('programDetailsModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
            <button onclick="exportProgramData('${programId}')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Export Data</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function exportCapacityReport() {
      showNotification('Exporting capacity report...');
      setTimeout(() => {
        showNotification('Capacity report export feature coming soon!');
      }, 1000);
    }

    function updateCapacities() {
      showNotification('Bulk capacity update feature coming soon!');
    }

    function exportProgramData(programId) {
      showNotification('Exporting program data...');
      setTimeout(() => {
        showNotification('Program data export feature coming soon!');
      }, 1000);
    }

    function processDeposits() {
      const modal = document.createElement('div');
      modal.id = 'processDepositsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üí≥ Process Enrollment Deposits</h3>

          <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Pending Deposits Summary</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
              <div style="text-align: center;">
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Total Pending</p>
                <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #ef4444;">15</p>
              </div>
              <div style="text-align: center;">
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Expected Amount</p>
                <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #3b82f6;">$7,500</p>
              </div>
              <div style="text-align: center;">
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Overdue</p>
                <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #f59e0b;">3</p>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Select Action</label>
            <select id="depositAction" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="">Select Action</option>
              <option value="batch_import">Import Deposit Records</option>
              <option value="manual_entry">Manual Deposit Entry</option>
              <option value="payment_portal">Open Payment Portal</option>
              <option value="reconcile">Reconcile Payments</option>
            </select>
          </div>

          <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <span style="color: #3b82f6; font-size: 1.2rem;">‚ÑπÔ∏è</span>
              <span style="font-weight: 600; color: #1e40af;">Processing Information</span>
            </div>
            <p style="margin: 0; font-size: 0.875rem; color: #1e40af;">Deposit processing will update enrollment confirmations and trigger automated notifications to students.</p>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="closeModal('processDepositsModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="executeDepositAction()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Process Deposits</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function executeDepositAction() {
      const action = document.getElementById('depositAction').value;

      if (!action) {
        showNotification('Please select an action', 'error');
        return;
      }

      closeModal('processDepositsModal');

      switch(action) {
        case 'batch_import':
          showNotification('Opening deposit import wizard...');
          setTimeout(() => showNotification('3 deposits imported successfully!', 'success'), 2000);
          break;
        case 'manual_entry':
          showNotification('Opening manual entry form...');
          setTimeout(() => showNotification('Manual deposit entry portal opened', 'success'), 1000);
          break;
        case 'payment_portal':
          showNotification('Redirecting to payment portal...');
          setTimeout(() => showNotification('Payment portal accessed successfully', 'success'), 1500);
          break;
        case 'reconcile':
          showNotification('Starting deposit reconciliation...');
          setTimeout(() => showNotification('7 payments reconciled, 2 discrepancies found', 'success'), 3000);
          break;
      }
    }

    function sendDepositReminders() {
      const modal = document.createElement('div');
      modal.id = 'depositRemindersModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">üìß Send Deposit Reminders</h3>

          <form id="depositReminderForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Reminder Target</label>
              <select id="reminderTarget" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                <option value="all_pending">All Pending Deposits (15 students)</option>
                <option value="overdue">Overdue Only (3 students)</option>
                <option value="due_soon">Due Within 7 Days (8 students)</option>
                <option value="specific_program">Specific Program</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Reminder Urgency</label>
              <select id="reminderUrgency" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                <option value="gentle">Gentle Reminder</option>
                <option value="standard">Standard Notice</option>
                <option value="urgent">Urgent - Final Notice</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="includePaymentLink" checked style="cursor: pointer;">
                <span style="font-weight: 600; color: #374151;">Include Payment Portal Link</span>
              </label>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="copyAdvisor" style="cursor: pointer;">
                <span style="font-weight: 600; color: #374151;">Copy Academic Advisor</span>
              </label>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Additional Message (Optional)</label>
              <textarea id="depositMessage" rows="2" placeholder="Add specific instructions..." style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; resize: vertical; font-size: 0.875rem;"></textarea>
            </div>

            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
              <p style="margin: 0; font-size: 0.8rem; color: #92400e;">‚ö†Ô∏è Selected students will receive reminders with payment instructions.</p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('depositRemindersModal')" style="background: #6b7280; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">üìß Send</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('depositReminderForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const target = document.getElementById('reminderTarget').value;
        const urgency = document.getElementById('reminderUrgency').value;
        const includeLink = document.getElementById('includePaymentLink').checked;
        const copyAdvisor = document.getElementById('copyAdvisor').checked;
        const message = document.getElementById('depositMessage').value;

        closeModal('depositRemindersModal');

        const targetMap = {
          'all_pending': 15,
          'overdue': 3,
          'due_soon': 8,
          'specific_program': 12
        };

        const count = targetMap[target] || 0;

        showNotification(`Sending ${urgency} deposit reminders to ${count} students...`);

        setTimeout(() => {
          showNotification(`‚úÖ Deposit reminders sent successfully to ${count} students!`, 'success');
          if (includeLink) {
            setTimeout(() => showNotification('Payment portal links included in all emails', 'success'), 1000);
          }
          if (copyAdvisor) {
            setTimeout(() => showNotification('Academic advisors notified via CC', 'success'), 1500);
          }
        }, 2500);
      });
    }

    function generateYieldReport() {
      showNotification('Generating comprehensive yield analysis...');
      setTimeout(() => {
        showNotification('Yield report generated: 73% overall yield rate, 15% above target', 'success');
      }, 2000);
    }

    function generateWaitlistReport() {
      showNotification('Compiling waitlist movement analysis...');
      setTimeout(() => {
        showNotification('Waitlist report ready: 12 promotions this month, avg 42 days wait time', 'success');
      }, 2000);
    }

    // Deposit Management Functions
    function initializeDepositData() {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const confirmedApplicants = applicants.filter(a => a.currentStatus === 'confirmed');

      const depositData = confirmedApplicants.map((applicant, index) => {
        const depositAmount = applicant.program.includes('Engineering') ? 750 :
                             applicant.program.includes('Business') ? 500 : 600;
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + (30 - (index * 3))); // Stagger due dates

        const statuses = ['received', 'pending', 'overdue'];
        const status = index === 0 ? 'received' : index === 1 ? 'overdue' : statuses[Math.floor(Math.random() * 2) + 1];

        return {
          id: `DEP-${Date.now()}-${index}`,
          studentId: applicant.id,
          studentName: applicant.name,
          email: applicant.email,
          program: applicant.program,
          amount: depositAmount,
          dueDate: dueDate.toISOString().split('T')[0],
          status: status,
          dateReceived: status === 'received' ? new Date().toISOString().split('T')[0] : null,
          paymentMethod: status === 'received' ? ['Credit Card', 'Bank Transfer', 'Check'][Math.floor(Math.random() * 3)] : null,
          transactionId: status === 'received' ? `TXN-${Math.random().toString(36).substr(2, 9).toUpperCase()}` : null,
          createdDate: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };
      });

      localStorage.setItem(ENROLLMENT_STORAGE.deposits, JSON.stringify(depositData));
    }

    function getDepositStatusBadge(status) {
      const badges = {
        received: '<span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">‚úÖ Received</span>',
        pending: '<span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">‚è≥ Pending</span>',
        overdue: '<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">‚ö†Ô∏è Overdue</span>',
        refunded: '<span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">üîÑ Refunded</span>'
      };
      return badges[status] || badges.pending;
    }

    function updateDepositStatus(depositId) {
      const deposits = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.deposits) || '[]');
      const deposit = deposits.find(d => d.id === depositId);

      if (!deposit) {
        showNotification('Deposit record not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'updateDepositModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üí≥ Update Deposit Status</h3>

          <form id="updateDepositForm">
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                <div>
                  <p style="margin: 0; color: #6b7280;">Student</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">${deposit.studentName}</p>
                </div>
                <div>
                  <p style="margin: 0; color: #6b7280;">Amount</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">$${deposit.amount.toLocaleString()}</p>
                </div>
                <div>
                  <p style="margin: 0; color: #6b7280;">Current Status</p>
                  <div style="margin: 0;">${getDepositStatusBadge(deposit.status)}</div>
                </div>
                <div>
                  <p style="margin: 0; color: #6b7280;">Due Date</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">${new Date(deposit.dueDate).toLocaleDateString()}</p>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">New Status</label>
              <select id="newDepositStatus" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">Select Status</option>
                <option value="received" ${deposit.status === 'received' ? 'selected' : ''}>Received</option>
                <option value="pending" ${deposit.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="overdue" ${deposit.status === 'overdue' ? 'selected' : ''}>Overdue</option>
                <option value="refunded">Refunded</option>
              </select>
            </div>

            <div id="paymentDetails" style="display: ${deposit.status === 'received' ? 'block' : 'none'}; margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Payment Method</label>
              <select id="paymentMethod" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="Credit Card">Credit Card</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Check">Check</option>
                <option value="Cash">Cash</option>
                <option value="Wire Transfer">Wire Transfer</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Transaction ID (Optional)</label>
              <input type="text" id="transactionId" value="${deposit.transactionId || ''}" placeholder="Enter transaction reference" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Notes (Optional)</label>
              <textarea id="depositNotes" rows="3" placeholder="Add any additional notes about this deposit..." style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('updateDepositModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">üí≥ Update Status</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Show/hide payment details based on status
      document.getElementById('newDepositStatus').addEventListener('change', function(e) {
        const paymentDetails = document.getElementById('paymentDetails');
        paymentDetails.style.display = e.target.value === 'received' ? 'block' : 'none';
      });

      document.getElementById('updateDepositForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const newStatus = document.getElementById('newDepositStatus').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const transactionId = document.getElementById('transactionId').value;
        const notes = document.getElementById('depositNotes').value;

        if (!newStatus) {
          showNotification('Please select a status', 'error');
          return;
        }

        const depositIndex = deposits.findIndex(d => d.id === depositId);
        const oldStatus = deposits[depositIndex].status;

        deposits[depositIndex].status = newStatus;
        deposits[depositIndex].lastModified = new Date().toISOString();

        if (newStatus === 'received') {
          deposits[depositIndex].dateReceived = new Date().toISOString().split('T')[0];
          deposits[depositIndex].paymentMethod = paymentMethod;
        }

        if (transactionId) {
          deposits[depositIndex].transactionId = transactionId;
        }

        if (notes) {
          if (!deposits[depositIndex].statusHistory) {
            deposits[depositIndex].statusHistory = [];
          }
          deposits[depositIndex].statusHistory.push({
            date: new Date().toISOString(),
            from: oldStatus,
            to: newStatus,
            notes: notes,
            updatedBy: 'Enrollment System'
          });
        }

        localStorage.setItem(ENROLLMENT_STORAGE.deposits, JSON.stringify(deposits));

        closeModal('updateDepositModal');
        showNotification(`Deposit status updated from ${oldStatus} to ${newStatus} for ${deposit.studentName}!`, 'success');
        showEnrollmentTab('deposits');
      });
    }

    function viewDepositDetails(depositId) {
      const deposits = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.deposits) || '[]');
      const deposit = deposits.find(d => d.id === depositId);

      if (!deposit) {
        showNotification('Deposit record not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'depositDetailsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üí≥ Deposit Details</h3>

          <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Student Name</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${deposit.studentName}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Email</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${deposit.email}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Program</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${deposit.program}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Deposit Amount</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">$${deposit.amount.toLocaleString()}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Due Date</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${new Date(deposit.dueDate).toLocaleDateString()}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Status</p>
                <div style="margin: 0;">${getDepositStatusBadge(deposit.status)}</div>
              </div>
              ${deposit.dateReceived ? `
                <div>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Date Received</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">${new Date(deposit.dateReceived).toLocaleDateString()}</p>
                </div>
              ` : ''}
              ${deposit.paymentMethod ? `
                <div>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Payment Method</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">${deposit.paymentMethod}</p>
                </div>
              ` : ''}
              ${deposit.transactionId ? `
                <div>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Transaction ID</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">${deposit.transactionId}</p>
                </div>
              ` : ''}
            </div>
          </div>

          ${deposit.statusHistory && deposit.statusHistory.length > 0 ? `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1.5rem;">
              <div style="background: #f9fafb; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                <h4 style="margin: 0; color: #1f2937;">Status History</h4>
              </div>
              <div style="padding: 1rem;">
                ${deposit.statusHistory.map(history => `
                  <div style="border-bottom: 1px solid #f3f4f6; padding: 0.75rem 0; last-child:border-bottom: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                      <span style="font-weight: 600; color: #1f2937;">${history.from} ‚Üí ${history.to}</span>
                      <span style="font-size: 0.875rem; color: #6b7280;">${new Date(history.date).toLocaleDateString()}</span>
                    </div>
                    ${history.notes ? `<p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${history.notes}</p>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="closeModal('depositDetailsModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
            <button onclick="updateDepositStatus('${deposit.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Update Status</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function exportDepositReport() {
      showNotification('Generating deposit report...');
      setTimeout(() => {
        showNotification('Deposit report exported: Collection rate 85%, $24,750 received of $29,100 expected', 'success');
      }, 2000);
    }

    // Additional Enrollment Management Functions
    function sendOfferReminders() {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const pendingApplicants = applicants.filter(a => a.currentStatus === 'pending');

      showNotification(`Sending reminders to ${pendingApplicants.length} applicants with pending responses...`);
      setTimeout(() => {
        showNotification(`Email reminders sent successfully to ${pendingApplicants.length} applicants!`, 'success');
      }, 2000);
    }

    function bulkStatusUpdate() {
      const modal = document.createElement('div');
      modal.id = 'bulkStatusModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üîÑ Bulk Status Update</h3>

          <form id="bulkUpdateForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Select Program</label>
              <select id="bulkProgram" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">All Programs</option>
                <option value="Computer Science - BS">Computer Science - BS</option>
                <option value="Engineering - BS">Engineering - BS</option>
                <option value="Business Administration - BS">Business Administration - BS</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Current Status</label>
              <select id="currentStatus" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">Any Status</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="declined">Declined</option>
                <option value="deferred">Deferred</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">New Status</label>
              <select id="newStatus" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">Select New Status</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="declined">Declined</option>
                <option value="deferred">Deferred</option>
              </select>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('bulkStatusModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Update Status</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('bulkUpdateForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const program = document.getElementById('bulkProgram').value;
        const currentStatus = document.getElementById('currentStatus').value;
        const newStatus = document.getElementById('newStatus').value;

        const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
        let updatedCount = 0;

        applicants.forEach(applicant => {
          let shouldUpdate = true;

          if (program && applicant.program !== program) shouldUpdate = false;
          if (currentStatus && applicant.currentStatus !== currentStatus) shouldUpdate = false;

          if (shouldUpdate) {
            applicant.currentStatus = newStatus;
            applicant.lastModified = new Date().toISOString();
            updatedCount++;
          }
        });

        localStorage.setItem(ENROLLMENT_STORAGE.applicants, JSON.stringify(applicants));

        closeModal('bulkStatusModal');
        showNotification(`Successfully updated ${updatedCount} applicant(s) to ${newStatus} status!`, 'success');
        showEnrollmentTab('offers');
      });
    }

    function viewApplicantDetails(applicantId) {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const applicant = applicants.find(a => a.id === applicantId);

      if (!applicant) {
        showNotification('Applicant not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'applicantDetailsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üë§ Applicant Details</h3>

          <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Full Name</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.name}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Email</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.email}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Program</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.program}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Status</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.currentStatus || applicant.status}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">GPA</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.gpa || 'N/A'}</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Test Scores</p>
                <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.testScores || 'N/A'}</p>
              </div>
              ${applicant.offerDate ? `
                <div>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Offer Date</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">${new Date(applicant.offerDate).toLocaleDateString()}</p>
                </div>
              ` : ''}
              ${applicant.responseDeadline ? `
                <div>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Response Deadline</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">${new Date(applicant.responseDeadline).toLocaleDateString()}</p>
                </div>
              ` : ''}
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="closeModal('applicantDetailsModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
            <button onclick="editApplicantStatus('${applicant.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Edit Status</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function editApplicantStatus(applicantId) {
      closeModal('applicantDetailsModal');

      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const applicant = applicants.find(a => a.id === applicantId);

      if (!applicant) return;

      const modal = document.createElement('div');
      modal.id = 'editStatusModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">‚úèÔ∏è Edit Status - ${applicant.name}</h3>

          <form id="editStatusForm">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Current Status</label>
              <select id="newApplicantStatus" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="pending" ${applicant.currentStatus === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="confirmed" ${applicant.currentStatus === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                <option value="declined" ${applicant.currentStatus === 'declined' ? 'selected' : ''}>Declined</option>
                <option value="deferred" ${applicant.currentStatus === 'deferred' ? 'selected' : ''}>Deferred</option>
              </select>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('editStatusModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Update Status</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editStatusForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const newStatus = document.getElementById('newApplicantStatus').value;
        const applicantIndex = applicants.findIndex(a => a.id === applicantId);

        applicants[applicantIndex].currentStatus = newStatus;
        applicants[applicantIndex].lastModified = new Date().toISOString();

        localStorage.setItem(ENROLLMENT_STORAGE.applicants, JSON.stringify(applicants));

        closeModal('editStatusModal');
        showNotification(`${applicant.name}'s status updated to ${newStatus}!`, 'success');
        showEnrollmentTab('offers');
      });
    }

    function editWaitlistRank(waitlistId, applicantId) {
      const waitlists = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.waitlists) || '[]');
      const waitlist = waitlists.find(w => w.id === waitlistId);

      if (!waitlist) {
        showNotification('Waitlist not found!', 'error');
        return;
      }

      const applicantIndex = waitlist.applicants.findIndex(a => a.id === applicantId);
      if (applicantIndex === -1) {
        showNotification('Applicant not found in waitlist!', 'error');
        return;
      }

      const applicant = waitlist.applicants[applicantIndex];

      const modal = document.createElement('div');
      modal.id = 'editRankModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">‚úèÔ∏è Edit Waitlist Rank</h3>

          <form id="editRankForm">
            <div style="background: #f8fafc; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.8rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: #6b7280;">Applicant:</span>
                <span style="font-weight: 600; color: #1f2937;">${applicant.name}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: #6b7280;">Current Rank:</span>
                <span style="font-weight: 600; color: #3b82f6;">#${applicantIndex + 1}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Score:</span>
                <span style="font-weight: 600; color: #1f2937;">${applicant.priorityScore || 'N/A'}</span>
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">New Rank Position</label>
              <select id="newRank" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                ${waitlist.applicants.map((_, index) => `
                  <option value="${index + 1}" ${index === applicantIndex ? 'selected' : ''}>#${index + 1}${index < 5 ? ' ‚≠ê' : ''}</option>
                `).join('')}
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Update Priority Score</label>
              <input type="number" id="newPriorityScore" min="0" max="100" value="${applicant.priorityScore || ''}" placeholder="0-100" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Reason (Optional)</label>
              <textarea id="rankChangeReason" rows="2" placeholder="Why is this change being made?" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; resize: vertical; font-size: 0.875rem;"></textarea>
            </div>

            <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
              <p style="margin: 0; font-size: 0.8rem; color: #1e40af;">üí° Changing rank will automatically adjust other applicant positions.</p>
            </div>

            <div style="display: flex; gap: 0.75rem; justify-content: end;">
              <button type="button" onclick="closeModal('editRankModal')" style="background: #6b7280; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Update</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editRankForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const newRankPosition = parseInt(document.getElementById('newRank').value) - 1; // Convert to 0-based index
        const newPriorityScore = document.getElementById('newPriorityScore').value;
        const reason = document.getElementById('rankChangeReason').value;

        if (newRankPosition === applicantIndex) {
          if (newPriorityScore && newPriorityScore !== (applicant.priorityScore || '').toString()) {
            // Update only priority score
            applicant.priorityScore = parseInt(newPriorityScore);
          } else {
            showNotification('No changes were made', 'error');
            return;
          }
        } else {
          // Move applicant to new position
          const removedApplicant = waitlist.applicants.splice(applicantIndex, 1)[0];
          waitlist.applicants.splice(newRankPosition, 0, removedApplicant);

          // Update priority score if provided
          if (newPriorityScore) {
            removedApplicant.priorityScore = parseInt(newPriorityScore);
          }

          // Log the change
          if (reason) {
            if (!removedApplicant.rankingHistory) {
              removedApplicant.rankingHistory = [];
            }
            removedApplicant.rankingHistory.push({
              date: new Date().toISOString(),
              fromRank: applicantIndex + 1,
              toRank: newRankPosition + 1,
              reason: reason,
              changedBy: 'Enrollment System'
            });
          }
        }

        // Update the waitlist
        const waitlistIndex = waitlists.findIndex(w => w.id === waitlistId);
        waitlists[waitlistIndex] = waitlist;
        localStorage.setItem(ENROLLMENT_STORAGE.waitlists, JSON.stringify(waitlists));

        closeModal('editRankModal');
        showNotification(`${applicant.name}'s waitlist ranking updated successfully!`, 'success');

        // Refresh the waitlist tab
        showEnrollmentTab('waitlist');
      });
    }

    function updateApplicantStatus(applicantId) {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const applicant = applicants.find(a => a.id === applicantId);

      if (!applicant) {
        showNotification('Applicant not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'quickUpdateModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üîÑ Update Status - ${applicant.name}</h3>

          <form id="quickUpdateForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Current Status</label>
              <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 8px; font-weight: 500;">
                ${getStatusBadge(applicant.currentStatus || applicant.status)}
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">New Status</label>
              <select id="quickNewStatus" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">Select New Status</option>
                <option value="pending">Pending Response</option>
                <option value="confirmed">Confirmed Enrollment</option>
                <option value="declined">Declined Offer</option>
                <option value="deferred">Deferred Enrollment</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Notes (Optional)</label>
              <textarea id="statusNotes" rows="3" placeholder="Add any notes about this status change..." style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('quickUpdateModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Update Status</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('quickUpdateForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const newStatus = document.getElementById('quickNewStatus').value;
        const notes = document.getElementById('statusNotes').value;

        if (!newStatus) {
          showNotification('Please select a new status', 'error');
          return;
        }

        const applicantIndex = applicants.findIndex(a => a.id === applicantId);
        const oldStatus = applicants[applicantIndex].currentStatus || applicants[applicantIndex].status;

        applicants[applicantIndex].currentStatus = newStatus;
        applicants[applicantIndex].lastModified = new Date().toISOString();

        if (notes) {
          if (!applicants[applicantIndex].statusHistory) {
            applicants[applicantIndex].statusHistory = [];
          }
          applicants[applicantIndex].statusHistory.push({
            date: new Date().toISOString(),
            from: oldStatus,
            to: newStatus,
            notes: notes
          });
        }

        localStorage.setItem(ENROLLMENT_STORAGE.applicants, JSON.stringify(applicants));

        closeModal('quickUpdateModal');
        showNotification(`${applicant.name}'s status updated from ${oldStatus} to ${newStatus}!`, 'success');
        showEnrollmentTab('offers'); // Refresh the tab
      });
    }

    function sendIndividualReminder(applicantId) {
      const applicants = JSON.parse(localStorage.getItem(ENROLLMENT_STORAGE.applicants) || '[]');
      const applicant = applicants.find(a => a.id === applicantId);

      if (!applicant) {
        showNotification('Applicant not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'reminderModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      const daysUntilDeadline = applicant.responseDeadline ?
        Math.ceil((new Date(applicant.responseDeadline) - new Date()) / (1000 * 60 * 60 * 24)) : null;

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 8px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">üìß Send Reminder - ${applicant.name}</h3>

          <form id="reminderForm">
            <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                <div>
                  <p style="margin: 0; color: #6b7280;">Email</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937; word-break: break-word;">${applicant.email}</p>
                </div>
                <div>
                  <p style="margin: 0; color: #6b7280;">Status</p>
                  <p style="margin: 0; font-weight: 600; color: #1f2937;">${applicant.currentStatus || applicant.status}</p>
                </div>
                ${daysUntilDeadline ? `
                  <div style="grid-column: 1 / -1;">
                    <p style="margin: 0; color: #6b7280;">Days Until Deadline</p>
                    <p style="margin: 0; font-weight: 600; color: ${daysUntilDeadline <= 7 ? '#ef4444' : daysUntilDeadline <= 14 ? '#f59e0b' : '#3b82f6'};">${daysUntilDeadline} days</p>
                  </div>
                ` : ''}
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem; font-size: 0.875rem;">Reminder Type</label>
              <select id="reminderType" required style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                <option value="">Select Reminder Type</option>
                <option value="deadline">Response Deadline</option>
                <option value="status">Status Update</option>
                <option value="documents">Missing Documents</option>
                <option value="deposit">Enrollment Deposit</option>
                <option value="custom">Custom Message</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem; font-size: 0.875rem;">Priority</label>
              <select id="reminderPriority" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                <option value="normal">Normal</option>
                <option value="high">High Priority</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem; font-size: 0.875rem;">Additional Message (Optional)</label>
              <textarea id="reminderMessage" rows="3" placeholder="Add specific instructions..." style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; resize: vertical; font-size: 0.875rem;"></textarea>
            </div>

            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                <span style="color: #f59e0b;">‚ö†Ô∏è</span>
                <span style="font-weight: 600; color: #92400e;">Preview</span>
              </div>
              <p style="margin: 0; color: #92400e;">Reminder will be sent immediately and logged in communication history.</p>
            </div>

            <div style="display: flex; gap: 0.75rem; justify-content: end;">
              <button type="button" onclick="closeModal('reminderModal')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">üìß Send</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('reminderForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const reminderType = document.getElementById('reminderType').value;
        const priority = document.getElementById('reminderPriority').value;
        const message = document.getElementById('reminderMessage').value;

        if (!reminderType) {
          showNotification('Please select a reminder type', 'error');
          return;
        }

        // Log the reminder in applicant's history
        const applicantIndex = applicants.findIndex(a => a.id === applicantId);
        if (!applicants[applicantIndex].reminderHistory) {
          applicants[applicantIndex].reminderHistory = [];
        }

        applicants[applicantIndex].reminderHistory.push({
          date: new Date().toISOString(),
          type: reminderType,
          priority: priority,
          message: message || '',
          sentBy: 'Enrollment System'
        });

        applicants[applicantIndex].lastReminderSent = new Date().toISOString();

        localStorage.setItem(ENROLLMENT_STORAGE.applicants, JSON.stringify(applicants));

        closeModal('reminderModal');
        showNotification(`${reminderType} reminder sent to ${applicant.name} (${applicant.email})!`, 'success');

        // Show a more detailed success notification
        setTimeout(() => {
          showNotification(`Reminder logged in communication history with ${priority} priority`, 'success');
        }, 1500);
      });
    }

    // Initialize when document is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        // Auto-initialize enrollment data
        initializeEnrollmentData();
      });
    } else {
      initializeEnrollmentData();
    }

    // System management functions
    window.closeEnrollmentSystem = function() {
      const modal = document.getElementById('enrollmentManagementModal');
      if (modal) modal.remove();
    };

    window.toggleEnrollmentFullscreen = function() {
      const modal = document.getElementById('enrollmentManagementModal');
      const icon = document.getElementById('enrollmentFullscreenIcon');
      const text = document.getElementById('enrollmentFullscreenText');
      const isFullscreen = modal.classList.contains('fullscreen-mode');

      if (isFullscreen) {
        modal.classList.remove('fullscreen-mode');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';
        icon.textContent = '‚õ∂';
        text.textContent = 'Fullscreen';

        const innerContainer = modal.querySelector('div:first-child');
        innerContainer.style.cssText = 'background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 95vh; overflow: hidden; display: flex; flex-direction: column;';
      } else {
        modal.classList.add('fullscreen-mode');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 25000;';
        icon.textContent = '‚õó';
        text.textContent = 'Exit Fullscreen';

        const innerContainer = modal.querySelector('div:first-child');
        innerContainer.style.cssText = 'background: white; border-radius: 0; width: 100%; height: 100%; overflow: hidden; display: flex; flex-direction: column;';
      }
    };

    // ============================================
    // INTEGRATION SETTINGS FUNCTIONS
    // ============================================

    // SIS Integration Functions
    function testSISConnection() {
      showNotification('Testing SIS connection...');

      setTimeout(() => {
        const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
        if (!settings.integration) settings.integration = {};

        const isConnected = Math.random() > 0.3;
        settings.integration.sisConnected = isConnected;
        localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(settings));

        const statusElement = document.getElementById('sisStatus');
        if (statusElement) {
          statusElement.textContent = isConnected ? 'Connected' : 'Failed';
          statusElement.style.background = isConnected ? '#dcfce7' : '#fee2e2';
          statusElement.style.color = isConnected ? '#166534' : '#991b1b';
        }

        showNotification(isConnected ? 'SIS connection test successful!' : 'SIS connection test failed. Please check configuration.');
      }, 2000);
    }

    function configureSIS() {
      try {
        // Remove any existing modals first
        const existingModals = document.querySelectorAll('div[style*="position: fixed"]');
        existingModals.forEach(modal => modal.remove());

        console.log('Creating SIS configuration modal...');
        showNotification('SIS configuration panel opening...');
        const modal = document.createElement('div');
        modal.id = 'sisConfigModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üîó Configure SIS Integration</h3>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">SIS Provider</label>
            <select id="sisProvider" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="banner">Banner ERP</option>
              <option value="peoplesoft">PeopleSoft</option>
              <option value="colleague">Colleague</option>
              <option value="custom">Custom API</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Server URL</label>
            <input type="url" id="sisUrl" placeholder="https://sis.university.edu/api" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">API Key</label>
            <input type="password" id="sisApiKey" placeholder="Enter SIS API key" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="sisAutoSync">
              <span style="color: #374151; font-weight: 600;">Enable automatic data synchronization</span>
            </label>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="saveSISConfiguration()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Save Configuration</button>
          </div>
        </div>
      `;

      // Add click-to-close functionality
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });

      document.body.appendChild(modal);
      console.log('SIS modal added to DOM');
      } catch (error) {
        console.error('Error creating SIS modal:', error);
        showNotification('Error opening configuration modal. Please try again.');
      }
    }

    function saveSISConfiguration() {
      const provider = document.getElementById('sisProvider').value;
      const url = document.getElementById('sisUrl').value;
      const apiKey = document.getElementById('sisApiKey').value;
      const autoSync = document.getElementById('sisAutoSync').checked;

      if (!url || !apiKey) {
        showNotification('Please fill in all required fields.');
        return;
      }

      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      if (!settings.integration) settings.integration = {};

      settings.integration.sisProvider = provider;
      settings.integration.sisUrl = url;
      settings.integration.sisApiKey = apiKey;
      settings.integration.sisAutoSync = autoSync;
      settings.integration.sisConnected = true;

      localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(settings));

      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) modal.remove();

      showNotification('SIS configuration saved successfully!');

      const statusElement = document.getElementById('sisStatus');
      if (statusElement) {
        statusElement.textContent = 'Connected';
        statusElement.style.background = '#dcfce7';
        statusElement.style.color = '#166534';
      }
    }

    // Email Service Functions
    function setupEmailService() {
      try {
        // Remove any existing modals first
        const existingModals = document.querySelectorAll('div[style*="position: fixed"]');
        existingModals.forEach(modal => modal.remove());

        console.log('Creating email setup modal...');
        const modal = document.createElement('div');
        modal.id = 'emailSetupModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üìß Setup Email Service</h3>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Email Provider</label>
            <select id="emailProvider" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="smtp">SMTP Server</option>
              <option value="sendgrid">SendGrid</option>
              <option value="mailgun">Mailgun</option>
              <option value="ses">Amazon SES</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">SMTP Server</label>
            <input type="text" id="smtpServer" placeholder="smtp.university.edu" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Port</label>
              <input type="number" id="smtpPort" value="587" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
            </div>
            <div style="flex: 1;">
              <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1.5rem;">
                <input type="checkbox" id="smtpSSL" checked>
                <span style="color: #374151; font-weight: 600;">Use SSL/TLS</span>
              </label>
            </div>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Username</label>
            <input type="email" id="smtpUsername" placeholder="admissions@university.edu" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Password</label>
            <input type="password" id="smtpPassword" placeholder="Enter email password" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="saveEmailConfiguration()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Save & Test</button>
          </div>
        </div>
      `;

      // Add click-to-close functionality
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });

      document.body.appendChild(modal);
      console.log('Email modal added to DOM');
      } catch (error) {
        console.error('Error creating email modal:', error);
        showNotification('Error opening email setup modal. Please try again.');
      }
    }

    function saveEmailConfiguration() {
      const provider = document.getElementById('emailProvider').value;
      const server = document.getElementById('smtpServer').value;
      const port = document.getElementById('smtpPort').value;
      const ssl = document.getElementById('smtpSSL').checked;
      const username = document.getElementById('smtpUsername').value;
      const password = document.getElementById('smtpPassword').value;

      if (!server || !username || !password) {
        showNotification('Please fill in all required fields.');
        return;
      }

      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      if (!settings.integration) settings.integration = {};

      settings.integration.emailProvider = provider;
      settings.integration.smtpServer = server;
      settings.integration.smtpPort = port;
      settings.integration.smtpSSL = ssl;
      settings.integration.smtpUsername = username;
      settings.integration.emailPending = true;

      localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(settings));

      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) modal.remove();

      showNotification('Email configuration saved. Testing connection...');

      setTimeout(() => {
        testEmailService(true);
      }, 1000);
    }

    function testEmailService(fromSetup = false) {
      if (!fromSetup) {
        showNotification('Testing email service...');
      }

      setTimeout(() => {
        const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
        if (!settings.integration) settings.integration = {};

        const isConnected = Math.random() > 0.2;
        settings.integration.emailConnected = isConnected;
        settings.integration.emailPending = false;
        localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(settings));

        const statusElement = document.getElementById('emailStatus');
        if (statusElement) {
          statusElement.textContent = isConnected ? 'Connected' : 'Failed';
          statusElement.style.background = isConnected ? '#dcfce7' : '#fee2e2';
          statusElement.style.color = isConnected ? '#166534' : '#991b1b';
        }

        showNotification(isConnected ? 'Email service test successful!' : 'Email service test failed. Please check configuration.');
      }, 2000);
    }

    // Document Management Functions
    function connectDocumentSystem() {
      try {
        // Remove any existing modals first
        const existingModals = document.querySelectorAll('div[style*="position: fixed"]');
        existingModals.forEach(modal => modal.remove());

        console.log('Creating document system modal...');
        const modal = document.createElement('div');
        modal.id = 'documentSystemModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1e293b; font-size: 1.25rem;">üìÅ Connect Document Management</h3>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Document System</label>
            <select id="docProvider" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="sharepoint">Microsoft SharePoint</option>
              <option value="google">Google Drive</option>
              <option value="box">Box</option>
              <option value="dropbox">Dropbox Business</option>
              <option value="s3">Amazon S3</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Connection URL</label>
            <input type="url" id="docUrl" placeholder="https://university.sharepoint.com/sites/admissions" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Access Token</label>
            <input type="password" id="docToken" placeholder="Enter access token or API key" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Root Folder</label>
            <input type="text" id="docRoot" placeholder="/Admissions/Applications" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="docAutoUpload">
              <span style="color: #374151; font-weight: 600;">Automatically upload new documents</span>
            </label>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="saveDocumentConfiguration()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Connect</button>
          </div>
        </div>
      `;

      // Add click-to-close functionality
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });

      document.body.appendChild(modal);
      console.log('Document modal added to DOM');
      } catch (error) {
        console.error('Error creating document modal:', error);
        showNotification('Error opening document connection modal. Please try again.');
      }
    }

    function saveDocumentConfiguration() {
      const provider = document.getElementById('docProvider').value;
      const url = document.getElementById('docUrl').value;
      const token = document.getElementById('docToken').value;
      const root = document.getElementById('docRoot').value;
      const autoUpload = document.getElementById('docAutoUpload').checked;

      if (!url || !token) {
        showNotification('Please fill in all required fields.');
        return;
      }

      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      if (!settings.integration) settings.integration = {};

      settings.integration.docProvider = provider;
      settings.integration.docUrl = url;
      settings.integration.docToken = token;
      settings.integration.docRoot = root;
      settings.integration.docAutoUpload = autoUpload;
      settings.integration.documentsConnected = true;

      localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(settings));

      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) modal.remove();

      showNotification('Document system connected successfully!');

      const statusElement = document.getElementById('docStatus');
      if (statusElement) {
        statusElement.textContent = 'Connected';
        statusElement.style.background = '#dcfce7';
        statusElement.style.color = '#166534';
      }
    }

    function configureDocumentSystem() {
      // Allow configuration whether connected or not
      connectDocumentSystem();
    }

    // API Management Functions
    function regenerateAPIKey() {
      if (confirm('Are you sure you want to regenerate the API key? This will invalidate the current key.')) {
        showNotification('Generating new API key...');

        setTimeout(() => {
          const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
          if (!settings.integration) settings.integration = {};

          const newKey = 'ak_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
          settings.integration.apiKey = newKey;
          localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(settings));

          showNotification('New API key generated successfully!');
        }, 1500);
      }
    }

    function copyAPIKey() {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      const apiKey = settings.integration?.apiKey || 'ak_demo_key_1234567890abcdef';

      navigator.clipboard.writeText(apiKey).then(() => {
        showNotification('API key copied to clipboard!');
      }).catch(() => {
        showNotification('Failed to copy API key. Please copy manually.');
      });
    }

    function testAPIConnection() {
      showNotification('Testing API connection...');

      setTimeout(() => {
        const isWorking = Math.random() > 0.1;
        showNotification(isWorking ? 'API connection test successful!' : 'API connection test failed. Please check configuration.');
      }, 2000);
    }

    function viewAPILogs() {
      try {
        // Remove any existing modals first
        const existingModals = document.querySelectorAll('div[style*="position: fixed"]');
        existingModals.forEach(modal => modal.remove());

        console.log('Creating API logs modal...');
        const modal = document.createElement('div');
        modal.id = 'apiLogsModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      const logs = [
        { timestamp: new Date(Date.now() - 300000), level: 'INFO', message: 'API key authenticated successfully', endpoint: '/api/v1/auth' },
        { timestamp: new Date(Date.now() - 240000), level: 'SUCCESS', message: 'Student data synchronized', endpoint: '/api/v1/students/sync' },
        { timestamp: new Date(Date.now() - 180000), level: 'WARNING', message: 'Rate limit approaching (450/500)', endpoint: '/api/v1/applications' },
        { timestamp: new Date(Date.now() - 120000), level: 'ERROR', message: 'Email service timeout', endpoint: '/api/v1/notifications/email' },
        { timestamp: new Date(Date.now() - 60000), level: 'INFO', message: 'Document uploaded successfully', endpoint: '/api/v1/documents/upload' }
      ];

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem;">üìä API Activity Logs</h3>
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Close</button>
          </div>

          <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 0.875rem; max-height: 400px; overflow-y: auto;">
            ${logs.map(log => {
              const levelColors = {
                INFO: '#3b82f6',
                SUCCESS: '#3b82f6',
                WARNING: '#f59e0b',
                ERROR: '#ef4444'
              };

              return `
                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; border-left: 3px solid ${levelColors[log.level]};">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: ${levelColors[log.level]}; font-weight: 600;">[${log.level}]</span>
                    <span style="color: #6b7280;">${log.timestamp.toLocaleTimeString()}</span>
                  </div>
                  <div style="color: #374151;">${log.message}</div>
                  <div style="color: #6b7280; font-size: 0.8rem;">Endpoint: ${log.endpoint}</div>
                </div>
              `;
            }).join('')}
          </div>

          <div style="margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
            <p style="margin: 0; color: #1e40af; font-size: 0.875rem;">üí° Logs are automatically rotated every 7 days. Critical errors are retained for 30 days.</p>
          </div>
        </div>
      `;

      // Add click-to-close functionality
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });

      document.body.appendChild(modal);
      console.log('API logs modal added to DOM');
      } catch (error) {
        console.error('Error creating API logs modal:', error);
        showNotification('Error opening API logs. Please try again.');
      }
    }

    // ============================================
    // NOTIFICATION MANAGEMENT FUNCTIONS
    // ============================================

    // Send all pending notifications
    function sendBulkNotifications() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const pendingNotifications = decisions.filter(d => !d.notificationSent);

      if (pendingNotifications.length === 0) {
        showNotification('No pending notifications to send.');
        return;
      }

      if (!confirm(`Send ${pendingNotifications.length} pending notifications?`)) {
        return;
      }

      pendingNotifications.forEach(decision => {
        decision.notificationSent = true;
        decision.notificationDate = new Date().toISOString();
      });

      localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
      showNotification(`Successfully sent ${pendingNotifications.length} notifications!`);
      showDecisionTab('notifications');
    }

    // Preview notification before sending
    function previewNotification(decisionId) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (!decision) {
        showNotification('Decision not found.');
        return;
      }

      const template = getNotificationTemplate(decision.status);
      const personalizedContent = template.replace(/\[Student Name\]/g, decision.applicantName)
                                        .replace(/\[Program\]/g, decision.program)
                                        .replace(/\[Decision\]/g, decision.status);

      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #a78bfa); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìß</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Notification Preview</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Preview for ${decision.applicantName}</p>
          </div>

          <div style="background: #f9fafb; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
            <div style="margin-bottom: 0.75rem;">
              <strong>To:</strong> ${decision.email}<br>
              <strong>Subject:</strong> ${getNotificationSubject(decision.status)}
            </div>
            <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; white-space: pre-line;">
              ${personalizedContent}
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
            <button onclick="sendNotificationNow('${decisionId}'); this.closest('div').parentElement.remove();" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Send Now</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Schedule notification for later
    function scheduleNotification(decisionId) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (!decision) {
        showNotification('Decision not found.');
        return;
      }

      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      const now = new Date();
      const defaultDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // Tomorrow
      const dateString = defaultDate.toISOString().slice(0, 16);

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚è∞</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Schedule Notification</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Schedule notification for ${decision.applicantName}</p>
          </div>

          <form onsubmit="submitScheduleNotification(event, '${decisionId}')">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Send Date & Time</label>
              <input type="datetime-local" name="scheduleDate" required value="${dateString}" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Notification Priority</label>
              <select name="priority" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="normal">Normal Priority</option>
                <option value="high">High Priority</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>

            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 2rem;">
              <p style="margin: 0; color: #92400e; font-size: 0.875rem;">Scheduled notifications will be automatically sent at the specified time.</p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Schedule</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Submit scheduled notification
    function submitScheduleNotification(event, decisionId) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const scheduleDate = formData.get('scheduleDate');
      const priority = formData.get('priority');

      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (decision) {
        decision.scheduledRelease = scheduleDate;
        decision.notificationPriority = priority;
        localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
        showNotification('Notification scheduled successfully!');
        showDecisionTab('notifications');
      }

      event.target.closest('div').parentElement.remove();
    }

    // Send notification immediately
    function sendNotificationNow(decisionId) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (!decision) {
        showNotification('Decision not found.');
        return;
      }

      decision.notificationSent = true;
      decision.notificationDate = new Date().toISOString();
      decision.scheduledRelease = null; // Remove scheduled release if it exists

      localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
      showNotification(`Notification sent to ${decision.applicantName}!`);
      showDecisionTab('notifications');
    }

    // Resend notification
    function resendNotification(decisionId) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (!decision) {
        showNotification('Decision not found.');
        return;
      }

      if (!confirm(`Resend notification to ${decision.applicantName}?`)) {
        return;
      }

      decision.notificationDate = new Date().toISOString();
      decision.resendCount = (decision.resendCount || 0) + 1;

      localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
      showNotification(`Notification resent to ${decision.applicantName}!`);
      showDecisionTab('notifications');
    }

    // View notification details
    function viewNotificationDetails(decisionId) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (!decision) {
        showNotification('Decision not found.');
        return;
      }

      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #a78bfa); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìã</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Notification Details</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Details for ${decision.applicantName}</p>
          </div>

          <div style="space-y: 1rem;">
            <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Applicant Information</h4>
              <p style="margin: 0; color: #6b7280;"><strong>Name:</strong> ${decision.applicantName}</p>
              <p style="margin: 0; color: #6b7280;"><strong>Email:</strong> ${decision.email}</p>
              <p style="margin: 0; color: #6b7280;"><strong>Program:</strong> ${decision.program}</p>
              <p style="margin: 0; color: #6b7280;"><strong>Decision:</strong> ${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)}</p>
            </div>

            <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Notification History</h4>
              <p style="margin: 0; color: #6b7280;"><strong>Sent:</strong> ${new Date(decision.notificationDate).toLocaleString()}</p>
              <p style="margin: 0; color: #6b7280;"><strong>Times Resent:</strong> ${decision.resendCount || 0}</p>
              <p style="margin: 0; color: #6b7280;"><strong>Status:</strong> <span style="color: #3b82f6;">Delivered</span></p>
            </div>

            <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Message Content</h4>
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; white-space: pre-line; font-size: 0.875rem;">
                ${getNotificationTemplate(decision.status).replace(/\[Student Name\]/g, decision.applicantName).replace(/\[Program\]/g, decision.program).replace(/\[Decision\]/g, decision.status)}
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
            <button onclick="resendNotification('${decisionId}'); this.closest('div').parentElement.remove();" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Resend</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Get notification template based on decision status
    function getNotificationTemplate(status) {
      const templates = {
        admitted: `Dear [Student Name],

Congratulations! We are pleased to inform you that you have been admitted to the [Program] program.

Your application has been carefully reviewed, and we are impressed with your qualifications and potential. We look forward to welcoming you to our academic community.

Next steps:
1. Confirm your enrollment by the deadline
2. Submit your enrollment deposit
3. Complete any required pre-enrollment forms

If you have any questions, please don't hesitate to contact our admissions office.

Congratulations again, and we look forward to seeing you on campus!

Best regards,
Admissions Office`,

        denied: `Dear [Student Name],

Thank you for your interest in our [Program] program. After careful consideration of your application, we regret to inform you that we are unable to offer you admission at this time.

This decision was difficult to make, as we received many qualified applications. While we cannot offer you a place in this program, we encourage you to consider other opportunities that may be available.

We appreciate the time and effort you put into your application and wish you success in your future academic endeavors.

Sincerely,
Admissions Office`,

        waitlisted: `Dear [Student Name],

Thank you for your application to the [Program] program. Your application has been reviewed, and we would like to place you on our waitlist.

Being placed on the waitlist means that while we cannot offer you admission at this time, you remain under consideration should space become available.

We will notify waitlisted applicants of any developments by [Date]. In the meantime, if you have any questions or would like to provide additional information for your application, please contact our office.

Thank you for your patience, and we appreciate your continued interest in our program.

Best regards,
Admissions Office`,

        conditional: `Dear [Student Name],

We are pleased to offer you conditional admission to the [Program] program, subject to the completion of specific requirements.

Your application demonstrates strong potential, and we believe you will be successful in our program once the following conditions are met:

[Specific conditions will be listed here]

Please contact our admissions office to discuss the next steps and timeline for meeting these requirements.

We look forward to welcoming you to our program once all conditions are satisfied.

Best regards,
Admissions Office`
      };

      return templates[status] || templates.denied;
    }

    // Get notification subject based on decision status
    function getNotificationSubject(status) {
      const subjects = {
        admitted: 'Congratulations! Admission Decision',
        denied: 'Admission Decision Update',
        waitlisted: 'Admission Decision - Waitlist Status',
        conditional: 'Conditional Admission Offer'
      };

      return subjects[status] || 'Admission Decision Update';
    }

    // ============================================
    // ANALYTICS AND INSIGHTS ACTION FUNCTIONS
    // ============================================

    // Review criteria action
    function reviewCriteria() {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìã</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Review Admission Criteria</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Adjust your admission standards</p>
          </div>

          <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 2rem;">
            <p style="margin: 0; color: #1e40af; font-size: 0.875rem;">Current acceptance rate suggests reviewing criteria to ensure appropriate selectivity levels.</p>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
            <button onclick="showDecisionTab('settings'); this.closest('div').parentElement.remove();" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Go to Settings</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Check yield rates action
    function checkYieldRates() {
      showNotification('Analyzing yield rates... Feature coming soon!');
    }

    // Manage waitlist action
    function manageWaitlist() {
      showDecisionTab('decisions');
      showNotification('Switched to Decisions tab for waitlist management.');
    }

    // View predictions action
    function viewPredictions() {
      showNotification('Advanced predictions feature coming soon!');
    }

    // Scale capacity action
    function scaleCapacity() {
      showNotification('Capacity scaling recommendations sent to administration.');
    }

    // Boost recruitment action
    function boostRecruitment() {
      showNotification('Recruitment enhancement recommendations generated.');
    }

    // Optimize workflow action
    function optimizeWorkflow() {
      showDecisionTab('settings');
      showNotification('Redirected to automation settings for workflow optimization.');
    }

    // Enable AI action
    function enableAI() {
      showDecisionTab('settings');
      showNotification('AI features can be enabled in automation settings.');
    }

    // Cleanup data action
    function cleanupData() {
      showNotification('Data cleanup tools are being prepared...');
    }

    // ============================================
    // INTEGRATION AND SYSTEM FUNCTIONS
    // ============================================

    // Test SIS connection
    function testSISConnection() {
      showNotification('Testing SIS connection...');
      setTimeout(() => {
        showNotification('SIS connection test successful!');
      }, 2000);
    }

    // Configure SIS
    function configureSIS() {
      showNotification('SIS configuration panel opening...');
    }

    // Setup email service
    function setupEmailService() {
      showNotification('Email service setup wizard launching...');
    }

    // Test email
    function testEmail() {
      showNotification('Sending test email...');
      setTimeout(() => {
        showNotification('Test email sent successfully!');
      }, 1500);
    }

    // Connect document system
    function connectDocumentSystem() {
      showNotification('Connecting to document management system...');
      setTimeout(() => {
        showNotification('Document system connection established!');
      }, 2000);
    }

    // Configure documents
    function configureDocuments() {
      showNotification('Document system configuration opening...');
    }

    // ============================================
    // DECISION AND TEMPLATE FUNCTIONS
    // ============================================

    // Edit decision
    function editDecision(decisionId) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (!decision) {
        showNotification('Decision not found.');
        return;
      }

      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚úèÔ∏è</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Edit Decision</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">Update decision for ${decision.applicantName}</p>
          </div>

          <form onsubmit="submitEditDecision(event, '${decisionId}')">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Decision Status</label>
              <select name="status" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="admitted" ${decision.status === 'admitted' ? 'selected' : ''}>Admitted</option>
                <option value="denied" ${decision.status === 'denied' ? 'selected' : ''}>Denied</option>
                <option value="waitlisted" ${decision.status === 'waitlisted' ? 'selected' : ''}>Waitlisted</option>
                <option value="conditional" ${decision.status === 'conditional' ? 'selected' : ''}>Conditional</option>
              </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Notes</label>
              <textarea name="notes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; resize: vertical;" placeholder="Add any additional notes...">${decision.notes || ''}</textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Update</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Submit edit decision
    function submitEditDecision(event, decisionId) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const status = formData.get('status');
      const notes = formData.get('notes');

      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (decision) {
        decision.status = status;
        decision.notes = notes;
        decision.lastModified = new Date().toISOString();
        localStorage.setItem(DECISION_STORAGE.decisions, JSON.stringify(decisions));
        showNotification('Decision updated successfully!');
        showDecisionTab('decisions');
      }

      event.target.closest('div').parentElement.remove();
    }

    // Send notification
    function sendNotification(decisionId) {
      sendNotificationNow(decisionId);
    }

    // View history
    function viewHistory(decisionId) {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const decision = decisions.find(d => d.id === decisionId);

      if (!decision) {
        showNotification('Decision not found.');
        return;
      }

      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #a78bfa); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìä</div>
            <h3 style="margin: 0; color: #1f2937; font-size: 1.4rem;">Decision History</h3>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">History for ${decision.applicantName}</p>
          </div>

          <div style="background: #f9fafb; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151;">Decision Timeline</h4>
            <div style="space-y: 1rem;">
              <div style="border-left: 3px solid #3b82f6; padding-left: 1rem; margin-bottom: 1rem;">
                <div style="font-weight: 600; color: #374151;">Decision Made</div>
                <div style="font-size: 0.875rem; color: #6b7280;">${new Date(decision.decisionDate).toLocaleString()}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Status: ${decision.status.charAt(0).toUpperCase() + decision.status.slice(1)}</div>
              </div>
              ${decision.notificationSent ? `
                <div style="border-left: 3px solid #3b82f6; padding-left: 1rem; margin-bottom: 1rem;">
                  <div style="font-weight: 600; color: #374151;">Notification Sent</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">${new Date(decision.notificationDate).toLocaleString()}</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Resent ${decision.resendCount || 0} times</div>
                </div>
              ` : ''}
              ${decision.lastModified ? `
                <div style="border-left: 3px solid #f59e0b; padding-left: 1rem; margin-bottom: 1rem;">
                  <div style="font-weight: 600; color: #374151;">Last Modified</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">${new Date(decision.lastModified).toLocaleString()}</div>
                </div>
              ` : ''}
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // ============================================
    // THEME AND UI FUNCTIONS
    // ============================================

    // Select theme
    function selectTheme(theme) {
      updateSetting('general', 'theme', theme);
      document.querySelectorAll('[onclick*="selectTheme"]').forEach(el => {
        el.style.border = '2px solid #e5e7eb';
      });
      event.target.style.border = '2px solid #3b82f6';
      showNotification(`Theme changed to ${theme}`);
    }

    // ============================================
    // ANALYTICS REPORT FUNCTIONS
    // ============================================

    // Refresh analytics data
    function refreshAnalytics() {
      showNotification('Refreshing analytics data...');
      setTimeout(() => {
        showDecisionTab('analytics');
        showNotification('Analytics data refreshed successfully!');
      }, 1500);
    }

    // Export analytics report
    function exportAnalyticsReport() {
      const decisions = JSON.parse(localStorage.getItem(DECISION_STORAGE.decisions) || '[]');
      const analytics = calculateAdvancedAnalytics(decisions);

      const report = {
        generatedAt: new Date().toISOString(),
        summary: {
          totalDecisions: analytics.totalDecisions,
          acceptanceRate: analytics.acceptanceRate,
          decisionBreakdown: analytics.decisionBreakdown
        },
        insights: analytics.insights,
        rawData: decisions
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('Analytics report exported successfully!');
    }

    // ============================================
    // SETTINGS MANAGEMENT FUNCTIONS
    // ============================================

    // Reset settings to defaults
    function resetToDefaults() {
      if (!confirm('Are you sure you want to reset all settings to default values? This action cannot be undone.')) {
        return;
      }

      const defaultSettings = {
        general: {
          institutionName: 'University of Excellence',
          academicYear: '2025-2026',
          timeZone: 'EST',
          defaultLanguage: 'english',
          theme: 'light',
          enableAdvancedFeatures: true,
          autoArchive: true,
          decisionTimeline: 45
        },
        notifications: {
          emailEnabled: true,
          newApplications: true,
          decisionUpdates: true,
          deadlineReminders: false,
          frequency: 'daily',
          recipients: 'admin@university.edu, admissions@university.edu'
        },
        security: {
          sessionTimeout: 60,
          requireMFA: true,
          auditLog: false,
          dataRetention: 5,
          encryptData: true,
          backupData: true
        },
        automation: {
          autoRoute: true,
          autoAcknowledgments: true,
          smartPrioritization: false,
          autoDecisionThreshold: 'disabled',
          reviewPeriod: 14
        },
        integration: {
          sisEnabled: true,
          emailServiceStatus: 'pending',
          documentSystemStatus: 'disconnected',
          apiRateLimit: 500,
          enableWebhooks: true
        },
        advanced: {
          cacheDuration: 15,
          syncFrequency: '5min',
          enableCompression: true,
          logLevel: 'error',
          enableDebugMode: false,
          enablePerformanceMetrics: false
        }
      };

      localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(defaultSettings));
      showNotification('Settings reset to defaults successfully!');
      showDecisionTab('settings'); // Refresh the settings tab
    }

    // Export settings
    function exportSettings() {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      const exportData = {
        exportedAt: new Date().toISOString(),
        version: '1.0',
        applicationName: 'Flow PWA - Decision Tracking System',
        settings: settings
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `flow-settings-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('Settings exported successfully!');
    }

    // Import settings (bonus feature)
    function importSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importData = JSON.parse(e.target.result);
            if (importData.settings) {
              if (confirm('Import these settings? This will overwrite your current configuration.')) {
                localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(importData.settings));
                showNotification('Settings imported successfully!');
                showDecisionTab('settings'); // Refresh the settings tab
              }
            } else {
              showNotification('Invalid settings file format.');
            }
          } catch (error) {
            showNotification('Error reading settings file.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Universal setting value updater
    function updateSettingValue(category, key, value) {
      const settings = JSON.parse(localStorage.getItem(DECISION_STORAGE.settings) || '{}');
      if (!settings[category]) settings[category] = {};
      settings[category][key] = value;
      localStorage.setItem(DECISION_STORAGE.settings, JSON.stringify(settings));
      showNotification(`${key} updated successfully`);

      // Save system state when settings change
      saveDecisionSystemState();
    }

    // Visual theme selection helper
    function selectThemeVisual(element) {
      // Reset all theme selections
      element.parentElement.querySelectorAll('div').forEach(div => {
        div.style.border = '2px solid #e5e7eb';
      });
      // Highlight selected theme
      element.style.border = '2px solid #3b82f6';
    }

    // ============================================
    // EVALUATION SYSTEM FUNCTIONS
    // ============================================

    const EVALUATION_STORAGE = {
      rubrics: 'flow_evaluation_rubrics',
      evaluations: 'flow_evaluations',
      reviewers: 'flow_reviewers',
      applicants: 'flow_evaluation_applicants'
    };

    // Initialize evaluation data
    function initializeEvaluationData() {
      const defaultRubrics = [
        {
          id: 'rubric1',
          name: 'General Admissions Rubric',
          criteria: [
            { id: 'gpa', name: 'Academic Performance (GPA)', weight: 30, maxScore: 10, description: 'Overall academic performance and GPA' },
            { id: 'essays', name: 'Personal Essays', weight: 25, maxScore: 10, description: 'Quality and depth of personal statements' },
            { id: 'extracurricular', name: 'Extracurricular Activities', weight: 20, maxScore: 10, description: 'Leadership and involvement outside academics' },
            { id: 'recommendations', name: 'Letters of Recommendation', weight: 15, maxScore: 10, description: 'Quality and content of recommendation letters' },
            { id: 'interview', name: 'Interview Performance', weight: 10, maxScore: 10, description: 'Communication skills and personality fit' }
          ],
          createdDate: new Date().toISOString(),
          active: true
        }
      ];

      const defaultApplicants = [
        { id: 'app1', name: 'Sarah Johnson', program: 'Computer Science', gpa: 3.8, status: 'Under Review' },
        { id: 'app2', name: 'Michael Chen', program: 'Engineering', gpa: 3.9, status: 'Under Review' },
        { id: 'app3', name: 'Emma Davis', program: 'Business', gpa: 3.7, status: 'Under Review' },
        { id: 'app4', name: 'James Wilson', program: 'Liberal Arts', gpa: 3.6, status: 'Under Review' },
        { id: 'app5', name: 'Lisa Anderson', program: 'Sciences', gpa: 3.85, status: 'Under Review' }
      ];

      const defaultReviewers = [
        { id: 'rev1', name: 'Dr. Patricia Smith', department: 'Computer Science', role: 'Professor' },
        { id: 'rev2', name: 'Dr. Robert Brown', department: 'Engineering', role: 'Department Head' },
        { id: 'rev3', name: 'Prof. Maria Garcia', department: 'Admissions', role: 'Admissions Officer' },
        { id: 'rev4', name: 'Dr. John Taylor', department: 'Business', role: 'Associate Professor' }
      ];

      if (!localStorage.getItem(EVALUATION_STORAGE.rubrics)) {
        localStorage.setItem(EVALUATION_STORAGE.rubrics, JSON.stringify(defaultRubrics));
      }
      if (!localStorage.getItem(EVALUATION_STORAGE.applicants)) {
        localStorage.setItem(EVALUATION_STORAGE.applicants, JSON.stringify(defaultApplicants));
      }
      if (!localStorage.getItem(EVALUATION_STORAGE.reviewers)) {
        localStorage.setItem(EVALUATION_STORAGE.reviewers, JSON.stringify(defaultReviewers));
      }
      if (!localStorage.getItem(EVALUATION_STORAGE.evaluations)) {
        localStorage.setItem(EVALUATION_STORAGE.evaluations, JSON.stringify([]));
      }
    }

    function openEvaluationSystem() {
      showNotification('Opening Custom Evaluation System...');
      initializeEvaluationData();

      // Save system state
      localStorage.setItem('evaluation_system_open', 'true');

      const modal = document.createElement('div');
      modal.id = 'evaluationSystemModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 95vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(90, 91, 184, 0.2);">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 2rem; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="closeEvaluationSystem()" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                  <svg width="16" height="16" fill="white" style="margin-right: 0.25rem;">
                    <path d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                  </svg>
                  Back to Admissions
                </button>
                <div>
                  <h2 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Custom Evaluation & Scoring System</h2>
                  <p style="margin: 0.5rem 0 0 0; font-size: 1rem; opacity: 0.9;">Build flexible rubrics, manage multi-reviewer scoring, and analyze results</p>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="exportEvaluationData()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                  <span>üìÑ</span>
                  <span>Export Data</span>
                </button>
                <button onclick="toggleEvaluationFullscreen()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                  <span id="evaluationFullscreenIcon">‚õ∂</span>
                  <span id="evaluationFullscreenText">Fullscreen</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Navigation Tabs -->
          <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border-bottom: 1px solid rgba(59, 130, 246, 0.2); padding: 0 2rem; box-shadow: 0 1px 3px rgba(59, 130, 246, 0.1);">
            <div style="display: flex; gap: 2rem;">
              <button class="evaluation-tab active" data-tab="rubrics" onclick="showEvaluationTab('rubrics')" style="background: white; color: #3b82f6; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid #3b82f6; font-weight: 600; cursor: pointer; border-radius: 8px 8px 0 0; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);">
                üìù Rubric Builder
              </button>
              <button class="evaluation-tab" data-tab="scoring" onclick="showEvaluationTab('scoring')" style="background: rgba(59, 130, 246, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üìä Multi-Reviewer Scoring
              </button>
              <button class="evaluation-tab" data-tab="results" onclick="showEvaluationTab('results')" style="background: rgba(59, 130, 246, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üèÜ Results & Analysis
              </button>
              <button class="evaluation-tab" data-tab="comparison" onclick="showEvaluationTab('comparison')" style="background: rgba(59, 130, 246, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                ‚öñÔ∏è Side-by-Side Comparison
              </button>
              <button class="evaluation-tab" data-tab="reviewers" onclick="showEvaluationTab('reviewers')" style="background: rgba(59, 130, 246, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üë• Reviewer Management
              </button>
            </div>
          </div>

          <!-- Dynamic Content -->
          <div id="evaluationContent" style="flex: 1; overflow-y: auto; padding: 0;">
            <!-- Dynamic content will be loaded here -->
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Restore last active tab or default to rubrics
      const lastActiveTab = localStorage.getItem('evaluation_active_tab') || 'rubrics';
      showEvaluationTab(lastActiveTab);
      showNotification('Custom Evaluation System loaded successfully', 'success');
    }

    function closeEvaluationSystem() {
      const modal = document.getElementById('evaluationSystemModal');
      if (modal) {
        modal.remove();
        // Clear system state
        localStorage.removeItem('evaluation_system_open');
        showNotification('Evaluation System closed', 'success');
      }
    }

    function showEvaluationTab(tabName) {
      const content = document.getElementById('evaluationContent');
      const tabs = document.querySelectorAll('.evaluation-tab');

      // Update tab appearance
      tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = 'rgba(59, 130, 246, 0.05)';
        tab.style.borderBottom = '3px solid transparent';
        tab.style.color = '#64748b';
        tab.style.fontWeight = '500';
        tab.style.boxShadow = 'none';
      });

      const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.background = 'white';
        activeTab.style.borderBottom = '3px solid #3b82f6';
        activeTab.style.color = '#3b82f6';
        activeTab.style.fontWeight = '600';
        activeTab.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.1)';
      }

      // Save current tab state
      localStorage.setItem('evaluation_active_tab', tabName);

      // Load content based on tab
      switch (tabName) {
        case 'rubrics':
          content.innerHTML = generateRubricsTab();
          break;
        case 'scoring':
          content.innerHTML = generateScoringTab();
          break;
        case 'results':
          content.innerHTML = generateResultsTab();
          break;
        case 'comparison':
          content.innerHTML = generateComparisonTab();
          break;
        case 'reviewers':
          content.innerHTML = generateReviewersTab();
          break;
        default:
          content.innerHTML = generateRubricsTab();
      }
    }

    // ============================================
    // TAB GENERATION FUNCTIONS
    // ============================================

    function generateRubricsTab() {
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Evaluation Rubrics</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="createNewRubric()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">‚ûï Create New Rubric</button>
            </div>
          </div>

          <div style="display: grid; gap: 1.5rem;">
            ${rubrics.map(rubric => `
              <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);">
                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 1.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h4 style="margin: 0; font-size: 1.2rem; font-weight: 700;">${rubric.name}</h4>
                      <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Created: ${new Date(rubric.createdDate).toLocaleDateString()}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                      <button onclick="editRubric('${rubric.id}')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚úèÔ∏è Edit</button>
                      <button onclick="duplicateRubric('${rubric.id}')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üìã Duplicate</button>
                      <button onclick="deleteRubric('${rubric.id}')" style="background: rgba(239, 68, 68, 0.8); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üóëÔ∏è Delete</button>
                    </div>
                  </div>
                </div>

                <div style="padding: 1.5rem;">
                  <div style="display: grid; gap: 1rem;">
                    ${rubric.criteria.map(criterion => `
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="flex: 1;">
                          <h5 style="margin: 0; color: #1f2937; font-weight: 600;">${criterion.name}</h5>
                          <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${criterion.description}</p>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                          <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">${criterion.weight}%</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Weight</div>
                          </div>
                          <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #f59e0b;">${criterion.maxScore}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Max Score</div>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>

                  <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-weight: 600; color: #1f2937;">Total Weight: ${rubric.criteria.reduce((sum, c) => sum + c.weight, 0)}%</span>
                      <span style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600; ${rubric.active ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}">${rubric.active ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}</span>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function generateScoringTab() {
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Multi-Reviewer Scoring</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="assignBulkEvaluations()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üìù Assign Bulk Evaluations</button>
              <button onclick="viewEvaluationProgress()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üìä View Progress</button>
            </div>
          </div>

          <div style="display: grid; gap: 1.5rem;">
            ${applicants.map(applicant => {
              const applicantEvaluations = evaluations.filter(e => e.applicantId === applicant.id);
              const completedEvaluations = applicantEvaluations.length;
              const totalReviewers = reviewers.length;
              const progress = totalReviewers > 0 ? (completedEvaluations / totalReviewers * 100).toFixed(1) : 0;

              return `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);">
                  <div style="background: #f8fafc; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <h4 style="margin: 0; color: #1f2937; font-size: 1.1rem; font-weight: 700;">${applicant.name}</h4>
                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${applicant.program} ‚Ä¢ GPA: ${applicant.gpa}</p>
                      </div>
                      <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="text-align: center;">
                          <div style="font-size: 1.2rem; font-weight: 700; color: ${progress >= 100 ? '#3b82f6' : progress >= 50 ? '#f59e0b' : '#ef4444'};">${progress}%</div>
                          <div style="font-size: 0.75rem; color: #6b7280;">Complete</div>
                        </div>
                        <button onclick="scoreApplicant('${applicant.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">üìù Score</button>
                      </div>
                    </div>
                  </div>

                  <div style="padding: 1.5rem;">
                    <div style="display: grid; gap: 1rem;">
                      ${reviewers.map(reviewer => {
                        const evaluation = applicantEvaluations.find(e => e.reviewerId === reviewer.id);
                        const isCompleted = !!evaluation;

                        return `
                          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: ${isCompleted ? '#f0fdf4' : '#fef3c7'}; border-radius: 8px; border-left: 4px solid ${isCompleted ? '#3b82f6' : '#f59e0b'};">
                            <div>
                              <h5 style="margin: 0; color: #1f2937; font-weight: 600;">${reviewer.name}</h5>
                              <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${reviewer.department} ‚Ä¢ ${reviewer.role}</p>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                              ${isCompleted ? `
                                <div style="text-align: center;">
                                  <div style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">${evaluation.totalScore || 'N/A'}</div>
                                  <div style="font-size: 0.75rem; color: #6b7280;">Score</div>
                                </div>
                                <button onclick="viewEvaluation('${evaluation.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üëÅÔ∏è View</button>
                                <button onclick="editEvaluation('${evaluation.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚úèÔ∏è Edit</button>
                              ` : `
                                <span style="color: #92400e; font-weight: 500;">‚è≥ Pending</span>
                                <button onclick="assignEvaluation('${applicant.id}', '${reviewer.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üìù Assign</button>
                              `}
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function generateResultsTab() {
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');

      // Calculate composite scores for each applicant
      const applicantResults = applicants.map(applicant => {
        const applicantEvals = evaluations.filter(e => e.applicantId === applicant.id);
        const scores = applicantEvals.map(e => e.totalScore).filter(s => s !== undefined);
        const averageScore = scores.length > 0 ? (scores.reduce((sum, s) => sum + s, 0) / scores.length).toFixed(2) : 'N/A';
        const evaluationCount = scores.length;

        return {
          ...applicant,
          averageScore: parseFloat(averageScore) || 0,
          evaluationCount,
          hasScores: scores.length > 0
        };
      });

      // Sort by average score (highest first)
      applicantResults.sort((a, b) => (b.averageScore || 0) - (a.averageScore || 0));

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Results & Analysis</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="exportResultsData()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üìÑ Export Results</button>
              <button onclick="generateScoreReport()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üìä Full Report</button>
            </div>
          </div>

          <div style="display: grid; gap: 1.5rem;">
            ${applicantResults.map((applicant, index) => {
              const applicantEvals = evaluations.filter(e => e.applicantId === applicant.id);
              const scoreColor = applicant.averageScore >= 8 ? '#3b82f6' : applicant.averageScore >= 6 ? '#f59e0b' : '#ef4444';

              return `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);">
                  <div style="background: linear-gradient(135deg, ${scoreColor}10, ${scoreColor}05); padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: ${scoreColor}; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem;">
                          #${index + 1}
                        </div>
                        <div>
                          <h4 style="margin: 0; color: #1f2937; font-size: 1.2rem; font-weight: 700;">${applicant.name}</h4>
                          <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${applicant.program} ‚Ä¢ GPA: ${applicant.gpa}</p>
                        </div>
                      </div>
                      <div style="display: flex; gap: 2rem; align-items: center;">
                        <div style="text-align: center;">
                          <div style="font-size: 2rem; font-weight: 700; color: ${scoreColor};">${applicant.hasScores ? applicant.averageScore : 'N/A'}</div>
                          <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Avg Score</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280;">${applicant.evaluationCount}</div>
                          <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Reviews</div>
                        </div>
                        <button onclick="viewDetailedResults('${applicant.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">üìã Details</button>
                      </div>
                    </div>
                  </div>

                  ${applicant.hasScores ? `
                    <div style="padding: 1.5rem;">
                      <div style="display: grid; gap: 1rem;">
                        ${applicantEvals.map(evaluation => `
                          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div>
                              <h5 style="margin: 0; color: #1f2937; font-weight: 600;">${evaluation.reviewerName || 'Unknown Reviewer'}</h5>
                              <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">Completed: ${new Date(evaluation.completedDate).toLocaleDateString()}</p>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                              <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 700; color: ${scoreColor};">${evaluation.totalScore}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Score</div>
                              </div>
                              <button onclick="viewEvaluation('${evaluation.id}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üëÅÔ∏è View</button>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : `
                    <div style="padding: 2rem; text-align: center; color: #6b7280;">
                      <p style="margin: 0; font-size: 1.1rem;">No evaluations completed yet</p>
                      <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">Assign reviewers to begin scoring this applicant</p>
                    </div>
                  `}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function generateComparisonTab() {
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Side-by-Side Comparison</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="selectApplicantsForComparison()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üë• Select Applicants</button>
              <button onclick="exportComparisonData()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üìÑ Export Comparison</button>
            </div>
          </div>

          <div id="comparisonContent" style="min-height: 400px;">
            <div style="text-align: center; padding: 4rem; background: #f8fafc; border-radius: 12px; border: 2px dashed #d1d5db;">
              <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">‚öñÔ∏è</div>
              <h4 style="margin: 0 0 1rem 0; color: #6b7280; font-size: 1.2rem;">No Comparison Active</h4>
              <p style="margin: 0; color: #9ca3af;">Click "Select Applicants" to begin comparing candidates side-by-side</p>
              <button onclick="selectApplicantsForComparison()" style="background: #3b82f6; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 2rem;">Start Comparison</button>
            </div>
          </div>
        </div>
      `;
    }

    function generateReviewersTab() {
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Reviewer Management</h3>
            <div style="display: flex; gap: 1rem;">
              <button onclick="addNewReviewer()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">‚ûï Add Reviewer</button>
              <button onclick="importReviewers()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">üì• Import Reviewers</button>
            </div>
          </div>

          <div style="display: grid; gap: 1.5rem;">
            ${reviewers.map(reviewer => {
              const reviewerEvaluations = evaluations.filter(e => e.reviewerId === reviewer.id);
              const completedCount = reviewerEvaluations.length;
              const avgScore = reviewerEvaluations.length > 0 ?
                (reviewerEvaluations.reduce((sum, e) => sum + (e.totalScore || 0), 0) / reviewerEvaluations.length).toFixed(1) : 'N/A';

              return `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);">
                  <div style="background: #f8fafc; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;">
                          ${reviewer.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
                        </div>
                        <div>
                          <h4 style="margin: 0; color: #1f2937; font-size: 1.2rem; font-weight: 700;">${reviewer.name}</h4>
                          <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${reviewer.department} ‚Ä¢ ${reviewer.role}</p>
                        </div>
                      </div>
                      <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="text-align: center;">
                          <div style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">${completedCount}</div>
                          <div style="font-size: 0.75rem; color: #6b7280;">Reviews</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 1.2rem; font-weight: 700; color: #f59e0b;">${avgScore}</div>
                          <div style="font-size: 0.75rem; color: #6b7280;">Avg Score</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                          <button onclick="editEvaluationReviewer('${reviewer.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚úèÔ∏è Edit</button>
                          <button onclick="viewReviewerStats('${reviewer.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üìä Stats</button>
                          <button onclick="deleteReviewer('${reviewer.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üóëÔ∏è Delete</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  ${completedCount > 0 ? `
                    <div style="padding: 1.5rem;">
                      <h5 style="margin: 0 0 1rem 0; color: #1f2937;">Recent Evaluations</h5>
                      <div style="display: grid; gap: 0.75rem;">
                        ${reviewerEvaluations.slice(0, 3).map(evaluation => `
                          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 6px; border-left: 3px solid #3b82f6;">
                            <span style="font-weight: 500; color: #1f2937;">${evaluation.applicantName || 'Unknown Applicant'}</span>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                              <span style="font-weight: 700; color: #3b82f6;">${evaluation.totalScore}/10</span>
                              <span style="font-size: 0.75rem; color: #6b7280;">${new Date(evaluation.completedDate).toLocaleDateString()}</span>
                            </div>
                          </div>
                        `).join('')}
                        ${completedCount > 3 ? `
                          <div style="text-align: center; padding: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                            ...and ${completedCount - 3} more evaluations
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  ` : `
                    <div style="padding: 2rem; text-align: center; color: #6b7280;">
                      <p style="margin: 0;">No evaluations completed yet</p>
                    </div>
                  `}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    // ============================================
    // RUBRIC MANAGEMENT FUNCTIONS
    // ============================================

    function createNewRubric() {
      const modal = document.createElement('div');
      modal.id = 'newRubricModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">üìù Create New Rubric</h3>

          <form id="newRubricForm" onsubmit="saveNewRubric(event)">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Rubric Name *</label>
              <input type="text" id="rubricName" required placeholder="e.g., Graduate Admissions Rubric" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Description</label>
              <textarea id="rubricDescription" rows="2" placeholder="Brief description of this rubric's purpose..." style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; resize: vertical; font-size: 0.875rem;"></textarea>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Evaluation Criteria</label>
              <div id="criteriaContainer" style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; background: #f8fafc;">
                <div class="criterion-item" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; align-items: end; margin-bottom: 0.75rem;">
                  <input type="text" placeholder="Criterion name" class="criterion-name" style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.8rem;">
                  <input type="number" placeholder="Weight %" class="criterion-weight" min="1" max="100" style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.8rem;">
                  <input type="number" placeholder="Max Score" class="criterion-max" min="1" max="100" value="10" style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.8rem;">
                  <button type="button" onclick="removeCriterion(this)" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                </div>
              </div>
              <button type="button" onclick="addCriterion()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem; margin-top: 0.5rem;">‚ûï Add Criterion</button>
              <div id="weightTotal" style="margin-top: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #3b82f6;">Total Weight: 0%</div>
            </div>

            <div style="display: flex; gap: 0.75rem; justify-content: end; margin-top: 1rem;">
              <button type="button" onclick="closeModal('newRubricModal')" style="background: #6b7280; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Create Rubric</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Add initial criterion
      addCriterion();
      updateWeightTotal();
    }

    function addCriterion() {
      const container = document.getElementById('criteriaContainer');
      const criterionDiv = document.createElement('div');
      criterionDiv.className = 'criterion-item';
      criterionDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; align-items: end; margin-bottom: 0.75rem;';

      criterionDiv.innerHTML = `
        <input type="text" placeholder="Criterion name" class="criterion-name" style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.8rem;">
        <input type="number" placeholder="Weight %" class="criterion-weight" min="1" max="100" style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.8rem;" oninput="updateWeightTotal()">
        <input type="number" placeholder="Max Score" class="criterion-max" min="1" max="100" value="10" style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.8rem;">
        <button type="button" onclick="removeCriterion(this)" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
      `;

      container.appendChild(criterionDiv);
      updateWeightTotal();
    }

    function removeCriterion(button) {
      button.parentElement.remove();
      updateWeightTotal();
    }

    function updateWeightTotal() {
      const weights = document.querySelectorAll('.criterion-weight');
      let total = 0;
      weights.forEach(weight => {
        total += parseInt(weight.value) || 0;
      });

      const totalElement = document.getElementById('weightTotal');
      if (totalElement) {
        totalElement.textContent = `Total Weight: ${total}%`;
        totalElement.style.color = total === 100 ? '#3b82f6' : total > 100 ? '#ef4444' : '#3b82f6';
      }
    }

    function saveNewRubric(event) {
      event.preventDefault();

      const name = document.getElementById('rubricName').value;
      const description = document.getElementById('rubricDescription').value;

      const criteria = [];
      const criterionItems = document.querySelectorAll('.criterion-item');

      criterionItems.forEach((item, index) => {
        const nameInput = item.querySelector('.criterion-name');
        const weightInput = item.querySelector('.criterion-weight');
        const maxInput = item.querySelector('.criterion-max');

        if (nameInput.value && weightInput.value && maxInput.value) {
          criteria.push({
            id: `criterion_${Date.now()}_${index}`,
            name: nameInput.value,
            weight: parseInt(weightInput.value),
            maxScore: parseInt(maxInput.value),
            description: `Evaluation criterion: ${nameInput.value}`
          });
        }
      });

      const totalWeight = criteria.reduce((sum, c) => sum + c.weight, 0);

      if (totalWeight !== 100) {
        showNotification('Total weight must equal 100%', 'error');
        return;
      }

      const newRubric = {
        id: `rubric_${Date.now()}`,
        name,
        description,
        criteria,
        createdDate: new Date().toISOString(),
        active: true
      };

      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      rubrics.push(newRubric);
      localStorage.setItem(EVALUATION_STORAGE.rubrics, JSON.stringify(rubrics));

      closeModal('newRubricModal');
      showEvaluationTab('rubrics');
      showNotification('Rubric created successfully!', 'success');
    }

    // Additional Rubric Functions
    function editRubric(rubricId) {
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const rubric = rubrics.find(r => r.id === rubricId);

      if (!rubric) {
        showNotification('Rubric not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editRubricModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1.25rem;">‚úèÔ∏è Edit Rubric</h3>

          <form id="editRubricForm">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Rubric Name *</label>
              <input type="text" name="name" value="${rubric.name}" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">${rubric.description || ''}</textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Criteria</label>
              <div id="editCriteriaList">
                ${rubric.criteria.map((criteria, index) => `
                  <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 0.5rem; align-items: center;">
                      <input type="text" value="${criteria.name}" placeholder="Criteria name" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                      <input type="number" value="${criteria.weight}" min="1" max="100" placeholder="Weight %" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                      <button type="button" onclick="this.parentElement.parentElement.remove(); updateWeightTotal()" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                  </div>
                `).join('')}
              </div>
              <button type="button" onclick="addEditCriteria()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">+ Add Criteria</button>
              <div id="editWeightTotal" style="margin-top: 0.5rem; font-size: 0.875rem; color: #374151;">Total Weight: <span id="editTotalWeight">100</span>%</div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('editRubricModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Save Changes</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Add event listener for form submission
      document.getElementById('editRubricForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveEditedRubric(rubricId);
      });

      // Calculate initial total weight
      updateWeightTotal();
    }

    function addEditCriteria() {
      const criteriaList = document.getElementById('editCriteriaList');
      const newCriteria = document.createElement('div');
      newCriteria.style.cssText = 'background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #e5e7eb;';
      newCriteria.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 0.5rem; align-items: center;">
          <input type="text" placeholder="Criteria name" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
          <input type="number" min="1" max="100" placeholder="Weight %" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
          <button type="button" onclick="this.parentElement.parentElement.remove(); updateWeightTotal()" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
        </div>
      `;
      criteriaList.appendChild(newCriteria);
    }

    function updateWeightTotal() {
      const weightInputs = document.querySelectorAll('#editCriteriaList input[type="number"]');
      let total = 0;
      weightInputs.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      const totalWeightSpan = document.getElementById('editTotalWeight');
      if (totalWeightSpan) {
        totalWeightSpan.textContent = total;
        totalWeightSpan.style.color = total === 100 ? '#1d4ed8' : '#dc2626';
      }
    }

    function saveEditedRubric(rubricId) {
      const form = document.getElementById('editRubricForm');
      const formData = new FormData(form);

      const name = formData.get('name');
      const description = formData.get('description');

      if (!name.trim()) {
        showNotification('Please enter a rubric name', 'error');
        return;
      }

      // Collect criteria
      const criteriaInputs = document.querySelectorAll('#editCriteriaList > div');
      const criteria = [];
      let totalWeight = 0;

      criteriaInputs.forEach((criteriaDiv, index) => {
        const nameInput = criteriaDiv.querySelector('input[type="text"]');
        const weightInput = criteriaDiv.querySelector('input[type="number"]');

        const criteriaName = nameInput.value.trim();
        const weight = parseInt(weightInput.value) || 0;

        if (criteriaName && weight > 0) {
          criteria.push({
            id: `criteria_${Date.now()}_${index}`,
            name: criteriaName,
            weight: weight
          });
          totalWeight += weight;
        }
      });

      if (criteria.length === 0) {
        showNotification('Please add at least one criteria', 'error');
        return;
      }

      if (totalWeight !== 100) {
        showNotification('Total weight must equal 100%', 'error');
        return;
      }

      // Update rubric
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const rubricIndex = rubrics.findIndex(r => r.id === rubricId);

      if (rubricIndex !== -1) {
        rubrics[rubricIndex] = {
          ...rubrics[rubricIndex],
          name: name,
          description: description,
          criteria: criteria,
          lastModified: new Date().toISOString()
        };

        localStorage.setItem(EVALUATION_STORAGE.rubrics, JSON.stringify(rubrics));
        closeModal('editRubricModal');
        showEvaluationTab('rubrics');
        showNotification('Rubric updated successfully!', 'success');
      } else {
        showNotification('Rubric not found!', 'error');
      }
    }

    function duplicateRubric(rubricId) {
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const rubric = rubrics.find(r => r.id === rubricId);

      if (!rubric) {
        showNotification('Rubric not found!', 'error');
        return;
      }

      const duplicatedRubric = {
        ...rubric,
        id: `rubric_${Date.now()}`,
        name: `${rubric.name} (Copy)`,
        createdDate: new Date().toISOString()
      };

      rubrics.push(duplicatedRubric);
      localStorage.setItem(EVALUATION_STORAGE.rubrics, JSON.stringify(rubrics));
      showEvaluationTab('rubrics');
      showNotification(`Rubric "${rubric.name}" duplicated successfully!`, 'success');
    }

    function deleteRubric(rubricId) {
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const rubric = rubrics.find(r => r.id === rubricId);

      if (!rubric) {
        showNotification('Rubric not found!', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to delete rubric "${rubric.name}"? This action cannot be undone.`)) {
        return;
      }

      const updatedRubrics = rubrics.filter(r => r.id !== rubricId);
      localStorage.setItem(EVALUATION_STORAGE.rubrics, JSON.stringify(updatedRubrics));
      showEvaluationTab('rubrics');
      showNotification(`Rubric "${rubric.name}" deleted successfully!`, 'success');
    }

    // ============================================
    // SCORING FUNCTIONS
    // ============================================

    function viewEvaluationProgress() {
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');

      const modal = document.createElement('div');
      modal.id = 'progressModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      const totalEvaluations = applicants.length * reviewers.length;
      const completedEvaluations = evaluations.length;
      const progressPercent = totalEvaluations > 0 ? Math.round((completedEvaluations / totalEvaluations) * 100) : 0;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1.5rem 0; color: #3b82f6; font-size: 1.25rem;">üìä Evaluation Progress</h3>

          <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0;">Overall Progress</h4>
            <div style="background: rgba(255,255,255,0.2); border-radius: 8px; height: 20px; overflow: hidden; margin-bottom: 1rem;">
              <div style="background: white; height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
            </div>
            <p style="margin: 0; font-size: 1.1rem; font-weight: 600;">${completedEvaluations} of ${totalEvaluations} evaluations completed (${progressPercent}%)</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${applicants.length}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Applicants</div>
            </div>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${reviewers.length}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Reviewers</div>
            </div>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${rubrics.length}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Rubrics</div>
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="closeModal('progressModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function assignEvaluation(applicantId, reviewerId) {
      const modal = document.createElement('div');
      modal.id = 'assignModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');

      const applicant = applicants.find(a => a.id === applicantId);
      const reviewer = reviewers.find(r => r.id === reviewerId);

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1.25rem;">üìù Assign Evaluation</h3>

          <form id="assignForm">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Applicant</label>
              <input type="text" value="${applicant ? applicant.name : 'Unknown'}" disabled style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb;">
              <input type="hidden" name="applicantId" value="${applicantId}">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Reviewer</label>
              <input type="text" value="${reviewer ? reviewer.name : 'Unknown'}" disabled style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb;">
              <input type="hidden" name="reviewerId" value="${reviewerId}">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Rubric *</label>
              <select name="rubricId" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="">Select a rubric...</option>
                ${rubrics.map(rubric => `<option value="${rubric.id}">${rubric.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Due Date</label>
              <input type="date" name="dueDate" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Priority</label>
              <select name="priority" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="normal">Normal</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('assignModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Assign</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('assignForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const assignment = {
          id: 'assign_' + Date.now(),
          applicantId: formData.get('applicantId'),
          reviewerId: formData.get('reviewerId'),
          rubricId: formData.get('rubricId'),
          dueDate: formData.get('dueDate'),
          priority: formData.get('priority'),
          status: 'assigned',
          createdAt: new Date().toISOString()
        };

        const assignments = JSON.parse(localStorage.getItem('evaluation_assignments') || '[]');
        assignments.push(assignment);
        localStorage.setItem('evaluation_assignments', JSON.stringify(assignments));

        closeModal('assignModal');
        showNotification('Evaluation assigned successfully!', 'success');
        showEvaluationTab('scoring');
      });
    }

    function selectApplicantsForComparison() {
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');

      const modal = document.createElement('div');
      modal.id = 'compareModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1.25rem;">üë• Select Applicants for Comparison</h3>

          <form id="compareForm">
            <div style="margin-bottom: 1rem;">
              <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Select 2-5 applicants to compare their evaluation scores side by side.</p>

              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                ${applicants.map(applicant => {
                  const applicantEvaluations = evaluations.filter(e => e.applicantId === applicant.id);
                  const avgScore = applicantEvaluations.length > 0
                    ? (applicantEvaluations.reduce((sum, e) => sum + e.totalScore, 0) / applicantEvaluations.length).toFixed(1)
                    : 'N/A';

                  return `
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                      <input type="checkbox" name="applicants" value="${applicant.id}" style="cursor: pointer;">
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937;">${applicant.name}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">${applicant.program} ‚Ä¢ Avg Score: ${avgScore}</div>
                      </div>
                    </label>
                  `;
                }).join('')}
              </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('compareModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Compare Selected</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('compareForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const selectedIds = formData.getAll('applicants');

        if (selectedIds.length < 2) {
          showNotification('Please select at least 2 applicants to compare', 'error');
          return;
        }

        if (selectedIds.length > 5) {
          showNotification('Please select no more than 5 applicants to compare', 'error');
          return;
        }

        closeModal('compareModal');
        showComparisonResults(selectedIds);
      });
    }

    function showComparisonResults(applicantIds) {
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');

      const selectedApplicants = applicants.filter(a => applicantIds.includes(a.id));

      const modal = document.createElement('div');
      modal.id = 'comparisonResultsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 900px; width: 95%; max-height: 85vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: #3b82f6; font-size: 1.25rem;">üìä Applicant Comparison</h3>
            <button onclick="exportComparisonData()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üì• Export</button>
          </div>

          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
              <thead>
                <tr style="background: #f8fafc;">
                  <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">Applicant</th>
                  ${selectedApplicants.map(applicant => `<th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">${applicant.name}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 0.75rem; border: 1px solid #e5e7eb; font-weight: 600;">Program</td>
                  ${selectedApplicants.map(applicant => `<td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">${applicant.program}</td>`).join('')}
                </tr>
                <tr>
                  <td style="padding: 0.75rem; border: 1px solid #e5e7eb; font-weight: 600;">Average Score</td>
                  ${selectedApplicants.map(applicant => {
                    const applicantEvals = evaluations.filter(e => e.applicantId === applicant.id);
                    const avgScore = applicantEvals.length > 0
                      ? (applicantEvals.reduce((sum, e) => sum + e.totalScore, 0) / applicantEvals.length).toFixed(1)
                      : 'N/A';
                    return `<td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: ${avgScore === 'N/A' ? '#6b7280' : '#1d4ed8'};">${avgScore}</td>`;
                  }).join('')}
                </tr>
                <tr>
                  <td style="padding: 0.75rem; border: 1px solid #e5e7eb; font-weight: 600;">Evaluations Count</td>
                  ${selectedApplicants.map(applicant => {
                    const count = evaluations.filter(e => e.applicantId === applicant.id).length;
                    return `<td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">${count}</td>`;
                  }).join('')}
                </tr>
              </tbody>
            </table>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
            <button onclick="closeModal('comparisonResultsModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function addNewReviewer() {
      const modal = document.createElement('div');
      modal.id = 'addReviewerModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1.25rem;">‚ûï Add New Reviewer</h3>

          <form id="addReviewerForm">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Name *</label>
              <input type="text" name="name" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Email *</label>
              <input type="email" name="email" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Department</label>
              <input type="text" name="department" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Expertise Areas</label>
              <input type="text" name="expertise" placeholder="e.g., Computer Science, Mathematics" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Max Evaluations per Week</label>
              <input type="number" name="maxEvaluations" value="10" min="1" max="50" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('addReviewerModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Add Reviewer</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('addReviewerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const reviewer = {
          id: 'reviewer_' + Date.now(),
          name: formData.get('name'),
          email: formData.get('email'),
          department: formData.get('department'),
          expertise: formData.get('expertise').split(',').map(s => s.trim()).filter(s => s),
          maxEvaluations: parseInt(formData.get('maxEvaluations')),
          completedEvaluations: 0,
          averageScore: 0,
          status: 'active',
          joinedAt: new Date().toISOString()
        };

        const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
        reviewers.push(reviewer);
        localStorage.setItem(EVALUATION_STORAGE.reviewers, JSON.stringify(reviewers));

        closeModal('addReviewerModal');
        showNotification('Reviewer added successfully!', 'success');
        showEvaluationTab('reviewers');
      });
    }

    function viewReviewerStats(reviewerId) {
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const reviewer = reviewers.find(r => r.id === reviewerId);

      if (!reviewer) {
        showNotification('Reviewer not found!', 'error');
        return;
      }

      const reviewerEvaluations = evaluations.filter(e => e.reviewerId === reviewerId);
      const avgScore = reviewerEvaluations.length > 0
        ? (reviewerEvaluations.reduce((sum, e) => sum + e.totalScore, 0) / reviewerEvaluations.length).toFixed(1)
        : 'N/A';

      const modal = document.createElement('div');
      modal.id = 'reviewerStatsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1.25rem;">üìä ${reviewer.name} - Statistics</h3>

          <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0;">Performance Overview</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <div style="font-size: 1.5rem; font-weight: bold;">${reviewerEvaluations.length}</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">Completed</div>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: bold;">${avgScore}</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">Avg Score</div>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.75rem 0; color: #374151;">Details</h4>
            <div style="font-size: 0.875rem; line-height: 1.6;">
              <div style="margin-bottom: 0.5rem;"><strong>Email:</strong> ${reviewer.email}</div>
              <div style="margin-bottom: 0.5rem;"><strong>Department:</strong> ${reviewer.department || 'Not specified'}</div>
              <div style="margin-bottom: 0.5rem;"><strong>Expertise:</strong> ${reviewer.expertise ? reviewer.expertise.join(', ') : 'Not specified'}</div>
              <div style="margin-bottom: 0.5rem;"><strong>Max Evaluations:</strong> ${reviewer.maxEvaluations || 'Not set'}</div>
              <div style="margin-bottom: 0.5rem;"><strong>Status:</strong> ${reviewer.status || 'Active'}</div>
              <div style="margin-bottom: 0.5rem;"><strong>Joined:</strong> ${new Date(reviewer.joinedAt).toLocaleDateString()}</div>
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="editEvaluationReviewer('${reviewerId}')" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">‚úèÔ∏è Edit</button>
            <button onclick="closeModal('reviewerStatsModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function editEvaluationReviewer(reviewerId) {
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
      const reviewer = reviewers.find(r => r.id === reviewerId);

      if (!reviewer) {
        showNotification('Reviewer not found!', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editEvaluationReviewerModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1.25rem;">‚úèÔ∏è Edit Reviewer</h3>

          <form id="editEvaluationReviewerForm">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Name *</label>
              <input type="text" name="name" value="${reviewer.name}" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Email *</label>
              <input type="email" name="email" value="${reviewer.email}" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Department</label>
              <input type="text" name="department" value="${reviewer.department || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Expertise Areas</label>
              <input type="text" name="expertise" value="${reviewer.expertise ? reviewer.expertise.join(', ') : ''}" placeholder="e.g., Computer Science, Mathematics" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Max Evaluations</label>
                <input type="number" name="maxEvaluations" value="${reviewer.maxEvaluations || 10}" min="1" max="50" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Status</label>
                <select name="status" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="active" ${reviewer.status === 'active' ? 'selected' : ''}>Active</option>
                  <option value="inactive" ${reviewer.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                  <option value="on-leave" ${reviewer.status === 'on-leave' ? 'selected' : ''}>On Leave</option>
                </select>
              </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('editEvaluationReviewerModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Save Changes</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editEvaluationReviewerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
        const reviewerIndex = reviewers.findIndex(r => r.id === reviewerId);

        if (reviewerIndex !== -1) {
          reviewers[reviewerIndex] = {
            ...reviewers[reviewerIndex],
            name: formData.get('name'),
            email: formData.get('email'),
            department: formData.get('department'),
            expertise: formData.get('expertise').split(',').map(s => s.trim()).filter(s => s),
            maxEvaluations: parseInt(formData.get('maxEvaluations')),
            status: formData.get('status'),
            lastModified: new Date().toISOString()
          };

          localStorage.setItem(EVALUATION_STORAGE.reviewers, JSON.stringify(reviewers));

          closeModal('editEvaluationReviewerModal');
          closeModal('reviewerStatsModal'); // Close stats modal if open
          showNotification('Reviewer updated successfully!', 'success');
          showEvaluationTab('reviewers');
        } else {
          showNotification('Reviewer not found!', 'error');
        }
      });
    }

    function exportEvaluationData() {
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');

      const exportData = {
        exportDate: new Date().toISOString(),
        summary: {
          totalRubrics: rubrics.length,
          totalEvaluations: evaluations.length,
          totalApplicants: applicants.length,
          totalReviewers: reviewers.length
        },
        rubrics,
        evaluations,
        applicants,
        reviewers
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `evaluation-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('Evaluation data exported successfully!', 'success');
    }

    function exportComparisonData() {
      showNotification('Comparison data export feature coming soon!', 'info');
    }

    function exportResultsData() {
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');

      // Create comprehensive results data
      const resultsData = applicants.map(applicant => {
        const applicantEvaluations = evaluations.filter(e => e.applicantId === applicant.id);
        const averageScore = applicantEvaluations.length > 0
          ? applicantEvaluations.reduce((sum, e) => sum + e.totalScore, 0) / applicantEvaluations.length
          : 0;

        return {
          applicantName: applicant.name,
          applicantEmail: applicant.email,
          program: applicant.program,
          totalEvaluations: applicantEvaluations.length,
          averageScore: parseFloat(averageScore.toFixed(2)),
          evaluations: applicantEvaluations.map(evaluation => {
            const reviewer = reviewers.find(r => r.id === evaluation.reviewerId);
            const rubric = rubrics.find(r => r.id === evaluation.rubricId);
            return {
              reviewerName: reviewer ? reviewer.name : 'Unknown',
              rubricName: rubric ? rubric.name : 'Unknown',
              score: evaluation.totalScore,
              completedAt: evaluation.completedAt
            };
          })
        };
      });

      // Sort by average score (highest first)
      resultsData.sort((a, b) => b.averageScore - a.averageScore);

      const exportData = {
        exportDate: new Date().toISOString(),
        summary: {
          totalApplicants: applicants.length,
          totalEvaluations: evaluations.length,
          averageOverallScore: resultsData.length > 0
            ? parseFloat((resultsData.reduce((sum, applicant) => sum + applicant.averageScore, 0) / resultsData.length).toFixed(2))
            : 0
        },
        results: resultsData
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `evaluation-results-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('Results data exported successfully!', 'success');
    }

    function viewEvaluation(evaluationId) {
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');

      const evaluation = evaluations.find(e => e.id === evaluationId);
      if (!evaluation) {
        showNotification('Evaluation not found!', 'error');
        return;
      }

      const applicant = applicants.find(a => a.id === evaluation.applicantId);
      const reviewer = reviewers.find(r => r.id === evaluation.reviewerId);
      const rubric = rubrics.find(r => r.id === evaluation.rubricId);

      const modal = document.createElement('div');
      modal.id = 'viewEvaluationModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1.25rem;">üëÅÔ∏è View Evaluation</h3>

          <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Applicant</div>
                <div style="font-weight: 600; color: #1f2937;">${applicant ? applicant.name : 'Unknown'}</div>
              </div>
              <div>
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Reviewer</div>
                <div style="font-weight: 600; color: #1f2937;">${reviewer ? reviewer.name : 'Unknown'}</div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Rubric</div>
                <div style="font-weight: 600; color: #1f2937;">${rubric ? rubric.name : 'Unknown'}</div>
              </div>
              <div>
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Total Score</div>
                <div style="font-weight: 600; color: #1d4ed8; font-size: 1.1rem;">${evaluation.totalScore}/100</div>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.75rem 0; color: #374151;">Criteria Scores</h4>
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
              ${Object.entries(evaluation.scores || {}).map(([criteriaId, score]) => {
                const criteria = rubric && rubric.criteria ? rubric.criteria.find(c => c.id === criteriaId) : null;
                return `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #f3f4f6;">
                    <div>
                      <div style="font-weight: 600; color: #1f2937;">${criteria ? criteria.name : 'Unknown Criteria'}</div>
                      <div style="font-size: 0.875rem; color: #6b7280;">Weight: ${criteria ? criteria.weight : 'N/A'}%</div>
                    </div>
                    <div style="font-weight: 600; color: #1d4ed8;">${score}/10</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          ${evaluation.notes ? `
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 0.75rem 0; color: #374151;">Notes</h4>
              <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; border-left: 3px solid #3b82f6;">
                <p style="margin: 0; color: #374151; line-height: 1.5;">${evaluation.notes}</p>
              </div>
            </div>
          ` : ''}

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="closeModal('viewEvaluationModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function toggleEvaluationFullscreen() {
      const modal = document.getElementById('evaluationSystemModal');
      if (!modal) {
        showNotification('Evaluation system not found!', 'error');
        return;
      }

      const modalContent = modal.querySelector('div'); // The white content div
      if (!modalContent) return;

      const isFullscreen = modalContent.style.width === '100vw' || modalContent.style.width === '100%';

      const iconElement = document.getElementById('evaluationFullscreenIcon');
      const textElement = document.getElementById('evaluationFullscreenText');

      if (isFullscreen) {
        // Exit fullscreen
        modalContent.style.width = '95%';
        modalContent.style.height = '95vh';
        modalContent.style.maxWidth = '1400px';
        modalContent.style.borderRadius = '12px';

        if (iconElement) iconElement.textContent = '‚õ∂';
        if (textElement) textElement.textContent = 'Fullscreen';

        showNotification('Exited fullscreen', 'info');
      } else {
        // Enter fullscreen
        modalContent.style.width = '100vw';
        modalContent.style.height = '100vh';
        modalContent.style.maxWidth = 'none';
        modalContent.style.borderRadius = '0';

        if (iconElement) iconElement.textContent = 'üóó';
        if (textElement) textElement.textContent = 'Exit Fullscreen';

        showNotification('Entered fullscreen', 'info');
      }
    }

    function editEvaluation(evaluationId) {
      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      const evaluation = evaluations.find(e => e.id === evaluationId);

      if (!evaluation) {
        showNotification('Evaluation not found!', 'error');
        return;
      }

      // Close the view modal if open
      const viewModal = document.getElementById('viewEvaluationModal');
      if (viewModal) viewModal.remove();

      // Open scoring interface with pre-filled data
      scoreApplicant(evaluation.applicantId, evaluation.reviewerId, evaluation.rubricId, evaluation);
    }

    function importReviewers() {
      const modal = document.createElement('div');
      modal.id = 'importReviewersModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1.25rem;">üì• Import Reviewers</h3>

          <div style="margin-bottom: 1.5rem;">
            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Upload a JSON file containing reviewer data or paste CSV data below.</p>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Upload JSON File</label>
              <input type="file" id="reviewerFileInput" accept=".json" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Or Paste CSV Data</label>
              <textarea id="reviewerCsvData" rows="6" placeholder="name,email,department,expertise&#10;John Doe,john@example.com,Computer Science,Programming&#10;Jane Smith,jane@example.com,Mathematics,Statistics" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; font-size: 0.8rem;"></textarea>
            </div>

            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #0c4a6e; font-size: 0.875rem;">Expected Format:</h4>
              <ul style="margin: 0; padding-left: 1.5rem; color: #0c4a6e; font-size: 0.8rem;">
                <li>JSON: Array of objects with name, email, department, expertise fields</li>
                <li>CSV: Headers in first row (name,email,department,expertise)</li>
              </ul>
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: end;">
            <button onclick="closeModal('importReviewersModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="processReviewerImport()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Import</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Handle file upload
      document.getElementById('reviewerFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type === 'application/json') {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const data = JSON.parse(e.target.result);
              document.getElementById('reviewerCsvData').value = JSON.stringify(data, null, 2);
            } catch (error) {
              showNotification('Invalid JSON file format', 'error');
            }
          };
          reader.readAsText(file);
        }
      });
    }

    function processReviewerImport() {
      const csvData = document.getElementById('reviewerCsvData').value.trim();
      if (!csvData) {
        showNotification('Please provide data to import', 'error');
        return;
      }

      try {
        let reviewersToAdd = [];

        // Try to parse as JSON first
        if (csvData.startsWith('[') || csvData.startsWith('{')) {
          const jsonData = JSON.parse(csvData);
          reviewersToAdd = Array.isArray(jsonData) ? jsonData : [jsonData];
        } else {
          // Parse as CSV
          const lines = csvData.split('\n').filter(line => line.trim());
          if (lines.length < 2) {
            throw new Error('CSV must have at least a header row and one data row');
          }

          const headers = lines[0].split(',').map(h => h.trim());
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim());
            const reviewer = {};
            headers.forEach((header, index) => {
              reviewer[header] = values[index] || '';
            });
            reviewersToAdd.push(reviewer);
          }
        }

        // Validate and add reviewers
        const existingReviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
        let addedCount = 0;

        reviewersToAdd.forEach(reviewerData => {
          if (reviewerData.name && reviewerData.email) {
            // Check for duplicates
            const exists = existingReviewers.some(r => r.email === reviewerData.email);
            if (!exists) {
              const reviewer = {
                id: 'reviewer_' + Date.now() + '_' + addedCount,
                name: reviewerData.name,
                email: reviewerData.email,
                department: reviewerData.department || '',
                expertise: reviewerData.expertise ? reviewerData.expertise.split(';').map(s => s.trim()) : [],
                maxEvaluations: parseInt(reviewerData.maxEvaluations) || 10,
                completedEvaluations: 0,
                averageScore: 0,
                status: 'active',
                joinedAt: new Date().toISOString()
              };
              existingReviewers.push(reviewer);
              addedCount++;
            }
          }
        });

        localStorage.setItem(EVALUATION_STORAGE.reviewers, JSON.stringify(existingReviewers));

        closeModal('importReviewersModal');
        showNotification(`Successfully imported ${addedCount} reviewers!`, 'success');
        showEvaluationTab('reviewers');

      } catch (error) {
        showNotification('Error importing reviewers: ' + error.message, 'error');
      }
    }

    function deleteReviewer(reviewerId) {
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
      const reviewer = reviewers.find(r => r.id === reviewerId);

      if (!reviewer) {
        showNotification('Reviewer not found!', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to delete reviewer "${reviewer.name}"? This action cannot be undone.`)) {
        return;
      }

      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');

      // Check if reviewer has any evaluations
      const hasEvaluations = evaluations.some(e => e.reviewerId === reviewerId);
      if (hasEvaluations) {
        if (!confirm('This reviewer has existing evaluations. Deleting will remove their evaluation data as well. Continue?')) {
          return;
        }
        // Remove evaluations by this reviewer
        const filteredEvaluations = evaluations.filter(e => e.reviewerId !== reviewerId);
        localStorage.setItem(EVALUATION_STORAGE.evaluations, JSON.stringify(filteredEvaluations));
      }

      // Remove reviewer
      const filteredReviewers = reviewers.filter(r => r.id !== reviewerId);
      localStorage.setItem(EVALUATION_STORAGE.reviewers, JSON.stringify(filteredReviewers));

      showNotification(`Reviewer "${reviewer.name}" deleted successfully!`, 'success');
      showEvaluationTab('reviewers');
    }

    function assignBulkEvaluations() {
      const modal = document.createElement('div');
      modal.id = 'bulkAssignModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const reviewers = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]');
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">üìù Bulk Assign Evaluations</h3>

          <form id="bulkAssignForm" onsubmit="saveBulkAssignments(event)">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Select Rubric *</label>
              <select id="selectedRubric" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                <option value="">Choose rubric...</option>
                ${rubrics.filter(r => r.active).map(rubric => `
                  <option value="${rubric.id}">${rubric.name}</option>
                `).join('')}
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Select Applicants</label>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.5rem;">
                ${applicants.map(applicant => `
                  <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer;">
                    <input type="checkbox" class="applicant-checkbox" value="${applicant.id}" style="cursor: pointer;">
                    <span style="font-size: 0.875rem;">${applicant.name} (${applicant.program})</span>
                  </label>
                `).join('')}
              </div>
              <button type="button" onclick="toggleAllApplicants()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 0.5rem;">Select All</button>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Select Reviewers</label>
              <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.5rem;">
                ${reviewers.map(reviewer => `
                  <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer;">
                    <input type="checkbox" class="reviewer-checkbox" value="${reviewer.id}" style="cursor: pointer;">
                    <span style="font-size: 0.875rem;">${reviewer.name} (${reviewer.department})</span>
                  </label>
                `).join('')}
              </div>
              <button type="button" onclick="toggleAllReviewers()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 0.5rem;">Select All</button>
            </div>

            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
              <p style="margin: 0; font-size: 0.8rem; color: #1e40af;">üí° This will create evaluation assignments for each selected applicant-reviewer combination.</p>
            </div>

            <div style="display: flex; gap: 0.75rem; justify-content: end;">
              <button type="button" onclick="closeModal('bulkAssignModal')" style="background: #6b7280; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Create Assignments</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function toggleAllApplicants() {
      const checkboxes = document.querySelectorAll('.applicant-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    function toggleAllReviewers() {
      const checkboxes = document.querySelectorAll('.reviewer-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    function saveBulkAssignments(event) {
      event.preventDefault();

      const rubricId = document.getElementById('selectedRubric').value;
      const selectedApplicants = Array.from(document.querySelectorAll('.applicant-checkbox:checked')).map(cb => cb.value);
      const selectedReviewers = Array.from(document.querySelectorAll('.reviewer-checkbox:checked')).map(cb => cb.value);

      if (!rubricId || selectedApplicants.length === 0 || selectedReviewers.length === 0) {
        showNotification('Please select rubric, applicants, and reviewers', 'error');
        return;
      }

      const assignments = [];
      selectedApplicants.forEach(applicantId => {
        selectedReviewers.forEach(reviewerId => {
          assignments.push({
            id: `assignment_${Date.now()}_${Math.random()}`,
            applicantId,
            reviewerId,
            rubricId,
            status: 'pending',
            createdDate: new Date().toISOString()
          });
        });
      });

      // Store assignments (you could extend this to save to a separate storage)
      const existingEvaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      // For now, we'll just show success - in a real system you'd create pending evaluations

      closeModal('bulkAssignModal');
      showNotification(`Created ${assignments.length} evaluation assignments!`, 'success');
      showEvaluationTab('scoring');
    }

    function scoreApplicant(applicantId) {
      const applicants = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]');
      const rubrics = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.rubrics) || '[]');
      const applicant = applicants.find(a => a.id === applicantId);
      const activeRubric = rubrics.find(r => r.active);

      if (!applicant || !activeRubric) {
        showNotification('Applicant or active rubric not found', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'scoreApplicantModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';

      modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 480px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">üìù Score Applicant</h3>

          <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
            <h4 style="margin: 0; color: #1f2937;">${applicant.name}</h4>
            <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${applicant.program} ‚Ä¢ GPA: ${applicant.gpa}</p>
          </div>

          <form id="scoreForm" onsubmit="saveApplicantScore(event, '${applicantId}', '${activeRubric.id}')">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Reviewer *</label>
              <select id="reviewerId" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                <option value="">Select reviewer...</option>
                ${JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]').map(reviewer => `
                  <option value="${reviewer.id}">${reviewer.name} (${reviewer.department})</option>
                `).join('')}
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <h5 style="margin: 0 0 0.5rem 0; color: #1f2937;">Evaluation Criteria</h5>
              ${activeRubric.criteria.map(criterion => `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 6px; border-left: 3px solid #3b82f6;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                    <label style="font-weight: 600; color: #374151; font-size: 0.875rem;">${criterion.name} (${criterion.weight}%)</label>
                    <span style="font-size: 0.8rem; color: #6b7280;">Max: ${criterion.maxScore}</span>
                  </div>
                  <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.8rem;">${criterion.description}</p>
                  <input type="number" class="criterion-score" data-criterion="${criterion.id}" data-weight="${criterion.weight}" min="0" max="${criterion.maxScore}" step="0.1" placeholder="Score" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem;" oninput="calculateTotalScore()">
                </div>
              `).join('')}
            </div>

            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: #1e40af;">Total Weighted Score:</span>
                <span id="totalScore" style="font-size: 1.2rem; font-weight: 700; color: #1e40af;">0.0</span>
              </div>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.4rem; font-size: 0.875rem;">Comments (Optional)</label>
              <textarea id="evaluationComments" rows="3" placeholder="Additional notes about this evaluation..." style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; resize: vertical; font-size: 0.875rem;"></textarea>
            </div>

            <div style="display: flex; gap: 0.75rem; justify-content: end;">
              <button type="button" onclick="closeModal('scoreApplicantModal')" style="background: #6b7280; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Save Score</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function calculateTotalScore() {
      const scoreInputs = document.querySelectorAll('.criterion-score');
      let totalScore = 0;

      scoreInputs.forEach(input => {
        const score = parseFloat(input.value) || 0;
        const weight = parseFloat(input.dataset.weight) || 0;
        totalScore += (score * weight) / 100;
      });

      const totalElement = document.getElementById('totalScore');
      if (totalElement) {
        totalElement.textContent = totalScore.toFixed(1);
      }
    }

    function saveApplicantScore(event, applicantId, rubricId) {
      event.preventDefault();

      const reviewerId = document.getElementById('reviewerId').value;
      const comments = document.getElementById('evaluationComments').value;

      if (!reviewerId) {
        showNotification('Please select a reviewer', 'error');
        return;
      }

      const scores = {};
      let totalScore = 0;
      const scoreInputs = document.querySelectorAll('.criterion-score');

      scoreInputs.forEach(input => {
        const criterionId = input.dataset.criterion;
        const score = parseFloat(input.value) || 0;
        const weight = parseFloat(input.dataset.weight) || 0;
        scores[criterionId] = score;
        totalScore += (score * weight) / 100;
      });

      const evaluation = {
        id: `evaluation_${Date.now()}`,
        applicantId,
        reviewerId,
        rubricId,
        scores,
        totalScore: parseFloat(totalScore.toFixed(1)),
        comments,
        completedDate: new Date().toISOString(),
        applicantName: JSON.parse(localStorage.getItem(EVALUATION_STORAGE.applicants) || '[]').find(a => a.id === applicantId)?.name,
        reviewerName: JSON.parse(localStorage.getItem(EVALUATION_STORAGE.reviewers) || '[]').find(r => r.id === reviewerId)?.name
      };

      const evaluations = JSON.parse(localStorage.getItem(EVALUATION_STORAGE.evaluations) || '[]');
      evaluations.push(evaluation);
      localStorage.setItem(EVALUATION_STORAGE.evaluations, JSON.stringify(evaluations));

      closeModal('scoreApplicantModal');
      showEvaluationTab('scoring');
      showNotification('Evaluation saved successfully!', 'success');
    }

    // ============================================
    // STATE PERSISTENCE FOR EVALUATION SYSTEM
    // ============================================

    function restoreEvaluationSystemState() {
      const isSystemOpen = localStorage.getItem('evaluation_system_open') === 'true';
      if (isSystemOpen) {
        // Add a slight delay to ensure page is fully loaded
        setTimeout(() => {
          openEvaluationSystem();
        }, 500);
      }
    }

    // Restore evaluation system state on page load
    document.addEventListener('DOMContentLoaded', restoreEvaluationSystemState);

    // Handle page refresh/reload to maintain state
    window.addEventListener('beforeunload', function() {
      // State is already saved in individual functions, no additional action needed
    });

    // ============================================
    // DOCUMENT VERIFICATION SYSTEM
    // ============================================

    const DOCUMENT_STORAGE = {
      applicants: 'flow_doc_applicants',
      documents: 'flow_documents',
      verifications: 'flow_verifications',
      auditLogs: 'flow_audit_logs',
      requirements: 'flow_doc_requirements'
    };

    function initializeDocumentData() {
      // Initialize document requirements
      if (!localStorage.getItem(DOCUMENT_STORAGE.requirements)) {
        const defaultRequirements = [
          {
            id: 'req_1',
            name: 'Official Transcripts',
            type: 'transcript',
            required: true,
            formats: ['.pdf', '.doc', '.docx'],
            maxSize: 10, // MB
            description: 'Official academic transcripts from all institutions attended'
          },
          {
            id: 'req_2',
            name: 'Government ID',
            type: 'identification',
            required: true,
            formats: ['.pdf', '.jpg', '.png'],
            maxSize: 5,
            description: 'Valid government-issued photo identification'
          },
          {
            id: 'req_3',
            name: 'English Proficiency Certificate',
            type: 'certificate',
            required: true,
            formats: ['.pdf'],
            maxSize: 5,
            description: 'TOEFL, IELTS, or equivalent English proficiency certification'
          },
          {
            id: 'req_4',
            name: 'Letter of Recommendation',
            type: 'recommendation',
            required: true,
            formats: ['.pdf', '.doc', '.docx'],
            maxSize: 5,
            description: 'Letter of recommendation from academic or professional reference'
          },
          {
            id: 'req_5',
            name: 'Personal Statement',
            type: 'essay',
            required: true,
            formats: ['.pdf', '.doc', '.docx'],
            maxSize: 5,
            description: 'Personal statement or statement of purpose'
          }
        ];
        localStorage.setItem(DOCUMENT_STORAGE.requirements, JSON.stringify(defaultRequirements));
      }

      // Initialize sample applicants if none exist
      if (!localStorage.getItem(DOCUMENT_STORAGE.applicants)) {
        const sampleApplicants = [
          {
            id: 'app_001',
            name: 'Sarah Johnson',
            email: 'sarah.johnson@email.com',
            program: 'Computer Science',
            applicationDate: '2024-01-15',
            status: 'pending_documents'
          },
          {
            id: 'app_002',
            name: 'Michael Chen',
            email: 'michael.chen@email.com',
            program: 'Engineering',
            applicationDate: '2024-01-18',
            status: 'documents_complete'
          },
          {
            id: 'app_003',
            name: 'Emily Rodriguez',
            email: 'emily.rodriguez@email.com',
            program: 'Business Administration',
            applicationDate: '2024-01-20',
            status: 'missing_documents'
          }
        ];
        localStorage.setItem(DOCUMENT_STORAGE.applicants, JSON.stringify(sampleApplicants));
      }

      // Initialize sample documents
      if (!localStorage.getItem(DOCUMENT_STORAGE.documents)) {
        const sampleDocuments = [
          {
            id: 'doc_001',
            applicantId: 'app_001',
            requirementId: 'req_1',
            fileName: 'transcript_sarah_johnson.pdf',
            fileSize: 2.5,
            uploadDate: '2024-01-16T10:30:00Z',
            status: 'verified',
            verifiedBy: 'admin@institution.edu',
            verifiedDate: '2024-01-17T14:20:00Z'
          },
          {
            id: 'doc_002',
            applicantId: 'app_001',
            requirementId: 'req_2',
            fileName: 'id_sarah_johnson.pdf',
            fileSize: 1.2,
            uploadDate: '2024-01-16T10:35:00Z',
            status: 'pending',
            verifiedBy: null,
            verifiedDate: null
          },
          {
            id: 'doc_003',
            applicantId: 'app_002',
            requirementId: 'req_1',
            fileName: 'transcript_michael_chen.pdf',
            fileSize: 3.1,
            uploadDate: '2024-01-19T09:15:00Z',
            status: 'verified',
            verifiedBy: 'admin@institution.edu',
            verifiedDate: '2024-01-19T16:45:00Z'
          }
        ];
        localStorage.setItem(DOCUMENT_STORAGE.documents, JSON.stringify(sampleDocuments));
      }

      // Initialize audit logs if none exist
      if (!localStorage.getItem(DOCUMENT_STORAGE.auditLogs)) {
        localStorage.setItem(DOCUMENT_STORAGE.auditLogs, JSON.stringify([]));
      }
    }

    function openDocumentVerificationSystem() {
      showNotification('Opening Document Verification System...');
      initializeDocumentData();

      // Save system state
      localStorage.setItem('document_system_open', 'true');

      const modal = document.createElement('div');
      modal.id = 'documentVerificationModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 95vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 2rem; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="closeDocumentVerificationSystem()" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'" title="Close and return to admissions"
                  <svg width="16" height="16" fill="white" style="margin-right: 0.25rem;">
                    <path d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                  </svg>
                  Back to Admissions
                </button>
                <div>
                  <h2 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Document Verification & Compliance</h2>
                  <p style="margin: 0.5rem 0 0 0; font-size: 1rem; opacity: 0.9;">Verify documents, track compliance, and maintain audit trails</p>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="exportComplianceReport()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                  <span>üìä</span>
                  <span>Export Report</span>
                </button>
                <button onclick="toggleDocumentFullscreen()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                  <span id="documentFullscreenIcon">‚õ∂</span>
                  <span id="documentFullscreenText">Fullscreen</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Tab Navigation -->
          <div style="background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 0;">
            <div style="display: flex; overflow-x: auto;">
              <button class="document-tab active" data-tab="dashboard" onclick="showDocumentTab('dashboard')" style="background: white; color: #3b82f6; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid #3b82f6; font-weight: 600; cursor: pointer; border-radius: 8px 8px 0 0; box-shadow: 0 2px 4px rgba(34, 197, 94, 0.1);">
                üìä Compliance Dashboard
              </button>
              <button class="document-tab" data-tab="applicants" onclick="showDocumentTab('applicants')" style="background: rgba(34, 197, 94, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üë• Applicant Documents
              </button>
              <button class="document-tab" data-tab="verification" onclick="showDocumentTab('verification')" style="background: rgba(34, 197, 94, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                ‚úÖ Document Verification
              </button>
              <button class="document-tab" data-tab="requirements" onclick="showDocumentTab('requirements')" style="background: rgba(34, 197, 94, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üìã Requirements Setup
              </button>
              <button class="document-tab" data-tab="audit" onclick="showDocumentTab('audit')" style="background: rgba(34, 197, 94, 0.05); color: #64748b; border: none; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                üìù Audit Logs
              </button>
            </div>
          </div>

          <!-- Content Area -->
          <div id="documentContent" style="flex: 1; overflow-y: auto; padding: 2rem; background: #fafafa;">
            <!-- Content will be dynamically loaded here -->
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Restore last active tab or default to dashboard
      const lastActiveTab = localStorage.getItem('document_active_tab') || 'dashboard';
      showDocumentTab(lastActiveTab);
      showNotification('Document Verification System loaded successfully', 'success');
    }

    function closeDocumentVerificationSystem() {
      const modal = document.getElementById('documentVerificationModal');
      if (modal) {
        modal.remove();
        // Clear system state
        localStorage.removeItem('document_system_open');
        showNotification('Document Verification System closed', 'success');
      }
    }

    function showDocumentTab(tabName) {
      const content = document.getElementById('documentContent');
      const tabs = document.querySelectorAll('.document-tab');

      // Update tab appearance
      tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = 'rgba(59, 130, 246, 0.05)';
        tab.style.borderBottom = '3px solid transparent';
        tab.style.color = '#64748b';
        tab.style.fontWeight = '500';
        tab.style.boxShadow = 'none';
      });

      const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.background = 'white';
        activeTab.style.borderBottom = '3px solid #3b82f6';
        activeTab.style.color = '#3b82f6';
        activeTab.style.fontWeight = '600';
        activeTab.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.1)';
      }

      // Save current tab state
      localStorage.setItem(STATE_KEYS.activeTab, tabName);
      if (typeof saveSystemState === 'function') {
        saveSystemState();
      }

      // Load content based on tab
      switch (tabName) {
        case 'dashboard':
          content.innerHTML = generateComplianceDashboard();
          break;
        case 'applicants':
          content.innerHTML = generateApplicantDocumentsTab();
          break;
        case 'verification':
          content.innerHTML = generateDocumentVerificationTab();
          break;
        case 'requirements':
          content.innerHTML = generateRequirementsTab();
          break;
        case 'audit':
          content.innerHTML = generateAuditLogsTab();
          break;
        default:
          content.innerHTML = generateComplianceDashboard();
      }
    }

    function generateComplianceDashboard() {
      const applicants = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.applicants) || '[]');
      const documents = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.documents) || '[]');
      const requirements = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.requirements) || '[]');

      // Calculate compliance statistics
      const totalApplicants = applicants.length;
      const compliantApplicants = applicants.filter(app => {
        const requiredDocs = requirements.filter(req => req.required);
        const appDocs = documents.filter(doc => doc.applicantId === app.id && doc.status === 'verified');
        return requiredDocs.every(req => appDocs.some(doc => doc.requirementId === req.id));
      }).length;

      const pendingVerification = documents.filter(doc => doc.status === 'pending').length;
      const totalDocuments = documents.length;
      const verifiedDocuments = documents.filter(doc => doc.status === 'verified').length;

      return `
        <div style="margin-bottom: 2rem;">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.5rem;">üìä Compliance Overview</h3>

          <!-- Statistics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">${compliantApplicants}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">Compliant Applicants</div>
                </div>
                <div style="font-size: 2.5rem; opacity: 0.8;">‚úÖ</div>
              </div>
              <div style="margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.8;">${Math.round((compliantApplicants / totalApplicants) * 100)}% of total</div>
            </div>

            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">${pendingVerification}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">Pending Verification</div>
                </div>
                <div style="font-size: 2.5rem; opacity: 0.8;">‚è≥</div>
              </div>
              <div style="margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.8;">Requiring staff review</div>
            </div>

            <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">${verifiedDocuments}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">Verified Documents</div>
                </div>
                <div style="font-size: 2.5rem; opacity: 0.8;">üìã</div>
              </div>
              <div style="margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.8;">${Math.round((verifiedDocuments / totalDocuments) * 100)}% of submitted</div>
            </div>

            <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">${totalApplicants}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">Total Applicants</div>
                </div>
                <div style="font-size: 2.5rem; opacity: 0.8;">üë•</div>
              </div>
              <div style="margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.8;">Active applications</div>
            </div>
          </div>

          <!-- Compliance Status Table -->
          <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
              <h4 style="margin: 0; color: #1f2937;">Applicant Compliance Status</h4>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="refreshComplianceData()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">üîÑ Refresh</button>
                <button onclick="resetDocumentSystem()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">üóëÔ∏è Reset</button>
              </div>
            </div>

            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8fafc;">
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">Applicant</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Status</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Documents</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Compliance</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${applicants.map(applicant => {
                    const appDocs = documents.filter(doc => doc.applicantId === applicant.id);
                    const verifiedDocs = appDocs.filter(doc => doc.status === 'verified').length;
                    const requiredDocs = requirements.filter(req => req.required).length;
                    const compliance = requiredDocs > 0 ? Math.round((verifiedDocs / requiredDocs) * 100) : 0;

                    let statusColor = '#ef4444'; // red
                    let statusIcon = 'üî¥';
                    let statusText = 'Non-Compliant';

                    if (compliance === 100) {
                      statusColor = '#3b82f6'; // green
                      statusIcon = 'üü¢';
                      statusText = 'Compliant';
                    } else if (compliance >= 50) {
                      statusColor = '#f59e0b'; // yellow
                      statusIcon = 'üü°';
                      statusText = 'Partial';
                    }

                    return `
                      <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">
                          <div style="font-weight: 600; color: #1f2937;">${applicant.name}</div>
                          <div style="font-size: 0.875rem; color: #6b7280;">${applicant.program}</div>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                          <span style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; background: ${statusColor}; color: white; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                            ${statusIcon} ${statusText}
                          </span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                          <div style="font-weight: 600;">${verifiedDocs}/${requiredDocs}</div>
                          <div style="font-size: 0.8rem; color: #6b7280;">verified</div>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                          <div style="width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; margin: 0 auto;">
                            <div style="width: ${compliance}%; height: 100%; background: ${statusColor}; border-radius: 4px;"></div>
                          </div>
                          <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">${compliance}%</div>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                          <button onclick="viewApplicantDocuments('${applicant.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üìã View</button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // Additional Document System Functions
    function refreshComplianceData() {
      showNotification('Refreshing compliance data...', 'info');
      showDocumentTab('dashboard');
      showNotification('Compliance data refreshed', 'success');
    }

    function viewApplicantDocuments(applicantId) {
      localStorage.setItem('selected_applicant_id', applicantId);
      showDocumentTab('applicants');
    }

    function generateApplicantDocumentsTab() {
      const selectedApplicantId = localStorage.getItem('selected_applicant_id');
      const applicants = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.applicants) || '[]');
      const documents = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.documents) || '[]');
      const requirements = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.requirements) || '[]');

      if (!selectedApplicantId) {
        return `
          <div>
            <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.5rem;">üë• Applicant Documents</h3>
            <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Select an Applicant</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                ${applicants.map(applicant => {
                  const applicantDocs = documents.filter(doc => doc.applicantId === applicant.id);
                  const verifiedDocs = applicantDocs.filter(doc => doc.status === 'verified').length;
                  const totalDocs = applicantDocs.length;
                  const compliance = totalDocs > 0 ? Math.round((verifiedDocs / totalDocs) * 100) : 0;
                  const statusColor = compliance >= 80 ? '#3b82f6' : compliance >= 50 ? '#f59e0b' : '#ef4444';

                  return `
                    <div onclick="viewApplicantDocuments('${applicant.id}')" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s; background: white;" onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                        <div>
                          <div style="font-weight: 600; color: #1f2937;">${applicant.name}</div>
                          <div style="font-size: 0.875rem; color: #6b7280;">${applicant.email}</div>
                        </div>
                        <div style="width: 12px; height: 12px; background: ${statusColor}; border-radius: 50%;"></div>
                      </div>
                      <div style="background: #f9fafb; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <span style="font-size: 0.875rem; color: #6b7280;">Documents:</span>
                          <span style="font-weight: 600; color: #1f2937;">${verifiedDocs}/${totalDocs}</span>
                        </div>
                        <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 0.5rem;">
                          <div style="width: ${compliance}%; height: 100%; background: ${statusColor}; border-radius: 2px;"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">${compliance}% complete</div>
                      </div>
                      <button style="width: 100%; background: #3b82f6; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">üìã View Documents</button>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 12px;">
              <button onclick="showDocumentTab('dashboard')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">‚Üê Back to Dashboard</button>
            </div>
          </div>
        `;
      }

      const selectedApplicant = applicants.find(app => app.id === selectedApplicantId);
      if (!selectedApplicant) {
        localStorage.removeItem('selected_applicant_id');
        return generateApplicantDocumentsTab();
      }

      const applicantDocs = documents.filter(doc => doc.applicantId === selectedApplicantId);
      const verifiedDocs = applicantDocs.filter(doc => doc.status === 'verified').length;
      const pendingDocs = applicantDocs.filter(doc => doc.status === 'pending').length;
      const rejectedDocs = applicantDocs.filter(doc => doc.status === 'rejected').length;

      return `
        <div>
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.5rem;">üë§ ${selectedApplicant.name} - Documents</h3>

          <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <div>
                <h4 style="margin: 0; color: #1f2937;">${selectedApplicant.name}</h4>
                <div style="font-size: 0.875rem; color: #6b7280;">${selectedApplicant.email} ‚Ä¢ Applied: ${new Date(selectedApplicant.appliedDate).toLocaleDateString()}</div>
              </div>
              <div style="display: flex; gap: 1rem;">
                <button onclick="uploadDocumentSimulation('${selectedApplicantId}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">üì§ Upload Document</button>
                <button onclick="localStorage.removeItem('selected_applicant_id'); showDocumentTab('applicants')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚Üê Back</button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
              <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 600; color: #3b82f6;">${verifiedDocs}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Verified</div>
              </div>
              <div style="background: #fefce8; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 600; color: #f59e0b;">${pendingDocs}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Pending</div>
              </div>
              <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 600; color: #ef4444;">${rejectedDocs}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Rejected</div>
              </div>
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 600; color: #1f2937;">${applicantDocs.length}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Total</div>
              </div>
            </div>

            <h5 style="margin: 0 0 1rem 0; color: #1f2937;">Submitted Documents (${applicantDocs.length})</h5>
            ${applicantDocs.length === 0 ? `
              <div style="text-align: center; padding: 2rem; color: #6b7280; border: 2px dashed #e5e7eb; border-radius: 8px;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÑ</div>
                <p style="margin: 0;">No documents submitted yet</p>
              </div>
            ` : `
              <div style="space-y: 0.75rem;">
                ${applicantDocs.map(doc => {
                  const statusColors = {
                    'verified': '#3b82f6',
                    'pending': '#f59e0b',
                    'rejected': '#ef4444'
                  };
                  const statusIcons = {
                    'verified': '‚úÖ',
                    'pending': '‚è≥',
                    'rejected': '‚ùå'
                  };

                  return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                          <span style="font-size: 1.25rem;">${statusIcons[doc.status]}</span>
                          <div>
                            <div style="font-weight: 600; color: #1f2937;">${doc.fileName}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">${doc.fileSize}MB ‚Ä¢ Uploaded: ${new Date(doc.uploadDate).toLocaleString()}</div>
                            ${doc.folderPath ? `<div style="font-size: 0.75rem; color: #9ca3af; font-family: monospace;">üìÅ ${doc.folderPath}</div>` : ''}
                          </div>
                        </div>
                        <div style="text-align: right;">
                          <span style="background: ${statusColors[doc.status]}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${doc.status}</span>
                          ${doc.status === 'verified' ? `<div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">by ${doc.verifiedBy}</div>` : ''}
                        </div>
                      </div>
                      ${doc.status === 'pending' ? `
                        <div style="display: flex; gap: 0.5rem; justify-content: end;">
                          <button onclick="verifyDocument('${doc.id}', true)" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úÖ Verify</button>
                          <button onclick="rejectDocument('${doc.id}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚ùå Reject</button>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>

          <div style="background: white; padding: 1.5rem; border-radius: 12px;">
            <h5 style="margin: 0 0 1rem 0; color: #1f2937;">Required Documents Status</h5>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8fafc;">
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">Requirement</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Status</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Document</th>
                  </tr>
                </thead>
                <tbody>
                  ${requirements.map(req => {
                    const matchingDoc = applicantDocs.find(doc => doc.type === req.type);
                    const status = matchingDoc ? matchingDoc.status : 'missing';
                    const statusColors = {
                      'verified': '#3b82f6',
                      'pending': '#f59e0b',
                      'rejected': '#ef4444',
                      'missing': '#6b7280'
                    };
                    const statusText = {
                      'verified': '‚úÖ Submitted & Verified',
                      'pending': '‚è≥ Submitted & Pending',
                      'rejected': '‚ùå Submitted & Rejected',
                      'missing': 'üìÑ Not Submitted'
                    };

                    return `
                      <tr>
                        <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">
                          <div style="font-weight: 600; color: #1f2937;">${req.name}</div>
                          <div style="font-size: 0.875rem; color: #6b7280;">${req.description}</div>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                          <span style="color: ${statusColors[status]}; font-weight: 600;">${statusText[status]}</span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                          ${matchingDoc ? `
                            <div style="font-size: 0.875rem; color: #1f2937;">${matchingDoc.fileName}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">${matchingDoc.fileSize}MB</div>
                          ` : `
                            <span style="color: #6b7280; font-style: italic;">No document</span>
                          `}
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function generateDocumentVerificationTab() {
      const documents = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.documents) || '[]');
      const pendingDocs = documents.filter(doc => doc.status === 'pending');

      return `
        <div>
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.5rem;">‚úÖ Document Verification</h3>
          ${pendingDocs.length === 0 ? `
            <div style="background: white; padding: 2rem; border-radius: 12px; text-align: center;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">All documents verified!</h4>
              <p style="color: #6b7280; margin: 0;">No documents are currently pending verification.</p>
            </div>
          ` : `
            <div style="background: white; padding: 1.5rem; border-radius: 12px;">
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Documents Pending Verification (${pendingDocs.length})</h4>
              ${pendingDocs.map(doc => `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: 600; color: #1f2937;">${doc.fileName}</div>
                      <div style="font-size: 0.875rem; color: #6b7280;">Size: ${doc.fileSize}MB ‚Ä¢ Uploaded: ${new Date(doc.uploadDate).toLocaleDateString()}</div>
                      ${doc.folderPath ? `<div style="font-size: 0.75rem; color: #9ca3af; font-family: monospace;">üìÅ ${doc.folderPath}</div>` : ''}
                      ${doc.serverPath ? `<div style="font-size: 0.75rem; color: #9ca3af; font-family: monospace;">üíæ ${doc.serverPath}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                      <button onclick="verifyDocument('${doc.id}', true)" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚úÖ Verify</button>
                      <button onclick="rejectDocument('${doc.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚ùå Reject</button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    function generateRequirementsTab() {
      const requirements = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.requirements) || '[]');

      return `
        <div>
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.5rem;">üìã Requirements Setup</h3>

          <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h4 style="margin: 0; color: #1f2937;">Document Requirements (${requirements.length})</h4>
              <button onclick="addNewRequirement()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">‚ûï Add Requirement</button>
            </div>

            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8fafc;">
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">Requirement</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Type</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Required</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Formats</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Max Size</th>
                    <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${requirements.map(req => `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                      <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">
                        <div style="font-weight: 600; color: #1f2937;">${req.name}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">${req.description}</div>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                        <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">${req.type}</span>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                        <span style="color: ${req.required ? '#3b82f6' : '#6b7280'}; font-weight: 600;">${req.required ? '‚úÖ Yes' : '‚ö™ No'}</span>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                        <div style="font-size: 0.8rem; color: #6b7280;">${req.formats.join(', ')}</div>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                        <div style="font-size: 0.8rem; color: #6b7280;">${req.maxSize}MB</div>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">
                        <div style="display: flex; gap: 0.25rem; justify-content: center;">
                          <button onclick="editRequirement('${req.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úèÔ∏è</button>
                          <button onclick="deleteRequirement('${req.id}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>

          <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 12px; padding: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #0c4a6e; display: flex; align-items: center; gap: 0.5rem;">
              <span>üí°</span> Requirement Management Tips
            </h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: #0c4a6e; line-height: 1.6;">
              <li>Required documents must be submitted by all applicants</li>
              <li>File format restrictions help ensure document compatibility</li>
              <li>Size limits prevent upload issues and storage problems</li>
              <li>Clear descriptions help applicants understand requirements</li>
            </ul>
          </div>
        </div>
      `;
    }

    function generateAuditLogsTab() {
      const auditLogs = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.auditLogs) || '[]');
      const sortedLogs = auditLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      return `
        <div>
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.5rem;">üìù Audit Logs</h3>

          <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h4 style="margin: 0; color: #1f2937;">Activity History (${sortedLogs.length} events)</h4>
              <div style="display: flex; gap: 1rem; align-items: center;">
                <select onchange="filterAuditLogs(this.value)" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; background: white;">
                  <option value="">All Activities</option>
                  <option value="document_verified">Document Verified</option>
                  <option value="document_rejected">Document Rejected</option>
                  <option value="requirement_added">Requirement Added</option>
                  <option value="requirement_updated">Requirement Updated</option>
                  <option value="requirement_deleted">Requirement Deleted</option>
                </select>
                <button onclick="exportAuditLogs()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">üìÑ Export</button>
                <button onclick="clearAuditLogs()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">üóëÔ∏è Clear</button>
              </div>
            </div>

            <div id="auditLogsContainer">
              ${sortedLogs.length === 0 ? `
                <div style="text-align: center; padding: 2rem; color: #6b7280;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                  <h4 style="margin: 0 0 0.5rem 0;">No audit logs yet</h4>
                  <p style="margin: 0;">Activity will appear here when you perform document verification tasks.</p>
                </div>
              ` : `
                <div style="max-height: 500px; overflow-y: auto;">
                  ${sortedLogs.map(log => {
                    const actionColors = {
                      'document_verified': '#3b82f6',
                      'document_rejected': '#ef4444',
                      'requirement_added': '#3b82f6',
                      'requirement_updated': '#f59e0b',
                      'requirement_deleted': '#ef4444'
                    };
                    const actionIcons = {
                      'document_verified': '‚úÖ',
                      'document_rejected': '‚ùå',
                      'requirement_added': '‚ûï',
                      'requirement_updated': '‚úèÔ∏è',
                      'requirement_deleted': 'üóëÔ∏è'
                    };

                    return `
                      <div class="audit-log-entry" data-action="${log.action}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; background: #fafafa;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                          <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.25rem;">${actionIcons[log.action] || 'üìã'}</span>
                            <div>
                              <div style="font-weight: 600; color: #1f2937;">${log.details}</div>
                              <div style="font-size: 0.875rem; color: #6b7280;">by ${log.performedBy}</div>
                            </div>
                          </div>
                          <div style="text-align: right;">
                            <div style="font-size: 0.875rem; color: #6b7280;">${new Date(log.timestamp).toLocaleString()}</div>
                            <span style="background: ${actionColors[log.action] || '#6b7280'}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${log.action.replace('_', ' ')}</span>
                          </div>
                        </div>
                        ${log.documentId ? `
                          <div style="background: #f8fafc; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                            <div style="font-size: 0.8rem; color: #6b7280;">Document ID: ${log.documentId}</div>
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>

          <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 12px; padding: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #0c4a6e; display: flex; align-items: center; gap: 0.5rem;">
              <span>üîç</span> Audit Trail Information
            </h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: #0c4a6e; line-height: 1.6;">
              <li>All verification activities are automatically logged</li>
              <li>Logs include timestamp, user, and action details</li>
              <li>Export function provides complete audit history</li>
              <li>Filtering helps locate specific types of activities</li>
            </ul>
          </div>
        </div>
      `;
    }

    function verifyDocument(documentId, verified) {
      const documents = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.documents) || '[]');
      const docIndex = documents.findIndex(doc => doc.id === documentId);

      if (docIndex !== -1) {
        documents[docIndex].status = verified ? 'verified' : 'rejected';
        documents[docIndex].verifiedBy = 'admin@institution.edu';
        documents[docIndex].verifiedDate = new Date().toISOString();

        localStorage.setItem(DOCUMENT_STORAGE.documents, JSON.stringify(documents));

        // Add to audit log
        const auditLogs = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.auditLogs) || '[]');
        auditLogs.push({
          id: 'audit_' + Date.now(),
          action: verified ? 'document_verified' : 'document_rejected',
          documentId: documentId,
          performedBy: 'admin@institution.edu',
          timestamp: new Date().toISOString(),
          details: `Document ${verified ? 'verified' : 'rejected'}: ${documents[docIndex].fileName}`
        });
        localStorage.setItem(DOCUMENT_STORAGE.auditLogs, JSON.stringify(auditLogs));

        showNotification(`Document ${verified ? 'verified' : 'rejected'} successfully!`, 'success');
        showDocumentTab('verification');
      }
    }

    function rejectDocument(documentId) {
      verifyDocument(documentId, false);
    }

    function exportComplianceReport() {
      const applicants = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.applicants) || '[]');
      const documents = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.documents) || '[]');
      const auditLogs = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.auditLogs) || '[]');

      const reportData = {
        exportDate: new Date().toISOString(),
        summary: {
          totalApplicants: applicants.length,
          totalDocuments: documents.length,
          verifiedDocuments: documents.filter(doc => doc.status === 'verified').length,
          pendingDocuments: documents.filter(doc => doc.status === 'pending').length
        },
        applicants,
        documents,
        auditLogs
      };

      const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `compliance-report-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('Compliance report exported successfully!', 'success');
    }

    function toggleDocumentFullscreen() {
      const modal = document.getElementById('documentVerificationModal');
      if (!modal) {
        showNotification('Document system not found!', 'error');
        return;
      }

      const modalContent = modal.querySelector('div');
      if (!modalContent) return;

      const isFullscreen = modalContent.style.width === '100vw' || modalContent.style.width === '100%';
      const iconElement = document.getElementById('documentFullscreenIcon');
      const textElement = document.getElementById('documentFullscreenText');

      if (isFullscreen) {
        modalContent.style.width = '95%';
        modalContent.style.height = '95vh';
        modalContent.style.maxWidth = '1400px';
        modalContent.style.borderRadius = '12px';
        if (iconElement) iconElement.textContent = '‚õ∂';
        if (textElement) textElement.textContent = 'Fullscreen';
        showNotification('Exited fullscreen', 'info');
      } else {
        modalContent.style.width = '100vw';
        modalContent.style.height = '100vh';
        modalContent.style.maxWidth = 'none';
        modalContent.style.borderRadius = '0';
        if (iconElement) iconElement.textContent = 'üóó';
        if (textElement) textElement.textContent = 'Exit Fullscreen';
        showNotification('Entered fullscreen', 'info');
      }
    }

    function addNewRequirement() {
      const modal = document.createElement('div');
      modal.id = 'addRequirementModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">‚ûï Add Document Requirement</h3>

          <form id="addRequirementForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Requirement Name</label>
              <input type="text" name="name" required placeholder="e.g., Official Transcript" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="2" placeholder="Detailed description of the requirement" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Document Type</label>
                <select name="type" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="">Select type...</option>
                  <option value="transcript">Transcript</option>
                  <option value="identification">Identification</option>
                  <option value="certification">Certification</option>
                  <option value="recommendation">Recommendation Letter</option>
                  <option value="essay">Essay/Statement</option>
                  <option value="portfolio">Portfolio</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Max File Size (MB)</label>
                <input type="number" name="maxSize" required min="1" max="50" value="10" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Allowed File Formats</label>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="pdf" checked style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">PDF</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="doc" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">DOC</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="docx" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">DOCX</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="jpg" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">JPG</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="png" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">PNG</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="txt" style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">TXT</span>
                </label>
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="required" checked style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Required (must be submitted by all applicants)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('addRequirementModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Add Requirement</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('addRequirementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const selectedFormats = Array.from(formData.getAll('formats'));

        if (selectedFormats.length === 0) {
          showNotification('Please select at least one file format', 'error');
          return;
        }

        const requirements = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.requirements) || '[]');
        const newRequirement = {
          id: 'req_' + Date.now(),
          name: formData.get('name'),
          description: formData.get('description') || '',
          type: formData.get('type'),
          required: formData.get('required') === 'on',
          formats: selectedFormats,
          maxSize: parseInt(formData.get('maxSize')),
          createdAt: new Date().toISOString(),
          createdBy: 'admin@institution.edu'
        };

        requirements.push(newRequirement);
        localStorage.setItem(DOCUMENT_STORAGE.requirements, JSON.stringify(requirements));

        const auditLogs = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.auditLogs) || '[]');
        auditLogs.push({
          id: 'audit_' + Date.now(),
          action: 'requirement_added',
          performedBy: 'admin@institution.edu',
          timestamp: new Date().toISOString(),
          details: `Added new requirement: ${newRequirement.name}`
        });
        localStorage.setItem(DOCUMENT_STORAGE.auditLogs, JSON.stringify(auditLogs));

        closeModal('addRequirementModal');
        showDocumentTab('requirements');
        showNotification('Document requirement added successfully!', 'success');
      });
    }

    function editRequirement(requirementId) {
      const requirements = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.requirements) || '[]');
      const requirement = requirements.find(req => req.id === requirementId);

      if (!requirement) {
        showNotification('Requirement not found', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editRequirementModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">‚úèÔ∏è Edit Document Requirement</h3>

          <form id="editRequirementForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Requirement Name</label>
              <input type="text" name="name" required value="${requirement.name}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Description</label>
              <textarea name="description" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">${requirement.description}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Document Type</label>
                <select name="type" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="transcript" ${requirement.type === 'transcript' ? 'selected' : ''}>Transcript</option>
                  <option value="identification" ${requirement.type === 'identification' ? 'selected' : ''}>Identification</option>
                  <option value="certification" ${requirement.type === 'certification' ? 'selected' : ''}>Certification</option>
                  <option value="recommendation" ${requirement.type === 'recommendation' ? 'selected' : ''}>Recommendation Letter</option>
                  <option value="essay" ${requirement.type === 'essay' ? 'selected' : ''}>Essay/Statement</option>
                  <option value="portfolio" ${requirement.type === 'portfolio' ? 'selected' : ''}>Portfolio</option>
                  <option value="other" ${requirement.type === 'other' ? 'selected' : ''}>Other</option>
                </select>
              </div>

              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Max File Size (MB)</label>
                <input type="number" name="maxSize" required min="1" max="50" value="${requirement.maxSize}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
              </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Allowed File Formats</label>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="pdf" ${requirement.formats.includes('pdf') ? 'checked' : ''} style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">PDF</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="doc" ${requirement.formats.includes('doc') ? 'checked' : ''} style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">DOC</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="docx" ${requirement.formats.includes('docx') ? 'checked' : ''} style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">DOCX</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="jpg" ${requirement.formats.includes('jpg') ? 'checked' : ''} style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">JPG</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="png" ${requirement.formats.includes('png') ? 'checked' : ''} style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">PNG</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" name="formats" value="txt" ${requirement.formats.includes('txt') ? 'checked' : ''} style="cursor: pointer;">
                  <span style="font-size: 0.875rem;">TXT</span>
                </label>
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="required" ${requirement.required ? 'checked' : ''} style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: #374151;">Required (must be submitted by all applicants)</span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('editRequirementModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Update Requirement</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editRequirementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const selectedFormats = Array.from(formData.getAll('formats'));

        if (selectedFormats.length === 0) {
          showNotification('Please select at least one file format', 'error');
          return;
        }

        const reqIndex = requirements.findIndex(req => req.id === requirementId);
        requirements[reqIndex] = {
          ...requirement,
          name: formData.get('name'),
          description: formData.get('description') || '',
          type: formData.get('type'),
          required: formData.get('required') === 'on',
          formats: selectedFormats,
          maxSize: parseInt(formData.get('maxSize')),
          lastModified: new Date().toISOString(),
          modifiedBy: 'admin@institution.edu'
        };

        localStorage.setItem(DOCUMENT_STORAGE.requirements, JSON.stringify(requirements));

        const auditLogs = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.auditLogs) || '[]');
        auditLogs.push({
          id: 'audit_' + Date.now(),
          action: 'requirement_updated',
          performedBy: 'admin@institution.edu',
          timestamp: new Date().toISOString(),
          details: `Updated requirement: ${requirements[reqIndex].name}`
        });
        localStorage.setItem(DOCUMENT_STORAGE.auditLogs, JSON.stringify(auditLogs));

        closeModal('editRequirementModal');
        showDocumentTab('requirements');
        showNotification('Document requirement updated successfully!', 'success');
      });
    }

    function deleteRequirement(requirementId) {
      const requirements = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.requirements) || '[]');
      const requirement = requirements.find(req => req.id === requirementId);

      if (!requirement) {
        showNotification('Requirement not found', 'error');
        return;
      }

      if (confirm(`Are you sure you want to delete the requirement "${requirement.name}"? This action cannot be undone.`)) {
        const reqIndex = requirements.findIndex(req => req.id === requirementId);
        requirements.splice(reqIndex, 1);
        localStorage.setItem(DOCUMENT_STORAGE.requirements, JSON.stringify(requirements));

        const auditLogs = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.auditLogs) || '[]');
        auditLogs.push({
          id: 'audit_' + Date.now(),
          action: 'requirement_deleted',
          performedBy: 'admin@institution.edu',
          timestamp: new Date().toISOString(),
          details: `Deleted requirement: ${requirement.name}`
        });
        localStorage.setItem(DOCUMENT_STORAGE.auditLogs, JSON.stringify(auditLogs));

        showDocumentTab('requirements');
        showNotification('Document requirement deleted successfully!', 'success');
      }
    }

    function filterAuditLogs(action) {
      const entries = document.querySelectorAll('.audit-log-entry');
      entries.forEach(entry => {
        if (!action || entry.getAttribute('data-action') === action) {
          entry.style.display = 'block';
        } else {
          entry.style.display = 'none';
        }
      });

      const visibleCount = Array.from(entries).filter(entry => entry.style.display !== 'none').length;
      showNotification(`Showing ${visibleCount} ${action ? action.replace('_', ' ') : 'audit'} entries`, 'info');
    }

    function exportAuditLogs() {
      const auditLogs = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.auditLogs) || '[]');

      if (auditLogs.length === 0) {
        showNotification('No audit logs to export', 'warning');
        return;
      }

      const exportData = {
        exportDate: new Date().toISOString(),
        totalEntries: auditLogs.length,
        auditLogs: auditLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `audit-logs-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification(`Exported ${auditLogs.length} audit log entries`, 'success');
    }

    function clearAuditLogs() {
      if (confirm('Are you sure you want to clear all audit logs? This action cannot be undone.')) {
        localStorage.setItem(DOCUMENT_STORAGE.auditLogs, '[]');
        showDocumentTab('audit');
        showNotification('All audit logs have been cleared', 'success');
      }
    }

    function uploadDocumentSimulation(applicantId) {
      const requirements = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.requirements) || '[]');
      const documents = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.documents) || '[]');
      const applicants = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.applicants) || '[]');
      const applicant = applicants.find(app => app.id === applicantId);

      if (!applicant) {
        showNotification('Applicant not found', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'uploadSimulationModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 26000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">
          <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem;">üì§ Document Upload</h3>
          <p style="margin: 0 0 1.5rem 0; color: #6b7280; font-size: 0.875rem;">Upload documents for ${applicant.name} to the document management system</p>

          <form id="uploadSimulationForm">
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Document Type</label>
              <select name="documentType" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="">Select document type...</option>
                ${requirements.map(req => `<option value="${req.type}">${req.name}</option>`).join('')}
                <option value="other">Other Document</option>
              </select>
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">File Name</label>
              <input type="text" name="fileName" required placeholder="e.g., official_transcript.pdf" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Storage Folder Path</label>
              <select name="folderPath" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="">Select folder location...</option>
                <option value="/documents/applicants/${applicant.id}/transcripts/">üìÅ /documents/applicants/${applicant.id}/transcripts/</option>
                <option value="/documents/applicants/${applicant.id}/identification/">üìÅ /documents/applicants/${applicant.id}/identification/</option>
                <option value="/documents/applicants/${applicant.id}/recommendations/">üìÅ /documents/applicants/${applicant.id}/recommendations/</option>
                <option value="/documents/applicants/${applicant.id}/essays/">üìÅ /documents/applicants/${applicant.id}/essays/</option>
                <option value="/documents/applicants/${applicant.id}/certifications/">üìÅ /documents/applicants/${applicant.id}/certifications/</option>
                <option value="/documents/applicants/${applicant.id}/portfolio/">üìÅ /documents/applicants/${applicant.id}/portfolio/</option>
                <option value="/documents/applicants/${applicant.id}/other/">üìÅ /documents/applicants/${applicant.id}/other/</option>
              </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">File Size (MB)</label>
                <input type="number" name="fileSize" required min="0.1" max="50" step="0.1" value="2.5" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Initial Status</label>
                <select name="status" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="pending">Pending Review</option>
                  <option value="verified">Auto-Verified</option>
                  <option value="rejected">Auto-Rejected</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem;">Upload Notes (Optional)</label>
              <textarea name="notes" rows="2" placeholder="Additional notes about this document..." style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>

            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="color: #3b82f6;">üí°</span>
                <strong style="color: #1e40af;">Document Management</strong>
              </div>
              <ul style="margin: 0; padding-left: 1.5rem; color: #1e40af; font-size: 0.875rem; line-height: 1.5;">
                <li>Organizes files in structured folder hierarchy</li>
                <li>Stores documents with full server and URL paths</li>
                <li>Updates compliance status automatically</li>
                <li>Creates detailed audit trail records</li>
                <li>Supports institutional document policies</li>
              </ul>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end;">
              <button type="button" onclick="closeModal('uploadSimulationModal')" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">üì§ Upload Document</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('uploadSimulationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const folderPath = formData.get('folderPath').replace('${applicant.id}', applicantId);
        const fullPath = folderPath + formData.get('fileName');

        const newDocument = {
          id: 'doc_' + Date.now(),
          applicantId: applicantId,
          fileName: formData.get('fileName'),
          folderPath: folderPath,
          fullPath: fullPath,
          fileSize: parseFloat(formData.get('fileSize')),
          type: formData.get('documentType'),
          status: formData.get('status'),
          uploadDate: new Date().toISOString(),
          notes: formData.get('notes') || '',
          uploadedBy: applicant.email,
          serverPath: `C:\\DocumentStore\\Admissions${fullPath.replace(/\//g, '\\')}`,
          urlPath: `https://documents.institution.edu${fullPath}`
        };

        if (newDocument.status === 'verified') {
          newDocument.verifiedBy = 'admin@institution.edu';
          newDocument.verifiedDate = new Date().toISOString();
        }

        documents.push(newDocument);
        localStorage.setItem(DOCUMENT_STORAGE.documents, JSON.stringify(documents));

        const auditLogs = JSON.parse(localStorage.getItem(DOCUMENT_STORAGE.auditLogs) || '[]');
        auditLogs.push({
          id: 'audit_' + Date.now(),
          action: 'document_uploaded',
          documentId: newDocument.id,
          performedBy: 'system_simulation',
          timestamp: new Date().toISOString(),
          details: `Document uploaded via simulation: ${newDocument.fileName} for ${applicant.name}`
        });

        if (newDocument.status === 'verified') {
          auditLogs.push({
            id: 'audit_' + Date.now() + '_verify',
            action: 'document_verified',
            documentId: newDocument.id,
            performedBy: 'admin@institution.edu',
            timestamp: new Date().toISOString(),
            details: `Document auto-verified: ${newDocument.fileName}`
          });
        } else if (newDocument.status === 'rejected') {
          auditLogs.push({
            id: 'audit_' + Date.now() + '_reject',
            action: 'document_rejected',
            documentId: newDocument.id,
            performedBy: 'admin@institution.edu',
            timestamp: new Date().toISOString(),
            details: `Document auto-rejected: ${newDocument.fileName}`
          });
        }

        localStorage.setItem(DOCUMENT_STORAGE.auditLogs, JSON.stringify(auditLogs));

        closeModal('uploadSimulationModal');
        showDocumentTab('applicants');
        showNotification(`Document "${newDocument.fileName}" uploaded successfully to ${newDocument.folderPath}`, 'success');
      });
    }

    function resetDocumentSystem() {
      if (confirm('Are you sure you want to reset the entire document verification system? This will clear all data and cannot be undone.')) {
        Object.values(DOCUMENT_STORAGE).forEach(key => {
          localStorage.removeItem(key);
        });
        localStorage.removeItem('document_system_open');
        localStorage.removeItem('selected_applicant_id');

        showNotification('Document verification system has been reset', 'success');

        setTimeout(() => {
          location.reload();
        }, 1000);
      }
    }


    // Enhanced State Persistence System
    const STATE_KEYS = {
      systemOpen: 'flow_doc_system_open',
      activeTab: 'flow_doc_active_tab',
      selectedApplicant: 'flow_doc_selected_applicant',
      lastActivity: 'flow_doc_last_activity',
      sessionId: 'flow_doc_session_id',
      fullscreenMode: 'flow_doc_fullscreen'
    };

    function saveSystemState() {
      const state = {
        isOpen: !!document.getElementById('documentVerificationModal'),
        activeTab: getCurrentActiveTab(),
        selectedApplicant: localStorage.getItem('selected_applicant_id'),
        fullscreen: isDocumentSystemFullscreen(),
        timestamp: new Date().toISOString(),
        sessionId: getOrCreateSessionId()
      };

      Object.keys(state).forEach(key => {
        if (state[key] !== null && state[key] !== undefined) {
          localStorage.setItem(STATE_KEYS[key] || `flow_doc_${key}`,
                              typeof state[key] === 'object' ? JSON.stringify(state[key]) : state[key]);
        }
      });
    }

    function restoreSystemState() {
      const wasOpen = localStorage.getItem(STATE_KEYS.systemOpen) === 'true';
      const lastActivity = localStorage.getItem(STATE_KEYS.lastActivity);
      const sessionId = localStorage.getItem(STATE_KEYS.sessionId);

      if (wasOpen && isRecentActivity(lastActivity)) {
        console.log('Restoring document verification system state...');

        setTimeout(() => {
          openDocumentVerificationSystem();

          const activeTab = localStorage.getItem(STATE_KEYS.activeTab);
          if (activeTab) {
            showDocumentTab(activeTab);
          }

          const wasFullscreen = localStorage.getItem(STATE_KEYS.fullscreenMode) === 'true';
          if (wasFullscreen) {
            setTimeout(() => toggleDocumentFullscreen(), 500);
          }

          showNotification('Document system restored from previous session', 'info');
        }, 1000);
      }
    }

    function getCurrentActiveTab() {
      const tabs = document.querySelectorAll('.document-tab-button');
      for (let tab of tabs) {
        if (tab.style.background === 'rgb(59, 130, 246)' || tab.style.background === '#3b82f6') {
          return tab.getAttribute('onclick')?.match(/showDocumentTab\('([^']+)'\)/)?.[1];
        }
      }
      return 'dashboard';
    }

    function isDocumentSystemFullscreen() {
      const modal = document.getElementById('documentVerificationModal');
      if (!modal) return false;
      const content = modal.querySelector('div');
      return content?.style.width === '100vw' || content?.style.width === '100%';
    }

    function getOrCreateSessionId() {
      let sessionId = localStorage.getItem(STATE_KEYS.sessionId);
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem(STATE_KEYS.sessionId, sessionId);
      }
      return sessionId;
    }

    function isRecentActivity(timestamp) {
      if (!timestamp) return false;
      const lastTime = new Date(timestamp);
      const now = new Date();
      const hoursDiff = (now - lastTime) / (1000 * 60 * 60);
      return hoursDiff < 24; // Restore if activity was within last 24 hours
    }

    function clearSystemState() {
      Object.values(STATE_KEYS).forEach(key => {
        localStorage.removeItem(key);
      });
      localStorage.removeItem('selected_applicant_id');
    }

    // Auto-save state every 30 seconds when system is open
    setInterval(() => {
      if (document.getElementById('documentVerificationModal')) {
        saveSystemState();
        localStorage.setItem(STATE_KEYS.lastActivity, new Date().toISOString());
      }
    }, 30000);

    // Save state on page unload
    window.addEventListener('beforeunload', function() {
      if (document.getElementById('documentVerificationModal')) {
        localStorage.setItem(STATE_KEYS.systemOpen, 'true');
        localStorage.setItem(STATE_KEYS.lastActivity, new Date().toISOString());
        saveSystemState();
      } else {
        localStorage.setItem(STATE_KEYS.systemOpen, 'false');
      }
    });

    // Save state when system is closed
    function closeDocumentVerificationSystem() {
      localStorage.setItem(STATE_KEYS.systemOpen, 'false');
      clearSystemState();
      const modal = document.getElementById('documentVerificationModal');
      if (modal) {
        modal.remove();
      }
    }

    // Restore state on page load
    console.log('üöÄ REACHED: About to set up load event listener');
    window.addEventListener('load', function() {
      console.log('üîÑ REACHED: Page loaded, calling restoreSystemState');
      setTimeout(restoreSystemState, 500);
    });
    console.log('‚úÖ REACHED: Load event listener set up');



    // ============================================
    // SIS INTEGRATION SYSTEM
    // ============================================

    const SIS_STORAGE = {
      connections: 'flow_sis_connections',
      exports: 'flow_sis_exports',
      syncs: 'flow_sis_syncs',
      mappings: 'flow_sis_mappings',
      logs: 'flow_sis_logs',
      settings: 'flow_sis_settings'
    };

    function initializeSISData() {
      // Initialize SIS connections
      if (!localStorage.getItem(SIS_STORAGE.connections)) {
        const defaultConnections = [
          {
            id: 'conn_1',
            name: 'Primary SIS Connection',
            type: 'API',
            url: 'https://sis.university.edu/api/v2',
            status: 'active',
            lastSync: '2024-01-20T10:30:00Z',
            authMethod: 'OAuth 2.0',
            description: 'Main university SIS for student records'
          },
          {
            id: 'conn_2',
            name: 'Legacy System Bridge',
            type: 'SFTP',
            url: 'sftp://legacy.university.edu',
            status: 'inactive',
            lastSync: '2024-01-15T14:20:00Z',
            authMethod: 'SSH Key',
            description: 'Legacy system for historical data'
          }
        ];
        localStorage.setItem(SIS_STORAGE.connections, JSON.stringify(defaultConnections));
      }

      // Initialize export records
      if (!localStorage.getItem(SIS_STORAGE.exports)) {
        const defaultExports = [
          {
            id: 'export_1',
            type: 'admitted_students',
            connection: 'conn_1',
            status: 'completed',
            recordCount: 125,
            timestamp: '2024-01-20T09:15:00Z',
            format: 'JSON',
            size: '2.3 MB'
          },
          {
            id: 'export_2',
            type: 'status_updates',
            connection: 'conn_1',
            status: 'in_progress',
            recordCount: 45,
            timestamp: '2024-01-20T11:00:00Z',
            format: 'XML',
            size: '856 KB'
          }
        ];
        localStorage.setItem(SIS_STORAGE.exports, JSON.stringify(defaultExports));
      }

      // Initialize field mappings
      if (!localStorage.getItem(SIS_STORAGE.mappings)) {
        const defaultMappings = [
          {
            id: 'mapping_1',
            name: 'Student Record Mapping',
            source: 'admissions',
            target: 'sis',
            fields: [
              { source: 'student_id', target: 'StudentID', required: true, type: 'string' },
              { source: 'first_name', target: 'FirstName', required: true, type: 'string' },
              { source: 'last_name', target: 'LastName', required: true, type: 'string' },
              { source: 'email', target: 'Email', required: true, type: 'email' },
              { source: 'admission_status', target: 'EnrollmentStatus', required: true, type: 'enum' },
              { source: 'program_code', target: 'ProgramCode', required: true, type: 'string' }
            ]
          }
        ];
        localStorage.setItem(SIS_STORAGE.mappings, JSON.stringify(defaultMappings));
      }

      // Initialize sync logs
      if (!localStorage.getItem(SIS_STORAGE.logs)) {
        const defaultLogs = [
          {
            id: 'log_1',
            timestamp: '2024-01-20T10:30:00Z',
            level: 'SUCCESS',
            operation: 'EXPORT',
            message: 'Successfully exported 125 admitted student records to SIS',
            details: { recordCount: 125, duration: '2.3s', connection: 'conn_1' }
          },
          {
            id: 'log_2',
            timestamp: '2024-01-20T10:25:00Z',
            level: 'WARNING',
            operation: 'SYNC',
            message: 'Field mapping validation warning for 3 records',
            details: { affectedRecords: 3, issue: 'Missing program_code', connection: 'conn_1' }
          },
          {
            id: 'log_3',
            timestamp: '2024-01-20T10:15:00Z',
            level: 'ERROR',
            operation: 'EXPORT',
            message: 'Failed to export batch due to authentication timeout',
            details: { error: 'AUTH_TIMEOUT', retryScheduled: true, connection: 'conn_1' }
          }
        ];
        localStorage.setItem(SIS_STORAGE.logs, JSON.stringify(defaultLogs));
      }

      // Initialize settings
      if (!localStorage.getItem(SIS_STORAGE.settings)) {
        const defaultSettings = {
          autoSync: true,
          syncInterval: 30, // minutes
          batchSize: 50,
          retryAttempts: 3,
          encryptionEnabled: true,
          notificationEmail: 'admin@university.edu'
        };
        localStorage.setItem(SIS_STORAGE.settings, JSON.stringify(defaultSettings));
      }
    }

    function openSISIntegrationSystem() {
      showNotification('Opening SIS Integration System...');
      initializeSISData();

      // Load saved state
      const savedState = loadSISState();

      // Save system state
      localStorage.setItem('sis_system_open', 'true');

      const modal = document.createElement('div');
      modal.id = 'sisIntegrationModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 95vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 2rem; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="closeSISIntegrationSystem()" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'" title="Close and return to admissions">
                  ‚Üê Back
                </button>
                <div>
                  <h2 style="margin: 0; font-size: 1.75rem; font-weight: 700;">üîó SIS Integration System</h2>
                  <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 1rem;">Secure data exchange between admissions and student information systems</p>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem;">
                  <span style="opacity: 0.8;">Status:</span> <span style="color: #10b981; font-weight: 600;">‚óè Online</span>
                </div>
                <button onclick="toggleSISFullscreen()" id="sisFullscreenBtn" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'" title="Toggle fullscreen (F11, Ctrl+F, or ESC to exit)">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                  </svg>
                  <span id="fullscreenText">Fullscreen</span>
                </button>
                <button onclick="showSISKeyboardShortcuts()" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'" title="View keyboard shortcuts">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 5a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h12zM2 4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H2z"/>
                    <path d="M13 10.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm0-2a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm-5 0A.25.25 0 0 1 8.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 8 8.75v-.5zm2 0a.25.25 0 0 1 .25-.25A.25.25 0 0 1 10.5 8v.5a.25.25 0 0 1-.25.25.25.25 0 0 1-.25-.25v-.5zm1 0a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm-5-2A.25.25 0 0 1 6.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 6 6.75v-.5zm-2 0A.25.25 0 0 1 4.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 4 6.75v-.5zm-2 0A.25.25 0 0 1 2.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 2 6.75v-.5zm8 0a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm2 0a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm1 0a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5z"/>
                  </svg>
                </button>
                <button onclick="showSISPreferences()" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'" title="System preferences">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Navigation Tabs -->
          <div style="background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 0 2rem;">
            <div style="display: flex; gap: 0;">
              <button onclick="switchSISTab('dashboard')" data-tab="dashboard" class="sis-tab-btn" style="padding: 1rem 1.5rem; border: none; background: #3b82f6; color: white; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: 500; transition: all 0.3s ease;">üìä Dashboard</button>
              <button onclick="switchSISTab('connections')" data-tab="connections" class="sis-tab-btn" style="padding: 1rem 1.5rem; border: none; background: #e2e8f0; color: #64748b; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: 500; transition: all 0.3s ease;">üîå Connections</button>
              <button onclick="switchSISTab('export')" data-tab="export" class="sis-tab-btn" style="padding: 1rem 1.5rem; border: none; background: #e2e8f0; color: #64748b; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: 500; transition: all 0.3s ease;">üì§ Export</button>
              <button onclick="switchSISTab('sync')" data-tab="sync" class="sis-tab-btn" style="padding: 1rem 1.5rem; border: none; background: #e2e8f0; color: #64748b; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: 500; transition: all 0.3s ease;">üîÑ Sync</button>
              <button onclick="switchSISTab('mapping')" data-tab="mapping" class="sis-tab-btn" style="padding: 1rem 1.5rem; border: none; background: #e2e8f0; color: #64748b; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: 500; transition: all 0.3s ease;">üó∫Ô∏è Mapping</button>
              <button onclick="switchSISTab('logs')" data-tab="logs" class="sis-tab-btn" style="padding: 1rem 1.5rem; border: none; background: #e2e8f0; color: #64748b; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: 500; transition: all 0.3s ease;">üìã Logs</button>
            </div>
          </div>

          <!-- Content Area -->
          <div style="flex: 1; overflow-y: auto; padding: 2rem;">
            <div id="sis-dashboard-content" class="sis-tab-content">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Stats Cards -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                  <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; opacity: 0.9;">Active Connections</h3>
                  <p style="margin: 0; font-size: 2rem; font-weight: 700;">2</p>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; opacity: 0.8;">Primary SIS + Legacy</p>
                </div>
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                  <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; opacity: 0.9;">Records Exported</h3>
                  <p style="margin: 0; font-size: 2rem; font-weight: 700;">1,247</p>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; opacity: 0.8;">This academic year</p>
                </div>
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                  <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; opacity: 0.9;">Last Sync</h3>
                  <p style="margin: 0; font-size: 2rem; font-weight: 700;">2h</p>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; opacity: 0.8;">ago - successful</p>
                </div>
              </div>

              <!-- Recent Activity -->
              <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                  üìà Recent SIS Activity
                </h3>
                <div style="space-y: 1rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
                    <div>
                      <p style="margin: 0; font-weight: 600; color: #1e293b;">Exported admitted students</p>
                      <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #64748b;">125 records exported to Primary SIS</p>
                    </div>
                    <div style="text-align: right;">
                      <span style="background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">SUCCESS</span>
                      <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: #64748b;">2 hours ago</p>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
                    <div>
                      <p style="margin: 0; font-weight: 600; color: #1e293b;">Status update sync</p>
                      <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #64748b;">45 applicant status updates</p>
                    </div>
                    <div style="text-align: right;">
                      <span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">IN PROGRESS</span>
                      <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: #64748b;">30 minutes ago</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="sis-connections-content" class="sis-tab-content" style="display: none;">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; color: #1e293b; font-size: 1.5rem;">SIS Connections</h3>
                <button onclick="addSISConnection()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">+ Add Connection</button>
              </div>
              <div id="sisConnectionsList"></div>
            </div>

            <div id="sis-export-content" class="sis-tab-content" style="display: none;">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; color: #1e293b; font-size: 1.5rem;">Export Management</h3>
                <button onclick="startSISExport()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üì§ Start Export</button>
              </div>
              <div id="sisExportsList"></div>
            </div>

            <div id="sis-sync-content" class="sis-tab-content" style="display: none;">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; color: #1e293b; font-size: 1.5rem;">Sync Management</h3>
                <button onclick="startSISSync()" style="background: #8b5cf6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üîÑ Start Sync</button>
              </div>
              <div id="sisSyncList"></div>
            </div>

            <div id="sis-mapping-content" class="sis-tab-content" style="display: none;">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; color: #1e293b; font-size: 1.5rem;">Field Mapping</h3>
                <button onclick="createSISMapping()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üó∫Ô∏è New Mapping</button>
              </div>
              <div id="sisMappingList"></div>
            </div>

            <div id="sis-logs-content" class="sis-tab-content" style="display: none;">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; color: #1e293b; font-size: 1.5rem;">System Logs</h3>
                <button onclick="clearSISLogs()" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üóëÔ∏è Clear Logs</button>
              </div>
              <div id="sisLogsList"></div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      generateSISConnections();
      generateSISExports();
      generateSISSync();
      generateSISMapping();
      generateSISLogs();

      // Add keyboard shortcuts
      document.addEventListener('keydown', handleSISKeyboard);

      // Apply saved state
      applySISState(savedState);
    }

    function closeSISIntegrationSystem() {
      const modal = document.getElementById('sisIntegrationModal');
      if (modal) {
        // Save state before closing
        saveSISState();

        // Restore body overflow if in fullscreen
        if (modal.classList.contains('sis-fullscreen')) {
          document.body.style.overflow = '';
        }
        modal.remove();
      }
      localStorage.removeItem('sis_system_open');
      // Remove keyboard event listener
      document.removeEventListener('keydown', handleSISKeyboard);
      addSISLog('info', 'SIS Integration System closed');
      showNotification('SIS Integration System closed');
    }

    function switchSISTab(tabName) {
      // Hide all content
      document.querySelectorAll('.sis-tab-content').forEach(content => {
        content.style.display = 'none';
      });

      // Reset all tabs
      document.querySelectorAll('.sis-tab-btn').forEach(btn => {
        btn.style.background = '#e2e8f0';
        btn.style.color = '#64748b';
      });

      // Show selected content
      document.getElementById(`sis-${tabName}-content`).style.display = 'block';

      // Highlight selected tab
      const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
      activeTab.style.background = '#3b82f6';
      activeTab.style.color = 'white';

      // Save state when tab changes
      saveSISState();
      addSISLog('info', `Switched to ${tabName} tab`);
    }

    function generateSISConnections() {
      const connections = JSON.parse(localStorage.getItem(SIS_STORAGE.connections) || '[]');
      const container = document.getElementById('sisConnectionsList');

      container.innerHTML = connections.map(conn => `
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.5rem 0; color: #1e293b; font-size: 1.125rem; display: flex; align-items: center; gap: 0.5rem;">
                ${conn.type === 'API' ? 'üîå' : 'üìÅ'} ${conn.name}
                <span style="background: ${conn.status === 'active' ? '#10b981' : '#64748b'}; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                  ${conn.status.toUpperCase()}
                </span>
              </h4>
              <p style="margin: 0 0 0.75rem 0; color: #64748b; font-size: 0.875rem;">${conn.description}</p>
              <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #64748b;">
                <span><strong>URL:</strong> ${conn.url}</span>
                <span><strong>Auth:</strong> ${conn.authMethod}</span>
                <span><strong>Last Sync:</strong> ${new Date(conn.lastSync).toLocaleString()}</span>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="testSISConnection('${conn.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Test</button>
              <button onclick="editSISConnection('${conn.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Edit</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function generateSISExports() {
      const exports = JSON.parse(localStorage.getItem(SIS_STORAGE.exports) || '[]');
      const container = document.getElementById('sisExportsList');

      container.innerHTML = exports.map(exp => `
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.5rem 0; color: #1e293b; font-size: 1.125rem; display: flex; align-items: center; gap: 0.5rem;">
                üì§ ${exp.type.replace('_', ' ').toUpperCase()}
                <span style="background: ${exp.status === 'completed' ? '#10b981' : exp.status === 'in_progress' ? '#f59e0b' : '#ef4444'}; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                  ${exp.status.toUpperCase()}
                </span>
              </h4>
              <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #64748b; margin-bottom: 0.75rem;">
                <span><strong>Records:</strong> ${exp.recordCount}</span>
                <span><strong>Format:</strong> ${exp.format}</span>
                <span><strong>Size:</strong> ${exp.size}</span>
                <span><strong>Time:</strong> ${new Date(exp.timestamp).toLocaleString()}</span>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="downloadSISExport('${exp.id}')" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Download</button>
              <button onclick="retrySISExport('${exp.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Retry</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function generateSISSync() {
      const container = document.getElementById('sisSyncList');
      container.innerHTML = `
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
          <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.125rem;">üîÑ Sync Configuration</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Auto Sync</label>
              <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option>Enabled</option>
                <option>Disabled</option>
              </select>
            </div>
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Sync Interval</label>
              <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option>30 minutes</option>
                <option>1 hour</option>
                <option>4 hours</option>
                <option>Daily</option>
              </select>
            </div>
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Batch Size</label>
              <input type="number" value="50" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>
          </div>
        </div>
      `;
    }

    function generateSISMapping() {
      const mappings = JSON.parse(localStorage.getItem(SIS_STORAGE.mappings) || '[]');
      const container = document.getElementById('sisMappingList');

      container.innerHTML = mappings.map(mapping => `
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
          <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.125rem; display: flex; align-items: center; gap: 0.5rem;">
            üó∫Ô∏è ${mapping.name}
            <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
              ${mapping.fields.length} FIELDS
            </span>
          </h4>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
              <thead>
                <tr style="background: #f8fafc;">
                  <th style="padding: 0.75rem; text-align: left; border: 1px solid #e2e8f0;">Source Field</th>
                  <th style="padding: 0.75rem; text-align: left; border: 1px solid #e2e8f0;">Target Field</th>
                  <th style="padding: 0.75rem; text-align: left; border: 1px solid #e2e8f0;">Type</th>
                  <th style="padding: 0.75rem; text-align: left; border: 1px solid #e2e8f0;">Required</th>
                </tr>
              </thead>
              <tbody>
                ${mapping.fields.map(field => `
                  <tr>
                    <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${field.source}</td>
                    <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${field.target}</td>
                    <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${field.type}</td>
                    <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">
                      <span style="color: ${field.required ? '#ef4444' : '#64748b'};">
                        ${field.required ? '‚óè Required' : '‚óã Optional'}
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `).join('');
    }

    function generateSISLogs() {
      const logs = JSON.parse(localStorage.getItem(SIS_STORAGE.logs) || '[]');
      const container = document.getElementById('sisLogsList');

      container.innerHTML = logs.map(log => `
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <span style="background: ${log.level === 'SUCCESS' ? '#10b981' : log.level === 'WARNING' ? '#f59e0b' : '#ef4444'}; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                  ${log.level}
                </span>
                <span style="background: #e2e8f0; color: #64748b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                  ${log.operation}
                </span>
                <span style="color: #64748b; font-size: 0.875rem;">${new Date(log.timestamp).toLocaleString()}</span>
              </div>
              <p style="margin: 0 0 0.5rem 0; color: #1e293b; font-weight: 500;">${log.message}</p>
              <p style="margin: 0; color: #64748b; font-size: 0.875rem;">${JSON.stringify(log.details)}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    // SIS Integration utility functions
    function addSISConnection() {
      const modal = document.createElement('div');
      modal.id = 'addSISConnectionModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üîå Add SIS Connection</h3>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Configure secure connection to your Student Information System</p>
          </div>

          <div style="padding: 2rem;">
            <form id="sisConnectionForm">
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Connection Name</label>
                <input type="text" name="connectionName" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="e.g., Primary SIS, Legacy System">
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">SIS Provider</label>
                <select name="sisProvider" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="">Select Provider</option>
                  <option value="banner">Ellucian Banner</option>
                  <option value="colleague">Ellucian Colleague</option>
                  <option value="peoplesoft">Oracle PeopleSoft</option>
                  <option value="workday">Workday Student</option>
                  <option value="powerschool">PowerSchool</option>
                  <option value="jenzabar">Jenzabar</option>
                  <option value="custom">Custom/API</option>
                </select>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">API Endpoint URL</label>
                <input type="url" name="apiUrl" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="https://your-sis.edu/api/v1">
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Authentication Method</label>
                <select name="authMethod" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" onchange="toggleAuthFields(this.value)">
                  <option value="">Select Authentication</option>
                  <option value="api_key">API Key</option>
                  <option value="oauth2">OAuth 2.0</option>
                  <option value="basic">Basic Auth</option>
                  <option value="bearer">Bearer Token</option>
                </select>
              </div>

              <div id="authFields" style="margin-bottom: 1.5rem;"></div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151;">
                  <input type="checkbox" name="enableSSL" checked style="transform: scale(1.2);">
                  Enable SSL/TLS Encryption
                </label>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">Recommended for secure data transmission</p>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151;">
                  <input type="checkbox" name="autoSync" style="transform: scale(1.2);">
                  Enable Automatic Synchronization
                </label>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">Sync data every 15 minutes during business hours</p>
              </div>

              <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" onclick="closeSISConnectionModal()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button type="button" onclick="testSISConnectionSetup()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üß™ Test Connection</button>
                <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üíæ Save Connection</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('sisConnectionForm').onsubmit = function(e) {
        e.preventDefault();
        saveSISConnection(new FormData(this));
      };
    }

    function testSISConnection(connId) {
      showNotification(`Testing connection ${connId}...`);
      setTimeout(() => showNotification('Connection test successful!', 'success'), 2000);
    }

    function editSISConnection(connId) {
      showNotification(`Edit connection ${connId} dialog would open here`);
    }

    function startSISExport() {
      const modal = document.createElement('div');
      modal.id = 'startSISExportModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üì§ Export Admitted Students</h3>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Export admitted student data to connected SIS platforms</p>
          </div>

          <div style="padding: 2rem;">
            <form id="sisExportForm">
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Export Type</label>
                <select name="exportType" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" onchange="updateExportOptions(this.value)">
                  <option value="">Select Export Type</option>
                  <option value="admitted_students">Admitted Students</option>
                  <option value="enrolled_students">Enrolled Students</option>
                  <option value="status_updates">Status Updates</option>
                  <option value="batch_transfer">Batch Transfer</option>
                  <option value="full_sync">Full Synchronization</option>
                </select>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Target SIS Connection</label>
                <select name="targetConnection" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="">Select SIS Connection</option>
                  <option value="primary_sis">Primary SIS (Banner)</option>
                  <option value="legacy_system">Legacy System</option>
                  <option value="reporting_db">Reporting Database</option>
                </select>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Academic Term</label>
                <select name="academicTerm" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="">Select Term</option>
                  <option value="2024_fall">Fall 2024</option>
                  <option value="2025_spring">Spring 2025</option>
                  <option value="2025_summer">Summer 2025</option>
                  <option value="2025_fall">Fall 2025</option>
                </select>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Export Format</label>
                <select name="exportFormat" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="json">JSON (Recommended)</option>
                  <option value="xml">XML</option>
                  <option value="csv">CSV</option>
                  <option value="api_direct">Direct API Transfer</option>
                </select>
              </div>

              <div id="exportOptions" style="margin-bottom: 1.5rem;"></div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Data Security</label>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="encryptData" checked style="transform: scale(1.2);">
                    <span style="color: #374151;">Encrypt exported data (AES-256)</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="hashVerification" checked style="transform: scale(1.2);">
                    <span style="color: #374151;">Include data integrity hash</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="auditLog" checked style="transform: scale(1.2);">
                    <span style="color: #374151;">Create audit log entry</span>
                  </label>
                </div>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Export Notes (Optional)</label>
                <textarea name="exportNotes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical;" placeholder="Add notes about this export operation..."></textarea>
              </div>

              <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" onclick="closeSISExportModal()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button type="button" onclick="previewSISExport()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üëÅÔ∏è Preview</button>
                <button type="submit" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üì§ Start Export</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('sisExportForm').onsubmit = function(e) {
        e.preventDefault();
        executeSISExport(new FormData(this));
      };
    }

    function downloadSISExport(exportId) {
      showNotification(`Downloading export ${exportId}...`);
    }

    function retrySISExport(exportId) {
      showNotification(`Retrying export ${exportId}...`);
    }

    function startSISSync() {
      const modal = document.createElement('div');
      modal.id = 'startSISSyncModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üîÑ Sync Status Updates</h3>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Synchronize student status updates across all connected systems</p>
          </div>

          <div style="padding: 2rem;">
            <form id="sisSyncForm">
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Sync Type</label>
                <select name="syncType" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" onchange="updateSyncOptions(this.value)">
                  <option value="">Select Sync Type</option>
                  <option value="status_updates">Status Updates Only</option>
                  <option value="enrollment_changes">Enrollment Changes</option>
                  <option value="demographic_updates">Demographic Updates</option>
                  <option value="full_bidirectional">Full Bidirectional Sync</option>
                  <option value="batch_updates">Batch Status Updates</option>
                </select>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Source System</label>
                <select name="sourceSystem" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="">Select Source</option>
                  <option value="admissions">Admissions System (Primary)</option>
                  <option value="primary_sis">Primary SIS</option>
                  <option value="registrar">Registrar System</option>
                  <option value="external_api">External API Source</option>
                </select>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Target Systems</label>
                <div style="display: flex; flex-direction: column; gap: 0.75rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="targetSystems" value="primary_sis" checked style="transform: scale(1.2);">
                    <span style="color: #374151;">Primary SIS (Banner)</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="targetSystems" value="legacy_system" style="transform: scale(1.2);">
                    <span style="color: #374151;">Legacy System</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="targetSystems" value="reporting_db" style="transform: scale(1.2);">
                    <span style="color: #374151;">Reporting Database</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="targetSystems" value="external_partners" style="transform: scale(1.2);">
                    <span style="color: #374151;">External Partners</span>
                  </label>
                </div>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Date Range</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #6b7280;">From Date</label>
                    <input type="date" name="dateFrom" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #6b7280;">To Date</label>
                    <input type="date" name="dateTo" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  </div>
                </div>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Sync Options</label>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="validateData" checked style="transform: scale(1.2);">
                    <span style="color: #374151;">Validate data before sync</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="backupBeforeSync" checked style="transform: scale(1.2);">
                    <span style="color: #374151;">Create backup before sync</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="rollbackOnError" checked style="transform: scale(1.2);">
                    <span style="color: #374151;">Auto rollback on errors</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="notifyOnCompletion" style="transform: scale(1.2);">
                    <span style="color: #374151;">Send notification on completion</span>
                  </label>
                </div>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Batch Size</label>
                <select name="batchSize" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  <option value="50">50 records per batch</option>
                  <option value="100" selected>100 records per batch</option>
                  <option value="250">250 records per batch</option>
                  <option value="500">500 records per batch</option>
                  <option value="1000">1000 records per batch</option>
                </select>
              </div>

              <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" onclick="closeSISSyncModal()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button type="button" onclick="previewSISSync()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üëÅÔ∏è Preview</button>
                <button type="submit" style="background: #8b5cf6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üîÑ Start Sync</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('sisSyncForm').onsubmit = function(e) {
        e.preventDefault();
        executeSISSync(new FormData(this));
      };
    }

    function createSISMapping() {
      const modal = document.createElement('div');
      modal.id = 'createSISMappingModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">üó∫Ô∏è Create Field Mapping</h3>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Map admissions system fields to SIS fields for seamless data transfer</p>
          </div>

          <div style="padding: 2rem;">
            <form id="sisMappingForm">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Mapping Name</label>
                  <input type="text" name="mappingName" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="e.g., Banner Student Mapping">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Target SIS</label>
                  <select name="targetSIS" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                    <option value="">Select SIS Connection</option>
                    <option value="primary_sis">Primary SIS (Banner)</option>
                    <option value="legacy_system">Legacy System</option>
                    <option value="reporting_db">Reporting Database</option>
                  </select>
                </div>
              </div>

              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.125rem;">Field Mappings</h4>
                <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                  <div style="display: grid; grid-template-columns: 2fr 2fr 1fr 60px; gap: 1rem; margin-bottom: 1rem; font-weight: 600; color: #374151; font-size: 0.875rem;">
                    <div>Admissions Field</div>
                    <div>SIS Field</div>
                    <div>Transform</div>
                    <div>Action</div>
                  </div>

                  <div id="fieldMappings">
                    <div class="mapping-row" style="display: grid; grid-template-columns: 2fr 2fr 1fr 60px; gap: 1rem; margin-bottom: 0.75rem; align-items: center;">
                      <select name="admissionsField[]" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                        <option value="">Select Field</option>
                        <option value="student_id">Student ID</option>
                        <option value="first_name">First Name</option>
                        <option value="last_name">Last Name</option>
                        <option value="email">Email Address</option>
                        <option value="phone">Phone Number</option>
                        <option value="address">Address</option>
                        <option value="birth_date">Birth Date</option>
                        <option value="admission_status">Admission Status</option>
                        <option value="program_code">Program Code</option>
                        <option value="entry_term">Entry Term</option>
                        <option value="gpa">GPA</option>
                        <option value="test_scores">Test Scores</option>
                      </select>
                      <input type="text" name="sisField[]" required placeholder="Enter SIS field name" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                      <select name="transform[]" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                        <option value="">None</option>
                        <option value="uppercase">UPPERCASE</option>
                        <option value="lowercase">lowercase</option>
                        <option value="date_format">Date Format</option>
                        <option value="phone_format">Phone Format</option>
                        <option value="custom">Custom</option>
                      </select>
                      <button type="button" onclick="removeMappingRow(this)" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚úï</button>
                    </div>
                  </div>

                  <button type="button" onclick="addMappingRow()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem; margin-top: 0.5rem;">+ Add Field Mapping</button>
                </div>
              </div>

              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.125rem;">Data Transformation Rules</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                      <input type="checkbox" name="nullHandling" checked style="transform: scale(1.2);">
                      <span style="color: #374151; font-weight: 500;">Handle null values</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                      <input type="checkbox" name="dataValidation" checked style="transform: scale(1.2);">
                      <span style="color: #374151; font-weight: 500;">Validate data types</span>
                    </label>
                  </div>
                  <div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                      <input type="checkbox" name="duplicateCheck" style="transform: scale(1.2);">
                      <span style="color: #374151; font-weight: 500;">Check for duplicates</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                      <input type="checkbox" name="auditTrail" checked style="transform: scale(1.2);">
                      <span style="color: #374151; font-weight: 500;">Create audit trail</span>
                    </label>
                  </div>
                </div>
              </div>

              <div style="margin-bottom: 2rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Mapping Notes (Optional)</label>
                <textarea name="mappingNotes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical;" placeholder="Add notes about this field mapping configuration..."></textarea>
              </div>

              <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="closeSISMappingModal()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button type="button" onclick="testSISMapping()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üß™ Test Mapping</button>
                <button type="submit" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üíæ Save Mapping</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('sisMappingForm').onsubmit = function(e) {
        e.preventDefault();
        saveSISMapping(new FormData(this));
      };
    }

    function clearSISLogs() {
      if (confirm('Are you sure you want to clear all logs?')) {
        localStorage.setItem(SIS_STORAGE.logs, JSON.stringify([]));
        generateSISLogs();
        showNotification('Logs cleared successfully');
      }
    }

    // State Persistence Functions
    function loadSISState() {
      try {
        const savedState = localStorage.getItem('sis_system_state');
        return savedState ? JSON.parse(savedState) : getDefaultSISState();
      } catch (error) {
        console.warn('Error loading SIS state:', error);
        return getDefaultSISState();
      }
    }

    function saveSISState() {
      try {
        const modal = document.getElementById('sisIntegrationModal');
        if (!modal) return;

        const currentState = {
          // UI State
          isFullscreen: modal.classList.contains('sis-fullscreen'),
          activeTab: getCurrentActiveTab(),
          windowSize: {
            width: modal.style.width || '95%',
            height: modal.style.height || '95vh'
          },

          // User Preferences
          preferences: {
            autoRefresh: getSISPreference('autoRefresh', true),
            notificationsEnabled: getSISPreference('notificationsEnabled', true),
            showDebugLogs: getSISPreference('showDebugLogs', false),
            defaultExportFormat: getSISPreference('defaultExportFormat', 'json'),
            defaultBatchSize: getSISPreference('defaultBatchSize', 100),
            themeDark: getSISPreference('themeDark', false),
            autoRestore: getSISPreference('autoRestore', true)
          },

          // Connection Settings
          connectionDefaults: {
            sslEnabled: true,
            autoSync: false,
            timeout: 30000,
            retryAttempts: 3
          },

          // Export Settings
          exportDefaults: {
            encryptData: true,
            hashVerification: true,
            auditLog: true,
            includeMetadata: true
          },

          // Sync Settings
          syncDefaults: {
            validateData: true,
            backupBeforeSync: true,
            rollbackOnError: true,
            batchSize: 100
          },

          // System Status
          lastOpened: new Date().toISOString(),
          sessionCount: (getStoredState()?.sessionCount || 0) + 1,
          totalUsageTime: getStoredState()?.totalUsageTime || 0
        };

        localStorage.setItem('sis_system_state', JSON.stringify(currentState));

        // Also save individual preference items for easy access
        Object.entries(currentState.preferences).forEach(([key, value]) => {
          localStorage.setItem(`sis_pref_${key}`, JSON.stringify(value));
        });

        addSISLog('info', 'System state saved successfully');
      } catch (error) {
        console.error('Error saving SIS state:', error);
        addSISLog('error', 'Failed to save system state');
      }
    }

    function getDefaultSISState() {
      return {
        isFullscreen: false,
        activeTab: 'dashboard',
        windowSize: { width: '95%', height: '95vh' },
        preferences: {
          autoRefresh: true,
          notificationsEnabled: true,
          showDebugLogs: false,
          defaultExportFormat: 'json',
          defaultBatchSize: 100,
          themeDark: false,
          autoRestore: true
        },
        connectionDefaults: {
          sslEnabled: true,
          autoSync: false,
          timeout: 30000,
          retryAttempts: 3
        },
        exportDefaults: {
          encryptData: true,
          hashVerification: true,
          auditLog: true,
          includeMetadata: true
        },
        syncDefaults: {
          validateData: true,
          backupBeforeSync: true,
          rollbackOnError: true,
          batchSize: 100
        },
        lastOpened: new Date().toISOString(),
        sessionCount: 1,
        totalUsageTime: 0
      };
    }

    function applySISState(state) {
      if (!state) return;

      // Apply fullscreen state
      setTimeout(() => {
        if (state.isFullscreen) {
          toggleSISFullscreen();
        }
      }, 100);

      // Apply active tab
      setTimeout(() => {
        if (state.activeTab && state.activeTab !== 'dashboard') {
          switchSISTab(state.activeTab);
        }
      }, 150);

      // Apply user preferences to forms
      applyPreferencesToForms(state.preferences);

      // Update session info in dashboard
      updateSessionInfo(state);

      addSISLog('info', `System state restored - Session #${state.sessionCount}`);
    }

    function applyPreferencesToForms(preferences) {
      // Apply default values to new connection forms
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          const sslCheckboxes = document.querySelectorAll('input[name="enableSSL"]');
          sslCheckboxes.forEach(cb => cb.checked = preferences.sslEnabled || true);

          const autoSyncCheckboxes = document.querySelectorAll('input[name="autoSync"]');
          autoSyncCheckboxes.forEach(cb => cb.checked = preferences.autoSync || false);
        }, 200);
      });
    }

    function updateSessionInfo(state) {
      // Add session info to dashboard
      setTimeout(() => {
        const dashboardContent = document.getElementById('sis-dashboard-content');
        if (dashboardContent && !document.getElementById('sessionInfo')) {
          const sessionInfoHTML = `
            <div id="sessionInfo" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);">
              <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; opacity: 0.9;">Session Information</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                <div>
                  <p style="margin: 0; opacity: 0.8;">Session #</p>
                  <p style="margin: 0; font-size: 1.25rem; font-weight: 700;">${state.sessionCount}</p>
                </div>
                <div>
                  <p style="margin: 0; opacity: 0.8;">Last Opened</p>
                  <p style="margin: 0; font-size: 1rem; font-weight: 600;">${new Date(state.lastOpened).toLocaleDateString()}</p>
                </div>
                <div>
                  <p style="margin: 0; opacity: 0.8;">Active Tab</p>
                  <p style="margin: 0; font-size: 1rem; font-weight: 600; text-transform: capitalize;">${state.activeTab}</p>
                </div>
              </div>
            </div>
          `;
          dashboardContent.insertAdjacentHTML('afterbegin', sessionInfoHTML);
        }
      }, 300);
    }

    function getCurrentActiveTab() {
      const activeTabBtn = document.querySelector('.sis-tab-btn[style*="background: #3b82f6"]');
      return activeTabBtn ? activeTabBtn.getAttribute('data-tab') : 'dashboard';
    }

    function getSISPreference(key, defaultValue) {
      try {
        const stored = localStorage.getItem(`sis_pref_${key}`);
        return stored !== null ? JSON.parse(stored) : defaultValue;
      } catch {
        return defaultValue;
      }
    }

    function setSISPreference(key, value) {
      try {
        localStorage.setItem(`sis_pref_${key}`, JSON.stringify(value));
        saveSISState(); // Save complete state when preferences change
      } catch (error) {
        console.error('Error setting SIS preference:', error);
      }
    }

    function getStoredState() {
      try {
        const stored = localStorage.getItem('sis_system_state');
        return stored ? JSON.parse(stored) : null;
      } catch {
        return null;
      }
    }

    // Supporting functions for enhanced SIS functionality
    function toggleAuthFields(authMethod) {
      const authFields = document.getElementById('authFields');
      if (!authFields) return;

      let fieldsHTML = '';
      switch (authMethod) {
        case 'api_key':
          fieldsHTML = `
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">API Key</label>
            <input type="password" name="apiKey" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="Enter your API key">
          `;
          break;
        case 'oauth2':
          fieldsHTML = `
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Client ID</label>
              <input type="text" name="clientId" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="OAuth client ID">
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Client Secret</label>
              <input type="password" name="clientSecret" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="OAuth client secret">
            </div>
          `;
          break;
        case 'basic':
          fieldsHTML = `
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Username</label>
              <input type="text" name="username" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="Username">
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Password</label>
              <input type="password" name="password" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="Password">
            </div>
          `;
          break;
        case 'bearer':
          fieldsHTML = `
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Bearer Token</label>
            <input type="password" name="bearerToken" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="Enter bearer token">
          `;
          break;
      }
      authFields.innerHTML = fieldsHTML;
    }

    function closeSISConnectionModal() {
      const modal = document.getElementById('addSISConnectionModal');
      if (modal) modal.remove();
    }

    function testSISConnectionSetup() {
      showNotification('Testing connection...', 'info');
      setTimeout(() => {
        showNotification('Connection test successful! ‚úì', 'success');
      }, 2000);
    }

    function saveSISConnection(formData) {
      const connectionData = {
        id: 'conn_' + Date.now(),
        name: formData.get('connectionName'),
        provider: formData.get('sisProvider'),
        url: formData.get('apiUrl'),
        authMethod: formData.get('authMethod'),
        sslEnabled: formData.get('enableSSL') === 'on',
        autoSync: formData.get('autoSync') === 'on',
        status: 'active',
        createdAt: new Date().toISOString(),
        lastSync: new Date().toISOString()
      };

      const connections = JSON.parse(localStorage.getItem(SIS_STORAGE.connections) || '[]');
      connections.push(connectionData);
      localStorage.setItem(SIS_STORAGE.connections, JSON.stringify(connections));

      generateSISConnections();
      closeSISConnectionModal();
      showNotification('SIS connection saved successfully!', 'success');

      addSISLog('info', `New SIS connection created: ${connectionData.name}`);
    }

    function updateExportOptions(exportType) {
      const optionsDiv = document.getElementById('exportOptions');
      if (!optionsDiv) return;

      let optionsHTML = '';
      switch (exportType) {
        case 'admitted_students':
          optionsHTML = `
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Include Fields</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="includeFields" value="demographics" checked style="transform: scale(1.1);">
                <span style="color: #374151;">Demographics</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="includeFields" value="academic" checked style="transform: scale(1.1);">
                <span style="color: #374151;">Academic Records</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="includeFields" value="financial" style="transform: scale(1.1);">
                <span style="color: #374151;">Financial Aid</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="includeFields" value="contact" checked style="transform: scale(1.1);">
                <span style="color: #374151;">Contact Info</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="includeFields" value="emergency" style="transform: scale(1.1);">
                <span style="color: #374151;">Emergency Contacts</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="includeFields" value="documents" style="transform: scale(1.1);">
                <span style="color: #374151;">Document References</span>
              </label>
            </div>
          `;
          break;
        case 'batch_transfer':
          optionsHTML = `
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Batch Configuration</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #6b7280;">Records per batch</label>
                <select name="batchSize" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option value="50">50</option>
                  <option value="100" selected>100</option>
                  <option value="250">250</option>
                  <option value="500">500</option>
                </select>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #6b7280;">Transfer method</label>
                <select name="transferMethod" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option value="api">API Transfer</option>
                  <option value="file">File Upload</option>
                  <option value="sftp">SFTP</option>
                </select>
              </div>
            </div>
          `;
          break;
      }
      optionsDiv.innerHTML = optionsHTML;
    }

    function closeSISExportModal() {
      const modal = document.getElementById('startSISExportModal');
      if (modal) modal.remove();
    }

    function previewSISExport() {
      showNotification('Generating export preview...', 'info');
      setTimeout(() => {
        showNotification('Preview ready: 142 records will be exported', 'success');
      }, 1500);
    }

    function executeSISExport(formData) {
      const exportData = {
        id: 'export_' + Date.now(),
        type: formData.get('exportType'),
        targetConnection: formData.get('targetConnection'),
        academicTerm: formData.get('academicTerm'),
        format: formData.get('exportFormat'),
        encrypted: formData.get('encryptData') === 'on',
        status: 'in_progress',
        createdAt: new Date().toISOString(),
        recordCount: Math.floor(Math.random() * 300) + 50,
        notes: formData.get('exportNotes') || ''
      };

      const exports = JSON.parse(localStorage.getItem(SIS_STORAGE.exports) || '[]');
      exports.push(exportData);
      localStorage.setItem(SIS_STORAGE.exports, JSON.stringify(exports));

      generateSISExports();
      closeSISExportModal();
      showNotification('Export started successfully! Processing...', 'success');

      addSISLog('info', `Export initiated: ${exportData.type} to ${exportData.targetConnection}`);

      // Simulate export completion
      setTimeout(() => {
        exportData.status = 'completed';
        localStorage.setItem(SIS_STORAGE.exports, JSON.stringify(exports));
        generateSISExports();
        showNotification(`Export completed: ${exportData.recordCount} records exported`, 'success');
        addSISLog('success', `Export completed: ${exportData.recordCount} records exported to ${exportData.targetConnection}`);
      }, 5000);
    }

    function updateSyncOptions(syncType) {
      // This function can be used to update sync-specific options based on the selected type
      // Implementation can be added as needed
    }

    function closeSISSyncModal() {
      const modal = document.getElementById('startSISSyncModal');
      if (modal) modal.remove();
    }

    function previewSISSync() {
      showNotification('Analyzing sync requirements...', 'info');
      setTimeout(() => {
        showNotification('Sync preview: 89 records to update, 23 new records', 'success');
      }, 2000);
    }

    function executeSISSync(formData) {
      const syncData = {
        id: 'sync_' + Date.now(),
        type: formData.get('syncType'),
        sourceSystem: formData.get('sourceSystem'),
        targetSystems: formData.getAll('targetSystems'),
        dateFrom: formData.get('dateFrom'),
        dateTo: formData.get('dateTo'),
        batchSize: formData.get('batchSize'),
        validateData: formData.get('validateData') === 'on',
        backupBeforeSync: formData.get('backupBeforeSync') === 'on',
        rollbackOnError: formData.get('rollbackOnError') === 'on',
        status: 'in_progress',
        createdAt: new Date().toISOString()
      };

      closeSISSyncModal();
      showNotification('Sync process started! Validating data...', 'info');

      addSISLog('info', `Sync started: ${syncData.type} from ${syncData.sourceSystem}`);

      // Simulate sync process with multiple stages
      setTimeout(() => {
        showNotification('Data validation completed. Starting synchronization...', 'info');
        addSISLog('info', 'Data validation completed successfully');
      }, 2000);

      setTimeout(() => {
        showNotification('Synchronization in progress... (50% complete)', 'info');
      }, 4000);

      setTimeout(() => {
        const recordsProcessed = Math.floor(Math.random() * 200) + 50;
        showNotification(`Sync completed successfully! ${recordsProcessed} records processed`, 'success');
        addSISLog('success', `Sync completed: ${recordsProcessed} records synchronized across ${syncData.targetSystems.length} systems`);
      }, 7000);
    }

    function addSISLog(level, message) {
      const logs = JSON.parse(localStorage.getItem(SIS_STORAGE.logs) || '[]');
      logs.unshift({
        id: 'log_' + Date.now(),
        timestamp: new Date().toISOString(),
        level: level.toUpperCase(),
        message: message,
        source: 'SIS Integration'
      });

      // Keep only the last 100 logs
      if (logs.length > 100) {
        logs.splice(100);
      }

      localStorage.setItem(SIS_STORAGE.logs, JSON.stringify(logs));
      generateSISLogs();
    }

    // Fullscreen functionality
    function toggleSISFullscreen() {
      const modal = document.getElementById('sisIntegrationModal');
      const modalContent = modal.querySelector('div');
      const fullscreenBtn = document.getElementById('sisFullscreenBtn');
      const fullscreenText = document.getElementById('fullscreenText');
      const fullscreenIcon = fullscreenBtn.querySelector('svg');

      if (!modal.classList.contains('sis-fullscreen')) {
        // Enter fullscreen
        modal.classList.add('sis-fullscreen');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 25000;';
        modalContent.style.cssText = 'background: white; border-radius: 0; width: 100%; height: 100%; overflow: hidden; display: flex; flex-direction: column; box-shadow: none;';

        fullscreenText.textContent = 'Exit Fullscreen';
        fullscreenIcon.innerHTML = `<path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5zM0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zm10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4z"/>`;
        fullscreenBtn.title = 'Exit fullscreen';

        // Hide scrollbars on body when in fullscreen
        document.body.style.overflow = 'hidden';

        showNotification('SIS Integration in fullscreen mode', 'info');
        addSISLog('info', 'SIS Integration switched to fullscreen mode');
        saveSISState();
      } else {
        // Exit fullscreen
        modal.classList.remove('sis-fullscreen');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';
        modalContent.style.cssText = 'background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 95vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);';

        fullscreenText.textContent = 'Fullscreen';
        fullscreenIcon.innerHTML = `<path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>`;
        fullscreenBtn.title = 'Toggle fullscreen';

        // Restore body scrollbars
        document.body.style.overflow = '';

        showNotification('Exited fullscreen mode', 'info');
        addSISLog('info', 'SIS Integration exited fullscreen mode');
        saveSISState();
      }
    }

    // Keyboard shortcuts for SIS Integration
    function handleSISKeyboard(event) {
      const modal = document.getElementById('sisIntegrationModal');
      if (!modal) return;

      // Only handle shortcuts when SIS modal is open
      switch(event.key) {
        case 'Escape':
          // ESC to close or exit fullscreen
          if (modal.classList.contains('sis-fullscreen')) {
            toggleSISFullscreen();
          } else {
            closeSISIntegrationSystem();
          }
          event.preventDefault();
          break;
        case 'F11':
          // F11 to toggle fullscreen
          toggleSISFullscreen();
          event.preventDefault();
          break;
        case 'f':
          // Ctrl+F or Cmd+F to toggle fullscreen
          if (event.ctrlKey || event.metaKey) {
            toggleSISFullscreen();
            event.preventDefault();
          }
          break;
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
          // Alt + number to switch tabs
          if (event.altKey) {
            const tabs = ['dashboard', 'connections', 'export', 'sync', 'mapping', 'logs'];
            const tabIndex = parseInt(event.key) - 1;
            if (tabs[tabIndex]) {
              switchSISTab(tabs[tabIndex]);
              event.preventDefault();
            }
          }
          break;
      }
    }

    // Show keyboard shortcuts help
    function showSISKeyboardShortcuts() {
      const modal = document.createElement('div');
      modal.id = 'sisShortcutsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px; padding: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: #1e293b; font-size: 1.5rem; font-weight: 700;">‚å®Ô∏è Keyboard Shortcuts</h3>
            <button onclick="closeSISShortcutsModal()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; font-size: 1.25rem;">√ó</button>
          </div>

          <div style="space-y: 1rem;">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">F11</strong>
              <span style="color: #6b7280;">Toggle fullscreen mode</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">Ctrl + F</strong>
              <span style="color: #6b7280;">Toggle fullscreen mode</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">ESC</strong>
              <span style="color: #6b7280;">Exit fullscreen or close system</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">Alt + 1</strong>
              <span style="color: #6b7280;">Switch to Dashboard tab</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">Alt + 2</strong>
              <span style="color: #6b7280;">Switch to Connections tab</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">Alt + 3</strong>
              <span style="color: #6b7280;">Switch to Export tab</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">Alt + 4</strong>
              <span style="color: #6b7280;">Switch to Sync tab</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">Alt + 5</strong>
              <span style="color: #6b7280;">Switch to Mapping tab</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.75rem;">
              <strong style="color: #374151;">Alt + 6</strong>
              <span style="color: #6b7280;">Switch to Logs tab</span>
            </div>
          </div>

          <div style="margin-top: 2rem; text-align: center;">
            <button onclick="closeSISShortcutsModal()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">Got it!</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function closeSISShortcutsModal() {
      const modal = document.getElementById('sisShortcutsModal');
      if (modal) modal.remove();
    }

    // Show preferences modal
    function showSISPreferences() {
      const currentState = loadSISState();
      const modal = document.createElement('div');
      modal.id = 'sisPreferencesModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 30000;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">‚öôÔ∏è SIS Integration Preferences</h3>
              <button onclick="closeSISPreferencesModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; font-size: 1.25rem;">√ó</button>
            </div>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Customize your SIS Integration experience</p>
          </div>

          <div style="padding: 2rem;">
            <form id="sisPreferencesForm">
              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.125rem;">User Interface</h4>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                  <label style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                    <span style="color: #374151; font-weight: 500;">Enable notifications</span>
                    <input type="checkbox" name="notificationsEnabled" ${currentState.preferences.notificationsEnabled ? 'checked' : ''} style="transform: scale(1.3);">
                  </label>
                  <label style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                    <span style="color: #374151; font-weight: 500;">Auto refresh data</span>
                    <input type="checkbox" name="autoRefresh" ${currentState.preferences.autoRefresh ? 'checked' : ''} style="transform: scale(1.3);">
                  </label>
                  <label style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                    <span style="color: #374151; font-weight: 500;">Show debug logs</span>
                    <input type="checkbox" name="showDebugLogs" ${currentState.preferences.showDebugLogs ? 'checked' : ''} style="transform: scale(1.3);">
                  </label>
                  <label style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                    <span style="color: #374151; font-weight: 500;">Auto-restore after page refresh</span>
                    <input type="checkbox" name="autoRestore" ${currentState.preferences.autoRestore ? 'checked' : ''} style="transform: scale(1.3);">
                  </label>
                </div>
              </div>

              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.125rem;">Default Settings</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Default Export Format</label>
                    <select name="defaultExportFormat" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px;">
                      <option value="json" ${currentState.preferences.defaultExportFormat === 'json' ? 'selected' : ''}>JSON</option>
                      <option value="xml" ${currentState.preferences.defaultExportFormat === 'xml' ? 'selected' : ''}>XML</option>
                      <option value="csv" ${currentState.preferences.defaultExportFormat === 'csv' ? 'selected' : ''}>CSV</option>
                      <option value="api_direct" ${currentState.preferences.defaultExportFormat === 'api_direct' ? 'selected' : ''}>Direct API</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Default Batch Size</label>
                    <select name="defaultBatchSize" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px;">
                      <option value="50" ${currentState.preferences.defaultBatchSize === 50 ? 'selected' : ''}>50 records</option>
                      <option value="100" ${currentState.preferences.defaultBatchSize === 100 ? 'selected' : ''}>100 records</option>
                      <option value="250" ${currentState.preferences.defaultBatchSize === 250 ? 'selected' : ''}>250 records</option>
                      <option value="500" ${currentState.preferences.defaultBatchSize === 500 ? 'selected' : ''}>500 records</option>
                      <option value="1000" ${currentState.preferences.defaultBatchSize === 1000 ? 'selected' : ''}>1000 records</option>
                    </select>
                  </div>
                </div>
              </div>

              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.125rem;">Security Defaults</h4>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                  <label style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                    <span style="color: #374151; font-weight: 500;">Always encrypt exported data</span>
                    <input type="checkbox" name="alwaysEncrypt" ${currentState.exportDefaults.encryptData ? 'checked' : ''} style="transform: scale(1.3);">
                  </label>
                  <label style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                    <span style="color: #374151; font-weight: 500;">Backup before sync operations</span>
                    <input type="checkbox" name="alwaysBackup" ${currentState.syncDefaults.backupBeforeSync ? 'checked' : ''} style="transform: scale(1.3);">
                  </label>
                  <label style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                    <span style="color: #374151; font-weight: 500;">Create audit logs</span>
                    <input type="checkbox" name="auditLogs" ${currentState.exportDefaults.auditLog ? 'checked' : ''} style="transform: scale(1.3);">
                  </label>
                </div>
              </div>

              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.125rem;">Session Information</h4>
                <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                    <div>
                      <p style="margin: 0; color: #6b7280;">Current Session</p>
                      <p style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #1e293b;">#${currentState.sessionCount}</p>
                    </div>
                    <div>
                      <p style="margin: 0; color: #6b7280;">Last Opened</p>
                      <p style="margin: 0; font-weight: 600; color: #1e293b;">${new Date(currentState.lastOpened).toLocaleString()}</p>
                    </div>
                    <div>
                      <p style="margin: 0; color: #6b7280;">Data Storage</p>
                      <p style="margin: 0; font-weight: 600; color: #1e293b;">${Object.keys(localStorage).filter(k => k.startsWith('sis_')).length} items</p>
                    </div>
                  </div>
                </div>
              </div>

              <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="resetSISPreferences()" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">Reset to Defaults</button>
                <button type="button" onclick="closeSISPreferencesModal()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button type="submit" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üíæ Save Preferences</button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('sisPreferencesForm').onsubmit = function(e) {
        e.preventDefault();
        saveSISPreferences(new FormData(this));
      };
    }

    function closeSISPreferencesModal() {
      const modal = document.getElementById('sisPreferencesModal');
      if (modal) modal.remove();
    }

    function saveSISPreferences(formData) {
      const preferences = {
        notificationsEnabled: formData.get('notificationsEnabled') === 'on',
        autoRefresh: formData.get('autoRefresh') === 'on',
        showDebugLogs: formData.get('showDebugLogs') === 'on',
        autoRestore: formData.get('autoRestore') === 'on',
        defaultExportFormat: formData.get('defaultExportFormat'),
        defaultBatchSize: parseInt(formData.get('defaultBatchSize')),
        alwaysEncrypt: formData.get('alwaysEncrypt') === 'on',
        alwaysBackup: formData.get('alwaysBackup') === 'on',
        auditLogs: formData.get('auditLogs') === 'on'
      };

      // Save individual preferences
      Object.entries(preferences).forEach(([key, value]) => {
        setSISPreference(key, value);
      });

      closeSISPreferencesModal();
      showNotification('Preferences saved successfully!', 'success');
      addSISLog('info', 'User preferences updated');
    }

    function resetSISPreferences() {
      if (confirm('Are you sure you want to reset all preferences to defaults? This cannot be undone.')) {
        const defaultState = getDefaultSISState();

        // Clear all existing preferences
        Object.keys(localStorage).filter(key => key.startsWith('sis_pref_')).forEach(key => {
          localStorage.removeItem(key);
        });

        // Reset to defaults
        Object.entries(defaultState.preferences).forEach(([key, value]) => {
          setSISPreference(key, value);
        });

        // Reset state
        localStorage.setItem('sis_system_state', JSON.stringify(defaultState));

        closeSISPreferencesModal();
        showNotification('Preferences reset to defaults', 'success');
        addSISLog('info', 'User preferences reset to defaults');

        // Refresh the preferences modal if user wants to see changes
        setTimeout(() => {
          if (confirm('Would you like to reopen preferences to see the reset values?')) {
            showSISPreferences();
          }
        }, 500);
      }
    }

    // Field Mapping Functions
    function addMappingRow() {
      const mappingsContainer = document.getElementById('fieldMappings');
      const newRow = document.createElement('div');
      newRow.className = 'mapping-row';
      newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 2fr 1fr 60px; gap: 1rem; margin-bottom: 0.75rem; align-items: center;';

      newRow.innerHTML = `
        <select name="admissionsField[]" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
          <option value="">Select Field</option>
          <option value="student_id">Student ID</option>
          <option value="first_name">First Name</option>
          <option value="last_name">Last Name</option>
          <option value="email">Email Address</option>
          <option value="phone">Phone Number</option>
          <option value="address">Address</option>
          <option value="birth_date">Birth Date</option>
          <option value="admission_status">Admission Status</option>
          <option value="program_code">Program Code</option>
          <option value="entry_term">Entry Term</option>
          <option value="gpa">GPA</option>
          <option value="test_scores">Test Scores</option>
        </select>
        <input type="text" name="sisField[]" required placeholder="Enter SIS field name" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
        <select name="transform[]" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
          <option value="">None</option>
          <option value="uppercase">UPPERCASE</option>
          <option value="lowercase">lowercase</option>
          <option value="date_format">Date Format</option>
          <option value="phone_format">Phone Format</option>
          <option value="custom">Custom</option>
        </select>
        <button type="button" onclick="removeMappingRow(this)" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚úï</button>
      `;

      mappingsContainer.appendChild(newRow);
    }

    function removeMappingRow(button) {
      const row = button.closest('.mapping-row');
      if (row && document.querySelectorAll('.mapping-row').length > 1) {
        row.remove();
      } else {
        showNotification('At least one field mapping is required', 'warning');
      }
    }

    function closeSISMappingModal() {
      const modal = document.getElementById('createSISMappingModal');
      if (modal) modal.remove();
    }

    function testSISMapping() {
      showNotification('Testing field mapping configuration...', 'info');
      setTimeout(() => {
        showNotification('Mapping test successful! All fields validated ‚úì', 'success');
      }, 2000);
    }

    function saveSISMapping(formData) {
      const admissionsFields = formData.getAll('admissionsField[]');
      const sisFields = formData.getAll('sisField[]');
      const transforms = formData.getAll('transform[]');

      const fieldMappings = admissionsFields.map((field, index) => ({
        admissionsField: field,
        sisField: sisFields[index],
        transform: transforms[index] || 'none'
      })).filter(mapping => mapping.admissionsField && mapping.sisField);

      const mappingData = {
        id: 'mapping_' + Date.now(),
        name: formData.get('mappingName'),
        targetSIS: formData.get('targetSIS'),
        fieldMappings: fieldMappings,
        rules: {
          nullHandling: formData.get('nullHandling') === 'on',
          dataValidation: formData.get('dataValidation') === 'on',
          duplicateCheck: formData.get('duplicateCheck') === 'on',
          auditTrail: formData.get('auditTrail') === 'on'
        },
        notes: formData.get('mappingNotes') || '',
        status: 'active',
        createdAt: new Date().toISOString(),
        lastUsed: null
      };

      const mappings = JSON.parse(localStorage.getItem(SIS_STORAGE.mappings) || '[]');
      mappings.push(mappingData);
      localStorage.setItem(SIS_STORAGE.mappings, JSON.stringify(mappings));

      generateSISMapping();
      closeSISMappingModal();
      showNotification(`Field mapping "${mappingData.name}" saved successfully!`, 'success');

      addSISLog('info', `New field mapping created: ${mappingData.name} for ${mappingData.targetSIS}`);
    }

    // Auto-restore SIS Integration system if it was open before refresh
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        const wasSystemOpen = localStorage.getItem('sis_system_open');
        const autoRestore = getSISPreference('autoRestore', true);

        if (wasSystemOpen === 'true' && autoRestore) {
          // Show restoration indicator
          const restorationIndicator = document.createElement('div');
          restorationIndicator.id = 'sisRestorationIndicator';
          restorationIndicator.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 2rem 3rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
            z-index: 20000;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          `;

          restorationIndicator.innerHTML = `
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
              <div>
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">üîó Restoring SIS Integration</h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Reopening your previous session...</p>
              </div>
            </div>
            <style>
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            </style>
          `;

          document.body.appendChild(restorationIndicator);

          showNotification('Restoring SIS Integration System...', 'info');

          setTimeout(() => {
            openSISIntegrationSystem();

            // Remove restoration indicator after SIS opens
            setTimeout(() => {
              if (restorationIndicator && restorationIndicator.parentNode) {
                restorationIndicator.remove();
              }
              showNotification('SIS Integration System restored successfully!', 'success');
            }, 1000);
          }, 1500);
        }
      }, 200);
    });

    function openReportingDashboard() {
      showNotification('Loading Analytics Dashboard...');

      const modal = document.createElement('div');
      modal.id = 'reportingDashboardModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';

      modal.innerHTML = '<div style="background: white; border-radius: 12px; padding: 2rem; max-width: 900px; max-height: 90vh; overflow-y: auto;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem;"><h2 style="margin: 0; color: #1f2937;">üìä Analytics Dashboard</h2><div style="display: flex; gap: 0.5rem;"><button onclick="toggleDashboardFullscreen()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üîç Fullscreen</button><button onclick="exportBasicData()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üì• Export</button><button onclick="closeReportingDashboard()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‚Üê Back to Admissions</button></div></div><div id="dashboardSimpleContent">Loading analytics...</div></div>';

      document.body.appendChild(modal);

      // Add ESC key listener for normal close
      document.addEventListener('keydown', handleDashboardEsc);

      setTimeout(() => loadSimpleDashboard(), 100);
    }

    function generateAdvancedAnalyticsData() {
      const programs = ['Computer Science', 'Business Administration', 'Engineering', 'Medicine', 'Arts & Sciences', 'Law', 'Psychology', 'Data Science', 'Economics', 'Biology'];
      const statuses = ['Applied', 'Under Review', 'Interview Scheduled', 'Interviewed', 'Accepted', 'Rejected', 'Waitlisted', 'Enrolled', 'Deferred'];
      const regions = ['North America', 'Europe', 'Asia Pacific', 'Latin America', 'Middle East', 'Africa', 'Oceania'];
      const reviewers = ['Dr. Sarah Smith', 'Prof. Michael Johnson', 'Dr. Emily Williams', 'Prof. David Brown', 'Dr. Jessica Davis', 'Prof. Robert Miller', 'Dr. Lisa Wilson', 'Prof. James Moore'];
      const sources = ['Website', 'Education Fair', 'Social Media', 'Referral', 'Agent', 'Search Engine', 'Advertisement'];

      const applications = [];
      const currentYear = new Date().getFullYear();

      for (let i = 0; i < 2850; i++) {
        const submissionDate = new Date(currentYear, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
        const daysSinceSubmission = Math.floor((new Date() - submissionDate) / (1000 * 60 * 60 * 24));

        applications.push({
          id: 'APP' + (i + 1).toString().padStart(5, '0'),
          applicantName: generateRandomName(),
          program: programs[Math.floor(Math.random() * programs.length)],
          status: statuses[Math.floor(Math.random() * statuses.length)],
          submissionDate: submissionDate,
          region: regions[Math.floor(Math.random() * regions.length)],
          reviewer: reviewers[Math.floor(Math.random() * reviewers.length)],
          gpa: (Math.random() * 1.5 + 2.5).toFixed(2),
          testScore: Math.floor(Math.random() * 400) + 1200,
          isInternational: Math.random() > 0.65,
          source: sources[Math.floor(Math.random() * sources.length)],
          priority: Math.random() > 0.85 ? 'High' : Math.random() > 0.7 ? 'Medium' : 'Normal',
          decisionTime: Math.floor(Math.random() * 45) + 5,
          age: Math.floor(Math.random() * 15) + 18,
          daysSinceSubmission: daysSinceSubmission,
          tuitionPaid: Math.random() > 0.3,
          scholarshipAmount: Math.floor(Math.random() * 25000),
          essayScore: Math.floor(Math.random() * 10) + 1,
          interviewScore: Math.floor(Math.random() * 10) + 1
        });
      }

      return { applications, programs, statuses, regions, reviewers, sources };
    }

    function generateRandomName() {
      const firstNames = ['John', 'Sarah', 'Michael', 'Emily', 'David', 'Jessica', 'Robert', 'Ashley', 'William', 'Amanda', 'James', 'Lisa', 'Christopher', 'Nicole', 'Daniel', 'Elizabeth'];
      const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Davis', 'Miller', 'Wilson', 'Moore', 'Taylor', 'Anderson', 'Thomas', 'Jackson', 'White', 'Harris', 'Martin', 'Thompson'];
      return firstNames[Math.floor(Math.random() * firstNames.length)] + ' ' + lastNames[Math.floor(Math.random() * lastNames.length)];
    }

    function loadSimpleDashboard() {
      const contentDiv = document.getElementById('dashboardSimpleContent');
      if (!contentDiv) return;

      showNotification('Generating advanced analytics...', 'info');

      const data = generateAdvancedAnalyticsData();
      window.advancedDashboardData = data;

      setTimeout(() => {
        generateAdvancedDashboardContent(contentDiv, data);
      }, 500);
    }

    function generateAdvancedDashboardContent(contentDiv, data) {
      const { applications } = data;

      // Calculate comprehensive metrics
      const totalApps = applications.length;
      const statusCounts = {};
      const programCounts = {};
      const regionCounts = {};
      const sourceCounts = {};
      const monthlyData = {};

      let totalGPA = 0;
      let totalTestScore = 0;
      let totalDecisionTime = 0;
      let acceptedCount = 0;
      let internationalCount = 0;
      let totalScholarships = 0;

      applications.forEach(app => {
        statusCounts[app.status] = (statusCounts[app.status] || 0) + 1;
        programCounts[app.program] = (programCounts[app.program] || 0) + 1;
        regionCounts[app.region] = (regionCounts[app.region] || 0) + 1;
        sourceCounts[app.source] = (sourceCounts[app.source] || 0) + 1;

        const monthKey = app.submissionDate.toISOString().slice(0, 7);
        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;

        totalGPA += parseFloat(app.gpa);
        totalTestScore += app.testScore;
        totalDecisionTime += app.decisionTime;
        totalScholarships += app.scholarshipAmount;

        if (app.status === 'Accepted') acceptedCount++;
        if (app.isInternational) internationalCount++;
      });

      const avgGPA = (totalGPA / totalApps).toFixed(2);
      const avgTestScore = Math.round(totalTestScore / totalApps);
      const avgDecisionTime = Math.round(totalDecisionTime / totalApps);
      const acceptanceRate = ((acceptedCount / totalApps) * 100).toFixed(1);
      const internationalRate = ((internationalCount / totalApps) * 100).toFixed(1);
      const avgScholarship = Math.round(totalScholarships / totalApps);

      contentDiv.innerHTML = generateAdvancedHTML({
        totalApps, statusCounts, programCounts, regionCounts, sourceCounts, monthlyData,
        avgGPA, avgTestScore, avgDecisionTime, acceptanceRate, internationalRate, avgScholarship, applications
      });
    }

    function generateAdvancedHTML(metrics) {
      return '<div style="display: flex; flex-direction: column; gap: 2rem; height: 100%; overflow-y: auto;">' +
        generateKPICards(metrics) +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">' +
          generateStatusChart(metrics.statusCounts) +
          generateProgramChart(metrics.programCounts) +
        '</div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">' +
          generateRegionChart(metrics.regionCounts) +
          generateSourceChart(metrics.sourceCounts) +
        '</div>' +
        generateTimelineChart(metrics.monthlyData) +
        generateFunnelAnalysis(metrics.statusCounts) +
        generateReviewerWorkload(metrics.applications) +
        generateRecentApplicationsTable(metrics.applications.slice(0, 15)) +
        generateAdvancedFilters() +
      '</div>';
    }

    function generateKPICards(metrics) {
      return '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">' +
        '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);"><div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">' + metrics.totalApps.toLocaleString() + '</div><div style="opacity: 0.9; font-weight: 500;">Total Applications</div><div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">üìà +12% vs last year</div></div>' +
        '<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);"><div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">' + metrics.acceptanceRate + '%</div><div style="opacity: 0.9; font-weight: 500;">Acceptance Rate</div><div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">üéØ Industry avg: 18%</div></div>' +
        '<div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);"><div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">' + metrics.avgDecisionTime + '</div><div style="opacity: 0.9; font-weight: 500;">Avg Decision Days</div><div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">‚ö° -3 days vs target</div></div>' +
        '<div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);"><div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">' + metrics.internationalRate + '%</div><div style="opacity: 0.9; font-weight: 500;">International Students</div><div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">üåç From 7 regions</div></div>' +
        '<div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);"><div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">' + metrics.avgGPA + '</div><div style="opacity: 0.9; font-weight: 500;">Average GPA</div><div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">üìö Range: 2.5-4.0</div></div>' +
        '<div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #374151; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(168, 237, 234, 0.3);"><div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">$' + metrics.avgScholarship.toLocaleString() + '</div><div style="opacity: 0.9; font-weight: 500;">Avg Scholarship</div><div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">üí∞ Total awarded: $' + (metrics.avgScholarship * metrics.totalApps / 1000000).toFixed(1) + 'M</div></div>' +
      '</div>';
    }

    function generateStatusChart(statusCounts) {
      const colors = { 'Applied': '#3b82f6', 'Under Review': '#f59e0b', 'Interview Scheduled': '#8b5cf6', 'Interviewed': '#06b6d4', 'Accepted': '#10b981', 'Rejected': '#ef4444', 'Waitlisted': '#6b7280', 'Enrolled': '#059669', 'Deferred': '#84cc16' };
      const total = Object.values(statusCounts).reduce((a, b) => a + b, 0);

      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üìä Application Status Distribution</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem;">' +
        Object.entries(statusCounts).map(([status, count]) => {
          const percentage = ((count / total) * 100).toFixed(1);
          const height = Math.max(40, (count / Math.max(...Object.values(statusCounts))) * 120);
          return '<div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;"><div style="text-align: center; font-size: 0.75rem; color: #6b7280; font-weight: 600;"><div style="font-size: 1.25rem; font-weight: 800; color: #1f2937;">' + count + '</div>' + percentage + '%</div><div style="width: 30px; height: ' + height + 'px; background: linear-gradient(180deg, ' + (colors[status] || '#6b7280') + ' 0%, ' + (colors[status] || '#6b7280') + '80 100%); border-radius: 4px 4px 0 0; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div><span style="font-size: 0.7rem; color: #374151; writing-mode: vertical-lr; text-orientation: mixed; max-width: 30px; text-align: center; font-weight: 500;">' + status + '</span></div>';
        }).join('') + '</div></div>';
    }

    function generateProgramChart(programCounts) {
      const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#a8edea', '#ffeaa7', '#fd79a8', '#6c5ce7', '#00cec9'];
      const total = Object.values(programCounts).reduce((a, b) => a + b, 0);

      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üéì Program Distribution</h3><div style="display: flex; flex-direction: column; gap: 0.75rem;">' +
        Object.entries(programCounts).slice(0, 8).map(([program, count], index) => {
          const percentage = ((count / total) * 100).toFixed(1);
          const width = (count / Math.max(...Object.values(programCounts))) * 100;
          return '<div style="display: flex; align-items: center; gap: 1rem;"><div style="min-width: 120px; font-size: 0.875rem; font-weight: 500; color: #374151;">' + program + '</div><div style="flex: 1; background: #f1f5f9; border-radius: 8px; overflow: hidden;"><div style="height: 24px; background: linear-gradient(90deg, ' + colors[index % colors.length] + ' 0%, ' + colors[index % colors.length] + '80 100%); width: ' + width + '%; border-radius: 8px; display: flex; align-items: center; justify-content: end; padding: 0 0.5rem; color: white; font-size: 0.75rem; font-weight: 600; transition: all 0.3s ease;">' + count + '</div></div><div style="min-width: 50px; text-align: right; font-size: 0.875rem; font-weight: 600; color: #1f2937;">' + percentage + '%</div></div>';
        }).join('') + '</div></div>';
    }

    function generateRegionChart(regionCounts) {
      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16'];
      const total = Object.values(regionCounts).reduce((a, b) => a + b, 0);

      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üåç Geographic Distribution</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">' +
        Object.entries(regionCounts).map(([region, count], index) => {
          const percentage = ((count / total) * 100).toFixed(1);
          return '<div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid ' + colors[index % colors.length] + ';"><div style="width: 12px; height: 12px; background: ' + colors[index % colors.length] + '; border-radius: 50%; flex-shrink: 0;"></div><div style="flex: 1;"><div style="font-weight: 600; color: #374151; font-size: 0.875rem;">' + region + '</div><div style="font-size: 0.75rem; color: #6b7280;">' + count + ' (' + percentage + '%)</div></div></div>';
        }).join('') + '</div></div>';
    }

    function generateSourceChart(sourceCounts) {
      const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#a8edea', '#ffeaa7'];
      const total = Object.values(sourceCounts).reduce((a, b) => a + b, 0);

      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üìà Application Sources</h3><div style="display: flex; flex-direction: column; gap: 0.5rem;">' +
        Object.entries(sourceCounts).map(([source, count], index) => {
          const percentage = ((count / total) * 100).toFixed(1);
          const width = (count / Math.max(...Object.values(sourceCounts))) * 100;
          return '<div style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem;"><div style="min-width: 100px; font-size: 0.875rem; color: #374151; font-weight: 500;">' + source + '</div><div style="flex: 1; background: #f1f5f9; border-radius: 6px; overflow: hidden; height: 20px;"><div style="height: 100%; background: linear-gradient(90deg, ' + colors[index % colors.length] + ' 0%, ' + colors[index % colors.length] + '90 100%); width: ' + width + '%; border-radius: 6px; transition: all 0.3s ease;"></div></div><div style="min-width: 70px; text-align: right; font-size: 0.875rem; color: #1f2937;"><span style="font-weight: 600;">' + count + '</span> <span style="color: #6b7280;">(' + percentage + '%)</span></div></div>';
        }).join('') + '</div></div>';
    }

    function generateTimelineChart(monthlyData) {
      const months = Object.keys(monthlyData).sort();
      const maxValue = Math.max(...Object.values(monthlyData));

      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); grid-column: 1 / -1;"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üìÖ Application Timeline (Monthly)</h3><div style="display: flex; align-items: end; gap: 0.5rem; height: 120px; padding: 1rem 0;">' +
        months.map((month, index) => {
          const height = (monthlyData[month] / maxValue) * 100;
          const monthName = new Date(month + '-01').toLocaleDateString('en', { month: 'short' });
          return '<div style="display: flex; flex-direction: column; align-items: center; flex: 1;"><div style="height: ' + height + '%; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); border-radius: 4px 4px 0 0; min-height: 4px; width: 100%; margin-bottom: 0.5rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);"></div><div style="font-size: 0.7rem; color: #6b7280; font-weight: 500;">' + monthName + '</div><div style="font-size: 0.8rem; font-weight: 600; color: #1f2937;">' + monthlyData[month] + '</div></div>';
        }).join('') + '</div></div>';
    }

    function generateFunnelAnalysis(statusCounts) {
      const funnelStages = [
        { name: 'Applied', count: statusCounts['Applied'] || 0, color: '#3b82f6' },
        { name: 'Under Review', count: statusCounts['Under Review'] || 0, color: '#f59e0b' },
        { name: 'Interviewed', count: statusCounts['Interviewed'] || 0, color: '#8b5cf6' },
        { name: 'Accepted', count: statusCounts['Accepted'] || 0, color: '#10b981' },
        { name: 'Enrolled', count: statusCounts['Enrolled'] || 0, color: '#059669' }
      ];

      const maxCount = Math.max(...funnelStages.map(s => s.count));

      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); grid-column: 1 / -1;"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üîÑ Admissions Funnel Analysis</h3><div style="display: flex; align-items: center; gap: 1rem; justify-content: space-between;">' +
        funnelStages.map((stage, index) => {
          const width = Math.max(60, (stage.count / maxCount) * 200);
          const conversionRate = index > 0 ? ((stage.count / funnelStages[index - 1].count) * 100).toFixed(1) : '100.0';
          return '<div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;"><div style="width: ' + width + 'px; height: 60px; background: linear-gradient(135deg, ' + stage.color + ' 0%, ' + stage.color + '80 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: all 0.3s ease;">' + stage.count + '</div><div style="text-align: center;"><div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">' + stage.name + '</div><div style="font-size: 0.75rem; color: #6b7280;">' + conversionRate + '% conversion</div></div></div>' + (index < funnelStages.length - 1 ? '<div style="color: #9ca3af; font-size: 1.5rem;">‚Üí</div>' : '');
        }).join('') + '</div></div>';
    }

    function generateReviewerWorkload(applications) {
      const reviewerStats = {};
      applications.forEach(app => {
        if (!reviewerStats[app.reviewer]) {
          reviewerStats[app.reviewer] = { total: 0, pending: 0, completed: 0 };
        }
        reviewerStats[app.reviewer].total++;
        if (['Under Review', 'Interview Scheduled'].includes(app.status)) {
          reviewerStats[app.reviewer].pending++;
        } else {
          reviewerStats[app.reviewer].completed++;
        }
      });

      const maxWorkload = Math.max(...Object.values(reviewerStats).map(s => s.total));

      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); grid-column: 1 / -1;"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üë• Reviewer Workload Distribution</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">' +
        Object.entries(reviewerStats).map(([reviewer, stats]) => {
          const workloadPercentage = (stats.total / maxWorkload) * 100;
          const completionRate = ((stats.completed / stats.total) * 100).toFixed(1);
          return '<div style="padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;"><div style="font-weight: 600; color: #374151; font-size: 0.875rem;">' + reviewer + '</div><div style="font-weight: 700; color: #1f2937; font-size: 1.1rem;">' + stats.total + '</div></div><div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;"><div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;"><div style="height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); width: ' + ((stats.completed / stats.total) * 100) + '%; border-radius: 3px; transition: all 0.3s ease;"></div></div></div><div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280;"><span>Pending: ' + stats.pending + '</span><span>Completed: ' + completionRate + '%</span></div></div>';
        }).join('') + '</div></div>';
    }

    function generateRecentApplicationsTable(applications) {
      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); grid-column: 1 / -1;"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üìã Recent Applications</h3><div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;"><thead><tr style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;"><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">ID</th><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Applicant</th><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Program</th><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Status</th><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">GPA</th><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Test Score</th><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Region</th><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Days Since</th></tr></thead><tbody>' +
        applications.map((app, index) => {
          const statusColors = { 'Applied': '#3b82f6', 'Under Review': '#f59e0b', 'Accepted': '#10b981', 'Rejected': '#ef4444', 'Enrolled': '#059669', 'Interviewed': '#8b5cf6', 'Waitlisted': '#6b7280' };
          return '<tr style="border-bottom: 1px solid #e5e7eb; ' + (index % 2 === 0 ? 'background: #fafafa;' : '') + ' transition: all 0.2s ease;" onmouseover="this.style.background=\'#f0f9ff\'" onmouseout="this.style.background=\'' + (index % 2 === 0 ? '#fafafa' : 'white') + '\'"><td style="padding: 0.75rem; font-weight: 500; color: #667eea;">' + app.id + '</td><td style="padding: 0.75rem; font-weight: 500;">' + app.applicantName + '</td><td style="padding: 0.75rem;">' + app.program + '</td><td style="padding: 0.75rem;"><span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500; font-size: 0.75rem; color: white; background: ' + (statusColors[app.status] || '#6b7280') + ';">' + app.status + '</span></td><td style="padding: 0.75rem; font-weight: 600; color: #1f2937;">' + app.gpa + '</td><td style="padding: 0.75rem; font-weight: 600; color: #1f2937;">' + app.testScore + '</td><td style="padding: 0.75rem;">' + app.region + '</td><td style="padding: 0.75rem; color: #6b7280;">' + app.daysSinceSubmission + ' days</td></tr>';
        }).join('') + '</tbody></table></div></div>';
    }

    function generateAdvancedFilters() {
      return '<div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); grid-column: 1 / -1;"><h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">üîç Advanced Filters & Controls</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"><div style="display: flex; flex-direction: column; gap: 0.5rem;"><label style="font-weight: 600; color: #374151; font-size: 0.875rem;">Program Filter</label><select style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; background: white; transition: all 0.3s ease;" onfocus="this.style.borderColor=\'#667eea\'" onblur="this.style.borderColor=\'#e5e7eb\'"><option>All Programs</option><option>Computer Science</option><option>Business Administration</option><option>Engineering</option></select></div><div style="display: flex; flex-direction: column; gap: 0.5rem;"><label style="font-weight: 600; color: #374151; font-size: 0.875rem;">Status Filter</label><select style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; background: white; transition: all 0.3s ease;" onfocus="this.style.borderColor=\'#667eea\'" onblur="this.style.borderColor=\'#e5e7eb\'"><option>All Statuses</option><option>Applied</option><option>Under Review</option><option>Accepted</option></select></div><div style="display: flex; flex-direction: column; gap: 0.5rem;"><label style="font-weight: 600; color: #374151; font-size: 0.875rem;">Date Range</label><input type="date" style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; background: white; transition: all 0.3s ease;" onfocus="this.style.borderColor=\'#667eea\'" onblur="this.style.borderColor=\'#e5e7eb\'"></div><div style="display: flex; align-items: end;"><button onclick="refreshAdvancedData()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 16px rgba(102, 126, 234, 0.4)\'" onmouseout="this.style.transform=\'translateY(0px)\'; this.style.boxShadow=\'0 4px 12px rgba(102, 126, 234, 0.3)\'">üîÑ Apply Filters</button></div></div></div>';
    }

    function refreshAdvancedData() {
      showNotification('üîÑ Refreshing analytics data...', 'info');
      setTimeout(() => {
        loadSimpleDashboard();
        showNotification('‚úÖ Data refreshed successfully!', 'success');
      }, 1000);
    }

    function toggleDashboardFullscreen() {
      const modal = document.getElementById('reportingDashboardModal');
      const button = modal ? modal.querySelector('button[onclick="toggleDashboardFullscreen()"]') : null;
      if (!modal) return;

      if (!modal.classList.contains('fullscreen')) {
        // Enter fullscreen - use complete viewport
        modal.classList.add('fullscreen');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); display: block; margin: 0; padding: 0; z-index: 25000; overflow: hidden;';

        // Hide body scrollbars during fullscreen
        document.body.style.overflow = 'hidden';

        // Update inner content to use FULL screen with no borders/padding
        const innerDiv = modal.querySelector('div');
        if (innerDiv) {
          innerDiv.style.cssText = 'background: white; width: 100vw; height: 100vh; margin: 0; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; border-radius: 0; box-sizing: border-box;';
        }

        // Update button text
        if (button) button.innerHTML = 'üîç Exit Fullscreen';

        showNotification('üîç Fullscreen enabled - Press ESC to exit', 'info');

        // Add ESC key listener
        document.addEventListener('keydown', handleFullscreenEsc);
      } else {
        // Exit fullscreen - return to normal modal
        modal.classList.remove('fullscreen');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 25000;';

        // Restore body scrollbars
        document.body.style.overflow = '';

        // Reset inner content to normal centered modal size
        const innerDiv = modal.querySelector('div');
        if (innerDiv) {
          innerDiv.style.cssText = 'background: white; border-radius: 12px; padding: 2rem; max-width: 900px; max-height: 90vh; overflow-y: auto; width: auto; height: auto; margin: auto;';
        }

        // Update button text
        if (button) button.innerHTML = 'üîç Fullscreen';

        showNotification('üîç Fullscreen disabled', 'info');

        // Remove ESC key listener
        document.removeEventListener('keydown', handleFullscreenEsc);
      }
    }

    function handleFullscreenEsc(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('reportingDashboardModal');
        if (modal && modal.classList.contains('fullscreen')) {
          toggleDashboardFullscreen();
        }
      }
    }

    function exportBasicData() {
      const csvContent = 'Metric,Value\nTotal Applications,1247\nAccepted,284\nRejected,156\nUnder Review,807\nAcceptance Rate,22.8%';
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'dashboard-summary-' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      window.URL.revokeObjectURL(url);
      showNotification('Dashboard data exported successfully!', 'success');
    }

    function closeReportingDashboard() {
      const modal = document.getElementById('reportingDashboardModal');
      if (modal) {
        // Restore body scroll in case we're closing from fullscreen
        document.body.style.overflow = '';

        // Clean up event listeners
        document.removeEventListener('keydown', handleFullscreenEsc);
        document.removeEventListener('keydown', handleDashboardEsc);
        modal.remove();
      }
    }

    function handleDashboardEsc(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('reportingDashboardModal');
        if (modal && !modal.classList.contains('fullscreen')) {
          closeReportingDashboard();
        }
      }
    }
    console.log('Admissions page functions loaded successfully');
  </script>

  <!-- Flow Cookie Consent System -->
  <script src="/assets/js/cookie-consent.js"></script>
</body>
</html>
