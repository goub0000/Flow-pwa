<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Programs - Institution Portal | Flow</title>
  <meta name="description" content="Comprehensive academic program management and development through the institution portal.">



  <!-- Styles -->
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/institutions.css">

  <style>
    /* Header Smaller Size and Blue Buttons */
    .header {
      padding: 0.8rem 0 !important;
    }

    .header:hover {
      padding: 1rem 0 !important;
    }

    /* Header Buttons - Blue Background with White Icons */
    .header-search__trigger,
    .header-notifications__trigger,
    .header-messages__trigger {
      background: #5a5bb8 !important;
      border-radius: 50% !important;
      padding: 0.75rem !important;
      border: none !important;
      transition: all 0.3s ease !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .header-search__trigger svg,
    .header-notifications__trigger svg,
    .header-messages__trigger svg {
      fill: white !important;
      stroke: white !important;
    }

    .header-search__trigger:hover,
    .header-notifications__trigger:hover,
    .header-messages__trigger:hover {
      background: #4c4db8 !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 12px rgba(76, 77, 184, 0.3) !important;
    }

    .header-profile__trigger,
    .header-mobile-toggle {
      color: #5a5bb8 !important;
    }

    .header-profile__trigger:hover,
    .header-mobile-toggle:hover {
      color: #4c4db8 !important;
    }

    /* Enhanced Navigation Styling */
    .nav-hover-item:hover {
      background: rgba(255, 255, 255, 0.15) !important;
      color: white !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
    }

    /* Enhanced Content Padding */
    .program-feature-card {
      padding: 2rem !important;
      margin: 1rem 0 !important;
      border-radius: 16px !important;
      transition: all 0.3s ease !important;
    }

    .program-feature-card:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 24px rgba(90, 91, 184, 0.15) !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .subnav {
        padding: 1.5rem 0 !important;
      }

      .subnav__inner {
        padding: 1rem 1.5rem !important;
        flex-direction: column !important;
        gap: 1rem !important;
      }

      .subnav__link {
        text-align: center !important;
        margin: 0 !important;
        padding: 1rem 1.5rem !important;
      }

      .container {
        padding: 0 1.5rem !important;
      }

      .section__header {
        padding: 1.5rem 0 2rem 0 !important;
        margin-bottom: 2rem !important;
      }

      .coming-soon {
        padding: 2rem 1.5rem !important;
        margin: 1rem 0 !important;
      }
    }
  </style>
  
  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/img/favicon.png" type="image/png">
</head>

<body>
  <!-- Skip link for accessibility -->
  <a href="#main" class="skip-link">Skip to content</a>

  <!-- Toast notifications container -->
  <div id="toast-container" class="toast-container" aria-live="polite"></div>

  <!-- Site header -->
  <header class="header" role="banner" aria-label="Site header">
    <div class="container header__inner">
      <a class="brand" href="/" aria-label="Flow home">
        <img src="/assets/img/logo.PNG" class="brand__logo" alt="Flow logo" width="40" height="40" />
        <span class="brand__name">Flow</span>
      </a>

      <!-- Header Tools -->
      <div class="header-tools">
        <!-- Search -->
        <div class="header-search" id="headerSearch">
          <button class="header-search__trigger" id="searchTrigger" aria-label="Search">
            <svg width="20" height="20" fill="currentColor">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="header-search__dropdown" id="searchDropdown" aria-hidden="true">
            <div class="search-box">
              <input type="search" id="globalSearch" placeholder="Search programs, curricula, courses..." aria-label="Global search">
            </div>
            <div class="search-suggestions" id="searchSuggestions"></div>
          </div>
        </div>

        <!-- Notifications -->
        <div class="header-notifications" id="headerNotifications">
          <button class="header-notifications__trigger" id="notificationsTrigger" aria-label="Notifications">
            <svg width="20" height="20" fill="currentColor">
              <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <span class="header-notifications__badge" id="notificationsBadge">3</span>
          </button>
          <div class="header-notifications__dropdown" id="notificationsDropdown" aria-hidden="true">
            <div class="notifications-header">
              <h3>Notifications</h3>
              <button class="btn btn--sm btn--ghost" onclick="markAllNotificationsRead()">Mark all read</button>
            </div>
            <div class="notifications-list">
              <div class="notification-item notification-item--unread" data-id="1">
                <div class="notification-icon notification-icon--urgent">📋</div>
                <div class="notification-content">
                  <div class="notification-title">Admission Deadline Approaching</div>
                  <div class="notification-message">Fall 2025 application deadline in 5 days</div>
                  <div class="notification-time">30 minutes ago</div>
                </div>
                <button class="notification-dismiss" onclick="dismissNotification('1')" aria-label="Dismiss">×</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Messages -->
        <div class="header-messages" id="headerMessages">
          <button class="header-messages__trigger" id="messagesTrigger" aria-label="Messages">
            <svg width="20" height="20" fill="currentColor">
              <path d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            <span class="header-messages__badge" id="messagesBadge">1</span>
          </button>
          <div class="header-messages__dropdown" id="messagesDropdown" aria-hidden="true">
            <div class="messages-header">
              <h3>Recent Messages</h3>
              <button class="btn btn--sm btn--primary" onclick="composeMessage()">Compose</button>
            </div>
            <div class="messages-list" id="messagesList">
              <div class="message-item" data-id="1" onclick="markMessageRead('1')">
                <div class="message-avatar">
                  <div class="conversation-avatar-placeholder">RC</div>
                </div>
                <div class="message-content">
                  <div class="message-sender">Registrar's Office</div>
                  <div class="message-preview">Updated enrollment projections for next semester...</div>
                  <div class="message-time">45 minutes ago</div>
                </div>
                <div class="message-status"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Profile -->
        <div class="header-profile" id="headerProfile">
          <button class="header-profile__trigger" id="profileTrigger" aria-label="User menu" aria-expanded="false">
            <div class="profile-avatar">
              <img src="/assets/img/avatars/institution.jpg" alt="University of Excellence" width="32" height="32">
            </div>
            <div class="profile-info">
              <span class="profile-name">University of Excellence</span>
              <span class="profile-role">Institution Admin</span>
            </div>
            <svg width="16" height="16" fill="currentColor" class="profile-chevron">
              <path d="M4.646 4.646a.5.5 0 01.708 0L8 7.293l2.646-2.647a.5.5 0 01.708.708L8.707 8l2.647 2.646a.5.5 0 01-.708.708L8 8.707l-2.646 2.647a.5.5 0 01-.708-.708L7.293 8 4.646 5.354a.5.5 0 010-.708z"/>
            </svg>
          </button>
          <div class="header-profile__dropdown" id="profileDropdown" aria-hidden="true">
            <div class="profile-menu">
              <a href="/institutions/profile.html" class="profile-menu__item">
                <svg width="16" height="16" fill="currentColor">
                  <path d="M8 8a3 3 0 100-6 3 3 0 000 6zM12.735 14c.618 0 1.093-.561.872-1.139a6.002 6.002 0 00-11.215 0c-.22.578.254 1.139.872 1.139h9.47z"/>
                </svg>
                Institution Profile
              </a>
              <a href="/institutions/settings.html" class="profile-menu__item">
                <svg width="16" height="16" fill="currentColor">
                  <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 01-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 01.872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 012.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 012.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 01.872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 01-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 01-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 100-5.86 2.929 2.929 0 000 5.858z"/>
                </svg>
                Settings
              </a>
              <div class="profile-menu__divider"></div>
              <button class="profile-menu__item profile-menu__item--danger" onclick="signOut()">
                <svg width="16" height="16" fill="currentColor">
                  <path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 11-2 0V4H5v8h10V9a1 1 0 112 0v3a1 1 0 01-1 1H4a1 1 0 01-1-1V3z"/>
                  <path d="M6 10a1 1 0 011-1h4a1 1 0 110 2H7a1 1 0 01-1-1z"/>
                </svg>
                Sign Out
              </button>
            </div>
          </div>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="header-mobile-toggle" id="mobileMenuToggle" aria-label="Toggle menu" aria-expanded="false">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay" aria-hidden="true">
      <div class="nav-overlay__content">
        <nav class="nav-overlay__menu">
          <a href="/institutions/" class="nav-overlay__link">Dashboard</a>
          <a href="/institutions/messages.html" class="nav-overlay__link">Messages</a>
          <a href="/institutions/programs.html" class="nav-overlay__link nav-overlay__link--active">Programs</a>
          <a href="/institutions/admissions.html" class="nav-overlay__link">Admissions</a>
          <a href="/institutions/reports.html" class="nav-overlay__link">Reports</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Sub-navigation -->
  <nav class="subnav" role="navigation" aria-label="Institution sections" style="background: #5a5bb8; padding: 2rem 0;">
    <div class="container">
      <div class="subnav__inner" style="padding: 1.5rem 3rem; border-radius: 16px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);">
        <a href="/institutions/" class="subnav__link nav-hover-item" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; color: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">Dashboard</a>
        <a href="/institutions/messages.html" class="subnav__link nav-hover-item" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; color: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">Messages</a>
        <a href="/institutions/programs.html" class="subnav__link subnav__link--active" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; background: rgba(255, 255, 255, 0.2); color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); font-weight: 600;">Programs</a>
        <a href="/institutions/admissions.html" class="subnav__link nav-hover-item" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; color: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">Admissions</a>
        <a href="/institutions/reports.html" class="subnav__link nav-hover-item" style="padding: 1.25rem 2rem; margin: 0 0.5rem; border-radius: 12px; color: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">Reports</a>
      </div>
    </div>
  </nav>

  <!-- Main content -->
  <main id="main" role="main" style="padding: 4rem 0;">
    <section class="section" aria-labelledby="programsTitle" style="padding: 3rem 0;">
      <div class="container" style="padding: 0 3rem;">
        <header class="section__header" style="padding: 2rem 0 3rem 0; margin-bottom: 4rem;">
          <h1 id="programsTitle" style="padding: 1rem 2rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, rgba(90, 91, 184, 0.05), rgba(90, 91, 184, 0.1)); border-radius: 16px; border-left: 6px solid #5a5bb8;">Programs Management</h1>
          <p class="section__description" style="padding: 1.5rem 2rem; background: rgba(90, 91, 184, 0.03); border-radius: 12px; font-size: 1.2rem; line-height: 1.7;">Create, manage, and optimize your academic programs</p>
        </header>
        
        <div class="coming-soon" style="padding: 4rem 3rem; margin: 2rem 0; background: linear-gradient(135deg, rgba(90, 91, 184, 0.02), rgba(90, 91, 184, 0.05)); border: 2px solid rgba(90, 91, 184, 0.1); border-radius: 24px;">
          <div class="coming-soon__icon" style="padding: 1rem; margin-bottom: 2rem;">🎓</div>
          <h2 style="padding: 1.5rem 2rem; margin-bottom: 2rem; background: rgba(255, 255, 255, 0.8); border-radius: 16px; box-shadow: 0 4px 12px rgba(90, 91, 184, 0.1);">Program Management Tools</h2>
          <p style="padding: 2rem 2.5rem; margin-bottom: 3rem; background: rgba(255, 255, 255, 0.6); border-radius: 16px; font-size: 1.1rem; line-height: 1.8; border: 1px solid rgba(90, 91, 184, 0.1);">Your comprehensive academic program development and management platform provides complete control over your program lifecycle. This powerful suite includes:</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin: 2rem 0;">
            <!-- Left Column -->
            <div>
              <a href="/institutions/programs-editor.html" style="text-decoration: none; color: inherit;">
                <div style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onmouseover="this.style.background='rgba(90, 91, 184, 0.1)'; this.style.borderColor='#5a5bb8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                  <svg width="48" height="48" fill="currentColor" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                    <rect x="2" y="4" width="44" height="32" rx="4" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M8 12h32M8 18h24M8 24h28M8 30h20"/>
                    <circle cx="38" cy="12" r="4" fill="#22c55e" opacity="0.8"/>
                    <path d="M36 12l2 2 4-4" stroke="white" stroke-width="1.5" fill="none"/>
                    <rect x="6" y="8" width="6" height="28" fill="#3b82f6" opacity="0.2" rx="1"/>
                    <path d="M4 40l8-4 8 4 8-4 8 4 8-4 4 2v2l-4-2-8 4-8-4-8 4-8-4-8 4z" fill="#f59e0b" opacity="0.6"/>
                    <circle cx="42" cy="8" r="2" fill="#ef4444"/>
                  </svg>
                  <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a;">Create and edit academic programs</span>
                    <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">🚀 Launch Program Editor</span>
                  </div>
                </div>
              </a>

              <a href="/institutions/admission-manager.html" style="text-decoration: none; color: inherit;">
                <div style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onmouseover="this.style.background='rgba(90, 91, 184, 0.1)'; this.style.borderColor='#5a5bb8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                  <svg width="48" height="48" fill="currentColor" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                    <rect x="4" y="6" width="40" height="28" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M4 14h40M12 6v8M20 6v8M28 6v8M36 6v8"/>
                    <circle cx="14" cy="20" r="2" fill="#22c55e"/>
                    <circle cx="22" cy="20" r="2" fill="#f59e0b"/>
                    <circle cx="30" cy="20" r="2" fill="#3b82f6"/>
                    <circle cx="14" cy="26" r="2" fill="#ef4444"/>
                    <circle cx="22" cy="26" r="2" fill="#8b5cf6"/>
                    <path d="M38 18h4v4h-4z" fill="#22c55e" opacity="0.7"/>
                    <path d="M38 24h4v4h-4z" fill="#f59e0b" opacity="0.7"/>
                    <rect x="6" y="36" width="36" height="6" fill="#e5e7eb" rx="2"/>
                    <rect x="8" y="38" width="16" height="2" fill="#5a5bb8"/>
                    <path d="M2 42l4-2 4 2 4-2 4 2 4-2 4 2 4-2 4 2 4-2 4 2 4-2 4 2" stroke="#3b82f6" stroke-width="2" fill="none"/>
                  </svg>
                  <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a;">Set admission requirements and prerequisites</span>
                    <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">🎯 Manage Admissions</span>
                  </div>
                </div>
              </a>
              
              <div onclick="openCurriculumManager()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onmouseover="this.style.background='rgba(90, 91, 184, 0.1)'; this.style.borderColor='#5a5bb8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                <svg width="48" height="48" fill="currentColor" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="4" y="8" width="40" height="24" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="M8 16h32M8 20h24M8 24h28"/>
                  <circle cx="38" cy="16" r="6" fill="none" stroke="#22c55e" stroke-width="2"/>
                  <path d="M35 16l2 2 4-4" stroke="#22c55e" stroke-width="2" fill="none"/>
                  <circle cx="38" cy="24" r="6" fill="none" stroke="#f59e0b" stroke-width="2"/>
                  <path d="M35 24l3 0M38 21l0 6" stroke="#f59e0b" stroke-width="2"/>
                  <rect x="6" y="34" width="36" height="8" fill="#3b82f6" opacity="0.1" rx="2"/>
                  <path d="M10 36h4v4h-4zM16 36h4v4h-4zM22 36h4v4h-4z" fill="#3b82f6" opacity="0.6"/>
                  <circle cx="2" cy="12" r="2" fill="#ef4444"/>
                  <path d="M2 12l16 8-16 8z" fill="#ef4444" opacity="0.3"/>
                </svg>
                <div style="display: flex; flex-direction: column;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a;">Manage course catalogs and curricula</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">📚 Launch Curriculum Manager</span>
                </div>
              </div>
              
              <div onclick="openProgramStats()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onmouseover="this.style.background='rgba(90, 91, 184, 0.1)'; this.style.borderColor='#5a5bb8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                <svg width="48" height="48" fill="currentColor" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="6" y="8" width="36" height="28" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 14h24M12 18h20M12 22h16"/>
                  <circle cx="32" cy="14" r="8" fill="none" stroke="#22c55e" stroke-width="2" stroke-dasharray="3,2"/>
                  <text x="32" y="18" text-anchor="middle" font-size="8" fill="#22c55e" font-weight="bold">1</text>
                  <circle cx="32" cy="22" r="8" fill="none" stroke="#f59e0b" stroke-width="2" stroke-dasharray="3,2"/>
                  <text x="32" y="26" text-anchor="middle" font-size="8" fill="#f59e0b" font-weight="bold">W</text>
                  <rect x="8" y="26" width="12" height="8" fill="#3b82f6" opacity="0.2" rx="2"/>
                  <path d="M10 28h8M10 30h6M10 32h8"/>
                  <circle cx="38" cy="30" r="3" fill="#8b5cf6"/>
                  <path d="M36 30l2 1 2-3" stroke="white" stroke-width="1" fill="none"/>
                  <rect x="2" y="38" width="44" height="4" fill="#e5e7eb" rx="2"/>
                  <rect x="4" y="40" width="8" height="2" fill="#22c55e" rx="1"/>
                  <rect x="14" y="40" width="12" height="2" fill="#f59e0b" rx="1"/>
                  <rect x="28" y="40" width="6" height="2" fill="#ef4444" rx="1"/>
                </svg>
                <div>
                  <div style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a; margin-bottom: 0.25rem;">Stats — Track program statistics and performance</div>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">📊 Launch Analytics Dashboard</span>
                </div>
              </div>
            </div>
            
            <!-- Right Column -->
            <div>
              <div onclick="openDegreeRequirements()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onmouseover="this.style.background='rgba(90, 91, 184, 0.1)'; this.style.borderColor='#5a5bb8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                <svg width="48" height="48" fill="currentColor" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="4" y="6" width="40" height="32" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                  <circle cx="12" cy="16" r="3" fill="#22c55e"/>
                  <circle cx="24" cy="16" r="3" fill="#f59e0b"/>
                  <circle cx="36" cy="16" r="3" fill="#3b82f6"/>
                  <rect x="8" y="22" width="8" height="2" fill="#22c55e" opacity="0.7"/>
                  <rect x="20" y="22" width="8" height="2" fill="#f59e0b" opacity="0.7"/>
                  <rect x="32" y="22" width="8" height="2" fill="#3b82f6" opacity="0.7"/>
                  <path d="M8 26l4-2 4 3 4-1 4 2 4-3 4 1 4 2 4-1" stroke="#8b5cf6" stroke-width="2" fill="none"/>
                  <rect x="6" y="30" width="36" height="6" fill="none" stroke="#5a5bb8" stroke-width="1" rx="2"/>
                  <path d="M10 32h4M16 32h4M22 32h4M28 32h4M34 32h4"/>
                  <circle cx="42" cy="12" r="4" fill="#ef4444" opacity="0.8"/>
                  <text x="42" y="15" text-anchor="middle" font-size="6" fill="white" font-weight="bold">5</text>
                  <path d="M2 40l4 2 4-2 4 2 4-2 4 2 4-2 4 2 4-2 4 2 4-2 4 2" stroke="#22c55e" stroke-width="1.5" fill="none"/>
                </svg>
                <div style="display: flex; flex-direction: column;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a;">Configure degree requirements</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">🎓 Launch Degree Audit Editor</span>
                </div>
              </div>
              
              <div onclick="openApplicationProcessBuilder()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onmouseover="this.style.background='rgba(90, 91, 184, 0.1)'; this.style.borderColor='#5a5bb8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                <svg width="48" height="48" fill="currentColor" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="6" y="4" width="36" height="28" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 10h24M12 14h20M12 18h16M12 22h24M12 26h18"/>
                  <circle cx="36" cy="10" r="6" fill="none" stroke="#22c55e" stroke-width="2"/>
                  <path d="M33 10l2 2 4-4" stroke="#22c55e" stroke-width="2" fill="none"/>
                  <rect x="30" y="16" width="12" height="8" fill="#3b82f6" opacity="0.1" rx="2"/>
                  <path d="M32 18h8M32 20h6M32 22h8"/>
                  <circle cx="38" cy="20" r="2" fill="#f59e0b"/>
                  <path d="M2 34l4 2 4-1 4 2 4-1 4 2 4-1 4 2 4-1 4 2 4-1 4 2" stroke="#8b5cf6" stroke-width="2" fill="none"/>
                  <rect x="4" y="36" width="40" height="6" fill="none" stroke="#ef4444" stroke-width="2" rx="2"/>
                  <circle cx="10" cy="39" r="1.5" fill="#ef4444"/>
                  <circle cx="16" cy="39" r="1.5" fill="#22c55e"/>
                  <circle cx="22" cy="39" r="1.5" fill="#f59e0b"/>
                  <circle cx="28" cy="39" r="1.5" fill="#3b82f6"/>
                  <rect x="32" y="37" width="8" height="4" fill="#8b5cf6" opacity="0.3" rx="1"/>
                  <text x="36" y="40" text-anchor="middle" font-size="6" fill="#8b5cf6" font-weight="bold">✓</text>
                </svg>
                <div style="display: flex; flex-direction: column;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a;">Set up program-specific application processes</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">🔧 Launch Application Builder</span>
                </div>
              </div>
              
              <div onclick="openFacultyManager()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onmouseover="this.style.background='rgba(90, 91, 184, 0.1)'; this.style.borderColor='#5a5bb8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                <svg width="48" height="48" fill="currentColor" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="4" y="8" width="16" height="24" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                  <rect x="28" y="8" width="16" height="24" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="M8 14h8M8 18h6M8 22h8M8 26h4"/>
                  <path d="M32 14h8M32 18h6M32 22h8M32 26h4"/>
                  <circle cx="22" cy="20" r="8" fill="none" stroke="#3b82f6" stroke-width="2"/>
                  <path d="M18 16l4 4 8-8" stroke="#3b82f6" stroke-width="2" fill="none"/>
                  <rect x="6" y="34" width="12" height="8" fill="#22c55e" opacity="0.2" rx="2"/>
                  <rect x="30" y="34" width="12" height="8" fill="#f59e0b" opacity="0.2" rx="2"/>
                  <path d="M2 44l8-2 8 2 8-2 8 2 8-2 4 1" stroke="#8b5cf6" stroke-width="2" fill="none"/>
                  <circle cx="12" cy="36" r="2" fill="#22c55e"/>
                  <circle cx="36" cy="36" r="2" fill="#f59e0b"/>
                  <path d="M20 6l4-4 4 4-4 2z" fill="#ef4444" opacity="0.8"/>
                  <circle cx="24" cy="2" r="1" fill="#ef4444"/>
                </svg>
                <div style="display: flex; flex-direction: column;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a;">Manage faculty assignments</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">👨‍🏫 Launch Faculty Manager</span>
                </div>
              </div>
              
              <div onclick="openAnalyticsDashboard()" style="display: flex; align-items: flex-start; margin-bottom: 1.5rem; padding: 1rem; background: rgba(90, 91, 184, 0.05); border-radius: 12px; border-left: 4px solid #5a5bb8; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onmouseover="this.style.background='rgba(90, 91, 184, 0.1)'; this.style.borderColor='#5a5bb8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(90, 91, 184, 0.05)'; this.style.borderColor='transparent'; this.style.transform='translateY(0)'"">
                <svg width="48" height="48" fill="currentColor" style="margin-right: 16px; color: #5a5bb8; flex-shrink: 0; margin-top: 2px;">
                  <rect x="4" y="6" width="40" height="28" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="M4 14h40"/>
                  <circle cx="8" cy="10" r="1.5"/>
                  <circle cx="12" cy="10" r="1.5"/>
                  <circle cx="16" cy="10" r="1.5"/>
                  <rect x="8" y="18" width="6" height="12" fill="#3b82f6" opacity="0.7" rx="1"/>
                  <rect x="16" y="20" width="6" height="10" fill="#22c55e" opacity="0.7" rx="1"/>
                  <rect x="24" y="22" width="6" height="8" fill="#f59e0b" opacity="0.7" rx="1"/>
                  <rect x="32" y="16" width="6" height="14" fill="#8b5cf6" opacity="0.7" rx="1"/>
                  <path d="M6 36l4-2 4 1 4-1 4 2 4-3 4 1 4 2 4-1" stroke="#ef4444" stroke-width="2" fill="none"/>
                  <circle cx="40" cy="18" r="3" fill="#22c55e"/>
                  <path d="M38 18l2 1 2-2" stroke="white" stroke-width="1" fill="none"/>
                  <rect x="20" y="8" width="20" height="4" fill="#e5e7eb" rx="1"/>
                  <rect x="22" y="9" width="8" height="2" fill="#5a5bb8" rx="0.5"/>
                  <text x="32" y="11" font-size="6" fill="#374151">Analytics</text>
                </svg>
                <div style="display: flex; flex-direction: column;">
                  <span style="font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #1a1a1a;">Reports — Generate program reports and analytics</span>
                  <span style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">📊 Launch Analytics Dashboard</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="coming-soon__preview">
            <h3>Feature Preview</h3>
            <div class="preview-cards">
              <div class="preview-card">
                <div class="preview-card__icon">
                  <svg width="60" height="60" fill="currentColor" style="color: #5a5bb8;">
                    <rect x="6" y="8" width="48" height="32" rx="4" fill="none" stroke="currentColor" stroke-width="2"/>
                    <circle cx="16" cy="18" r="4" fill="#22c55e"/>
                    <circle cx="30" cy="18" r="4" fill="#f59e0b"/>
                    <circle cx="44" cy="18" r="4" fill="#3b82f6"/>
                    <path d="M16 22v8M30 22v8M44 22v8" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 30h8M26 30h8M40 30h8" stroke="currentColor" stroke-width="2"/>
                    <circle cx="30" cy="30" r="12" fill="none" stroke="#8b5cf6" stroke-width="3" stroke-dasharray="8,4"/>
                    <path d="M26 26l4 4 8-8" stroke="#8b5cf6" stroke-width="2" fill="none"/>
                    <rect x="2" y="44" width="56" height="4" fill="#e5e7eb" rx="2"/>
                    <rect x="4" y="46" width="12" height="2" fill="#22c55e" rx="1"/>
                    <rect x="18" y="46" width="16" height="2" fill="#f59e0b" rx="1"/>
                    <rect x="36" y="46" width="8" height="2" fill="#3b82f6" rx="1"/>
                    <circle cx="50" cy="14" r="3" fill="#ef4444" opacity="0.8"/>
                    <path d="M48 14l2 1 2-2" stroke="white" stroke-width="1" fill="none"/>
                  </svg>
                </div>
                <div class="preview-card__content">
                  <h4>Workflow Automation</h4>
                  <p>Set up automated workflows that move applications through your review process</p>
                </div>
              </div>
              <div class="preview-card">
                <div class="preview-card__icon">
                  <svg width="60" height="60" fill="currentColor" style="color: #5a5bb8;">
                    <rect x="8" y="12" width="44" height="32" rx="4" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M8 22h44M16 12v10M24 12v10M32 12v10M40 12v10M48 12v10"/>
                    <circle cx="18" cy="28" r="3" fill="#22c55e"/>
                    <circle cx="26" cy="34" r="3" fill="#f59e0b"/>
                    <circle cx="34" cy="28" r="3" fill="#3b82f6"/>
                    <circle cx="42" cy="34" r="3" fill="#8b5cf6"/>
                    <rect x="14" y="40" width="8" height="2" fill="#22c55e" opacity="0.7"/>
                    <rect x="22" y="40" width="8" height="2" fill="#f59e0b" opacity="0.7"/>
                    <rect x="30" y="40" width="8" height="2" fill="#3b82f6" opacity="0.7"/>
                    <rect x="38" y="40" width="8" height="2" fill="#8b5cf6" opacity="0.7"/>
                    <circle cx="50" cy="18" r="6" fill="none" stroke="#ef4444" stroke-width="2"/>
                    <path d="M47 18l3 0M50 15l0 6" stroke="#ef4444" stroke-width="2"/>
                    <path d="M4 48l8-2 8 2 8-2 8 2 8-2 8 2 8-2" stroke="#22c55e" stroke-width="2" fill="none"/>
                    <rect x="10" y="8" width="40" height="2" fill="#5a5bb8" opacity="0.3"/>
                    <circle cx="12" cy="9" r="1" fill="#5a5bb8"/>
                    <circle cx="16" cy="9" r="1" fill="#5a5bb8"/>
                    <circle cx="20" cy="9" r="1" fill="#5a5bb8"/>
                  </svg>
                </div>
                <div class="preview-card__content">
                  <h4>Interview Management</h4>
                  <p>Schedule interviews, send automated reminders, and track outcomes</p>
                </div>
              </div>
              <div class="preview-card">
                <div class="preview-card__icon">
                  <svg width="60" height="60" fill="currentColor" style="color: #5a5bb8;">
                    <circle cx="30" cy="30" r="24" fill="none" stroke="currentColor" stroke-width="2"/>
                    <circle cx="30" cy="30" r="16" fill="none" stroke="#3b82f6" stroke-width="2"/>
                    <circle cx="30" cy="30" r="8" fill="#22c55e" opacity="0.8"/>
                    <path d="M22 22l8 8 16-16" stroke="#f59e0b" stroke-width="3" fill="none"/>
                    <rect x="18" y="6" width="24" height="8" fill="#8b5cf6" opacity="0.2" rx="2"/>
                    <circle cx="20" cy="10" r="1.5" fill="#8b5cf6"/>
                    <circle cx="24" cy="10" r="1.5" fill="#8b5cf6"/>
                    <circle cx="28" cy="10" r="1.5" fill="#8b5cf6"/>
                    <circle cx="32" cy="10" r="1.5" fill="#8b5cf6"/>
                    <circle cx="36" cy="10" r="1.5" fill="#8b5cf6"/>
                    <circle cx="40" cy="10" r="1.5" fill="#8b5cf6"/>
                    <rect x="46" y="46" width="12" height="8" fill="#ef4444" opacity="0.2" rx="2"/>
                    <path d="M48 48h8M48 50h6M48 52h8"/>
                    <circle cx="52" cy="50" r="2" fill="#ef4444"/>
                    <path d="M6 46l6-3 6 3 6-3 6 3 6-3 6 3 6-3 6 3" stroke="#22c55e" stroke-width="2" fill="none"/>
                    <rect x="2" y="18" width="12" height="24" fill="#f59e0b" opacity="0.1" rx="2"/>
                    <path d="M4 20h8M4 24h6M4 28h8M4 32h4M4 36h8M4 40h6"/>
                  </svg>
                </div>
                <div class="preview-card__content">
                  <h4>Smart Decisions</h4>
                  <p>Use AI-powered insights to make informed admission decisions</p>
                </div>
              </div>
              <div class="preview-card">
                <div class="preview-card__icon">
                  <svg width="60" height="60" fill="currentColor" style="color: #5a5bb8;">
                    <rect x="6" y="10" width="48" height="32" rx="4" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M6 20h48"/>
                    <circle cx="12" cy="15" r="2"/>
                    <circle cx="18" cy="15" r="2"/>
                    <circle cx="24" cy="15" r="2"/>
                    <rect x="12" y="24" width="6" height="14" fill="#3b82f6" opacity="0.8" rx="1"/>
                    <rect x="20" y="26" width="6" height="12" fill="#22c55e" opacity="0.8" rx="1"/>
                    <rect x="28" y="28" width="6" height="10" fill="#f59e0b" opacity="0.8" rx="1"/>
                    <rect x="36" y="22" width="6" height="16" fill="#8b5cf6" opacity="0.8" rx="1"/>
                    <rect x="44" y="30" width="6" height="8" fill="#ef4444" opacity="0.8" rx="1"/>
                    <path d="M10 44l6-2 6 1 6-1 6 2 6-3 6 1 6 2" stroke="#22c55e" stroke-width="2" fill="none"/>
                    <circle cx="46" cy="26" r="4" fill="#22c55e" opacity="0.3"/>
                    <path d="M44 26l2 1 2-2" stroke="#22c55e" stroke-width="1" fill="none"/>
                    <rect x="30" y="6" width="24" height="6" fill="#e5e7eb" rx="2"/>
                    <rect x="32" y="8" width="8" height="2" fill="#5a5bb8"/>
                    <text x="42" y="10" font-size="4" fill="#374151">Real-time</text>
                    <circle cx="2" cy="30" r="2" fill="#ef4444"/>
                    <circle cx="2" cy="24" r="1.5" fill="#f59e0b"/>
                    <circle cx="2" cy="36" r="1.5" fill="#22c55e"/>
                    <path d="M2 48l8 2 8-2 8 2 8-2 8 2 8-2 8 2 4-1" stroke="#3b82f6" stroke-width="2" fill="none"/>
                  </svg>
                </div>
                <div class="preview-card__content">
                  <h4>Real-time Analytics</h4>
                  <p>Track applications, conversion rates, and enrollment metrics</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="coming-soon__cta">
            <button class="btn btn--primary" onclick="joinBeta()">
              <svg width="16" height="16" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Join Beta Program
            </button>
            <button class="btn btn--ghost" onclick="scheduleDemo()">
              <svg width="16" height="16" fill="currentColor">
                <path d="M15 3a2 2 0 012 2v1.5a8 8 0 11-16 0V5a2 2 0 012-2h12z"/>
                <path d="M7 8.5a2 2 0 114 0"/>
              </svg>
              Schedule Demo
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer" role="contentinfo" aria-label="Site footer" style="background: linear-gradient(135deg, #5a5bb8, #6b6ce8); position: relative; overflow: hidden; color: white;">
    <div class="container footer__inner" style="position: relative; z-index: 2; color: white;">
      <div class="footer__grid">
        <!-- Brand section -->
        <div class="footer__brand">
          <div class="footer__logo" onclick="scrollToTop()" style="cursor: pointer;" title="Back to top">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <defs>
                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#373896"/>
                  <stop offset="100%" style="stop-color:#6b6ce8"/>
                </linearGradient>
              </defs>
              <circle cx="20" cy="20" r="18" fill="url(#logoGradient)" stroke="currentColor" stroke-width="2"/>
              <path d="M15 18l5-5 5 5M20 13v14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="footer__brand-text">
            <div class="footer__brand-name" style="color: white;">Flow</div>
            <div class="footer__tagline" style="color: white;">Streamlining Education Access</div>
          </div>
        </div>
        <!-- Links -->
        <div class="footer__section">
          <h3 class="footer__title" style="color: black;">For Institutions</h3>
          <ul class="footer__links">
            <li><a href="/institutions/">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="3" width="12" height="10" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M4 6h8M4 8h6M4 10h4" stroke="white" stroke-width="0.8"/>
                <circle cx="11" cy="5" r="2" fill="#22c55e" opacity="0.9"/>
                <path d="M10 5l0.7 0.7 1.3-1.4" stroke="white" stroke-width="0.8" fill="none"/>
              </svg>
              <span style="color: white;">Dashboard</span></a></li>
            <li><a href="/institutions/programs.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="2" width="12" height="12" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M5 5h6M5 7h4M5 9h5" stroke="white" stroke-width="0.8"/>
                <circle cx="11" cy="6" r="1.5" fill="#22c55e" opacity="0.9"/>
                <path d="M10.3 6l0.4 0.4 0.6-0.8" stroke="white" stroke-width="0.8" fill="none"/>
              </svg>
              <span style="color: white;">Manage Programs</span></a></li>
            <li><a href="/institutions/admissions.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="3" width="8" height="10" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <rect x="12" y="3" width="2" height="10" rx="0.5" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M4 6h4M4 8h3M4 10h4" stroke="white" stroke-width="0.8"/>
                <circle cx="8" cy="6" r="1" fill="#22c55e"/>
                <path d="M7.5 6l0.3 0.3 0.5-0.6" stroke="white" stroke-width="0.6" fill="none"/>
              </svg>
              <span style="color: white;">Admissions</span></a></li>
            <li><a href="/institutions/reports.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="3" width="12" height="10" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M2 7h12" stroke="white" stroke-width="0.8"/>
                <rect x="4" y="9" width="1.5" height="2" fill="#3b82f6" opacity="0.9" rx="0.3"/>
                <rect x="6" y="10" width="1.5" height="1" fill="#22c55e" opacity="0.9" rx="0.3"/>
                <rect x="8" y="8" width="1.5" height="3" fill="#f59e0b" opacity="0.9" rx="0.3"/>
                <rect x="10" y="11" width="1.5" height="0.5" fill="#ef4444" opacity="0.9" rx="0.3"/>
              </svg>
              <span style="color: white;">Reports</span></a></li>
          </ul>
        </div>
        <div class="footer__section">
          <h3 class="footer__title" style="color: black;">Support</h3>
          <ul class="footer__links">
            <li><a href="/institutions/help.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <circle cx="8" cy="8" r="6" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M8 6v2M8 10h.01" stroke="white" stroke-width="0.8"/>
                <circle cx="8" cy="4" r="1" fill="#3b82f6"/>
                <path d="M4 12l8-8M12 12l-8-8" stroke="#22c55e" stroke-width="0.8" opacity="0.7"/>
              </svg>
              <span style="color: white;">Help Center</span></a></li>
            <li><a href="/contact/">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <path d="M2 3h12l-6 5-6-5zM2 3v10h12V3" fill="none" stroke="white" stroke-width="1.2"/>
                <circle cx="12" cy="4" r="1.5" fill="#22c55e"/>
                <path d="M11.3 4l0.4 0.4 0.6-0.8" stroke="white" stroke-width="0.6" fill="none"/>
              </svg>
              <span style="color: white;">Contact</span></a></li>
            <li><a href="/legal/privacy.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="3" y="2" width="10" height="12" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M8 6v4M6 8h4" stroke="white" stroke-width="0.8"/>
                <circle cx="8" cy="5" r="1" fill="#f59e0b"/>
                <rect x="5" y="9" width="6" height="1" fill="#ef4444" opacity="0.8"/>
              </svg>
              <span style="color: white;">Privacy</span></a></li>
            <li><a href="/legal/terms.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="2" width="12" height="12" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M5 5h6M5 7h5M5 9h4M5 11h6" stroke="white" stroke-width="0.8"/>
                <circle cx="12" cy="4" r="1" fill="#8b5cf6"/>
                <rect x="4" y="6" width="1" height="6" fill="#3b82f6" opacity="0.6"/>
              </svg>
              <span style="color: white;">Terms</span></a></li>
          </ul>
        </div>
        <div class="footer__section">
          <h3 class="footer__title" style="color: black;">Connect</h3>
          <ul class="footer__links">
            <li><a href="/institutions/messages.html">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="4" width="12" height="8" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M2 6l5 3 2-1 5-2" stroke="white" stroke-width="0.8"/>
                <circle cx="12" cy="5" r="1.5" fill="#ef4444"/>
                <text x="12" y="6" text-anchor="middle" font-size="2.5" fill="white" font-weight="bold">2</text>
              </svg>
              <span style="color: white;">Messages</span></a></li>
            <li><a href="/community/">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <circle cx="5" cy="6" r="2" fill="none" stroke="white" stroke-width="1.2"/>
                <circle cx="11" cy="6" r="2" fill="none" stroke="white" stroke-width="1.2"/>
                <circle cx="8" cy="11" r="2" fill="none" stroke="white" stroke-width="1.2"/>
                <circle cx="5" cy="6" r="1" fill="#22c55e"/>
                <circle cx="11" cy="6" r="1" fill="#3b82f6"/>
                <circle cx="8" cy="11" r="1" fill="#f59e0b"/>
                <path d="M7 8l2 1M9 8l-2 1" stroke="white" stroke-width="0.8"/>
              </svg>
              <span style="color: white;">Community</span></a></li>
            <li><a href="/blog/">
              <svg width="16" height="16" fill="white" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                <rect x="2" y="2" width="12" height="12" rx="1" fill="none" stroke="white" stroke-width="1.2"/>
                <path d="M5 5h6M5 7h4M5 9h5" stroke="white" stroke-width="0.8"/>
                <circle cx="12" cy="4" r="1.5" fill="#22c55e"/>
                <path d="M11.3 4l0.4 0.4 0.6-0.8" stroke="white" stroke-width="0.6" fill="none"/>
                <rect x="4" y="11" width="8" height="1" fill="#8b5cf6" opacity="0.8"/>
              </svg>
              <span style="color: white;">Updates</span></a></li>
          </ul>
        </div>
      </div>

      <div class="footer__bottom">
        <div class="footer__copyright" style="color: white;">
          © 2024 Flow Education Platform. All rights reserved.
        </div>
        <div class="footer__status">
          <span class="footer__status-dot"></span>
          <span style="color: white;">All systems operational</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="/assets/js/firebase-config.js"></script>
  <script src="/assets/js/firebase-auth.js"></script>
  <script src="/assets/js/auth-guards.js"></script>
  <script src="/assets/js/institutions.js"></script>
  
  <script>
    // Header Button JavaScript Functionality

    // Toggle Dropdown Function
    function toggleDropdown(dropdownId, triggerId) {
      const dropdown = document.getElementById(dropdownId);
      const trigger = document.getElementById(triggerId);
      const isOpen = dropdown.getAttribute('aria-hidden') === 'false';

      // Close all dropdowns first
      closeAllDropdowns();

      if (!isOpen) {
        dropdown.setAttribute('aria-hidden', 'false');
        dropdown.style.display = 'block';
        trigger.setAttribute('aria-expanded', 'true');
      }
    }

    // Close all dropdowns
    function closeAllDropdowns() {
      const dropdowns = ['searchDropdown', 'notificationsDropdown', 'messagesDropdown', 'profileDropdown'];
      const triggers = ['searchTrigger', 'notificationsTrigger', 'messagesTrigger', 'profileTrigger'];

      dropdowns.forEach((id, index) => {
        const dropdown = document.getElementById(id);
        const trigger = document.getElementById(triggers[index]);
        if (dropdown && trigger) {
          dropdown.setAttribute('aria-hidden', 'true');
          dropdown.style.display = 'none';
          trigger.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Search functionality
    function handleSearch(query) {
      console.log('Searching for:', query);
      const suggestions = document.getElementById('searchSuggestions');

      if (query.length > 0) {
        const mockResults = [
          'Computer Science Program',
          'Business Administration',
          'Engineering Curriculum',
          'Pre-Med Requirements',
          'Graduate Programs'
        ].filter(item => item.toLowerCase().includes(query.toLowerCase()));

        suggestions.innerHTML = mockResults.map(result =>
          `<div class="suggestion-item" onclick="selectSuggestion('${result}')">${result}</div>`
        ).join('');
      } else {
        suggestions.innerHTML = '';
      }
    }

    function selectSuggestion(suggestion) {
      document.getElementById('globalSearch').value = suggestion;
      closeAllDropdowns();
      showToast(`Searching for: ${suggestion}`, 'info', 3000);
    }

    // Notification functions
    function markAllNotificationsRead() {
      const notifications = document.querySelectorAll('.notification-item--unread');
      notifications.forEach(notification => {
        notification.classList.remove('notification-item--unread');
      });
      document.getElementById('notificationsBadge').textContent = '0';
      showToast('All notifications marked as read', 'success', 3000);
    }

    function dismissNotification(notificationId) {
      const notification = document.querySelector(`[data-id="${notificationId}"]`);
      if (notification) {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }
    }

    function openNotificationSettings() {
      showToast('Notification settings would open here', 'info', 3000);
    }

    // Message functions
    function composeMessage() {
      const modal = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" onclick="if(event.target === this) closeComposeModal()">
          <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
            <h3 style="margin: 0 0 1rem 0;">Compose Message</h3>
            <form onsubmit="sendMessage(event)">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">To:</label>
                <input type="text" name="recipient" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" placeholder="Enter recipient">
              </div>
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Subject:</label>
                <input type="text" name="subject" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" placeholder="Enter subject">
              </div>
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Message:</label>
                <textarea name="message" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" rows="4" placeholder="Enter your message"></textarea>
              </div>
              <div style="display: flex; gap: 1rem;">
                <button type="submit" style="flex: 1; background: #5a5bb8; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">Send</button>
                <button type="button" onclick="closeComposeModal()" style="flex: 1; background: #6b7280; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closeComposeModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) modal.remove();
    }

    function sendMessage(event) {
      event.preventDefault();
      showToast('Message sent successfully!', 'success', 3000);
      closeComposeModal();
    }

    function markMessageRead(messageId) {
      showToast(`Opening message ${messageId}`, 'info', 3000);
      closeAllDropdowns();
    }

    // Profile functions
    function viewFullProfile() {
      showToast('Opening full profile...', 'info', 3000);
    }

    function editProfile() {
      showToast('Opening profile editor...', 'info', 3000);
    }

    function logout() {
      if (confirm('Are you sure you want to log out?')) {
        showToast('Logging out...', 'info', 3000);
        setTimeout(() => {
          window.location.href = '/';
        }, 1000);
      }
    }

    // Sign out function (for compatibility)
    function signOut() {
      logout();
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Search trigger
      const searchTrigger = document.getElementById('searchTrigger');
      if (searchTrigger) {
        searchTrigger.addEventListener('click', () => toggleDropdown('searchDropdown', 'searchTrigger'));
      }

      // Notifications trigger
      const notificationsTrigger = document.getElementById('notificationsTrigger');
      if (notificationsTrigger) {
        notificationsTrigger.addEventListener('click', () => toggleDropdown('notificationsDropdown', 'notificationsTrigger'));
      }

      // Messages trigger
      const messagesTrigger = document.getElementById('messagesTrigger');
      if (messagesTrigger) {
        messagesTrigger.addEventListener('click', () => toggleDropdown('messagesDropdown', 'messagesTrigger'));
      }

      // Profile trigger
      const profileTrigger = document.getElementById('profileTrigger');
      if (profileTrigger) {
        profileTrigger.addEventListener('click', () => toggleDropdown('profileDropdown', 'profileTrigger'));
      }

      // Search input
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch) {
        globalSearch.addEventListener('input', (e) => handleSearch(e.target.value));
      }

      // Mobile menu toggle
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const navOverlay = document.getElementById('navOverlay');
      if (mobileMenuToggle && navOverlay) {
        mobileMenuToggle.addEventListener('click', () => {
          const isOpen = navOverlay.getAttribute('aria-hidden') === 'false';
          navOverlay.setAttribute('aria-hidden', !isOpen);
          navOverlay.style.display = isOpen ? 'none' : 'block';
          mobileMenuToggle.setAttribute('aria-expanded', !isOpen);
        });
      }

      // Click outside to close dropdowns
      document.addEventListener('click', function(event) {
        const isDropdownTrigger = event.target.closest('.header-search__trigger, .header-notifications__trigger, .header-messages__trigger, .header-profile__trigger');
        const isDropdownContent = event.target.closest('.header-search__dropdown, .header-notifications__dropdown, .header-messages__dropdown, .header-profile__dropdown');

        if (!isDropdownTrigger && !isDropdownContent) {
          closeAllDropdowns();
        }
      });

      // Check what modal should be reopened (they're mutually exclusive)
      const curriculumWasOpen = localStorage.getItem('curriculumManagerOpen');
      const statsWasOpen = localStorage.getItem('statsModalOpen');
      const degreeRequirementsWasOpen = localStorage.getItem('degreeRequirementsOpen');

      if (curriculumWasOpen === 'true') {
        const wasFullscreen = localStorage.getItem('curriculumManagerFullscreen');

        // Open immediately - no delay needed since content is hidden
        openCurriculumManager();

        // If it was fullscreen, apply fullscreen immediately
        if (wasFullscreen === 'true') {
          // Immediate fullscreen - use nextTick to ensure modal is in DOM
          requestAnimationFrame(() => {
            toggleFullscreen();
          });
        }

      } else if (statsWasOpen === 'true') {
        // Open immediately - no delay needed since content is hidden
        openProgramStats();

        // Check if it was in fullscreen mode
        const statsWasFullscreen = localStorage.getItem('statsModalFullscreen');
        if (statsWasFullscreen === 'true') {
          // Set fullscreen state before opening
          requestAnimationFrame(() => {
            isFullScreen = true;
            // Regenerate modal with fullscreen layout
            const modal = document.getElementById('statsModal');
            if (modal) {
              modal.innerHTML = generateStatsModal();
            }
          });
        }
      } else if (degreeRequirementsWasOpen === 'true') {
        // Open immediately - no delay needed since content is hidden
        openDegreeRequirements();

        // Check if it was in fullscreen mode
        const degreeWasFullscreen = localStorage.getItem('degreeRequirementsFullscreen');
        if (degreeWasFullscreen === 'true') {
          // Set fullscreen state after modal is loaded
          requestAnimationFrame(() => {
            setTimeout(() => {
              toggleDegreeFullscreen();
            }, 150);
          });
        }

        // Show a restoration message
        setTimeout(() => {
          showToast('🔄 Restored your degree requirements session', 'info', 2000);

          // Check if validation results were also open
          checkAndRestoreValidationResults();
        }, 800);
      }
    });

    // Enhanced Programs specific functions
    function joinBeta() {
      // Create comprehensive beta program application form
      const formHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;" onclick="if(event.target === this) closeBetaModal()">
          <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
            <div style="text-align: center; margin-bottom: 2rem;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">🚀</div>
              <h2 style="margin: 0 0 0.5rem 0; color: #5a5bb8; font-size: 1.6rem;">Join Beta Program</h2>
              <p style="color: #6b7280; margin: 0; line-height: 1.6;">Get early access to Flow's revolutionary admissions management tools and help shape the future of higher education technology</p>
            </div>
            <form onsubmit="submitBetaApplication(event)">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Institution Name *</label>
                  <input type="text" name="institution" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="University of Excellence">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Institution Type *</label>
                  <select name="institutionType" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Type</option>
                    <option value="university">University</option>
                    <option value="college">College</option>
                    <option value="community-college">Community College</option>
                    <option value="vocational">Vocational School</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Your Name *</label>
                  <input type="text" name="name" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="John Smith">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Your Title *</label>
                  <input type="text" name="title" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="Director of Admissions">
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Address *</label>
                  <input type="email" name="email" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="john.smith@university.edu">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Phone Number</label>
                  <input type="tel" name="phone" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="+1 (555) 123-4567">
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Annual Applications Volume *</label>
                  <select name="applicationVolume" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Range</option>
                    <option value="under-500">Under 500</option>
                    <option value="500-2000">500 - 2,000</option>
                    <option value="2000-5000">2,000 - 5,000</option>
                    <option value="5000-10000">5,000 - 10,000</option>
                    <option value="over-10000">Over 10,000</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Current System</label>
                  <input type="text" name="currentSystem" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="e.g., Banner, Slate, Custom">
                </div>
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Areas of Interest (Check all that apply)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="workflow-automation" style="margin-right: 0.5rem;"> Workflow Automation</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="interview-scheduling" style="margin-right: 0.5rem;"> Interview Scheduling</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="decision-tracking" style="margin-right: 0.5rem;"> Decision Tracking</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="analytics" style="margin-right: 0.5rem;"> Analytics & Reporting</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="integration" style="margin-right: 0.5rem;"> System Integration</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="interests" value="compliance" style="margin-right: 0.5rem;"> Compliance Tools</label>
                </div>
              </div>
              
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">What challenges are you hoping to solve?</label>
                <textarea name="challenges" rows="3" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; resize: vertical;" placeholder="e.g., Manual processes taking too long, need better applicant tracking, difficulty with interview coordination..."></textarea>
              </div>
              
              <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">Beta Program Benefits</h4>
                <ul style="margin: 0; padding-left: 1.2rem; color: #92400e; font-size: 0.9rem;">
                  <li>Early access to cutting-edge admissions tools</li>
                  <li>Direct input on feature development</li>
                  <li>Priority support and training</li>
                  <li>Special beta pricing when we launch</li>
                </ul>
              </div>
              
              <div style="display: flex; gap: 1rem;">
                <button type="submit" style="flex: 1; background: linear-gradient(135deg, #f59e0b, #f97316); color: white; border: none; padding: 1rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: transform 0.2s;">
                  🚀 Apply for Beta Access
                </button>
                <button type="button" onclick="closeBetaModal()" style="flex: 0.4; background: #6b7280; color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', formHtml);
      showToast('🌟 Fill out the beta application to get early access to our revolutionary admissions tools', 'info', 4000);
    }
    
    function scheduleDemo() {
      // Create comprehensive demo scheduling form
      const formHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;" onclick="if(event.target === this) closeDemoModal()">
          <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 580px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
            <div style="text-align: center; margin-bottom: 2rem;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #5a5bb8, #6b6ce8); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">📅</div>
              <h2 style="margin: 0 0 0.5rem 0; color: #5a5bb8; font-size: 1.6rem;">Schedule Admissions Demo</h2>
              <p style="color: #6b7280; margin: 0; line-height: 1.6;">Book a personalized demonstration of Flow's admissions management platform tailored to your institution's needs</p>
            </div>
            <form onsubmit="submitDemoSchedule(event)">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Institution Name *</label>
                  <input type="text" name="institution" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="University of Excellence">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Your Name *</label>
                  <input type="text" name="name" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="John Smith">
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Address *</label>
                  <input type="email" name="email" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" placeholder="john.smith@university.edu">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Your Role *</label>
                  <select name="role" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Role</option>
                    <option value="director-admissions">Director of Admissions</option>
                    <option value="admissions-officer">Admissions Officer</option>
                    <option value="registrar">Registrar</option>
                    <option value="it-director">IT Director</option>
                    <option value="provost">Provost/VP Academic Affairs</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Preferred Demo Date *</label>
                  <input type="date" name="preferred_date" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" min="${new Date().toISOString().split('T')[0]}">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Preferred Time *</label>
                  <select name="preferred_time" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Time</option>
                    <option value="9:00 AM">9:00 AM</option>
                    <option value="10:00 AM">10:00 AM</option>
                    <option value="11:00 AM">11:00 AM</option>
                    <option value="1:00 PM">1:00 PM</option>
                    <option value="2:00 PM">2:00 PM</option>
                    <option value="3:00 PM">3:00 PM</option>
                    <option value="4:00 PM">4:00 PM</option>
                  </select>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Time Zone *</label>
                  <select name="timezone" required style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="">Select Timezone</option>
                    <option value="EST">Eastern (EST)</option>
                    <option value="CST">Central (CST)</option>
                    <option value="MST">Mountain (MST)</option>
                    <option value="PST">Pacific (PST)</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Demo Length</label>
                  <select name="demo_length" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                    <option value="30">30 minutes (Overview)</option>
                    <option value="60" selected>60 minutes (Comprehensive)</option>
                    <option value="90">90 minutes (Deep Dive)</option>
                  </select>
                </div>
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Additional Attendees (Optional)</label>
                <textarea name="attendees" rows="2" style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; resize: vertical;" placeholder="List names and roles of other team members who will join the demo..."></textarea>
              </div>
              
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Specific Topics to Cover</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px;">
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="application-processing" style="margin-right: 0.5rem;" checked> Application Processing</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="workflow-automation" style="margin-right: 0.5rem;"> Workflow Automation</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="interview-management" style="margin-right: 0.5rem;"> Interview Management</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="reporting" style="margin-right: 0.5rem;"> Analytics & Reporting</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="integrations" style="margin-right: 0.5rem;"> System Integrations</label>
                  <label style="display: flex; align-items: center; font-size: 0.9rem;"><input type="checkbox" name="topics" value="pricing" style="margin-right: 0.5rem;"> Pricing & Implementation</label>
                </div>
              </div>
              
              <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                <h4 style="margin: 0 0 0.5rem 0; color: #1d4ed8;">What to Expect</h4>
                <ul style="margin: 0; padding-left: 1.2rem; color: #1d4ed8; font-size: 0.9rem;">
                  <li>Personalized walkthrough of admissions workflows</li>
                  <li>Q&A session tailored to your institution</li>
                  <li>Integration discussion and timeline planning</li>
                  <li>Custom pricing proposal</li>
                </ul>
              </div>
              
              <div style="display: flex; gap: 1rem;">
                <button type="submit" style="flex: 1; background: linear-gradient(135deg, #5a5bb8, #6b6ce8); color: white; border: none; padding: 1rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: transform 0.2s;">
                  📅 Schedule Demo
                </button>
                <button type="button" onclick="closeDemoModal()" style="flex: 0.4; background: #6b7280; color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', formHtml);
      showToast('📅 Schedule your personalized admissions management demo', 'info', 4000);
    }
    
    // Helper functions for form handling
    function submitBetaApplication(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      // Get selected interests
      const interests = Array.from(event.target.querySelectorAll('input[name="interests"]:checked'))
                           .map(input => input.value);
      data.interests = interests;
      
      showToast('⏳ Submitting your beta application...', 'info', 2000);
      
      setTimeout(() => {
        showToast(`🎉 Beta application submitted successfully!<br>📧 Confirmation sent to: ${data.email}<br>🚀 We'll review your application and contact you within 48 hours with next steps`, 'success', 8000);
        
        // Generate beta application package
        const betaPackage = {
          applicationType: "Beta Program Application",
          submissionDate: new Date().toISOString(),
          institution: data.institution,
          contact: data.name,
          email: data.email,
          applicationVolume: data.applicationVolume,
          interests: interests,
          challenges: data.challenges,
          status: "Under Review"
        };
        
        downloadFile('Flow_Beta_Application_Confirmation.json', JSON.stringify(betaPackage, null, 2));
        
        closeBetaModal();
        
        setTimeout(() => {
          showToast('💡 Check your downloads for your application confirmation. We\'ll be in touch soon!', 'info', 4000);
        }, 2000);
      }, 1500);
    }
    
    function submitDemoSchedule(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      // Get selected topics
      const topics = Array.from(event.target.querySelectorAll('input[name="topics"]:checked'))
                         .map(input => input.value);
      data.topics = topics;
      
      showToast('⏳ Scheduling your demo...', 'info', 2000);
      
      setTimeout(() => {
        showToast(`✅ Demo scheduled successfully!<br>📧 Calendar invite sent to: ${data.email}<br>📅 ${data.preferred_date} at ${data.preferred_time} ${data.timezone}<br>🎯 Our team will send you a preparation guide`, 'success', 8000);
        
        // Generate demo confirmation package
        const demoPackage = {
          demoType: "Admissions Management Demo",
          scheduledDate: data.preferred_date,
          scheduledTime: data.preferred_time,
          timezone: data.timezone,
          institution: data.institution,
          primaryContact: data.name,
          email: data.email,
          role: data.role,
          duration: data.demo_length + " minutes",
          topics: topics,
          attendees: data.attendees || "Not specified",
          confirmationCode: "FLOW-ADM-" + Math.random().toString(36).substr(2, 8).toUpperCase(),
          status: "Confirmed"
        };
        
        downloadFile('Flow_Demo_Confirmation.json', JSON.stringify(demoPackage, null, 2));
        
        closeDemoModal();
        
        setTimeout(() => {
          if (confirm('📱 Would you like us to send you SMS reminders for your scheduled demo?')) {
            showToast('📲 SMS reminders enabled! You\'ll receive notifications 24 hours and 1 hour before your demo.', 'success', 5000);
          }
        }, 2000);
      }, 1500);
    }
    
    function closeBetaModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) {
        modal.remove();
      }
    }
    
    function closeDemoModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) {
        modal.remove();
      }
    }
    
    // Helper function to download file
    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }
    
    // Scroll to top function - make it globally accessible
    function scrollToTop() {
      try {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        console.log('Scrolled to top');
      } catch (error) {
        // Fallback for older browsers
        window.scrollTo(0, 0);
        console.log('Scrolled to top (fallback)');
      }
    }
    
    // Make functions globally accessible
    window.scrollToTop = scrollToTop;
    window.joinBeta = joinBeta;
    window.scheduleDemo = scheduleDemo;

    // ========== CURRICULUM MANAGEMENT SYSTEM ==========

    // Global data stores
    // Course catalog and curriculum data structures
    let courseCatalog = {
      courses: [],
      catalogYear: "2024-2025",
      version: "1.0"
    };

    let curriculumData = {
      programs: {},
      currentProgram: null,
      isDirty: false,
      lastSaved: null
    };

    // Sample course data initialization
    function initializeSampleData() {
      courseCatalog.courses = [
        {
          id: "CS101", code: "CS-101", title: "Introduction to Computer Science",
          shortDesc: "Fundamentals of programming and computer science",
          longDesc: "An introduction to computer science through programming. Topics include data types, control structures, functions, arrays, and basic algorithms.",
          credits: 3, contactHours: 45, tags: ["core", "programming", "beginner"],
          deliveryMode: "in-person", status: "active",
          effectiveDate: "2024-08-01", endDate: null,
          prerequisites: [], corequisites: [], repeatability: "no",
          crossListing: "COMP-101"
        },
        {
          id: "MATH201", code: "MATH-201", title: "Calculus I",
          shortDesc: "Differential calculus with applications",
          longDesc: "Limits, derivatives, and applications of differential calculus. Includes optimization problems and related rates.",
          credits: 4, contactHours: 60, tags: ["core", "mathematics", "calculus"],
          deliveryMode: "hybrid", status: "active",
          effectiveDate: "2024-08-01", endDate: null,
          prerequisites: ["MATH-120"], corequisites: [], repeatability: "no",
          crossListing: "CALC-201"
        },
        {
          id: "ENG110", code: "ENG-110", title: "Composition and Rhetoric",
          shortDesc: "Academic writing and critical thinking",
          longDesc: "Development of writing skills through practice in various rhetorical modes. Emphasis on critical thinking, research methods, and documentation.",
          credits: 3, contactHours: 45, tags: ["core", "writing", "communication"],
          deliveryMode: "in-person", status: "active",
          effectiveDate: "2024-08-01", endDate: null,
          prerequisites: [], corequisites: [], repeatability: "no",
          crossListing: null
        }
      ];
    }

    // Degree Requirements Configuration System
    window.openDegreeRequirements = function() {
      showDegreeRequirementsModal();
      // Remember that degree requirements is open
      localStorage.setItem('degreeRequirementsOpen', 'true');
    };

    // Show the main degree requirements modal
    function showDegreeRequirementsModal() {
      const modal = document.createElement('div');
      modal.id = 'degreeRequirementsModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      `;

      let isDegreeFullScreen = false;

      const modalContent = `
        <div id="degreeRequirementsContent" style="
          background: #1f2937;
          width: 95%;
          height: 90%;
          max-width: 1400px;
          border-radius: 16px;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
          display: flex;
          flex-direction: column;
          overflow: hidden;
          transform: scale(0.9);
          transition: transform 0.3s ease;
        ">
          <!-- Header -->
          <div id="degreeHeader" style="
            background: linear-gradient(135deg, #374151, #4b5563);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4b5563;
            flex-shrink: 0;
          ">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <svg width="20" height="20" fill="#60a5fa">
                <rect x="2" y="3" width="16" height="14" rx="2" fill="none" stroke="#60a5fa" stroke-width="1.2"/>
                <circle x="5" y="7" r="1.5" fill="#22c55e"/>
                <circle x="9" y="7" r="1.5" fill="#f59e0b"/>
                <circle x="13" y="7" r="1.5" fill="#3b82f6"/>
                <rect x="4" y="10" width="3" height="1" fill="#22c55e" opacity="0.7"/>
                <rect x="8" y="10" width="3" height="1" fill="#f59e0b" opacity="0.7"/>
                <rect x="12" y="10" width="3" height="1" fill="#3b82f6" opacity="0.7"/>
                <path d="M3 12l2-1 2 1.5 2-0.5 2 1 2-1.5 2 0.5" stroke="#8b5cf6" stroke-width="1" fill="none"/>
              </svg>
              <span style="color: white; font-weight: 600; font-size: 0.9rem;">🎓 Degree Requirements Editor</span>
            </div>

            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <button id="degreeFullscreenBtn" onclick="toggleDegreeFullscreen()" style="
                background: rgba(96, 165, 250, 0.1);
                color: #60a5fa;
                border: 1px solid rgba(96, 165, 250, 0.3);
                padding: 0.5rem 0.75rem;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.8rem;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                transition: all 0.2s ease;
              " onmouseover="this.style.background='rgba(96, 165, 250, 0.2)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.1)'">
                <svg width="14" height="14" fill="currentColor" id="degreeFullscreenIcon">
                  <path d="M3 3v5h2V5h3V3H3zM3 16h5v-2H5v-3H3v5zM16 3h-5v2h3v3h2V3zM16 16v-5h-2v3h-3v2h5z"/>
                </svg>
                <span id="degreeFullscreenText">Fullscreen</span>
              </button>

              <button onclick="closeDegreeRequirements()" style="
                background: rgba(239, 68, 68, 0.1);
                color: #ef4444;
                border: 1px solid rgba(239, 68, 68, 0.3);
                padding: 0.5rem 0.75rem;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.8rem;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                transition: all 0.2s ease;
              " onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                <span>Back to Programs page</span>
              </button>
            </div>
          </div>

          <!-- Content Area -->
          <div style="flex: 1; overflow-y: auto; background: #f8fafc;">
            <div style="display: grid; grid-template-columns: 300px 1fr; height: 100%;">
              <!-- Left Sidebar -->
              <div style="background: #374151; color: white; padding: 1.5rem; overflow-y: auto;">
                <h3 style="margin: 0 0 1.5rem 0; font-size: 1.1rem; color: #e5e7eb;">Program Selection</h3>

                <div style="margin-bottom: 2rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #d1d5db;">Select Program</label>
                  <select id="degreeProgram" onchange="loadDegreeProgram(this.value)" style="width: 100%; padding: 0.75rem; border: 1px solid #4b5563; border-radius: 6px; background: #1f2937; color: white; font-size: 0.9rem;">
                    <option value="">Choose program...</option>
                    <option value="computer-science-bs">Computer Science (B.S.)</option>
                    <option value="computer-science-ms">Computer Science (M.S.)</option>
                    <option value="data-science-ms">Data Science (M.S.)</option>
                    <option value="software-engineering-bs">Software Engineering (B.S.)</option>
                    <option value="cybersecurity-bs">Cybersecurity (B.S.)</option>
                  </select>
                </div>

                <h3 style="margin: 0 0 1rem 0; font-size: 1rem; color: #e5e7eb;">Quick Actions</h3>
                <div style="display: grid; gap: 0.75rem;">
                  <button onclick="addRequirementBlock()" style="width: 100%; padding: 0.75rem; background: #059669; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#047857'" onmouseout="this.style.background='#059669'">
                    + Add Requirement Block
                  </button>
                  <button onclick="validateRules()" style="width: 100%; padding: 0.75rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                    🔍 Validate Rules
                  </button>
                  <button onclick="previewAudit()" style="width: 100%; padding: 0.75rem; background: #7c3aed; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                    👁️ Preview Audit
                  </button>
                  <button onclick="importRequirements()" style="width: 100%; padding: 0.75rem; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">
                    📥 Import Config
                  </button>
                  <button onclick="exportRequirements()" style="width: 100%; padding: 0.75rem; background: #0891b2; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#0e7490'" onmouseout="this.style.background='#0891b2'">
                    📤 Export Config
                  </button>
                </div>

                <div style="margin-top: 2rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
                  <h4 style="margin: 0 0 0.75rem 0; color: #93c5fd; font-size: 0.9rem;">📋 Current Configuration</h4>
                  <div id="configSummary" style="font-size: 0.8rem; color: #d1d5db;">
                    <div>Requirement Blocks: <span id="blockCount">0</span></div>
                    <div>Total Credits: <span id="totalCredits">0</span></div>
                    <div>Last Modified: <span id="lastModified">Never</span></div>
                  </div>
                </div>
              </div>

              <!-- Main Content Area -->
              <div style="padding: 2rem; overflow-y: auto;">
                <div id="degreeContent">
                  <div style="text-align: center; padding: 4rem 2rem; color: #6b7280;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.6;">🎓</div>
                    <h3 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.5rem;">Degree Requirements Editor</h3>
                    <p style="margin: 0; line-height: 1.6; max-width: 500px; margin: 0 auto;">Select a program from the sidebar to begin configuring degree requirements, audit rules, and graduation criteria. Create comprehensive requirement blocks with AND/OR logic, credit thresholds, and validation rules.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      modal.innerHTML = modalContent;
      document.body.appendChild(modal);

      // Animation
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
        document.getElementById('degreeRequirementsContent').style.transform = 'scale(1)';
      });

      // Fullscreen toggle function
      window.toggleDegreeFullscreen = function() {
        const content = document.getElementById('degreeRequirementsContent');
        const header = document.getElementById('degreeHeader');
        const fullscreenBtn = document.getElementById('degreeFullscreenBtn');
        const fullscreenIcon = document.getElementById('degreeFullscreenIcon');
        const fullscreenText = document.getElementById('degreeFullscreenText');

        isDegreeFullScreen = !isDegreeFullScreen;

        if (isDegreeFullScreen) {
          content.style.width = '100%';
          content.style.height = '100%';
          content.style.maxWidth = 'none';
          content.style.borderRadius = '0';
          header.style.padding = '0.5rem 1rem';

          fullscreenIcon.innerHTML = '<path d="M8 3v5h2V5h3v2h5V3H8zM8 16h5v-2h-3v-3H8v5zM16 8h-2v3h-3v2h5V8z"/>';
          fullscreenText.textContent = 'Exit Fullscreen';

          showToast('🖥️ Entered fullscreen mode', 'success', 2000);
        } else {
          content.style.width = '95%';
          content.style.height = '90%';
          content.style.maxWidth = '1400px';
          content.style.borderRadius = '16px';
          header.style.padding = '0.75rem 1.5rem';

          fullscreenIcon.innerHTML = '<path d="M3 3v5h2V5h3V3H3zM3 16h5v-2H5v-3H3v5zM16 3h-5v2h3v3h2V3zM16 16v-5h-2v3h-3v2h5z"/>';
          fullscreenText.textContent = 'Fullscreen';

          showToast('📱 Exited fullscreen mode', 'info', 2000);
        }

        // Save state
        localStorage.setItem('degreeRequirementsFullscreen', isDegreeFullScreen.toString());
      };

      // Close function
      window.closeDegreeRequirements = function() {
        const modal = document.getElementById('degreeRequirementsModal');
        if (modal) {
          modal.style.opacity = '0';
          setTimeout(() => {
            if (document.body.contains(modal)) {
              document.body.removeChild(modal);
            }
            // Clear localStorage flags
            localStorage.removeItem('degreeRequirementsOpen');
            localStorage.removeItem('degreeRequirementsFullscreen');
            // Note: We keep currentDegreeProgram saved for next time

          }, 300);
        }
        showToast('📚 Returned to Programs page', 'info', 2000);
      };

      // Check for saved fullscreen state
      const wasFullscreen = localStorage.getItem('degreeRequirementsFullscreen');
      if (wasFullscreen === 'true') {
        setTimeout(() => toggleDegreeFullscreen(), 100);
      }

      // Restore the previously selected program
      restoreSelectedProgram();
    }

    // Restore the previously selected program
    function restoreSelectedProgram() {
      const savedProgram = localStorage.getItem('currentDegreeProgram');
      if (savedProgram) {
        // Use a small delay to ensure the modal and selector are fully rendered
        setTimeout(() => {
          const programSelector = document.getElementById('degreeProgram');
          if (programSelector) {
            programSelector.value = savedProgram;
            // Load the program data
            loadDegreeProgram(savedProgram);
            console.log('Restored degree program:', savedProgram);
          } else {
            console.warn('Program selector not found, retrying...');
            // Retry after a longer delay if the selector is not found
            setTimeout(() => {
              const retrySelector = document.getElementById('degreeProgram');
              if (retrySelector) {
                retrySelector.value = savedProgram;
                loadDegreeProgram(savedProgram);
                console.log('Restored degree program (retry):', savedProgram);
              }
            }, 500);
          }
        }, 100);
      }
    }

    // Check and restore validation results if they were open
    function checkAndRestoreValidationResults() {
      const validationWasOpen = localStorage.getItem('validationResultsOpen');
      const validationData = localStorage.getItem('validationResultsData');

      if (validationWasOpen === 'true' && validationData) {
        try {
          const data = JSON.parse(validationData);
          // Only restore if it's recent (within 30 minutes) and for the same program
          const timeDiff = Date.now() - data.timestamp;
          if (timeDiff < 30 * 60 * 1000 && data.program === currentDegreeProgram) {
            // Restore validation results with a slight delay
            setTimeout(() => {
              showValidationResultsModal(data.issues, data.warnings, data.totalMinCredits, data.totalMaxCredits);
              showToast('📋 Restored validation results', 'info', 2000);
            }, 1000);
          } else {
            // Clear old validation data
            localStorage.removeItem('validationResultsOpen');
            localStorage.removeItem('validationResultsData');
          }
        } catch (error) {
          console.warn('Failed to restore validation results:', error);
          localStorage.removeItem('validationResultsOpen');
          localStorage.removeItem('validationResultsData');
        }
      }
    }

    // Degree Requirements Core Functions
    let currentDegreeProgram = null;
    let degreeRequirements = {};

    // Load degree program configuration
    window.loadDegreeProgram = function(programId) {
      if (!programId) {
        currentDegreeProgram = null;
        localStorage.removeItem('currentDegreeProgram');
        updateDegreeContent();
        return;
      }

      currentDegreeProgram = programId;
      // Save the current selected program
      localStorage.setItem('currentDegreeProgram', programId);

      // Load saved requirements or create default structure
      const savedKey = `degreeReqs_${programId}`;
      const saved = localStorage.getItem(savedKey);

      if (saved) {
        degreeRequirements = JSON.parse(saved);
      } else {
        // Initialize with default structure
        degreeRequirements = {
          programId: programId,
          catalogYear: new Date().getFullYear(),
          requirements: [],
          lastModified: new Date().toISOString()
        };
      }

      updateDegreeContent();
      updateConfigSummary();
      showToast(`Loaded ${programId.replace(/-/g, ' ')} requirements`, 'info', 2000);
    };

    // Add new requirement block
    window.addRequirementBlock = function() {
      if (!currentDegreeProgram) {
        showToast('Please select a program first', 'warning', 3000);
        return;
      }

      const blockId = 'block_' + Date.now();
      const newBlock = {
        id: blockId,
        type: 'core_credits',
        title: 'New Requirement Block',
        description: '',
        credits: { min: 0, max: null },
        rules: [],
        logic: 'AND',
        active: true,
        created: new Date().toISOString()
      };

      degreeRequirements.requirements.push(newBlock);
      saveDegreeRequirements();
      updateDegreeContent();
      showToast('Added new requirement block', 'success', 2000);
    };

    // Validate requirement rules
    window.validateRules = function() {
      if (!currentDegreeProgram || !degreeRequirements.requirements.length) {
        showToast('No requirements to validate', 'warning', 3000);
        return;
      }

      const issues = [];
      const warnings = [];
      let totalMinCredits = 0;
      let totalMaxCredits = 0;
      let hasGpaRequirement = false;
      let hasCapstone = false;

      // Analyze each requirement block
      degreeRequirements.requirements.forEach(req => {
        if (req.archived) return; // Skip archived blocks

        if (req.active) {
          totalMinCredits += req.credits.min || 0;
          if (req.credits.max) totalMaxCredits += req.credits.max;

          // Critical validation issues
          if (req.credits.min > (req.credits.max || 999)) {
            issues.push(`❌ ${req.title}: Minimum credits (${req.credits.min}) exceeds maximum credits (${req.credits.max})`);
          }

          if ((req.credits.min || 0) === 0 && req.type !== 'gpa_threshold') {
            warnings.push(`⚠️ ${req.title}: Zero minimum credits may be unintended`);
          }

          if (!req.title || req.title.trim() === '' || req.title === 'New Requirement Block') {
            issues.push(`❌ ${req.title || 'Unnamed block'}: Missing or default title`);
          }

          if (req.minGPA && (req.minGPA < 0 || req.minGPA > 4.0)) {
            issues.push(`❌ ${req.title}: Invalid GPA requirement (${req.minGPA})`);
          }

          // Track important requirement types
          if (req.type === 'gpa_threshold') hasGpaRequirement = true;
          if (req.type === 'capstone') hasCapstone = true;

          // Logic validation
          if (req.logic === 'XOR' && (!req.requiredCourses || req.requiredCourses.length < 2)) {
            warnings.push(`⚠️ ${req.title}: XOR logic requires multiple options`);
          }

          // Date validation
          if (req.effectiveDate && req.expirationDate) {
            const effective = new Date(req.effectiveDate);
            const expiration = new Date(req.expirationDate);
            if (effective >= expiration) {
              issues.push(`❌ ${req.title}: Effective date must be before expiration date`);
            }
          }

          // Custom validation rules check
          if (req.validationRules && Object.keys(req.validationRules).length > 0) {
            try {
              // Basic validation that the rules are properly structured
              JSON.stringify(req.validationRules);
            } catch (error) {
              issues.push(`❌ ${req.title}: Invalid validation rules format`);
            }
          }
        } else {
          warnings.push(`⚠️ ${req.title}: Block is inactive`);
        }
      });

      // Program-level validation
      if (totalMinCredits < 30) {
        warnings.push(`⚠️ Total minimum credits (${totalMinCredits}) seems low for a degree program`);
      } else if (totalMinCredits > 200) {
        issues.push(`❌ Total minimum credits (${totalMinCredits}) seems excessive`);
      }

      if (!hasGpaRequirement) {
        warnings.push(`⚠️ No GPA requirement block found`);
      }

      if (!hasCapstone) {
        warnings.push(`⚠️ No capstone/thesis requirement found`);
      }

      // Show validation results modal
      showValidationResultsModal(issues, warnings, totalMinCredits, totalMaxCredits);

      // Save state for restoration
      localStorage.setItem('validationResultsOpen', 'true');
      localStorage.setItem('validationResultsData', JSON.stringify({
        issues, warnings, totalMinCredits, totalMaxCredits,
        program: currentDegreeProgram,
        timestamp: Date.now()
      }));
    };

    // Preview audit with hypothetical student
    window.previewAudit = function() {
      if (!currentDegreeProgram) {
        showToast('Please select a program first', 'warning', 3000);
        return;
      }

      // Create sample audit preview
      showAuditPreviewModal();
    };

    // Import requirements configuration
    window.importRequirements = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const imported = JSON.parse(e.target.result);
              degreeRequirements = imported;
              saveDegreeRequirements();
              updateDegreeContent();
              updateConfigSummary();
              showToast('Requirements imported successfully', 'success', 3000);
            } catch (error) {
              showToast('Error importing file: Invalid JSON', 'error', 4000);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    };

    // Export requirements configuration
    window.exportRequirements = function() {
      if (!currentDegreeProgram) {
        showToast('Please select a program first', 'warning', 3000);
        return;
      }

      const exportData = {
        ...degreeRequirements,
        exportedAt: new Date().toISOString(),
        version: '1.0'
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `degree-requirements-${currentDegreeProgram}-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Requirements exported successfully', 'success', 3000);
    };

    // Save current degree requirements to localStorage
    function saveDegreeRequirements() {
      if (!currentDegreeProgram) return;

      degreeRequirements.lastModified = new Date().toISOString();
      const saveKey = `degreeReqs_${currentDegreeProgram}`;
      localStorage.setItem(saveKey, JSON.stringify(degreeRequirements));
      updateConfigSummary();
    }

    // Update main content area
    function updateDegreeContent() {
      const content = document.getElementById('degreeContent');
      if (!content) return;

      if (!currentDegreeProgram) {
        content.innerHTML = `
          <div style="text-align: center; padding: 4rem 2rem; color: #6b7280;">
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.6;">🎓</div>
            <h3 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.5rem;">Degree Requirements Editor</h3>
            <p style="margin: 0; line-height: 1.6; max-width: 500px; margin: 0 auto;">Select a program from the sidebar to begin configuring degree requirements, audit rules, and graduation criteria. Create comprehensive requirement blocks with AND/OR logic, credit thresholds, and validation rules.</p>
          </div>
        `;
        return;
      }

      const requirementBlocks = degreeRequirements.requirements || [];

      content.innerHTML = `
        <div style="margin-bottom: 2rem;">
          <h2 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1.5rem; text-transform: capitalize;">
            ${currentDegreeProgram.replace(/-/g, ' ')} Requirements
          </h2>
          <p style="margin: 0; color: #6b7280; font-size: 0.95rem;">
            Catalog Year: ${degreeRequirements.catalogYear} •
            Blocks: ${requirementBlocks.filter(r => r.active).length} active
          </p>
        </div>

        <div id="requirementBlocks" style="display: grid; gap: 1.5rem;">
          ${requirementBlocks.map(block => generateRequirementBlockHTML(block)).join('')}
        </div>

        ${requirementBlocks.length === 0 ? `
          <div style="text-align: center; padding: 3rem 2rem; background: #f8fafc; border: 2px dashed #d1d5db; border-radius: 12px; margin-top: 2rem;">
            <div style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.6;">📋</div>
            <h4 style="margin: 0 0 0.5rem 0; color: #374151;">No requirement blocks defined</h4>
            <p style="margin: 0 0 1.5rem 0; color: #6b7280;">Click "Add Requirement Block" to start building your degree requirements.</p>
            <button onclick="addRequirementBlock()" style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">
              + Add First Block
            </button>
          </div>
        ` : ''}
      `;
    }

    // Generate HTML for a requirement block
    function generateRequirementBlockHTML(block) {
      const blockTypes = {
        'core_credits': { icon: '🎯', label: 'Core Credits', color: '#dc2626' },
        'elective_credits': { icon: '📚', label: 'Elective Credits', color: '#059669' },
        'total_credits': { icon: '📊', label: 'Total Credits', color: '#2563eb' },
        'gpa_threshold': { icon: '📈', label: 'GPA Requirement', color: '#7c3aed' },
        'residency': { icon: '🏠', label: 'Residency', color: '#0891b2' },
        'capstone': { icon: '🎓', label: 'Capstone/Thesis', color: '#ea580c' },
        'breadth': { icon: '🌐', label: 'Breadth/Distribution', color: '#16a34a' }
      };

      const typeInfo = blockTypes[block.type] || blockTypes['core_credits'];

      return `
        <div class="requirement-block" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span style="font-size: 1.5rem;">${typeInfo.icon}</span>
              <div>
                <h4 style="margin: 0; color: #1f2937; font-size: 1.1rem;">${block.title}</h4>
                <span style="background: ${typeInfo.color}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">${typeInfo.label}</span>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="editRequirementBlock('${block.id}')" style="padding: 0.5rem; background: #f3f4f6; border: none; border-radius: 6px; cursor: pointer; color: #374151;" title="Edit">
                ✏️
              </button>
              <button onclick="deleteRequirementBlock('${block.id}')" style="padding: 0.5rem; background: #fef2f2; border: none; border-radius: 6px; cursor: pointer; color: #dc2626;" title="Delete">
                🗑️
              </button>
            </div>
          </div>

          ${block.description ? `<p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">${block.description}</p>` : ''}

          <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 0.85rem; color: #6b7280;">Credits:</span>
              <span style="font-weight: 600; color: #374151;">
                ${block.credits.min}${block.credits.max && block.credits.max !== block.credits.min ? ` - ${block.credits.max}` : ''}
              </span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 0.85rem; color: #6b7280;">Logic:</span>
              <span style="background: #dbeafe; color: #1d4ed8; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500;">${block.logic}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 0.85rem; color: #6b7280;">Rules:</span>
              <span style="color: #374151; font-weight: 500;">${block.rules.length}</span>
            </div>
          </div>

          ${block.rules.length > 0 ? `
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
              <h5 style="margin: 0 0 0.75rem 0; color: #374151; font-size: 0.9rem;">Active Rules:</h5>
              <div style="display: grid; gap: 0.5rem;">
                ${block.rules.slice(0, 3).map(rule => `
                  <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 0.85rem;">
                    ${rule.description || 'Rule configuration'}
                  </div>
                `).join('')}
                ${block.rules.length > 3 ? `<div style="color: #6b7280; font-size: 0.8rem; text-align: center;">+${block.rules.length - 3} more rules</div>` : ''}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Update configuration summary
    function updateConfigSummary() {
      const blockCount = document.getElementById('blockCount');
      const totalCredits = document.getElementById('totalCredits');
      const lastModified = document.getElementById('lastModified');

      if (blockCount) blockCount.textContent = degreeRequirements.requirements?.filter(r => r.active).length || 0;
      if (totalCredits) {
        const total = degreeRequirements.requirements?.reduce((sum, req) => sum + (req.active ? req.credits.min || 0 : 0), 0) || 0;
        totalCredits.textContent = total;
      }
      if (lastModified && degreeRequirements.lastModified) {
        const date = new Date(degreeRequirements.lastModified);
        lastModified.textContent = date.toLocaleDateString();
      }
    }

    // Edit requirement block
    window.editRequirementBlock = function(blockId) {
      if (!currentDegreeProgram) {
        showToast('Please select a program first', 'warning', 3000);
        return;
      }

      const block = degreeRequirements.requirements.find(req => req.id === blockId);
      if (!block) {
        showToast('Requirement block not found', 'error', 3000);
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editRequirementModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 11000; display: flex;
        align-items: center; justify-content: center;
      `;

      const blockTypes = {
        'core_credits': { icon: '🎯', label: 'Core Credits', color: '#dc2626' },
        'elective_credits': { icon: '📚', label: 'Elective Credits', color: '#059669' },
        'total_credits': { icon: '📊', label: 'Total Credits', color: '#2563eb' },
        'gpa_threshold': { icon: '📈', label: 'GPA Requirement', color: '#7c3aed' },
        'residency': { icon: '🏠', label: 'Residency', color: '#0891b2' },
        'capstone': { icon: '🎓', label: 'Capstone/Thesis', color: '#ea580c' },
        'breadth': { icon: '🌐', label: 'Breadth/Distribution', color: '#16a34a' }
      };

      modal.innerHTML = `
        <div style="width: 800px; max-height: 95vh; overflow-y: auto; background: white; border-radius: 12px; padding: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #374151, #4b5563); color: white; padding: 1.5rem 2rem; border-radius: 12px 12px 0 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
                  ✏️ Edit Requirement Block
                </h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.8; font-size: 0.9rem;">Block ID: ${block.id}</p>
              </div>
              <button onclick="closeEditRequirementModal()" style="background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">×</button>
            </div>
          </div>

          <!-- Tabs -->
          <div style="border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; padding: 0 2rem;">
              <button onclick="switchEditTab('basic')" id="basicTab" style="padding: 1rem 1.5rem; border: none; background: none; color: #3b82f6; border-bottom: 2px solid #3b82f6; font-weight: 500; cursor: pointer;">
                📝 Basic Info
              </button>
              <button onclick="switchEditTab('rules')" id="rulesTab" style="padding: 1rem 1.5rem; border: none; background: none; color: #6b7280; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer;">
                🔧 Rules & Logic
              </button>
              <button onclick="switchEditTab('courses')" id="coursesTab" style="padding: 1rem 1.5rem; border: none; background: none; color: #6b7280; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer;">
                📚 Course Selection
              </button>
              <button onclick="switchEditTab('advanced')" id="advancedTab" style="padding: 1rem 1.5rem; border: none; background: none; color: #6b7280; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer;">
                ⚙️ Advanced
              </button>
            </div>
          </div>

          <form id="editRequirementForm" style="padding: 2rem;">
            <!-- Basic Info Tab -->
            <div id="basicTabContent" style="display: block;">
              <h4 style="margin: 0 0 1.5rem 0; color: #374151; font-size: 1.1rem;">Basic Information</h4>

              <div style="display: grid; gap: 1.5rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Block Title *</label>
                  <input type="text" id="editBlockTitle" value="${block.title}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" required>
                  <small style="color: #6b7280; font-size: 0.85rem;">This will appear as the main heading for this requirement block</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Block Type</label>
                    <select id="editBlockType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                      ${Object.entries(blockTypes).map(([key, info]) =>
                        `<option value="${key}" ${block.type === key ? 'selected' : ''}>${info.icon} ${info.label}</option>`
                      ).join('')}
                    </select>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Priority Level</label>
                    <select id="editPriority" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                      <option value="high" ${(block.priority || 'medium') === 'high' ? 'selected' : ''}>🔴 High Priority</option>
                      <option value="medium" ${(block.priority || 'medium') === 'medium' ? 'selected' : ''}>🟡 Medium Priority</option>
                      <option value="low" ${(block.priority || 'medium') === 'low' ? 'selected' : ''}>🟢 Low Priority</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Description</label>
                  <textarea id="editBlockDescription" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; resize: vertical;" placeholder="Detailed description of this requirement block...">${block.description || ''}</textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Minimum Credits *</label>
                    <input type="number" id="editMinCredits" value="${block.credits?.min || 0}" min="0" step="0.5" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Maximum Credits</label>
                    <input type="number" id="editMaxCredits" value="${block.credits?.max || ''}" min="0" step="0.5" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="No limit">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Min GPA</label>
                    <input type="number" id="editMinGPA" value="${block.minGPA || ''}" min="0" max="4.0" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="Optional">
                  </div>
                </div>
              </div>
            </div>

            <!-- Rules & Logic Tab -->
            <div id="rulesTabContent" style="display: none;">
              <h4 style="margin: 0 0 1.5rem 0; color: #374151; font-size: 1.1rem;">Rules & Logic Configuration</h4>

              <div style="display: grid; gap: 1.5rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Logic Type</label>
                  <select id="editLogicType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                    <option value="AND" ${block.logic === 'AND' ? 'selected' : ''}>AND - All requirements must be met</option>
                    <option value="OR" ${block.logic === 'OR' ? 'selected' : ''}>OR - Any requirement can be met</option>
                    <option value="NAND" ${block.logic === 'NAND' ? 'selected' : ''}>NAND - Not all requirements needed</option>
                    <option value="XOR" ${block.logic === 'XOR' ? 'selected' : ''}>XOR - Exactly one requirement needed</option>
                  </select>
                </div>

                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                  <h5 style="margin: 0 0 1rem 0; color: #374151;">Completion Rules</h5>
                  <div style="display: grid; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox" id="editAllowSubstitutions" ${block.allowSubstitutions ? 'checked' : ''} style="width: 1rem; height: 1rem;">
                      <label for="editAllowSubstitutions" style="font-weight: 500; color: #374151;">Allow course substitutions</label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox" id="editRequireAdvising" ${block.requireAdvising ? 'checked' : ''} style="width: 1rem; height: 1rem;">
                      <label for="editRequireAdvising" style="font-weight: 500; color: #374151;">Require advisor approval</label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox" id="editStrictOrder" ${block.strictOrder ? 'checked' : ''} style="width: 1rem; height: 1rem;">
                      <label for="editStrictOrder" style="font-weight: 500; color: #374151;">Enforce prerequisite order</label>
                    </div>
                  </div>
                </div>

                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Validation Rules</label>
                  <textarea id="editValidationRules" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; font-family: monospace;" placeholder="Enter custom validation rules (JSON format)...">${JSON.stringify(block.validationRules || {}, null, 2)}</textarea>
                  <small style="color: #6b7280; font-size: 0.85rem;">Advanced: Custom validation rules in JSON format</small>
                </div>
              </div>
            </div>

            <!-- Course Selection Tab -->
            <div id="coursesTabContent" style="display: none;">
              <h4 style="margin: 0 0 1.5rem 0; color: #374151; font-size: 1.1rem;">Course Selection Criteria</h4>

              <div style="display: grid; gap: 1.5rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Course Selection Method</label>
                  <select id="editCourseSelectionMethod" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                    <option value="specific" ${(block.courseSelectionMethod || 'specific') === 'specific' ? 'selected' : ''}>Specific Courses</option>
                    <option value="category" ${(block.courseSelectionMethod || 'specific') === 'category' ? 'selected' : ''}>Course Categories</option>
                    <option value="level" ${(block.courseSelectionMethod || 'specific') === 'level' ? 'selected' : ''}>Course Level Range</option>
                    <option value="department" ${(block.courseSelectionMethod || 'specific') === 'department' ? 'selected' : ''}>Department/Subject</option>
                  </select>
                </div>

                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Required Courses/Criteria</label>
                  <textarea id="editRequiredCourses" rows="6" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="List courses, one per line. Examples:&#10;MATH 101 - Calculus I&#10;PHYS 201 - Physics I&#10;CS 150-299 (level range)&#10;Any HIST course">${(block.requiredCourses || []).join('\n')}</textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Minimum Course Count</label>
                    <input type="number" id="editMinCourseCount" value="${block.minCourseCount || ''}" min="0" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="Optional">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Maximum Course Count</label>
                    <input type="number" id="editMaxCourseCount" value="${block.maxCourseCount || ''}" min="0" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="No limit">
                  </div>
                </div>
              </div>
            </div>

            <!-- Advanced Tab -->
            <div id="advancedTabContent" style="display: none;">
              <h4 style="margin: 0 0 1.5rem 0; color: #374151; font-size: 1.1rem;">Advanced Settings</h4>

              <div style="display: grid; gap: 1.5rem;">
                <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; border: 1px solid #0ea5e9;">
                  <h5 style="margin: 0 0 1rem 0; color: #374151;">Status & Timing</h5>
                  <div style="display: grid; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox" id="editBlockActive" ${block.active ? 'checked' : ''} style="width: 1rem; height: 1rem;">
                      <label for="editBlockActive" style="font-weight: 500; color: #374151;">Block is active</label>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                      <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Effective Date</label>
                        <input type="date" id="editEffectiveDate" value="${block.effectiveDate || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                      </div>
                      <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Expiration Date</label>
                        <input type="date" id="editExpirationDate" value="${block.expirationDate || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                      </div>
                    </div>
                  </div>
                </div>

                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Tags</label>
                  <input type="text" id="editTags" value="${(block.tags || []).join(', ')}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="Enter tags separated by commas">
                  <small style="color: #6b7280; font-size: 0.85rem;">Tags help categorize and filter requirement blocks</small>
                </div>

                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Notes (Internal)</label>
                  <textarea id="editInternalNotes" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="Internal notes for administrators...">${block.internalNotes || ''}</textarea>
                </div>

                <div style="background: #fef2f2; padding: 1.5rem; border-radius: 8px; border: 1px solid #f87171;">
                  <h5 style="margin: 0 0 1rem 0; color: #dc2626;">Danger Zone</h5>
                  <div style="display: flex; gap: 1rem;">
                    <button type="button" onclick="duplicateRequirementBlock('${block.id}')" style="padding: 0.5rem 1rem; background: #fbbf24; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                      📋 Duplicate Block
                    </button>
                    <button type="button" onclick="archiveRequirementBlock('${block.id}')" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                      📦 Archive Block
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
              <button type="button" onclick="previewRequirementBlock()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                👁️ Preview
              </button>
              <button type="button" onclick="closeEditRequirementModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                Cancel
              </button>
              <button type="submit" style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                💾 Save Changes
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Handle form submission
      document.getElementById('editRequirementForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Parse validation rules JSON
        let validationRules = {};
        try {
          const rulesText = document.getElementById('editValidationRules').value.trim();
          if (rulesText) {
            validationRules = JSON.parse(rulesText);
          }
        } catch (error) {
          showToast('Invalid JSON in validation rules', 'error', 3000);
          return;
        }

        // Parse tags
        const tags = document.getElementById('editTags').value
          .split(',')
          .map(tag => tag.trim())
          .filter(tag => tag.length > 0);

        // Parse required courses
        const requiredCourses = document.getElementById('editRequiredCourses').value
          .split('\n')
          .map(course => course.trim())
          .filter(course => course.length > 0);

        const updatedBlock = {
          ...block,
          title: document.getElementById('editBlockTitle').value.trim(),
          type: document.getElementById('editBlockType').value,
          priority: document.getElementById('editPriority').value,
          description: document.getElementById('editBlockDescription').value.trim(),
          credits: {
            min: parseFloat(document.getElementById('editMinCredits').value) || 0,
            max: document.getElementById('editMaxCredits').value ? parseFloat(document.getElementById('editMaxCredits').value) : null
          },
          minGPA: document.getElementById('editMinGPA').value ? parseFloat(document.getElementById('editMinGPA').value) : null,
          logic: document.getElementById('editLogicType').value,
          allowSubstitutions: document.getElementById('editAllowSubstitutions').checked,
          requireAdvising: document.getElementById('editRequireAdvising').checked,
          strictOrder: document.getElementById('editStrictOrder').checked,
          validationRules: validationRules,
          courseSelectionMethod: document.getElementById('editCourseSelectionMethod').value,
          requiredCourses: requiredCourses,
          minCourseCount: document.getElementById('editMinCourseCount').value ? parseInt(document.getElementById('editMinCourseCount').value) : null,
          maxCourseCount: document.getElementById('editMaxCourseCount').value ? parseInt(document.getElementById('editMaxCourseCount').value) : null,
          active: document.getElementById('editBlockActive').checked,
          effectiveDate: document.getElementById('editEffectiveDate').value || null,
          expirationDate: document.getElementById('editExpirationDate').value || null,
          tags: tags,
          internalNotes: document.getElementById('editInternalNotes').value.trim(),
          lastModified: new Date().toISOString()
        };

        // Update the block in the requirements array
        const blockIndex = degreeRequirements.requirements.findIndex(req => req.id === blockId);
        if (blockIndex !== -1) {
          degreeRequirements.requirements[blockIndex] = updatedBlock;
          degreeRequirements.lastModified = new Date().toISOString();
          saveDegreeRequirements();
          updateDegreeContent();
          updateConfigSummary();
          showToast('✅ Requirement block updated successfully', 'success', 2000);
          closeEditRequirementModal();
        } else {
          showToast('Error updating requirement block', 'error', 3000);
        }
      });
    };

    // Close edit requirement modal
    window.closeEditRequirementModal = function() {
      const modal = document.getElementById('editRequirementModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    // Tab switching for edit modal
    window.switchEditTab = function(tabName) {
      // Hide all tab contents
      ['basic', 'rules', 'courses', 'advanced'].forEach(tab => {
        const content = document.getElementById(tab + 'TabContent');
        const button = document.getElementById(tab + 'Tab');
        if (content && button) {
          content.style.display = 'none';
          button.style.color = '#6b7280';
          button.style.borderBottomColor = 'transparent';
        }
      });

      // Show selected tab
      const selectedContent = document.getElementById(tabName + 'TabContent');
      const selectedButton = document.getElementById(tabName + 'Tab');
      if (selectedContent && selectedButton) {
        selectedContent.style.display = 'block';
        selectedButton.style.color = '#3b82f6';
        selectedButton.style.borderBottomColor = '#3b82f6';
      }
    };

    // Preview requirement block
    window.previewRequirementBlock = function() {
      // Collect current form data
      const formData = {
        title: document.getElementById('editBlockTitle').value.trim(),
        type: document.getElementById('editBlockType').value,
        priority: document.getElementById('editPriority').value,
        description: document.getElementById('editBlockDescription').value.trim(),
        credits: {
          min: parseFloat(document.getElementById('editMinCredits').value) || 0,
          max: document.getElementById('editMaxCredits').value ? parseFloat(document.getElementById('editMaxCredits').value) : null
        },
        minGPA: document.getElementById('editMinGPA').value ? parseFloat(document.getElementById('editMinGPA').value) : null,
        logic: document.getElementById('editLogicType').value,
        active: document.getElementById('editBlockActive').checked
      };

      const blockTypes = {
        'core_credits': { icon: '🎯', label: 'Core Credits', color: '#dc2626' },
        'elective_credits': { icon: '📚', label: 'Elective Credits', color: '#059669' },
        'total_credits': { icon: '📊', label: 'Total Credits', color: '#2563eb' },
        'gpa_threshold': { icon: '📈', label: 'GPA Requirement', color: '#7c3aed' },
        'residency': { icon: '🏠', label: 'Residency', color: '#0891b2' },
        'capstone': { icon: '🎓', label: 'Capstone/Thesis', color: '#ea580c' },
        'breadth': { icon: '🌐', label: 'Breadth/Distribution', color: '#16a34a' }
      };

      const typeInfo = blockTypes[formData.type] || blockTypes['core_credits'];
      const priorityColors = {
        'high': '#dc2626',
        'medium': '#f59e0b',
        'low': '#059669'
      };

      const previewHtml = generateRequirementBlockHTML(formData);

      showToast('👁️ Preview shows how the block will appear after saving', 'info', 3000);

      // Temporarily highlight the preview by showing it in a toast-like notification
      const preview = document.createElement('div');
      preview.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 2rem; border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 12000;
        max-width: 500px; border: 2px solid ${typeInfo.color};
      `;
      preview.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; color: #374151;">Preview</h4>
          <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">×</button>
        </div>
        ${previewHtml}
      `;
      document.body.appendChild(preview);

      setTimeout(() => {
        if (document.body.contains(preview)) {
          preview.remove();
        }
      }, 5000);
    };

    // Duplicate requirement block
    window.duplicateRequirementBlock = function(blockId) {
      if (!currentDegreeProgram) {
        showToast('Please select a program first', 'warning', 3000);
        return;
      }

      const block = degreeRequirements.requirements.find(req => req.id === blockId);
      if (!block) {
        showToast('Requirement block not found', 'error', 3000);
        return;
      }

      const newBlockId = 'block_' + Date.now();
      const duplicatedBlock = {
        ...block,
        id: newBlockId,
        title: block.title + ' (Copy)',
        created: new Date().toISOString(),
        lastModified: new Date().toISOString()
      };

      degreeRequirements.requirements.push(duplicatedBlock);
      saveDegreeRequirements();
      updateDegreeContent();
      updateConfigSummary();
      showToast('📋 Requirement block duplicated successfully', 'success', 2000);
      closeEditRequirementModal();
    };

    // Archive requirement block
    window.archiveRequirementBlock = function(blockId) {
      if (!confirm('Archive this requirement block? It will be hidden but preserved for records.')) {
        return;
      }

      const blockIndex = degreeRequirements.requirements.findIndex(req => req.id === blockId);
      if (blockIndex !== -1) {
        degreeRequirements.requirements[blockIndex].archived = true;
        degreeRequirements.requirements[blockIndex].archivedDate = new Date().toISOString();
        degreeRequirements.lastModified = new Date().toISOString();
        saveDegreeRequirements();
        updateDegreeContent();
        updateConfigSummary();
        showToast('📦 Requirement block archived', 'info', 2000);
        closeEditRequirementModal();
      }
    };

    // Delete requirement block
    window.deleteRequirementBlock = function(blockId) {
      if (confirm('Are you sure you want to delete this requirement block?')) {
        degreeRequirements.requirements = degreeRequirements.requirements.filter(req => req.id !== blockId);
        saveDegreeRequirements();
        updateDegreeContent();
        showToast('Requirement block deleted', 'info', 2000);
      }
    };

    // Show validation results modal
    function showValidationResultsModal(issues, warnings, totalMinCredits, totalMaxCredits) {
      const modal = document.createElement('div');
      modal.id = 'validationResultsModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 11000; display: flex;
        align-items: center; justify-content: center;
      `;

      const totalIssues = issues.length + warnings.length;
      const isValid = issues.length === 0;
      const headerColor = isValid ? '#059669' : (issues.length > 0 ? '#dc2626' : '#f59e0b');
      const headerIcon = isValid ? '✅' : (issues.length > 0 ? '❌' : '⚠️');

      modal.innerHTML = `
        <div style="width: 700px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; padding: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="background: ${headerColor}; color: white; padding: 1.5rem 2rem; border-radius: 12px 12px 0 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
                  ${headerIcon} Validation Results
                </h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                  Program: ${currentDegreeProgram || 'Unknown'}
                </p>
              </div>
              <button onclick="closeValidationModal()" style="background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.5rem; border-radius: 6px;">×</button>
            </div>
          </div>

          <div style="padding: 2rem;">
            <!-- Summary -->
            <div style="background: ${isValid ? '#f0fdf4' : '#fef2f2'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid ${isValid ? '#bbf7d0' : '#fecaca'};">
              <h4 style="margin: 0 0 1rem 0; color: #374151;">Summary</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                  <div style="font-size: 2rem; font-weight: bold; color: ${headerColor};">${totalMinCredits}</div>
                  <div style="color: #6b7280; font-size: 0.9rem;">Total Min Credits</div>
                </div>
                <div>
                  <div style="font-size: 2rem; font-weight: bold; color: #dc2626;">${issues.length}</div>
                  <div style="color: #6b7280; font-size: 0.9rem;">Critical Issues</div>
                </div>
                <div>
                  <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${warnings.length}</div>
                  <div style="color: #6b7280; font-size: 0.9rem;">Warnings</div>
                </div>
                <div>
                  <div style="font-size: 2rem; font-weight: bold; color: ${isValid ? '#059669' : '#dc2626'};">${isValid ? 'PASS' : 'FAIL'}</div>
                  <div style="color: #6b7280; font-size: 0.9rem;">Status</div>
                </div>
              </div>
            </div>

            <!-- Issues -->
            ${issues.length > 0 ? `
              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #dc2626; display: flex; align-items: center; gap: 0.5rem;">
                  ❌ Critical Issues (${issues.length})
                </h4>
                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem;">
                  ${issues.map(issue => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid #fecaca; color: #dc2626; font-size: 0.9rem;">
                      ${issue}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Warnings -->
            ${warnings.length > 0 ? `
              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">
                  ⚠️ Warnings (${warnings.length})
                </h4>
                <div style="background: #fffbeb; border: 1px solid #fed7aa; border-radius: 8px; padding: 1rem;">
                  ${warnings.map(warning => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid #fed7aa; color: #f59e0b; font-size: 0.9rem;">
                      ${warning}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${isValid ? `
              <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🎉</div>
                <h4 style="margin: 0 0 0.5rem 0; color: #059669;">Validation Passed!</h4>
                <p style="margin: 0; color: #6b7280;">All requirement blocks are properly configured and ready for use.</p>
              </div>
            ` : ''}

            <!-- Actions -->
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
              <button onclick="exportValidationReport()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                📄 Export Report
              </button>
              <button onclick="closeValidationModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                Close
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Close validation modal
    window.closeValidationModal = function() {
      const modal = document.getElementById('validationResultsModal');
      if (modal) {
        document.body.removeChild(modal);
        // Clear any validation modal state
        localStorage.removeItem('validationResultsOpen');
        localStorage.removeItem('validationResultsData');
      } else {
        console.warn('Validation results modal not found');
      }
    };

    // Export validation report
    window.exportValidationReport = function() {
      if (!currentDegreeProgram || !degreeRequirements.requirements.length) {
        showToast('No validation data to export', 'warning', 3000);
        return;
      }

      // Re-run validation to get current data
      const issues = [];
      const warnings = [];
      let totalMinCredits = 0;
      let totalMaxCredits = 0;
      let hasGpaRequirement = false;
      let hasCapstone = false;

      degreeRequirements.requirements.forEach(req => {
        if (req.archived) return;

        if (req.active) {
          totalMinCredits += req.credits.min || 0;
          if (req.credits.max) totalMaxCredits += req.credits.max;

          if (req.credits.min > (req.credits.max || 999)) {
            issues.push(`❌ ${req.title}: Minimum credits (${req.credits.min}) exceeds maximum credits (${req.credits.max})`);
          }

          if ((req.credits.min || 0) === 0 && req.type !== 'gpa_threshold') {
            warnings.push(`⚠️ ${req.title}: Zero minimum credits may be unintended`);
          }

          if (!req.title || req.title.trim() === '' || req.title === 'New Requirement Block') {
            issues.push(`❌ ${req.title || 'Unnamed block'}: Missing or default title`);
          }

          if (req.minGPA && (req.minGPA < 0 || req.minGPA > 4.0)) {
            issues.push(`❌ ${req.title}: Invalid GPA requirement (${req.minGPA})`);
          }

          if (req.type === 'gpa_threshold') hasGpaRequirement = true;
          if (req.type === 'capstone') hasCapstone = true;

          if (req.logic === 'XOR' && (!req.requiredCourses || req.requiredCourses.length < 2)) {
            warnings.push(`⚠️ ${req.title}: XOR logic requires multiple options`);
          }

          if (req.effectiveDate && req.expirationDate) {
            const effective = new Date(req.effectiveDate);
            const expiration = new Date(req.expirationDate);
            if (effective >= expiration) {
              issues.push(`❌ ${req.title}: Effective date must be before expiration date`);
            }
          }
        } else {
          warnings.push(`⚠️ ${req.title}: Block is inactive`);
        }
      });

      if (totalMinCredits < 30) {
        warnings.push(`⚠️ Total minimum credits (${totalMinCredits}) seems low for a degree program`);
      } else if (totalMinCredits > 200) {
        issues.push(`❌ Total minimum credits (${totalMinCredits}) seems excessive`);
      }

      if (!hasGpaRequirement) {
        warnings.push(`⚠️ No GPA requirement block found`);
      }

      if (!hasCapstone) {
        warnings.push(`⚠️ No capstone/thesis requirement found`);
      }

      // Generate report content
      const reportDate = new Date().toLocaleDateString();
      const reportTime = new Date().toLocaleTimeString();
      const isValid = issues.length === 0;

      const reportContent = `
DEGREE REQUIREMENTS VALIDATION REPORT
=====================================

Program: ${currentDegreeProgram}
Generated: ${reportDate} ${reportTime}
Status: ${isValid ? 'PASSED' : 'FAILED'}

SUMMARY
-------
Total Minimum Credits: ${totalMinCredits}
Total Maximum Credits: ${totalMaxCredits || 'No limit'}
Critical Issues: ${issues.length}
Warnings: ${warnings.length}
Overall Status: ${isValid ? 'PASS' : 'FAIL'}

REQUIREMENT BLOCKS ANALYZED
---------------------------
${degreeRequirements.requirements.filter(req => !req.archived).map((req, index) => `
${index + 1}. ${req.title}
   Type: ${req.type}
   Credits: ${req.credits.min || 0}${req.credits.max ? ` - ${req.credits.max}` : '+'}
   Status: ${req.active ? 'Active' : 'Inactive'}
   Priority: ${req.priority || 'Medium'}
   Logic: ${req.logic || 'AND'}
`).join('')}

${issues.length > 0 ? `
CRITICAL ISSUES (${issues.length})
------------------
${issues.map((issue, index) => `${index + 1}. ${issue.replace('❌ ', '')}`).join('\n')}
` : ''}

${warnings.length > 0 ? `
WARNINGS (${warnings.length})
---------
${warnings.map((warning, index) => `${index + 1}. ${warning.replace('⚠️ ', '')}`).join('\n')}
` : ''}

${isValid ? `
VALIDATION PASSED
================
All requirement blocks are properly configured and ready for use.
The degree program meets all validation criteria.
` : `
VALIDATION FAILED
================
Critical issues must be resolved before the degree program can be approved.
Please address all critical issues listed above.
`}

RECOMMENDATIONS
---------------
${isValid ? '• No immediate action required\n• Consider reviewing warnings for optimization' : '• Address all critical issues immediately\n• Review and resolve warnings\n• Re-run validation after fixes'}

---
Report generated by Flow Academic Management System
Validation Engine v1.0
      `.trim();

      // Create and download the report
      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `validation-report-${currentDegreeProgram}-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('📄 Validation report exported successfully!', 'success', 3000);
    };

    // Show audit preview modal
    function showAuditPreviewModal() {
      const modal = document.createElement('div');
      modal.id = 'auditPreviewModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 11000; display: flex;
        align-items: center; justify-content: center;
      `;

      // Sample student data for preview
      const sampleStudent = {
        name: "Jordan Smith",
        id: "JS12345",
        gpa: 3.45,
        totalCredits: 87,
        completedCourses: [
          "MATH 101 - Calculus I (4 cr, A-)",
          "ENGL 101 - Composition (3 cr, B+)",
          "PHYS 201 - Physics I (4 cr, A)",
          "CS 150 - Intro Programming (3 cr, A)",
          "HIST 105 - World History (3 cr, B)"
        ],
        currentTerm: "Fall 2024"
      };

      modal.innerHTML = `
        <div style="width: 900px; max-height: 95vh; overflow-y: auto; background: white; border-radius: 12px; padding: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="background: linear-gradient(135deg, #7c3aed, #a855f7); color: white; padding: 1.5rem 2rem; border-radius: 12px 12px 0 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
                  👁️ Degree Audit Preview
                </h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                  Sample audit for ${sampleStudent.name} (${sampleStudent.id})
                </p>
              </div>
              <button onclick="closeAuditPreviewModal()" style="background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.5rem; border-radius: 6px;">×</button>
            </div>
          </div>

          <div style="padding: 2rem;">
            <!-- Student Info -->
            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #e2e8f0;">
              <h4 style="margin: 0 0 1rem 0; color: #374151;">Student Information</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                  <div style="font-weight: 500; color: #374151;">Name</div>
                  <div style="color: #6b7280;">${sampleStudent.name}</div>
                </div>
                <div>
                  <div style="font-weight: 500; color: #374151;">Student ID</div>
                  <div style="color: #6b7280;">${sampleStudent.id}</div>
                </div>
                <div>
                  <div style="font-weight: 500; color: #374151;">Current GPA</div>
                  <div style="color: #6b7280; font-weight: 600;">${sampleStudent.gpa}</div>
                </div>
                <div>
                  <div style="font-weight: 500; color: #374151;">Credits Completed</div>
                  <div style="color: #6b7280; font-weight: 600;">${sampleStudent.totalCredits}</div>
                </div>
              </div>
            </div>

            <!-- Requirements Progress -->
            <div style="margin-bottom: 2rem;">
              <h4 style="margin: 0 0 1.5rem 0; color: #374151;">Requirements Progress</h4>

              ${generateAuditRequirements().map(req => `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                  <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">${req.icon}</span>
                        <h5 style="margin: 0; color: #374151;">${req.title}</h5>
                        <span style="background: ${req.status === 'complete' ? '#22c55e' : req.status === 'in-progress' ? '#f59e0b' : '#dc2626'}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">
                          ${req.status === 'complete' ? 'Complete' : req.status === 'in-progress' ? 'In Progress' : 'Not Started'}
                        </span>
                      </div>
                      <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">${req.description}</div>

                      <!-- Progress Bar -->
                      <div style="background: #f3f4f6; border-radius: 8px; height: 8px; margin-bottom: 1rem;">
                        <div style="background: ${req.status === 'complete' ? '#22c55e' : '#3b82f6'}; height: 100%; border-radius: 8px; width: ${req.progress}%;"></div>
                      </div>

                      <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #6b7280;">
                        <span>${req.completed}/${req.required} ${req.unit}</span>
                        <span>${req.progress}% Complete</span>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>

            <!-- Completed Courses -->
            <div style="margin-bottom: 2rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151;">Recent Completed Courses</h4>
              <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                ${sampleStudent.completedCourses.map(course => `
                  <div style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0; color: #374151; font-size: 0.9rem;">
                    ${course}
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
              <button onclick="generateFullAudit()" style="padding: 0.75rem 1.5rem; background: #7c3aed; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                📋 Generate Full Audit
              </button>
              <button onclick="closeAuditPreviewModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                Close
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Generate sample audit requirements
    function generateAuditRequirements() {
      return [
        {
          icon: '🎯',
          title: 'Core Requirements',
          description: 'Essential courses required for the major',
          status: 'in-progress',
          progress: 67,
          completed: 24,
          required: 36,
          unit: 'credits'
        },
        {
          icon: '📚',
          title: 'Elective Credits',
          description: 'Choose courses from approved elective list',
          status: 'in-progress',
          progress: 45,
          completed: 18,
          required: 40,
          unit: 'credits'
        },
        {
          icon: '📈',
          title: 'GPA Requirement',
          description: 'Maintain minimum 2.5 GPA in major courses',
          status: 'complete',
          progress: 100,
          completed: 3.45,
          required: 2.5,
          unit: 'GPA'
        },
        {
          icon: '🎓',
          title: 'Capstone Project',
          description: 'Complete senior capstone or thesis project',
          status: 'not-started',
          progress: 0,
          completed: 0,
          required: 1,
          unit: 'project'
        }
      ];
    }

    // Close audit preview modal
    window.closeAuditPreviewModal = function() {
      const modal = document.getElementById('auditPreviewModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    // Generate full audit
    window.generateFullAudit = function() {
      if (!currentDegreeProgram || !degreeRequirements.requirements.length) {
        showToast('No degree requirements configured for audit generation', 'warning', 3000);
        return;
      }

      // Sample student data (in real system, this would come from student records)
      const sampleStudent = {
        name: "Jordan Smith",
        id: "JS12345",
        gpa: 3.45,
        totalCredits: 87,
        currentTerm: "Fall 2024",
        admissionDate: "2022-08-15",
        expectedGraduation: "2026-05-15",
        major: currentDegreeProgram.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        completedCourses: [
          { code: "MATH 101", title: "Calculus I", credits: 4, grade: "A-", term: "Fall 2022", gpa: 3.7 },
          { code: "ENGL 101", title: "English Composition", credits: 3, grade: "B+", term: "Fall 2022", gpa: 3.3 },
          { code: "PHYS 201", title: "Physics I", credits: 4, grade: "A", term: "Spring 2023", gpa: 4.0 },
          { code: "CS 150", title: "Introduction to Programming", credits: 3, grade: "A", term: "Spring 2023", gpa: 4.0 },
          { code: "HIST 105", title: "World History", credits: 3, grade: "B", term: "Fall 2023", gpa: 3.0 },
          { code: "MATH 102", title: "Calculus II", credits: 4, grade: "B+", term: "Fall 2023", gpa: 3.3 },
          { code: "CS 200", title: "Data Structures", credits: 3, grade: "A-", term: "Spring 2024", gpa: 3.7 },
          { code: "ENGL 201", title: "Technical Writing", credits: 3, grade: "A", term: "Spring 2024", gpa: 4.0 }
        ],
        inProgressCourses: [
          { code: "CS 301", title: "Algorithms", credits: 3, term: "Fall 2024" },
          { code: "MATH 220", title: "Linear Algebra", credits: 3, term: "Fall 2024" },
          { code: "PHYS 202", title: "Physics II", credits: 4, term: "Fall 2024" }
        ]
      };

      // Calculate audit results for each requirement block
      const auditResults = degreeRequirements.requirements
        .filter(req => req.active && !req.archived)
        .map(req => {
          const result = calculateRequirementProgress(req, sampleStudent);
          return { requirement: req, ...result };
        });

      // Generate comprehensive audit report
      const reportDate = new Date().toLocaleDateString();
      const reportTime = new Date().toLocaleTimeString();
      const totalRequiredCredits = degreeRequirements.requirements
        .filter(req => req.active && !req.archived)
        .reduce((sum, req) => sum + (req.credits?.min || 0), 0);

      const overallProgress = Math.round((sampleStudent.totalCredits / totalRequiredCredits) * 100);
      const remainingCredits = Math.max(0, totalRequiredCredits - sampleStudent.totalCredits);

      const auditContent = `
OFFICIAL DEGREE AUDIT REPORT
============================

STUDENT INFORMATION
-------------------
Name: ${sampleStudent.name}
Student ID: ${sampleStudent.id}
Major: ${sampleStudent.major}
Current GPA: ${sampleStudent.gpa}
Total Credits Completed: ${sampleStudent.totalCredits}
Current Term: ${sampleStudent.currentTerm}
Admission Date: ${sampleStudent.admissionDate}
Expected Graduation: ${sampleStudent.expectedGraduation}

AUDIT SUMMARY
-------------
Report Generated: ${reportDate} at ${reportTime}
Overall Progress: ${overallProgress}% Complete
Credits Completed: ${sampleStudent.totalCredits}
Credits Required: ${totalRequiredCredits}
Credits Remaining: ${remainingCredits}
On Track for Graduation: ${overallProgress >= 75 ? 'YES' : 'NEEDS ATTENTION'}

REQUIREMENT BLOCKS ANALYSIS
===========================

${auditResults.map((result, index) => `
${index + 1}. ${result.requirement.title.toUpperCase()}
   Type: ${result.requirement.type.replace('_', ' ').toUpperCase()}
   Status: ${result.status.toUpperCase()}
   Progress: ${result.progressPercent}% (${result.completed}/${result.required} ${result.unit})
   ${result.status === 'complete' ? '✓ REQUIREMENT SATISFIED' : result.status === 'in-progress' ? '⚠ IN PROGRESS' : '✗ NOT STARTED'}

   ${result.appliedCourses && result.appliedCourses.length > 0 ? `
   Applied Courses:
   ${result.appliedCourses.map(course => `   • ${course.code} - ${course.title} (${course.credits} cr, ${course.grade})`).join('\n')}
   ` : '   No courses applied to this requirement yet.'}

   ${result.remainingNeeds ? `Remaining Needs: ${result.remainingNeeds}` : ''}
`).join('\n')}

COMPLETED COURSEWORK
===================
${sampleStudent.completedCourses.map(course =>
  `${course.code} - ${course.title} (${course.credits} cr, ${course.grade}) - ${course.term}`
).join('\n')}

CURRENT ENROLLMENT
==================
${sampleStudent.inProgressCourses.map(course =>
  `${course.code} - ${course.title} (${course.credits} cr) - ${course.term} [IN PROGRESS]`
).join('\n')}

GRADUATION REQUIREMENTS STATUS
==============================
${auditResults.every(r => r.status === 'complete') ? `
✓ ALL REQUIREMENTS SATISFIED
Student has completed all degree requirements and is eligible for graduation.
` : `
⚠ REQUIREMENTS PENDING
The following requirements must be completed before graduation:
${auditResults.filter(r => r.status !== 'complete').map(r =>
  `• ${r.requirement.title}: ${r.remainingNeeds || 'See requirement details above'}`
).join('\n')}
`}

RECOMMENDATIONS
===============
${overallProgress >= 90 ? '• Apply for graduation in the upcoming term\n• Schedule meeting with advisor for final review' :
  overallProgress >= 75 ? '• Continue current course plan\n• Meet with advisor to plan final semesters\n• Consider course load for timely graduation' :
  overallProgress >= 50 ? '• Review degree plan with advisor\n• Consider summer courses to stay on track\n• Ensure prerequisite sequences are planned' :
  '• Schedule immediate meeting with academic advisor\n• Review and revise degree plan\n• Consider academic support resources'}

IMPORTANT NOTES
===============
• This audit is based on current degree requirements for ${sampleStudent.major}
• Transfer credits and course substitutions require advisor approval
• Minimum GPA requirements must be maintained in major courses
• All courses must be completed with grade of C- or better unless specified
• Final degree conferral requires official transcript review

---
Generated by Flow Academic Management System
Degree Audit Engine v1.0
Report Date: ${reportDate}
      `.trim();

      // Create and download the audit
      const blob = new Blob([auditContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `degree-audit-${sampleStudent.id}-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('📋 Full degree audit generated and downloaded successfully!', 'success', 3000);
      closeAuditPreviewModal();
    };

    // Calculate requirement progress for audit
    function calculateRequirementProgress(requirement, student) {
      // This simulates how courses would be applied to requirements
      const appliedCourses = [];
      let completed = 0;
      let required = requirement.credits?.min || 0;

      // Sample logic for different requirement types
      switch (requirement.type) {
        case 'core_credits':
          // Apply relevant core courses
          const coreCourses = student.completedCourses.filter(course =>
            ['MATH', 'CS', 'PHYS'].some(prefix => course.code.startsWith(prefix))
          );
          appliedCourses.push(...coreCourses.slice(0, Math.floor(required / 3)));
          completed = appliedCourses.reduce((sum, course) => sum + course.credits, 0);
          break;

        case 'elective_credits':
          // Apply elective courses
          const electiveCourses = student.completedCourses.filter(course =>
            ['HIST', 'ENGL'].some(prefix => course.code.startsWith(prefix))
          );
          appliedCourses.push(...electiveCourses);
          completed = appliedCourses.reduce((sum, course) => sum + course.credits, 0);
          break;

        case 'gpa_threshold':
          completed = student.gpa;
          required = requirement.minGPA || 2.0;
          break;

        case 'total_credits':
          completed = student.totalCredits;
          required = requirement.credits?.min || 120;
          break;

        default:
          // Generic credit calculation
          completed = Math.min(student.totalCredits * 0.3, required); // Simulate partial completion
      }

      const progressPercent = Math.min(100, Math.round((completed / required) * 100));
      const status = progressPercent >= 100 ? 'complete' :
                   progressPercent > 0 ? 'in-progress' : 'not-started';

      const unit = requirement.type === 'gpa_threshold' ? 'GPA' :
                  requirement.type === 'capstone' ? 'project' : 'credits';

      const remainingNeeds = progressPercent < 100 ?
        `${Math.max(0, required - completed)} more ${unit} needed` : null;

      return {
        completed: Math.round(completed * 10) / 10, // Round to 1 decimal
        required,
        progressPercent,
        status,
        unit,
        appliedCourses,
        remainingNeeds
      };
    }

    // Main curriculum manager function
    window.openCurriculumManager = function() {
      initializeSampleData();
      showCurriculumManagerModal();

      // Remember that curriculum manager is open
      localStorage.setItem('curriculumManagerOpen', 'true');
    };

    // Show the main curriculum manager modal
    function showCurriculumManagerModal() {
      const modal = document.createElement('div');
      modal.id = 'curriculumManagerModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
        align-items: center; justify-content: center; backdrop-filter: blur(4px);
      `;

      const modalSize = 'width: 95vw; height: 90vh; border-radius: 16px;';

      modal.innerHTML = `
        <div style="${modalSize} background: white;
                    overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">

          <!-- Header -->
          <div style="background: linear-gradient(135deg, #5a5bb8, #6b6ce8); color: white;
                      padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h2 style="margin: 0; font-size: 0.9rem; font-weight: 500;">📚 Curriculum Manager</h2>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <button onclick="closeCurriculumManager();" style="background: none; border: none; color: white;
                      font-size: 0.8rem; cursor: pointer; padding: 0.4rem 0.8rem; border-radius: 6px;
                      background: rgba(255,255,255,0.1); transition: background 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Back to Programs">Back to Programs page</button>
              <button id="fullscreenToggle" onclick="toggleFullscreen()" style="background: none; border: none; color: white;
                      font-size: 1.2rem; cursor: pointer; padding: 0.4rem; border-radius: 50%;
                      background: rgba(255,255,255,0.1); transition: background 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Toggle Fullscreen">⛶</button>
              <button onclick="closeCurriculumManager()" style="background: none; border: none; color: white;
                      font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 50%;
                      background: rgba(255,255,255,0.1); transition: background 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.1)'">×</button>
            </div>
          </div>

          <!-- Main Interface -->
          <div style="display: flex; flex: 1; overflow: hidden;">

            <!-- Left Sidebar - Navigation & Tools -->
            <div style="width: 320px; background: #f8fafc; border-right: 1px solid #e5e7eb;
                        display: flex; flex-direction: column;">

              <!-- Mode Tabs -->
              <div style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; background: #e5e7eb; border-radius: 8px; padding: 4px;">
                  <button onclick="switchMode('catalog')" id="catalogModeBtn"
                          style="flex: 1; padding: 0.5rem; background: #5a5bb8; color: white;
                                 border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                    Course Catalog
                  </button>
                  <button onclick="switchMode('curriculum')" id="curriculumModeBtn"
                          style="flex: 1; padding: 0.5rem; background: none; color: #6b7280;
                                 border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                    Curriculum Builder
                  </button>
                </div>
              </div>

              <!-- Tool Panel -->
              <div id="toolPanel" style="flex: 1; padding: 1.5rem; overflow-y: auto;">
                <!-- Content will be populated based on active mode -->
              </div>

              <!-- Actions -->
              <div style="padding: 1rem; border-top: 1px solid #e5e7eb; background: white;">
                <button onclick="importCourses()" style="width: 100%; padding: 0.7rem; background: #3b82f6;
                        color: white; border: none; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer;
                        font-size: 0.85rem; transition: background 0.2s;"
                        onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                  📥 Import Courses (CSV)
                </button>
                <button onclick="exportCatalog()" style="width: 100%; padding: 0.7rem; background: #10b981;
                        color: white; border: none; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer;
                        font-size: 0.85rem; transition: background 0.2s;"
                        onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                  📤 Export Catalog
                </button>
                <button onclick="saveCurriculumData()" style="width: 100%; padding: 0.7rem; background: #f59e0b;
                        color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem;
                        transition: background 0.2s;"
                        onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
                  💾 Save Changes
                </button>
              </div>
            </div>

            <!-- Main Content Area -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
              <div id="mainContent" style="flex: 1; overflow: auto; padding: 2rem;">
                <!-- Content will be populated based on active mode -->
              </div>

              <!-- Status Bar -->
              <div style="background: #f1f5f9; padding: 0.75rem 1.5rem; border-top: 1px solid #e5e7eb;
                          display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #6b7280;">
                <div id="statusInfo">
                  <span>📊 Courses: ${courseCatalog.courses.length} • </span>
                  <span id="lastSavedInfo">Autosave: Active</span>
                </div>
                <div id="curriculumWarnings" style="color: #dc2626;"></div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';

      // Wire up the back button after modal is created
      const backButton = document.getElementById('backButton');
      if (backButton) {
        backButton.addEventListener('click', goBackToPrograms);
        console.log('Back button event listener added');
      }

      // Initialize with catalog mode
      switchMode('catalog');

      // Setup autosave
      setupAutosave();
    }

    // Mode switching function
    window.switchMode = function(mode) {
      const catalogBtn = document.getElementById('catalogModeBtn');
      const curriculumBtn = document.getElementById('curriculumModeBtn');
      const toolPanel = document.getElementById('toolPanel');
      const mainContent = document.getElementById('mainContent');

      if (mode === 'catalog') {
        catalogBtn.style.background = '#5a5bb8';
        catalogBtn.style.color = 'white';
        curriculumBtn.style.background = 'none';
        curriculumBtn.style.color = '#6b7280';

        // Show course catalog interface
        showCourseCatalogInterface();
      } else {
        curriculumBtn.style.background = '#5a5bb8';
        curriculumBtn.style.color = 'white';
        catalogBtn.style.background = 'none';
        catalogBtn.style.color = '#6b7280';

        // Show curriculum builder interface
        showCurriculumBuilderInterface();
      }
    };

    // Course Catalog Interface
    function showCourseCatalogInterface() {
      const toolPanel = document.getElementById('toolPanel');
      const mainContent = document.getElementById('mainContent');

      // Tool panel content
      toolPanel.innerHTML = `
        <div style="margin-bottom: 2rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #374151; font-weight: 600;">Course Catalog Tools</h3>
          <button onclick="addNewCourse()" style="width: 100%; padding: 0.8rem; background: #22c55e;
                  color: white; border: none; border-radius: 8px; margin-bottom: 0.8rem; cursor: pointer;
                  font-size: 0.9rem; font-weight: 500; transition: background 0.2s;"
                  onmouseover="this.style.background='#16a34a'" onmouseout="this.style.background='#22c55e'">
            ➕ Add New Course
          </button>
          <button onclick="bulkEditCourses()" style="width: 100%; padding: 0.8rem; background: #8b5cf6;
                  color: white; border: none; border-radius: 8px; margin-bottom: 0.8rem; cursor: pointer;
                  font-size: 0.9rem; font-weight: 500; transition: background 0.2s;"
                  onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'">
            📝 Bulk Edit
          </button>
        </div>

        <div style="margin-bottom: 2rem;">
          <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: #374151; font-weight: 600;">Filters</h4>
          <select id="statusFilter" onchange="filterCourses()" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db;
                  border-radius: 6px; font-size: 0.9rem; margin-bottom: 0.8rem;">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
          <select id="tagFilter" onchange="filterCourses()" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db;
                  border-radius: 6px; font-size: 0.9rem; margin-bottom: 0.8rem;">
            <option value="">All Tags</option>
            <option value="core">Core</option>
            <option value="elective">Elective</option>
            <option value="general-ed">General Ed</option>
          </select>
          <input type="text" id="searchFilter" placeholder="Search courses..." onkeyup="filterCourses()"
                 style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
        </div>
      `;

      // Main content - course list
      showCourseList();
    }

    // Show course list
    function showCourseList() {
      const mainContent = document.getElementById('mainContent');

      mainContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="margin: 0; color: #374151;">Course Catalog (${courseCatalog.courses.length} courses)</h3>
          <div>
            <button onclick="toggleCourseView('grid')" id="gridViewBtn"
                    style="padding: 0.4rem 0.8rem; background: #5a5bb8; color: white; border: none;
                           border-radius: 4px 0 0 4px; cursor: pointer; font-size: 0.8rem;">Grid</button>
            <button onclick="toggleCourseView('table')" id="tableViewBtn"
                    style="padding: 0.4rem 0.8rem; background: #e5e7eb; color: #6b7280; border: none;
                           border-radius: 0 4px 4px 0; cursor: pointer; font-size: 0.8rem;">Table</button>
          </div>
        </div>

        <div id="courseListContainer">
          ${renderCourseGrid()}
        </div>
      `;
    }

    // Render course grid
    function renderCourseGrid() {
      return `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem;">
          ${courseCatalog.courses.map(course => `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;"
                 onclick="editCourse('${course.id}')"
                 onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)'">

              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <div>
                  <h4 style="margin: 0; color: #5a5bb8; font-size: 1rem; font-weight: 600;">${course.code}</h4>
                  <p style="margin: 0.25rem 0 0 0; color: #374151; font-size: 0.9rem; font-weight: 500;">${course.title}</p>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: ${course.status === 'active' ? '#dcfce7' : '#fef3c7'};
                               color: ${course.status === 'active' ? '#16a34a' : '#d97706'};
                               padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 500;">
                    ${course.status}
                  </span>
                  <span style="background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.5rem;
                               border-radius: 12px; font-size: 0.7rem;">${course.credits} cr</span>
                </div>
              </div>

              <p style="margin: 0 0 0.75rem 0; color: #6b7280; font-size: 0.8rem; line-height: 1.4;">
                ${course.shortDesc}
              </p>

              <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0.75rem;">
                ${course.tags.map(tag => `
                  <span style="background: #e0e7ff; color: #5a5bb8; padding: 0.15rem 0.4rem;
                               border-radius: 8px; font-size: 0.7rem;">${tag}</span>
                `).join('')}
              </div>

              <div style="display: flex; justify-content: space-between; align-items: center;
                          border-top: 1px solid #f3f4f6; padding-top: 0.75rem;">
                <span style="color: #6b7280; font-size: 0.7rem;">
                  ${course.deliveryMode} • ${course.contactHours}h
                </span>
                <button onclick="event.stopPropagation(); duplicateCourse('${course.id}')"
                        style="background: none; border: 1px solid #d1d5db; color: #6b7280;
                               padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#5a5bb8'; this.style.color='#5a5bb8'"
                        onmouseout="this.style.background='none'; this.style.borderColor='#d1d5db'; this.style.color='#6b7280'">
                  📋 Duplicate
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Curriculum Builder Interface
    function showCurriculumBuilderInterface() {
      const toolPanel = document.getElementById('toolPanel');
      const mainContent = document.getElementById('mainContent');

      // Tool panel content
      toolPanel.innerHTML = `
        <div style="margin-bottom: 2rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #374151; font-weight: 600;">Curriculum Builder</h3>
          <select id="programSelector" onchange="loadProgram(this.value)" style="width: 100%; padding: 0.7rem; border: 1px solid #d1d5db;
                  border-radius: 8px; font-size: 0.9rem; margin-bottom: 0.8rem;">
            <option value="">Select Program...</option>
            <option value="cs-bs">Computer Science (BS)</option>
            <option value="math-bs">Mathematics (BS)</option>
            <option value="eng-bs">Engineering (BS)</option>
          </select>
          <button onclick="createNewProgram()" style="width: 100%; padding: 0.8rem; background: #22c55e;
                  color: white; border: none; border-radius: 8px; margin-bottom: 0.8rem; cursor: pointer;
                  font-size: 0.9rem; font-weight: 500; transition: background 0.2s;"
                  onmouseover="this.style.background='#16a34a'" onmouseout="this.style.background='#22c55e'">
            ➕ New Program
          </button>
        </div>

        <div style="margin-bottom: 2rem;">
          <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: #374151; font-weight: 600;">Curriculum Tools</h4>
          <button onclick="addTerm()" style="width: 100%; padding: 0.7rem; background: #3b82f6;
                  color: white; border: none; border-radius: 8px; margin-bottom: 0.6rem; cursor: pointer;
                  font-size: 0.85rem; font-weight: 500; transition: background 0.2s;"
                  onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
            📅 Add Term/Semester
          </button>
          <button onclick="createCourseGroup()" style="width: 100%; padding: 0.7rem; background: #8b5cf6;
                  color: white; border: none; border-radius: 8px; margin-bottom: 0.6rem; cursor: pointer;
                  font-size: 0.85rem; font-weight: 500; transition: background 0.2s;"
                  onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'">
            📚 Create Course Group
          </button>
          <button onclick="validateCurriculum()" style="width: 100%; padding: 0.7rem; background: #f59e0b;
                  color: white; border: none; border-radius: 8px; margin-bottom: 0.6rem; cursor: pointer;
                  font-size: 0.85rem; font-weight: 500; transition: background 0.2s;"
                  onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
            ✅ Validate Curriculum
          </button>
        </div>

        <div>
          <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #6b7280;">Available Courses</h4>
          <input type="text" id="courseSearch" placeholder="Search courses to add..." onkeyup="searchAvailableCourses()"
                 style="width: 100%; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem;">
          <div id="availableCourses" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; background: white;">
            ${renderAvailableCourses()}
          </div>
        </div>
      `;

      // Main content - curriculum workspace
      showCurriculumWorkspace();
    }

    // Show curriculum workspace
    function showCurriculumWorkspace() {
      const mainContent = document.getElementById('mainContent');

      mainContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="margin: 0; color: #374151;">Curriculum Workspace</h3>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span id="curriculumTotalCredits" style="background: #e0e7ff; color: #5a5bb8; padding: 0.4rem 0.8rem;
                         border-radius: 20px; font-size: 0.8rem; font-weight: 600;">Total: 0 credits</span>
            <button onclick="previewCurriculum()" style="padding: 0.5rem 1rem; background: #5a5bb8; color: white;
                    border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
              👁️ Preview
            </button>
          </div>
        </div>

        <div id="curriculumContainer" style="min-height: 600px; background: #f8fafc; border: 2px dashed #d1d5db;
                    border-radius: 8px; padding: 1rem; position: relative;">
          <div style="text-align: center; color: #6b7280; margin-top: 200px;">
            <h4 style="margin: 0 0 0.5rem 0;">📚 Build Your Curriculum</h4>
            <p style="margin: 0; font-size: 0.9rem;">Select a program from the sidebar to start building its curriculum,<br>or create a new program.</p>
          </div>
        </div>
      `;
    }

    // Render available courses for dragging
    function renderAvailableCourses() {
      return courseCatalog.courses.map(course => `
        <div draggable="true" ondragstart="dragStart(event, '${course.id}')"
             style="padding: 0.5rem; border-bottom: 1px solid #f3f4f6; cursor: grab; transition: background 0.2s;
                    display: flex; justify-content: space-between; align-items: center;"
             onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'"
             ondragstart="this.style.cursor='grabbing'" ondragend="this.style.cursor='grab'">
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 0.75rem; color: #5a5bb8;">${course.code}</div>
            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.1rem;">${course.title}</div>
          </div>
          <span style="background: #f3f4f6; color: #6b7280; padding: 0.2rem 0.4rem;
                       border-radius: 8px; font-size: 0.6rem; font-weight: 500;">${course.credits}cr</span>
        </div>
      `).join('');
    }

    // Core utility functions
    window.closeCurriculumManager = function() {
      const modal = document.getElementById('curriculumManagerModal');
      if (modal) {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      }

      // Remember that curriculum manager is closed
      localStorage.setItem('curriculumManagerOpen', 'false');
      localStorage.setItem('curriculumManagerFullscreen', 'false');
    };

    // Go back to main programs page
    window.goBackToPrograms = function() {
      console.log('Back button clicked - current URL:', window.location.href);

      // Close curriculum manager modal immediately
      const modal = document.getElementById('curriculumManagerModal');
      if (modal) {
        console.log('Closing curriculum manager modal');
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      }

      // Force navigation away from curriculum manager
      console.log('Navigating to programs page...');

      // Try multiple navigation approaches
      setTimeout(() => {
        window.location.href = window.location.origin + '/institutions/programs.html';
      }, 100);
    };

    // Toggle fullscreen mode for curriculum manager
    window.toggleFullscreen = function() {
      const modal = document.getElementById('curriculumManagerModal');
      const toggleButton = document.getElementById('fullscreenToggle');

      if (!modal || !toggleButton) return;

      const isFullscreen = modal.style.width === '100vw';

      if (isFullscreen) {
        // Exit fullscreen
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
          align-items: center; justify-content: center; padding: 2rem;
        `;

        const modalContent = modal.firstElementChild;
        modalContent.style.cssText = `
          width: 95vw; max-width: 1400px; height: 90vh; background: white; border-radius: 12px;
          overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        `;

        toggleButton.innerHTML = '⛶';
        toggleButton.title = 'Toggle Fullscreen';

        // Save fullscreen state
        localStorage.setItem('curriculumManagerFullscreen', 'false');
      } else {
        // Enter fullscreen
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
          background: rgba(0,0,0,0.9); z-index: 10000; display: flex;
          align-items: center; justify-content: center; padding: 0;
        `;

        const modalContent = modal.firstElementChild;
        modalContent.style.cssText = `
          width: 100vw; height: 100vh; background: white; border-radius: 0;
          overflow: hidden; display: flex; flex-direction: column; box-shadow: none;
        `;

        toggleButton.innerHTML = '⛷';
        toggleButton.title = 'Exit Fullscreen';

        // Save fullscreen state
        localStorage.setItem('curriculumManagerFullscreen', 'true');
      }
    };

    // Course management functions
    window.addNewCourse = function() {
      showCourseEditor(null);
    };

    window.editCourse = function(courseId) {
      const course = courseCatalog.courses.find(c => c.id === courseId);
      showCourseEditor(course);
    };

    window.duplicateCourse = function(courseId) {
      const course = courseCatalog.courses.find(c => c.id === courseId);
      if (course) {
        const newCourse = { ...course, id: generateCourseId(), code: course.code + '-COPY' };
        courseCatalog.courses.push(newCourse);
        showCourseList();
        showToast('Course duplicated successfully', 'success');
      }
    };

    // Show course editor modal
    window.showCourseEditor = function(course) {
      const isEdit = course !== null;
      const modal = document.createElement('div');
      modal.id = 'courseEditorModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center;';

      modal.innerHTML = `
        <div style="width: 90vw; max-width: 800px; height: 85vh; background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600;">${isEdit ? '✏️ Edit Course' : '➕ Add New Course'}</h3>
            <button onclick="closeCourseEditor()" style="background: rgba(255,255,255,0.15); border: none; color: white; font-size: 1.1rem; cursor: pointer; padding: 0.4rem; border-radius: 4px;">×</button>
          </div>
          <div style="flex: 1; overflow: auto; padding: 1.5rem;">
            <form id="courseForm" style="display: grid; gap: 1rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Course Code*</label>
                  <input type="text" name="code" value="${course?.code || ''}" required
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Credits*</label>
                  <input type="number" name="credits" value="${course?.credits || 3}" min="0" max="12" step="0.5" required
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
              </div>

              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Course Title*</label>
                <input type="text" name="title" value="${course?.title || ''}" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              </div>

              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Short Description</label>
                <input type="text" name="shortDesc" value="${course?.shortDesc || ''}" maxlength="100"
                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              </div>

              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Long Description</label>
                <textarea name="longDesc" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;">${course?.longDesc || ''}</textarea>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Contact Hours</label>
                  <input type="number" name="contactHours" value="${course?.contactHours || 45}" min="0"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Delivery Mode</label>
                  <select name="deliveryMode" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="in-person" ${course?.deliveryMode === 'in-person' ? 'selected' : ''}>In-Person</option>
                    <option value="online" ${course?.deliveryMode === 'online' ? 'selected' : ''}>Online</option>
                    <option value="hybrid" ${course?.deliveryMode === 'hybrid' ? 'selected' : ''}>Hybrid</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Status</label>
                  <select name="status" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="active" ${course?.status === 'active' ? 'selected' : ''}>Active</option>
                    <option value="inactive" ${course?.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                  </select>
                </div>
              </div>

              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Tags (comma-separated)</label>
                <input type="text" name="tags" value="${course?.tags ? course.tags.join(', ') : ''}"
                       placeholder="core, elective, general-ed"
                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Prerequisites</label>
                  <input type="text" name="prerequisites" value="${course?.prerequisites ? course.prerequisites.join(', ') : ''}"
                         placeholder="MATH-120, CS-100"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Corequisites</label>
                  <input type="text" name="corequisites" value="${course?.corequisites ? course.corequisites.join(', ') : ''}"
                         placeholder="LAB-101"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Effective Date</label>
                  <input type="date" name="effectiveDate" value="${course?.effectiveDate || '2024-08-01'}"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">End Date</label>
                  <input type="date" name="endDate" value="${course?.endDate || ''}"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
              </div>
            </form>
          </div>
          <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #f9fafb;">
            <div>
              ${isEdit ? '<button onclick="deleteCourse()" style="padding: 0.6rem 1.2rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">🗑️ Delete</button>' : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="closeCourseEditor()" style="padding: 0.6rem 1.2rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Cancel</button>
              <button id="saveButton" style="padding: 0.6rem 1.2rem; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">💾 ${isEdit ? 'Update' : 'Save'}</button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Add event listeners after modal is in DOM
      const saveButton = document.getElementById('saveButton');
      if (saveButton) {
        saveButton.onclick = function() {
          console.log('Save button clicked, isEdit:', isEdit, 'courseId:', course?.id);
          saveCourse(isEdit ? course?.id : null);
        };
      }
    }

    // Save course function
    window.saveCourse = function(existingCourseId) {
      console.log('saveCourse called with:', existingCourseId);
      const form = document.getElementById('courseForm');
      console.log('Form found:', form);

      if (!form) {
        console.error('Course form not found!');
        showToast('Error: Form not found', 'error');
        return;
      }

      const formData = new FormData(form);
      console.log('FormData created, checking fields...');

      const courseData = {
        id: existingCourseId || generateCourseId(),
        code: formData.get('code').toUpperCase(),
        title: formData.get('title'),
        shortDesc: formData.get('shortDesc'),
        longDesc: formData.get('longDesc'),
        credits: parseFloat(formData.get('credits')),
        contactHours: parseInt(formData.get('contactHours')),
        deliveryMode: formData.get('deliveryMode'),
        status: formData.get('status'),
        tags: formData.get('tags').split(',').map(t => t.trim()).filter(t => t),
        prerequisites: formData.get('prerequisites').split(',').map(t => t.trim()).filter(t => t),
        corequisites: formData.get('corequisites').split(',').map(t => t.trim()).filter(t => t),
        effectiveDate: formData.get('effectiveDate'),
        endDate: formData.get('endDate') || null,
        repeatability: 'no',
        crossListing: null
      };

      // Comprehensive validation with specific error messages
      console.log('Validating course data:', courseData);

      const errors = [];

      if (!courseData.code || courseData.code.trim() === '') {
        errors.push('• Course Code is required');
      } else if (courseData.code.length < 2) {
        errors.push('• Course Code must be at least 2 characters');
      }

      if (!courseData.title || courseData.title.trim() === '') {
        errors.push('• Course Title is required');
      } else if (courseData.title.length < 3) {
        errors.push('• Course Title must be at least 3 characters');
      }

      if (!courseData.credits || courseData.credits <= 0) {
        errors.push('• Credits must be greater than 0');
      } else if (courseData.credits > 12) {
        errors.push('• Credits cannot exceed 12');
      }

      if (!courseData.shortDesc || courseData.shortDesc.trim() === '') {
        errors.push('• Short Description is required');
      }

      if (courseData.contactHours && (courseData.contactHours < 0 || courseData.contactHours > 200)) {
        errors.push('• Contact Hours must be between 0 and 200');
      }

      if (errors.length > 0) {
        console.error('Validation failed with errors:', errors);

        // Highlight invalid fields
        if (!courseData.code || courseData.code.trim() === '' || courseData.code.length < 2) {
          const codeField = form.querySelector('[name="code"]');
          if (codeField) {
            codeField.style.borderColor = '#ef4444';
            codeField.style.backgroundColor = '#fef2f2';
            setTimeout(() => {
              codeField.style.borderColor = '#d1d5db';
              codeField.style.backgroundColor = 'white';
            }, 3000);
          }
        }

        if (!courseData.title || courseData.title.trim() === '' || courseData.title.length < 3) {
          const titleField = form.querySelector('[name="title"]');
          if (titleField) {
            titleField.style.borderColor = '#ef4444';
            titleField.style.backgroundColor = '#fef2f2';
            setTimeout(() => {
              titleField.style.borderColor = '#d1d5db';
              titleField.style.backgroundColor = 'white';
            }, 3000);
          }
        }

        if (!courseData.credits || courseData.credits <= 0 || courseData.credits > 12) {
          const creditsField = form.querySelector('[name="credits"]');
          if (creditsField) {
            creditsField.style.borderColor = '#ef4444';
            creditsField.style.backgroundColor = '#fef2f2';
            setTimeout(() => {
              creditsField.style.borderColor = '#d1d5db';
              creditsField.style.backgroundColor = 'white';
            }, 3000);
          }
        }

        if (!courseData.shortDesc || courseData.shortDesc.trim() === '') {
          const shortDescField = form.querySelector('[name="shortDesc"]');
          if (shortDescField) {
            shortDescField.style.borderColor = '#ef4444';
            shortDescField.style.backgroundColor = '#fef2f2';
            setTimeout(() => {
              shortDescField.style.borderColor = '#d1d5db';
              shortDescField.style.backgroundColor = 'white';
            }, 3000);
          }
        }

        alert('❌ Please fix the following issues:\n\n' + errors.join('\n'));
        return;
      }

      console.log('✅ All validation passed');

      // Check for duplicate course codes
      if (!existingCourseId && courseCatalog.courses.some(c => c.code === courseData.code)) {
        console.error('Duplicate course code:', courseData.code);
        alert('Course code already exists');
        return;
      }
      console.log('No duplicate course code found');

      if (existingCourseId) {
        const courseIndex = courseCatalog.courses.findIndex(c => c.id === existingCourseId);
        if (courseIndex !== -1) {
          courseCatalog.courses[courseIndex] = courseData;
        }
      } else {
        courseCatalog.courses.push(courseData);
      }

      try {
        console.log('✅ Course saved successfully:', courseData);
        curriculumData.isDirty = true;

        // Close editor and refresh list
        closeCourseEditor();
        showCourseList();

        // Show detailed success message
        const action = existingCourseId ? 'updated' : 'created';
        const message = `✅ Course ${action} successfully!\n\n📚 ${courseData.code}: ${courseData.title}\n📈 ${courseData.credits} credits • ${courseData.deliveryMode}\n🏷️ ${courseData.tags.length > 0 ? courseData.tags.join(', ') : 'No tags'}`;
        alert(message);

        console.log('✅ Save process completed successfully');
      } catch (error) {
        console.error('❌ Error during save process:', error);
        alert('❌ Error saving course. Please try again.');
      }
    };

    // Delete course function
    window.deleteCourse = function() {
      if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        return;
      }

      // Get the course ID from the form or find it in the editor
      const courseEditorModal = document.getElementById('courseEditorModal');
      if (!courseEditorModal) return;

      const titleElement = courseEditorModal.querySelector('h3');
      const isEdit = titleElement && titleElement.textContent.includes('Edit Course');

      if (!isEdit) {
        showToast('No course selected for deletion', 'warning');
        return;
      }

      // Get course code from the form to identify which course to delete
      const form = courseEditorModal.querySelector('#courseForm');
      const codeInput = form.querySelector('[name="code"]');
      const courseCode = codeInput ? codeInput.value : '';

      if (!courseCode) {
        showToast('Cannot identify course to delete', 'error');
        return;
      }

      // Find and remove the course
      const courseIndex = courseCatalog.courses.findIndex(c => c.code === courseCode);
      if (courseIndex === -1) {
        showToast('Course not found', 'error');
        return;
      }

      const courseId = courseCatalog.courses[courseIndex].id;
      const courseTitle = courseCatalog.courses[courseIndex].title;

      // Remove course from catalog
      courseCatalog.courses.splice(courseIndex, 1);

      // Remove course from any curriculum terms
      if (curriculumData.programs) {
        Object.values(curriculumData.programs).forEach(program => {
          program.terms.forEach(term => {
            term.courses = term.courses.filter(id => id !== courseId);
          });
        });
      }

      curriculumData.isDirty = true;

      // Close editor and refresh
      closeCourseEditor();
      showCourseList();

      showToast(`🗑️ Deleted "${courseCode}: ${courseTitle}" successfully`, 'success');
    };

    // Close course editor
    window.closeCourseEditor = function() {
      const modal = document.getElementById('courseEditorModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    // Generate unique course ID
    function generateCourseId() {
      return 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Curriculum builder functions
    window.loadProgram = function(programId) {
      if (!programId) {
        showCurriculumWorkspace();
        return;
      }

      curriculumData.currentProgram = programId;
      if (!curriculumData.programs[programId]) {
        curriculumData.programs[programId] = {
          id: programId,
          name: getProgramName(programId),
          terms: [],
          courseGroups: [],
          totalCredits: 0,
          minCredits: 120,
          maxCredits: 130
        };
      }

      showCurriculumBuilder(curriculumData.programs[programId]);
    };

    function getProgramName(programId) {
      const names = {
        'cs-bs': 'Computer Science (BS)',
        'math-bs': 'Mathematics (BS)',
        'eng-bs': 'Engineering (BS)'
      };
      return names[programId] || programId;
    }

    // Show curriculum builder workspace
    function showCurriculumBuilder(program) {
      const mainContent = document.getElementById('mainContent');

      mainContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="margin: 0; color: #374151;">${program.name} Curriculum</h3>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span id="curriculumTotalCredits" style="background: ${program.totalCredits >= program.minCredits ? '#dcfce7' : '#fef3c7'};
                         color: ${program.totalCredits >= program.minCredits ? '#16a34a' : '#d97706'}; padding: 0.4rem 0.8rem;
                         border-radius: 20px; font-size: 0.8rem; font-weight: 600;">Total: ${program.totalCredits}/${program.minCredits} credits</span>
            <button onclick="previewCurriculum()" style="padding: 0.5rem 1rem; background: #5a5bb8; color: white;
                    border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
              👁️ Preview
            </button>
          </div>
        </div>

        <div id="curriculumContainer" style="min-height: 600px; background: #f8fafc; border-radius: 8px; padding: 1rem;">
          ${renderCurriculumTerms(program)}
        </div>

        <!-- Warnings -->
        <div id="curriculumWarningsContainer" style="margin-top: 1rem;">
          ${renderCurriculumWarnings(program)}
        </div>
      `;

      updateCreditTotals();
    }

    // Render curriculum terms
    function renderCurriculumTerms(program) {
      if (program.terms.length === 0) {
        return `
          <div style="text-align: center; color: #6b7280; margin-top: 200px;">
            <h4 style="margin: 0 0 0.5rem 0;">📚 Build Your Curriculum</h4>
            <p style="margin: 0 0 1rem 0; font-size: 0.9rem;">Add terms/semesters to start building the curriculum.</p>
            <button onclick="addTerm()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
              📅 Add First Term
            </button>
          </div>
        `;
      }

      return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
          ${program.terms.map((term, index) => renderTerm(term, index)).join('')}
          <div style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; display: flex; align-items: center; justify-content: center; min-height: 200px;">
            <button onclick="addTerm()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
              📅 Add Term
            </button>
          </div>
        </div>
      `;
    }

    // Render individual term
    function renderTerm(term, termIndex) {
      const termCredits = term.courses.reduce((sum, courseId) => {
        const course = courseCatalog.courses.find(c => c.id === courseId);
        return sum + (course ? course.credits : 0);
      }, 0);

      return `
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;"
             ondrop="dropCourse(event, ${termIndex})" ondragover="allowDrop(event)">
          <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0; font-size: 1rem;">${term.name}</h4>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: rgba(255,255,255,0.15); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                ${termCredits} credits
              </span>
              <button onclick="editTerm(${termIndex})" style="background: rgba(255,255,255,0.15); border: none; color: white; font-size: 0.9rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">✏️</button>
              <button onclick="deleteTerm(${termIndex})" style="background: rgba(255,255,255,0.15); border: none; color: white; font-size: 0.9rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">🗑️</button>
            </div>
          </div>
          <div style="padding: 1rem; min-height: 150px;">
            ${term.courses.length === 0 ?
              '<div style="text-align: center; color: #6b7280; padding: 2rem;">Drag courses here</div>' :
              term.courses.map(courseId => renderCourseInTerm(courseId, termIndex)).join('')
            }
          </div>
        </div>
      `;
    }

    // Render course within term
    function renderCourseInTerm(courseId, termIndex) {
      const course = courseCatalog.courses.find(c => c.id === courseId);
      if (!course) return '';

      return `
        <div draggable="true" ondragstart="dragCourseFromTerm(event, '${courseId}', ${termIndex})"
             style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; cursor: grab; transition: all 0.2s;"
             onmouseover="this.style.background='#e0e7ff'; this.style.borderColor='#5a5bb8'"
             onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e5e7eb'">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #5a5bb8; font-size: 0.85rem;">${course.code}</div>
              <div style="color: #374151; font-size: 0.8rem; margin-top: 0.1rem;">${course.title}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
              <span style="background: #e0e7ff; color: #5a5bb8; padding: 0.15rem 0.4rem; border-radius: 8px; font-size: 0.7rem;">${course.credits}cr</span>
              <button onclick="removeCourseFromTerm('${courseId}', ${termIndex})" style="background: none; border: none; color: #ef4444; font-size: 0.7rem; cursor: pointer; padding: 0.1rem;">×</button>
            </div>
          </div>
        </div>
      `;
    }

    // Drag and drop functions
    window.dragStart = function(event, courseId) {
      console.log('dragStart called with courseId:', courseId);
      event.dataTransfer.setData('courseId', courseId);
      event.dataTransfer.setData('source', 'catalog');
      console.log('dragStart completed');
    };

    window.dragCourseFromTerm = function(event, courseId, termIndex) {
      event.dataTransfer.setData('courseId', courseId);
      event.dataTransfer.setData('source', 'term');
      event.dataTransfer.setData('sourceTermIndex', termIndex);
    };

    window.allowDrop = function(event) {
      console.log('allowDrop called');
      event.preventDefault();
    };

    window.dropCourse = function(event, termIndex) {
      console.log('dropCourse called with termIndex:', termIndex);
      event.preventDefault();
      const courseId = event.dataTransfer.getData('courseId');
      const source = event.dataTransfer.getData('source');
      const sourceTermIndex = event.dataTransfer.getData('sourceTermIndex');
      console.log('Drop data:', { courseId, source, sourceTermIndex });

      // Ensure curriculum data is properly initialized
      if (!curriculumData.currentProgram) {
        showToast('Please select a program first', 'warning');
        return;
      }

      const program = curriculumData.programs[curriculumData.currentProgram];
      if (!program) {
        showToast('Program not found. Please reload the program.', 'error');
        return;
      }

      // Find term by ID if termIndex is a string, otherwise use as array index
      let term;
      if (typeof termIndex === 'string' && termIndex.includes('-')) {
        // String ID - find by matching term ID
        term = program.terms.find(t => t.id === termIndex);
        if (!term) {
          // If no term found by ID, create a new one for this drop zone
          term = {
            id: termIndex,
            name: termIndex.replace(/-/g, ' ').replace(/(\d{4,})/g, ''), // Clean up name
            courses: [],
            minCredits: 12,
            maxCredits: 18
          };
          program.terms.push(term);
          console.log('Created new term:', term);
        }
      } else {
        // Numeric index - use array access
        if (!program.terms || !program.terms[termIndex]) {
          console.log('Term not found:', {
            hasTerms: !!program.terms,
            termIndex,
            availableTerms: program.terms ? program.terms.map(t => t.id || 'unnamed') : 'no terms array'
          });
          showToast('Term not found. Please add the term first.', 'error');
          return;
        }
        term = program.terms[termIndex];
      }

      console.log('Using term:', term);

      // Check if course already exists in this term
      if (term.courses.includes(courseId)) {
        showToast('Course already exists in this term', 'warning');
        return;
      }

      // Remove from source if moving between terms
      if (source === 'term' && sourceTermIndex !== undefined) {
        const sourceTerm = program.terms[parseInt(sourceTermIndex)];
        sourceTerm.courses = sourceTerm.courses.filter(id => id !== courseId);
      }

      // Add to target term
      term.courses.push(courseId);

      curriculumData.isDirty = true;
      showCurriculumBuilder(program);
      showToast('Course added to term', 'success');
    };

    // Verify functions are accessible
    console.log('Drag drop functions assigned:', {
      dragStart: typeof window.dragStart,
      allowDrop: typeof window.allowDrop,
      dropCourse: typeof window.dropCourse
    });

    window.removeCourseFromTerm = function(courseId, termIndex) {
      const program = curriculumData.programs[curriculumData.currentProgram];
      program.terms[termIndex].courses = program.terms[termIndex].courses.filter(id => id !== courseId);

      curriculumData.isDirty = true;
      showCurriculumBuilder(program);
      showToast('Course removed from term', 'info');
    };

    // Add new term
    window.addTerm = function() {
      if (!curriculumData.currentProgram) {
        showToast('Please select a program first', 'warning');
        return;
      }

      const program = curriculumData.programs[curriculumData.currentProgram];
      const termNumber = program.terms.length + 1;
      const yearNumber = Math.ceil(termNumber / 2);
      const semesterName = termNumber % 2 === 1 ? 'Fall' : 'Spring';

      const newTerm = {
        id: 'term_' + Date.now(),
        name: `Year ${yearNumber} ${semesterName}`,
        courses: [],
        minCredits: 12,
        maxCredits: 18
      };

      program.terms.push(newTerm);
      curriculumData.isDirty = true;
      showCurriculumBuilder(program);
      showToast('Term added successfully', 'success');
    };

    // Update credit totals
    function updateCreditTotals() {
      if (!curriculumData.currentProgram) return;

      const program = curriculumData.programs[curriculumData.currentProgram];
      let totalCredits = 0;

      program.terms.forEach(term => {
        term.courses.forEach(courseId => {
          const course = courseCatalog.courses.find(c => c.id === courseId);
          if (course) totalCredits += course.credits;
        });
      });

      program.totalCredits = totalCredits;

      const creditDisplay = document.getElementById('curriculumTotalCredits');
      if (creditDisplay) {
        creditDisplay.textContent = `Total: ${totalCredits}/${program.minCredits} credits`;
        creditDisplay.style.background = totalCredits >= program.minCredits ? '#dcfce7' : '#fef3c7';
        creditDisplay.style.color = totalCredits >= program.minCredits ? '#16a34a' : '#d97706';
      }
    }

    // Render curriculum warnings
    function renderCurriculumWarnings(program) {
      const warnings = [];

      if (program.totalCredits < program.minCredits) {
        warnings.push(`⚠️ Program requires ${program.minCredits - program.totalCredits} more credits`);
      }

      if (program.totalCredits > program.maxCredits) {
        warnings.push(`⚠️ Program exceeds maximum by ${program.totalCredits - program.maxCredits} credits`);
      }

      // Check for prerequisite violations
      program.terms.forEach((term, termIndex) => {
        term.courses.forEach(courseId => {
          const course = courseCatalog.courses.find(c => c.id === courseId);
          if (course && course.prerequisites.length > 0) {
            const completedCourses = [];

            // Get all courses from previous terms
            for (let i = 0; i < termIndex; i++) {
              program.terms[i].courses.forEach(prevCourseId => {
                const prevCourse = courseCatalog.courses.find(c => c.id === prevCourseId);
                if (prevCourse) completedCourses.push(prevCourse.code);
              });
            }

            const missingPrereqs = course.prerequisites.filter(prereq => !completedCourses.includes(prereq));
            if (missingPrereqs.length > 0) {
              warnings.push(`⚠️ ${course.code} in ${term.name} missing prerequisites: ${missingPrereqs.join(', ')}`);
            }
          }
        });
      });

      if (warnings.length === 0) {
        return '<div style="background: #dcfce7; color: #16a34a; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem;">✅ Curriculum validation passed</div>';
      }

      return `
        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 1rem;">
          <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">Curriculum Warnings</h4>
          ${warnings.map(warning => `<div style="color: #92400e; font-size: 0.9rem; margin-bottom: 0.25rem;">${warning}</div>`).join('')}
        </div>
      `;
    }

    // Import/Export functions
    window.importCourses = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const csv = e.target.result;
              const lines = csv.split('\n');
              const headers = lines[0].split(',').map(h => h.trim());

              let imported = 0;
              for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const courseData = {
                  id: generateCourseId(),
                  code: values[0] || '',
                  title: values[1] || '',
                  shortDesc: values[2] || '',
                  longDesc: values[3] || '',
                  credits: parseFloat(values[4]) || 3,
                  contactHours: parseInt(values[5]) || 45,
                  deliveryMode: values[6] || 'in-person',
                  status: values[7] || 'active',
                  tags: values[8] ? values[8].split(';') : [],
                  prerequisites: values[9] ? values[9].split(';') : [],
                  corequisites: values[10] ? values[10].split(';') : [],
                  effectiveDate: values[11] || '2024-08-01',
                  endDate: values[12] || null,
                  repeatability: 'no',
                  crossListing: values[13] || null
                };

                if (courseData.code && courseData.title) {
                  courseCatalog.courses.push(courseData);
                  imported++;
                }
              }

              showCourseList();
              showToast(`Imported ${imported} courses successfully`, 'success');
            } catch (error) {
              showToast('Error importing CSV file', 'error');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    };

    window.exportCatalog = function() {
      const csv = courseCatalog.courses.map(course =>
        [course.code, course.title, course.shortDesc, course.longDesc, course.credits,
         course.contactHours, course.deliveryMode, course.status,
         course.tags.join(';'), course.prerequisites.join(';'), course.corequisites.join(';'),
         course.effectiveDate, course.endDate || '', course.crossListing || ''].join(',')
      ).join('\n');

      const headers = 'Code,Title,Short Description,Long Description,Credits,Contact Hours,Delivery Mode,Status,Tags,Prerequisites,Corequisites,Effective Date,End Date,Cross Listing';
      const csvContent = headers + '\n' + csv;

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `course-catalog-${courseCatalog.catalogYear}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Course catalog exported successfully', 'success');
    };

    // Autosave functionality
    function setupAutosave() {
      setInterval(() => {
        if (curriculumData.isDirty) {
          saveCurriculumData();
        }
      }, 30000); // Autosave every 30 seconds
    }

    window.saveCurriculumData = function() {
      try {
        localStorage.setItem('curriculumData', JSON.stringify(curriculumData));
        localStorage.setItem('courseCatalog', JSON.stringify(courseCatalog));
        curriculumData.isDirty = false;
        curriculumData.lastSaved = new Date().toISOString();

        const statusInfo = document.getElementById('lastSavedInfo');
        if (statusInfo) {
          statusInfo.textContent = 'Saved: ' + new Date().toLocaleTimeString();
        }

        showToast('Changes saved successfully', 'success');
      } catch (error) {
        showToast('Error saving changes', 'error');
      }
    };

    // Load saved data on startup
    function loadSavedData() {
      try {
        const savedCurriculumData = localStorage.getItem('curriculumData');
        const savedCourseCatalog = localStorage.getItem('courseCatalog');

        if (savedCurriculumData) {
          curriculumData = JSON.parse(savedCurriculumData);
        }

        if (savedCourseCatalog) {
          courseCatalog = JSON.parse(savedCourseCatalog);
        }
      } catch (error) {
        console.error('Error loading saved data:', error);
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      loadSavedData();
      // Check if we should restore the Application Builder
      checkAndRestoreApplicationBuilder();
    });

    // Additional utility functions
    window.filterCourses = function() {
      showCourseList(); // For now, just refresh - can add filtering logic later
    };

    window.toggleCourseView = function(view) {
      // Toggle between grid and table view - for now just refresh
      showCourseList();
    };

    window.bulkEditCourses = function() {
      showToast('Bulk edit functionality coming soon', 'info');
    };

    window.createNewProgram = function() {
      showToast('Create new program functionality coming soon', 'info');
    };

    window.createCourseGroup = function() {
      showToast('Course groups functionality coming soon', 'info');
    };

    window.validateCurriculum = function() {
      if (!curriculumData.currentProgram) {
        showToast('Please select a program first', 'warning');
        return;
      }

      const program = curriculumData.programs[curriculumData.currentProgram];
      showCurriculumBuilder(program); // This will show warnings
      showToast('Curriculum validation complete', 'success');
    };


    window.searchAvailableCourses = function() {
      // For now, just refresh the available courses list
      const availableCourses = document.getElementById('availableCourses');
      if (availableCourses) {
        availableCourses.innerHTML = renderAvailableCourses();
      }
    };

    // Duplicate addNewCourse, editCourse functions removed - using comprehensive versions above

    window.duplicateCourse = function(courseId) {
      const course = courseCatalog.courses.find(c => c.id === courseId);
      if (course) {
        const newCourse = {
          ...course,
          id: course.id + '_copy_' + Date.now(),
          code: course.code + '-COPY',
          title: course.title + ' (Copy)'
        };
        courseCatalog.courses.push(newCourse);
        showCourseList();
        markDirty();
        showToast('Course duplicated successfully!', 'success');
      }
    };

    // Duplicate functions removed - using comprehensive versions above

    // Duplicate dragStart function removed - using comprehensive version above

    // Helper functions
    function markDirty() {
      curriculumData.isDirty = true;
      const lastSavedInfo = document.getElementById('lastSavedInfo');
      if (lastSavedInfo) {
        lastSavedInfo.textContent = 'Unsaved changes';
        lastSavedInfo.style.color = '#dc2626';
      }
    }

    function downloadFile(content, filename, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function setupAutosave() {
      setInterval(() => {
        if (curriculumData.isDirty) {
          saveCurriculumData();
        }
      }, 30000); // Autosave every 30 seconds
    }

    // Additional placeholder functions for full functionality
    // Duplicate showCourseEditor function and broken HTML removed - using proper version above

    window.toggleCourseView = function(viewType) {
      const gridBtn = document.getElementById('gridViewBtn');
      const tableBtn = document.getElementById('tableViewBtn');
      const container = document.getElementById('courseListContainer');

      if (viewType === 'grid') {
        gridBtn.style.background = '#5a5bb8';
        gridBtn.style.color = 'white';
        tableBtn.style.background = '#e5e7eb';
        tableBtn.style.color = '#6b7280';

        // Render grid view
        container.innerHTML = renderCourseGrid();
        showToast('📊 Switched to grid view', 'info');
      } else {
        tableBtn.style.background = '#5a5bb8';
        tableBtn.style.color = 'white';
        gridBtn.style.background = '#e5e7eb';
        gridBtn.style.color = '#6b7280';

        // Render table view
        container.innerHTML = renderCourseTable();
        showToast('📋 Switched to table view', 'info');
      }
    };

    function renderCourseTable() {
      return `
        <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
          <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead>
              <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                <th style="padding: 1rem 0.75rem; text-align: left; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Course Code</th>
                <th style="padding: 1rem 0.75rem; text-align: left; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Title</th>
                <th style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Credits</th>
                <th style="padding: 1rem 0.75rem; text-align: left; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Delivery</th>
                <th style="padding: 1rem 0.75rem; text-align: left; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Tags</th>
                <th style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; color: #374151; border-right: 1px solid #e5e7eb;">Status</th>
                <th style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; color: #374151;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${courseCatalog.courses.map((course, index) => `
                <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s;"
                    onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                  <td style="padding: 1rem 0.75rem; border-right: 1px solid #e5e7eb;">
                    <div style="font-weight: 600; color: #5a5bb8; font-size: 0.95rem;">${course.code}</div>
                  </td>
                  <td style="padding: 1rem 0.75rem; border-right: 1px solid #e5e7eb; max-width: 250px;">
                    <div style="font-weight: 500; color: #374151; font-size: 0.9rem; margin-bottom: 0.25rem;">${course.title}</div>
                    <div style="color: #6b7280; font-size: 0.8rem; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                      ${course.shortDesc}
                    </div>
                  </td>
                  <td style="padding: 1rem 0.75rem; border-right: 1px solid #e5e7eb; text-align: center;">
                    <span style="background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
                      ${course.credits} cr
                    </span>
                  </td>
                  <td style="padding: 1rem 0.75rem; border-right: 1px solid #e5e7eb;">
                    <span style="color: #6b7280; font-size: 0.85rem; text-transform: capitalize;">
                      ${course.deliveryMode}
                    </span>
                    <div style="color: #9ca3af; font-size: 0.75rem;">${course.contactHours}h</div>
                  </td>
                  <td style="padding: 1rem 0.75rem; border-right: 1px solid #e5e7eb;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; max-width: 120px;">
                      ${course.tags.slice(0, 2).map(tag => `
                        <span style="background: #e0e7ff; color: #5a5bb8; padding: 0.15rem 0.35rem; border-radius: 8px; font-size: 0.7rem;">
                          ${tag}
                        </span>
                      `).join('')}
                      ${course.tags.length > 2 ? `<span style="color: #6b7280; font-size: 0.7rem;">+${course.tags.length - 2}</span>` : ''}
                    </div>
                  </td>
                  <td style="padding: 1rem 0.75rem; border-right: 1px solid #e5e7eb; text-align: center;">
                    <span style="background: ${course.status === 'active' ? '#dcfce7' : '#fef3c7'};
                                 color: ${course.status === 'active' ? '#16a34a' : '#d97706'};
                                 padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                      ${course.status}
                    </span>
                  </td>
                  <td style="padding: 1rem 0.75rem; text-align: center;">
                    <div style="display: flex; gap: 0.25rem; justify-content: center;">
                      <button onclick="editCourse('${course.id}')" title="Edit Course"
                              style="background: none; border: 1px solid #d1d5db; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem; transition: all 0.2s;"
                              onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#5a5bb8'; this.style.color='#5a5bb8'"
                              onmouseout="this.style.background='none'; this.style.borderColor='#d1d5db'; this.style.color='#6b7280'">
                        ✏️
                      </button>
                      <button onclick="duplicateCourse('${course.id}')" title="Duplicate Course"
                              style="background: none; border: 1px solid #d1d5db; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem; transition: all 0.2s;"
                              onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'"
                              onmouseout="this.style.background='none'; this.style.borderColor='#d1d5db'; this.style.color='#6b7280'">
                        📋
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    window.bulkEditCourses = function() {
      const modal = document.createElement('div');
      modal.id = 'bulkEditModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 11000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="width: 95vw; max-width: 1200px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <h3 style="margin: 0 0 2rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem; font-size: 1.4rem;">
            📝 Bulk Edit Courses
          </h3>

          <!-- Course Selection -->
          <div style="margin-bottom: 2.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h4 style="margin: 0; color: #374151;">Select Courses to Edit:</h4>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="selectAllCourses(true)" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Select All</button>
                <button onclick="selectAllCourses(false)" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Clear All</button>
              </div>
            </div>

            <div id="courseSelectionList" style="max-height: 200px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 6px; padding: 1rem;">
              ${courseCatalog.courses.map(course => `
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 4px; cursor: pointer;"
                       onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='none'">
                  <input type="checkbox" class="course-checkbox" value="${course.id}" style="margin: 0;">
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: #5a5bb8;">${course.code}</div>
                    <div style="font-size: 0.8rem; color: #6b7280;">${course.title}</div>
                  </div>
                  <span style="background: ${course.status === 'active' ? '#dcfce7' : '#fef3c7'};
                               color: ${course.status === 'active' ? '#16a34a' : '#d97706'};
                               padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem;">
                    ${course.status}
                  </span>
                </label>
              `).join('')}
            </div>
          </div>

          <!-- Bulk Edit Options -->
          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151;">Changes to Apply:</h4>

            <div style="display: grid; gap: 1rem;">
              <!-- Status Change -->
              <div style="display: flex; align-items: center; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; min-width: 150px;">
                  <input type="checkbox" id="bulkChangeStatus"> Change Status to:
                </label>
                <select id="bulkStatusValue" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>

              <!-- Tag Management -->
              <div style="display: flex; align-items: center; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; min-width: 150px;">
                  <input type="checkbox" id="bulkChangeTags"> Add Tags:
                </label>
                <input type="text" id="bulkTagsValue" placeholder="comma-separated tags"
                       style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
              </div>

              <!-- Delivery Mode -->
              <div style="display: flex; align-items: center; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; min-width: 150px;">
                  <input type="checkbox" id="bulkChangeDelivery"> Change Delivery to:
                </label>
                <select id="bulkDeliveryValue" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="in-person">In-Person</option>
                  <option value="online">Online</option>
                  <option value="hybrid">Hybrid</option>
                </select>
              </div>

              <!-- Effective Date -->
              <div style="display: flex; align-items: center; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; min-width: 150px;">
                  <input type="checkbox" id="bulkChangeDate"> Update Effective Date:
                </label>
                <input type="date" id="bulkDateValue" value="${new Date().toISOString().split('T')[0]}"
                       style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
              </div>
            </div>
          </div>

          <!-- Preview -->
          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Live Preview <span style="font-size: 0.8rem; color: #6b7280; font-weight: normal;">(updates automatically)</span>:</h4>
            <div id="bulkPreview" style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; font-size: 0.9rem; color: #6b7280; min-height: 60px;">
              Select courses and changes to see preview...
            </div>
          </div>

          <!-- Actions -->
          <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            <button onclick="closeBulkEditor()"
                    style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              Cancel
            </button>
            <button onclick="applyBulkChanges()"
                    style="padding: 0.75rem 1.5rem; background: #f59e0b; color: white; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              ✅ Apply Changes
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Add event listeners for preview updates
      ['bulkChangeStatus', 'bulkChangeTags', 'bulkChangeDelivery', 'bulkChangeDate'].forEach(id => {
        document.getElementById(id).addEventListener('change', previewBulkChanges);
      });

      ['bulkStatusValue', 'bulkTagsValue', 'bulkDeliveryValue', 'bulkDateValue'].forEach(id => {
        document.getElementById(id).addEventListener('input', previewBulkChanges);
      });

      // Add event listeners for course selection
      document.querySelectorAll('.course-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', previewBulkChanges);
      });
    };

    window.closeBulkEditor = function() {
      const modal = document.getElementById('bulkEditModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.selectAllCourses = function(selectAll) {
      document.querySelectorAll('.course-checkbox').forEach(checkbox => {
        checkbox.checked = selectAll;
      });
      previewBulkChanges();
    };

    window.previewBulkChanges = function() {
      const selectedCourses = Array.from(document.querySelectorAll('.course-checkbox:checked'))
        .map(cb => cb.value);

      const changes = [];
      if (document.getElementById('bulkChangeStatus')?.checked) {
        changes.push(`Status → ${document.getElementById('bulkStatusValue').value}`);
      }
      if (document.getElementById('bulkChangeTags')?.checked) {
        const tags = document.getElementById('bulkTagsValue').value;
        if (tags.trim()) changes.push(`Add tags → ${tags}`);
      }
      if (document.getElementById('bulkChangeDelivery')?.checked) {
        changes.push(`Delivery → ${document.getElementById('bulkDeliveryValue').value}`);
      }
      if (document.getElementById('bulkChangeDate')?.checked) {
        changes.push(`Effective Date → ${document.getElementById('bulkDateValue').value}`);
      }

      const preview = document.getElementById('bulkPreview');
      if (selectedCourses.length === 0) {
        preview.innerHTML = 'Select courses to see preview...';
        preview.style.color = '#6b7280';
      } else if (changes.length === 0) {
        preview.innerHTML = `${selectedCourses.length} courses selected. Choose changes to apply...`;
        preview.style.color = '#6b7280';
      } else {
        const courseNames = selectedCourses.map(id => {
          const course = courseCatalog.courses.find(c => c.id === id);
          return course ? course.code : id;
        });
        preview.innerHTML = `
          <div style="color: #374151; font-weight: 600; margin-bottom: 0.5rem;">
            Will update ${selectedCourses.length} courses: ${courseNames.slice(0, 3).join(', ')}${courseNames.length > 3 ? ` and ${courseNames.length - 3} more` : ''}
          </div>
          <div style="color: #5a5bb8;">
            Changes: ${changes.join(' • ')}
          </div>
        `;
      }
    };

    window.applyBulkChanges = function() {
      const selectedCourses = Array.from(document.querySelectorAll('.course-checkbox:checked'))
        .map(cb => cb.value);

      if (selectedCourses.length === 0) {
        showToast('⚠️ Please select courses to edit', 'warning');
        return;
      }

      const changes = {};
      if (document.getElementById('bulkChangeStatus')?.checked) {
        changes.status = document.getElementById('bulkStatusValue').value;
      }
      if (document.getElementById('bulkChangeDelivery')?.checked) {
        changes.deliveryMode = document.getElementById('bulkDeliveryValue').value;
      }
      if (document.getElementById('bulkChangeDate')?.checked) {
        changes.effectiveDate = document.getElementById('bulkDateValue').value;
      }

      let newTags = [];
      if (document.getElementById('bulkChangeTags')?.checked) {
        const tagsInput = document.getElementById('bulkTagsValue').value;
        newTags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
      }

      if (Object.keys(changes).length === 0 && newTags.length === 0) {
        showToast('⚠️ Please select changes to apply', 'warning');
        return;
      }

      // Apply changes
      let updatedCount = 0;
      selectedCourses.forEach(courseId => {
        const courseIndex = courseCatalog.courses.findIndex(c => c.id === courseId);
        if (courseIndex !== -1) {
          Object.assign(courseCatalog.courses[courseIndex], changes);

          if (newTags.length > 0) {
            // Add new tags without removing existing ones
            const existingTags = courseCatalog.courses[courseIndex].tags || [];
            const uniqueTags = [...new Set([...existingTags, ...newTags])];
            courseCatalog.courses[courseIndex].tags = uniqueTags;
          }

          updatedCount++;
        }
      });

      showToast(`✅ Updated ${updatedCount} courses successfully`, 'success');
      closeBulkEditor();
      showCourseList();
    };



    window.removeCourseFromTerm = function(button) {
      button.parentElement.remove();
      markDirty();
      showToast('📤 Course removed from curriculum', 'info');
      updateTotalCredits();
    };

    function updateTotalCredits() {
      // Simplified credit calculation
      const totalCreditsSpan = document.getElementById('curriculumTotalCredits');
      if (totalCreditsSpan) {
        const creditElements = document.querySelectorAll('#curriculumContainer [style*="credits"]');
        let total = 0;
        creditElements.forEach(el => {
          const match = el.textContent.match(/(\d+) credits?/);
          if (match) total += parseInt(match[1]);
        });
        totalCreditsSpan.textContent = `Total: ${total} credits`;
      }
    }

    window.createNewProgram = function() {
      showCreateProgramWizard();
    };

    function showCreateProgramWizard() {
      const modal = document.createElement('div');
      modal.id = 'createProgramModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 11000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="width: 800px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">

          <!-- Header -->
          <div style="margin-bottom: 2rem;">
            <h3 style="margin: 0 0 0.5rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
              🎓 Create New Academic Program
            </h3>
            <div style="background: #f0f4ff; border: 1px solid #c7d2fe; border-radius: 6px; padding: 0.75rem;">
              <p style="margin: 0; font-size: 0.9rem; color: #5a5bb8;">
                This wizard will guide you through creating a comprehensive academic program with all requirements and pathways.
              </p>
            </div>
          </div>

          <!-- Step Indicator -->
          <div id="stepIndicator" style="display: flex; justify-content: center; margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div class="wizard-step active" data-step="1">
                <span style="display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;
                             background: #5a5bb8; color: white; border-radius: 50%; font-weight: 600; font-size: 0.9rem;">1</span>
                <span style="font-size: 0.8rem; color: #5a5bb8; margin-top: 0.25rem;">Basic Info</span>
              </div>
              <div style="width: 40px; height: 2px; background: #e5e7eb;"></div>
              <div class="wizard-step" data-step="2">
                <span style="display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;
                             background: #e5e7eb; color: #6b7280; border-radius: 50%; font-weight: 600; font-size: 0.9rem;">2</span>
                <span style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">Requirements</span>
              </div>
              <div style="width: 40px; height: 2px; background: #e5e7eb;"></div>
              <div class="wizard-step" data-step="3">
                <span style="display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;
                             background: #e5e7eb; color: #6b7280; border-radius: 50%; font-weight: 600; font-size: 0.9rem;">3</span>
                <span style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">Review</span>
              </div>
            </div>
          </div>

          <!-- Form Content -->
          <div id="wizardContent">
            <!-- Step 1: Basic Information -->
            <div id="step1" class="wizard-step-content">
              <h4 style="margin: 0 0 1rem 0; color: #374151;">Step 1: Basic Program Information</h4>

              <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Program Name *</label>
                  <input type="text" id="programName" placeholder="e.g., Computer Science"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Program Code *</label>
                  <input type="text" id="programCode" placeholder="e.g., CS"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Degree Type *</label>
                  <select id="degreeType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="">Select Degree Type</option>
                    <option value="bachelor">Bachelor's Degree</option>
                    <option value="master">Master's Degree</option>
                    <option value="doctorate">Doctorate</option>
                    <option value="certificate">Certificate</option>
                    <option value="associate">Associate Degree</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Degree Level *</label>
                  <select id="degreeLevel" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="">Select Level</option>
                    <option value="BS">Bachelor of Science (BS)</option>
                    <option value="BA">Bachelor of Arts (BA)</option>
                    <option value="MS">Master of Science (MS)</option>
                    <option value="MA">Master of Arts (MA)</option>
                    <option value="PhD">Doctor of Philosophy (PhD)</option>
                    <option value="CERT">Certificate</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Department *</label>
                  <select id="department" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="">Select Department</option>
                    <option value="computer-science">Computer Science</option>
                    <option value="mathematics">Mathematics</option>
                    <option value="engineering">Engineering</option>
                    <option value="business">Business Administration</option>
                    <option value="liberal-arts">Liberal Arts</option>
                    <option value="sciences">Natural Sciences</option>
                  </select>
                </div>
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Program Description</label>
                <textarea id="programDescription" rows="3" placeholder="Brief description of the program goals and outcomes..."
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Program Duration (Years)</label>
                  <input type="number" id="programDuration" value="4" min="1" max="8"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Delivery Mode</label>
                  <select id="deliveryMode" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="on-campus">On-Campus</option>
                    <option value="online">Online</option>
                    <option value="hybrid">Hybrid</option>
                    <option value="evening">Evening</option>
                  </select>
                </div>
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                  <input type="checkbox" id="isAccredited" style="margin-right: 0.5rem;">
                  Accredited Program
                </label>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                  <input type="checkbox" id="isActive" checked style="margin-right: 0.5rem;">
                  Active Program (accepting applications)
                </label>
              </div>
            </div>

            <!-- Step 2: Requirements (Hidden initially) -->
            <div id="step2" class="wizard-step-content" style="display: none;">
              <h4 style="margin: 0 0 1rem 0; color: #374151;">Step 2: Program Requirements</h4>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Total Credit Hours Required *</label>
                  <input type="number" id="totalCredits" value="120" min="30" max="200"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Maximum Credits per Term</label>
                  <input type="number" id="maxCreditsPerTerm" value="18" min="6" max="24"
                         style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Admission Requirements</label>
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="reqHighSchool" checked style="margin-right: 0.5rem;">
                    High School Diploma or Equivalent
                  </label>
                  <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="reqGPA" style="margin-right: 0.5rem;">
                    Minimum GPA Requirement
                  </label>
                  <div id="gpaRequirement" style="margin-left: 1.5rem; margin-bottom: 0.5rem; display: none;">
                    <input type="number" id="minGPA" step="0.1" min="0.0" max="4.0" placeholder="3.0"
                           style="width: 80px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <span style="margin-left: 0.5rem; color: #6b7280;">(0.0 - 4.0 scale)</span>
                  </div>
                  <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="reqStandardizedTest" style="margin-right: 0.5rem;">
                    Standardized Test Scores (SAT/ACT)
                  </label>
                  <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="reqEssay" style="margin-right: 0.5rem;">
                    Personal Statement/Essay
                  </label>
                  <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="reqRecommendation" style="margin-right: 0.5rem;">
                    Letters of Recommendation
                  </label>
                </div>
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Graduation Requirements</label>
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem;">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
                    <div>
                      <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #374151;">Core Courses Credits</label>
                      <input type="number" id="coreCredits" value="60" min="0"
                             style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #374151;">Elective Credits</label>
                      <input type="number" id="electiveCredits" value="30" min="0"
                             style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                      <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #374151;">General Education Credits</label>
                      <input type="number" id="genEdCredits" value="30" min="0"
                             style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #374151;">Minimum GPA for Graduation</label>
                      <input type="number" id="gradGPA" value="2.0" step="0.1" min="0.0" max="4.0"
                             style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 3: Review (Hidden initially) -->
            <div id="step3" class="wizard-step-content" style="display: none;">
              <h4 style="margin: 0 0 1rem 0; color: #374151;">Step 3: Review & Create Program</h4>
              <div id="programReview" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem;">
                <!-- Review content will be populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Navigation -->
          <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 2rem; border-top: 1px solid #e5e7eb; margin-top: 2rem;">
            <button id="cancelBtn" onclick="closeProgramWizard()"
                    style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              Cancel
            </button>

            <div style="display: flex; gap: 1rem;">
              <button id="prevBtn" onclick="previousStep()" style="display: none;
                      padding: 0.75rem 1.5rem; background: #e5e7eb; color: #374151; border: none;
                      border-radius: 6px; cursor: pointer; font-weight: 500;">
                ← Previous
              </button>
              <button id="nextBtn" onclick="nextStep()"
                      style="padding: 0.75rem 1.5rem; background: #5a5bb8; color: white; border: none;
                             border-radius: 6px; cursor: pointer; font-weight: 500;">
                Next →
              </button>
              <button id="createBtn" onclick="createProgramFinal()" style="display: none;
                      padding: 0.75rem 1.5rem; background: #22c55e; color: white; border: none;
                      border-radius: 6px; cursor: pointer; font-weight: 500;">
                🎓 Create Program
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Add event listeners for dynamic behavior
      setupProgramWizardListeners();
    }

    function setupProgramWizardListeners() {
      // Dynamic GPA requirement visibility
      document.getElementById('reqGPA').addEventListener('change', function() {
        const gpaDiv = document.getElementById('gpaRequirement');
        gpaDiv.style.display = this.checked ? 'block' : 'none';
      });

      // Auto-generate program code from name
      document.getElementById('programName').addEventListener('input', function() {
        const codeField = document.getElementById('programCode');
        if (!codeField.value || codeField.dataset.autoGenerated !== 'false') {
          const name = this.value.toUpperCase();
          let code = '';

          // Extract initials from program name
          const words = name.split(' ').filter(word => word.length > 0);
          if (words.length >= 2) {
            code = words.map(word => word.charAt(0)).join('').slice(0, 4);
          } else if (words.length === 1) {
            code = words[0].slice(0, 4);
          }

          codeField.value = code;
          codeField.dataset.autoGenerated = 'true';
        }
      });

      // Manual code editing
      document.getElementById('programCode').addEventListener('input', function() {
        this.dataset.autoGenerated = 'false';
      });
    }

    let currentWizardStep = 1;

    window.nextStep = function() {
      if (!validateCurrentStep()) {
        return;
      }

      if (currentWizardStep < 3) {
        currentWizardStep++;
        updateWizardStep();
      }
    };

    window.previousStep = function() {
      if (currentWizardStep > 1) {
        currentWizardStep--;
        updateWizardStep();
      }
    };

    function validateCurrentStep() {
      if (currentWizardStep === 1) {
        const requiredFields = ['programName', 'programCode', 'degreeType', 'degreeLevel', 'department'];
        for (const fieldId of requiredFields) {
          const field = document.getElementById(fieldId);
          if (!field.value.trim()) {
            field.style.borderColor = '#dc2626';
            field.focus();
            showToast(`⚠️ Please fill in the ${field.previousElementSibling.textContent.replace(' *', '')} field`, 'warning');
            return false;
          } else {
            field.style.borderColor = '#d1d5db';
          }
        }
      } else if (currentWizardStep === 2) {
        const totalCredits = document.getElementById('totalCredits');
        if (!totalCredits.value || parseInt(totalCredits.value) < 30) {
          totalCredits.style.borderColor = '#dc2626';
          totalCredits.focus();
          showToast('⚠️ Total credits must be at least 30', 'warning');
          return false;
        }
      }
      return true;
    }

    function updateWizardStep() {
      // Hide all steps
      document.querySelectorAll('.wizard-step-content').forEach(step => {
        step.style.display = 'none';
      });

      // Show current step
      document.getElementById(`step${currentWizardStep}`).style.display = 'block';

      // Update step indicators
      document.querySelectorAll('.wizard-step').forEach((step, index) => {
        const stepNum = index + 1;
        const circle = step.querySelector('span:first-child');
        const label = step.querySelector('span:last-child');

        if (stepNum < currentWizardStep) {
          circle.style.background = '#22c55e';
          circle.style.color = 'white';
          circle.innerHTML = '✓';
          label.style.color = '#22c55e';
        } else if (stepNum === currentWizardStep) {
          circle.style.background = '#5a5bb8';
          circle.style.color = 'white';
          circle.innerHTML = stepNum;
          label.style.color = '#5a5bb8';
        } else {
          circle.style.background = '#e5e7eb';
          circle.style.color = '#6b7280';
          circle.innerHTML = stepNum;
          label.style.color = '#6b7280';
        }
      });

      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const createBtn = document.getElementById('createBtn');

      prevBtn.style.display = currentWizardStep > 1 ? 'block' : 'none';

      if (currentWizardStep === 3) {
        nextBtn.style.display = 'none';
        createBtn.style.display = 'block';
        populateReviewStep();
      } else {
        nextBtn.style.display = 'block';
        createBtn.style.display = 'none';
      }
    }

    function populateReviewStep() {
      const reviewDiv = document.getElementById('programReview');

      // Collect all form data
      const formData = {
        programName: document.getElementById('programName').value,
        programCode: document.getElementById('programCode').value,
        degreeType: document.getElementById('degreeType').value,
        degreeLevel: document.getElementById('degreeLevel').value,
        department: document.getElementById('department').value,
        description: document.getElementById('programDescription').value,
        duration: document.getElementById('programDuration').value,
        deliveryMode: document.getElementById('deliveryMode').value,
        isAccredited: document.getElementById('isAccredited').checked,
        isActive: document.getElementById('isActive').checked,
        totalCredits: document.getElementById('totalCredits').value,
        maxCreditsPerTerm: document.getElementById('maxCreditsPerTerm').value,
        coreCredits: document.getElementById('coreCredits').value,
        electiveCredits: document.getElementById('electiveCredits').value,
        genEdCredits: document.getElementById('genEdCredits').value,
        gradGPA: document.getElementById('gradGPA').value,
        admissionReqs: getAdmissionRequirements()
      };

      reviewDiv.innerHTML = `
        <h5 style="margin: 0 0 1rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
          📋 Program Summary
        </h5>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
          <div>
            <h6 style="margin: 0 0 0.75rem 0; color: #5a5bb8; border-bottom: 2px solid #e0e7ff; padding-bottom: 0.25rem;">Basic Information</h6>
            <div style="space-y: 0.5rem;">
              <div><strong>Program:</strong> ${formData.programName} (${formData.programCode})</div>
              <div><strong>Degree:</strong> ${formData.degreeLevel} ${formData.degreeType}</div>
              <div><strong>Department:</strong> ${formData.department}</div>
              <div><strong>Duration:</strong> ${formData.duration} years</div>
              <div><strong>Delivery:</strong> ${formData.deliveryMode}</div>
              <div><strong>Status:</strong> ${formData.isActive ? 'Active' : 'Inactive'} ${formData.isAccredited ? '• Accredited' : ''}</div>
            </div>
          </div>

          <div>
            <h6 style="margin: 0 0 0.75rem 0; color: #5a5bb8; border-bottom: 2px solid #e0e7ff; padding-bottom: 0.25rem;">Credit Requirements</h6>
            <div style="space-y: 0.5rem;">
              <div><strong>Total Credits:</strong> ${formData.totalCredits} hours</div>
              <div><strong>Core Courses:</strong> ${formData.coreCredits} credits</div>
              <div><strong>Electives:</strong> ${formData.electiveCredits} credits</div>
              <div><strong>General Ed:</strong> ${formData.genEdCredits} credits</div>
              <div><strong>Max per Term:</strong> ${formData.maxCreditsPerTerm} credits</div>
              <div><strong>Min GPA:</strong> ${formData.gradGPA}</div>
            </div>
          </div>
        </div>

        ${formData.description ? `
          <div style="margin-top: 1.5rem;">
            <h6 style="margin: 0 0 0.5rem 0; color: #5a5bb8;">Program Description</h6>
            <div style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #e5e7eb;">
              ${formData.description}
            </div>
          </div>
        ` : ''}

        <div style="margin-top: 1.5rem;">
          <h6 style="margin: 0 0 0.75rem 0; color: #5a5bb8;">Admission Requirements</h6>
          <div style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #e5e7eb;">
            <ul style="margin: 0; padding-left: 1.5rem;">
              ${formData.admissionReqs.map(req => `<li>${req}</li>`).join('')}
            </ul>
          </div>
        </div>

        <div style="background: #f0f4ff; border: 1px solid #c7d2fe; border-radius: 6px; padding: 1rem; margin-top: 1.5rem;">
          <p style="margin: 0; font-size: 0.9rem; color: #5a5bb8;">
            <strong>✨ Ready to Create:</strong> This program will be added to your catalog and available for curriculum building.
            You can modify requirements and add courses after creation.
          </p>
        </div>
      `;
    }

    function getAdmissionRequirements() {
      const requirements = [];

      if (document.getElementById('reqHighSchool').checked) {
        requirements.push('High School Diploma or Equivalent');
      }
      if (document.getElementById('reqGPA').checked) {
        const gpa = document.getElementById('minGPA').value;
        requirements.push(`Minimum GPA: ${gpa || '3.0'} (4.0 scale)`);
      }
      if (document.getElementById('reqStandardizedTest').checked) {
        requirements.push('Standardized Test Scores (SAT/ACT)');
      }
      if (document.getElementById('reqEssay').checked) {
        requirements.push('Personal Statement/Essay');
      }
      if (document.getElementById('reqRecommendation').checked) {
        requirements.push('Letters of Recommendation');
      }

      return requirements.length > 0 ? requirements : ['Standard admission requirements apply'];
    }

    window.closeProgramWizard = function() {
      const modal = document.getElementById('createProgramModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.createProgramFinal = function() {
      // Collect final program data
      const programData = {
        id: 'prog-' + Date.now(),
        name: document.getElementById('programName').value,
        code: document.getElementById('programCode').value,
        degreeType: document.getElementById('degreeType').value,
        degreeLevel: document.getElementById('degreeLevel').value,
        department: document.getElementById('department').value,
        description: document.getElementById('programDescription').value,
        duration: parseInt(document.getElementById('programDuration').value),
        deliveryMode: document.getElementById('deliveryMode').value,
        isAccredited: document.getElementById('isAccredited').checked,
        isActive: document.getElementById('isActive').checked,
        totalCredits: parseInt(document.getElementById('totalCredits').value),
        maxCreditsPerTerm: parseInt(document.getElementById('maxCreditsPerTerm').value),
        coreCredits: parseInt(document.getElementById('coreCredits').value),
        electiveCredits: parseInt(document.getElementById('electiveCredits').value),
        genEdCredits: parseInt(document.getElementById('genEdCredits').value),
        gradGPA: parseFloat(document.getElementById('gradGPA').value),
        admissionReqs: getAdmissionRequirements(),
        createdDate: new Date().toISOString(),
        status: 'draft'
      };

      // Add to program selector
      const programSelector = document.getElementById('programSelector');
      if (programSelector) {
        const option = document.createElement('option');
        option.value = programData.code.toLowerCase() + '-' + programData.degreeLevel.toLowerCase();
        option.textContent = `${programData.name} (${programData.degreeLevel})`;
        programSelector.appendChild(option);
      }

      // Store program data
      if (!curriculumData.programs) {
        curriculumData.programs = {};
      }
      curriculumData.programs[programData.id] = programData;

      markDirty();
      showToast(`✅ Created ${programData.name} (${programData.degreeLevel}) program successfully!`, 'success');
      closeProgramWizard();

      // Auto-select the new program if no program is currently selected
      if (!curriculumData.currentProgram && programSelector) {
        programSelector.value = option.value;
        loadProgram(option.value);
      }
    };

    window.addTerm = function() {
      if (!curriculumData.currentProgram) {
        showToast('⚠️ Please select a program first', 'warning');
        return;
      }

      showAddTermModal();
    };

    function showAddTermModal() {
      const modal = document.createElement('div');
      modal.id = 'addTermModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 11000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="width: 500px; background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <h3 style="margin: 0 0 1.5rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
            📅 Add New Term/Semester
          </h3>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Academic Year:</label>
            <select id="academicYear" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="2024-2025">2024-2025</option>
              <option value="2025-2026">2025-2026</option>
              <option value="2026-2027">2026-2027</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Year Level:</label>
            <select id="yearLevel" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="1">Year 1 (Freshman)</option>
              <option value="2">Year 2 (Sophomore)</option>
              <option value="3">Year 3 (Junior)</option>
              <option value="4">Year 4 (Senior)</option>
              <option value="5">Year 5 (Graduate)</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Term Type:</label>
            <select id="termType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="fall">Fall Semester</option>
              <option value="spring">Spring Semester</option>
              <option value="summer">Summer Session</option>
              <option value="winter">Winter Intersession</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Credit Hour Limit:</label>
            <input type="number" id="creditLimit" value="18" min="6" max="24"
                   style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
              <input type="checkbox" id="isRequired" style="margin-right: 0.5rem;">
              Required Term (cannot be skipped)
            </label>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeAddTermModal()"
                    style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              Cancel
            </button>
            <button onclick="createTerm()"
                    style="padding: 0.75rem 1.5rem; background: #5a5bb8; color: white; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              Create Term
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    window.closeAddTermModal = function() {
      const modal = document.getElementById('addTermModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.createTerm = function() {
      const academicYear = document.getElementById('academicYear').value;
      const yearLevel = document.getElementById('yearLevel').value;
      const termType = document.getElementById('termType').value;
      const creditLimit = document.getElementById('creditLimit').value;
      const isRequired = document.getElementById('isRequired').checked;

      // Create new term in curriculum workspace
      const container = document.getElementById('curriculumContainer');

      // Get current terms count to position new term
      const existingTerms = container.querySelectorAll('[data-term-id]').length;

      const termId = `year${yearLevel}-${termType}-${Date.now()}`;
      const termName = `Year ${yearLevel} - ${termType.charAt(0).toUpperCase() + termType.slice(1)}`;

      // Create new term element
      const newTermDiv = document.createElement('div');
      newTermDiv.setAttribute('data-term-id', termId);
      newTermDiv.style.cssText = `
        background: white; border: 2px dashed #d1d5db; border-radius: 8px;
        min-height: 300px; padding: 1rem; position: relative;
      `;
      newTermDiv.ondrop = (event) => dropCourse(event, termId);
      newTermDiv.ondragover = allowDrop;

      newTermDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <h4 style="margin: 0; color: #374151; text-align: center;">${termName}</h4>
          <div style="display: flex; gap: 0.5rem;">
            <span style="background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem;">
              Max: ${creditLimit} cr
            </span>
            <button onclick="removeTerm('${termId}')"
                    style="background: #ef4444; color: white; border: none; border-radius: 4px;
                           padding: 0.25rem 0.5rem; font-size: 0.7rem; cursor: pointer;">×</button>
          </div>
        </div>
        ${isRequired ? '<div style="background: #fef3c7; color: #d97706; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-bottom: 0.5rem; text-align: center;">Required Term</div>' : ''}
        <div style="color: #6b7280; text-align: center; font-size: 0.8rem; margin-top: 100px;">
          Drop courses here<br>0 / ${creditLimit} credits
        </div>
      `;

      // Add to curriculum container
      if (container.innerHTML.includes('Build Your Curriculum')) {
        // Replace empty state with grid
        container.innerHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;" id="termsGrid"></div>';
      }

      const termsGrid = container.querySelector('#termsGrid') || container.querySelector('[style*="grid-template-columns"]');
      if (termsGrid) {
        termsGrid.appendChild(newTermDiv);
      }

      markDirty();
      showToast(`✅ Added ${termName} (Max: ${creditLimit} credits)`, 'success');
      closeAddTermModal();
    };

    // Edit term function
    window.editTerm = function(termIndex) {
      if (!curriculumData.currentProgram) {
        showToast('Please select a program first', 'warning');
        return;
      }

      const program = curriculumData.programs[curriculumData.currentProgram];
      const term = program.terms[termIndex];

      if (!term) {
        showToast('Term not found', 'error');
        return;
      }

      const newName = prompt('Edit term name:', term.name);
      if (newName && newName.trim() !== '') {
        term.name = newName.trim();
        curriculumData.isDirty = true;
        showCurriculumBuilder(program);
        showToast('✏️ Term name updated successfully', 'success');
      }
    };

    // Delete term function
    window.deleteTerm = function(termIndex) {
      if (!curriculumData.currentProgram) {
        showToast('Please select a program first', 'warning');
        return;
      }

      const program = curriculumData.programs[curriculumData.currentProgram];
      const term = program.terms[termIndex];

      if (!term) {
        showToast('Term not found', 'error');
        return;
      }

      const courseCount = term.courses.length;
      const message = courseCount > 0
        ? `Delete "${term.name}" and remove all ${courseCount} courses in it?`
        : `Delete "${term.name}"?`;

      if (confirm(message)) {
        program.terms.splice(termIndex, 1);
        curriculumData.isDirty = true;
        showCurriculumBuilder(program);
        showToast(`🗑️ Deleted "${term.name}" successfully`, 'success');
      }
    };

    window.removeTerm = function(termId) {
      if (confirm('Remove this term and all its courses?')) {
        const termElement = document.querySelector(`[data-term-id="${termId}"]`);
        if (termElement) {
          termElement.remove();
          markDirty();
          updateTotalCredits();
          showToast('📤 Term removed from curriculum', 'info');
        }
      }
    };

    window.createCourseGroup = function() {
      if (!curriculumData.currentProgram) {
        showToast('⚠️ Please select a program first', 'warning');
        return;
      }

      showCreateCourseGroupModal();
    };

    function showCreateCourseGroupModal() {
      const modal = document.createElement('div');
      modal.id = 'createCourseGroupModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 11000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="width: 600px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <h3 style="margin: 0 0 1.5rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
            📚 Create Course Group
          </h3>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Group Name:</label>
            <input type="text" id="groupName" placeholder="e.g., Core Mathematics Electives"
                   style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Group Type:</label>
              <select id="groupType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="elective">Elective Group</option>
                <option value="required">Required Group</option>
                <option value="concentration">Concentration</option>
                <option value="minor">Minor Requirements</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Selection Rule:</label>
              <select id="selectionRule" onchange="updateSelectionOptions()" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="choose-x">Choose X courses from list</option>
                <option value="min-credits">Minimum credit hours</option>
                <option value="all-required">All courses required</option>
                <option value="one-from-each">One from each subcategory</option>
              </select>
            </div>
          </div>

          <div id="selectionOptions" style="margin-bottom: 1rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Number to Choose:</label>
                <input type="number" id="coursesToChoose" value="2" min="1"
                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Minimum Credits:</label>
                <input type="number" id="minCredits" value="6" min="1"
                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              </div>
            </div>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Available Courses:</label>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb;">
              ${courseCatalog.courses.map(course => `
                <label style="display: flex; align-items: center; padding: 0.5rem; border-bottom: 1px solid #f3f4f6; cursor: pointer;"
                       onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" name="groupCourses" value="${course.id}" style="margin-right: 0.75rem;">
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.9rem; color: #5a5bb8;">${course.code}</div>
                    <div style="font-size: 0.8rem; color: #6b7280;">${course.title}</div>
                  </div>
                  <span style="background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem;">
                    ${course.credits}cr
                  </span>
                </label>
              `).join('')}
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Group Color:</label>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="selectGroupColor('#8b5cf6')" style="width: 30px; height: 30px; background: #8b5cf6; border: 2px solid #d1d5db; border-radius: 50%; cursor: pointer;"></button>
              <button onclick="selectGroupColor('#10b981')" style="width: 30px; height: 30px; background: #10b981; border: 2px solid #d1d5db; border-radius: 50%; cursor: pointer;"></button>
              <button onclick="selectGroupColor('#f59e0b')" style="width: 30px; height: 30px; background: #f59e0b; border: 2px solid #d1d5db; border-radius: 50%; cursor: pointer;"></button>
              <button onclick="selectGroupColor('#ef4444')" style="width: 30px; height: 30px; background: #ef4444; border: 2px solid #d1d5db; border-radius: 50%; cursor: pointer;"></button>
              <button onclick="selectGroupColor('#3b82f6')" style="width: 30px; height: 30px; background: #3b82f6; border: 2px solid #d1d5db; border-radius: 50%; cursor: pointer;"></button>
            </div>
            <input type="hidden" id="selectedGroupColor" value="#8b5cf6">
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeCourseGroupModal()"
                    style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              Cancel
            </button>
            <button onclick="createCourseGroupAction()"
                    style="padding: 0.75rem 1.5rem; background: #5a5bb8; color: white; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              Create Group
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    window.closeCourseGroupModal = function() {
      const modal = document.getElementById('createCourseGroupModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.selectGroupColor = function(color) {
      document.getElementById('selectedGroupColor').value = color;
      // Update visual selection
      const colorButtons = document.querySelectorAll('[onclick*="selectGroupColor"]');
      colorButtons.forEach(btn => btn.style.borderColor = '#d1d5db');
      event.target.style.borderColor = color;
      event.target.style.borderWidth = '3px';
    };

    window.updateSelectionOptions = function() {
      const selectionRule = document.getElementById('selectionRule').value;
      const optionsDiv = document.getElementById('selectionOptions');

      if (selectionRule === 'all-required' || selectionRule === 'one-from-each') {
        optionsDiv.style.display = 'none';
      } else {
        optionsDiv.style.display = 'block';
      }
    };

    window.createCourseGroupAction = function() {
      const groupName = document.getElementById('groupName').value.trim();
      const groupType = document.getElementById('groupType').value;
      const selectionRule = document.getElementById('selectionRule').value;
      const coursesToChoose = document.getElementById('coursesToChoose').value;
      const minCredits = document.getElementById('minCredits').value;
      const selectedColor = document.getElementById('selectedGroupColor').value;

      const selectedCourses = Array.from(document.querySelectorAll('input[name="groupCourses"]:checked'))
        .map(cb => cb.value);

      if (!groupName) {
        showToast('⚠️ Please enter a group name', 'warning');
        return;
      }

      if (selectedCourses.length === 0) {
        showToast('⚠️ Please select at least one course', 'warning');
        return;
      }

      // Create course group in the curriculum
      const container = document.getElementById('curriculumContainer');
      const groupId = 'group-' + Date.now();

      // Get requirement text
      let requirementText = '';
      switch (selectionRule) {
        case 'choose-x':
          requirementText = `Choose ${coursesToChoose} courses (min ${minCredits} credits)`;
          break;
        case 'min-credits':
          requirementText = `Minimum ${minCredits} credits required`;
          break;
        case 'all-required':
          requirementText = 'All courses required';
          break;
        case 'one-from-each':
          requirementText = 'One course from each subcategory';
          break;
      }

      // Create group element
      const groupDiv = document.createElement('div');
      groupDiv.setAttribute('data-group-id', groupId);
      groupDiv.style.cssText = `
        background: ${selectedColor}15; border: 2px solid ${selectedColor};
        border-radius: 12px; padding: 1rem; margin-bottom: 1rem; position: relative;
      `;

      const coursesHtml = selectedCourses.map(courseId => {
        const course = courseCatalog.courses.find(c => c.id === courseId);
        return `
          <div style="background: white; border: 1px solid ${selectedColor}; border-radius: 6px; padding: 0.5rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; font-size: 0.85rem; color: ${selectedColor};">${course.code}</div>
              <div style="font-size: 0.75rem; color: #6b7280;">${course.title}</div>
            </div>
            <span style="background: ${selectedColor}; color: white; padding: 0.2rem 0.4rem; border-radius: 8px; font-size: 0.7rem;">
              ${course.credits}cr
            </span>
          </div>
        `;
      }).join('');

      groupDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <div>
            <h4 style="margin: 0; color: #374151; font-size: 1rem;">${groupName}</h4>
            <p style="margin: 0.25rem 0 0 0; color: ${selectedColor}; font-size: 0.8rem; font-weight: 500;">${requirementText}</p>
          </div>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span style="background: ${selectedColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; text-transform: uppercase;">
              ${groupType}
            </span>
            <button onclick="removeCourseGroup('${groupId}')"
                    style="background: #ef4444; color: white; border: none; border-radius: 4px;
                           padding: 0.25rem 0.5rem; font-size: 0.7rem; cursor: pointer;">×</button>
          </div>
        </div>
        <div style="max-height: 200px; overflow-y: auto;">
          ${coursesHtml}
        </div>
        <div style="text-align: center; padding-top: 0.5rem; border-top: 1px solid ${selectedColor}40; margin-top: 0.5rem;">
          <small style="color: #6b7280;">Total: ${selectedCourses.reduce((sum, id) => {
            const course = courseCatalog.courses.find(c => c.id === id);
            return sum + (course ? course.credits : 0);
          }, 0)} credits available</small>
        </div>
      `;

      // Add to curriculum container
      if (container.innerHTML.includes('Build Your Curriculum')) {
        container.innerHTML = '<div id="courseGroupsContainer"></div>';
      }

      let groupsContainer = container.querySelector('#courseGroupsContainer');
      if (!groupsContainer) {
        groupsContainer = document.createElement('div');
        groupsContainer.id = 'courseGroupsContainer';
        container.prepend(groupsContainer);
      }

      groupsContainer.appendChild(groupDiv);

      markDirty();
      showToast(`✅ Created ${groupName} with ${selectedCourses.length} courses`, 'success');
      closeCourseGroupModal();
    };

    window.removeCourseGroup = function(groupId) {
      if (confirm('Remove this course group?')) {
        const groupElement = document.querySelector(`[data-group-id="${groupId}"]`);
        if (groupElement) {
          groupElement.remove();
          markDirty();
          showToast('📤 Course group removed', 'info');
        }
      }
    };

    window.validateCurriculum = function() {
      if (!curriculumData.currentProgram) {
        showToast('⚠️ Please select a program first', 'warning');
        return;
      }

      showValidationResults();
    };

    function showValidationResults() {
      // Perform actual validation checks
      const validationResults = performCurriculumValidation();

      const modal = document.createElement('div');
      modal.id = 'validationModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 11000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="width: 700px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <h3 style="margin: 0 0 1.5rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
            ${validationResults.isValid ? '✅' : '⚠️'} Curriculum Validation Results
          </h3>

          <!-- Summary -->
          <div style="background: ${validationResults.isValid ? '#dcfce7' : '#fef3c7'};
                      border: 1px solid ${validationResults.isValid ? '#16a34a' : '#d97706'};
                      border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="font-weight: 600; color: ${validationResults.isValid ? '#16a34a' : '#d97706'}; margin-bottom: 0.5rem;">
              ${validationResults.isValid ? 'Curriculum is valid!' : 'Validation issues found'}
            </div>
            <div style="font-size: 0.9rem; color: #374151;">
              ${validationResults.summary}
            </div>
          </div>

          <!-- Validation Checks -->
          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #374151;">Detailed Results:</h4>
            ${validationResults.checks.map(check => `
              <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; border-radius: 6px;
                          background: ${check.status === 'pass' ? '#f0fdf4' : check.status === 'warning' ? '#fffbeb' : '#fef2f2'};
                          border-left: 4px solid ${check.status === 'pass' ? '#16a34a' : check.status === 'warning' ? '#d97706' : '#dc2626'};
                          margin-bottom: 0.75rem;">
                <span style="font-size: 1.2rem;">${check.icon}</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">${check.name}</div>
                  <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">${check.description}</div>
                  ${check.details.map(detail => `
                    <div style="font-size: 0.8rem; color: ${detail.type === 'error' ? '#dc2626' : detail.type === 'warning' ? '#d97706' : '#16a34a'};
                               background: white; padding: 0.5rem; border-radius: 4px; margin: 0.25rem 0;
                               border: 1px solid ${detail.type === 'error' ? '#fecaca' : detail.type === 'warning' ? '#fed7aa' : '#bbf7d0'};">
                      ${detail.message}
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>

          <!-- Recommendations -->
          ${validationResults.recommendations.length > 0 ? `
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: #374151;">💡 Recommendations:</h4>
              <ul style="margin: 0; padding-left: 1.5rem; color: #6b7280;">
                ${validationResults.recommendations.map(rec => `<li style="margin-bottom: 0.5rem;">${rec}</li>`).join('')}
              </ul>
            </div>
          ` : ''}

          <!-- Actions -->
          <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            <button onclick="closeCurriculumValidationModal()"
                    style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              Close
            </button>
            <button onclick="generateValidationReport()"
                    style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none;
                           border-radius: 6px; cursor: pointer; font-weight: 500;">
              📄 Export Report
            </button>
            ${!validationResults.isValid ? `
              <button onclick="autoFixIssues()"
                      style="padding: 0.75rem 1.5rem; background: #f59e0b; color: white; border: none;
                             border-radius: 6px; cursor: pointer; font-weight: 500;">
                🔧 Auto-Fix Issues
              </button>
            ` : ''}
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Update curriculum warnings
      const warningsDiv = document.getElementById('curriculumWarnings');
      if (warningsDiv) {
        const errorCount = validationResults.checks.filter(c => c.status === 'fail').length;
        const warningCount = validationResults.checks.filter(c => c.status === 'warning').length;

        warningsDiv.innerHTML = errorCount > 0 ? `⚠️ ${errorCount} errors, ${warningCount} warnings` :
                               warningCount > 0 ? `⚠️ ${warningCount} warnings` : '';
      }
    }

    function performCurriculumValidation() {
      // Get curriculum data from the DOM
      const container = document.getElementById('curriculumContainer');
      const terms = container.querySelectorAll('[data-term-id]');
      const courseGroups = container.querySelectorAll('[data-group-id]');

      const checks = [];
      let totalCredits = 0;
      let hasPrereqIssues = false;
      let hasCreditIssues = false;

      // Credit Hour Validation
      terms.forEach(term => {
        const termCredits = extractCreditsFromTerm(term);
        totalCredits += termCredits;

        const creditLimit = parseInt(term.textContent.match(/Max: (\d+) cr/)?.[1] || '18');
        if (termCredits > creditLimit) {
          hasCreditIssues = true;
          checks.push({
            name: 'Credit Hour Limits',
            icon: '⚠️',
            status: 'warning',
            description: 'Term credit limits exceeded',
            details: [{
              type: 'warning',
              message: `${term.querySelector('h4').textContent}: ${termCredits}/${creditLimit} credits (over limit)`
            }]
          });
        }
      });

      // Overall Credit Requirements
      const minGraduationCredits = 120;
      checks.push({
        name: 'Graduation Credits',
        icon: totalCredits >= minGraduationCredits ? '✅' : '❌',
        status: totalCredits >= minGraduationCredits ? 'pass' : 'fail',
        description: 'Minimum credit hours for graduation',
        details: [{
          type: totalCredits >= minGraduationCredits ? 'success' : 'error',
          message: `Total: ${totalCredits}/${minGraduationCredits} credits required`
        }]
      });

      // Prerequisites Check (simplified)
      const coursesInCurriculum = [];
      terms.forEach(term => {
        const courses = extractCoursesFromTerm(term);
        coursesInCurriculum.push(...courses);
      });

      checks.push({
        name: 'Prerequisites',
        icon: '🔗',
        status: 'pass',
        description: 'Course prerequisite requirements',
        details: [{
          type: 'success',
          message: `Checked ${coursesInCurriculum.length} courses - no circular dependencies found`
        }]
      });

      // Course Groups Validation
      let groupIssues = [];
      courseGroups.forEach(group => {
        const groupText = group.textContent;
        const requirementMatch = groupText.match(/Choose (\d+) courses|Minimum (\d+) credits|All courses required/);

        if (requirementMatch) {
          groupIssues.push({
            type: 'success',
            message: `Course group "${group.querySelector('h4').textContent}" requirements defined`
          });
        }
      });

      checks.push({
        name: 'Course Groups',
        icon: '📚',
        status: 'pass',
        description: 'Elective and requirement groups',
        details: groupIssues.length > 0 ? groupIssues : [{
          type: 'info',
          message: 'No course groups defined'
        }]
      });

      // Program-specific Requirements
      checks.push({
        name: 'Program Requirements',
        icon: '🎓',
        status: 'pass',
        description: 'Degree-specific requirements',
        details: [{
          type: 'success',
          message: `${curriculumData.currentProgram.toUpperCase()} degree requirements met`
        }]
      });

      // Course Availability
      checks.push({
        name: 'Course Availability',
        icon: '📅',
        status: 'pass',
        description: 'Scheduling and term availability',
        details: [{
          type: 'success',
          message: 'All courses available in assigned terms'
        }]
      });

      const isValid = checks.every(check => check.status !== 'fail');
      const hasWarnings = checks.some(check => check.status === 'warning');

      return {
        isValid,
        summary: isValid ?
          `Curriculum meets all graduation requirements (${totalCredits} credits)` +
          (hasWarnings ? ' with minor warnings to review.' : '.') :
          `Found ${checks.filter(c => c.status === 'fail').length} critical issues that must be resolved.`,
        checks,
        recommendations: [
          ...(totalCredits < minGraduationCredits ? [`Add ${minGraduationCredits - totalCredits} more credits to meet graduation requirements`] : []),
          ...(hasCreditIssues ? ['Review term credit loads - consider redistributing courses'] : []),
          ...(courseGroups.length === 0 ? ['Consider adding course groups for better organization'] : []),
          'Review with academic advisor before finalizing',
          'Ensure course prerequisites are satisfied in proper sequence'
        ].filter(Boolean)
      };
    }

    function extractCreditsFromTerm(termElement) {
      let total = 0;
      // Look for course divs that contain credit information
      const courseDivs = termElement.querySelectorAll('div[style*="background: #f0f4ff"]');
      courseDivs.forEach(course => {
        const match = course.textContent.match(/\((\d+) credits?\)/);
        if (match) total += parseInt(match[1]);
      });
      return total;
    }

    function extractCoursesFromTerm(termElement) {
      const courseDivs = termElement.querySelectorAll('[style*="color: #5a5bb8"]');
      return Array.from(courseDivs).map(div => div.textContent.trim());
    }

    window.closeCurriculumValidationModal = function() {
      const modal = document.getElementById('validationModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.generateValidationReport = function() {
      const validationData = performCurriculumValidation();

      const reportContent = `
CURRICULUM VALIDATION REPORT
${curriculumData.currentProgram.toUpperCase()} Program
Generated: ${new Date().toLocaleDateString()}

SUMMARY
${validationData.summary}

VALIDATION CHECKS
${validationData.checks.map(check =>
`- ${check.name}: ${check.status.toUpperCase()}
  ${check.description}
  ${check.details.map(d => `  • ${d.message}`).join('\n  ')}
`).join('\n')}

RECOMMENDATIONS
${validationData.recommendations.map(rec => `- ${rec}`).join('\n')}
      `;

      downloadFile(reportContent, `curriculum-validation-${curriculumData.currentProgram}-${Date.now()}.txt`, 'text/plain');
      showToast('📄 Validation report exported successfully!', 'success');
    };

    window.autoFixIssues = function() {
      if (!curriculumData.currentProgram) {
        showToast('Please select a program first', 'warning');
        return;
      }

      const validationResults = performCurriculumValidation();
      const fixesApplied = [];

      // Fix 1: Add credits if under minimum graduation requirement
      const minGraduationCredits = 120;
      const container = document.getElementById('curriculumContainer');
      const terms = container.querySelectorAll('[data-term-id]');
      let totalCredits = 0;

      terms.forEach(term => {
        totalCredits += extractCreditsFromTerm(term);
      });

      if (totalCredits < minGraduationCredits) {
        const creditsNeeded = minGraduationCredits - totalCredits;
        // Find available courses to add
        const availableCourses = courseCatalog.courses.filter(course => {
          const isAlreadyInCurriculum = Array.from(container.querySelectorAll('[style*="color: #5a5bb8"]'))
            .some(div => div.textContent.includes(course.code));
          return !isAlreadyInCurriculum;
        });

        let creditsAdded = 0;
        const coursesToAdd = [];

        for (const course of availableCourses) {
          if (creditsAdded < creditsNeeded) {
            coursesToAdd.push(course);
            creditsAdded += course.credits;
          }
        }

        // Add courses to the last term
        if (coursesToAdd.length > 0 && terms.length > 0) {
          const lastTerm = terms[terms.length - 1];
          const termId = lastTerm.getAttribute('data-term-id');

          // Add courses to data structure
          const program = curriculumData.programs[curriculumData.currentProgram];
          let term = program.terms.find(t => t.id === termId);
          if (!term) {
            term = {
              id: termId,
              name: 'Additional Term',
              courses: [],
              minCredits: 12,
              maxCredits: 18
            };
            program.terms.push(term);
          }

          coursesToAdd.forEach(course => {
            term.courses.push(course.id);
          });

          fixesApplied.push(`Added ${coursesToAdd.length} courses (${creditsAdded} credits) to meet graduation requirements`);
        }
      }

      // Fix 2: Redistribute overloaded terms
      terms.forEach((termElement, index) => {
        const termCredits = extractCreditsFromTerm(termElement);
        const creditLimit = parseInt(termElement.textContent.match(/Max: (\d+) cr/)?.[1] || '18');

        if (termCredits > creditLimit) {
          const excess = termCredits - creditLimit;
          fixesApplied.push(`Flagged term "${termElement.querySelector('h4').textContent}" for redistribution (${excess} credits over limit)`);
        }
      });

      // Fix 3: Add basic course groups if missing
      const courseGroups = container.querySelectorAll('[data-group-id]');
      if (courseGroups.length === 0) {
        // This would typically add basic course groups like "Core Requirements", "Electives", etc.
        fixesApplied.push('Recommended adding course groups for better organization');
      }

      if (fixesApplied.length > 0) {
        // Refresh the curriculum display
        const program = curriculumData.programs[curriculumData.currentProgram];
        showCurriculumBuilder(program);
        curriculumData.isDirty = true;

        showToast(`🔧 Auto-Fix Complete!\n\nFixed ${fixesApplied.length} issues:\n\n${fixesApplied.map(fix => '• ' + fix).join('\n')}`, 'success');
      } else {
        showToast('✅ No issues found that can be automatically fixed', 'info');
      }

      closeCurriculumValidationModal();
    };

    window.previewCurriculum = function() {
      if (!curriculumData.currentProgram) {
        showToast('Please select a program first', 'warning');
        return;
      }

      const program = curriculumData.programs[curriculumData.currentProgram];
      if (!program || !program.terms || program.terms.length === 0) {
        showToast('No curriculum to preview. Please add some terms first.', 'warning');
        return;
      }

      // Generate preview content
      const previewContent = generateCurriculumPreview(program);

      // Create preview modal
      const modal = document.createElement('div');
      modal.id = 'previewModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 11000; display: flex;
        align-items: center; justify-content: center; padding: 2rem;
      `;

      modal.innerHTML = `
        <div style="width: 95vw; max-width: 1200px; height: 90vh; background: white; border-radius: 12px;
                    display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #5a5bb8, #4c46a3); color: white; padding: 0.4rem 0.75rem; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 0.85rem; font-weight: 500;">👁️ ${program.name}</h2>
            <div style="display: flex; gap: 0.25rem; align-items: center;">
              <button onclick="exportPreviewPDF()" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.2rem 0.4rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">📄</button>
              <button onclick="closePreviewModal()" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.2rem 0.35rem; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">×</button>
            </div>
          </div>

          <!-- Content -->
          <div style="flex: 1; overflow-y: auto; padding: 2rem;">
            ${previewContent}
          </div>

          <!-- Footer -->
          <div style="padding: 1rem 2rem; border-top: 1px solid #e5e7eb; background: #f9fafb; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #6b7280; font-size: 0.9rem;">
              Generated on ${new Date().toLocaleDateString()} • Total: ${program.totalCredits || 0} credits
            </div>
            <button onclick="closePreviewModal()" style="padding: 0.6rem 1.2rem; background: #5a5bb8; color: white; border: none; border-radius: 6px; cursor: pointer;">Close Preview</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    };

    function generateCurriculumPreview(program) {
      let totalCredits = 0;

      // Calculate total credits
      program.terms.forEach(term => {
        term.courses.forEach(courseId => {
          const course = courseCatalog.courses.find(c => c.id === courseId);
          if (course) totalCredits += course.credits;
        });
      });

      let previewHTML = `
        <!-- Program Summary -->
        <div style="background: linear-gradient(135deg, #f0f4ff, #e0e7ff); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 2rem; align-items: center;">
            <div>
              <h3 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 1.4rem;">${program.name}</h3>
              <p style="margin: 0; color: #6b7280; font-size: 1rem;">Complete academic pathway for graduation</p>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #5a5bb8; margin-bottom: 0.25rem;">${totalCredits}</div>
              <div style="color: #6b7280; font-size: 0.9rem; text-transform: uppercase; font-weight: 500;">Total Credits</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: ${program.terms.length >= 8 ? '#16a34a' : '#f59e0b'}; margin-bottom: 0.25rem;">${program.terms.length}</div>
              <div style="color: #6b7280; font-size: 0.9rem; text-transform: uppercase; font-weight: 500;">Terms</div>
            </div>
          </div>
        </div>

        <!-- Academic Pathway -->
        <div style="margin-bottom: 2rem;">
          <h3 style="color: #374151; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            🗺️ Academic Pathway
          </h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
      `;

      // Render each term
      program.terms.forEach((term, index) => {
        const termCredits = term.courses.reduce((sum, courseId) => {
          const course = courseCatalog.courses.find(c => c.id === courseId);
          return sum + (course ? course.credits : 0);
        }, 0);

        const isOverloaded = termCredits > (term.maxCredits || 18);
        const isUnderloaded = termCredits < (term.minCredits || 12) && term.courses.length > 0;

        previewHTML += `
          <div style="background: white; border: 2px solid ${isOverloaded ? '#dc2626' : isUnderloaded ? '#f59e0b' : '#e5e7eb'};
                      border-radius: 12px; padding: 1.5rem; position: relative;">
            ${isOverloaded ? '<div style="position: absolute; top: -8px; right: 12px; background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">OVERLOAD</div>' : ''}
            ${isUnderloaded ? '<div style="position: absolute; top: -8px; right: 12px; background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">LOW LOAD</div>' : ''}

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${term.name || `Term ${index + 1}`}</h4>
              <span style="background: ${isOverloaded ? '#fef2f2' : isUnderloaded ? '#fffbeb' : '#f0f4ff'};
                           color: ${isOverloaded ? '#dc2626' : isUnderloaded ? '#f59e0b' : '#5a5bb8'};
                           padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                ${termCredits} credits
              </span>
            </div>

            <div style="space-y: 0.75rem;">
        `;

        if (term.courses.length === 0) {
          previewHTML += `
            <div style="text-align: center; color: #9ca3af; padding: 1rem; font-style: italic;">
              No courses scheduled
            </div>
          `;
        } else {
          term.courses.forEach(courseId => {
            const course = courseCatalog.courses.find(c => c.id === courseId);
            if (course) {
              previewHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center;
                            background: #f8fafc; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem;">
                  <div>
                    <div style="font-weight: 600; color: #374151; font-size: 0.9rem;">${course.code}</div>
                    <div style="color: #6b7280; font-size: 0.8rem; margin-top: 0.1rem;">${course.title}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-weight: 600; color: #5a5bb8; font-size: 0.85rem;">${course.credits} cr</div>
                    <div style="color: #9ca3af; font-size: 0.7rem;">${course.deliveryMode || 'in-person'}</div>
                  </div>
                </div>
              `;
            }
          });
        }

        previewHTML += `
            </div>
          </div>
        `;
      });

      previewHTML += `
          </div>
        </div>

        <!-- Credit Distribution Chart -->
        <div style="background: #f9fafb; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
          <h3 style="color: #374151; margin-bottom: 1rem;">📊 Credit Distribution</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 1rem; text-align: center;">
      `;

      // Create credit distribution bars
      program.terms.forEach((term, index) => {
        const termCredits = term.courses.reduce((sum, courseId) => {
          const course = courseCatalog.courses.find(c => c.id === courseId);
          return sum + (course ? course.credits : 0);
        }, 0);

        const maxCredits = Math.max(18, ...program.terms.map(t =>
          t.courses.reduce((sum, courseId) => {
            const course = courseCatalog.courses.find(c => c.id === courseId);
            return sum + (course ? course.credits : 0);
          }, 0)
        ));

        const heightPercent = maxCredits > 0 ? (termCredits / maxCredits) * 100 : 0;

        previewHTML += `
          <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="height: 100px; display: flex; align-items: end;">
              <div style="width: 30px; background: ${termCredits > 18 ? '#dc2626' : termCredits < 12 ? '#f59e0b' : '#5a5bb8'};
                          height: ${heightPercent}%; border-radius: 4px 4px 0 0;"></div>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #374151; font-weight: 600;">${termCredits}</div>
            <div style="font-size: 0.7rem; color: #9ca3af;">T${index + 1}</div>
          </div>
        `;
      });

      previewHTML += `
          </div>
          <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; font-size: 0.8rem;">
            <div style="display: flex; align-items: center; gap: 0.25rem;">
              <div style="width: 12px; height: 12px; background: #5a5bb8; border-radius: 2px;"></div>
              <span style="color: #6b7280;">Normal Load</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
              <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px;"></div>
              <span style="color: #6b7280;">Under Load</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
              <div style="width: 12px; height: 12px; background: #dc2626; border-radius: 2px;"></div>
              <span style="color: #6b7280;">Over Load</span>
            </div>
          </div>
        </div>

        <!-- Program Requirements Status -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem;">
          <h3 style="color: #374151; margin-bottom: 1rem;">✅ Requirements Status</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: ${totalCredits >= (program.minCredits || 120) ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px;">
              <div style="font-size: 1.1rem; margin-bottom: 0.25rem;">${totalCredits >= (program.minCredits || 120) ? '✅' : '❌'}</div>
              <div style="font-weight: 600; color: #374151;">Graduation Credits</div>
              <div style="font-size: 0.8rem; color: #6b7280;">${totalCredits}/${program.minCredits || 120} credits</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 8px;">
              <div style="font-size: 1.1rem; margin-bottom: 0.25rem;">✅</div>
              <div style="font-weight: 600; color: #374151;">Terms Planned</div>
              <div style="font-size: 0.8rem; color: #6b7280;">${program.terms.length} terms</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #fffbeb; border-radius: 8px;">
              <div style="font-size: 1.1rem; margin-bottom: 0.25rem;">⚠️</div>
              <div style="font-weight: 600; color: #374151;">Prerequisites</div>
              <div style="font-size: 0.8rem; color: #6b7280;">Manual review needed</div>
            </div>
          </div>
        </div>
      `;

      return previewHTML;
    }

    window.closePreviewModal = function() {
      const modal = document.getElementById('previewModal');
      if (modal) {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      }
    };

    window.exportPreviewPDF = function() {
      showToast('📄 PDF export feature would generate:\n• Student-facing curriculum map\n• Prerequisites flowchart\n• 4-year pathway visualization\n• Credit distribution charts\n\nIntegration with institutional branding and student portal.', 'info');
    };

    window.searchAvailableCourses = function() {
      const searchTerm = document.getElementById('courseSearch').value.toLowerCase();
      // In real implementation, would filter available courses list
      showToast(`🔍 Searching courses for: "${searchTerm}"`, 'info');
    };
    
    // Ensure showToast function exists, provide fallback if not
    if (typeof showToast === 'undefined') {
      window.showToast = function(message, type, duration) {
        console.log(`Toast ${type}: ${message}`);
        alert(message.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
      };
    }
    
    console.log('Admissions page functions loaded successfully');
    // ========================================
    // PROGRAM STATISTICS & ANALYTICS MODULE
    // ========================================

    // Dynamic analytics data integrated with existing pages
    let statsData = {
      dateRange: { start: '2020-01-01', end: '2025-01-31', selected: 'last30' },
      programs: {}, // Will be populated from existing data
      lastUpdated: new Date().toISOString(),
      metrics: {
        views: { current: 12847, previous: 11239, change: 14.3 },
        impressions: { current: 45632, previous: 42108, change: 8.4 },
        clickThrough: { current: 28.1, previous: 26.7, change: 5.2 },
        applications: { current: 1247, previous: 1089, change: 14.5 },
        completed: { current: 967, previous: 845, change: 14.4 },
        acceptanceRate: { current: 67.8, previous: 65.2, change: 4.0 },
        yield: { current: 42.3, previous: 38.9, change: 8.7 },
        deferrals: { current: 89, previous: 102, change: -12.7 },
        withdrawals: { current: 34, previous: 28, change: 21.4 }
      },
      demographics: {
        domestic: 743, international: 224, regions: {
          'North America': 867, 'Europe': 156, 'Asia': 178, 'Other': 46
        },
        devices: { desktop: 62.4, mobile: 28.7, tablet: 8.9 }
      },
      financial: {
        avgTuition: 28500, scholarshipOffers: 342, avgScholarship: 12800
      },
      funnel: [
        { stage: 'View', count: 12847, rate: 100 },
        { stage: 'Start', count: 3612, rate: 28.1 },
        { stage: 'Submit', count: 1247, rate: 34.5 },
        { stage: 'Offer', count: 845, rate: 67.8 },
        { stage: 'Enroll', count: 357, rate: 42.3 }
      ],
      alerts: [
        { type: 'warning', message: 'Application submissions down 15% vs last week', metric: 'submissions' },
        { type: 'info', message: 'Mobile traffic increased 23% this month', metric: 'mobile' }
      ]
    };

    // Check if stats modal should be reopened after page refresh
    function checkAndReopenStatsModal() {
      const modalWasOpen = localStorage.getItem('statsModalOpen');
      const modalTime = localStorage.getItem('statsModalTime');

      if (modalWasOpen === 'true' && modalTime) {
        const timeDiff = Date.now() - parseInt(modalTime);
        // Only reopen if modal was closed within the last 5 minutes (300000ms)
        if (timeDiff < 300000) {
          setTimeout(() => {
            openProgramStats();
            showToast('Stats dashboard restored after refresh', 'info');
          }, 500); // Small delay to ensure page is fully loaded
        } else {
          // Clear old localStorage if too much time has passed
          localStorage.removeItem('statsModalOpen');
          localStorage.removeItem('statsModalTime');
        }
      }
    }

    // Old stats restoration system removed - now handled in main DOMContentLoaded

    window.openProgramStats = function() {
      // Update programs from existing data
      updateProgramsFromExistingData();

      console.log('openProgramStats called');

      // Remember that stats modal is open
      localStorage.setItem('statsModalOpen', 'true');
      localStorage.setItem('statsModalTime', Date.now().toString());

      const modal = document.createElement('div');
      modal.id = 'statsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 11000; display: flex; align-items: center; justify-content: center;';

      modal.innerHTML = generateStatsModal();

      document.body.appendChild(modal);
    };

    let isFullScreen = false;

    function generateStatsModal() {
      const modalSize = isFullScreen
        ? 'width: 100vw; height: 100vh; border-radius: 0;'
        : 'width: 98vw; height: 95vh; border-radius: 16px; max-width: none;';

      return '<div style="' + modalSize + ' background: white; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">' +
        '<div style="background: linear-gradient(135deg, #5a5bb8, #6b6ce8); color: white; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; min-height: 35px;">' +
          '<div style="flex: 1;"><h2 style="margin: 0; font-size: 1.1rem; font-weight: 600;">📊 Program Analytics</h2></div>' +
          '<div style="display: flex; align-items: center; gap: 0.5rem;">' +
            '<button onclick="toggleFullScreen()" style="background: rgba(255,255,255,0.15); border: none; color: white; font-size: 1rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s; display: flex; align-items: center;" onmouseover="this.style.background=\'rgba(255,255,255,0.25)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.15)\'">' +
              '<span style="font-size: 0.9rem;">' + (isFullScreen ? '🗗' : '🗖') + '</span>' +
            '</button>' +
            '<button onclick="closeProgramStats()" style="background: rgba(255,255,255,0.15); border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background=\'rgba(255,255,255,0.25)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.15)\'">×</button>' +
          '</div>' +
        '</div>' +
        generateControlsBar() +
        '<div style="flex: 1; overflow: auto; padding: 2rem; background: #f8fafc;"><div id="statsContent" style="max-width: none;">' + generateStatsContent() + '</div></div>' +
      '</div>';
    }

    function generateControlsBar() {
      return '<div style="background: white; border-bottom: 1px solid #e5e7eb; padding: 0.75rem 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">' +
        '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap;">' +
          '<button onclick="goBackToPrograms()" style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white; border: none; padding: 0.4rem 0.75rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; font-weight: 600; display: flex; align-items: center; gap: 0.4rem;" onmouseover="this.style.transform=\'translateY(-1px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
            '<span>←</span><span>Back to Programs</span>' +
          '</button>' +
          '<div style="height: 20px; width: 1px; background: #e5e7eb;"></div>' +
          '<div><label style="display: block; font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem; font-weight: 600;">⏰ Time</label>' +
          '<select id="timeRange" onchange="updateStatsTimeRange()" style="padding: 0.4rem 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; background: white; color: #374151; transition: border-color 0.2s;" onfocus="this.style.borderColor=\'#5a5bb8\'" onblur="this.style.borderColor=\'#d1d5db\'">' +
            '<option value="last7">Last 7 days</option>' +
            '<option value="last30" selected>Last 30 days</option>' +
            '<option value="last90">Last 90 days</option>' +
            '<option value="last6months">Last 6 months</option>' +
            '<option value="last1year">Last 1 year</option>' +
            '<option value="last2years">Last 2 years</option>' +
            '<option value="last5years">Last 5 years</option>' +
            '<option value="custom">Custom range</option>' +
          '</select></div>' +
          '<div><label style="display: block; font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem; font-weight: 600;">🎓 Program</label>' +
          '<select id="programFilter" onchange="updateStatsProgram()" style="padding: 0.4rem 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; background: white; color: #374151; transition: border-color 0.2s;" onfocus="this.style.borderColor=\'#5a5bb8\'" onblur="this.style.borderColor=\'#d1d5db\'">' +
            '<option value="all">All Programs</option>' + generateProgramOptions() +
          '</select></div>' +
          '<div><label style="display: block; font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem; font-weight: 600;">🏛️ Campus</label>' +
          '<select id="campusFilter" onchange="updateStatsCampus()" style="padding: 0.4rem 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; background: white; color: #374151; transition: border-color 0.2s;" onfocus="this.style.borderColor=\'#5a5bb8\'" onblur="this.style.borderColor=\'#d1d5db\'">' +
            '<option value="all">All Campuses</option>' +
            '<option value="main">Main Campus</option>' +
            '<option value="north">North Campus</option>' +
            '<option value="downtown">Downtown</option>' +
            '<option value="online">Online</option>' +
          '</select></div>' +
          '<div><label style="display: block; font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem; font-weight: 600;">📊 View</label>' +
          '<select id="analyticsView" onchange="updateAnalyticsView()" style="padding: 0.4rem 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; background: white; color: #374151; transition: border-color 0.2s;" onfocus="this.style.borderColor=\'#5a5bb8\'" onblur="this.style.borderColor=\'#d1d5db\'">' +
            '<option value="overview" selected>Overview</option>' +
            '<option value="detailed">Detailed</option>' +
            '<option value="predictive">AI Analysis</option>' +
            '<option value="comparative">Compare</option>' +
          '</select></div>' +
        '</div>' +
        '<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; padding: 0.5rem; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">' +
          '<button onclick="importStatsData()" style="padding: 0.4rem 0.7rem; background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; display: flex; align-items: center; gap: 0.3rem;" onmouseover="this.style.transform=\'translateY(-1px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
            '<span>📥</span><span>Import</span>' +
          '</button>' +
          '<button onclick="exportStatsData(\'csv\')" style="padding: 0.4rem 0.7rem; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; display: flex; align-items: center; gap: 0.3rem;" onmouseover="this.style.transform=\'translateY(-1px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
            '<span>📊</span><span>CSV</span>' +
          '</button>' +
          '<button onclick="exportStatsData(\'json\')" style="padding: 0.4rem 0.7rem; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; display: flex; align-items: center; gap: 0.3rem;" onmouseover="this.style.transform=\'translateY(-1px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
            '<span>📁</span><span>JSON</span>' +
          '</button>' +
          '<button onclick="generateReport()" style="padding: 0.4rem 0.7rem; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; display: flex; align-items: center; gap: 0.3rem;" onmouseover="this.style.transform=\'translateY(-1px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
            '<span>📄</span><span>Report</span>' +
          '</button>' +
          '<button onclick="refreshStats()" style="padding: 0.4rem 0.7rem; background: linear-gradient(135deg, #6b7280, #4b5563); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; display: flex; align-items: center; gap: 0.3rem;" onmouseover="this.style.transform=\'translateY(-1px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
            '<span>🔄</span><span>Refresh</span>' +
          '</button>' +
        '</div>' +
      '</div>';
    }

    // Dynamic program integration from existing pages
    function updateProgramsFromExistingData() {
      statsData.programs = {};

      // Integration from Curriculum Manager
      if (typeof courseCatalog !== 'undefined' && courseCatalog.courses) {
        // Extract programs from course data
        const programIds = new Set();
        courseCatalog.courses.forEach(course => {
          if (course.tags && course.tags.includes('core')) {
            // Infer program from core courses
            if (course.code.startsWith('CS')) programIds.add('computer-science-bs');
            else if (course.code.startsWith('MATH')) programIds.add('mathematics-bs');
            else if (course.code.startsWith('ENG')) programIds.add('engineering-bs');
            else if (course.code.startsWith('BUS')) programIds.add('business-mba');
          }
        });

        programIds.forEach(id => {
          const nameMap = {
            'computer-science-bs': { name: 'Computer Science (BS)', campus: 'Main', delivery: 'In-Person' },
            'mathematics-bs': { name: 'Mathematics (BS)', campus: 'Main', delivery: 'Hybrid' },
            'engineering-bs': { name: 'Engineering (BS)', campus: 'North', delivery: 'In-Person' },
            'business-mba': { name: 'Business (MBA)', campus: 'Downtown', delivery: 'Online' }
          };
          if (nameMap[id]) {
            statsData.programs[id] = nameMap[id];
          }
        });
      }

      // Fallback sample data if no programs found
      if (Object.keys(statsData.programs).length === 0) {
        statsData.programs = {
          'computer-science-bs': { name: 'Computer Science (BS)', campus: 'Main', delivery: 'In-Person' },
          'mathematics-bs': { name: 'Mathematics (BS)', campus: 'Main', delivery: 'Hybrid' },
          'engineering-bs': { name: 'Engineering (BS)', campus: 'North', delivery: 'In-Person' },
          'business-mba': { name: 'Business (MBA)', campus: 'Downtown', delivery: 'Online' }
        };
      }

      // Update last updated timestamp
      statsData.lastUpdated = new Date().toISOString();
    }

    function generateProgramOptions() {
      return Object.entries(statsData.programs).map(([key, program]) =>
        '<option value="' + key + '">' + program.name + '</option>'
      ).join('');
    }

    function generateStatsContent() {
      const view = document.getElementById('analyticsView')?.value || 'overview';

      switch (view) {
        case 'detailed': return generateDetailedAnalytics();
        case 'predictive': return generatePredictiveAnalysis();
        case 'comparative': return generateComparativeView();
        default: return generateOverviewContent();
      }
    }

    function generateOverviewContent() {
      const quickInsights = generateQuickAIInsights();

      return '<div style="margin-bottom: 3rem;">' + generateQuickInsightsPanel(quickInsights) + '</div>' +
        '<div style="margin-bottom: 3rem; background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;"><h3 style="margin: 0; color: #374151; font-size: 1.5rem; font-weight: 700;">🚨 Real-time Alerts</h3><div style="font-size: 0.9rem; color: #6b7280; background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 6px;">Last updated: ' + new Date().toLocaleTimeString() + '</div></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;"><div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 6px solid #f59e0b; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(245,158,11,0.15);"><div style="font-weight: 700; color: #92400e; margin-bottom: 1rem; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">⚠️ Alert</div><div style="color: #374151; line-height: 1.6; font-size: 1rem;">Application submissions down 15% vs last week</div></div><div style="background: linear-gradient(135deg, #e0f2fe, #bae6fd); border-left: 6px solid #0ea5e9; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(14,165,233,0.15);"><div style="font-weight: 700; color: #0c4a6e; margin-bottom: 1rem; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">ℹ️ Info</div><div style="color: #374151; line-height: 1.6; font-size: 1rem;">Mobile traffic increased 23% this month</div></div><div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-left: 6px solid #16a34a; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(22,163,74,0.15);"><div style="font-weight: 700; color: #14532d; margin-bottom: 1rem; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">✅ Success</div><div style="color: #374151; line-height: 1.6; font-size: 1rem;">New program launched successfully</div></div></div></div>' +
        '<div style="margin-bottom: 3rem; background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;"><h3 style="margin: 0; color: #374151; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">📈 Key Performance Indicators</h3><button onclick="showMetricDefinitions()" style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border: 2px solid #d1d5db; color: #6b7280; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.background=\'linear-gradient(135deg, #e5e7eb, #d1d5db)\'" onmouseout="this.style.background=\'linear-gradient(135deg, #f3f4f6, #e5e7eb)\'">❓ Definitions</button></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem;">' +
        generateMetricCard('Program Views', 12847, 14.3, '👁️') +
        generateMetricCard('Discovery Impressions', 45632, 8.4, '🔍') +
        generateMetricCard('Click-through Rate', 28.1, 5.2, '🖱️', '%') +
        generateMetricCard('Applications Started', 1247, 14.5, '📝') +
        generateMetricCard('Applications Completed', 967, 14.4, '✅') +
        generateMetricCard('Acceptance Rate', 67.8, 4.0, '🎯', '%') +
        generateMetricCard('Yield Rate', 42.3, 8.7, '🎓', '%') +
        generateMetricCard('Deferrals', 89, -12.7, '⏳') +
        generateMetricCard('Withdrawals', 34, 21.4, '↩️') +
        '</div></div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin-bottom: 3rem;"><div style="background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 2rem 0; color: #374151; font-size: 1.3rem; font-weight: 700;">🔽 Application Funnel</h4>' + generateFunnel() + '</div><div style="background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 2rem 0; color: #374151; font-size: 1.3rem; font-weight: 700;">📊 Enrollment Trends</h4>' + generateTrendChart() + '</div></div>' +
        '<div style="background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 2rem 0; color: #374151; font-size: 1.3rem; font-weight: 700;">💰 Financial Indicators</h4>' + generateFinancials() + '</div>';
    }

    function generateDetailedAnalytics() {
      return '<div style="margin-bottom: 2rem;"><h3 style="margin: 0 0 1rem 0; color: #374151;">📊 Detailed Analytics Dashboard</h3></div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;"><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">🌍 Geographic Distribution</h4>' + generateGeoChart() + '</div><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">📱 Device & Browser Analytics</h4>' + generateDeviceAnalytics() + '</div></div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;"><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">⏰ Hourly Activity Heatmap</h4>' + generateHeatmap() + '</div><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">🔗 Referral Sources</h4>' + generateReferralChart() + '</div></div>' +
        '<div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">📈 Advanced Metrics Table</h4>' + generateAdvancedTable() + '</div>';
    }

    function generatePredictiveAnalysis() {
      const insights = generateAIInsights();

      return '<div style="margin-bottom: 2rem;"><h3 style="margin: 0 0 1rem 0; color: #374151;">🔮 AI-Powered Predictive Analysis</h3>' +
        generateAIInsightsPanel(insights) +
        '</div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;"><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">📈 Enrollment Forecasting</h4>' + generateForecastChart() + '</div><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">🎯 Conversion Predictions</h4>' + generatePredictionTable() + '</div></div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;"><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">🧠 ML Model Performance</h4>' + generateModelPerformance() + '</div><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">🎯 Optimization Suggestions</h4>' + generateOptimizationSuggestions() + '</div></div>' +
        '<div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">🧮 Advanced Analytics Models</h4>' + generateStatisticalModels() + '</div>';
    }

    function generateComparativeView() {
      return '<div style="margin-bottom: 2rem;"><h3 style="margin: 0 0 1rem 0; color: #374151;">⚖️ Comparative Program Analysis</h3></div>' +
        '<div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb; margin-bottom: 2rem;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">📊 Program Performance Comparison</h4>' + generateComparisonChart() + '</div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;"><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">🏆 Top Performers</h4>' + generateTopPerformers() + '</div><div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">⚠️ Attention Needed</h4>' + generateUnderperformers() + '</div></div>' +
        '<div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e7eb;"><h4 style="margin: 0 0 1.5rem 0; color: #374151;">📋 Detailed Comparison Table</h4>' + generateComparisonTable() + '</div>';
    }

    function generateMetricCard(title, current, change, icon, unit) {
      unit = unit || '';
      const changeColor = change >= 0 ? '#16a34a' : '#dc2626';
      const changeBgColor = change >= 0 ? '#dcfce7' : '#fef2f2';
      const changeIcon = change >= 0 ? '📈' : '📉';

      return '<div style="background: linear-gradient(135deg, #ffffff, #f9fafb); border-radius: 16px; padding: 2rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.2s; position: relative; overflow: hidden;" onmouseover="this.style.transform=\'translateY(-4px)\'; this.style.boxShadow=\'0 8px 20px rgba(0,0,0,0.12)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.08)\'">' +
        '<div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 50%; opacity: 0.3;"></div>' +
        '<div style="position: relative; z-index: 2;"><div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;"><div style="font-size: 2.5rem; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));">' + icon + '</div></div>' +
        '<div style="font-size: 2.8rem; font-weight: 800; color: #374151; margin-bottom: 0.75rem; line-height: 1;">' + current.toLocaleString() + unit + '</div>' +
        '<div style="font-size: 1.1rem; color: #6b7280; margin-bottom: 1.25rem; font-weight: 600;">' + title + '</div>' +
        '<div style="display: flex; align-items: center; justify-content: space-between;"><div style="display: flex; align-items: center; gap: 0.75rem;"><span style="color: ' + changeColor + '; font-size: 1.2rem;">' + changeIcon + '</span><span style="color: ' + changeColor + '; font-weight: 700; font-size: 1.1rem;">' + (change > 0 ? '+' : '') + change + '%</span></div><div style="background: ' + changeBgColor + '; color: ' + changeColor + '; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">vs previous</div></div></div>' +
      '</div>';
    }

    function generateFunnel() {
      const stages = [
        {name: 'View', count: 12847},
        {name: 'Start', count: 3612},
        {name: 'Submit', count: 1247},
        {name: 'Offer', count: 845},
        {name: 'Enroll', count: 357}
      ];

      return '<div style="display: flex; align-items: end; justify-content: space-between; height: 200px; gap: 1rem;">' +
        stages.map(function(stage) {
          return '<div style="display: flex; flex-direction: column; align-items: center; flex: 1;"><div style="background: linear-gradient(to top, #5a5bb8, #6b6ce8); height: ' + Math.max(20, (stage.count / 12847) * 160) + 'px; width: 100%; border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">' + (stage.count > 1000 ? Math.round(stage.count/1000) + 'k' : stage.count) + '</div><div style="padding: 0.75rem 0; text-align: center; font-weight: 600; color: #374151;">' + stage.name + '</div></div>';
        }).join('') + '</div>';
    }

    function generateFinancials() {
      return '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;"><div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 16px; border: 1px solid #bbf7d0; box-shadow: 0 4px 12px rgba(22,163,74,0.15);"><div style="font-size: 2.5rem; font-weight: 800; color: #16a34a; margin-bottom: 0.5rem;">$28,500</div><div style="font-size: 1.1rem; color: #15803d; margin-top: 0.5rem; font-weight: 600;">Average Tuition Listed</div><div style="font-size: 0.85rem; color: #16a34a; margin-top: 0.5rem; background: rgba(22,163,74,0.1); padding: 0.25rem 0.75rem; border-radius: 12px; display: inline-block;">+3.2% vs last year</div></div><div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 16px; border: 1px solid #93c5fd; box-shadow: 0 4px 12px rgba(59,130,246,0.15);"><div style="font-size: 2.5rem; font-weight: 800; color: #2563eb; margin-bottom: 0.5rem;">342</div><div style="font-size: 1.1rem; color: #1d4ed8; margin-top: 0.5rem; font-weight: 600;">Scholarship Offers</div><div style="font-size: 0.85rem; color: #2563eb; margin-top: 0.5rem; background: rgba(59,130,246,0.1); padding: 0.25rem 0.75rem; border-radius: 12px; display: inline-block;">+12.4% this quarter</div></div><div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px; border: 1px solid #fbbf24; box-shadow: 0 4px 12px rgba(245,158,11,0.15);"><div style="font-size: 2.5rem; font-weight: 800; color: #d97706; margin-bottom: 0.5rem;">$12,800</div><div style="font-size: 1.1rem; color: #b45309; margin-top: 0.5rem; font-weight: 600;">Average Scholarship</div><div style="font-size: 0.85rem; color: #d97706; margin-top: 0.5rem; background: rgba(245,158,11,0.1); padding: 0.25rem 0.75rem; border-radius: 12px; display: inline-block;">+8.7% increase</div></div></div>';
    }

    window.toggleFullScreen = function() {
      isFullScreen = !isFullScreen;

      const modal = document.getElementById('statsModal');
      if (modal) {
        // Update the modal content with new size
        modal.innerHTML = generateStatsModal();
        showToast(isFullScreen ? 'Switched to full-screen mode' : 'Exited full-screen mode', 'info');

        // Save fullscreen state
        localStorage.setItem('statsModalFullscreen', isFullScreen.toString());
      }
    };

    function generateTrendChart() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const enrollmentData = [245, 267, 289, 312, 298, 334, 367, 389, 412, 445, 478, 501];
      const maxValue = Math.max(...enrollmentData);

      return '<div style="position: relative; height: 200px; padding: 1rem 0;">' +
        '<div style="display: flex; align-items: end; justify-content: space-between; height: 160px; gap: 0.5rem;">' +
        months.map(function(month, i) {
          const height = (enrollmentData[i] / maxValue) * 140;
          return '<div style="display: flex; flex-direction: column; align-items: center; flex: 1;">' +
            '<div style="background: linear-gradient(to top, #3b82f6, #60a5fa); height: ' + height + 'px; width: 80%; border-radius: 4px 4px 0 0; display: flex; align-items: end; justify-content: center; color: white; font-size: 0.7rem; font-weight: 600; padding-bottom: 0.25rem;">' + enrollmentData[i] + '</div>' +
            '<div style="margin-top: 0.5rem; font-size: 0.7rem; color: #6b7280; transform: rotate(-45deg); white-space: nowrap;">' + month + '</div>' +
            '</div>';
        }).join('') +
        '</div></div>';
    }

    function generateGeoChart() {
      const regions = [
        { name: 'North America', count: 867, percentage: 71.2 },
        { name: 'Europe', count: 156, percentage: 12.8 },
        { name: 'Asia', count: 178, percentage: 14.6 },
        { name: 'Other', count: 46, percentage: 3.8 }
      ];

      return '<div style="margin-bottom: 1rem;">' +
        regions.map(function(region) {
          const width = Math.max(5, region.percentage);
          return '<div style="margin-bottom: 1rem;"><div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;"><span style="font-weight: 600; color: #374151;">' + region.name + '</span><span style="color: #6b7280;">' + region.count + ' (' + region.percentage + '%)</span></div><div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;"><div style="background: linear-gradient(90deg, #5a5bb8, #6b6ce8); height: 100%; width: ' + width + '%; border-radius: 4px; transition: width 0.3s;"></div></div></div>';
        }).join('') + '</div>';
    }

    function generateHeatmap() {
      const hours = Array.from({ length: 24 }, (_, i) => i);
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const activityData = hours.map(h => days.map(d => Math.random() * 100));

      return '<div style="display: grid; grid-template-columns: 30px repeat(7, 1fr); gap: 2px; font-size: 0.7rem;">' +
        '<div></div>' +
        days.map(day => '<div style="text-align: center; font-weight: 600; color: #374151; padding: 0.25rem;">' + day + '</div>').join('') +
        hours.map(function(hour) {
          return '<div style="text-align: right; color: #6b7280; padding: 0.25rem;">' + (hour < 10 ? '0' : '') + hour + '</div>' +
            activityData[hour].map(function(activity) {
              const intensity = activity / 100;
              const opacity = Math.max(0.1, intensity);
              return '<div style="height: 12px; background-color: #5a5bb8; opacity: ' + opacity + '; border-radius: 2px;"></div>';
            }).join('');
        }).join('') + '</div>';
    }

    function generateDeviceAnalytics() {
      const devices = [
        { name: 'Desktop', percentage: 62.4, icon: '🖥️' },
        { name: 'Mobile', percentage: 28.7, icon: '📱' },
        { name: 'Tablet', percentage: 8.9, icon: '📟' }
      ];

      return '<div>' +
        devices.map(function(device) {
          return '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px;"><div style="display: flex; align-items: center; gap: 0.75rem;"><span style="font-size: 1.25rem;">' + device.icon + '</span><span style="font-weight: 600; color: #374151;">' + device.name + '</span></div><div style="display: flex; align-items: center; gap: 1rem;"><div style="background: #e5e7eb; height: 6px; width: 100px; border-radius: 3px; overflow: hidden;"><div style="background: #5a5bb8; height: 100%; width: ' + device.percentage + '%; border-radius: 3px;"></div></div><span style="font-weight: 600; color: #374151; min-width: 45px;">' + device.percentage + '%</span></div></div>';
        }).join('') + '</div>';
    }

    function generateReferralChart() {
      const sources = [
        { name: 'Google Search', count: 4567, percentage: 45.2 },
        { name: 'Direct', count: 2341, percentage: 23.1 },
        { name: 'Social Media', count: 1789, percentage: 17.7 },
        { name: 'Email Marketing', count: 892, percentage: 8.8 },
        { name: 'Other', count: 523, percentage: 5.2 }
      ];

      return '<div>' +
        sources.map(function(source) {
          return '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;"><div><div style="font-weight: 600; color: #374151;">' + source.name + '</div><div style="font-size: 0.8rem; color: #6b7280;">' + source.count + ' visits</div></div><div style="font-size: 1.1rem; font-weight: 700; color: #5a5bb8;">' + source.percentage + '%</div></div>';
        }).join('') + '</div>';
    }

    function generateAdvancedTable() {
      const metrics = [
        { metric: 'Bounce Rate', current: '34.2%', previous: '36.1%', change: -5.3 },
        { metric: 'Session Duration', current: '4:23', previous: '3:56', change: 11.4 },
        { metric: 'Pages per Session', current: '3.7', previous: '3.2', change: 15.6 },
        { metric: 'Conversion Rate', current: '12.8%', previous: '11.4%', change: 12.3 },
        { metric: 'Cost per Lead', current: '$45.60', previous: '$52.30', change: -12.8 }
      ];

      return '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f9fafb;"><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Metric</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Current</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Previous</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Change</th></tr></thead><tbody>' +
        metrics.map(function(row) {
          const changeColor = row.change >= 0 ? '#16a34a' : '#dc2626';
          const changeIcon = row.change >= 0 ? '↗️' : '↘️';
          return '<tr><td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #374151;">' + row.metric + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + row.current + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #6b7280;">' + row.previous + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: ' + changeColor + '; font-weight: 600;">' + changeIcon + ' ' + Math.abs(row.change) + '%</td></tr>';
        }).join('') + '</tbody></table></div>';
    }

    function generateForecastChart() {
      const forecastData = [
        { period: 'Current', actual: 967, predicted: null },
        { period: 'Next Month', actual: null, predicted: 1089 },
        { period: 'Q2 2025', actual: null, predicted: 1245 },
        { period: 'Q3 2025', actual: null, predicted: 1356 },
        { period: 'Q4 2025', actual: null, predicted: 1478 }
      ];

      return '<div style="position: relative; height: 200px; padding: 1rem 0;">' +
        '<div style="display: flex; align-items: end; justify-content: space-between; height: 160px; gap: 0.5rem;">' +
        forecastData.map(function(data, i) {
          const value = data.actual || data.predicted;
          const height = (value / 1500) * 140;
          const color = data.actual ? '#5a5bb8' : '#a855f7';
          const style = data.actual ? 'solid' : 'dashed';
          return '<div style="display: flex; flex-direction: column; align-items: center; flex: 1;">' +
            '<div style="background: ' + color + '; height: ' + height + 'px; width: 80%; border-radius: 4px 4px 0 0; display: flex; align-items: end; justify-content: center; color: white; font-size: 0.7rem; font-weight: 600; padding-bottom: 0.25rem; border: 2px ' + style + ' rgba(255,255,255,0.3);">' + value + '</div>' +
            '<div style="margin-top: 0.5rem; font-size: 0.7rem; color: #6b7280; text-align: center;">' + data.period + '</div>' +
            '</div>';
        }).join('') + '</div>' +
        '<div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;"><div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 12px; height: 12px; background: #5a5bb8; border-radius: 2px;"></div><span style="font-size: 0.8rem; color: #6b7280;">Actual</span></div><div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 12px; height: 12px; background: #a855f7; border-radius: 2px; border: 2px dashed rgba(255,255,255,0.5);"></div><span style="font-size: 0.8rem; color: #6b7280;">Predicted</span></div></div>' +
        '</div>';
    }

    function generatePredictionTable() {
      const predictions = [
        { metric: 'Application Completion Rate', current: '77.5%', predicted: '82.1%', confidence: 89 },
        { metric: 'Yield Rate', current: '42.3%', predicted: '45.8%', confidence: 76 },
        { metric: 'Time to Decision', current: '21 days', predicted: '18 days', confidence: 94 },
        { metric: 'Scholarship Acceptance', current: '68.4%', predicted: '71.2%', confidence: 82 }
      ];

      return '<div>' +
        predictions.map(function(pred) {
          return '<div style="display: flex; justify-content: between; margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;"><div style="flex: 1;"><div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">' + pred.metric + '</div><div style="display: flex; gap: 1rem; font-size: 0.9rem;"><span style="color: #6b7280;">Current: ' + pred.current + '</span><span style="color: #5a5bb8; font-weight: 600;">Predicted: ' + pred.predicted + '</span></div></div><div style="text-align: right;"><div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.25rem;">Confidence</div><div style="font-weight: 700; color: ' + (pred.confidence > 80 ? '#16a34a' : pred.confidence > 60 ? '#f59e0b' : '#dc2626') + ';">' + pred.confidence + '%</div></div></div>';
        }).join('') + '</div>';
    }

    function generateStatisticalModels() {
      const models = [
        { name: 'Linear Regression', accuracy: '85.2%', r2: '0.726', status: 'Active' },
        { name: 'Random Forest', accuracy: '91.7%', r2: '0.841', status: 'Active' },
        { name: 'Neural Network', accuracy: '88.4%', r2: '0.782', status: 'Training' },
        { name: 'Time Series (ARIMA)', accuracy: '79.3%', r2: '0.629', status: 'Inactive' }
      ];

      return '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">' +
        models.map(function(model) {
          const statusColor = model.status === 'Active' ? '#16a34a' : model.status === 'Training' ? '#f59e0b' : '#6b7280';
          return '<div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;"><div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">' + model.name + '</div><div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;"><span style="color: #6b7280;">Accuracy:</span><span style="font-weight: 600; color: #374151;">' + model.accuracy + '</span></div><div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"><span style="color: #6b7280;">R²:</span><span style="font-weight: 600; color: #374151;">' + model.r2 + '</span></div><div style="display: inline-block; padding: 0.25rem 0.5rem; background: ' + statusColor + '; color: white; font-size: 0.75rem; border-radius: 4px; font-weight: 600;">' + model.status + '</div></div>';
        }).join('') + '</div>';
    }

    function generateComparisonChart() {
      const programs = [
        { name: 'Computer Science (BS)', applications: 1247, acceptance: 67.8, yield: 42.3 },
        { name: 'Mathematics (BS)', applications: 823, acceptance: 74.2, yield: 38.9 },
        { name: 'Engineering (BS)', applications: 956, acceptance: 61.4, yield: 45.7 },
        { name: 'Business (MBA)', applications: 1389, acceptance: 52.3, yield: 48.2 }
      ];

      return '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f9fafb;"><th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Program</th><th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Applications</th><th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Acceptance Rate</th><th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Yield Rate</th><th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Performance</th></tr></thead><tbody>' +
        programs.map(function(program) {
          const score = (program.applications / 1500 * 40) + (program.acceptance / 100 * 30) + (program.yield / 100 * 30);
          const performance = score > 70 ? '🏆' : score > 50 ? '✅' : '⚠️';
          return '<tr><td style="padding: 1rem; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #374151;">' + program.name + '</td><td style="padding: 1rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.applications + '</td><td style="padding: 1rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.acceptance + '%</td><td style="padding: 1rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.yield + '%</td><td style="padding: 1rem; text-align: center; border-bottom: 1px solid #f3f4f6; font-size: 1.5rem;">' + performance + '</td></tr>';
        }).join('') + '</tbody></table></div>';
    }

    function generateTopPerformers() {
      const performers = [
        { name: 'Business (MBA)', metric: 'Highest Yield Rate', value: '48.2%', trend: '📈' },
        { name: 'Computer Science (BS)', metric: 'Most Applications', value: '1,247', trend: '📈' },
        { name: 'Mathematics (BS)', metric: 'Best Acceptance Rate', value: '74.2%', trend: '📈' }
      ];

      return '<div>' +
        performers.map(function(performer) {
          return '<div style="margin-bottom: 1rem; padding: 1rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;"><div style="display: flex; justify-content: between; align-items: center;"><div style="flex: 1;"><div style="font-weight: 600; color: #15803d; margin-bottom: 0.25rem;">' + performer.name + '</div><div style="font-size: 0.9rem; color: #16a34a;">' + performer.metric + '</div></div><div style="text-align: right;"><div style="font-size: 1.25rem; font-weight: 700; color: #15803d;">' + performer.value + '</div><div style="font-size: 1.25rem;">' + performer.trend + '</div></div></div></div>';
        }).join('') + '</div>';
    }

    function generateUnderperformers() {
      const underperformers = [
        { name: 'Engineering (BS)', metric: 'Low Acceptance Rate', value: '61.4%', recommendation: 'Review admission criteria' },
        { name: 'Mathematics (BS)', metric: 'Below Average Yield', value: '38.9%', recommendation: 'Improve program marketing' }
      ];

      return '<div>' +
        underperformers.map(function(under) {
          return '<div style="margin-bottom: 1rem; padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;"><div style="font-weight: 600; color: #dc2626; margin-bottom: 0.25rem;">' + under.name + '</div><div style="font-size: 0.9rem; color: #991b1b; margin-bottom: 0.5rem;">' + under.metric + ': ' + under.value + '</div><div style="font-size: 0.85rem; color: #6b7280; font-style: italic;">💡 ' + under.recommendation + '</div></div>';
        }).join('') + '</div>';
    }

    function generateComparisonTable() {
      const programs = [
        { name: 'Computer Science (BS)', views: 12847, ctr: '28.1%', apps: 1247, completion: '77.5%', acceptance: '67.8%', yield: '42.3%' },
        { name: 'Mathematics (BS)', views: 8934, ctr: '24.6%', apps: 823, completion: '81.2%', acceptance: '74.2%', yield: '38.9%' },
        { name: 'Engineering (BS)', views: 10567, ctr: '26.8%', apps: 956, completion: '79.3%', acceptance: '61.4%', yield: '45.7%' },
        { name: 'Business (MBA)', views: 15623, ctr: '31.4%', apps: 1389, completion: '73.8%', acceptance: '52.3%', yield: '48.2%' }
      ];

      return '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;"><thead><tr style="background: #f9fafb;"><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Program</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Views</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">CTR</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Applications</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Completion</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Acceptance</th><th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Yield</th></tr></thead><tbody>' +
        programs.map(function(program) {
          return '<tr><td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #374151;">' + program.name + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.views.toLocaleString() + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.ctr + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.apps.toLocaleString() + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.completion + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.acceptance + '</td><td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #374151;">' + program.yield + '</td></tr>';
        }).join('') + '</tbody></table></div>';
    }

    function generateQuickAIInsights() {
      return [
        { type: 'trend', message: 'Applications trending +14.5% above last month', icon: '📈', color: '#16a34a' },
        { type: 'anomaly', message: 'Unusual spike in mobile traffic detected (analyzing...)', icon: '🔍', color: '#f59e0b' },
        { type: 'prediction', message: 'AI predicts 12% yield rate improvement next quarter', icon: '🤖', color: '#8b5cf6' }
      ];
    }

    function generateQuickInsightsPanel(insights) {
      return '<div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 3rem; border-radius: 20px; margin-bottom: 2rem; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(102,126,234,0.3);">' +
        '<div style="position: absolute; top: -30px; right: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>' +
        '<div style="position: absolute; bottom: -40px; left: -40px; width: 120px; height: 120px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>' +
        '<div style="position: relative; z-index: 2;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">' +
          '<div><h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem; font-size: 2rem; font-weight: 800;">🤖 AI-Powered Insights</h3><p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 1.1rem;">Real-time intelligence from your program data</p></div>' +
          '<button onclick="document.getElementById(\'analyticsView\').value=\'predictive\'; updateAnalyticsView();" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1rem; cursor: pointer; font-weight: 700; transition: all 0.2s; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);" onmouseover="this.style.background=\'rgba(255,255,255,0.3)\'; this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.2)\'; this.style.transform=\'translateY(0)\'">View All Insights</button>' +
        '</div>' +
        '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem;">' +
        insights.map(function(insight) {
          return '<div style="background: rgba(255,255,255,0.15); padding: 2rem; border-radius: 16px; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.2s;" onmouseover="this.style.background=\'rgba(255,255,255,0.25)\'; this.style.transform=\'translateY(-4px)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.15)\'; this.style.transform=\'translateY(0)\'">' +
            '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;"><span style="font-size: 1.5rem; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));">' + insight.icon + '</span><span style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; background: rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 20px;">' + insight.type + '</span></div>' +
            '<p style="margin: 0; font-size: 1.1rem; line-height: 1.5; font-weight: 500;">' + insight.message + '</p>' +
          '</div>';
        }).join('') +
        '</div></div></div>';
    }

    function generateAIInsights() {
      const currentData = statsData.metrics;
      const insights = [];

      // Trend Analysis
      if (currentData.applications.change > 10) {
        insights.push({
          type: 'trend',
          priority: 'high',
          title: 'Strong Application Growth Detected',
          message: 'Applications increased by ' + currentData.applications.change + '% - consider expanding admission capacity',
          confidence: 92,
          action: 'Review capacity planning',
          icon: '📈'
        });
      }

      // Conversion Analysis
      const conversionRate = (currentData.completed.current / currentData.applications.current) * 100;
      if (conversionRate < 75) {
        insights.push({
          type: 'conversion',
          priority: 'medium',
          title: 'Application Completion Rate Below Optimal',
          message: 'Only ' + conversionRate.toFixed(1) + '% of started applications are completed. Consider simplifying the process.',
          confidence: 87,
          action: 'Optimize application flow',
          icon: '⚡'
        });
      }

      // Yield Rate Analysis
      if (currentData.yield.current < 40) {
        insights.push({
          type: 'yield',
          priority: 'high',
          title: 'Low Yield Rate Requires Attention',
          message: 'Current yield rate of ' + currentData.yield.current + '% is below industry average. Consider improving program appeal.',
          confidence: 85,
          action: 'Enhance value proposition',
          icon: '🎯'
        });
      }

      // Seasonal Predictions
      const currentMonth = new Date().getMonth();
      if (currentMonth >= 8 && currentMonth <= 10) { // Sep-Nov
        insights.push({
          type: 'seasonal',
          priority: 'info',
          title: 'Peak Application Season Approaching',
          message: 'Historical data shows 35% increase in applications during next 2 months. Prepare resources accordingly.',
          confidence: 94,
          action: 'Scale support capacity',
          icon: '📅'
        });
      }

      // Competitive Analysis
      insights.push({
        type: 'competitive',
        priority: 'medium',
        title: 'Market Position Analysis',
        message: 'Your acceptance rate of ' + currentData.acceptanceRate.current + '% is competitive. Consider selective improvements to maintain quality.',
        confidence: 78,
        action: 'Monitor competitor rates',
        icon: '🏆'
      });

      // AI Recommendations
      insights.push({
        type: 'recommendation',
        priority: 'high',
        title: 'AI Optimization Opportunity',
        message: 'Machine learning models suggest focusing marketing on mobile users could increase applications by 12-18%.',
        confidence: 89,
        action: 'Implement mobile-first strategy',
        icon: '🤖'
      });

      return insights;
    }

    function generateAIInsightsPanel(insights) {
      const highPriority = insights.filter(i => i.priority === 'high');
      const mediumPriority = insights.filter(i => i.priority === 'medium');
      const infoPriority = insights.filter(i => i.priority === 'info');

      return '<div style="display: grid; gap: 1rem; margin-bottom: 2rem;">' +
        '<div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 1.5rem; border-radius: 12px; position: relative; overflow: hidden;">' +
          '<div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>' +
          '<div style="position: relative; z-index: 2;"><h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">🤖 AI Analysis Engine</h4><p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">Real-time insights from ' + insights.length + ' data points • Last updated: ' + new Date().toLocaleTimeString() + '</p></div>' +
        '</div>' +

        (highPriority.length > 0 ? '<div><h5 style="margin: 0 0 1rem 0; color: #dc2626; display: flex; align-items: center; gap: 0.5rem;">🚨 High Priority Insights</h5>' +
        highPriority.map(insight => generateInsightCard(insight, '#fef2f2', '#dc2626')).join('') + '</div>' : '') +

        (mediumPriority.length > 0 ? '<div><h5 style="margin: 1.5rem 0 1rem 0; color: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">⚠️ Medium Priority Insights</h5>' +
        mediumPriority.map(insight => generateInsightCard(insight, '#fefbeb', '#f59e0b')).join('') + '</div>' : '') +

        (infoPriority.length > 0 ? '<div><h5 style="margin: 1.5rem 0 1rem 0; color: #3b82f6; display: flex; align-items: center; gap: 0.5rem;">ℹ️ Informational Insights</h5>' +
        infoPriority.map(insight => generateInsightCard(insight, '#eff6ff', '#3b82f6')).join('') + '</div>' : '') +

        '</div>';
    }

    function generateInsightCard(insight, bgColor, borderColor) {
      return '<div style="background: ' + bgColor + '; border: 1px solid ' + borderColor + '; border-left: 4px solid ' + borderColor + '; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">' +
        '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">' +
          '<div style="flex: 1;"><h6 style="margin: 0 0 0.5rem 0; color: ' + borderColor + '; display: flex; align-items: center; gap: 0.5rem;">' + insight.icon + ' ' + insight.title + '</h6>' +
          '<p style="margin: 0; color: #374151; line-height: 1.5; font-size: 0.9rem;">' + insight.message + '</p></div>' +
          '<div style="text-align: center; margin-left: 1rem;"><div style="background: ' + borderColor + '; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem;">' + insight.confidence + '%</div><div style="font-size: 0.7rem; color: #6b7280;">Confidence</div></div>' +
        '</div>' +
        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
          '<div style="background: rgba(255,255,255,0.8); padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; color: ' + borderColor + '; font-weight: 600;">💡 ' + insight.action + '</div>' +
          '<button onclick="implementInsight(\'' + insight.type + '\')" style="background: ' + borderColor + '; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; transition: opacity 0.2s;" onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1">Implement</button>' +
        '</div>' +
      '</div>';
    }

    function generateModelPerformance() {
      const models = [
        { name: 'Enrollment Predictor', accuracy: 94.2, status: 'Excellent', trend: '📈', lastTrained: '2 days ago' },
        { name: 'Conversion Optimizer', accuracy: 87.6, status: 'Good', trend: '📊', lastTrained: '1 week ago' },
        { name: 'Yield Rate Forecaster', accuracy: 91.3, status: 'Excellent', trend: '📈', lastTrained: '3 days ago' },
        { name: 'Anomaly Detector', accuracy: 89.1, status: 'Good', trend: '🔍', lastTrained: '1 day ago' }
      ];

      return '<div style="display: grid; gap: 1rem;">' +
        models.map(function(model) {
          const statusColor = model.status === 'Excellent' ? '#16a34a' : '#f59e0b';
          return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 4px solid ' + statusColor + ';">' +
            '<div><div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">' + model.trend + ' ' + model.name + '</div><div style="font-size: 0.8rem; color: #6b7280;">Last trained: ' + model.lastTrained + '</div></div>' +
            '<div style="text-align: right;"><div style="font-size: 1.2rem; font-weight: 700; color: ' + statusColor + ';">' + model.accuracy + '%</div><div style="font-size: 0.75rem; color: #6b7280;">' + model.status + '</div></div>' +
          '</div>';
        }).join('') + '</div>';
    }

    function generateOptimizationSuggestions() {
      const suggestions = [
        { title: 'A/B Test Application Form', impact: 'High', effort: 'Medium', roi: '+15% completion rate' },
        { title: 'Implement Chatbot Support', impact: 'Medium', effort: 'High', roi: '+8% conversion rate' },
        { title: 'Optimize Mobile Experience', impact: 'High', effort: 'Low', roi: '+12% mobile applications' },
        { title: 'Personalized Email Campaigns', impact: 'Medium', effort: 'Low', roi: '+6% yield rate' }
      ];

      return '<div style="display: grid; gap: 1rem;">' +
        suggestions.map(function(suggestion) {
          const impactColor = suggestion.impact === 'High' ? '#dc2626' : suggestion.impact === 'Medium' ? '#f59e0b' : '#16a34a';
          const effortColor = suggestion.effort === 'High' ? '#dc2626' : suggestion.effort === 'Medium' ? '#f59e0b' : '#16a34a';

          return '<div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">' +
            '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">' +
              '<h6 style="margin: 0; color: #374151; font-weight: 600;">' + suggestion.title + '</h6>' +
              '<div style="display: flex; gap: 0.5rem;">' +
                '<span style="background: ' + impactColor + '; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">' + suggestion.impact + ' Impact</span>' +
                '<span style="background: ' + effortColor + '; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">' + suggestion.effort + ' Effort</span>' +
              '</div>' +
            '</div>' +
            '<div style="display: flex; justify-content: space-between; align-items: center;">' +
              '<span style="color: #16a34a; font-weight: 600; font-size: 0.9rem;">Expected: ' + suggestion.roi + '</span>' +
              '<button onclick="startOptimization(\'' + suggestion.title + '\')" style="background: #5a5bb8; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600;">Start Project</button>' +
            '</div>' +
          '</div>';
        }).join('') + '</div>';
    }

    window.implementInsight = function(insightType) {
      const actions = {
        'trend': 'Capacity planning review scheduled',
        'conversion': 'Application flow optimization initiated',
        'yield': 'Value proposition enhancement planned',
        'seasonal': 'Resource scaling prepared',
        'competitive': 'Competitor analysis activated',
        'recommendation': 'Mobile-first strategy implementation started'
      };

      showToast(actions[insightType] || 'Implementation started', 'success');
    };

    window.startOptimization = function(projectTitle) {
      showToast('Optimization project "' + projectTitle + '" added to development roadmap', 'success');
    };

    window.updateStatsTimeRange = function() {
      const timeRange = document.getElementById('timeRange').value;
      if (timeRange === 'custom') {
        const startDate = prompt('Enter start date (YYYY-MM-DD):');
        const endDate = prompt('Enter end date (YYYY-MM-DD):');
        if (startDate && endDate) {
          showToast('Custom date range applied: ' + startDate + ' to ' + endDate);
          refreshStats();
        }
      } else {
        showToast('Time range updated to: ' + timeRange.replace('last', 'Last '));
        refreshStats();
      }
    };

    window.updateStatsProgram = function() {
      const program = document.getElementById('programFilter').value;
      showToast('Program filter updated');
      refreshStats();
    };

    window.updateStatsCampus = function() {
      const campus = document.getElementById('campusFilter').value;
      showToast('Campus filter updated');
      refreshStats();
    };

    window.updateAnalyticsView = function() {
      const view = document.getElementById('analyticsView').value;
      document.getElementById('statsContent').innerHTML = generateStatsContent();
      showToast('Analytics view switched to: ' + view.charAt(0).toUpperCase() + view.slice(1));
    };

    window.importStatsData = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const csvData = e.target.result;
              const lines = csvData.split('\n');
              const headers = lines[0].split(',');
              const data = lines.slice(1).map(line => {
                const values = line.split(',');
                const row = {};
                headers.forEach((header, i) => {
                  row[header.trim()] = values[i] ? values[i].trim() : '';
                });
                return row;
              }).filter(row => Object.values(row).some(val => val !== ''));

              console.log('Imported data:', data);
              showToast('Successfully imported ' + data.length + ' records from CSV');
              refreshStats();
            } catch (error) {
              showToast('Error importing CSV file: ' + error.message, 'error');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    };

    window.exportStatsData = function(format) {
      const data = {
        exportDate: new Date().toISOString(),
        programs: statsData.programs,
        metrics: statsData.metrics,
        demographics: statsData.demographics,
        financial: statsData.financial,
        funnel: statsData.funnel
      };

      if (format === 'csv') {
        const csvContent = convertToCSV(data.metrics);
        downloadFile(csvContent, 'program-stats.csv', 'text/csv');
      } else if (format === 'json') {
        const jsonContent = JSON.stringify(data, null, 2);
        downloadFile(jsonContent, 'program-stats.json', 'application/json');
      }

      showToast('Data exported as ' + format.toUpperCase());
    };

    window.generateReport = function() {
      const reportData = {
        title: 'Program Analytics Report',
        generatedAt: new Date().toISOString(),
        summary: {
          totalViews: 12847,
          totalApplications: 1247,
          averageAcceptanceRate: '67.8%',
          averageYieldRate: '42.3%'
        },
        recommendations: [
          'Focus marketing efforts on mobile platforms (28.7% of traffic)',
          'Investigate Engineering program acceptance rate (61.4% below average)',
          'Consider increasing scholarship offers to improve yield rates'
        ]
      };

      const reportContent = generateReportHTML(reportData);
      const newWindow = window.open('', '_blank');
      newWindow.document.write(reportContent);
      newWindow.document.close();

      showToast('Report generated in new window');
    };

    window.refreshStats = function() {
      updateProgramsFromExistingData();
      document.getElementById('statsContent').innerHTML = generateStatsContent();
      showToast('Stats refreshed with latest data');
    };

    window.goBackToPrograms = function() {
      const modal = document.getElementById('statsModal');
      if (modal) {
        document.body.removeChild(modal);
      }

      // Clear localStorage when going back
      localStorage.removeItem('statsModalOpen');
      localStorage.removeItem('statsModalTime');
      localStorage.removeItem('statsModalFullscreen');
      showToast('Returned to Programs page', 'info');
    };

    window.showMetricDefinitions = function() {
      const definitions = {
        'Program Views': 'Number of times program pages were viewed by prospective students',
        'Discovery Impressions': 'Times program appeared in search results or recommendations',
        'Click-through Rate': 'Percentage of impressions that resulted in program page views',
        'Applications Started': 'Number of application forms initiated by prospective students',
        'Applications Completed': 'Number of fully submitted applications',
        'Acceptance Rate': 'Percentage of applications that received admission offers',
        'Yield Rate': 'Percentage of admitted students who enrolled in the program',
        'Deferrals': 'Applications postponed to future admission cycles',
        'Withdrawals': 'Applications withdrawn before completion'
      };

      let definitionHTML = '<div style="max-height: 400px; overflow-y: auto;">';
      Object.entries(definitions).forEach(([metric, definition]) => {
        definitionHTML += '<div style="margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px;"><div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">' + metric + '</div><div style="color: #6b7280; font-size: 0.9rem;">' + definition + '</div></div>';
      });
      definitionHTML += '</div>';

      showModal('📖 Metric Definitions', definitionHTML);
    };

    function convertToCSV(data) {
      const headers = Object.keys(data);
      const values = Object.values(data).map(v => v.current || v);
      return headers.join(',') + '\n' + values.join(',');
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function generateReportHTML(data) {
      return '<!DOCTYPE html><html><head><title>' + data.title + '</title><style>body{font-family:Arial,sans-serif;margin:2rem;line-height:1.6}h1{color:#374151}h2{color:#6b7280;border-bottom:1px solid #e5e7eb;padding-bottom:0.5rem}ul{padding-left:1.5rem}</style></head><body><h1>' + data.title + '</h1><p><strong>Generated:</strong> ' + new Date(data.generatedAt).toLocaleString() + '</p><h2>Executive Summary</h2><ul><li>Total Program Views: ' + data.summary.totalViews.toLocaleString() + '</li><li>Total Applications: ' + data.summary.totalApplications.toLocaleString() + '</li><li>Average Acceptance Rate: ' + data.summary.averageAcceptanceRate + '</li><li>Average Yield Rate: ' + data.summary.averageYieldRate + '</li></ul><h2>Recommendations</h2><ul>' + data.recommendations.map(r => '<li>' + r + '</li>').join('') + '</ul></body></html>';
    }

    function showModal(title, content) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 12000; display: flex; align-items: center; justify-content: center;';
      modal.innerHTML = '<div style="width: 90%; max-width: 600px; max-height: 80%; background: white; border-radius: 12px; overflow: hidden;"><div style="background: #5a5bb8; color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;"><h3 style="margin: 0;">' + title + '</h3><button onclick="this.closest(\'.modal\').remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button></div><div style="padding: 1.5rem; overflow-y: auto; max-height: 500px;">' + content + '</div></div>';
      modal.className = 'modal';
      document.body.appendChild(modal);
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const bgColor = type === 'error' ? '#dc2626' : type === 'success' ? '#16a34a' : '#3b82f6';
      toast.style.cssText = 'position: fixed; top: 2rem; right: 2rem; background: ' + bgColor + '; color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 13000; max-width: 300px; font-size: 0.9rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        if (toast && toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 3000);
    }


    window.closeProgramStats = function() {
      const modal = document.getElementById('statsModal');
      if (modal) {
        document.body.removeChild(modal);
      }

      // Restore page visibility and content
      document.documentElement.style.cssText = '';
      document.body.style.cssText = '';

      // Show hidden content
      const mainContent = document.querySelector('main');
      const header = document.querySelector('.header');
      if (mainContent) mainContent.style.display = '';
      if (header) header.style.display = '';

      // Clear localStorage when modal is closed
      localStorage.removeItem('statsModalOpen');
      localStorage.removeItem('statsModalTime');
      localStorage.removeItem('statsModalFullscreen');
    };

    // Application Builder state management
    window.applicationBuilderState = {
      isFullscreen: true,
      currentSection: 'steps',
      lastSaved: new Date(),
      autoSaveInterval: null
    };

    window.openApplicationProcessBuilder = function() {
      // Save current page state for potential refresh
      saveApplicationBuilderState();

      // Set initial fullscreen mode
      document.body.style.overflow = 'hidden';
      document.documentElement.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100vh; overflow: hidden;';

      const modal = document.createElement('div');
      modal.id = 'applicationBuilderModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: #f8fafc;
        z-index: 10000;
        display: flex;
        flex-direction: column;
      `;

      modal.innerHTML = `
        <div style="background: #1e293b; color: white; padding: 1rem 2rem; display: flex; align-items: center; justify-content: between; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <button onclick="backToPrograms()" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Back to Programs">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                <path d="M11.354 4.646L8.707 7.293l2.647 2.647a.5.5 0 0 1-.708.708L8 8.001 5.354 10.647a.5.5 0 1 1-.708-.708L7.293 7.293 4.646 4.646a.5.5 0 1 1 .708-.708L8 6.585l2.646-2.647a.5.5 0 0 1 .708.708z"/>
              </svg>
              <span style="font-size: 0.875rem;">Programs</span>
            </button>
            <svg width="24" height="24" fill="currentColor">
              <rect x="3" y="2" width="18" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M6 6h12M6 9h8M6 12h12M6 15h6"/>
              <circle cx="18" cy="6" r="3" fill="none" stroke="#22c55e" stroke-width="2"/>
              <path d="M16.5 6l1 1 2-2" stroke="#22c55e" stroke-width="2" fill="none"/>
            </svg>
            <h1 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Application Process Builder</h1>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <button onclick="toggleBuilderFullscreen()" id="fullscreenToggle" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Exit Fullscreen">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5zM0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zm10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4z"/>
              </svg>
            </button>
            <button onclick="closeApplicationBuilder()" style="background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Close Builder">&times;</button>
          </div>
        </div>

        <div style="flex: 1; display: flex; overflow: hidden;">
          <div style="width: 250px; background: white; border-right: 1px solid #e5e7eb; overflow-y: auto;">
            <div style="padding: 1.5rem;">
              <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: #374151;">Configuration Sections</h3>
              <nav>
                <div onclick="showBuilderSection('steps')" id="nav-steps" class="nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #3b82f6; color: white;">
                  🔧 Application Steps
                </div>
                <div onclick="showBuilderSection('questions')" id="nav-questions" class="nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  ❓ Custom Questions
                </div>
                <div onclick="showBuilderSection('deadlines')" id="nav-deadlines" class="nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  📅 Deadlines & Rounds
                </div>
                <div onclick="showBuilderSection('fees')" id="nav-fees" class="nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  💰 Fees & Waivers
                </div>
                <div onclick="showBuilderSection('notifications')" id="nav-notifications" class="nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  📧 Notifications
                </div>
                <div onclick="showBuilderSection('preview')" id="nav-preview" class="nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  👁️ Preview & Test
                </div>
                <div onclick="showBuilderSection('export')" id="nav-export" class="nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  📊 Data Export
                </div>
              </nav>
            </div>
          </div>

          <div style="flex: 1; overflow-y: auto; background: #f8fafc;">
            <div id="builderContent" style="padding: 2rem;">
              ${generateStepsBuilderContent()}
            </div>
          </div>
        </div>

        <div style="background: white; border-top: 1px solid #e5e7eb; padding: 1rem 2rem; display: flex; justify-content: between; align-items: center;">
          <div style="display: flex; gap: 1rem;">
            <span style="font-size: 0.875rem; color: #6b7280;">Auto-saved 2 minutes ago</span>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button onclick="previewApplication()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Preview Application</button>
            <button onclick="publishApplication()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Publish Changes</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Start auto-save functionality
      startAutoSave();

      // Update fullscreen button state
      updateFullscreenButton();
    };

    function generateStepsBuilderContent() {
      return `
        <div style="max-width: 1200px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Application Steps Builder</h2>
            <p style="margin: 0; color: #6b7280;">Configure the sequence of steps applicants will complete during the application process.</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Step Library</h3>
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                ${generateStepLibraryItems()}
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Application Flow</h3>
              <div id="applicationFlow" ondrop="dropStep(event)" ondragover="allowDrop(event)" style="min-height: 300px; border: 2px dashed #d1d5db; border-radius: 8px; padding: 1rem; text-align: center; color: #6b7280;">
                Drag steps from the library to build your application flow
              </div>
            </div>
          </div>

          <div style="margin-top: 2rem; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Conditional Logic</h3>
            <p style="margin: 0 0 1rem 0; color: #6b7280;">Show or hide steps based on applicant attributes.</p>
            <div id="conditionalRules"></div>
            <button onclick="addConditionalRule()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">+ Add Conditional Rule</button>
          </div>
        </div>
      `;
    }

    function generateStepLibraryItems() {
      const steps = [
        { id: 'profile', name: 'Profile Questions', icon: '👤', description: 'Basic demographic and contact information' },
        { id: 'essays', name: 'Essays', icon: '📝', description: 'Written responses and personal statements' },
        { id: 'portfolio', name: 'Portfolio Upload', icon: '🎨', description: 'Creative work samples and documents' },
        { id: 'timed-task', name: 'Timed Task', icon: '⏱️', description: 'Time-limited assessments or exercises' },
        { id: 'video', name: 'Video Prompt', icon: '🎥', description: 'Video responses to prompts' },
        { id: 'payment', name: 'Payment Step', icon: '💳', description: 'Application fee processing' },
        { id: 'recommender', name: 'Recommender Request', icon: '✉️', description: 'Request letters of recommendation' },
        { id: 'interview', name: 'Interview Scheduling', icon: '📞', description: 'Schedule interview appointments' }
      ];

      return steps.map(step => `
        <div draggable="true" ondragstart="dragStep(event, '${step.id}')" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
          <span style="font-size: 1.25rem;">${step.icon}</span>
          <div>
            <div style="font-weight: 500; color: #1f2937;">${step.name}</div>
            <div style="font-size: 0.75rem; color: #6b7280;">${step.description}</div>
          </div>
        </div>
      `).join('');
    }

    window.showBuilderSection = function(section) {
      // Update navigation state
      document.querySelectorAll('.nav-item').forEach(item => {
        item.style.background = '#f3f4f6';
        item.style.color = '#374151';
      });

      document.getElementById('nav-' + section).style.background = '#3b82f6';
      document.getElementById('nav-' + section).style.color = 'white';

      // Track current section
      window.applicationBuilderState.currentSection = section;
      saveApplicationBuilderState();

      const content = document.getElementById('builderContent');

      switch(section) {
        case 'steps':
          content.innerHTML = generateStepsBuilderContent();
          break;
        case 'questions':
          content.innerHTML = generateQuestionsBuilderContent();
          break;
        case 'deadlines':
          content.innerHTML = generateDeadlinesContent();
          break;
        case 'fees':
          content.innerHTML = generateFeesContent();
          break;
        case 'notifications':
          content.innerHTML = generateNotificationsContent();
          break;
        case 'preview':
          content.innerHTML = generatePreviewContent();
          break;
        case 'export':
          content.innerHTML = generateExportContent();
          break;
      }
    };

    function generateQuestionsBuilderContent() {
      return `
        <div style="max-width: 1200px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Program-Specific Questions</h2>
            <p style="margin: 0; color: #6b7280;">Create custom questions for your application process.</p>
          </div>

          <div style="display: flex; gap: 2rem;">
            <div style="flex: 1;">
              <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                  <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Question Library</h3>
                  <button onclick="createNewQuestion()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">+ New Question</button>
                </div>
                <div id="questionsList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                  ${generateSampleQuestions()}
                </div>
              </div>
            </div>

            <div style="width: 350px;">
              <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Question Types</h3>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectQuestionType('single-select')">
                    <div style="font-weight: 500;">Single Select</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Multiple choice, one answer</div>
                  </div>
                  <div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectQuestionType('multi-select')">
                    <div style="font-weight: 500;">Multi Select</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Multiple choice, multiple answers</div>
                  </div>
                  <div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectQuestionType('short-text')">
                    <div style="font-weight: 500;">Short Text</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Brief text response</div>
                  </div>
                  <div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectQuestionType('long-text')">
                    <div style="font-weight: 500;">Long Text</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Essay or paragraph response</div>
                  </div>
                  <div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectQuestionType('file-upload')">
                    <div style="font-weight: 500;">File Upload</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Document or media upload</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateSampleQuestions() {
      return `
        <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
            <div style="font-weight: 500; color: #1f2937;">Why are you interested in this program?</div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="editQuestion(1)" style="background: none; border: none; color: #6b7280; cursor: pointer;">✏️</button>
              <button onclick="duplicateQuestion(1)" style="background: none; border: none; color: #6b7280; cursor: pointer;">📋</button>
            </div>
          </div>
          <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">Long Text • Required • 500 word limit</div>
          <div style="display: flex; gap: 0.5rem;">
            <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Graduate Programs</span>
          </div>
        </div>

        <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
            <div style="font-weight: 500; color: #1f2937;">Previous research experience</div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="editQuestion(2)" style="background: none; border: none; color: #6b7280; cursor: pointer;">✏️</button>
              <button onclick="duplicateQuestion(2)" style="background: none; border: none; color: #6b7280; cursor: pointer;">📋</button>
            </div>
          </div>
          <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">Single Select • Optional</div>
          <div style="display: flex; gap: 0.5rem;">
            <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Research Programs</span>
          </div>
        </div>
      `;
    }

    function generateDeadlinesContent() {
      return `
        <div style="max-width: 1200px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Deadlines & Application Rounds</h2>
            <p style="margin: 0; color: #6b7280;">Configure application deadlines, rounds, and capacity management.</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Application Rounds</h3>
                <button onclick="addApplicationRound()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">+ Add Round</button>
              </div>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0; font-weight: 600; color: #1f2937;">Early Decision</h4>
                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem;">
                    <div>Deadline: November 15, 2024</div>
                    <div>Capacity: 50 students (12 applied)</div>
                    <div>Decision by: December 15, 2024</div>
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    <button onclick="editRound('early')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Edit</button>
                    <button onclick="toggleRound('early')" style="background: #fef3c7; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Pause</button>
                  </div>
                </div>

                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0; font-weight: 600; color: #1f2937;">Regular Decision</h4>
                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Upcoming</span>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem;">
                    <div>Deadline: February 1, 2025</div>
                    <div>Capacity: 200 students</div>
                    <div>Decision by: April 1, 2025</div>
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    <button onclick="editRound('regular')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Edit</button>
                    <button onclick="toggleRound('regular')" style="background: #dcfce7; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Activate</button>
                  </div>
                </div>
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Advanced Settings</h3>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Auto-close applications</label>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" checked style="margin: 0;">
                    <span style="font-size: 0.875rem; color: #6b7280;">Automatically close when deadline is reached</span>
                  </div>
                </div>

                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Late submission window</label>
                  <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option>No late submissions</option>
                    <option>1 day grace period</option>
                    <option>3 days grace period</option>
                    <option>1 week grace period</option>
                    <option>Custom period</option>
                  </select>
                </div>

                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Notification timing</label>
                  <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                      <input type="checkbox" checked>
                      <span>2 weeks before deadline</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                      <input type="checkbox" checked>
                      <span>1 week before deadline</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                      <input type="checkbox" checked>
                      <span>24 hours before deadline</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateFeesContent() {
      return `
        <div style="max-width: 1200px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Application Fees & Waivers</h2>
            <p style="margin: 0; color: #6b7280;">Configure application fees and waiver policies.</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Fee Structure</h3>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Application Fee</label>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: #6b7280; font-size: 1.125rem;">$</span>
                    <input type="number" value="75" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  </div>
                </div>

                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">International Fee</label>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: #6b7280; font-size: 1.125rem;">$</span>
                    <input type="number" value="100" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  </div>
                </div>

                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Late Fee</label>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: #6b7280; font-size: 1.125rem;">$</span>
                    <input type="number" value="25" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  </div>
                </div>

                <div>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox">
                    <span style="font-weight: 500; color: #374151;">Enable partial refunds</span>
                  </label>
                </div>
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Fee Waivers</h3>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Waiver Codes</label>
                  <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" placeholder="Enter waiver code" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <button onclick="addWaiverCode()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Add</button>
                  </div>
                  <div style="display: flex; flex-wrap: gap: 0.5rem;">
                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">NEED2024 ✕</span>
                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">VETERAN ✕</span>
                  </div>
                </div>

                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Auto-waive Rules</label>
                  <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox" checked>
                      <span style="font-size: 0.875rem;">First-generation college students</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox">
                      <span style="font-size: 0.875rem;">Students from partner institutions</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox">
                      <span style="font-size: 0.875rem;">Income below threshold</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox">
                      <span style="font-size: 0.875rem;">Military veterans</span>
                    </label>
                  </div>
                </div>

                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Manual Review</label>
                  <textarea placeholder="Instructions for fee waiver review process..." style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; height: 80px;"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateNotificationsContent() {
      return `
        <div style="max-width: 1200px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Email Notifications & Templates</h2>
            <p style="margin: 0; color: #6b7280;">Configure automated email communications throughout the application process.</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Email Templates</h3>
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div onclick="editTemplate('submission')" style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                  <div style="display: flex; justify-content: between; align-items: center;">
                    <div>
                      <div style="font-weight: 500; color: #1f2937;">Application Submitted</div>
                      <div style="font-size: 0.75rem; color: #6b7280;">Sent immediately after submission</div>
                    </div>
                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>
                  </div>
                </div>

                <div onclick="editTemplate('missing-docs')" style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                  <div style="display: flex; justify-content: between; align-items: center;">
                    <div>
                      <div style="font-weight: 500; color: #1f2937;">Missing Documents</div>
                      <div style="font-size: 0.75rem; color: #6b7280;">Reminder for incomplete applications</div>
                    </div>
                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>
                  </div>
                </div>

                <div onclick="editTemplate('decision')" style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                  <div style="display: flex; justify-content: between; align-items: center;">
                    <div>
                      <div style="font-weight: 500; color: #1f2937;">Decision Posted</div>
                      <div style="font-size: 0.75rem; color: #6b7280;">Admission decision notification</div>
                    </div>
                    <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Draft</span>
                  </div>
                </div>

                <button onclick="createNewTemplate()" style="width: 100%; padding: 0.75rem; border: 2px dashed #d1d5db; border-radius: 8px; background: none; color: #6b7280; cursor: pointer;">+ Add New Template</button>
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Template Editor</h3>
              <div id="templateEditor">
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Subject Line</label>
                  <input type="text" value="Welcome! Your application has been received" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>

                <div style="margin-bottom: 1rem;">
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Email Content</label>
                  <textarea style="width: 100%; height: 200px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;">Dear {{applicant_name}},

Thank you for submitting your application to {{program_name}} at {{institution_name}}.

We have received your application on {{submission_date}} and will begin reviewing it shortly.

Application ID: {{application_id}}
Submission Date: {{submission_date}}

Next steps:
- We will review your application materials
- You will receive updates at {{applicant_email}}
- Decisions will be posted by {{decision_date}}

If you have any questions, please contact us at admissions@university.edu.

Best regards,
{{institution_name}} Admissions Team</textarea>
                </div>

                <div style="margin-bottom: 1rem;">
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Available Variables</label>
                  <div style="display: flex; flex-wrap: gap: 0.5rem;">
                    <button onclick="insertVariable('{{applicant_name}}')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">{{applicant_name}}</button>
                    <button onclick="insertVariable('{{program_name}}')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">{{program_name}}</button>
                    <button onclick="insertVariable('{{application_id}}')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">{{application_id}}</button>
                    <button onclick="insertVariable('{{submission_date}}')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">{{submission_date}}</button>
                  </div>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="previewTemplate()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Preview</button>
                  <button onclick="saveTemplate()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Save Template</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generatePreviewContent() {
      return `
        <div style="max-width: 1200px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Preview & Test Mode</h2>
            <p style="margin: 0; color: #6b7280;">Preview the applicant journey and test the application process.</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Application Flow Preview</h3>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">1</span>
                    <span style="font-weight: 500;">Profile Questions</span>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Basic information and demographics</div>
                </div>

                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">2</span>
                    <span style="font-weight: 500;">Academic History</span>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Educational background and transcripts</div>
                </div>

                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">3</span>
                    <span style="font-weight: 500;">Essays & Writing Samples</span>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Personal statement and supplemental essays</div>
                </div>

                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">4</span>
                    <span style="font-weight: 500;">Payment</span>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Application fee ($75)</div>
                </div>
              </div>

              <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                <button onclick="launchTestMode()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Launch Test Mode</button>
                <button onclick="exportPreview()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Export Flow</button>
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Test Scenarios</h3>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="font-weight: 500; margin-bottom: 0.5rem;">Complete Application</div>
                  <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">Test the full application process from start to finish</div>
                  <button onclick="runTestScenario('complete')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Run Test</button>
                </div>

                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="font-weight: 500; margin-bottom: 0.5rem;">Incomplete Application</div>
                  <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">Test incomplete application handling and reminders</div>
                  <button onclick="runTestScenario('incomplete')" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Run Test</button>
                </div>

                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="font-weight: 500; margin-bottom: 0.5rem;">Fee Waiver Application</div>
                  <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">Test application with fee waiver codes</div>
                  <button onclick="runTestScenario('waiver')" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Run Test</button>
                </div>

                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="font-weight: 500; margin-bottom: 0.5rem;">Late Application</div>
                  <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">Test late submission behavior and fees</div>
                  <button onclick="runTestScenario('late')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Run Test</button>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top: 2rem; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Test Results</h3>
            <div id="testResults" style="min-height: 100px; padding: 1rem; background: #f9fafb; border-radius: 8px; color: #6b7280; text-align: center;">
              Run a test scenario to see results here
            </div>
          </div>
        </div>
      `;
    }

    function generateExportContent() {
      return `
        <div style="max-width: 1200px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Data Export Configuration</h2>
            <p style="margin: 0; color: #6b7280;">Configure data export mappings for downstream systems.</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Export Templates</h3>
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="font-weight: 500; color: #1f2937;">Student Information System</div>
                    <button onclick="configureExport('sis')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Configure</button>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Basic applicant data without PII</div>
                </div>

                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="font-weight: 500; color: #1f2937;">CRM Integration</div>
                    <button onclick="configureExport('crm')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Configure</button>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Contact information and engagement data</div>
                </div>

                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="font-weight: 500; color: #1f2937;">Analytics Platform</div>
                    <button onclick="configureExport('analytics')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Configure</button>
                  </div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Anonymized application metrics</div>
                </div>

                <button onclick="createExportTemplate()" style="width: 100%; padding: 0.75rem; border: 2px dashed #d1d5db; border-radius: 8px; background: none; color: #6b7280; cursor: pointer;">+ Add Export Template</button>
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Field Mapping</h3>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Export Format</label>
                  <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option>CSV</option>
                    <option>JSON</option>
                    <option>XML</option>
                    <option>Excel</option>
                  </select>
                </div>

                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Data Classification</label>
                  <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox" checked>
                      <span style="font-size: 0.875rem;">Include non-PII data</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox">
                      <span style="font-size: 0.875rem;">Include PII data (requires approval)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox">
                      <span style="font-size: 0.875rem;">Include sensitive academic data</span>
                    </label>
                  </div>
                </div>

                <div>
                  <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Export Schedule</label>
                  <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option>Manual export only</option>
                    <option>Daily</option>
                    <option>Weekly</option>
                    <option>Monthly</option>
                    <option>Real-time sync</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top: 2rem; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Data Security & Compliance</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
              <div>
                <h4 style="margin: 0 0 0.5rem 0; font-weight: 500; color: #374151;">Access Controls</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" checked>
                    <span style="font-size: 0.875rem;">Require approval for PII exports</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" checked>
                    <span style="font-size: 0.875rem;">Log all export activities</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox">
                    <span style="font-size: 0.875rem;">Encrypt exported files</span>
                  </label>
                </div>
              </div>
              <div>
                <h4 style="margin: 0 0 0.5rem 0; font-weight: 500; color: #374151;">Compliance Features</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" checked>
                    <span style="font-size: 0.875rem;">FERPA compliance</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox">
                    <span style="font-size: 0.875rem;">GDPR compliance</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox">
                    <span style="font-size: 0.875rem;">Data retention policies</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.closeApplicationBuilder = function() {
      const modal = document.getElementById('applicationBuilderModal');
      if (modal) {
        document.body.removeChild(modal);
      }
      document.body.style.overflow = '';
      document.documentElement.style.cssText = '';
    };

    window.dragStep = function(event, stepId) {
      event.dataTransfer.setData('text/plain', stepId);
      event.dataTransfer.effectAllowed = 'copy';
    };

    window.allowDrop = function(event) {
      event.preventDefault();
    };

    window.dropStep = function(event) {
      event.preventDefault();
      const stepId = event.dataTransfer.getData('text/plain');
      const dropZone = document.getElementById('applicationFlow');

      // Get step information
      const stepInfo = getStepInfo(stepId);
      if (!stepInfo) return;

      // Clear the placeholder text if this is the first step
      if (dropZone.children.length === 0 || dropZone.textContent.includes('Drag steps')) {
        dropZone.innerHTML = '';
      }

      // Create step element
      const stepElement = document.createElement('div');
      stepElement.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        position: relative;
        transition: all 0.2s;
      `;
      stepElement.setAttribute('data-step-id', stepId);

      stepElement.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
          <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${dropZone.children.length + 1}</span>
          <span style="font-size: 1.25rem;">${stepInfo.icon}</span>
          <div>
            <div style="font-weight: 500; color: #1f2937;">${stepInfo.name}</div>
            <div style="font-size: 0.75rem; color: #6b7280;">${stepInfo.description}</div>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button onclick="editFlowStep('${stepId}')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #6b7280;">⚙️ Configure</button>
          <button onclick="removeFlowStep(this)" style="background: #fee2e2; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #dc2626;">✕ Remove</button>
        </div>
      `;

      // Add drag handles for reordering
      stepElement.draggable = true;
      stepElement.ondragstart = function(e) {
        e.dataTransfer.setData('text/plain', 'reorder:' + stepId);
        e.dataTransfer.effectAllowed = 'move';
      };

      stepElement.ondragover = function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      };

      stepElement.ondrop = function(e) {
        e.preventDefault();
        const draggedData = e.dataTransfer.getData('text/plain');
        if (draggedData.startsWith('reorder:')) {
          const draggedStepId = draggedData.replace('reorder:', '');
          reorderSteps(draggedStepId, stepId);
        }
      };

      dropZone.appendChild(stepElement);
      updateStepNumbers();

      // Show success feedback
      stepElement.style.transform = 'scale(1.05)';
      setTimeout(() => {
        stepElement.style.transform = 'scale(1)';
      }, 200);
    };

    function getStepInfo(stepId) {
      const steps = {
        'profile': { name: 'Profile Questions', icon: '👤', description: 'Basic demographic and contact information' },
        'essays': { name: 'Essays', icon: '📝', description: 'Written responses and personal statements' },
        'portfolio': { name: 'Portfolio Upload', icon: '🎨', description: 'Creative work samples and documents' },
        'timed-task': { name: 'Timed Task', icon: '⏱️', description: 'Time-limited assessments or exercises' },
        'video': { name: 'Video Prompt', icon: '🎥', description: 'Video responses to prompts' },
        'payment': { name: 'Payment Step', icon: '💳', description: 'Application fee processing' },
        'recommender': { name: 'Recommender Request', icon: '✉️', description: 'Request letters of recommendation' },
        'interview': { name: 'Interview Scheduling', icon: '📞', description: 'Schedule interview appointments' }
      };
      return steps[stepId];
    }

    function updateStepNumbers() {
      const dropZone = document.getElementById('applicationFlow');
      const steps = dropZone.children;
      for (let i = 0; i < steps.length; i++) {
        const numberSpan = steps[i].querySelector('span');
        if (numberSpan) {
          numberSpan.textContent = i + 1;
        }
      }
    }

    window.removeFlowStep = function(button) {
      const stepElement = button.closest('[data-step-id]');
      if (stepElement) {
        stepElement.style.transform = 'scale(0.8)';
        stepElement.style.opacity = '0';
        setTimeout(() => {
          stepElement.remove();
          updateStepNumbers();

          // Show placeholder if no steps remain
          const dropZone = document.getElementById('applicationFlow');
          if (dropZone.children.length === 0) {
            dropZone.innerHTML = 'Drag steps from the library to build your application flow';
            dropZone.style.textAlign = 'center';
            dropZone.style.color = '#6b7280';
          }
        }, 200);
      }
    };

    window.editFlowStep = function(stepId) {
      const stepInfo = getStepInfo(stepId);
      showStepConfigurationModal(stepId, stepInfo);
    };

    function showStepConfigurationModal(stepId, stepInfo) {
      const modal = document.createElement('div');
      modal.id = 'stepConfigModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 20000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">${stepInfo.icon} Configure ${stepInfo.name}</h3>
            <button onclick="closeStepConfigModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Step Title</label>
            <input type="text" value="${stepInfo.name}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Description</label>
            <textarea style="width: 100%; height: 80px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;">${stepInfo.description}</textarea>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Required</label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" checked>
              <span>This step is required for submission</span>
            </label>
          </div>

          ${generateStepSpecificSettings(stepId)}

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeStepConfigModal()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="saveStepConfiguration('${stepId}')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Save Configuration</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function generateStepSpecificSettings(stepId) {
      switch(stepId) {
        case 'essays':
          return `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Word Limit</label>
              <input type="number" value="500" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Number of Essays</label>
              <input type="number" value="2" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
          `;
        case 'portfolio':
          return `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">File Types Allowed</label>
              <div style="display: flex; flex-wrap: gap: 0.5rem;">
                <label><input type="checkbox" checked> PDF</label>
                <label><input type="checkbox" checked> JPG</label>
                <label><input type="checkbox"> PNG</label>
                <label><input type="checkbox"> DOCX</label>
              </div>
            </div>
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Maximum File Size (MB)</label>
              <input type="number" value="10" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
          `;
        case 'payment':
          return `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Application Fee</label>
              <input type="number" value="75" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" checked>
                <span>Allow fee waivers</span>
              </label>
            </div>
          `;
        case 'timed-task':
          return `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Time Limit (minutes)</label>
              <input type="number" value="60" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Task Type</label>
              <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                <option>Writing Sample</option>
                <option>Logic Puzzle</option>
                <option>Case Study</option>
                <option>Technical Challenge</option>
              </select>
            </div>
          `;
        default:
          return `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Additional Instructions</label>
              <textarea placeholder="Add any specific instructions for this step..." style="width: 100%; height: 60px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;"></textarea>
            </div>
          `;
      }
    }

    window.closeStepConfigModal = function() {
      const modal = document.getElementById('stepConfigModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.saveStepConfiguration = function(stepId) {
      // Here you would save the configuration
      alert(`Configuration saved for ${getStepInfo(stepId).name}`);
      closeStepConfigModal();
    };

    function reorderSteps(draggedStepId, targetStepId) {
      const dropZone = document.getElementById('applicationFlow');
      const draggedElement = dropZone.querySelector(`[data-step-id="${draggedStepId}"]`);
      const targetElement = dropZone.querySelector(`[data-step-id="${targetStepId}"]`);

      if (draggedElement && targetElement && draggedElement !== targetElement) {
        const draggedIndex = Array.from(dropZone.children).indexOf(draggedElement);
        const targetIndex = Array.from(dropZone.children).indexOf(targetElement);

        if (draggedIndex < targetIndex) {
          targetElement.parentNode.insertBefore(draggedElement, targetElement.nextSibling);
        } else {
          targetElement.parentNode.insertBefore(draggedElement, targetElement);
        }
        updateStepNumbers();
      }
    }

    window.previewApplication = function() {
      showApplicationPreview();
    };

    window.publishApplication = function() {
      showPublishModal();
    };

    function showApplicationPreview() {
      const modal = document.createElement('div');
      modal.id = 'applicationPreviewModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 25000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
          <div style="background: #1e293b; color: white; padding: 1rem 2rem; display: flex; justify-content: between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">🔍 Application Preview</h3>
            <button onclick="closeApplicationPreview()" style="background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px;">&times;</button>
          </div>

          <div style="flex: 1; overflow-y: auto; padding: 2rem;">
            <div style="max-width: 600px; margin: 0 auto;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="color: #1f2937; margin-bottom: 0.5rem;">Graduate Program Application</h1>
                <p style="color: #6b7280; margin: 0;">This is how applicants will experience your application process</p>
              </div>

              ${generateApplicationPreviewSteps()}

              <div style="margin-top: 2rem; padding: 1.5rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">Application Summary</h4>
                <div style="font-size: 0.875rem; color: #6b7280;">
                  <div>• ${getApplicationFlowSteps().length} total steps configured</div>
                  <div>• Estimated completion time: ${estimateCompletionTime()} minutes</div>
                  <div>• Application fee: $75 (waivers available)</div>
                  <div>• Auto-save enabled for all sections</div>
                </div>
              </div>
            </div>
          </div>

          <div style="background: #f8fafc; border-top: 1px solid #e5e7eb; padding: 1rem 2rem; display: flex; justify-content: between; align-items: center;">
            <div style="display: flex; gap: 1rem;">
              <button onclick="testApplicationFlow()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">🧪 Test Flow</button>
              <button onclick="exportApplicationFlow()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">📤 Export</button>
            </div>
            <button onclick="closeApplicationPreview()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close Preview</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function generateApplicationPreviewSteps() {
      const steps = getApplicationFlowSteps();
      if (steps.length === 0) {
        return `
          <div style="text-align: center; padding: 3rem; color: #6b7280;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
            <h3 style="margin: 0 0 0.5rem 0;">No Steps Configured</h3>
            <p style="margin: 0;">Add steps to your application flow to see the preview</p>
          </div>
        `;
      }

      return steps.map((step, index) => {
        const stepInfo = getStepInfo(step.id);
        return `
          <div style="margin-bottom: 1.5rem; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
            <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="width: 32px; height: 32px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${index + 1}</span>
                <span style="font-size: 1.5rem;">${stepInfo.icon}</span>
                <div>
                  <h4 style="margin: 0; font-size: 1.1rem; color: #1f2937;">${stepInfo.name}</h4>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${stepInfo.description}</p>
                </div>
              </div>
            </div>
            <div style="padding: 1.5rem;">
              ${generateStepPreviewContent(step.id)}
            </div>
          </div>
        `;
      }).join('');
    }

    function generateStepPreviewContent(stepId) {
      switch(stepId) {
        case 'profile':
          return `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">First Name *</label>
                <input type="text" placeholder="Enter first name" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" disabled>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Last Name *</label>
                <input type="text" placeholder="Enter last name" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" disabled>
              </div>
            </div>
          `;
        case 'essays':
          return `
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Personal Statement *</label>
              <textarea placeholder="Why are you interested in this program? (500 word limit)" style="width: 100%; height: 120px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;" disabled></textarea>
              <div style="text-align: right; font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">0 / 500 words</div>
            </div>
          `;
        case 'portfolio':
          return `
            <div style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; background: #f9fafb;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">📎</div>
              <p style="margin: 0; color: #6b7280;">Drag and drop files here or click to browse</p>
              <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #9ca3af;">Supported: PDF, JPG, PNG (max 10MB)</p>
            </div>
          `;
        case 'payment':
          return `
            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
              <h4 style="margin: 0 0 1rem 0;">Application Fee</h4>
              <div style="display: flex; justify-content: between; margin-bottom: 1rem;">
                <span>Application Fee</span>
                <span style="font-weight: 600;">$75.00</span>
              </div>
              <div style="margin-bottom: 1rem;">
                <input type="text" placeholder="Fee waiver code (optional)" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" disabled>
              </div>
              <button style="width: 100%; background: #3b82f6; color: white; border: none; padding: 0.75rem; border-radius: 6px; font-weight: 500;" disabled>Proceed to Payment</button>
            </div>
          `;
        case 'recommender':
          return `
            <div>
              <p style="margin-bottom: 1rem; color: #6b7280;">Request letters of recommendation from your references</p>
              <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                <input type="email" placeholder="Recommender email" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 0.5rem;" disabled>
                <input type="text" placeholder="Recommender name" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" disabled>
              </div>
              <button style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px;" disabled>Send Request</button>
            </div>
          `;
        default:
          return `
            <div style="padding: 2rem; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 6px;">
              <p style="margin: 0;">This step will be configured based on your settings</p>
            </div>
          `;
      }
    }

    function getApplicationFlowSteps() {
      const flowContainer = document.getElementById('applicationFlow');
      if (!flowContainer) return [];

      const stepElements = flowContainer.querySelectorAll('[data-step-id]');
      return Array.from(stepElements).map(el => ({
        id: el.getAttribute('data-step-id'),
        order: Array.from(stepElements).indexOf(el) + 1
      }));
    }

    function estimateCompletionTime() {
      const steps = getApplicationFlowSteps();
      const timeEstimates = {
        'profile': 5,
        'essays': 30,
        'portfolio': 10,
        'timed-task': 60,
        'video': 15,
        'payment': 3,
        'recommender': 5,
        'interview': 2
      };

      return steps.reduce((total, step) => total + (timeEstimates[step.id] || 5), 0);
    }

    function showPublishModal() {
      const modal = document.createElement('div');
      modal.id = 'publishModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 25000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      const steps = getApplicationFlowSteps();
      const hasSteps = steps.length > 0;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="background: #1e293b; color: white; padding: 1.5rem 2rem; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">🚀 Publish Application Changes</h3>
          </div>

          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Publishing Summary</h4>
              ${generatePublishSummary()}
            </div>

            ${hasSteps ? `
              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Pre-Publish Validation</h4>
                ${generateValidationChecks()}
              </div>

              <div style="margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Deployment Options</h4>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="deploymentType" value="immediate" checked>
                    <div>
                      <div style="font-weight: 500;">Publish Immediately</div>
                      <div style="font-size: 0.875rem; color: #6b7280;">Changes go live right away</div>
                    </div>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="deploymentType" value="scheduled">
                    <div>
                      <div style="font-weight: 500;">Schedule for Later</div>
                      <div style="font-size: 0.875rem; color: #6b7280;">Set a specific date and time</div>
                    </div>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="deploymentType" value="staging">
                    <div>
                      <div style="font-weight: 500;">Deploy to Staging</div>
                      <div style="font-size: 0.875rem; color: #6b7280;">Test in staging environment first</div>
                    </div>
                  </label>
                </div>
              </div>

              <div style="margin-bottom: 2rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Deployment Notes</label>
                <textarea placeholder="Add notes about this deployment..." style="width: 100%; height: 80px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
              </div>
            ` : `
              <div style="text-align: center; padding: 2rem; color: #6b7280; background: #fef3c7; border-radius: 8px; margin-bottom: 2rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">⚠️</div>
                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">No Application Steps Configured</h4>
                <p style="margin: 0; color: #92400e;">You need to add at least one step to your application flow before publishing.</p>
              </div>
            `}
          </div>

          <div style="background: #f8fafc; border-top: 1px solid #e5e7eb; padding: 1.5rem 2rem; display: flex; justify-content: between; align-items: center; border-radius: 0 0 12px 12px;">
            <button onclick="closePublishModal()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <div style="display: flex; gap: 1rem;">
              ${hasSteps ? `
                <button onclick="validateAndPublish()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">✅ Validate & Publish</button>
              ` : `
                <button onclick="goToStepsBuilder()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">📝 Configure Steps</button>
              `}
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function generatePublishSummary() {
      const steps = getApplicationFlowSteps();
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
            <div style="font-size: 1.5rem; font-weight: 600; color: #3b82f6;">${steps.length}</div>
            <div style="font-size: 0.875rem; color: #6b7280;">Application Steps</div>
          </div>
          <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
            <div style="font-size: 1.5rem; font-weight: 600; color: #10b981;">${estimateCompletionTime()}</div>
            <div style="font-size: 0.875rem; color: #6b7280;">Est. Minutes</div>
          </div>
        </div>
      `;
    }

    function generateValidationChecks() {
      const steps = getApplicationFlowSteps();
      const checks = [
        { name: 'Application flow configured', status: steps.length > 0 },
        { name: 'Payment step included', status: steps.some(s => s.id === 'payment') },
        { name: 'Required steps marked', status: true },
        { name: 'Email templates configured', status: true },
        { name: 'Deadlines set', status: true }
      ];

      return checks.map(check => `
        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0;">
          <span style="color: ${check.status ? '#10b981' : '#ef4444'}; font-size: 1.25rem;">
            ${check.status ? '✅' : '❌'}
          </span>
          <span style="color: ${check.status ? '#1f2937' : '#ef4444'};">${check.name}</span>
        </div>
      `).join('');
    }

    window.closeApplicationPreview = function() {
      const modal = document.getElementById('applicationPreviewModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.closePublishModal = function() {
      const modal = document.getElementById('publishModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.testApplicationFlow = function() {
      alert('Testing application flow...');
      closeApplicationPreview();
      showBuilderSection('preview');
    };

    window.exportApplicationFlow = function() {
      const steps = getApplicationFlowSteps();
      const config = {
        applicationFlow: steps,
        metadata: {
          created: new Date().toISOString(),
          estimatedTime: estimateCompletionTime(),
          totalSteps: steps.length
        }
      };

      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'application-flow-config.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    window.validateAndPublish = function() {
      // Simulate publishing process
      const modal = document.getElementById('publishModal');
      const content = modal.querySelector('[style*="padding: 2rem"]');

      content.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">🚀</div>
          <h3 style="margin: 0 0 1rem 0; color: #1f2937;">Publishing Application...</h3>
          <div style="background: #f3f4f6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
              <span style="color: #10b981;">✅</span>
              <span>Validating application flow...</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
              <span style="color: #10b981;">✅</span>
              <span>Updating database configuration...</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
              <span style="color: #f59e0b;">⏳</span>
              <span>Deploying to production servers...</span>
            </div>
          </div>
          <p style="color: #6b7280; margin: 0;">This may take a few moments...</p>
        </div>
      `;

      setTimeout(() => {
        content.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem; color: #10b981;">🎉</div>
            <h3 style="margin: 0 0 1rem 0; color: #1f2937;">Application Published Successfully!</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">Your application process is now live and accepting submissions.</p>
            <div style="background: #dcfce7; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
              <div style="font-weight: 500; color: #166534; margin-bottom: 0.5rem;">Published Details:</div>
              <div style="font-size: 0.875rem; color: #166534;">
                <div>• Application URL: /apply/graduate-programs</div>
                <div>• Published at: ${new Date().toLocaleString()}</div>
                <div>• Version: 1.${Math.floor(Math.random() * 100)}</div>
              </div>
            </div>
          </div>
        `;

        const footer = modal.querySelector('[style*="background: #f8fafc"]');
        footer.innerHTML = `
          <button onclick="closePublishModal()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; margin: 0 auto; display: block;">Close</button>
        `;
      }, 3000);
    };

    window.goToStepsBuilder = function() {
      closePublishModal();
      showBuilderSection('steps');
    };

    // Back to Programs functionality
    window.backToPrograms = function() {
      if (confirm('Are you sure you want to go back to Programs? Any unsaved changes will be lost.')) {
        closeApplicationBuilder();
        // Optionally scroll to the programs section or refresh page
        window.location.reload();
      }
    };

    // Fullscreen toggle functionality
    window.toggleBuilderFullscreen = function() {
      const modal = document.getElementById('applicationBuilderModal');
      const fullscreenBtn = document.getElementById('fullscreenToggle');

      if (window.applicationBuilderState.isFullscreen) {
        // Exit fullscreen - make it a normal modal
        modal.style.cssText = `
          position: fixed;
          top: 5%;
          left: 5%;
          width: 90%;
          height: 90%;
          background: #f8fafc;
          z-index: 10000;
          display: flex;
          flex-direction: column;
          border-radius: 12px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        `;

        document.body.style.overflow = '';
        document.documentElement.style.cssText = '';

        window.applicationBuilderState.isFullscreen = false;

        // Update button to show fullscreen icon
        fullscreenBtn.innerHTML = `
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
          </svg>
        `;
        fullscreenBtn.title = 'Enter Fullscreen';

      } else {
        // Enter fullscreen
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100vh;
          background: #f8fafc;
          z-index: 10000;
          display: flex;
          flex-direction: column;
        `;

        document.body.style.overflow = 'hidden';
        document.documentElement.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100vh; overflow: hidden;';

        window.applicationBuilderState.isFullscreen = true;

        // Update button to show exit fullscreen icon
        fullscreenBtn.innerHTML = `
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5zM0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zm10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4z"/>
          </svg>
        `;
        fullscreenBtn.title = 'Exit Fullscreen';
      }

      saveApplicationBuilderState();
    };

    function updateFullscreenButton() {
      const fullscreenBtn = document.getElementById('fullscreenToggle');
      if (fullscreenBtn) {
        if (window.applicationBuilderState.isFullscreen) {
          fullscreenBtn.innerHTML = `
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5zM0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zm10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4z"/>
            </svg>
          `;
          fullscreenBtn.title = 'Exit Fullscreen';
        } else {
          fullscreenBtn.innerHTML = `
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
            </svg>
          `;
          fullscreenBtn.title = 'Enter Fullscreen';
        }
      }
    }

    // Auto-save functionality
    function startAutoSave() {
      // Clear any existing auto-save interval
      if (window.applicationBuilderState.autoSaveInterval) {
        clearInterval(window.applicationBuilderState.autoSaveInterval);
      }

      // Auto-save every 30 seconds
      window.applicationBuilderState.autoSaveInterval = setInterval(() => {
        saveApplicationBuilderState();
        updateLastSavedTime();
      }, 30000);
    }

    function saveApplicationBuilderState() {
      const modal = document.getElementById('applicationBuilderModal');
      const state = {
        isBuilderOpen: !!modal, // Track if builder is currently open
        isFullscreen: window.applicationBuilderState.isFullscreen,
        currentSection: window.applicationBuilderState.currentSection,
        lastSaved: new Date().toISOString(),
        applicationFlow: getApplicationFlowSteps(),
        conditionalRules: getConditionalRules()
      };

      localStorage.setItem('applicationBuilderState', JSON.stringify(state));
    }

    function loadApplicationBuilderState() {
      const saved = localStorage.getItem('applicationBuilderState');
      if (saved) {
        try {
          const state = JSON.parse(saved);
          window.applicationBuilderState = {
            ...window.applicationBuilderState,
            ...state,
            lastSaved: new Date(state.lastSaved)
          };
          return state;
        } catch (e) {
          console.warn('Failed to load application builder state:', e);
        }
      }
      return null;
    }

    function getConditionalRules() {
      const rulesContainer = document.getElementById('conditionalRules');
      if (!rulesContainer) return [];

      const rules = [];
      rulesContainer.querySelectorAll('[id^="rule_"]').forEach(rule => {
        const selects = rule.querySelectorAll('select');
        const input = rule.querySelector('input[type="text"]');
        if (selects.length >= 2 && input) {
          rules.push({
            id: rule.id,
            showStep: selects[0].value,
            condition: selects[1].value,
            value: input.value
          });
        }
      });
      return rules;
    }

    function updateLastSavedTime() {
      const saveText = document.querySelector('[style*="Auto-saved"]');
      if (saveText) {
        const now = new Date();
        const timeAgo = Math.floor((now - window.applicationBuilderState.lastSaved) / 1000);
        let timeText;

        if (timeAgo < 60) {
          timeText = 'just now';
        } else if (timeAgo < 3600) {
          timeText = `${Math.floor(timeAgo / 60)} minutes ago`;
        } else {
          timeText = `${Math.floor(timeAgo / 3600)} hours ago`;
        }

        saveText.textContent = `Auto-saved ${timeText}`;
      }
    }

    // Enhanced close function with state cleanup
    window.closeApplicationBuilder = function() {
      // Clear auto-save interval
      if (window.applicationBuilderState.autoSaveInterval) {
        clearInterval(window.applicationBuilderState.autoSaveInterval);
        window.applicationBuilderState.autoSaveInterval = null;
      }

      const modal = document.getElementById('applicationBuilderModal');
      if (modal) {
        document.body.removeChild(modal);
      }

      // Restore page state
      document.body.style.overflow = '';
      document.documentElement.style.cssText = '';

      // Mark builder as closed and save final state
      const state = {
        isBuilderOpen: false, // Explicitly mark as closed
        isFullscreen: window.applicationBuilderState.isFullscreen,
        currentSection: window.applicationBuilderState.currentSection,
        lastSaved: new Date().toISOString(),
        applicationFlow: getApplicationFlowSteps(),
        conditionalRules: getConditionalRules()
      };
      localStorage.setItem('applicationBuilderState', JSON.stringify(state));
    };

    // Page refresh restoration functionality
    function checkAndRestoreApplicationBuilder() {
      const saved = loadApplicationBuilderState();
      if (saved && saved.isBuilderOpen) {
        // Small delay to ensure page is fully loaded
        setTimeout(() => {
          openApplicationProcessBuilder();

          // Restore the section
          if (saved.currentSection) {
            showBuilderSection(saved.currentSection);
          }

          // Restore fullscreen state
          if (!saved.isFullscreen && window.applicationBuilderState.isFullscreen) {
            toggleBuilderFullscreen();
          }

          // Restore application flow
          if (saved.applicationFlow && saved.applicationFlow.length > 0) {
            restoreApplicationFlow(saved.applicationFlow);
          }

          // Restore conditional rules
          if (saved.conditionalRules && saved.conditionalRules.length > 0) {
            restoreConditionalRules(saved.conditionalRules);
          }
        }, 100);
      }
    }

    function restoreApplicationFlow(steps) {
      const dropZone = document.getElementById('applicationFlow');
      if (!dropZone || steps.length === 0) return;

      // Clear existing content
      dropZone.innerHTML = '';
      dropZone.style.textAlign = 'left';
      dropZone.style.color = 'inherit';

      // Restore each step
      steps.forEach(step => {
        const stepInfo = getStepInfo(step.id);
        if (!stepInfo) return;

        const stepElement = document.createElement('div');
        stepElement.style.cssText = `
          display: flex;
          align-items: center;
          gap: 0.75rem;
          padding: 1rem;
          background: white;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          margin-bottom: 0.75rem;
          position: relative;
          transition: all 0.2s;
        `;
        stepElement.setAttribute('data-step-id', step.id);

        stepElement.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
            <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${step.order}</span>
            <span style="font-size: 1.25rem;">${stepInfo.icon}</span>
            <div>
              <div style="font-weight: 500; color: #1f2937;">${stepInfo.name}</div>
              <div style="font-size: 0.75rem; color: #6b7280;">${stepInfo.description}</div>
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="editFlowStep('${step.id}')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #6b7280;">⚙️ Configure</button>
            <button onclick="removeFlowStep(this)" style="background: #fee2e2; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #dc2626;">✕ Remove</button>
          </div>
        `;

        // Add drag functionality
        stepElement.draggable = true;
        stepElement.ondragstart = function(e) {
          e.dataTransfer.setData('text/plain', 'reorder:' + step.id);
          e.dataTransfer.effectAllowed = 'move';
        };

        stepElement.ondragover = function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        };

        stepElement.ondrop = function(e) {
          e.preventDefault();
          const draggedData = e.dataTransfer.getData('text/plain');
          if (draggedData.startsWith('reorder:')) {
            const draggedStepId = draggedData.replace('reorder:', '');
            reorderSteps(draggedStepId, step.id);
          }
        };

        dropZone.appendChild(stepElement);
      });
    }

    function restoreConditionalRules(rules) {
      const rulesContainer = document.getElementById('conditionalRules');
      if (!rulesContainer || rules.length === 0) return;

      // Clear existing rules
      rulesContainer.innerHTML = '';

      // Restore each rule
      rules.forEach(rule => {
        const ruleElement = document.createElement('div');
        ruleElement.id = rule.id;
        ruleElement.style.cssText = 'border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f9fafb;';

        ruleElement.innerHTML = `
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
            <h4 style="margin: 0; font-weight: 500;">Conditional Rule</h4>
            <button onclick="removeConditionalRule('${rule.id}')" style="background: #fee2e2; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; color: #dc2626; cursor: pointer;">✕</button>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem;">Show Step</label>
              <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option ${rule.showStep === 'Essays' ? 'selected' : ''}>Essays</option>
                <option ${rule.showStep === 'Portfolio Upload' ? 'selected' : ''}>Portfolio Upload</option>
                <option ${rule.showStep === 'Interview' ? 'selected' : ''}>Interview</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem;">When</label>
              <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option ${rule.condition === 'Program Type equals' ? 'selected' : ''}>Program Type equals</option>
                <option ${rule.condition === 'GPA is greater than' ? 'selected' : ''}>GPA is greater than</option>
                <option ${rule.condition === 'Major contains' ? 'selected' : ''}>Major contains</option>
                <option ${rule.condition === 'Application Type is' ? 'selected' : ''}>Application Type is</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem;">Value</label>
              <input type="text" value="${rule.value || ''}" placeholder="Enter value..." style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>
          </div>
        `;

        rulesContainer.appendChild(ruleElement);
      });
    }

    // Conditional Rules functionality
    window.addConditionalRule = function() {
      const rulesContainer = document.getElementById('conditionalRules');
      const ruleId = 'rule_' + Date.now();

      const ruleElement = document.createElement('div');
      ruleElement.id = ruleId;
      ruleElement.style.cssText = 'border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f9fafb;';

      ruleElement.innerHTML = `
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; font-weight: 500;">Conditional Rule</h4>
          <button onclick="removeConditionalRule('${ruleId}')" style="background: #fee2e2; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; color: #dc2626; cursor: pointer;">✕</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div>
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem;">Show Step</label>
            <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
              <option>Essays</option>
              <option>Portfolio Upload</option>
              <option>Interview</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem;">When</label>
            <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
              <option>Program Type equals</option>
              <option>GPA is greater than</option>
              <option>Major contains</option>
              <option>Application Type is</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem;">Value</label>
            <input type="text" placeholder="Enter value..." style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>
        </div>
      `;

      rulesContainer.appendChild(ruleElement);
    };

    window.removeConditionalRule = function(ruleId) {
      const rule = document.getElementById(ruleId);
      if (rule) {
        rule.remove();
      }
    };

    // Questions management functionality
    window.createNewQuestion = function() {
      showQuestionEditor();
    };

    window.editQuestion = function(questionId) {
      showQuestionEditor(questionId);
    };

    window.duplicateQuestion = function(questionId) {
      alert(`Duplicating question ${questionId}...`);
    };

    function showQuestionEditor(questionId = null) {
      const modal = document.createElement('div');
      modal.id = 'questionEditorModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 20000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">${questionId ? 'Edit' : 'Create New'} Question</h3>
            <button onclick="closeQuestionEditor()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Question Text</label>
            <textarea placeholder="Enter your question..." style="width: 100%; height: 80px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;"></textarea>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Question Type</label>
              <select onchange="updateQuestionTypeSettings(this.value)" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                <option value="short-text">Short Text</option>
                <option value="long-text">Long Text</option>
                <option value="single-select">Single Select</option>
                <option value="multi-select">Multi Select</option>
                <option value="file-upload">File Upload</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Required</label>
              <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                <option value="true">Required</option>
                <option value="false">Optional</option>
              </select>
            </div>
          </div>

          <div id="questionTypeSettings">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Character Limit</label>
              <input type="number" value="250" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Help Text</label>
            <textarea placeholder="Optional help text for applicants..." style="width: 100%; height: 60px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;"></textarea>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeQuestionEditor()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="saveQuestion()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Save Question</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    window.closeQuestionEditor = function() {
      const modal = document.getElementById('questionEditorModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.saveQuestion = function() {
      alert('Question saved successfully!');
      closeQuestionEditor();
    };

    window.updateQuestionTypeSettings = function(type) {
      const settings = document.getElementById('questionTypeSettings');
      switch(type) {
        case 'long-text':
          settings.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Word Limit</label>
              <input type="number" value="500" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
          `;
          break;
        case 'single-select':
        case 'multi-select':
          settings.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Options</label>
              <div id="optionsList">
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <input type="text" placeholder="Option 1" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <button onclick="removeOption(this)" style="background: #fee2e2; border: none; padding: 0.5rem; border-radius: 4px; color: #dc2626; cursor: pointer;">✕</button>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <input type="text" placeholder="Option 2" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <button onclick="removeOption(this)" style="background: #fee2e2; border: none; padding: 0.5rem; border-radius: 4px; color: #dc2626; cursor: pointer;">✕</button>
                </div>
              </div>
              <button onclick="addOption()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">+ Add Option</button>
            </div>
          `;
          break;
        case 'file-upload':
          settings.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Allowed File Types</label>
              <div style="display: flex; flex-wrap: gap: 0.5rem;">
                <label><input type="checkbox" checked> PDF</label>
                <label><input type="checkbox"> DOCX</label>
                <label><input type="checkbox"> JPG</label>
                <label><input type="checkbox"> PNG</label>
              </div>
            </div>
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Max File Size (MB)</label>
              <input type="number" value="10" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
          `;
          break;
        default:
          settings.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Character Limit</label>
              <input type="number" value="250" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
          `;
      }
    };

    window.addOption = function() {
      const optionsList = document.getElementById('optionsList');
      const optionDiv = document.createElement('div');
      optionDiv.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
      optionDiv.innerHTML = `
        <input type="text" placeholder="New option" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
        <button onclick="removeOption(this)" style="background: #fee2e2; border: none; padding: 0.5rem; border-radius: 4px; color: #dc2626; cursor: pointer;">✕</button>
      `;
      optionsList.appendChild(optionDiv);
    };

    window.removeOption = function(button) {
      button.parentElement.remove();
    };

    // Application Rounds management
    window.addApplicationRound = function() {
      showRoundEditor();
    };

    window.editRound = function(roundId) {
      showRoundEditor(roundId);
    };

    window.toggleRound = function(roundId) {
      alert(`Toggling ${roundId} round status...`);
    };

    function showRoundEditor(roundId = null) {
      const modal = document.createElement('div');
      modal.id = 'roundEditorModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 20000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">${roundId ? 'Edit' : 'Create'} Application Round</h3>
            <button onclick="closeRoundEditor()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Round Name</label>
            <input type="text" value="${roundId === 'early' ? 'Early Decision' : roundId === 'regular' ? 'Regular Decision' : ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Application Deadline</label>
              <input type="date" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Decision Date</label>
              <input type="date" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Capacity</label>
              <input type="number" value="50" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Status</label>
              <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                <option>Active</option>
                <option>Upcoming</option>
                <option>Closed</option>
                <option>Paused</option>
              </select>
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeRoundEditor()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="saveRound()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Save Round</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    window.closeRoundEditor = function() {
      const modal = document.getElementById('roundEditorModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.saveRound = function() {
      alert('Application round saved successfully!');
      closeRoundEditor();
    };

    // Waiver code management
    window.addWaiverCode = function() {
      alert('Add waiver code functionality implemented');
    };

    // Email template functionality
    window.editTemplate = function(templateId) {
      alert(`Editing ${templateId} template...`);
    };

    window.createNewTemplate = function() {
      alert('Creating new email template...');
    };

    window.insertVariable = function(variable) {
      alert(`Inserting variable: ${variable}`);
    };

    window.previewTemplate = function() {
      alert('Previewing email template...');
    };

    window.saveTemplate = function() {
      alert('Email template saved successfully!');
    };

    // Test scenario functionality
    window.launchTestMode = function() {
      alert('Launching test mode for application preview...');
    };

    window.exportPreview = function() {
      alert('Exporting application flow...');
    };

    window.runTestScenario = function(scenario) {
      const results = document.getElementById('testResults');
      results.innerHTML = `
        <div style="text-align: left;">
          <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Test Results: ${scenario.toUpperCase()}</h4>
          <div style="background: #dcfce7; color: #166534; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
            ✅ Application flow validation passed
          </div>
          <div style="background: #dcfce7; color: #166534; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
            ✅ Email notifications triggered correctly
          </div>
          <div style="background: #dcfce7; color: #166534; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
            ✅ Fee processing ${scenario === 'waiver' ? 'waived' : 'completed'}
          </div>
          <div style="background: #fef3c7; color: #92400e; padding: 0.75rem; border-radius: 6px;">
            ⚠️ ${scenario === 'late' ? 'Late fee applied' : scenario === 'incomplete' ? 'Missing documents detected' : 'All validations passed'}
          </div>
        </div>
      `;
    };

    // Export configuration functionality
    window.configureExport = function(type) {
      alert(`Configuring ${type.toUpperCase()} export settings...`);
    };

    window.createExportTemplate = function() {
      alert('Creating new export template...');
    };

    // Faculty Management System
    window.facultyManagerState = {
      isFullscreen: true,
      currentSection: 'directory',
      faculties: getSampleFaculties(),
      assignments: getSampleAssignments(),
      workloadData: getSampleWorkload()
    };

    window.openFacultyManager = function() {
      // Save current state before opening
      saveFacultyManagerState('opening');

      document.body.style.overflow = 'hidden';
      document.documentElement.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100vh; overflow: hidden;';

      const modal = document.createElement('div');
      modal.id = 'facultyManagerModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: #f8fafc;
        z-index: 10000;
        display: flex;
        flex-direction: column;
      `;

      modal.innerHTML = `
        <div style="background: #1e293b; color: white; padding: 1rem 2rem; display: flex; align-items: center; justify-content: between; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <button onclick="backToPrograms()" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Back to Programs">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM7.5 7.5v-3a.5.5 0 0 1 1 0v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3z"/>
              </svg>
              <span style="font-size: 0.875rem;">Programs</span>
            </button>
            <svg width="24" height="24" fill="currentColor">
              <rect x="4" y="8" width="16" height="24" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M8 14h8M8 18h6M8 22h8M8 26h4"/>
              <circle cx="22" cy="20" r="8" fill="none" stroke="#22c55e" stroke-width="2"/>
              <path d="M18 16l4 4 8-8" stroke="#22c55e" stroke-width="2" fill="none"/>
            </svg>
            <h1 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Faculty Management</h1>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <button onclick="toggleFacultyFullscreen()" id="facultyFullscreenToggle" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: background 0.2s;" title="Exit Fullscreen">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
              </svg>
            </button>
            <button onclick="closeFacultyManager()" style="background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" title="Close Manager">&times;</button>
          </div>
        </div>

        <div style="flex: 1; display: flex; overflow: hidden;">
          <div style="width: 250px; background: white; border-right: 1px solid #e5e7eb; overflow-y: auto;">
            <div style="padding: 1.5rem;">
              <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: #374151;">Faculty Management</h3>
              <nav>
                <div onclick="showFacultySection('directory')" id="faculty-nav-directory" class="faculty-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #3b82f6; color: white;">
                  👨‍🏫 Faculty Directory
                </div>
                <div onclick="showFacultySection('assignments')" id="faculty-nav-assignments" class="faculty-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  📚 Program Assignments
                </div>
                <div onclick="showFacultySection('courses')" id="faculty-nav-courses" class="faculty-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  🎓 Course Assignments
                </div>
                <div onclick="showFacultySection('workload')" id="faculty-nav-workload" class="faculty-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  📊 Workload & Conflicts
                </div>
                <div onclick="showFacultySection('visibility')" id="faculty-nav-visibility" class="faculty-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  👁️ Public Profiles
                </div>
                <div onclick="showFacultySection('import')" id="faculty-nav-import" class="faculty-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  📥 Import Faculty
                </div>
              </nav>
            </div>
          </div>

          <div style="flex: 1; overflow-y: auto; background: #f8fafc;">
            <div id="facultyContent" style="padding: 2rem;">
              ${generateFacultyDirectoryContent()}
            </div>
          </div>
        </div>

        <div style="background: white; border-top: 1px solid #e5e7eb; padding: 1rem 2rem; display: flex; justify-content: between; align-items: center;">
          <div style="display: flex; gap: 1rem;">
            <span style="font-size: 0.875rem; color: #6b7280;">Auto-saved 1 minute ago</span>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button onclick="exportFacultyData()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Export Data</button>
            <button onclick="saveFacultyChanges()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Save Changes</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Restore previous section or default to directory
      const savedState = getFacultyManagerState();
      const sectionToShow = savedState?.currentSection || 'directory';
      showFacultySection(sectionToShow);
    };

    // Faculty Manager state persistence functions
    function saveFacultyManagerState(action, section = null) {
      const state = {
        isOpen: action === 'opening' || action === 'section_change',
        currentSection: section || getFacultyManagerState()?.currentSection || 'directory',
        timestamp: new Date().toISOString()
      };

      if (section) {
        state.currentSection = section;
      }

      localStorage.setItem('facultyManagerCurrentState', JSON.stringify(state));
    }

    function getFacultyManagerState() {
      try {
        const saved = localStorage.getItem('facultyManagerCurrentState');
        return saved ? JSON.parse(saved) : null;
      } catch (error) {
        return null;
      }
    }

    function clearFacultyManagerState() {
      localStorage.removeItem('facultyManagerCurrentState');
    }

    // Auto-restore Faculty Manager on page load if it was open
    function autoRestoreFacultyManager() {
      const savedState = getFacultyManagerState();
      if (savedState && savedState.isOpen) {
        // Check if the state is recent (within 30 minutes)
        const stateAge = Date.now() - new Date(savedState.timestamp).getTime();
        if (stateAge < 30 * 60 * 1000) {
          setTimeout(() => {
            openFacultyManager();
          }, 100);
        } else {
          clearFacultyManagerState();
        }
      }
    }

    // Call auto-restore when the page loads
    document.addEventListener('DOMContentLoaded', autoRestoreFacultyManager);

    function generateFacultyDirectoryContent() {
      return `
        <div style="max-width: 1400px;">
          <div style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Faculty Directory</h2>
              <div style="display: flex; gap: 1rem;">
                <button onclick="addNewFaculty()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">+ Add Faculty</button>
                <button onclick="bulkEditFaculty()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Bulk Edit</button>
              </div>
            </div>
            <p style="margin: 0; color: #6b7280;">Manage faculty profiles, roles, and contact information.</p>
          </div>

          <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
              <input type="text" placeholder="Search faculty by name, department, or expertise..." style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
              <select style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; min-width: 150px;">
                <option>All Departments</option>
                <option>Computer Science</option>
                <option>Mathematics</option>
                <option>Engineering</option>
                <option>Business</option>
              </select>
              <select style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; min-width: 120px;">
                <option>All Status</option>
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            ${generateFacultyCards()}
          </div>
        </div>
      `;
    }

    function generateFacultyCards() {
      const faculties = window.facultyManagerState.faculties;
      return faculties.map(faculty => `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.25rem; flex-shrink: 0;">
              ${faculty.name.split(' ').map(n => n[0]).join('')}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #1f2937; line-height: 1.3;">${faculty.name}</h3>
                <span style="background: ${faculty.status === 'Active' ? '#dcfce7' : '#fee2e2'}; color: ${faculty.status === 'Active' ? '#166534' : '#dc2626'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">${faculty.status}</span>
              </div>
              <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">${faculty.title}</div>
              <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">${faculty.department}</div>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                ${faculty.expertise.slice(0, 3).map(exp => `
                  <span style="background: #f3f4f6; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${exp}</span>
                `).join('')}
                ${faculty.expertise.length > 3 ? `<span style="color: #6b7280; font-size: 0.75rem;">+${faculty.expertise.length - 3} more</span>` : ''}
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <a href="mailto:${faculty.email}" style="color: #6b7280; text-decoration: none; font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem;">
              📧 ${faculty.email}
            </a>
          </div>

          <div style="display: flex; gap: 0.5rem;">
            <button onclick="editFaculty('${faculty.id}')" style="flex: 1; background: #f3f4f6; color: #374151; border: none; padding: 0.5rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Edit Profile</button>
            <button onclick="viewAssignments('${faculty.id}')" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 0.5rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Assignments</button>
            <button onclick="toggleFacultyStatus('${faculty.id}')" style="background: ${faculty.status === 'Active' ? '#fee2e2' : '#dcfce7'}; color: ${faculty.status === 'Active' ? '#dc2626' : '#166534'}; border: none; padding: 0.5rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">
              ${faculty.status === 'Active' ? 'Deactivate' : 'Activate'}
            </button>
          </div>
        </div>
      `).join('');
    }

    function getSampleFaculties() {
      return [
        {
          id: 'fac_001',
          name: 'Dr. Sarah Johnson',
          title: 'Professor of Computer Science',
          department: 'Computer Science',
          email: 'sarah.johnson@university.edu',
          phone: '+1 (555) 123-4567',
          office: 'CS Building, Room 301',
          bio: 'Dr. Johnson specializes in artificial intelligence and machine learning with over 15 years of research experience.',
          expertise: ['Artificial Intelligence', 'Machine Learning', 'Data Science', 'Neural Networks'],
          status: 'Active',
          publicProfile: true
        },
        {
          id: 'fac_002',
          name: 'Prof. Michael Chen',
          title: 'Associate Professor of Mathematics',
          department: 'Mathematics',
          email: 'michael.chen@university.edu',
          phone: '+1 (555) 234-5678',
          office: 'Math Building, Room 205',
          bio: 'Prof. Chen focuses on applied mathematics and statistical modeling.',
          expertise: ['Applied Mathematics', 'Statistics', 'Modeling', 'Analysis'],
          status: 'Active',
          publicProfile: true
        },
        {
          id: 'fac_003',
          name: 'Dr. Emily Rodriguez',
          title: 'Assistant Professor of Engineering',
          department: 'Engineering',
          email: 'emily.rodriguez@university.edu',
          phone: '+1 (555) 345-6789',
          office: 'Engineering Building, Room 150',
          bio: 'Dr. Rodriguez researches sustainable engineering solutions and renewable energy systems.',
          expertise: ['Sustainable Engineering', 'Renewable Energy', 'Environmental Systems'],
          status: 'Active',
          publicProfile: false
        },
        {
          id: 'fac_004',
          name: 'Dr. Robert Taylor',
          title: 'Professor Emeritus',
          department: 'Business',
          email: 'robert.taylor@university.edu',
          phone: '+1 (555) 456-7890',
          office: 'Business Building, Room 400',
          bio: 'Dr. Taylor has extensive experience in strategic management and organizational behavior.',
          expertise: ['Strategic Management', 'Leadership', 'Organizational Behavior'],
          status: 'Inactive',
          publicProfile: true
        }
      ];
    }

    function getSampleAssignments() {
      return [
        { facultyId: 'fac_001', programId: 'cs_masters', role: 'Program Director', startDate: '2023-09-01' },
        { facultyId: 'fac_001', programId: 'cs_phd', role: 'Committee Member', startDate: '2023-09-01' },
        { facultyId: 'fac_002', programId: 'math_masters', role: 'Advisor', startDate: '2023-09-01' },
        { facultyId: 'fac_003', programId: 'eng_masters', role: 'Program Director', startDate: '2024-01-01' }
      ];
    }

    function getSampleWorkload() {
      return [
        { facultyId: 'fac_001', term: 'Fall 2024', courses: 3, totalHours: 9, workload: 85 },
        { facultyId: 'fac_002', term: 'Fall 2024', courses: 2, totalHours: 6, workload: 60 },
        { facultyId: 'fac_003', term: 'Fall 2024', courses: 4, totalHours: 12, workload: 95 },
        { facultyId: 'fac_004', term: 'Fall 2024', courses: 1, totalHours: 3, workload: 30 }
      ];
    }

    // Faculty Management Navigation and Functions
    window.showFacultySection = function(section) {
      document.querySelectorAll('.faculty-nav-item').forEach(item => {
        item.style.background = '#f3f4f6';
        item.style.color = '#374151';
      });

      document.getElementById('faculty-nav-' + section).style.background = '#3b82f6';
      document.getElementById('faculty-nav-' + section).style.color = 'white';

      window.facultyManagerState.currentSection = section;

      // Save current section to state
      saveFacultyManagerState('section_change', section);

      const content = document.getElementById('facultyContent');

      switch(section) {
        case 'directory':
          content.innerHTML = generateFacultyDirectoryContent();
          break;
        case 'assignments':
          content.innerHTML = generateAssignmentsContent();
          break;
        case 'courses':
          content.innerHTML = generateCoursesContent();
          break;
        case 'workload':
          content.innerHTML = generateWorkloadContent();
          break;
        case 'visibility':
          content.innerHTML = generateVisibilityContent();
          break;
        case 'import':
          content.innerHTML = generateImportContent();
          break;
      }
    };

    function generateAssignmentsContent() {
      return `
        <div style="max-width: 1400px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Program Assignments</h2>
            <p style="margin: 0; color: #6b7280;">Manage faculty roles within academic programs.</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Current Assignments</h3>
                <button onclick="addProgramAssignment()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">+ Add Assignment</button>
              </div>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                ${generateProgramAssignmentCards()}
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Assignment Rules</h3>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <h4 style="margin: 0 0 0.5rem 0; font-weight: 500;">Program Director</h4>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">One per program. Full oversight of curriculum, admissions, and faculty coordination.</p>
                </div>
                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <h4 style="margin: 0 0 0.5rem 0; font-weight: 500;">Advisor</h4>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Student mentoring and academic guidance. Multiple advisors allowed.</p>
                </div>
                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <h4 style="margin: 0 0 0.5rem 0; font-weight: 500;">Committee Member</h4>
                  <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Participates in program decisions and curriculum review.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateProgramAssignmentCards() {
      const assignments = window.facultyManagerState.assignments;
      const faculties = window.facultyManagerState.faculties;

      return assignments.map(assignment => {
        const faculty = faculties.find(f => f.id === assignment.facultyId);
        return `
          <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
              <div>
                <h4 style="margin: 0; font-weight: 500; color: #1f2937;">${faculty?.name || 'Unknown Faculty'}</h4>
                <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${assignment.role} - ${assignment.programId}</p>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="editAssignment('${assignment.facultyId}', '${assignment.programId}')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Edit</button>
                <button onclick="removeAssignment('${assignment.facultyId}', '${assignment.programId}')" style="background: #fee2e2; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #dc2626;">Remove</button>
              </div>
            </div>
            <div style="font-size: 0.75rem; color: #6b7280;">Since: ${new Date(assignment.startDate).toLocaleDateString()}</div>
          </div>
        `;
      }).join('');
    }

    function generateCoursesContent() {
      return `
        <div style="max-width: 1400px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Course Assignments</h2>
            <p style="margin: 0; color: #6b7280;">Assign faculty to specific courses with terms and workload percentages.</p>
          </div>

          <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; align-items: end;">
              <div style="flex: 1;">
                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Term</label>
                <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                  <option>Fall 2024</option>
                  <option>Spring 2025</option>
                  <option>Summer 2025</option>
                </select>
              </div>
              <div style="flex: 1;">
                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Department</label>
                <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                  <option>All Departments</option>
                  <option>Computer Science</option>
                  <option>Mathematics</option>
                  <option>Engineering</option>
                </select>
              </div>
              <button onclick="addCourseAssignment()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">+ Add Course Assignment</button>
            </div>
          </div>

          <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Course Assignments - Fall 2024</h3>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="border-bottom: 2px solid #e5e7eb;">
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Course</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Faculty</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Role</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Workload</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Credits</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${generateCourseAssignmentRows()}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function generateCourseAssignmentRows() {
      // Initialize course assignments if not exists
      if (!window.facultyManagerState.courseAssignments) {
        window.facultyManagerState.courseAssignments = [];
      }

      // Get saved course assignments, or use default data if none exist
      let courses = window.facultyManagerState.courseAssignments;

      // If no saved assignments, show some default data
      if (courses.length === 0) {
        courses = [
          {
            id: 'cs401_default',
            courseId: 'CS401',
            courseName: 'Advanced Algorithms',
            faculty: 'Dr. Sarah Johnson',
            role: 'Instructor',
            workload: '100%',
            credits: 3,
            term: 'Fall 2024'
          },
          {
            id: 'cs350_default',
            courseId: 'CS350',
            courseName: 'Machine Learning',
            faculty: 'Dr. Sarah Johnson',
            role: 'Instructor',
            workload: '100%',
            credits: 3,
            term: 'Fall 2024'
          },
          {
            id: 'math301_default',
            courseId: 'MATH301',
            courseName: 'Statistics',
            faculty: 'Prof. Michael Chen',
            role: 'Instructor',
            workload: '100%',
            credits: 3,
            term: 'Fall 2024'
          },
          {
            id: 'eng201_main',
            courseId: 'ENG201',
            courseName: 'Sustainable Systems',
            faculty: 'Dr. Emily Rodriguez',
            role: 'Instructor',
            workload: '80%',
            credits: 3,
            term: 'Fall 2024'
          },
          {
            id: 'eng201_co',
            courseId: 'ENG201',
            courseName: 'Sustainable Systems',
            faculty: 'Dr. Robert Taylor',
            role: 'Co-Instructor',
            workload: '20%',
            credits: 3,
            term: 'Fall 2024'
          }
        ];
      }

      if (courses.length === 0) {
        return `
          <tr>
            <td colspan="6" style="padding: 2rem; text-align: center; color: #6b7280;">
              <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">📚 No course assignments found</div>
              <div>Click "Add Course Assignment" to get started</div>
            </td>
          </tr>
        `;
      }

      return courses.map(course => {
        // Handle both old and new data structures
        const courseId = course.courseId || course.id;
        const courseName = course.courseName || course.name;
        const assignmentId = course.id || courseId + '_' + Date.now();

        return `
        <tr style="border-bottom: 1px solid #f3f4f6;">
          <td style="padding: 0.75rem;">
            <div style="font-weight: 500;">${courseId}</div>
            <div style="font-size: 0.875rem; color: #6b7280;">${courseName}</div>
          </td>
          <td style="padding: 0.75rem;">${course.faculty}</td>
          <td style="padding: 0.75rem;">
            <span style="background: ${course.role === 'Instructor' ? '#dcfce7' : '#dbeafe'}; color: ${course.role === 'Instructor' ? '#166534' : '#1e40af'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${course.role}</span>
          </td>
          <td style="padding: 0.75rem;">${course.workload}</td>
          <td style="padding: 0.75rem;">${course.credits}</td>
          <td style="padding: 0.75rem;">
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="editCourseAssignmentById('${assignmentId}')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Edit</button>
              <button onclick="removeCourseAssignmentById('${assignmentId}')" style="background: #fee2e2; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #dc2626;">Remove</button>
            </div>
          </td>
        </tr>
      `;
      }).join('');
    }

    function generateWorkloadContent() {
      return `
        <div style="max-width: 1400px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Workload & Conflict Analysis</h2>
            <p style="margin: 0; color: #6b7280;">Monitor teaching loads and identify scheduling conflicts.</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
              <div style="font-size: 2rem; font-weight: 600; color: #3b82f6; margin-bottom: 0.5rem;">75%</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Average Workload</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
              <div style="font-size: 2rem; font-weight: 600; color: #ef4444; margin-bottom: 0.5rem;">2</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Overloaded Faculty</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
              <div style="font-size: 2rem; font-weight: 600; color: #f59e0b; margin-bottom: 0.5rem;">3</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Time Conflicts</div>
            </div>
          </div>

          <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Faculty Workload Summary</h3>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="border-bottom: 2px solid #e5e7eb;">
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Faculty</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Courses</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Credit Hours</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Workload</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Status</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Conflicts</th>
                  </tr>
                </thead>
                <tbody>
                  ${generateWorkloadRows()}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function generateWorkloadRows() {
      const workloads = window.facultyManagerState.workloadData;
      const faculties = window.facultyManagerState.faculties;

      return workloads.map(workload => {
        const faculty = faculties.find(f => f.id === workload.facultyId);
        const status = workload.workload > 90 ? 'Overloaded' : workload.workload > 80 ? 'Full' : 'Normal';
        const statusColor = workload.workload > 90 ? '#ef4444' : workload.workload > 80 ? '#f59e0b' : '#10b981';
        const conflicts = Math.floor(Math.random() * 3); // Simulated conflicts

        return `
          <tr style="border-bottom: 1px solid #f3f4f6;">
            <td style="padding: 0.75rem;">${faculty?.name || 'Unknown'}</td>
            <td style="padding: 0.75rem;">${workload.courses}</td>
            <td style="padding: 0.75rem;">${workload.totalHours}</td>
            <td style="padding: 0.75rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="flex: 1; background: #f3f4f6; border-radius: 4px; height: 8px;">
                  <div style="background: ${statusColor}; height: 100%; border-radius: 4px; width: ${workload.workload}%;"></div>
                </div>
                <span style="font-size: 0.875rem; font-weight: 500;">${workload.workload}%</span>
              </div>
            </td>
            <td style="padding: 0.75rem;">
              <span style="background: ${statusColor}20; color: ${statusColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">${status}</span>
            </td>
            <td style="padding: 0.75rem;">
              ${conflicts > 0 ? `<span style="color: #ef4444; font-weight: 500;">${conflicts} conflicts</span>` : '<span style="color: #10b981;">None</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Faculty management utility functions
    window.addNewFaculty = function() {
      showFacultyEditor();
    };

    window.editFaculty = function(facultyId) {
      showFacultyEditor(facultyId);
    };

    window.viewAssignments = function(facultyId) {
      showFacultySection('assignments');
    };

    window.toggleFacultyStatus = function(facultyId) {
      const faculty = window.facultyManagerState.faculties.find(f => f.id === facultyId);
      if (faculty) {
        faculty.status = faculty.status === 'Active' ? 'Inactive' : 'Active';
        showFacultySection('directory'); // Refresh the view
      }
    };

    window.closeFacultyManager = function() {
      const modal = document.getElementById('facultyManagerModal');
      if (modal) {
        document.body.removeChild(modal);
      }
      document.body.style.overflow = '';
      document.documentElement.style.cssText = '';

      // Clear the state when closing
      clearFacultyManagerState();
    };

    window.exportFacultyData = function() {
      const data = {
        faculties: window.facultyManagerState.faculties,
        assignments: window.facultyManagerState.assignments,
        workload: window.facultyManagerState.workloadData,
        exported: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'faculty-data-export.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    window.saveFacultyChanges = function() {
      alert('Faculty changes saved successfully!');
    };

    function generateVisibilityContent() {
      return `
        <div style="max-width: 1400px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Public Profile Visibility</h2>
            <p style="margin: 0; color: #6b7280;">Control which faculty profiles appear on public program pages.</p>
          </div>

          <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; align-items: end;">
              <div style="flex: 1;">
                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Filter by Program</label>
                <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                  <option>All Programs</option>
                  <option>Computer Science Masters</option>
                  <option>Mathematics Masters</option>
                  <option>Engineering Masters</option>
                </select>
              </div>
              <div style="flex: 1;">
                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Visibility Status</label>
                <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                  <option>All Faculty</option>
                  <option>Public Profiles</option>
                  <option>Internal Only</option>
                </select>
              </div>
              <button onclick="bulkUpdateVisibility()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Bulk Update</button>
            </div>
          </div>

          <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Faculty Visibility Settings</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1rem;">
              ${generateVisibilityCards()}
            </div>
          </div>
        </div>
      `;
    }

    function generateVisibilityCards() {
      const faculties = window.facultyManagerState.faculties;
      return faculties.map(faculty => `
        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
          <div style="display: flex; gap: 1rem;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1rem; flex-shrink: 0;">
              ${faculty.name.split(' ').map(n => n[0]).join('')}
            </div>
            <div style="flex: 1; min-width: 0;">
              <h4 style="margin: 0; font-weight: 500; color: #1f2937;">${faculty.name}</h4>
              <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${faculty.title}</p>
              <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${faculty.department}</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: end;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" ${faculty.publicProfile ? 'checked' : ''} onchange="togglePublicProfile('${faculty.id}', this.checked)" style="margin: 0;">
                <span style="font-size: 0.875rem; color: #374151;">Public Profile</span>
              </label>
              <span style="background: ${faculty.publicProfile ? '#dcfce7' : '#fee2e2'}; color: ${faculty.publicProfile ? '#166534' : '#dc2626'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                ${faculty.publicProfile ? 'Public' : 'Internal Only'}
              </span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function generateImportContent() {
      return `
        <div style="max-width: 1400px;">
          <div style="margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Import Faculty Data</h2>
            <p style="margin: 0; color: #6b7280;">Import faculty profiles from CSV files with automatic deduplication.</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Upload CSV File</h3>

              <div style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; margin-bottom: 1.5rem; background: #f9fafb;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">📄</div>
                <p style="margin: 0; color: #6b7280; margin-bottom: 1rem;">Drag and drop your CSV file here or click to browse</p>
                <input type="file" accept=".csv" style="display: none;" id="csvFileInput" onchange="handleCSVUpload(this)">
                <button onclick="document.getElementById('csvFileInput').click()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Choose File</button>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; font-weight: 500;">Import Options</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" checked>
                    <span style="font-size: 0.875rem;">Skip duplicate entries (by email)</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" checked>
                    <span style="font-size: 0.875rem;">Update existing profiles</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="setActiveDefault">
                    <span style="font-size: 0.875rem;">Set all as active by default</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="setPublicDefault">
                    <span style="font-size: 0.875rem;">Enable public profiles by default</span>
                  </label>
                </div>
              </div>

              <button onclick="processCSVImport()" style="width: 100%; background: #10b981; color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Process Import</button>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">CSV Format Requirements</h3>

              <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; font-weight: 500; color: #374151;">Required Columns</h4>
                <ul style="margin: 0; padding-left: 1.25rem; color: #6b7280; font-size: 0.875rem;">
                  <li>name (Full name)</li>
                  <li>email (Unique identifier)</li>
                  <li>department</li>
                  <li>title</li>
                </ul>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; font-weight: 500; color: #374151;">Optional Columns</h4>
                <ul style="margin: 0; padding-left: 1.25rem; color: #6b7280; font-size: 0.875rem;">
                  <li>phone</li>
                  <li>office</li>
                  <li>bio</li>
                  <li>expertise (comma-separated)</li>
                  <li>status (Active/Inactive)</li>
                  <li>publicProfile (true/false)</li>
                </ul>
              </div>

              <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; font-weight: 500; color: #374151;">Sample CSV Format</h4>
                <code style="font-size: 0.75rem; color: #6b7280; white-space: pre;">name,email,department,title,phone,expertise
Dr. John Smith,j.smith@edu,CS,Professor,555-1234,"AI,ML"
Dr. Jane Doe,j.doe@edu,Math,Assoc Prof,555-5678,"Statistics"</code>
              </div>

              <button onclick="downloadSampleCSV()" style="width: 100%; background: #6b7280; color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Download Sample CSV</button>
            </div>
          </div>

          <div id="importResults" style="margin-top: 2rem; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: none;">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Import Results</h3>
            <div id="importResultsContent"></div>
          </div>
        </div>
      `;
    }

    // Additional Faculty Management Functions
    window.togglePublicProfile = function(facultyId, isPublic) {
      const faculty = window.facultyManagerState.faculties.find(f => f.id === facultyId);
      if (faculty) {
        faculty.publicProfile = isPublic;
        faculty.lastModified = new Date().toISOString();

        // Save to localStorage
        localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));

        // Refresh the visibility view to update the status badge
        showFacultySection('visibility');

        // Show success message
        const action = isPublic ? 'enabled' : 'disabled';
        showToast(`Public profile ${action} for ${faculty.name}`, 'success', 3000);
      } else {
        showToast('Faculty member not found', 'error', 3000);
      }
    };

    window.bulkUpdateVisibility = function() {
      const modal = document.createElement('div');
      modal.id = 'bulkVisibilityModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px;">
          <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; color: #374151; font-size: 1.5rem;">Bulk Update Visibility</h3>
              <button onclick="closeBulkVisibilityModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
            </div>
          </div>
          <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select Action:</label>
              <select id="bulkVisibilityAction" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Choose Action</option>
                <option value="enable">Enable Public Profile for All</option>
                <option value="disable">Disable Public Profile for All</option>
                <option value="enable_active">Enable for Active Faculty Only</option>
                <option value="disable_inactive">Disable for Inactive Faculty Only</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Filter by Department (Optional):</label>
              <select id="bulkVisibilityDepartment" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Departments</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Mathematics">Mathematics</option>
                <option value="Engineering">Engineering</option>
                <option value="Business">Business</option>
              </select>
            </div>

            <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
              <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">
                This action will update the public profile visibility for selected faculty members. Changes will be saved immediately.
              </p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button onclick="closeBulkVisibilityModal()"
                      style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer;">
                Cancel
              </button>
              <button onclick="applyBulkVisibilityUpdate()"
                      style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Apply Changes
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.closeBulkVisibilityModal = function() {
      const modal = document.getElementById('bulkVisibilityModal');
      if (modal) modal.remove();
    };

    window.applyBulkVisibilityUpdate = function() {
      const action = document.getElementById('bulkVisibilityAction').value;
      const department = document.getElementById('bulkVisibilityDepartment').value;

      if (!action) {
        showToast('Please select an action', 'error', 3000);
        return;
      }

      if (!window.facultyManagerState.faculties || window.facultyManagerState.faculties.length === 0) {
        showToast('No faculty members found', 'error', 3000);
        return;
      }

      let updatedCount = 0;
      const now = new Date().toISOString();

      window.facultyManagerState.faculties.forEach(faculty => {
        // Apply department filter if specified
        if (department && faculty.department !== department) {
          return;
        }

        let shouldUpdate = false;
        let newVisibility = faculty.publicProfile;

        switch (action) {
          case 'enable':
            newVisibility = true;
            shouldUpdate = true;
            break;
          case 'disable':
            newVisibility = false;
            shouldUpdate = true;
            break;
          case 'enable_active':
            if (faculty.status === 'Active') {
              newVisibility = true;
              shouldUpdate = true;
            }
            break;
          case 'disable_inactive':
            if (faculty.status === 'Inactive') {
              newVisibility = false;
              shouldUpdate = true;
            }
            break;
        }

        if (shouldUpdate && faculty.publicProfile !== newVisibility) {
          faculty.publicProfile = newVisibility;
          faculty.lastModified = now;
          updatedCount++;
        }
      });

      if (updatedCount > 0) {
        localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
        showFacultySection('visibility');
        closeBulkVisibilityModal();
        showToast(`Updated visibility for ${updatedCount} faculty member${updatedCount === 1 ? '' : 's'}`, 'success', 4000);
      } else {
        showToast('No faculty members matched the criteria for update', 'warning', 3000);
      }
    };

    // Store uploaded CSV data globally
    let uploadedCSVData = null;

    window.handleCSVUpload = function(input) {
      if (input.files && input.files[0]) {
        const file = input.files[0];

        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
          showToast('Please select a valid CSV file', 'error', 3000);
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const csvText = e.target.result;
            uploadedCSVData = parseCSV(csvText);
            showToast(`File loaded: ${file.name} (${uploadedCSVData.length - 1} records found)`, 'success', 3000);
          } catch (error) {
            showToast('Error reading CSV file: ' + error.message, 'error', 4000);
            uploadedCSVData = null;
          }
        };
        reader.readAsText(file);
      }
    };

    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim());
      if (lines.length === 0) throw new Error('Empty CSV file');

      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        if (values.length >= headers.length) {
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });
          data.push(row);
        }
      }

      return [headers, ...data];
    }

    window.processCSVImport = function() {
      if (!uploadedCSVData) {
        showToast('Please upload a CSV file first', 'error', 3000);
        return;
      }

      const resultsDiv = document.getElementById('importResults');
      const contentDiv = document.getElementById('importResultsContent');

      // Get import settings
      const setActiveDefault = document.getElementById('setActiveDefault')?.checked || false;
      const setPublicDefault = document.getElementById('setPublicDefault')?.checked || false;

      // Show processing state
      contentDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
          <div style="width: 20px; height: 20px; border: 2px solid #3b82f6; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <span>Processing CSV import...</span>
        </div>
      `;
      resultsDiv.style.display = 'block';

      // Process import after short delay for UX
      setTimeout(() => {
        const importResult = processCSVData(uploadedCSVData, setActiveDefault, setPublicDefault);
        displayImportResults(importResult);
      }, 1000);
    };

    function processCSVData(csvData, setActiveDefault, setPublicDefault) {
      const [headers, ...rows] = csvData;
      const results = {
        imported: 0,
        duplicates: 0,
        errors: 0,
        log: []
      };

      // Initialize faculty state if needed
      if (!window.facultyManagerState.faculties) {
        window.facultyManagerState.faculties = [];
      }

      // Required fields
      const requiredFields = ['name', 'email', 'title', 'department'];

      rows.forEach((row, index) => {
        const rowNumber = index + 2; // +2 because index starts at 0 and header is row 1

        try {
          // Check required fields
          const missingFields = requiredFields.filter(field => !row[field] || row[field].trim() === '');
          if (missingFields.length > 0) {
            results.errors++;
            results.log.push(`❌ Row ${rowNumber}: Missing required fields: ${missingFields.join(', ')}`);
            return;
          }

          // Check for duplicate email
          const existingFaculty = window.facultyManagerState.faculties.find(f => f.email === row.email);
          if (existingFaculty) {
            results.duplicates++;
            results.log.push(`⚠️ ${row.name}: Skipped (duplicate email: ${row.email})`);
            return;
          }

          // Process expertise (comma-separated)
          const expertise = row.expertise ? row.expertise.split(',').map(e => e.trim()).filter(e => e) : [];

          // Create new faculty object
          const newFaculty = {
            id: 'faculty_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            name: row.name.trim(),
            email: row.email.trim(),
            title: row.title.trim(),
            department: row.department.trim(),
            phone: row.phone || '',
            office: row.office || '',
            bio: row.bio || '',
            expertise: expertise,
            status: row.status || (setActiveDefault ? 'Active' : 'Inactive'),
            publicProfile: row.publicProfile === 'true' || setPublicDefault,
            photo: null,
            created: new Date().toISOString(),
            lastModified: new Date().toISOString()
          };

          window.facultyManagerState.faculties.push(newFaculty);
          results.imported++;
          results.log.push(`✅ ${row.name}: Imported successfully`);

        } catch (error) {
          results.errors++;
          results.log.push(`❌ Row ${rowNumber}: Error processing record - ${error.message}`);
        }
      });

      // Save to localStorage
      localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));

      return results;
    }

    function displayImportResults(results) {
      const contentDiv = document.getElementById('importResultsContent');

      contentDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 600; color: #166534;">${results.imported}</div>
            <div style="font-size: 0.875rem; color: #166534;">Records Imported</div>
          </div>
          <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 600; color: #92400e;">${results.duplicates}</div>
            <div style="font-size: 0.875rem; color: #92400e;">Duplicates Skipped</div>
          </div>
          <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 600; color: #dc2626;">${results.errors}</div>
            <div style="font-size: 0.875rem; color: #dc2626;">Errors</div>
          </div>
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem;">
          <h4 style="margin: 0 0 0.5rem 0; font-weight: 500;">Import Log</h4>
          <div style="font-size: 0.875rem; color: #6b7280; max-height: 200px; overflow-y: auto;">
            ${results.log.map(entry => `<div>${entry}</div>`).join('')}
          </div>
        </div>
        ${results.imported > 0 ? `
          <div style="margin-top: 1rem; text-align: center;">
            <button onclick="showFacultySection('directory')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
              View Imported Faculty
            </button>
          </div>
        ` : ''}
      `;

      // Show success message
      if (results.imported > 0) {
        showToast(`Successfully imported ${results.imported} faculty member${results.imported === 1 ? '' : 's'}!`, 'success', 4000);
      }

      // Clear uploaded data
      uploadedCSVData = null;
    };

    window.downloadSampleCSV = function() {
      const csvContent = `name,email,department,title,phone,office,expertise,status,publicProfile
Dr. John Smith,j.smith@university.edu,Computer Science,Professor,+1-555-1234,CS-301,"Artificial Intelligence,Machine Learning",Active,true
Dr. Jane Doe,j.doe@university.edu,Mathematics,Associate Professor,+1-555-5678,MATH-205,"Statistics,Data Analysis",Active,true
Prof. Michael Johnson,m.johnson@university.edu,Engineering,Assistant Professor,+1-555-9012,ENG-150,"Renewable Energy,Sustainability",Active,false`;

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'faculty-import-sample.csv';
      a.click();
      URL.revokeObjectURL(url);
    };

    // Placeholder functions for missing assignment management
    window.addProgramAssignment = function() {
      const modal = document.createElement('div');
      modal.id = 'addProgramAssignmentModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; color: #374151; font-size: 1.5rem;">Add New Program Assignment</h3>
              <button onclick="closeAddProgramModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
            </div>
          </div>
          <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Faculty Member:</label>
              <select id="addProgramFaculty" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Select Faculty Member</option>
                <option value="faculty1">Dr. Sarah Johnson</option>
                <option value="faculty2">Prof. Michael Chen</option>
                <option value="faculty3">Dr. Emily Rodriguez</option>
                <option value="faculty4">Dr. Robert Taylor</option>
                <option value="faculty5">Dr. Lisa Anderson</option>
                <option value="faculty6">Prof. David Kim</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Program:</label>
              <select id="addProgramTitle" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Select Program</option>
                <option value="Computer Science - MS">Computer Science - MS</option>
                <option value="Data Science - MS">Data Science - MS</option>
                <option value="Engineering Management - MS">Engineering Management - MS</option>
                <option value="Cybersecurity - MS">Cybersecurity - MS</option>
                <option value="Software Engineering - MS">Software Engineering - MS</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role:</label>
              <select id="addProgramRole" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Select Role</option>
                <option value="Program Director">Program Director</option>
                <option value="Program Advisor">Program Advisor</option>
                <option value="Committee Member">Committee Member</option>
                <option value="Faculty Liaison">Faculty Liaison</option>
                <option value="Academic Coordinator">Academic Coordinator</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Start Date:</label>
              <input type="date" id="addProgramStartDate"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">End Date (Optional):</label>
              <input type="date" id="addProgramEndDate"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Workload Percentage:</label>
              <input type="number" id="addProgramWorkload" placeholder="e.g., 25" min="0" max="100"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes:</label>
              <textarea id="addProgramNotes" rows="3" placeholder="Additional notes about this assignment..."
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button onclick="closeAddProgramModal()"
                      style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer;">
                Cancel
              </button>
              <button onclick="saveNewProgramAssignment()"
                      style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Add Assignment
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.closeAddProgramModal = function() {
      const modal = document.getElementById('addProgramAssignmentModal');
      if (modal) modal.remove();
    };

    window.saveNewProgramAssignment = function() {
      const facultyId = document.getElementById('addProgramFaculty').value;
      const programTitle = document.getElementById('addProgramTitle').value;
      const role = document.getElementById('addProgramRole').value;
      const startDate = document.getElementById('addProgramStartDate').value;
      const endDate = document.getElementById('addProgramEndDate').value;
      const workloadPercentage = document.getElementById('addProgramWorkload').value;
      const notes = document.getElementById('addProgramNotes').value.trim();

      if (!facultyId || !programTitle || !role || !startDate) {
        showToast('Please fill in all required fields', 'error', 3000);
        return;
      }

      if (workloadPercentage && (parseInt(workloadPercentage) < 0 || parseInt(workloadPercentage) > 100)) {
        showToast('Workload must be between 0% and 100%', 'error', 3000);
        return;
      }

      if (!window.facultyManagerState.assignments) {
        window.facultyManagerState.assignments = [];
      }

      const existingAssignment = window.facultyManagerState.assignments.find(a =>
        a.facultyId === facultyId && a.programTitle === programTitle && a.role === role
      );

      if (existingAssignment) {
        showToast('This program assignment already exists', 'error', 3000);
        return;
      }

      const newAssignment = {
        facultyId,
        programId: 'prog_' + Date.now(),
        programTitle,
        role,
        startDate,
        endDate: endDate || null,
        workloadPercentage: parseInt(workloadPercentage) || 0,
        notes,
        created: new Date().toISOString()
      };

      window.facultyManagerState.assignments.push(newAssignment);
      localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
      showFacultySection('assignments');
      closeAddProgramModal();
      showToast('Program assignment added successfully', 'success', 3000);
    };

    window.editAssignment = function(facultyId, programId) {
      const assignment = window.facultyManagerState.assignments.find(a =>
        a.facultyId === facultyId && a.programId === programId
      );
      const faculty = window.facultyManagerState.faculties.find(f => f.id === facultyId);

      if (!assignment || !faculty) {
        showToast('Assignment not found', 'error', 3000);
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editAssignmentModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; color: #374151; font-size: 1.5rem;">Edit Assignment</h3>
              <button onclick="closeEditAssignmentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
            </div>
          </div>
          <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
              <strong>Faculty:</strong> ${faculty.name} (${faculty.email})
            </div>
            <div style="margin-bottom: 1.5rem;">
              <strong>Program:</strong> ${assignment.programTitle}
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role:</label>
              <select id="editAssignmentRole" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="Program Director" ${assignment.role === 'Program Director' ? 'selected' : ''}>Program Director</option>
                <option value="Program Advisor" ${assignment.role === 'Program Advisor' ? 'selected' : ''}>Program Advisor</option>
                <option value="Committee Member" ${assignment.role === 'Committee Member' ? 'selected' : ''}>Committee Member</option>
                <option value="Faculty Liaison" ${assignment.role === 'Faculty Liaison' ? 'selected' : ''}>Faculty Liaison</option>
                <option value="Academic Coordinator" ${assignment.role === 'Academic Coordinator' ? 'selected' : ''}>Academic Coordinator</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Start Date:</label>
              <input type="date" id="editAssignmentStartDate" value="${assignment.startDate}"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">End Date (Optional):</label>
              <input type="date" id="editAssignmentEndDate" value="${assignment.endDate || ''}"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Workload Percentage:</label>
              <input type="number" id="editAssignmentWorkload" value="${assignment.workloadPercentage || 0}"
                     min="0" max="100" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes:</label>
              <textarea id="editAssignmentNotes" rows="3" placeholder="Additional notes about this assignment..."
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;">${assignment.notes || ''}</textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button onclick="closeEditAssignmentModal()"
                      style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer;">
                Cancel
              </button>
              <button onclick="saveAssignmentEdit('${facultyId}', '${programId}')"
                      style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.closeEditAssignmentModal = function() {
      const modal = document.getElementById('editAssignmentModal');
      if (modal) modal.remove();
    };

    window.saveAssignmentEdit = function(facultyId, programId) {
      const role = document.getElementById('editAssignmentRole').value;
      const startDate = document.getElementById('editAssignmentStartDate').value;
      const endDate = document.getElementById('editAssignmentEndDate').value;
      const workloadPercentage = parseInt(document.getElementById('editAssignmentWorkload').value) || 0;
      const notes = document.getElementById('editAssignmentNotes').value;

      if (!startDate) {
        showToast('Start date is required', 'error', 3000);
        return;
      }

      const assignmentIndex = window.facultyManagerState.assignments.findIndex(a =>
        a.facultyId === facultyId && a.programId === programId
      );

      if (assignmentIndex !== -1) {
        window.facultyManagerState.assignments[assignmentIndex] = {
          ...window.facultyManagerState.assignments[assignmentIndex],
          role,
          startDate,
          endDate: endDate || null,
          workloadPercentage,
          notes,
          lastModified: new Date().toISOString()
        };

        localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
        showFacultySection('assignments');
        closeEditAssignmentModal();
        showToast('Assignment updated successfully', 'success', 3000);
      }
    };

    window.removeAssignment = function(facultyId, programId) {
      const assignment = window.facultyManagerState.assignments.find(a =>
        a.facultyId === facultyId && a.programId === programId
      );
      const faculty = window.facultyManagerState.faculties.find(f => f.id === facultyId);

      if (!assignment || !faculty) {
        showToast('Assignment not found', 'error', 3000);
        return;
      }

      if (confirm(`Are you sure you want to remove ${faculty.name}'s assignment as ${assignment.role} for ${assignment.programTitle}?`)) {
        window.facultyManagerState.assignments = window.facultyManagerState.assignments.filter(a =>
          !(a.facultyId === facultyId && a.programId === programId)
        );

        localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
        showFacultySection('assignments');
        showToast('Assignment removed successfully', 'success', 3000);
      }
    };

    window.addCourseAssignment = function() {
      const modal = document.createElement('div');
      modal.id = 'addCourseAssignmentModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; color: #374151; font-size: 1.5rem;">Add New Course Assignment</h3>
              <button onclick="closeAddCourseModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
            </div>
          </div>
          <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Course ID:</label>
              <input type="text" id="addCourseId" placeholder="e.g., CS401, MATH301"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Course Name:</label>
              <input type="text" id="addCourseName" placeholder="e.g., Advanced Algorithms"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Faculty Member:</label>
              <select id="addCourseFaculty" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Select Faculty Member</option>
                <option value="Dr. Sarah Johnson">Dr. Sarah Johnson</option>
                <option value="Prof. Michael Chen">Prof. Michael Chen</option>
                <option value="Dr. Emily Rodriguez">Dr. Emily Rodriguez</option>
                <option value="Dr. Robert Taylor">Dr. Robert Taylor</option>
                <option value="Dr. Lisa Anderson">Dr. Lisa Anderson</option>
                <option value="Prof. David Kim">Prof. David Kim</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role:</label>
              <select id="addCourseRole" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Select Role</option>
                <option value="Instructor">Instructor</option>
                <option value="Co-Instructor">Co-Instructor</option>
                <option value="Teaching Assistant">Teaching Assistant</option>
                <option value="Lab Supervisor">Lab Supervisor</option>
                <option value="Guest Lecturer">Guest Lecturer</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Workload Percentage:</label>
              <input type="number" id="addCourseWorkload" placeholder="e.g., 100" min="1" max="100"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Credits:</label>
              <input type="number" id="addCourseCredits" placeholder="e.g., 3" min="1" max="6"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Semester/Term:</label>
              <select id="addCourseTerm" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="Fall 2024" selected>Fall 2024</option>
                <option value="Spring 2025">Spring 2025</option>
                <option value="Summer 2025">Summer 2025</option>
                <option value="Fall 2025">Fall 2025</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Schedule:</label>
              <input type="text" id="addCourseSchedule" placeholder="e.g., MWF 10:00-11:00 AM"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes:</label>
              <textarea id="addCourseNotes" rows="3" placeholder="Additional notes about this assignment..."
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button onclick="closeAddCourseModal()"
                      style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer;">
                Cancel
              </button>
              <button onclick="saveNewCourseAssignment()"
                      style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Add Assignment
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.closeAddCourseModal = function() {
      const modal = document.getElementById('addCourseAssignmentModal');
      if (modal) modal.remove();
    };

    window.saveNewCourseAssignment = function() {
      const courseId = document.getElementById('addCourseId').value.trim();
      const courseName = document.getElementById('addCourseName').value.trim();
      const faculty = document.getElementById('addCourseFaculty').value;
      const role = document.getElementById('addCourseRole').value;
      const workload = document.getElementById('addCourseWorkload').value;
      const credits = document.getElementById('addCourseCredits').value;
      const term = document.getElementById('addCourseTerm').value;
      const schedule = document.getElementById('addCourseSchedule').value.trim();
      const notes = document.getElementById('addCourseNotes').value.trim();

      if (!courseId || !courseName || !faculty || !role || !workload || !credits) {
        showToast('Please fill in all required fields', 'error', 3000);
        return;
      }

      if (parseInt(workload) < 1 || parseInt(workload) > 100) {
        showToast('Workload must be between 1% and 100%', 'error', 3000);
        return;
      }

      if (!window.facultyManagerState.courseAssignments) {
        window.facultyManagerState.courseAssignments = [];
      }

      const existingAssignment = window.facultyManagerState.courseAssignments.find(a =>
        a.courseId === courseId && a.faculty === faculty && a.role === role
      );

      if (existingAssignment) {
        showToast('This course assignment already exists', 'error', 3000);
        return;
      }

      const newAssignment = {
        courseId,
        courseName,
        faculty,
        role,
        workload: workload + '%',
        credits: parseInt(credits),
        term,
        schedule,
        notes,
        created: new Date().toISOString()
      };

      window.facultyManagerState.courseAssignments.push(newAssignment);
      localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
      showFacultySection('courses');
      closeAddCourseModal();
      showToast('Course assignment added successfully', 'success', 3000);
    };

    window.editCourseAssignment = function(courseId) {
      const courses = [
        { id: 'CS401', name: 'Advanced Algorithms', faculty: 'Dr. Sarah Johnson', role: 'Instructor', workload: '100%', credits: 3 },
        { id: 'CS350', name: 'Machine Learning', faculty: 'Dr. Sarah Johnson', role: 'Instructor', workload: '100%', credits: 3 },
        { id: 'MATH301', name: 'Statistics', faculty: 'Prof. Michael Chen', role: 'Instructor', workload: '100%', credits: 3 },
        { id: 'ENG201', name: 'Sustainable Systems', faculty: 'Dr. Emily Rodriguez', role: 'Instructor', workload: '80%', credits: 3 },
        { id: 'ENG201-CO', name: 'Sustainable Systems', faculty: 'Dr. Robert Taylor', role: 'Co-Instructor', workload: '20%', credits: 3 }
      ];

      const course = courses.find(c => c.id === courseId || c.id + '-CO' === courseId);
      if (!course) {
        showToast('Course assignment not found', 'error', 3000);
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editCourseAssignmentModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; color: #374151; font-size: 1.5rem;">Edit Course Assignment</h3>
              <button onclick="closeCourseAssignmentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
            </div>
          </div>
          <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
              <strong>Course:</strong> ${course.id} - ${course.name}
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Faculty Member:</label>
              <select id="editCourseFaculty" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="Dr. Sarah Johnson" ${course.faculty === 'Dr. Sarah Johnson' ? 'selected' : ''}>Dr. Sarah Johnson</option>
                <option value="Prof. Michael Chen" ${course.faculty === 'Prof. Michael Chen' ? 'selected' : ''}>Prof. Michael Chen</option>
                <option value="Dr. Emily Rodriguez" ${course.faculty === 'Dr. Emily Rodriguez' ? 'selected' : ''}>Dr. Emily Rodriguez</option>
                <option value="Dr. Robert Taylor" ${course.faculty === 'Dr. Robert Taylor' ? 'selected' : ''}>Dr. Robert Taylor</option>
                <option value="Dr. Lisa Anderson" ${course.faculty === 'Dr. Lisa Anderson' ? 'selected' : ''}>Dr. Lisa Anderson</option>
                <option value="Prof. David Kim" ${course.faculty === 'Prof. David Kim' ? 'selected' : ''}>Prof. David Kim</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role:</label>
              <select id="editCourseRole" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="Instructor" ${course.role === 'Instructor' ? 'selected' : ''}>Instructor</option>
                <option value="Co-Instructor" ${course.role === 'Co-Instructor' ? 'selected' : ''}>Co-Instructor</option>
                <option value="Teaching Assistant" ${course.role === 'Teaching Assistant' ? 'selected' : ''}>Teaching Assistant</option>
                <option value="Lab Supervisor" ${course.role === 'Lab Supervisor' ? 'selected' : ''}>Lab Supervisor</option>
                <option value="Guest Lecturer" ${course.role === 'Guest Lecturer' ? 'selected' : ''}>Guest Lecturer</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Workload Percentage:</label>
              <input type="number" id="editCourseWorkload" value="${parseInt(course.workload)}"
                     min="0" max="100" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Credits:</label>
              <input type="number" id="editCourseCredits" value="${course.credits}"
                     min="1" max="6" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Semester/Term:</label>
              <select id="editCourseTerm" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="Fall 2024" selected>Fall 2024</option>
                <option value="Spring 2025">Spring 2025</option>
                <option value="Summer 2025">Summer 2025</option>
                <option value="Fall 2025">Fall 2025</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Schedule:</label>
              <input type="text" id="editCourseSchedule" placeholder="e.g., MWF 10:00-11:00 AM"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes:</label>
              <textarea id="editCourseNotes" rows="3" placeholder="Additional notes about this assignment..."
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button onclick="closeCourseAssignmentModal()"
                      style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer;">
                Cancel
              </button>
              <button onclick="saveCourseAssignmentEdit('${courseId}')"
                      style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.closeCourseAssignmentModal = function() {
      const modal = document.getElementById('editCourseAssignmentModal');
      if (modal) modal.remove();
    };

    window.saveCourseAssignmentEdit = function(courseId) {
      const faculty = document.getElementById('editCourseFaculty').value;
      const role = document.getElementById('editCourseRole').value;
      const workload = document.getElementById('editCourseWorkload').value;
      const credits = document.getElementById('editCourseCredits').value;
      const term = document.getElementById('editCourseTerm').value;
      const schedule = document.getElementById('editCourseSchedule').value;
      const notes = document.getElementById('editCourseNotes').value;

      if (!faculty || !role || !workload || !credits) {
        showToast('Please fill in all required fields', 'error', 3000);
        return;
      }

      if (parseInt(workload) < 1 || parseInt(workload) > 100) {
        showToast('Workload must be between 1% and 100%', 'error', 3000);
        return;
      }

      if (!window.facultyManagerState.courseAssignments) {
        window.facultyManagerState.courseAssignments = [];
      }

      const assignmentIndex = window.facultyManagerState.courseAssignments.findIndex(a => a.courseId === courseId);
      const assignmentData = {
        courseId,
        faculty,
        role,
        workload: workload + '%',
        credits: parseInt(credits),
        term,
        schedule,
        notes,
        lastModified: new Date().toISOString()
      };

      if (assignmentIndex !== -1) {
        window.facultyManagerState.courseAssignments[assignmentIndex] = assignmentData;
      } else {
        window.facultyManagerState.courseAssignments.push(assignmentData);
      }

      localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
      showFacultySection('courses');
      closeCourseAssignmentModal();
      showToast('Course assignment updated successfully', 'success', 3000);
    };

    window.removeCourseAssignment = function(courseId) {
      const courses = [
        { id: 'CS401', name: 'Advanced Algorithms', faculty: 'Dr. Sarah Johnson', role: 'Instructor', workload: '100%', credits: 3 },
        { id: 'CS350', name: 'Machine Learning', faculty: 'Dr. Sarah Johnson', role: 'Instructor', workload: '100%', credits: 3 },
        { id: 'MATH301', name: 'Statistics', faculty: 'Prof. Michael Chen', role: 'Instructor', workload: '100%', credits: 3 },
        { id: 'ENG201', name: 'Sustainable Systems', faculty: 'Dr. Emily Rodriguez', role: 'Instructor', workload: '80%', credits: 3 },
        { id: 'ENG201-CO', name: 'Sustainable Systems', faculty: 'Dr. Robert Taylor', role: 'Co-Instructor', workload: '20%', credits: 3 }
      ];

      const course = courses.find(c => c.id === courseId || c.id + '-CO' === courseId);
      if (!course) {
        showToast('Course assignment not found', 'error', 3000);
        return;
      }

      if (confirm(`Are you sure you want to remove the course assignment for ${course.id} - ${course.name}?\n\nFaculty: ${course.faculty}\nRole: ${course.role}`)) {
        if (!window.facultyManagerState.courseAssignments) {
          window.facultyManagerState.courseAssignments = [];
        }

        window.facultyManagerState.courseAssignments = window.facultyManagerState.courseAssignments.filter(a => a.courseId !== courseId);
        localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
        showFacultySection('courses');
        showToast('Course assignment removed successfully', 'success', 3000);
      }
    };

    // New functions for assignment-specific operations
    window.editCourseAssignmentById = function(assignmentId) {
      if (!window.facultyManagerState.courseAssignments) {
        window.facultyManagerState.courseAssignments = [];
      }

      const assignment = window.facultyManagerState.courseAssignments.find(a => a.id === assignmentId);

      // If assignment not found in saved data, look in default data
      if (!assignment) {
        const defaultCourses = [
          {
            id: 'cs401_default',
            courseId: 'CS401',
            courseName: 'Advanced Algorithms',
            faculty: 'Dr. Sarah Johnson',
            role: 'Instructor',
            workload: '100%',
            credits: 3,
            term: 'Fall 2024'
          },
          {
            id: 'cs350_default',
            courseId: 'CS350',
            courseName: 'Machine Learning',
            faculty: 'Dr. Sarah Johnson',
            role: 'Instructor',
            workload: '100%',
            credits: 3,
            term: 'Fall 2024'
          },
          {
            id: 'math301_default',
            courseId: 'MATH301',
            courseName: 'Statistics',
            faculty: 'Prof. Michael Chen',
            role: 'Instructor',
            workload: '100%',
            credits: 3,
            term: 'Fall 2024'
          },
          {
            id: 'eng201_main',
            courseId: 'ENG201',
            courseName: 'Sustainable Systems',
            faculty: 'Dr. Emily Rodriguez',
            role: 'Instructor',
            workload: '80%',
            credits: 3,
            term: 'Fall 2024'
          },
          {
            id: 'eng201_co',
            courseId: 'ENG201',
            courseName: 'Sustainable Systems',
            faculty: 'Dr. Robert Taylor',
            role: 'Co-Instructor',
            workload: '20%',
            credits: 3,
            term: 'Fall 2024'
          }
        ];

        const defaultAssignment = defaultCourses.find(c => c.id === assignmentId);
        if (defaultAssignment) {
          // Add default assignment to saved data first
          window.facultyManagerState.courseAssignments.push(defaultAssignment);
          localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
        }
      }

      const courseAssignment = window.facultyManagerState.courseAssignments.find(a => a.id === assignmentId);
      if (!courseAssignment) {
        showToast('Course assignment not found', 'error', 3000);
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'editCourseAssignmentModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; color: #374151; font-size: 1.5rem;">Edit Course Assignment</h3>
              <button onclick="closeCourseAssignmentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
            </div>
          </div>
          <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
              <strong>Course:</strong> ${courseAssignment.courseId} - ${courseAssignment.courseName}
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Faculty Member:</label>
              <select id="editCourseFaculty" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="Dr. Sarah Johnson" ${courseAssignment.faculty === 'Dr. Sarah Johnson' ? 'selected' : ''}>Dr. Sarah Johnson</option>
                <option value="Prof. Michael Chen" ${courseAssignment.faculty === 'Prof. Michael Chen' ? 'selected' : ''}>Prof. Michael Chen</option>
                <option value="Dr. Emily Rodriguez" ${courseAssignment.faculty === 'Dr. Emily Rodriguez' ? 'selected' : ''}>Dr. Emily Rodriguez</option>
                <option value="Dr. Robert Taylor" ${courseAssignment.faculty === 'Dr. Robert Taylor' ? 'selected' : ''}>Dr. Robert Taylor</option>
                <option value="Dr. Lisa Anderson" ${courseAssignment.faculty === 'Dr. Lisa Anderson' ? 'selected' : ''}>Dr. Lisa Anderson</option>
                <option value="Prof. David Kim" ${courseAssignment.faculty === 'Prof. David Kim' ? 'selected' : ''}>Prof. David Kim</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role:</label>
              <select id="editCourseRole" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="Instructor" ${courseAssignment.role === 'Instructor' ? 'selected' : ''}>Instructor</option>
                <option value="Co-Instructor" ${courseAssignment.role === 'Co-Instructor' ? 'selected' : ''}>Co-Instructor</option>
                <option value="Teaching Assistant" ${courseAssignment.role === 'Teaching Assistant' ? 'selected' : ''}>Teaching Assistant</option>
                <option value="Lab Supervisor" ${courseAssignment.role === 'Lab Supervisor' ? 'selected' : ''}>Lab Supervisor</option>
                <option value="Guest Lecturer" ${courseAssignment.role === 'Guest Lecturer' ? 'selected' : ''}>Guest Lecturer</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Workload Percentage:</label>
              <input type="number" id="editCourseWorkload" value="${parseInt(courseAssignment.workload)}"
                     min="0" max="100" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Credits:</label>
              <input type="number" id="editCourseCredits" value="${courseAssignment.credits}"
                     min="1" max="6" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Semester/Term:</label>
              <select id="editCourseTerm" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="Fall 2024" ${courseAssignment.term === 'Fall 2024' ? 'selected' : ''}>Fall 2024</option>
                <option value="Spring 2025" ${courseAssignment.term === 'Spring 2025' ? 'selected' : ''}>Spring 2025</option>
                <option value="Summer 2025" ${courseAssignment.term === 'Summer 2025' ? 'selected' : ''}>Summer 2025</option>
                <option value="Fall 2025" ${courseAssignment.term === 'Fall 2025' ? 'selected' : ''}>Fall 2025</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Schedule:</label>
              <input type="text" id="editCourseSchedule" value="${courseAssignment.schedule || ''}" placeholder="e.g., MWF 10:00-11:00 AM"
                     style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes:</label>
              <textarea id="editCourseNotes" rows="3" placeholder="Additional notes about this assignment..."
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;">${courseAssignment.notes || ''}</textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button onclick="closeCourseAssignmentModal()"
                      style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer;">
                Cancel
              </button>
              <button onclick="saveCourseAssignmentEditById('${assignmentId}')"
                      style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    };

    window.saveCourseAssignmentEditById = function(assignmentId) {
      const faculty = document.getElementById('editCourseFaculty').value;
      const role = document.getElementById('editCourseRole').value;
      const workload = document.getElementById('editCourseWorkload').value;
      const credits = document.getElementById('editCourseCredits').value;
      const term = document.getElementById('editCourseTerm').value;
      const schedule = document.getElementById('editCourseSchedule').value;
      const notes = document.getElementById('editCourseNotes').value;

      if (!faculty || !role || !workload || !credits) {
        showToast('Please fill in all required fields', 'error', 3000);
        return;
      }

      if (parseInt(workload) < 1 || parseInt(workload) > 100) {
        showToast('Workload must be between 1% and 100%', 'error', 3000);
        return;
      }

      const assignmentIndex = window.facultyManagerState.courseAssignments.findIndex(a => a.id === assignmentId);

      if (assignmentIndex !== -1) {
        window.facultyManagerState.courseAssignments[assignmentIndex] = {
          ...window.facultyManagerState.courseAssignments[assignmentIndex],
          faculty,
          role,
          workload: workload + '%',
          credits: parseInt(credits),
          term,
          schedule,
          notes,
          lastModified: new Date().toISOString()
        };

        localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
        showFacultySection('courses');
        closeCourseAssignmentModal();
        showToast('Course assignment updated successfully', 'success', 3000);
      } else {
        showToast('Assignment not found', 'error', 3000);
      }
    };

    window.removeCourseAssignmentById = function(assignmentId) {
      if (!window.facultyManagerState.courseAssignments) {
        window.facultyManagerState.courseAssignments = [];
      }

      const assignment = window.facultyManagerState.courseAssignments.find(a => a.id === assignmentId);

      // If assignment not found in saved data, handle default assignments
      if (!assignment) {
        const defaultCourses = [
          { id: 'cs401_default', courseId: 'CS401', courseName: 'Advanced Algorithms', faculty: 'Dr. Sarah Johnson', role: 'Instructor' },
          { id: 'cs350_default', courseId: 'CS350', courseName: 'Machine Learning', faculty: 'Dr. Sarah Johnson', role: 'Instructor' },
          { id: 'math301_default', courseId: 'MATH301', courseName: 'Statistics', faculty: 'Prof. Michael Chen', role: 'Instructor' },
          { id: 'eng201_main', courseId: 'ENG201', courseName: 'Sustainable Systems', faculty: 'Dr. Emily Rodriguez', role: 'Instructor' },
          { id: 'eng201_co', courseId: 'ENG201', courseName: 'Sustainable Systems', faculty: 'Dr. Robert Taylor', role: 'Co-Instructor' }
        ];

        const defaultAssignment = defaultCourses.find(c => c.id === assignmentId);
        if (!defaultAssignment) {
          showToast('Course assignment not found', 'error', 3000);
          return;
        }

        if (confirm(`Are you sure you want to remove the course assignment for ${defaultAssignment.courseId} - ${defaultAssignment.courseName}?\n\nFaculty: ${defaultAssignment.faculty}\nRole: ${defaultAssignment.role}`)) {
          // For default assignments, just refresh the view (they'll remain as default data)
          showFacultySection('courses');
          showToast('Course assignment removed from view', 'success', 3000);
        }
        return;
      }

      if (confirm(`Are you sure you want to remove the course assignment for ${assignment.courseId} - ${assignment.courseName}?\n\nFaculty: ${assignment.faculty}\nRole: ${assignment.role}`)) {
        window.facultyManagerState.courseAssignments = window.facultyManagerState.courseAssignments.filter(a => a.id !== assignmentId);
        localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));
        showFacultySection('courses');
        showToast('Course assignment removed successfully', 'success', 3000);
      }
    };

    // Missing Faculty Manager Functions
    window.toggleFacultyFullscreen = function() {
      const modal = document.getElementById('facultyManagerModal');
      const fullscreenBtn = document.getElementById('facultyFullscreenToggle');

      if (window.facultyManagerState.isFullscreen) {
        // Exit fullscreen - make it a normal modal
        modal.style.cssText = `
          position: fixed;
          top: 5%;
          left: 5%;
          width: 90%;
          height: 90%;
          background: #f8fafc;
          z-index: 10000;
          display: flex;
          flex-direction: column;
          border-radius: 12px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        `;

        document.body.style.overflow = '';
        document.documentElement.style.cssText = '';

        window.facultyManagerState.isFullscreen = false;

        fullscreenBtn.innerHTML = `
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4z"/>
          </svg>
        `;
        fullscreenBtn.title = 'Enter Fullscreen';

      } else {
        // Enter fullscreen
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100vh;
          background: #f8fafc;
          z-index: 10000;
          display: flex;
          flex-direction: column;
        `;

        document.body.style.overflow = 'hidden';
        document.documentElement.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100vh; overflow: hidden;';

        window.facultyManagerState.isFullscreen = true;

        fullscreenBtn.innerHTML = `
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
          </svg>
        `;
        fullscreenBtn.title = 'Exit Fullscreen';
      }
    };

    window.bulkEditFaculty = function() {
      showBulkEditModal();
    };

    function showBulkEditModal() {
      const modal = document.createElement('div');
      modal.id = 'bulkEditModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 25000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="background: #1e293b; color: white; padding: 1.5rem 2rem; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">📝 Bulk Edit Faculty</h3>
          </div>

          <div style="padding: 2rem;">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Select Faculty</label>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                ${generateFacultyCheckboxes()}
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Bulk Actions</label>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" name="bulkAction" value="status">
                  <span>Change Status</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" name="bulkAction" value="department">
                  <span>Change Department</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" name="bulkAction" value="visibility">
                  <span>Change Public Visibility</span>
                </label>
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">New Value</label>
              <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
          </div>

          <div style="background: #f8fafc; border-top: 1px solid #e5e7eb; padding: 1.5rem 2rem; display: flex; justify-content: between; align-items: center; border-radius: 0 0 12px 12px;">
            <button onclick="closeBulkEditModal()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="applyBulkEdit()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Apply Changes</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function generateFacultyCheckboxes() {
      const faculties = window.facultyManagerState.faculties;
      return faculties.map(faculty => `
        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
          <input type="checkbox" value="${faculty.id}">
          <span>${faculty.name} - ${faculty.department}</span>
        </label>
      `).join('');
    }

    window.closeBulkEditModal = function() {
      const modal = document.getElementById('bulkEditModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.applyBulkEdit = function() {
      alert('Bulk edit applied successfully!');
      closeBulkEditModal();
      showFacultySection('directory'); // Refresh the view
    };

    function showFacultyEditor(facultyId = null) {
      const faculty = facultyId ? window.facultyManagerState.faculties.find(f => f.id === facultyId) : null;
      const isEdit = !!faculty;

      const modal = document.createElement('div');
      modal.id = 'facultyEditorModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 25000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;">
          <div style="background: #1e293b; color: white; padding: 1.5rem 2rem; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">${isEdit ? '✏️ Edit' : '➕ Add'} Faculty Member</h3>
          </div>

          <div style="padding: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Full Name *</label>
                <input type="text" id="facultyName" value="${faculty?.name || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Email *</label>
                <input type="email" id="facultyEmail" value="${faculty?.email || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Title *</label>
                <input type="text" id="facultyTitle" value="${faculty?.title || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Department *</label>
                <select id="facultyDepartment" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                  <option value="Computer Science" ${faculty?.department === 'Computer Science' ? 'selected' : ''}>Computer Science</option>
                  <option value="Mathematics" ${faculty?.department === 'Mathematics' ? 'selected' : ''}>Mathematics</option>
                  <option value="Engineering" ${faculty?.department === 'Engineering' ? 'selected' : ''}>Engineering</option>
                  <option value="Business" ${faculty?.department === 'Business' ? 'selected' : ''}>Business</option>
                </select>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Phone</label>
                <input type="tel" id="facultyPhone" value="${faculty?.phone || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Office</label>
                <input type="text" id="facultyOffice" value="${faculty?.office || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Bio</label>
              <textarea id="facultyBio" style="width: 100%; height: 100px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;">${faculty?.bio || ''}</textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Areas of Expertise (comma-separated)</label>
              <input type="text" id="facultyExpertise" value="${faculty?.expertise?.join(', ') || ''}" placeholder="e.g., Machine Learning, Data Science, AI" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Status</label>
                <select id="facultyStatus" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                  <option value="Active" ${faculty?.status === 'Active' ? 'selected' : ''}>Active</option>
                  <option value="Inactive" ${faculty?.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                </select>
              </div>
              <div>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 2rem;">
                  <input type="checkbox" id="facultyPublicProfile" ${faculty?.publicProfile ? 'checked' : ''}>
                  <span>Public Profile</span>
                </label>
              </div>
            </div>
          </div>

          <div style="background: #f8fafc; border-top: 1px solid #e5e7eb; padding: 1.5rem 2rem; display: flex; justify-content: between; align-items: center; border-radius: 0 0 12px 12px;">
            <button onclick="closeFacultyEditor()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button onclick="saveFacultyProfile('${facultyId || ''}')" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">${isEdit ? 'Save Changes' : 'Add Faculty'}</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    window.closeFacultyEditor = function() {
      const modal = document.getElementById('facultyEditorModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.saveFacultyProfile = function(facultyId) {
      // Collect form data
      const name = document.getElementById('facultyName').value.trim();
      const email = document.getElementById('facultyEmail').value.trim();
      const title = document.getElementById('facultyTitle').value.trim();
      const department = document.getElementById('facultyDepartment').value;
      const phone = document.getElementById('facultyPhone').value.trim();
      const office = document.getElementById('facultyOffice').value.trim();
      const bio = document.getElementById('facultyBio').value.trim();
      const expertiseString = document.getElementById('facultyExpertise').value.trim();
      const status = document.getElementById('facultyStatus').value;
      const publicProfile = document.getElementById('facultyPublicProfile').checked;

      // Validate required fields
      if (!name || !email || !title || !department) {
        showToast('Please fill in all required fields (Name, Email, Title, Department)', 'error', 4000);
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('Please enter a valid email address', 'error', 3000);
        return;
      }

      // Process expertise areas
      const expertise = expertiseString ? expertiseString.split(',').map(item => item.trim()).filter(item => item) : [];

      // Initialize faculty state if needed
      if (!window.facultyManagerState.faculties) {
        window.facultyManagerState.faculties = [];
      }

      const isEdit = !!facultyId;
      let faculty;

      if (isEdit) {
        // Update existing faculty
        const facultyIndex = window.facultyManagerState.faculties.findIndex(f => f.id === facultyId);
        if (facultyIndex === -1) {
          showToast('Faculty member not found', 'error', 3000);
          return;
        }

        faculty = {
          ...window.facultyManagerState.faculties[facultyIndex],
          name,
          email,
          title,
          department,
          phone,
          office,
          bio,
          expertise,
          status,
          publicProfile,
          lastModified: new Date().toISOString()
        };

        window.facultyManagerState.faculties[facultyIndex] = faculty;
      } else {
        // Check for duplicate email
        const existingFaculty = window.facultyManagerState.faculties.find(f => f.email === email);
        if (existingFaculty) {
          showToast('A faculty member with this email already exists', 'error', 4000);
          return;
        }

        // Create new faculty
        faculty = {
          id: 'faculty_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          name,
          email,
          title,
          department,
          phone,
          office,
          bio,
          expertise,
          status: status || 'Active',
          publicProfile,
          photo: null,
          created: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };

        window.facultyManagerState.faculties.push(faculty);
      }

      // Save to localStorage
      localStorage.setItem('facultyManagerState', JSON.stringify(window.facultyManagerState));

      // Show success message
      const action = isEdit ? 'updated' : 'added';
      showToast(`Faculty profile ${action} successfully!`, 'success', 3000);

      // Close editor and refresh directory view
      closeFacultyEditor();
      showFacultySection('directory');
    };

    // Enhanced backToPrograms function for all modals
    window.backToPrograms = function() {
      const modal = document.getElementById('facultyManagerModal') ||
                   document.getElementById('applicationBuilderModal') ||
                   document.getElementById('analyticsDashboardModal');
      if (modal) {
        if (confirm('Are you sure you want to go back to Programs? Any unsaved changes will be lost.')) {
          if (modal.id === 'facultyManagerModal') {
            closeFacultyManager();
          } else if (modal.id === 'applicationBuilderModal') {
            closeApplicationBuilder();
          } else if (modal.id === 'analyticsDashboardModal') {
            closeAnalyticsDashboard();
          }
          window.location.reload();
        }
      } else {
        window.location.reload();
      }
    };

    // Analytics Dashboard System
    let analyticsState = {
      currentSection: 'gallery',
      customReport: {
        name: '',
        metrics: [],
        dimensions: [],
        filters: [],
        timeRange: { start: '', end: '' }
      },
      scheduledReports: [],
      reportTemplates: []
    };

    // Initialize analytics state
    function initializeAnalyticsState() {
      const saved = localStorage.getItem('analyticsState');
      if (saved) {
        try {
          analyticsState = { ...analyticsState, ...JSON.parse(saved) };
        } catch (error) {
          console.warn('Failed to load analytics state:', error);
        }
      }
    }

    function saveAnalyticsState() {
      localStorage.setItem('analyticsState', JSON.stringify(analyticsState));
    }

    // Auto-restore Analytics Dashboard on page load if it was open
    function autoRestoreAnalyticsDashboard() {
      const savedState = getAnalyticsDashboardState();
      if (savedState && savedState.isOpen) {
        const stateAge = Date.now() - new Date(savedState.timestamp).getTime();
        if (stateAge < 30 * 60 * 1000) {
          setTimeout(() => {
            openAnalyticsDashboard();
          }, 100);
        } else {
          clearAnalyticsDashboardState();
        }
      }
    }

    function saveAnalyticsDashboardState(action, section = null) {
      const state = {
        isOpen: action === 'opening' || action === 'section_change',
        currentSection: section || getAnalyticsDashboardState()?.currentSection || 'gallery',
        timestamp: new Date().toISOString()
      };

      if (section) {
        state.currentSection = section;
      }

      localStorage.setItem('analyticsDashboardCurrentState', JSON.stringify(state));
    }

    function getAnalyticsDashboardState() {
      try {
        const saved = localStorage.getItem('analyticsDashboardCurrentState');
        return saved ? JSON.parse(saved) : null;
      } catch (error) {
        return null;
      }
    }

    function clearAnalyticsDashboardState() {
      localStorage.removeItem('analyticsDashboardCurrentState');
    }

    window.openAnalyticsDashboard = function() {
      saveAnalyticsDashboardState('opening');

      document.body.style.overflow = 'hidden';
      document.documentElement.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100vh; overflow: hidden;';

      const modal = document.createElement('div');
      modal.id = 'analyticsDashboardModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: #f8fafc;
        z-index: 10000;
        display: flex;
        flex-direction: column;
      `;

      modal.innerHTML = `
        <div style="background: #1e293b; color: white; padding: 1rem 2rem; display: flex; align-items: center; justify-content: between; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <button onclick="backToPrograms()" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Back to Programs">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM7.5 7.5v-3a.5.5 0 0 1 1 0v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3z"/>
              </svg>
              <span style="font-size: 0.875rem;">Programs</span>
            </button>
            <svg width="24" height="24" fill="currentColor">
              <rect x="4" y="6" width="40" height="28" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
              <rect x="8" y="18" width="6" height="12" fill="#3b82f6" opacity="0.7" rx="1"/>
              <rect x="16" y="20" width="6" height="10" fill="#22c55e" opacity="0.7" rx="1"/>
              <rect x="24" y="22" width="6" height="8" fill="#f59e0b" opacity="0.7" rx="1"/>
              <rect x="32" y="16" width="6" height="14" fill="#8b5cf6" opacity="0.7" rx="1"/>
            </svg>
            <h1 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Analytics Dashboard</h1>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <button onclick="toggleAnalyticsFullscreen()" id="analyticsFullscreenToggle" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: background 0.2s;" title="Toggle Fullscreen">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
              </svg>
            </button>
            <button onclick="closeAnalyticsDashboard()" style="background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" title="Close Dashboard">&times;</button>
          </div>
        </div>

        <div style="flex: 1; display: flex; overflow: hidden;">
          <div style="width: 250px; background: white; border-right: 1px solid #e5e7eb; overflow-y: auto;">
            <div style="padding: 1.5rem;">
              <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: #374151;">Analytics & Reports</h3>
              <nav>
                <div onclick="showAnalyticsSection('gallery')" id="analytics-nav-gallery" class="analytics-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #3b82f6; color: white;">
                  📊 Report Gallery
                </div>
                <div onclick="showAnalyticsSection('builder')" id="analytics-nav-builder" class="analytics-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  🔧 Custom Builder
                </div>
                <div onclick="showAnalyticsSection('scheduled')" id="analytics-nav-scheduled" class="analytics-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  📅 Scheduled Reports
                </div>
                <div onclick="showAnalyticsSection('governance')" id="analytics-nav-governance" class="analytics-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  🔒 Data Governance
                </div>
                <div onclick="showAnalyticsSection('audit')" id="analytics-nav-audit" class="analytics-nav-item" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; background: #f3f4f6; color: #374151;">
                  📋 Audit Trail
                </div>
              </nav>
            </div>
          </div>

          <div style="flex: 1; background: #f8fafc; overflow-y: auto;">
            <div id="analyticsContent" style="padding: 2rem; min-height: 100%;">
              <!-- Content will be loaded here -->
            </div>
          </div>
        </div>

        <div style="background: white; border-top: 1px solid #e5e7eb; padding: 1rem 2rem; display: flex; justify-content: between; align-items: center;">
          <div style="display: flex; gap: 1rem;">
            <span style="font-size: 0.875rem; color: #6b7280;">Last updated: ${new Date().toLocaleTimeString()}</span>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button onclick="refreshAnalyticsData()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">🔄 Refresh Data</button>
            <button onclick="exportAllReports()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">📤 Export All</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Restore previous section or default to gallery
      const savedState = getAnalyticsDashboardState();
      const sectionToShow = savedState?.currentSection || 'gallery';
      showAnalyticsSection(sectionToShow);
    };

    window.showAnalyticsSection = function(section) {
      document.querySelectorAll('.analytics-nav-item').forEach(item => {
        item.style.background = '#f3f4f6';
        item.style.color = '#374151';
      });

      document.getElementById('analytics-nav-' + section).style.background = '#3b82f6';
      document.getElementById('analytics-nav-' + section).style.color = 'white';

      analyticsState.currentSection = section;
      saveAnalyticsDashboardState('section_change', section);

      const content = document.getElementById('analyticsContent');

      switch(section) {
        case 'gallery':
          content.innerHTML = generateReportGalleryContent();
          break;
        case 'builder':
          content.innerHTML = generateCustomBuilderContent();
          break;
        case 'scheduled':
          content.innerHTML = generateScheduledReportsContent();
          break;
        case 'governance':
          content.innerHTML = generateDataGovernanceContent();
          break;
        case 'audit':
          content.innerHTML = generateAuditTrailContent();
          // Initialize the audit table after content is loaded
          setTimeout(() => {
            if (window.auditAllLogs.length > 0) {
              updateAuditTable();
            }
          }, 100);
          break;
      }
    };

    function generateReportGalleryContent() {
      const prebuiltReports = [
        {
          id: 'applications-cycle',
          title: 'Applications by Cycle',
          description: 'Track application volume and trends across admission cycles',
          category: 'Admissions',
          icon: '📈',
          lastRun: '2 hours ago',
          dataPoints: '1,247 applications'
        },
        {
          id: 'conversion-funnel',
          title: 'Conversion Funnel',
          description: 'Analyze conversion rates from inquiry to enrollment',
          category: 'Admissions',
          icon: '🔄',
          lastRun: '4 hours ago',
          dataPoints: '3,456 prospects'
        },
        {
          id: 'geographic-distribution',
          title: 'Geographic Distribution',
          description: 'Student and applicant distribution by region',
          category: 'Demographics',
          icon: '🌍',
          lastRun: '1 day ago',
          dataPoints: '47 states, 12 countries'
        },
        {
          id: 'prerequisite-compliance',
          title: 'Prerequisite Compliance',
          description: 'Monitor prerequisite completion rates and exceptions',
          category: 'Academic',
          icon: '✅',
          lastRun: '6 hours ago',
          dataPoints: '892 students tracked'
        },
        {
          id: 'curriculum-changes',
          title: 'Curriculum Changes Over Time',
          description: 'Track curriculum modifications and their impact',
          category: 'Academic',
          icon: '📚',
          lastRun: '3 days ago',
          dataPoints: '156 changes tracked'
        },
        {
          id: 'enrollment-yield',
          title: 'Enrollment Yield',
          description: 'Yield rates by program and demographic segments',
          category: 'Enrollment',
          icon: '🎯',
          lastRun: '1 hour ago',
          dataPoints: '78% average yield'
        },
        {
          id: 'faculty-workload',
          title: 'Faculty Workload',
          description: 'Teaching loads, research time, and service commitments',
          category: 'Faculty',
          icon: '👨‍🏫',
          lastRun: '5 hours ago',
          dataPoints: '24 faculty members'
        },
        {
          id: 'financial-summary',
          title: 'Financial Summary',
          description: 'Tuition revenue vs scholarship distribution analysis',
          category: 'Financial',
          icon: '💰',
          lastRun: '2 days ago',
          dataPoints: '$2.4M analyzed'
        },
        {
          id: 'exceptions-report',
          title: 'Exceptions Report',
          description: 'Missing requirements and compliance issues at publish',
          category: 'Compliance',
          icon: '⚠️',
          lastRun: '30 minutes ago',
          dataPoints: '23 exceptions found'
        }
      ];

      return `
        <div style="max-width: 1400px;">
          <div style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1f2937;">Report Gallery</h2>
              <div style="display: flex; gap: 1rem;">
                <select style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                  <option>All Categories</option>
                  <option>Admissions</option>
                  <option>Academic</option>
                  <option>Enrollment</option>
                  <option>Faculty</option>
                  <option>Financial</option>
                  <option>Compliance</option>
                </select>
                <button onclick="runAllReports()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Run All Reports</button>
              </div>
            </div>
            <p style="margin: 0; color: #6b7280;">Pre-built reports for leadership, accreditation, and internal review.</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            ${prebuiltReports.map(report => `
              <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                <div style="display: flex; items-start; gap: 1rem; margin-bottom: 1rem;">
                  <div style="font-size: 2rem;">${report.icon}</div>
                  <div style="flex: 1;">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">${report.title}</h3>
                    <span style="background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${report.category}</span>
                  </div>
                </div>
                <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">${report.description}</p>
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem; font-size: 0.75rem; color: #9ca3af;">
                  <span>Last run: ${report.lastRun}</span>
                  <span>${report.dataPoints}</span>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="runReport('${report.id}')" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">🏃 Run Report</button>
                  <button onclick="scheduleReport('${report.id}')" style="background: #f3f4f6; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;" title="Schedule">📅</button>
                  <button onclick="downloadReport('${report.id}')" style="background: #f3f4f6; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;" title="Download">📥</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function generateCustomBuilderContent() {
      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;">🔧 Custom Report Builder</h2>
              <p style="margin: 0; color: #6b7280;">Create custom reports with drag-and-drop builder</p>
            </div>
            <div style="display: flex; gap: 1rem;">
              <button onclick="createNewReport()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">📊 New Report</button>
              <button onclick="loadReportTemplate()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">📋 Templates</button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 250px 1fr; gap: 2rem; height: 600px;">
            <!-- Left Panel - Data Sources -->
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; overflow-y: auto;">
              <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: #1f2937;">Data Sources</h3>

              <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 600; color: #374151;">👥 Student Data</h4>
                <div style="margin-left: 1rem;">
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'student_count')">Student Count</div>
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'enrollment_date')">Enrollment Date</div>
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'program_name')">Program Name</div>
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'gpa')">GPA</div>
                </div>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 600; color: #374151;">👨‍🏫 Faculty Data</h4>
                <div style="margin-left: 1rem;">
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'faculty_count')">Faculty Count</div>
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'course_load')">Course Load</div>
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'department')">Department</div>
                </div>
              </div>

              <div>
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 600; color: #374151;">💰 Financial Data</h4>
                <div style="margin-left: 1rem;">
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'tuition_revenue')">Tuition Revenue</div>
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'budget_allocation')">Budget Allocation</div>
                  <div class="data-field" draggable="true" style="padding: 0.5rem; margin-bottom: 0.25rem; background: #f9fafb; border-radius: 6px; cursor: move; font-size: 0.875rem;" ondragstart="handleDragStart(event, 'cost_per_student')">Cost per Student</div>
                </div>
              </div>
            </div>

            <!-- Right Panel - Report Builder -->
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; font-size: 1rem; font-weight: 600; color: #1f2937;">Report Canvas</h3>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="previewReport()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">👁️ Preview</button>
                  <button onclick="saveReport()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">💾 Save</button>
                </div>
              </div>

              <div id="reportCanvas" style="min-height: 400px; border: 2px dashed #e5e7eb; border-radius: 8px; padding: 2rem; text-align: center; color: #9ca3af;" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
                <div style="font-size: 4rem; margin-bottom: 1rem;">📊</div>
                <p style="font-size: 1.125rem; margin: 0;">Drag and drop data fields here to build your report</p>
                <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;">Fields will automatically generate charts and tables</p>
              </div>

              <div style="margin-top: 1rem; padding: 1.5rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: #1f2937;">📋 Report Configuration</h4>
                  <button onclick="clearReportConfig()" style="background: #f3f4f6; color: #6b7280; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Clear All">🗑️ Clear</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #374151;">Report Name:</label>
                    <input id="reportName" placeholder="Enter report name" oninput="validateReportName()" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#d1d5db'">
                    <div id="reportNameStatus" style="margin-top: 0.25rem; font-size: 0.75rem; min-height: 1rem;"></div>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #374151;">Default Chart Type:</label>
                    <select id="chartType" onchange="updateDefaultChartType()" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; cursor: pointer; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#d1d5db'">
                      <option value="table">📋 Table</option>
                      <option value="bar">📊 Bar Chart</option>
                      <option value="line">📈 Line Chart</option>
                      <option value="pie">🥧 Pie Chart</option>
                      <option value="donut">🍩 Donut Chart</option>
                      <option value="area">📍 Area Chart</option>
                      <option value="histogram">📊 Histogram</option>
                      <option value="scatter">⚡ Scatter Plot</option>
                      <option value="metric">🔢 Metric Display</option>
                    </select>
                  </div>
                </div>

                <div style="background: white; border-radius: 6px; padding: 1rem; border: 1px solid #e5e7eb;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.875rem; font-weight: 500; color: #374151;">Quick Actions:</span>
                    <div id="reportStatus" style="font-size: 0.75rem; color: #6b7280;">No fields added</div>
                  </div>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="autoNameReport()" style="background: #dbeafe; color: #1e40af; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">🎯 Auto-Name</button>
                    <button onclick="duplicateReport()" style="background: #dcfce7; color: #166534; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">📋 Duplicate</button>
                    <button onclick="shareReport()" style="background: #fef3c7; color: #92400e; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">🔗 Share</button>
                    <button onclick="showSavedReports()" style="background: #f3e8ff; color: #7c3aed; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">📁 Saved</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateScheduledReportsContent() {
      const scheduledReports = JSON.parse(localStorage.getItem('reportSchedules') || '[]');

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;">📅 Scheduled Reports</h2>
              <p style="margin: 0; color: #6b7280;">Manage automated report delivery and schedules</p>
            </div>
            <div style="display: flex; gap: 1rem;">
              <button onclick="createSchedule()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">➕ New Schedule</button>
              <button onclick="manageSubscribers()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">👥 Subscribers</button>
            </div>
          </div>

          ${scheduledReports.length === 0 ? `
            <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 4rem; margin-bottom: 1rem;">📅</div>
              <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">No Scheduled Reports</h3>
              <p style="margin: 0 0 2rem 0; color: #6b7280;">Create your first scheduled report to automate delivery</p>
              <button onclick="createSchedule()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Create Schedule</button>
            </div>
          ` : `
            <div style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
              <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 100px; gap: 1rem; font-weight: 600; color: #374151; font-size: 0.875rem;">
                  <div>Report</div>
                  <div>Frequency</div>
                  <div>Next Run</div>
                  <div>Recipients</div>
                  <div>Actions</div>
                </div>
              </div>
              ${scheduledReports.map(schedule => {
                const nextRun = new Date(schedule.startDate);
                nextRun.setDate(nextRun.getDate() + (schedule.frequency === 'daily' ? 1 : schedule.frequency === 'weekly' ? 7 : 30));

                return `
                  <div style="padding: 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 100px; gap: 1rem; align-items: center;">
                    <div>
                      <div style="font-weight: 600; color: #1f2937;">${schedule.reportId}</div>
                      <div style="font-size: 0.875rem; color: #6b7280;">Created ${new Date(schedule.created).toLocaleDateString()}</div>
                    </div>
                    <div>
                      <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize;">${schedule.frequency}</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #374151;">${nextRun.toLocaleDateString()}</div>
                    <div style="font-size: 0.875rem; color: #374151;">${schedule.emails.length} recipients</div>
                    <div style="display: flex; gap: 0.25rem;">
                      <button onclick="editSchedule('${schedule.reportId}')" style="background: #f3f4f6; border: none; padding: 0.25rem; border-radius: 4px; cursor: pointer;" title="Edit">✏️</button>
                      <button onclick="deleteSchedule('${schedule.reportId}')" style="background: #fef2f2; color: #dc2626; border: none; padding: 0.25rem; border-radius: 4px; cursor: pointer;" title="Delete">🗑️</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}

          <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">📊 Delivery Statistics</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="text-align: center; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                  <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">${scheduledReports.length}</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Active Schedules</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                  <div style="font-size: 2rem; font-weight: 700; color: #10b981;">${scheduledReports.reduce((total, s) => total + s.emails.length, 0)}</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">Total Recipients</div>
                </div>
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">⚙️ Quick Actions</h3>
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button onclick="runAllScheduled()" style="background: #10b981; color: white; border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer; text-align: left;">🏃 Run All Now</button>
                <button onclick="exportSchedules()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer; text-align: left;">📤 Export Schedules</button>
                <button onclick="importSchedules()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer; text-align: left;">📥 Import Schedules</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateDataGovernanceContent() {
      // Load policies from localStorage
      const savedPolicies = JSON.parse(localStorage.getItem('dataPolicies') || '[]');

      // Default policies if none exist
      const defaultPolicies = [
        {
          id: 'default-1',
          name: 'Student Records Access',
          description: 'Academic and personal data',
          type: 'access',
          categories: ['student'],
          roles: ['registrar', 'faculty'],
          status: 'active'
        },
        {
          id: 'default-2',
          name: 'Financial Data Access',
          description: 'Tuition and financial records',
          type: 'access',
          categories: ['financial'],
          roles: ['finance'],
          status: 'active'
        },
        {
          id: 'default-3',
          name: 'Research Data Access',
          description: 'Research and analytics',
          type: 'access',
          categories: ['research'],
          roles: ['faculty'],
          status: 'review'
        }
      ];

      const allPolicies = savedPolicies.length > 0 ? [...defaultPolicies, ...savedPolicies] : defaultPolicies;

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;">🔒 Data Governance</h2>
              <p style="margin: 0; color: #6b7280;">Manage data access, privacy, and compliance policies</p>
            </div>
            <div style="display: flex; gap: 1rem;">
              <button onclick="addDataPolicy()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">➕ New Policy</button>
              <button onclick="scanDataCompliance()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">🔍 Scan</button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">🛡️ Data Classification</h3>
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #fef2f2; border-radius: 6px; border-left: 4px solid #dc2626;">
                  <div>
                    <div style="font-weight: 600; color: #dc2626;">🔴 Highly Sensitive</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">SSN, Financial Records, Medical</div>
                  </div>
                  <span style="background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">247 fields</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                  <div>
                    <div style="font-weight: 600; color: #f59e0b;">🟡 Sensitive</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">Email, Phone, Address</div>
                  </div>
                  <span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">834 fields</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #22c55e;">
                  <div>
                    <div style="font-weight: 600; color: #22c55e;">🟢 Public</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">Name, Program, Academic Year</div>
                  </div>
                  <span style="background: #22c55e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">1,523 fields</span>
                </div>
              </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">📋 Compliance Status</h3>
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f0fdf4; border-radius: 6px;">
                  <div>
                    <div style="font-weight: 600; color: #1f2937;">FERPA Compliance</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">Educational records protection</div>
                  </div>
                  <span style="background: #22c55e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">✅ Compliant</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f0fdf4; border-radius: 6px;">
                  <div>
                    <div style="font-weight: 600; color: #1f2937;">GDPR Compliance</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">Data protection regulation</div>
                  </div>
                  <span style="background: #22c55e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">✅ Compliant</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #fef3c7; border-radius: 6px;">
                  <div>
                    <div style="font-weight: 600; color: #1f2937;">SOX Compliance</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">Financial reporting accuracy</div>
                  </div>
                  <span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">⚠️ Review</span>
                </div>
              </div>
            </div>
          </div>

          <div style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
            <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
              <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">🔐 Access Control Policies</h3>
            </div>
            <div style="padding: 1.5rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 100px; gap: 1rem; margin-bottom: 1rem; font-weight: 600; color: #374151; font-size: 0.875rem;">
                <div>Policy Name</div>
                <div>Data Types</div>
                <div>Authorized Roles</div>
                <div>Status</div>
              </div>

              ${allPolicies.map(policy => `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 100px; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid #f3f4f6; align-items: center;">
                  <div>
                    <div style="font-weight: 600; color: #1f2937;">${policy.name}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">${policy.description}</div>
                  </div>
                  <div style="font-size: 0.875rem; color: #374151;">${policy.categories ? policy.categories.map(cat => cat.charAt(0).toUpperCase() + cat.slice(1)).join(', ') : 'General'}</div>
                  <div style="font-size: 0.875rem; color: #374151;">${policy.roles ? policy.roles.map(role => role.charAt(0).toUpperCase() + role.slice(1)).join(', ') : 'All Users'}</div>
                  <span style="background: ${policy.status === 'active' ? '#22c55e' : policy.status === 'review' ? '#f59e0b' : '#6b7280'}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${policy.status ? policy.status.charAt(0).toUpperCase() + policy.status.slice(1) : 'Active'}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Global variables for audit trail
    window.auditCurrentPage = 1;
    window.auditItemsPerPage = 5;
    window.auditFilteredLogs = [];
    window.auditAllLogs = [];

    function generateAuditTrailContent() {
      // Initialize or get audit logs from localStorage
      if (!window.auditAllLogs.length) {
        window.auditAllLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');

        // If no stored logs, create sample data
        if (window.auditAllLogs.length === 0) {
          window.auditAllLogs = [
            { id: 1, action: 'Report Generated', user: 'john.smith@university.edu', target: 'Admissions Analytics', timestamp: new Date(Date.now() - 1000 * 60 * 30), status: 'success', ip: '192.168.1.227', category: 'Report Generation' },
            { id: 2, action: 'Data Export', user: 'jane.doe@university.edu', target: 'Student Records', timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2), status: 'success', ip: '192.168.1.122', category: 'Data Access' },
            { id: 3, action: 'Access Attempt', user: 'unauthorized@external.com', target: 'Financial Data', timestamp: new Date(Date.now() - 1000 * 60 * 60 * 4), status: 'blocked', ip: '192.168.1.123', category: 'Security Events' },
            { id: 4, action: 'Schedule Created', user: 'admin@university.edu', target: 'Weekly Enrollment Report', timestamp: new Date(Date.now() - 1000 * 60 * 60 * 6), status: 'success', ip: '192.168.1.36', category: 'Report Generation' },
            { id: 5, action: 'Policy Updated', user: 'security@university.edu', target: 'Data Governance Policy', timestamp: new Date(Date.now() - 1000 * 60 * 60 * 8), status: 'success', ip: '192.168.1.32', category: 'Policy Changes' },
            { id: 6, action: 'Login Attempt', user: 'hacker@malicious.com', target: 'Admin Panel', timestamp: new Date(Date.now() - 1000 * 60 * 60 * 10), status: 'blocked', ip: '195.133.44.55', category: 'Security Events' },
            { id: 7, action: 'Data Backup', user: 'system@university.edu', target: 'Student Database', timestamp: new Date(Date.now() - 1000 * 60 * 60 * 12), status: 'success', ip: '192.168.1.1', category: 'Data Access' },
            { id: 8, action: 'Report Scheduled', user: 'faculty@university.edu', target: 'Grade Distribution Report', timestamp: new Date(Date.now() - 1000 * 60 * 60 * 14), status: 'success', ip: '192.168.1.45', category: 'Report Generation' }
          ];
          localStorage.setItem('auditLogs', JSON.stringify(window.auditAllLogs));
        }
      }

      window.auditFilteredLogs = window.auditAllLogs;
      const auditLogs = getCurrentPageLogs();

      return `
        <div style="padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;">📋 Audit Trail</h2>
              <p style="margin: 0; color: #6b7280;">Track all system activities and data access events</p>
            </div>
            <div style="display: flex; gap: 1rem;">
              <button onclick="exportAuditLog()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">📤 Export Log</button>
              <button onclick="generateAuditReport()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">📊 Report</button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
            <div style="background: white; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">247</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Total Activities Today</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 2rem; font-weight: 700; color: #22c55e;">234</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Successful Actions</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 2rem; font-weight: 700; color: #dc2626;">13</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Blocked Attempts</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">89</div>
              <div style="font-size: 0.875rem; color: #6b7280;">Unique Users</div>
            </div>
          </div>

          <div style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
            <div style="background: #f9fafb; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Recent Activity</h3>
              <div style="display: flex; gap: 0.5rem;">
                <select id="activityFilter" onchange="filterAuditActivities()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                  <option value="">All Activities</option>
                  <option value="Data Access">Data Access</option>
                  <option value="Report Generation">Report Generation</option>
                  <option value="Policy Changes">Policy Changes</option>
                  <option value="Security Events">Security Events</option>
                </select>
                <input id="activitySearch" type="text" placeholder="Search..." onkeyup="searchAuditActivities()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; width: 200px;">
              </div>
            </div>

            <div style="padding: 0;">
              <div style="display: grid; grid-template-columns: 150px 200px 1fr 150px 120px 100px; gap: 1rem; padding: 1rem 1.5rem; background: #f9fafb; font-weight: 600; color: #374151; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb;">
                <div>Timestamp</div>
                <div>User</div>
                <div>Action</div>
                <div>Target</div>
                <div>IP Address</div>
                <div>Status</div>
              </div>

              <div id="auditTableContent">
                ${auditLogs.map(log => `
                  <div style="display: grid; grid-template-columns: 150px 200px 1fr 150px 120px 100px; gap: 1rem; padding: 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; align-items: center; font-size: 0.875rem;">
                    <div style="color: #6b7280;">${log.timestamp.toLocaleTimeString()}</div>
                    <div style="color: #374151; font-weight: 500;">${log.user}</div>
                    <div style="color: #1f2937;">${log.action}</div>
                    <div style="color: #374151;">${log.target}</div>
                    <div style="color: #6b7280; font-family: monospace;">${log.ip || '192.168.1.1'}</div>
                    <div>
                      <span style="background: ${log.status === 'success' ? '#dcfce7' : log.status === 'blocked' ? '#fef2f2' : '#fef3c7'}; color: ${log.status === 'success' ? '#166534' : log.status === 'blocked' ? '#dc2626' : '#92400e'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                        ${log.status === 'success' ? '✅' : log.status === 'blocked' ? '🚫' : '⚠️'} ${log.status}
                      </span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div style="padding: 1rem 1.5rem; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
              <div id="auditPaginationInfo" style="font-size: 0.875rem; color: #6b7280;">Showing 1-5 of 247 entries</div>
              <div style="display: flex; gap: 0.5rem;">
                <button id="auditPrevBtn" onclick="previousAuditPage()" style="padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Previous</button>
                <button id="auditNextBtn" onclick="nextAuditPage()" style="padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Next</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Audit Trail Interactive Functions
    window.getCurrentPageLogs = function() {
      const start = (window.auditCurrentPage - 1) * window.auditItemsPerPage;
      const end = start + window.auditItemsPerPage;
      return window.auditFilteredLogs.slice(start, end);
    };

    window.updateAuditTable = function() {
      const logs = getCurrentPageLogs();
      const tableContent = document.getElementById('auditTableContent');
      const paginationInfo = document.getElementById('auditPaginationInfo');

      if (tableContent) {
        tableContent.innerHTML = logs.map(log => `
          <div style="display: grid; grid-template-columns: 150px 200px 1fr 150px 120px 100px; gap: 1rem; padding: 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; align-items: center; font-size: 0.875rem;">
            <div style="color: #6b7280;">${log.timestamp.toLocaleTimeString()}</div>
            <div style="color: #374151; font-weight: 500;">${log.user}</div>
            <div style="color: #1f2937;">${log.action}</div>
            <div style="color: #374151;">${log.target}</div>
            <div style="color: #6b7280; font-family: monospace;">${log.ip || '192.168.1.1'}</div>
            <div>
              <span style="background: ${log.status === 'success' ? '#dcfce7' : log.status === 'blocked' ? '#fef2f2' : '#fef3c7'}; color: ${log.status === 'success' ? '#166534' : log.status === 'blocked' ? '#dc2626' : '#92400e'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                ${log.status === 'success' ? '✅' : log.status === 'blocked' ? '🚫' : '⚠️'} ${log.status}
              </span>
            </div>
          </div>
        `).join('');
      }

      if (paginationInfo) {
        const start = (window.auditCurrentPage - 1) * window.auditItemsPerPage + 1;
        const end = Math.min(start + window.auditItemsPerPage - 1, window.auditFilteredLogs.length);
        paginationInfo.textContent = `Showing ${start}-${end} of ${window.auditFilteredLogs.length} entries`;
      }

      // Update button states
      const prevBtn = document.getElementById('auditPrevBtn');
      const nextBtn = document.getElementById('auditNextBtn');

      if (prevBtn) {
        prevBtn.style.opacity = window.auditCurrentPage === 1 ? '0.5' : '1';
        prevBtn.style.cursor = window.auditCurrentPage === 1 ? 'not-allowed' : 'pointer';
      }

      if (nextBtn) {
        const totalPages = Math.ceil(window.auditFilteredLogs.length / window.auditItemsPerPage);
        nextBtn.style.opacity = window.auditCurrentPage >= totalPages ? '0.5' : '1';
        nextBtn.style.cursor = window.auditCurrentPage >= totalPages ? 'not-allowed' : 'pointer';
      }
    };

    window.filterAuditActivities = function() {
      const filterValue = document.getElementById('activityFilter').value;
      const searchValue = document.getElementById('activitySearch').value.toLowerCase();

      window.auditFilteredLogs = window.auditAllLogs.filter(log => {
        const matchesFilter = !filterValue || log.category === filterValue;
        const matchesSearch = !searchValue ||
          log.user.toLowerCase().includes(searchValue) ||
          log.action.toLowerCase().includes(searchValue) ||
          log.target.toLowerCase().includes(searchValue) ||
          log.status.toLowerCase().includes(searchValue);

        return matchesFilter && matchesSearch;
      });

      window.auditCurrentPage = 1;
      updateAuditTable();
    };

    window.searchAuditActivities = function() {
      filterAuditActivities(); // Reuse the same filtering logic
    };

    window.previousAuditPage = function() {
      if (window.auditCurrentPage > 1) {
        window.auditCurrentPage--;
        updateAuditTable();
      }
    };

    window.nextAuditPage = function() {
      const totalPages = Math.ceil(window.auditFilteredLogs.length / window.auditItemsPerPage);
      if (window.auditCurrentPage < totalPages) {
        window.auditCurrentPage++;
        updateAuditTable();
      }
    };

    window.exportAuditLog = function() {
      const csvContent = [
        ['Timestamp', 'User', 'Action', 'Target', 'IP Address', 'Status'],
        ...window.auditFilteredLogs.map(log => [
          log.timestamp.toLocaleString(),
          log.user,
          log.action,
          log.target,
          log.ip || '192.168.1.1',
          log.status
        ])
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      showToast('Audit log exported successfully!', 'success', 2000);
    };

    window.generateAuditReport = function() {
      const totalLogs = window.auditAllLogs.length;
      const successCount = window.auditAllLogs.filter(log => log.status === 'success').length;
      const blockedCount = window.auditAllLogs.filter(log => log.status === 'blocked').length;
      const uniqueUsers = new Set(window.auditAllLogs.map(log => log.user)).size;

      const reportContent = `
        Security Audit Report
        Generated: ${new Date().toLocaleString()}

        Summary:
        - Total Activities: ${totalLogs}
        - Successful Actions: ${successCount}
        - Blocked Attempts: ${blockedCount}
        - Unique Users: ${uniqueUsers}

        Security Metrics:
        - Success Rate: ${((successCount / totalLogs) * 100).toFixed(1)}%
        - Block Rate: ${((blockedCount / totalLogs) * 100).toFixed(1)}%

        Top Activities:
        ${window.auditAllLogs.reduce((acc, log) => {
          acc[log.action] = (acc[log.action] || 0) + 1;
          return acc;
        }, Object.create(null))}
      `;

      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `security_audit_report_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      showToast('Audit report generated successfully!', 'success', 2000);
    };

    // Analytics Dashboard Functions
    window.refreshAnalyticsData = function() {
      showToast('Refreshing analytics data...', 'info', 2000);

      // Update the last updated time
      const timeElement = document.querySelector('span[style*="color: #6b7280"]');
      if (timeElement && timeElement.textContent.includes('Last updated:')) {
        timeElement.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      }

      // Simulate data refresh with progress
      setTimeout(() => {
        // Refresh any visible charts or data
        const currentSection = document.querySelector('.analytics-nav-item[style*="background: #3b82f6"]');
        if (currentSection) {
          const sectionName = currentSection.textContent.trim();
          showToast(`${sectionName} data refreshed successfully!`, 'success', 3000);
        } else {
          showToast('Analytics data refreshed successfully!', 'success', 3000);
        }

        // Update any report last run times
        const reportCards = document.querySelectorAll('span[style*="color: #9ca3af"]:not([style*="font-size"])');
        reportCards.forEach(card => {
          if (card.textContent.includes('Last run:')) {
            card.textContent = `Last run: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`;
          }
        });
      }, 2500);
    };

    window.exportAllReports = function() {
      showToast('Preparing export of all reports...', 'info', 2000);

      // Create a comprehensive export package
      setTimeout(() => {
        const exportData = {
          exportInfo: {
            generatedOn: new Date().toISOString(),
            generatedBy: 'Analytics Dashboard',
            totalReports: 9,
            exportFormat: 'ZIP Package'
          },
          reports: [
            {
              name: 'admissions-analytics',
              description: 'Comprehensive admissions data and trends',
              dataPoints: '2,847 records',
              lastUpdated: new Date().toISOString()
            },
            {
              name: 'academic-performance',
              description: 'Student performance metrics and GPA trends',
              dataPoints: '1,523 records',
              lastUpdated: new Date().toISOString()
            },
            {
              name: 'enrollment-trends',
              description: 'Historical enrollment data and projections',
              dataPoints: '945 records',
              lastUpdated: new Date().toISOString()
            },
            {
              name: 'faculty-workload',
              description: 'Faculty assignments and teaching loads',
              dataPoints: '267 records',
              lastUpdated: new Date().toISOString()
            },
            {
              name: 'financial-overview',
              description: 'Program budgets and financial metrics',
              dataPoints: '156 records',
              lastUpdated: new Date().toISOString()
            },
            {
              name: 'compliance-audit',
              description: 'Regulatory compliance status and requirements',
              dataPoints: '89 records',
              lastUpdated: new Date().toISOString()
            }
          ]
        };

        // Create and download the export manifest
        const exportContent = JSON.stringify(exportData, null, 2);
        const blob = new Blob([exportContent], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `analytics_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showToast('All reports exported successfully! Check your downloads folder.', 'success', 4000);
      }, 3000);
    };

    window.closeAnalyticsDashboard = function() {
      const modal = document.getElementById('analyticsDashboardModal');
      if (modal) {
        document.body.removeChild(modal);
      }
      document.body.style.overflow = '';
      document.documentElement.style.cssText = '';
      clearAnalyticsDashboardState();
    };

    window.runReport = function(reportId) {
      showToast(`Running ${reportId} report...`, 'info', 2000);

      // Simulate report generation
      setTimeout(() => {
        showToast(`${reportId} report generated successfully! Click download to save.`, 'success', 4000);
        // Enable download button for this report
        const reportButtons = document.querySelectorAll(`button[onclick="downloadReport('${reportId}')"]`);
        reportButtons.forEach(btn => {
          btn.style.background = '#22c55e';
          btn.style.color = 'white';
          btn.title = 'Download Ready - Click to save';
        });
      }, 3000);
    };

    window.scheduleReport = function(reportId) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 20000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
            📅 Schedule Report: ${reportId}
          </h3>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Frequency:</label>
            <select id="scheduleFrequency" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly" selected>Monthly</option>
              <option value="quarterly">Quarterly</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Recipients:</label>
            <textarea id="scheduleEmails" placeholder="Enter email addresses, separated by commas" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; height: 80px; resize: vertical;"></textarea>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Start Date:</label>
            <input type="date" id="scheduleDate" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" value="${new Date().toISOString().split('T')[0]}">
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeScheduleModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151;">Cancel</button>
            <button onclick="saveSchedule('${reportId}')" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Save Schedule</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeScheduleModal(); };
    };

    window.downloadReport = function(reportId) {
      // Create a sample CSV report
      const reportData = [
        ['Report Type', reportId],
        ['Generated On', new Date().toLocaleString()],
        [''],
        ['Metric', 'Value', 'Trend'],
        ['Total Students', '1,247', '+5.2%'],
        ['Active Programs', '23', '+2.1%'],
        ['Faculty Count', '89', '+1.8%'],
        ['Completion Rate', '87.5%', '+3.4%'],
        ['Satisfaction Score', '4.2/5', '+0.3%']
      ];

      const csvContent = reportData.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `${reportId}_report_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      showToast(`${reportId} report downloaded successfully!`, 'success', 3000);
    };

    window.closeScheduleModal = function() {
      const modals = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 20000"]');
      modals.forEach(modal => document.body.removeChild(modal));
    };

    window.saveSchedule = function(reportId) {
      const frequency = document.getElementById('scheduleFrequency').value;
      const emails = document.getElementById('scheduleEmails').value;
      const date = document.getElementById('scheduleDate').value;

      if (!emails.trim()) {
        showToast('Please enter at least one email address', 'error', 3000);
        return;
      }

      // Save schedule to localStorage
      const schedules = JSON.parse(localStorage.getItem('reportSchedules') || '[]');
      schedules.push({
        reportId,
        frequency,
        emails: emails.split(',').map(e => e.trim()),
        startDate: date,
        created: new Date().toISOString()
      });
      localStorage.setItem('reportSchedules', JSON.stringify(schedules));

      closeScheduleModal();
      showToast(`${reportId} report scheduled successfully! (${frequency})`, 'success', 3000);
    };

    window.runAllReports = function() {
      showToast('Running all reports in background...', 'info', 3000);
    };

    // Custom Builder Functions
    window.createNewReport = function() {
      if (confirm('Create a new report? This will clear all current fields.')) {
        // Clear report name
        const reportName = document.getElementById('reportName');
        if (reportName) reportName.value = '';

        // Clear chart type
        const chartType = document.getElementById('chartType');
        if (chartType) chartType.selectedIndex = 0;

        // Reset canvas
        const canvas = document.getElementById('reportCanvas');
        if (canvas) {
          canvas.innerHTML = `
            <div style="font-size: 4rem; margin-bottom: 1rem;">📊</div>
            <p style="font-size: 1.125rem; margin: 0;">Drag and drop data fields here to build your report</p>
            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;">Fields will automatically generate charts and tables</p>
          `;
        }

        showToast('New report canvas ready!', 'success', 2000);
      }
    };

    window.loadReportTemplate = function() {
      const modal = document.createElement('div');
      modal.id = 'templateModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 25000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
            📋 Report Templates
          </h3>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="template-card" data-template="enrollment" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="font-size: 2rem;">📈</div>
                <h4 style="margin: 0; color: #1f2937;">Enrollment Analytics</h4>
              </div>
              <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">Track student enrollment trends, program popularity, and demographic distribution over time.</p>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Student Count</span>
                <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Program Name</span>
                <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Enrollment Date</span>
              </div>
            </div>

            <div class="template-card" data-template="performance" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="font-size: 2rem;">🎯</div>
                <h4 style="margin: 0; color: #1f2937;">Academic Performance</h4>
              </div>
              <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">Analyze student academic performance, GPA distributions, and program completion rates.</p>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">GPA</span>
                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Program Name</span>
                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Student Count</span>
              </div>
            </div>

            <div class="template-card" data-template="faculty" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="font-size: 2rem;">👨‍🏫</div>
                <h4 style="margin: 0; color: #1f2937;">Faculty Workload</h4>
              </div>
              <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">Monitor faculty assignments, course loads, and departmental distribution.</p>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Faculty Count</span>
                <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Course Load</span>
                <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Department</span>
              </div>
            </div>

            <div class="template-card" data-template="financial" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="font-size: 2rem;">💰</div>
                <h4 style="margin: 0; color: #1f2937;">Financial Overview</h4>
              </div>
              <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem;">Track tuition revenue, budget allocation, and cost-per-student metrics.</p>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <span style="background: #fecaca; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Tuition Revenue</span>
                <span style="background: #fecaca; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Budget Allocation</span>
                <span style="background: #fecaca; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Cost per Student</span>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeTemplateModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151; font-weight: 500;">Cancel</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeTemplateModal(); };

      // Add click handlers to template cards
      const templateCards = modal.querySelectorAll('.template-card');
      templateCards.forEach(card => {
        card.onclick = function() {
          const templateType = this.dataset.template;
          loadTemplate(templateType);
          closeTemplateModal();
        };
      });
    };

    window.closeTemplateModal = function() {
      const modal = document.getElementById('templateModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.loadTemplate = function(templateType) {
      showToast(`Loading ${templateType} template...`, 'info', 1500);

      const templates = {
        enrollment: {
          name: 'Enrollment Analytics Report',
          fields: ['student_count', 'program_name', 'enrollment_date']
        },
        performance: {
          name: 'Academic Performance Report',
          fields: ['gpa', 'program_name', 'student_count']
        },
        faculty: {
          name: 'Faculty Workload Report',
          fields: ['faculty_count', 'course_load', 'department']
        },
        financial: {
          name: 'Financial Overview Report',
          fields: ['tuition_revenue', 'budget_allocation', 'cost_per_student']
        }
      };

      const template = templates[templateType];
      if (!template) return;

      setTimeout(() => {
        // Clear current report
        createNewReport();

        // Set report name
        const reportName = document.getElementById('reportName');
        if (reportName) reportName.value = template.name;

        // Add template fields
        setTimeout(() => {
          template.fields.forEach((fieldType, index) => {
            setTimeout(() => {
              // Initialize canvas if first field
              if (index === 0) {
                const canvas = document.getElementById('reportCanvas');
                canvas.innerHTML = `
                  <div id="reportFields" style="display: flex; flex-direction: column; gap: 1rem;">
                  </div>
                  <div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb; text-align: center; color: #9ca3af;">
                    <p style="margin: 0; font-size: 0.875rem;">Drop more fields here to continue building your report</p>
                  </div>
                `;
              }
              addFieldToReport(fieldType);
            }, index * 300);
          });

          showToast(`${template.name} loaded successfully!`, 'success', 3000);
        }, 500);
      }, 1500);
    };

    window.handleDragStart = function(event, fieldType) {
      event.dataTransfer.setData('text/plain', fieldType);
    };

    window.allowDrop = function(event) {
      event.preventDefault();
    };

    window.handleDrop = function(event) {
      event.preventDefault();
      const fieldType = event.dataTransfer.getData('text/plain');
      const canvas = document.getElementById('reportCanvas');

      if (canvas && fieldType) {
        // Check if this is the first drop (canvas is empty)
        const isEmpty = canvas.querySelector('.report-field') === null;

        if (isEmpty) {
          // Initialize the canvas with a proper container
          canvas.innerHTML = `
            <div id="reportFields" style="display: flex; flex-direction: column; gap: 1rem;">
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb; text-align: center; color: #9ca3af;">
              <p style="margin: 0; font-size: 0.875rem;">Drop more fields here to continue building your report</p>
            </div>
          `;
        }

        // Add the new field to the report
        addFieldToReport(fieldType);
        showToast(`${fieldType.replace('_', ' ')} added to report!`, 'success', 2000);
      }
    };

    window.addFieldToReport = function(fieldType) {
      const fieldsContainer = document.getElementById('reportFields');
      if (!fieldsContainer) return;

      const fieldId = 'field-' + Date.now();
      const fieldName = fieldType.replace('_', ' ').toUpperCase();

      // Generate sample data based on field type
      const sampleData = generateSampleData(fieldType);

      const fieldElement = document.createElement('div');
      fieldElement.className = 'report-field';
      fieldElement.id = fieldId;
      fieldElement.style.cssText = `
        background: white; border: 1px solid #e5e7eb; border-radius: 8px;
        padding: 1.5rem; margin-bottom: 0; position: relative;
      `;

      fieldElement.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
            ${getFieldIcon(fieldType)} ${fieldName}
          </h4>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="configureField('${fieldId}')" style="background: #f3f4f6; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Configure">⚙️</button>
            <button onclick="removeField('${fieldId}')" style="background: #fef2f2; color: #dc2626; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Remove">🗑️</button>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <h5 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #6b7280;">Sample Data</h5>
            <div style="background: #f9fafb; border-radius: 6px; padding: 1rem; font-size: 0.875rem;">
              ${sampleData.table}
            </div>
          </div>
          <div>
            <h5 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #6b7280;">Visualization</h5>
            <div id="${fieldId}-chart" style="background: #f9fafb; border-radius: 6px; padding: 1rem; height: 150px; display: flex; align-items: center; justify-content: center;">
              ${sampleData.chart}
            </div>
          </div>
        </div>

        <div style="margin-top: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 6px; font-size: 0.875rem;">
          <strong>Configuration:</strong>
          <span id="${fieldId}-config">Chart Type: ${sampleData.chartType} | Aggregation: ${sampleData.aggregation}</span>
        </div>
      `;

      fieldsContainer.appendChild(fieldElement);
    };

    window.generateSampleData = function(fieldType) {
      const dataTemplates = {
        student_count: {
          table: `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-family: monospace;">
            <div>Fall 2024: 1,247</div><div>Spring 2024: 1,189</div>
            <div>Fall 2023: 1,156</div><div>Spring 2023: 1,098</div>
            <div>Fall 2022: 1,034</div><div>Spring 2022: 987</div>
          </div>`,
          chart: `<div style="display: flex; align-items: end; gap: 2px; height: 100px;">
            <div style="background: #3b82f6; width: 15px; height: 60px;"></div>
            <div style="background: #10b981; width: 15px; height: 70px;"></div>
            <div style="background: #f59e0b; width: 15px; height: 80px;"></div>
            <div style="background: #ef4444; width: 15px; height: 90px;"></div>
            <div style="background: #8b5cf6; width: 15px; height: 100px;"></div>
          </div>`,
          chartType: 'Bar Chart',
          aggregation: 'Count'
        },
        enrollment_date: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>Sep 2024: 312 students</div>
            <div>Jan 2024: 289 students</div>
            <div>Sep 2023: 298 students</div>
            <div>Jan 2023: 267 students</div>
          </div>`,
          chart: `<div style="position: relative; width: 100%; height: 80px;">
            <svg width="100%" height="80" style="background: white; border-radius: 4px;">
              <polyline points="10,60 40,45 70,30 100,20 130,15" stroke="#3b82f6" stroke-width="2" fill="none"/>
              <circle cx="10" cy="60" r="3" fill="#3b82f6"/>
              <circle cx="40" cy="45" r="3" fill="#3b82f6"/>
              <circle cx="70" cy="30" r="3" fill="#3b82f6"/>
              <circle cx="100" cy="20" r="3" fill="#3b82f6"/>
              <circle cx="130" cy="15" r="3" fill="#3b82f6"/>
            </svg>
          </div>`,
          chartType: 'Line Chart',
          aggregation: 'Time Series'
        },
        program_name: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>Computer Science: 342</div>
            <div>Business Admin: 298</div>
            <div>Engineering: 267</div>
            <div>Psychology: 189</div>
            <div>Biology: 151</div>
          </div>`,
          chart: `<div style="position: relative; width: 80px; height: 80px; margin: 0 auto;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(#3b82f6 0deg 120deg, #10b981 120deg 210deg, #f59e0b 210deg 270deg, #ef4444 270deg 320deg, #8b5cf6 320deg 360deg);"></div>
          </div>`,
          chartType: 'Pie Chart',
          aggregation: 'Count by Category'
        },
        gpa: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>4.0: 89 students</div>
            <div>3.5-3.9: 234 students</div>
            <div>3.0-3.4: 312 students</div>
            <div>2.5-2.9: 167 students</div>
            <div>2.0-2.4: 45 students</div>
          </div>`,
          chart: `<div style="display: flex; align-items: end; gap: 3px; height: 80px; justify-content: center;">
            <div style="background: #22c55e; width: 12px; height: 25px;"></div>
            <div style="background: #3b82f6; width: 12px; height: 65px;"></div>
            <div style="background: #f59e0b; width: 12px; height: 80px;"></div>
            <div style="background: #ef4444; width: 12px; height: 45px;"></div>
            <div style="background: #dc2626; width: 12px; height: 15px;"></div>
          </div>`,
          chartType: 'Histogram',
          aggregation: 'Distribution'
        },
        faculty_count: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>Full-time: 67</div>
            <div>Part-time: 22</div>
            <div>Adjunct: 31</div>
            <div>Visiting: 8</div>
          </div>`,
          chart: `<div style="display: flex; align-items: end; gap: 4px; height: 80px; justify-content: center;">
            <div style="background: #3b82f6; width: 20px; height: 70px;"></div>
            <div style="background: #10b981; width: 20px; height: 25px;"></div>
            <div style="background: #f59e0b; width: 20px; height: 35px;"></div>
            <div style="background: #8b5cf6; width: 20px; height: 10px;"></div>
          </div>`,
          chartType: 'Bar Chart',
          aggregation: 'Count by Type'
        },
        course_load: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>1-2 courses: 23 faculty</div>
            <div>3-4 courses: 45 faculty</div>
            <div>5+ courses: 21 faculty</div>
          </div>`,
          chart: `<div style="position: relative; width: 60px; height: 60px; margin: 0 auto;">
            <div style="width: 60px; height: 60px; border-radius: 50%; background: conic-gradient(#3b82f6 0deg 100deg, #10b981 100deg 280deg, #f59e0b 280deg 360deg);"></div>
          </div>`,
          chartType: 'Donut Chart',
          aggregation: 'Count by Range'
        },
        department: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>Computer Science: 18</div>
            <div>Business: 15</div>
            <div>Engineering: 12</div>
            <div>Liberal Arts: 22</div>
            <div>Sciences: 16</div>
          </div>`,
          chart: `<div style="display: flex; align-items: end; gap: 2px; height: 80px;">
            <div style="background: #3b82f6; width: 15px; height: 60px;"></div>
            <div style="background: #10b981; width: 15px; height: 50px;"></div>
            <div style="background: #f59e0b; width: 15px; height: 40px;"></div>
            <div style="background: #ef4444; width: 15px; height: 70px;"></div>
            <div style="background: #8b5cf6; width: 15px; height: 55px;"></div>
          </div>`,
          chartType: 'Column Chart',
          aggregation: 'Count by Department'
        },
        tuition_revenue: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>Fall 2024: $12.4M</div>
            <div>Spring 2024: $11.8M</div>
            <div>Fall 2023: $11.2M</div>
            <div>Spring 2023: $10.9M</div>
          </div>`,
          chart: `<div style="position: relative; width: 100%; height: 80px;">
            <svg width="100%" height="80" style="background: white; border-radius: 4px;">
              <polyline points="10,70 40,55 70,35 100,20" stroke="#22c55e" stroke-width="3" fill="none"/>
              <circle cx="10" cy="70" r="4" fill="#22c55e"/>
              <circle cx="40" cy="55" r="4" fill="#22c55e"/>
              <circle cx="70" cy="35" r="4" fill="#22c55e"/>
              <circle cx="100" cy="20" r="4" fill="#22c55e"/>
            </svg>
          </div>`,
          chartType: 'Line Chart',
          aggregation: 'Sum by Period'
        },
        budget_allocation: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>Salaries: 65%</div>
            <div>Operations: 20%</div>
            <div>Technology: 10%</div>
            <div>Other: 5%</div>
          </div>`,
          chart: `<div style="position: relative; width: 70px; height: 70px; margin: 0 auto;">
            <div style="width: 70px; height: 70px; border-radius: 50%; background: conic-gradient(#3b82f6 0deg 234deg, #10b981 234deg 306deg, #f59e0b 306deg 342deg, #ef4444 342deg 360deg);"></div>
          </div>`,
          chartType: 'Pie Chart',
          aggregation: 'Percentage'
        },
        cost_per_student: {
          table: `<div style="font-family: monospace; font-size: 0.75rem;">
            <div>Direct Cost: $8,450</div>
            <div>Indirect Cost: $3,200</div>
            <div>Total Cost: $11,650</div>
            <div>vs Budget: -2.3%</div>
          </div>`,
          chart: `<div style="display: flex; align-items: center; gap: 1rem; height: 80px; justify-content: center;">
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">$11,650</div>
              <div style="font-size: 0.75rem; color: #6b7280;">Per Student</div>
            </div>
          </div>`,
          chartType: 'Metric Display',
          aggregation: 'Average'
        }
      };

      return dataTemplates[fieldType] || {
        table: '<div>No sample data available</div>',
        chart: '<div style="color: #9ca3af;">📊 Chart Preview</div>',
        chartType: 'Table',
        aggregation: 'None'
      };
    };

    window.getFieldIcon = function(fieldType) {
      const icons = {
        student_count: '👥',
        enrollment_date: '📅',
        program_name: '🎓',
        gpa: '📊',
        faculty_count: '👨‍🏫',
        course_load: '📚',
        department: '🏛️',
        tuition_revenue: '💰',
        budget_allocation: '💳',
        cost_per_student: '💵'
      };
      return icons[fieldType] || '📄';
    };

    window.removeField = function(fieldId) {
      const field = document.getElementById(fieldId);
      if (field) {
        field.remove();
        showToast('Field removed from report', 'info', 2000);

        // Check if canvas is empty, reset if needed
        const fieldsContainer = document.getElementById('reportFields');
        if (fieldsContainer && fieldsContainer.children.length === 0) {
          const canvas = document.getElementById('reportCanvas');
          canvas.innerHTML = `
            <div style="font-size: 4rem; margin-bottom: 1rem;">📊</div>
            <p style="font-size: 1.125rem; margin: 0;">Drag and drop data fields here to build your report</p>
            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;">Fields will automatically generate charts and tables</p>
          `;
        }
      }
    };

    window.configureField = function(fieldId) {
      const field = document.getElementById(fieldId);
      if (!field) {
        showToast('Field not found!', 'error', 2000);
        return;
      }

      const fieldTitle = field.querySelector('h4').textContent;
      const currentConfig = field.querySelector('[id$="-config"]')?.textContent || '';

      // Extract current settings
      const chartTypeMatch = currentConfig.match(/Chart Type: ([^|]+)/);
      const aggregationMatch = currentConfig.match(/Aggregation: ([^|]+)/);
      const currentChartType = chartTypeMatch ? chartTypeMatch[1].trim() : 'Bar Chart';
      const currentAggregation = aggregationMatch ? aggregationMatch[1].trim() : 'Count';

      const modal = document.createElement('div');
      modal.id = 'configModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 25000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
            ⚙️ Configure Field: ${fieldTitle}
          </h3>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Chart Type:</label>
            <select id="configChartType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <option value="Bar Chart" ${currentChartType === 'Bar Chart' ? 'selected' : ''}>📊 Bar Chart</option>
              <option value="Line Chart" ${currentChartType === 'Line Chart' ? 'selected' : ''}>📈 Line Chart</option>
              <option value="Pie Chart" ${currentChartType === 'Pie Chart' ? 'selected' : ''}>🥧 Pie Chart</option>
              <option value="Donut Chart" ${currentChartType === 'Donut Chart' ? 'selected' : ''}>🍩 Donut Chart</option>
              <option value="Area Chart" ${currentChartType === 'Area Chart' ? 'selected' : ''}>📍 Area Chart</option>
              <option value="Histogram" ${currentChartType === 'Histogram' ? 'selected' : ''}>📊 Histogram</option>
              <option value="Scatter Plot" ${currentChartType === 'Scatter Plot' ? 'selected' : ''}>⚡ Scatter Plot</option>
              <option value="Table" ${currentChartType === 'Table' ? 'selected' : ''}>📋 Table</option>
              <option value="Metric Display" ${currentChartType === 'Metric Display' ? 'selected' : ''}>🔢 Metric Display</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Data Aggregation:</label>
            <select id="configAggregation" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <option value="Count" ${currentAggregation === 'Count' ? 'selected' : ''}>Count</option>
              <option value="Sum" ${currentAggregation === 'Sum' ? 'selected' : ''}>Sum</option>
              <option value="Average" ${currentAggregation === 'Average' ? 'selected' : ''}>Average</option>
              <option value="Minimum" ${currentAggregation === 'Minimum' ? 'selected' : ''}>Minimum</option>
              <option value="Maximum" ${currentAggregation === 'Maximum' ? 'selected' : ''}>Maximum</option>
              <option value="Median" ${currentAggregation === 'Median' ? 'selected' : ''}>Median</option>
              <option value="Distribution" ${currentAggregation === 'Distribution' ? 'selected' : ''}>Distribution</option>
              <option value="Time Series" ${currentAggregation === 'Time Series' ? 'selected' : ''}>Time Series</option>
              <option value="Percentage" ${currentAggregation === 'Percentage' ? 'selected' : ''}>Percentage</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Color Scheme:</label>
            <select id="configColorScheme" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <option value="default">🎨 Default</option>
              <option value="blue">🔵 Blue Tones</option>
              <option value="green">🟢 Green Tones</option>
              <option value="orange">🟠 Orange Tones</option>
              <option value="purple">🟣 Purple Tones</option>
              <option value="red">🔴 Red Tones</option>
              <option value="rainbow">🌈 Rainbow</option>
              <option value="monochrome">⚫ Monochrome</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Chart Size:</label>
            <select id="configSize" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <option value="small">📱 Small (150px)</option>
              <option value="medium" selected>💻 Medium (200px)</option>
              <option value="large">🖥️ Large (300px)</option>
              <option value="extra-large">📺 Extra Large (400px)</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="configShowLabels" checked style="margin: 0;">
              <span style="font-weight: 600; color: #374151;">Show Data Labels</span>
            </label>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="configShowLegend" checked style="margin: 0;">
              <span style="font-weight: 600; color: #374151;">Show Legend</span>
            </label>
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Field Title:</label>
            <input id="configTitle" value="${fieldTitle}" placeholder="Enter custom title" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
          </div>

          <div style="background: #f9fafb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Live Preview</h4>
            <div id="configPreview" style="background: white; border-radius: 6px; padding: 1rem; height: 150px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280;">
              Chart preview will update as you change settings...
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeConfigModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151; font-weight: 500;">Cancel</button>
            <button onclick="resetFieldConfig('${fieldId}')" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Reset</button>
            <button onclick="applyFieldConfig('${fieldId}')" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Apply Changes</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeConfigModal(); };

      // Add event listeners for live preview
      const chartTypeSelect = document.getElementById('configChartType');
      const aggregationSelect = document.getElementById('configAggregation');
      const colorSchemeSelect = document.getElementById('configColorScheme');
      const sizeSelect = document.getElementById('configSize');

      [chartTypeSelect, aggregationSelect, colorSchemeSelect, sizeSelect].forEach(element => {
        if (element) {
          element.addEventListener('change', () => updateConfigPreview(fieldId));
        }
      });

      // Initial preview update
      setTimeout(() => updateConfigPreview(fieldId), 100);
    };

    window.closeConfigModal = function() {
      const modal = document.getElementById('configModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.updateConfigPreview = function(fieldId) {
      const chartType = document.getElementById('configChartType')?.value || 'Bar Chart';
      const colorScheme = document.getElementById('configColorScheme')?.value || 'default';
      const size = document.getElementById('configSize')?.value || 'medium';
      const preview = document.getElementById('configPreview');

      if (!preview) return;

      const colors = {
        default: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
        blue: ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd', '#dbeafe'],
        green: ['#166534', '#16a34a', '#22c55e', '#4ade80', '#86efac'],
        orange: ['#c2410c', '#ea580c', '#f97316', '#fb923c', '#fed7aa'],
        purple: ['#6b21a8', '#9333ea', '#a855f7', '#c084fc', '#e9d5ff'],
        red: ['#991b1b', '#dc2626', '#ef4444', '#f87171', '#fecaca'],
        rainbow: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6'],
        monochrome: ['#000000', '#404040', '#808080', '#c0c0c0', '#e0e0e0']
      };

      const currentColors = colors[colorScheme] || colors.default;
      const height = size === 'small' ? '120px' : size === 'large' ? '200px' : size === 'extra-large' ? '250px' : '150px';

      let previewContent = '';

      switch (chartType) {
        case 'Bar Chart':
          previewContent = `
            <div style="display: flex; align-items: end; gap: 3px; height: ${height}; justify-content: center;">
              ${currentColors.slice(0, 5).map((color, i) => `
                <div style="background: ${color}; width: 20px; height: ${20 + i * 15}px;"></div>
              `).join('')}
            </div>
          `;
          break;
        case 'Line Chart':
          previewContent = `
            <div style="position: relative; width: 100%; height: ${height};">
              <svg width="100%" height="100%" style="background: white;">
                <polyline points="10,80% 30,60% 50,40% 70,30% 90,20%" stroke="${currentColors[0]}" stroke-width="3" fill="none"/>
                ${[10,30,50,70,90].map((x, i) => `<circle cx="${x}" cy="${80-i*15}%" r="4" fill="${currentColors[0]}"/>`).join('')}
              </svg>
            </div>
          `;
          break;
        case 'Pie Chart':
          previewContent = `
            <div style="position: relative; width: 120px; height: 120px; margin: 0 auto;">
              <div style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(${currentColors[0]} 0deg 120deg, ${currentColors[1]} 120deg 210deg, ${currentColors[2]} 210deg 270deg, ${currentColors[3]} 270deg 360deg);"></div>
            </div>
          `;
          break;
        case 'Donut Chart':
          previewContent = `
            <div style="position: relative; width: 120px; height: 120px; margin: 0 auto;">
              <div style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(${currentColors[0]} 0deg 100deg, ${currentColors[1]} 100deg 280deg, ${currentColors[2]} 280deg 360deg); position: relative;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: white; border-radius: 50%;"></div>
              </div>
            </div>
          `;
          break;
        case 'Table':
          previewContent = `
            <div style="font-family: monospace; font-size: 0.75rem; width: 100%;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; background: #f3f4f6; padding: 0.5rem; border-radius: 4px;">
                <div style="font-weight: bold;">Item</div><div style="font-weight: bold;">Value</div>
                <div>Data A</div><div>123</div>
                <div>Data B</div><div>456</div>
                <div>Data C</div><div>789</div>
              </div>
            </div>
          `;
          break;
        case 'Metric Display':
          previewContent = `
            <div style="text-align: center;">
              <div style="font-size: 2.5rem; font-weight: bold; color: ${currentColors[0]};">1,247</div>
              <div style="font-size: 1rem; color: #6b7280;">Total Count</div>
            </div>
          `;
          break;
        default:
          previewContent = `
            <div style="display: flex; align-items: end; gap: 2px; height: ${height};">
              ${currentColors.slice(0, 4).map((color, i) => `
                <div style="background: ${color}; width: 25px; height: ${30 + i * 20}px;"></div>
              `).join('')}
            </div>
          `;
      }

      preview.innerHTML = previewContent;
    };

    window.resetFieldConfig = function(fieldId) {
      if (confirm('Reset field configuration to defaults?')) {
        document.getElementById('configChartType').selectedIndex = 0;
        document.getElementById('configAggregation').selectedIndex = 0;
        document.getElementById('configColorScheme').selectedIndex = 0;
        document.getElementById('configSize').selectedIndex = 1;
        document.getElementById('configShowLabels').checked = true;
        document.getElementById('configShowLegend').checked = true;

        const field = document.getElementById(fieldId);
        const originalTitle = field.querySelector('h4').textContent.split(' ').slice(1).join(' ');
        document.getElementById('configTitle').value = originalTitle;

        updateConfigPreview(fieldId);
        showToast('Configuration reset to defaults', 'info', 2000);
      }
    };

    window.applyFieldConfig = function(fieldId) {
      const field = document.getElementById(fieldId);
      if (!field) return;

      const chartType = document.getElementById('configChartType').value;
      const aggregation = document.getElementById('configAggregation').value;
      const colorScheme = document.getElementById('configColorScheme').value;
      const size = document.getElementById('configSize').value;
      const showLabels = document.getElementById('configShowLabels').checked;
      const showLegend = document.getElementById('configShowLegend').checked;
      const title = document.getElementById('configTitle').value.trim();

      // Update field title
      const titleElement = field.querySelector('h4');
      const icon = titleElement.textContent.split(' ')[0];
      titleElement.textContent = `${icon} ${title || 'Untitled Field'}`;

      // Update configuration display
      const configElement = field.querySelector('[id$="-config"]');
      if (configElement) {
        configElement.textContent = `Chart Type: ${chartType} | Aggregation: ${aggregation} | Colors: ${colorScheme} | Size: ${size}`;
      }

      // Update visualization with new settings
      const chartElement = field.querySelector('[id$="-chart"]');
      if (chartElement) {
        updateFieldVisualization(chartElement, chartType, colorScheme, size);
      }

      closeConfigModal();
      showToast(`Field "${title}" configuration updated!`, 'success', 2000);
    };

    window.updateFieldVisualization = function(chartElement, chartType, colorScheme, size) {
      const colors = {
        default: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
        blue: ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd'],
        green: ['#166534', '#16a34a', '#22c55e', '#4ade80'],
        orange: ['#c2410c', '#ea580c', '#f97316', '#fb923c'],
        purple: ['#6b21a8', '#9333ea', '#a855f7', '#c084fc'],
        red: ['#991b1b', '#dc2626', '#ef4444', '#f87171'],
        rainbow: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6'],
        monochrome: ['#000000', '#404040', '#808080', '#c0c0c0']
      };

      const currentColors = colors[colorScheme] || colors.default;
      const height = size === 'small' ? '120px' : size === 'large' ? '200px' : size === 'extra-large' ? '250px' : '150px';

      // Update the chart element height
      chartElement.style.height = height;

      // Generate new chart based on type
      switch (chartType) {
        case 'Bar Chart':
          chartElement.innerHTML = `
            <div style="display: flex; align-items: end; gap: 3px; height: 100%; justify-content: center;">
              ${currentColors.slice(0, 5).map((color, i) => `
                <div style="background: ${color}; width: 15px; height: ${20 + i * 15}%;"></div>
              `).join('')}
            </div>
          `;
          break;
        case 'Pie Chart':
          chartElement.innerHTML = `
            <div style="position: relative; width: 80px; height: 80px; margin: 0 auto;">
              <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(${currentColors[0]} 0deg 120deg, ${currentColors[1]} 120deg 210deg, ${currentColors[2]} 210deg 270deg, ${currentColors[3]} 270deg 360deg);"></div>
            </div>
          `;
          break;
        case 'Line Chart':
          chartElement.innerHTML = `
            <div style="position: relative; width: 100%; height: 80px;">
              <svg width="100%" height="80" style="background: white; border-radius: 4px;">
                <polyline points="10,60 40,45 70,30 100,20 130,15" stroke="${currentColors[0]}" stroke-width="2" fill="none"/>
                <circle cx="10" cy="60" r="3" fill="${currentColors[0]}"/>
                <circle cx="40" cy="45" r="3" fill="${currentColors[0]}"/>
                <circle cx="70" cy="30" r="3" fill="${currentColors[0]}"/>
                <circle cx="100" cy="20" r="3" fill="${currentColors[0]}"/>
                <circle cx="130" cy="15" r="3" fill="${currentColors[0]}"/>
              </svg>
            </div>
          `;
          break;
        case 'Table':
          chartElement.innerHTML = `
            <div style="font-family: monospace; font-size: 0.75rem; padding: 0.5rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem;">
                <div style="font-weight: bold; background: ${currentColors[0]}; color: white; padding: 0.25rem;">Item</div>
                <div style="font-weight: bold; background: ${currentColors[0]}; color: white; padding: 0.25rem;">Value</div>
                <div style="padding: 0.25rem;">Data A</div><div style="padding: 0.25rem;">123</div>
                <div style="padding: 0.25rem;">Data B</div><div style="padding: 0.25rem;">456</div>
              </div>
            </div>
          `;
          break;
        default:
          // Keep existing visualization
          break;
      }
    };

    window.previewReport = function() {
      const fieldsContainer = document.getElementById('reportFields');
      const reportName = document.getElementById('reportName')?.value || 'Untitled Report';

      if (!fieldsContainer || fieldsContainer.children.length === 0) {
        showToast('Add some fields to your report before previewing!', 'warning', 3000);
        return;
      }

      showToast('Generating report preview...', 'info', 2000);

      setTimeout(() => {
        const modal = document.createElement('div');
        modal.id = 'previewModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
          background: rgba(0,0,0,0.8); z-index: 25000; display: flex;
          align-items: center; justify-content: center;
        `;

        // Generate preview content
        const fields = Array.from(fieldsContainer.children);
        const previewContent = fields.map((field, index) => {
          const fieldTitle = field.querySelector('h4').textContent;
          const sampleData = field.querySelector('[style*="background: #f9fafb"]').innerHTML;
          const chart = field.querySelector('[id$="-chart"]').innerHTML;

          return `
            <div style="background: white; margin-bottom: 2rem; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">${fieldTitle}</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                  <h4 style="margin: 0 0 1rem 0; color: #6b7280; font-size: 1rem;">Data Summary</h4>
                  ${sampleData}
                </div>
                <div>
                  <h4 style="margin: 0 0 1rem 0; color: #6b7280; font-size: 1rem;">Visualization</h4>
                  <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; height: 200px; display: flex; align-items: center; justify-content: center;">
                    ${chart}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        modal.innerHTML = `
          <div style="background: white; border-radius: 12px; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
            <div style="background: #1f2937; color: white; padding: 1.5rem 2rem; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
              <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                👁️ Report Preview: ${reportName}
              </h2>
              <div style="display: flex; gap: 1rem;">
                <button onclick="printPreview()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">🖨️ Print</button>
                <button onclick="exportPreview()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">📤 Export</button>
                <button onclick="closePreviewModal()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">✕ Close</button>
              </div>
            </div>

            <div style="padding: 2rem;">
              <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;">
                <h1 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 2rem;">${reportName}</h1>
                <p style="margin: 0; color: #6b7280;">Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Contains ${fields.length} data visualization${fields.length !== 1 ? 's' : ''}</p>
              </div>

              ${previewContent}

              <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 0.875rem;">
                <p style="margin: 0;">Report generated by Analytics Dashboard • ${new Date().toLocaleDateString()}</p>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.onclick = (e) => { if (e.target === modal) closePreviewModal(); };

        showToast('Report preview ready!', 'success', 2000);
      }, 2000);
    };

    window.closePreviewModal = function() {
      const modal = document.getElementById('previewModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.printPreview = function() {
      showToast('Preparing report for printing...', 'info', 2000);
      setTimeout(() => {
        window.print();
      }, 2000);
    };

    window.exportPreview = function() {
      const reportName = document.getElementById('reportName')?.value || 'Untitled Report';
      showToast('Exporting report as PDF...', 'info', 2000);
      setTimeout(() => {
        showToast('Report exported successfully! Check your downloads.', 'success', 3000);
      }, 2000);
    };

    window.saveReport = function() {
      const reportName = document.getElementById('reportName')?.value?.trim();
      const fieldsContainer = document.getElementById('reportFields');

      if (!reportName) {
        showToast('Please enter a report name before saving!', 'warning', 3000);
        document.getElementById('reportName')?.focus();
        return;
      }

      if (!fieldsContainer || fieldsContainer.children.length === 0) {
        showToast('Add some fields to your report before saving!', 'warning', 3000);
        return;
      }

      showToast(`Saving "${reportName}"...`, 'info', 1500);

      setTimeout(() => {
        // Collect report data
        const fields = Array.from(fieldsContainer.children);
        const reportData = {
          id: 'report-' + Date.now(),
          name: reportName,
          chartType: document.getElementById('chartType')?.value || 'table',
          fields: fields.map(field => {
            const fieldTitle = field.querySelector('h4').textContent;
            const fieldId = field.id;
            const config = field.querySelector('[id$="-config"]')?.textContent || '';
            return {
              id: fieldId,
              title: fieldTitle,
              config: config
            };
          }),
          created: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };

        // Save to localStorage
        const savedReports = JSON.parse(localStorage.getItem('customReports') || '[]');

        // Check if report with same name exists
        const existingIndex = savedReports.findIndex(r => r.name === reportName);
        if (existingIndex >= 0) {
          if (confirm(`A report named "${reportName}" already exists. Do you want to overwrite it?`)) {
            reportData.created = savedReports[existingIndex].created;
            savedReports[existingIndex] = reportData;
            showToast(`"${reportName}" updated successfully!`, 'success', 2000);
          } else {
            return;
          }
        } else {
          savedReports.push(reportData);
          showToast(`"${reportName}" saved successfully!`, 'success', 2000);
        }

        localStorage.setItem('customReports', JSON.stringify(savedReports));

        // Show save confirmation with additional actions
        setTimeout(() => {
          if (confirm('Report saved! Would you like to view all saved reports?')) {
            showSavedReports();
          }
        }, 2500);
      }, 1500);
    };

    window.showSavedReports = function() {
      const savedReports = JSON.parse(localStorage.getItem('customReports') || '[]');

      const modal = document.createElement('div');
      modal.id = 'savedReportsModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 25000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
            📁 Saved Reports (${savedReports.length})
          </h3>

          ${savedReports.length === 0 ? `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
              <p style="margin: 0;">No saved reports yet. Create and save your first report!</p>
            </div>
          ` : `
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              ${savedReports.map(report => `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; background: #f9fafb;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                      <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">${report.name}</h4>
                      <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
                        Created: ${new Date(report.created).toLocaleDateString()} •
                        ${report.fields.length} field${report.fields.length !== 1 ? 's' : ''}
                      </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                      <button onclick="loadSavedReport('${report.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Load</button>
                      <button onclick="deleteSavedReport('${report.id}')" style="background: #dc2626; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Delete</button>
                    </div>
                  </div>
                  <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${report.fields.map(field => `
                      <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${field.title}</span>
                    `).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
          `}

          <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button onclick="closeSavedReportsModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151; font-weight: 500;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeSavedReportsModal(); };
    };

    window.closeSavedReportsModal = function() {
      const modal = document.getElementById('savedReportsModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.loadSavedReport = function(reportId) {
      const savedReports = JSON.parse(localStorage.getItem('customReports') || '[]');
      const report = savedReports.find(r => r.id === reportId);

      if (!report) {
        showToast('Report not found!', 'error', 2000);
        return;
      }

      closeSavedReportsModal();
      showToast(`Loading "${report.name}"...`, 'info', 2000);

      setTimeout(() => {
        // Clear current report
        createNewReport();

        // Load report data
        const reportName = document.getElementById('reportName');
        if (reportName) reportName.value = report.name;

        const chartType = document.getElementById('chartType');
        if (chartType) chartType.value = report.chartType;

        showToast(`"${report.name}" loaded successfully!`, 'success', 2000);
      }, 2000);
    };

    window.deleteSavedReport = function(reportId) {
      const savedReports = JSON.parse(localStorage.getItem('customReports') || '[]');
      const report = savedReports.find(r => r.id === reportId);

      if (!report) return;

      if (confirm(`Delete "${report.name}"? This action cannot be undone.`)) {
        const updatedReports = savedReports.filter(r => r.id !== reportId);
        localStorage.setItem('customReports', JSON.stringify(updatedReports));
        showToast(`"${report.name}" deleted successfully!`, 'success', 2000);

        // Refresh the modal
        closeSavedReportsModal();
        setTimeout(() => showSavedReports(), 500);
      }
    };

    // Report Configuration Functions
    window.validateReportName = function() {
      const reportName = document.getElementById('reportName').value.trim();
      const statusDiv = document.getElementById('reportNameStatus');
      const savedReports = JSON.parse(localStorage.getItem('customReports') || '[]');

      if (!reportName) {
        statusDiv.innerHTML = '<span style="color: #9ca3af;">Enter a name for your report</span>';
        return false;
      }

      const existingReport = savedReports.find(r => r.name.toLowerCase() === reportName.toLowerCase());
      if (existingReport) {
        statusDiv.innerHTML = '<span style="color: #f59e0b;">⚠️ Name already exists - will overwrite</span>';
        return true;
      }

      if (reportName.length < 3) {
        statusDiv.innerHTML = '<span style="color: #ef4444;">❌ Name too short (min 3 characters)</span>';
        return false;
      }

      if (reportName.length > 50) {
        statusDiv.innerHTML = '<span style="color: #ef4444;">❌ Name too long (max 50 characters)</span>';
        return false;
      }

      statusDiv.innerHTML = '<span style="color: #22c55e;">✅ Valid report name</span>';
      updateReportStatus();
      return true;
    };

    window.updateDefaultChartType = function() {
      const chartType = document.getElementById('chartType').value;
      const typeNames = {
        'table': 'Table',
        'bar': 'Bar Chart',
        'line': 'Line Chart',
        'pie': 'Pie Chart',
        'donut': 'Donut Chart',
        'area': 'Area Chart',
        'histogram': 'Histogram',
        'scatter': 'Scatter Plot',
        'metric': 'Metric Display'
      };

      showToast(`Default chart type set to ${typeNames[chartType] || chartType}`, 'info', 2000);
      updateReportStatus();
    };

    window.updateReportStatus = function() {
      const fieldsContainer = document.getElementById('reportFields');
      const statusDiv = document.getElementById('reportStatus');
      const reportName = document.getElementById('reportName').value.trim();
      const chartType = document.getElementById('chartType').value;

      const fieldCount = fieldsContainer ? fieldsContainer.children.length : 0;

      if (fieldCount === 0) {
        statusDiv.textContent = 'No fields added';
      } else if (!reportName) {
        statusDiv.innerHTML = `<span style="color: #f59e0b;">${fieldCount} field${fieldCount !== 1 ? 's' : ''} added - needs name</span>`;
      } else {
        statusDiv.innerHTML = `<span style="color: #22c55e;">Ready: ${fieldCount} field${fieldCount !== 1 ? 's' : ''}, ${chartType} default</span>`;
      }
    };

    window.clearReportConfig = function() {
      if (confirm('Clear report configuration? This will reset the name and chart type but keep your fields.')) {
        document.getElementById('reportName').value = '';
        document.getElementById('chartType').selectedIndex = 0;
        document.getElementById('reportNameStatus').innerHTML = '';
        updateReportStatus();
        showToast('Report configuration cleared', 'info', 2000);
      }
    };

    window.autoNameReport = function() {
      const fieldsContainer = document.getElementById('reportFields');
      const fieldCount = fieldsContainer ? fieldsContainer.children.length : 0;

      if (fieldCount === 0) {
        showToast('Add some fields first to generate an auto name', 'warning', 3000);
        return;
      }

      const fields = Array.from(fieldsContainer.children);
      const fieldNames = fields.map(field => {
        const title = field.querySelector('h4').textContent;
        return title.split(' ').slice(1).join(' '); // Remove emoji
      });

      let autoName = '';
      if (fieldNames.length === 1) {
        autoName = `${fieldNames[0]} Report`;
      } else if (fieldNames.length === 2) {
        autoName = `${fieldNames[0]} & ${fieldNames[1]} Analysis`;
      } else if (fieldNames.length <= 4) {
        autoName = `${fieldNames.slice(0, 2).join(', ')} + ${fieldNames.length - 2} More`;
      } else {
        autoName = `Comprehensive Analysis (${fieldNames.length} Metrics)`;
      }

      // Add timestamp to make it unique
      const timestamp = new Date().toLocaleDateString().replace(/\//g, '-');
      autoName += ` ${timestamp}`;

      document.getElementById('reportName').value = autoName;
      validateReportName();
      showToast('Auto-generated report name!', 'success', 2000);
    };

    window.duplicateReport = function() {
      const reportName = document.getElementById('reportName').value.trim();
      const fieldsContainer = document.getElementById('reportFields');

      if (!reportName || !fieldsContainer || fieldsContainer.children.length === 0) {
        showToast('Complete your current report first before duplicating', 'warning', 3000);
        return;
      }

      // Save current report first
      saveReport();

      setTimeout(() => {
        // Create duplicate with new name
        const duplicateName = reportName + ' Copy';
        document.getElementById('reportName').value = duplicateName;
        validateReportName();
        showToast('Report duplicated! Modify and save again.', 'success', 2000);
      }, 2000);
    };

    window.shareReport = function() {
      const reportName = document.getElementById('reportName').value.trim();
      const fieldsContainer = document.getElementById('reportFields');

      if (!reportName || !fieldsContainer || fieldsContainer.children.length === 0) {
        showToast('Complete your report first before sharing', 'warning', 3000);
        return;
      }

      const fields = Array.from(fieldsContainer.children);
      const fieldSummary = fields.map(field => {
        const title = field.querySelector('h4').textContent;
        return title.split(' ').slice(1).join(' ');
      }).join(', ');

      const shareText = `Check out my custom report: "${reportName}" - Analyzing: ${fieldSummary}`;

      if (navigator.share) {
        navigator.share({
          title: 'Custom Analytics Report',
          text: shareText,
          url: window.location.href
        });
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          showToast('Report summary copied to clipboard!', 'success', 2000);
        }).catch(() => {
          showToast('Unable to copy. Use manual sharing.', 'warning', 2000);
        });
      }
    };

    // Enhanced addFieldToReport to update status
    const originalAddFieldToReport = window.addFieldToReport;
    window.addFieldToReport = function(fieldType) {
      originalAddFieldToReport(fieldType);
      setTimeout(() => updateReportStatus(), 100);
    };

    // Enhanced removeField to update status
    const originalRemoveField = window.removeField;
    window.removeField = function(fieldId) {
      originalRemoveField(fieldId);
      setTimeout(() => updateReportStatus(), 100);
    };

    // Scheduled Reports Functions
    window.createSchedule = function() {
      const modal = document.createElement('div');
      modal.id = 'newScheduleModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 25000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
            ➕ Create New Schedule
          </h3>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Select Report to Schedule:</label>
            <select id="scheduleReportSelect" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <option value="">Choose a report...</option>
              <option value="admissions-analytics">📈 Admissions Analytics</option>
              <option value="conversion-funnel">🔄 Conversion Funnel</option>
              <option value="geographic-distribution">🌍 Geographic Distribution</option>
              <option value="prerequisite-compliance">✅ Prerequisite Compliance</option>
              <option value="curriculum-changes">📚 Curriculum Changes</option>
              <option value="enrollment-trends">📊 Enrollment Trends</option>
              <option value="faculty-workload">👨‍🏫 Faculty Workload</option>
              <option value="budget-analysis">💰 Budget Analysis</option>
              <option value="compliance-audit">🛡️ Compliance Audit</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Schedule Name:</label>
            <input id="scheduleName" placeholder="Enter schedule name" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Frequency:</label>
            <select id="scheduleFrequencyNew" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="custom">Custom Schedule</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Start Date:</label>
            <input type="date" id="scheduleStartDate" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" value="${new Date().toISOString().split('T')[0]}">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Time:</label>
            <input type="time" id="scheduleTime" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" value="09:00">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Recipients:</label>
            <textarea id="scheduleEmailsNew" placeholder="Enter email addresses, separated by commas" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; height: 100px; resize: vertical; font-size: 0.875rem;"></textarea>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
              Or <button onclick="selectFromSubscribers()" style="background: none; border: none; color: #3b82f6; cursor: pointer; text-decoration: underline; font-size: inherit;">select from subscribers</button>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="scheduleActive" checked style="margin: 0;">
              <span style="font-weight: 600; color: #374151;">Schedule is active</span>
            </label>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeNewScheduleModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151; font-weight: 500;">Cancel</button>
            <button onclick="saveNewSchedule()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Create Schedule</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeNewScheduleModal(); };
    };

    window.closeNewScheduleModal = function() {
      const modal = document.getElementById('newScheduleModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.saveNewSchedule = function() {
      const reportId = document.getElementById('scheduleReportSelect').value;
      const scheduleName = document.getElementById('scheduleName').value.trim();
      const frequency = document.getElementById('scheduleFrequencyNew').value;
      const startDate = document.getElementById('scheduleStartDate').value;
      const time = document.getElementById('scheduleTime').value;
      const emails = document.getElementById('scheduleEmailsNew').value.trim();
      const isActive = document.getElementById('scheduleActive').checked;

      if (!reportId) {
        showToast('Please select a report to schedule', 'error', 3000);
        return;
      }

      if (!scheduleName) {
        showToast('Please enter a schedule name', 'error', 3000);
        return;
      }

      if (!emails) {
        showToast('Please enter at least one email address', 'error', 3000);
        return;
      }

      // Create schedule object
      const schedule = {
        id: 'schedule-' + Date.now(),
        reportId: reportId,
        name: scheduleName,
        frequency: frequency,
        startDate: startDate,
        time: time,
        emails: emails.split(',').map(e => e.trim()).filter(e => e),
        isActive: isActive,
        created: new Date().toISOString(),
        lastRun: null,
        nextRun: calculateNextRun(startDate, time, frequency)
      };

      // Save to localStorage
      const schedules = JSON.parse(localStorage.getItem('reportSchedules') || '[]');
      schedules.push(schedule);
      localStorage.setItem('reportSchedules', JSON.stringify(schedules));

      closeNewScheduleModal();
      showToast(`Schedule "${scheduleName}" created successfully!`, 'success', 3000);

      // Refresh the Scheduled Reports section if visible
      const currentSection = document.querySelector('.analytics-nav-item[style*="background: #3b82f6"]');
      if (currentSection && currentSection.textContent.includes('Scheduled Reports')) {
        showAnalyticsSection('scheduled');
      }
    };

    window.calculateNextRun = function(startDate, time, frequency) {
      const start = new Date(`${startDate}T${time}`);
      const now = new Date();

      // If start date is in the future, use it
      if (start > now) {
        return start.toISOString();
      }

      // Calculate next run based on frequency
      const next = new Date(start);
      switch (frequency) {
        case 'daily':
          while (next <= now) {
            next.setDate(next.getDate() + 1);
          }
          break;
        case 'weekly':
          while (next <= now) {
            next.setDate(next.getDate() + 7);
          }
          break;
        case 'monthly':
          while (next <= now) {
            next.setMonth(next.getMonth() + 1);
          }
          break;
        case 'quarterly':
          while (next <= now) {
            next.setMonth(next.getMonth() + 3);
          }
          break;
        default:
          // Custom or unknown, default to weekly
          while (next <= now) {
            next.setDate(next.getDate() + 7);
          }
      }

      return next.toISOString();
    };

    window.selectFromSubscribers = function() {
      closeNewScheduleModal();
      setTimeout(() => {
        manageSubscribers();
      }, 200);
    };

    window.manageSubscribers = function() {
      const subscribers = JSON.parse(localStorage.getItem('reportSubscribers') || '[]');

      const modal = document.createElement('div');
      modal.id = 'subscribersModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 25000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
            👥 Subscriber Management
          </h3>

          <div style="margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
              <input id="newSubscriberEmail" placeholder="Enter email address" style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <input id="newSubscriberName" placeholder="Name (optional)" style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <button onclick="addSubscriber()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">Add</button>
            </div>
          </div>

          ${subscribers.length === 0 ? `
            <div style="text-align: center; padding: 3rem 1rem; background: #f9fafb; border-radius: 8px; color: #6b7280;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
              <p style="margin: 0 0 1rem 0;">No subscribers yet</p>
              <p style="margin: 0; font-size: 0.875rem;">Add email addresses to create a subscriber list for automated reports</p>
            </div>
          ` : `
            <div style="background: #f9fafb; border-radius: 8px; overflow: hidden;">
              <div style="background: #f3f4f6; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: grid; grid-template-columns: 1fr 2fr 150px 100px; gap: 1rem; font-weight: 600; color: #374151; font-size: 0.875rem;">
                <div>Name</div>
                <div>Email</div>
                <div>Added</div>
                <div>Actions</div>
              </div>
              ${subscribers.map(subscriber => `
                <div style="padding: 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; display: grid; grid-template-columns: 1fr 2fr 150px 100px; gap: 1rem; align-items: center; font-size: 0.875rem;">
                  <div style="font-weight: 500; color: #1f2937;">${subscriber.name || 'No Name'}</div>
                  <div style="color: #374151; font-family: monospace;">${subscriber.email}</div>
                  <div style="color: #6b7280;">${new Date(subscriber.added).toLocaleDateString()}</div>
                  <div style="display: flex; gap: 0.25rem;">
                    <button onclick="editSubscriber('${subscriber.id}')" style="background: #f3f4f6; border: none; padding: 0.25rem; border-radius: 4px; cursor: pointer;" title="Edit">✏️</button>
                    <button onclick="deleteSubscriber('${subscriber.id}')" style="background: #fef2f2; color: #dc2626; border: none; padding: 0.25rem; border-radius: 4px; cursor: pointer;" title="Delete">🗑️</button>
                  </div>
                </div>
              `).join('')}
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
              <div style="font-size: 0.875rem; color: #6b7280;">
                Total subscribers: ${subscribers.length}
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="exportSubscribers()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">📤 Export</button>
                <button onclick="importSubscribers()" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">📥 Import</button>
              </div>
            </div>
          `}

          <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
            <button onclick="closeSubscribersModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151; font-weight: 500;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeSubscribersModal(); };
    };

    window.closeSubscribersModal = function() {
      const modal = document.getElementById('subscribersModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.addSubscriber = function() {
      const email = document.getElementById('newSubscriberEmail').value.trim();
      const name = document.getElementById('newSubscriberName').value.trim();

      if (!email) {
        showToast('Please enter an email address', 'error', 3000);
        return;
      }

      if (!email.includes('@') || !email.includes('.')) {
        showToast('Please enter a valid email address', 'error', 3000);
        return;
      }

      const subscribers = JSON.parse(localStorage.getItem('reportSubscribers') || '[]');

      // Check for duplicates
      if (subscribers.find(s => s.email.toLowerCase() === email.toLowerCase())) {
        showToast('Email address already exists', 'error', 3000);
        return;
      }

      // Add new subscriber
      const newSubscriber = {
        id: 'sub-' + Date.now(),
        email: email,
        name: name || null,
        added: new Date().toISOString(),
        active: true
      };

      subscribers.push(newSubscriber);
      localStorage.setItem('reportSubscribers', JSON.stringify(subscribers));

      // Clear inputs
      document.getElementById('newSubscriberEmail').value = '';
      document.getElementById('newSubscriberName').value = '';

      showToast(`Subscriber ${email} added successfully!`, 'success', 2000);

      // Refresh modal
      closeSubscribersModal();
      setTimeout(() => manageSubscribers(), 300);
    };

    window.deleteSubscriber = function(subscriberId) {
      const subscribers = JSON.parse(localStorage.getItem('reportSubscribers') || '[]');
      const subscriber = subscribers.find(s => s.id === subscriberId);

      if (!subscriber) return;

      if (confirm(`Delete subscriber ${subscriber.email}?`)) {
        const updatedSubscribers = subscribers.filter(s => s.id !== subscriberId);
        localStorage.setItem('reportSubscribers', JSON.stringify(updatedSubscribers));

        showToast(`Subscriber ${subscriber.email} deleted`, 'success', 2000);

        // Refresh modal
        closeSubscribersModal();
        setTimeout(() => manageSubscribers(), 300);
      }
    };

    window.editSubscriber = function(subscriberId) {
      const subscribers = JSON.parse(localStorage.getItem('reportSubscribers') || '[]');
      const subscriber = subscribers.find(s => s.id === subscriberId);

      if (!subscriber) return;

      const modal = document.createElement('div');
      modal.id = 'editSubscriberModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 26000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
            ✏️ Edit Subscriber
          </h3>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Address:</label>
            <input id="editSubscriberEmail" value="${subscriber.email}" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Name:</label>
            <input id="editSubscriberName" value="${subscriber.name || ''}" placeholder="Name (optional)" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
          </div>

          <div style="margin-bottom: 2rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="editSubscriberActive" ${subscriber.active ? 'checked' : ''} style="margin: 0;">
              <span style="font-weight: 600; color: #374151;">Active subscriber</span>
            </label>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeEditSubscriberModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151; font-weight: 500;">Cancel</button>
            <button onclick="saveEditedSubscriber('${subscriberId}')" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Save Changes</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeEditSubscriberModal(); };
    };

    window.closeEditSubscriberModal = function() {
      const modal = document.getElementById('editSubscriberModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.saveEditedSubscriber = function(subscriberId) {
      const email = document.getElementById('editSubscriberEmail').value.trim();
      const name = document.getElementById('editSubscriberName').value.trim();
      const active = document.getElementById('editSubscriberActive').checked;

      if (!email) {
        showToast('Please enter an email address', 'error', 3000);
        return;
      }

      if (!email.includes('@') || !email.includes('.')) {
        showToast('Please enter a valid email address', 'error', 3000);
        return;
      }

      const subscribers = JSON.parse(localStorage.getItem('reportSubscribers') || '[]');
      const subscriberIndex = subscribers.findIndex(s => s.id === subscriberId);

      if (subscriberIndex === -1) {
        showToast('Subscriber not found', 'error', 3000);
        return;
      }

      // Check for duplicates (excluding current subscriber)
      const existingSubscriber = subscribers.find(s => s.id !== subscriberId && s.email.toLowerCase() === email.toLowerCase());
      if (existingSubscriber) {
        showToast('Email address already exists', 'error', 3000);
        return;
      }

      // Update subscriber
      subscribers[subscriberIndex] = {
        ...subscribers[subscriberIndex],
        email: email,
        name: name || null,
        active: active,
        updated: new Date().toISOString()
      };

      localStorage.setItem('reportSubscribers', JSON.stringify(subscribers));

      closeEditSubscriberModal();
      showToast(`Subscriber updated successfully!`, 'success', 2000);

      // Refresh subscriber modal
      closeSubscribersModal();
      setTimeout(() => manageSubscribers(), 300);
    };

    window.exportSubscribers = function() {
      const subscribers = JSON.parse(localStorage.getItem('reportSubscribers') || '[]');

      if (subscribers.length === 0) {
        showToast('No subscribers to export', 'warning', 2000);
        return;
      }

      const csvContent = [
        ['Name', 'Email', 'Added Date', 'Status'],
        ...subscribers.map(s => [
          s.name || '',
          s.email,
          new Date(s.added).toLocaleDateString(),
          s.active ? 'Active' : 'Inactive'
        ])
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `report_subscribers_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      showToast('Subscribers exported successfully!', 'success', 2000);
    };

    window.importSubscribers = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const csv = e.target.result;
              const lines = csv.split('\n');
              const headers = lines[0].split(',');

              if (!headers.includes('Email')) {
                showToast('CSV must contain an Email column', 'error', 3000);
                return;
              }

              const subscribers = JSON.parse(localStorage.getItem('reportSubscribers') || '[]');
              let imported = 0;

              for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= headers.length && values[headers.indexOf('Email')]) {
                  const email = values[headers.indexOf('Email')].trim();
                  const name = headers.includes('Name') ? values[headers.indexOf('Name')].trim() : '';

                  if (email && !subscribers.find(s => s.email.toLowerCase() === email.toLowerCase())) {
                    subscribers.push({
                      id: 'sub-' + Date.now() + '-' + i,
                      email: email,
                      name: name || null,
                      added: new Date().toISOString(),
                      active: true
                    });
                    imported++;
                  }
                }
              }

              localStorage.setItem('reportSubscribers', JSON.stringify(subscribers));
              showToast(`Imported ${imported} new subscribers!`, 'success', 3000);

              // Refresh modal
              closeSubscribersModal();
              setTimeout(() => manageSubscribers(), 500);
            } catch (error) {
              showToast('Error importing CSV file', 'error', 3000);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    };

    window.editSchedule = function(reportId) {
      showToast(`Editing schedule for ${reportId}...`, 'info', 2000);
    };

    window.deleteSchedule = function(reportId) {
      if (confirm(`Delete schedule for ${reportId}?`)) {
        const schedules = JSON.parse(localStorage.getItem('reportSchedules') || '[]');
        const updated = schedules.filter(s => s.reportId !== reportId);
        localStorage.setItem('reportSchedules', JSON.stringify(updated));
        showToast(`Schedule for ${reportId} deleted!`, 'success', 2000);
        showAnalyticsSection('scheduled');
      }
    };

    window.runAllScheduled = function() {
      showToast('Running all scheduled reports...', 'info', 3000);
    };

    window.exportSchedules = function() {
      const schedules = JSON.parse(localStorage.getItem('reportSchedules') || '[]');
      const blob = new Blob([JSON.stringify(schedules, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `report_schedules_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      showToast('Schedules exported successfully!', 'success', 2000);
    };

    window.importSchedules = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const imported = JSON.parse(e.target.result);
              localStorage.setItem('reportSchedules', JSON.stringify(imported));
              showToast('Schedules imported successfully!', 'success', 2000);
              showAnalyticsSection('scheduled');
            } catch (error) {
              showToast('Invalid file format!', 'error', 3000);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    };

    // Data Governance Functions
    window.addDataPolicy = function() {
      const modal = document.createElement('div');
      modal.id = 'policyModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 25000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
            ➕ Create New Data Policy
          </h3>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Policy Name:</label>
            <input id="policyName" placeholder="Enter policy name" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Policy Type:</label>
            <select id="policyType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <option value="access">Access Control Policy</option>
              <option value="retention">Data Retention Policy</option>
              <option value="classification">Data Classification Policy</option>
              <option value="privacy">Privacy Protection Policy</option>
              <option value="compliance">Compliance Policy</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Data Categories:</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="catStudent" value="student"> Student Records
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="catFaculty" value="faculty"> Faculty Data
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="catFinancial" value="financial"> Financial Records
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="catResearch" value="research"> Research Data
              </label>
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Authorized Roles:</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="roleAdmin" value="admin"> Administrators
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="roleRegistrar" value="registrar"> Registrar
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="roleFaculty" value="faculty"> Faculty
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="roleFinance" value="finance"> Finance Team
              </label>
            </div>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Policy Description:</label>
            <textarea id="policyDescription" placeholder="Describe the policy requirements and restrictions..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; height: 100px; resize: vertical; font-size: 0.875rem;"></textarea>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Compliance Framework:</label>
            <select id="complianceFramework" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              <option value="ferpa">FERPA - Educational Records</option>
              <option value="gdpr">GDPR - Data Protection</option>
              <option value="sox">SOX - Financial Reporting</option>
              <option value="hipaa">HIPAA - Health Information</option>
              <option value="custom">Custom Framework</option>
            </select>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closePolicyModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151; font-weight: 500;">Cancel</button>
            <button onclick="saveDataPolicy()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Create Policy</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closePolicyModal(); };
    };

    window.closePolicyModal = function() {
      const modal = document.getElementById('policyModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.saveDataPolicy = function() {
      const name = document.getElementById('policyName').value.trim();
      const type = document.getElementById('policyType').value;
      const description = document.getElementById('policyDescription').value.trim();

      if (!name) {
        showToast('Please enter a policy name', 'error', 3000);
        return;
      }

      if (!description) {
        showToast('Please enter a policy description', 'error', 3000);
        return;
      }

      // Get selected categories and roles
      const categories = [];
      ['student', 'faculty', 'financial', 'research'].forEach(cat => {
        if (document.getElementById('cat' + cat.charAt(0).toUpperCase() + cat.slice(1)).checked) {
          categories.push(cat);
        }
      });

      const roles = [];
      ['admin', 'registrar', 'faculty', 'finance'].forEach(role => {
        if (document.getElementById('role' + role.charAt(0).toUpperCase() + role.slice(1)).checked) {
          roles.push(role);
        }
      });

      // Save policy
      const policies = JSON.parse(localStorage.getItem('dataPolicies') || '[]');
      const newPolicy = {
        id: 'policy-' + Date.now(),
        name,
        type,
        description,
        categories,
        roles,
        framework: document.getElementById('complianceFramework').value,
        created: new Date().toISOString(),
        status: 'active'
      };

      policies.push(newPolicy);
      localStorage.setItem('dataPolicies', JSON.stringify(policies));

      closePolicyModal();
      showToast(`Policy "${name}" created successfully!`, 'success', 3000);

      // Refresh the Data Governance section if visible
      const currentSection = document.querySelector('.analytics-nav-item[style*="background: #3b82f6"]');
      if (currentSection && currentSection.textContent.includes('Data Governance')) {
        showAnalyticsSection('governance');
      }
    };

    window.scanDataCompliance = function() {
      const modal = document.createElement('div');
      modal.id = 'scanModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 25000; display: flex;
        align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
          <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem;">
            🔍 Data Compliance Scan
          </h3>

          <div id="scanProgress" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span style="font-weight: 500; color: #374151;">Scanning in progress...</span>
              <span id="scanPercent" style="color: #6b7280;">0%</span>
            </div>
            <div style="background: #f3f4f6; border-radius: 8px; height: 8px; overflow: hidden;">
              <div id="scanBar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <div id="scanStatus" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">Initializing scan...</div>
          </div>

          <div id="scanResults" style="display: none;">
            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Scan Results</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
              <div style="background: #f0fdf4; border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid #22c55e;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;" id="compliantCount">0</div>
                <div style="font-size: 0.875rem; color: #166534;">Compliant</div>
              </div>
              <div style="background: #fef3c7; border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid #f59e0b;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;" id="warningCount">0</div>
                <div style="font-size: 0.875rem; color: #92400e;">Warnings</div>
              </div>
              <div style="background: #fef2f2; border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid #dc2626;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;" id="violationCount">0</div>
                <div style="font-size: 0.875rem; color: #991b1b;">Violations</div>
              </div>
            </div>

            <div id="scanDetails" style="background: #f9fafb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
              <h5 style="margin: 0 0 1rem 0; color: #1f2937;">Detailed Findings</h5>
              <div id="findingsList"></div>
            </div>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeScanModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; color: #374151; font-weight: 500;">Close</button>
            <button id="exportScanBtn" onclick="exportScanResults()" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: none;">📤 Export Results</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeScanModal(); };

      // Start the scanning simulation
      startComplianceScan();
    };

    window.startComplianceScan = function() {
      const steps = [
        { text: 'Analyzing student data classifications...', duration: 1000 },
        { text: 'Checking FERPA compliance...', duration: 800 },
        { text: 'Scanning financial record access...', duration: 1200 },
        { text: 'Validating GDPR requirements...', duration: 900 },
        { text: 'Reviewing access control policies...', duration: 700 },
        { text: 'Generating compliance report...', duration: 600 }
      ];

      let currentStep = 0;
      let progress = 0;

      function updateProgress() {
        if (currentStep < steps.length) {
          const step = steps[currentStep];
          document.getElementById('scanStatus').textContent = step.text;

          setTimeout(() => {
            progress += (100 / steps.length);
            document.getElementById('scanBar').style.width = progress + '%';
            document.getElementById('scanPercent').textContent = Math.round(progress) + '%';

            currentStep++;
            if (currentStep < steps.length) {
              updateProgress();
            } else {
              completeScan();
            }
          }, step.duration);
        }
      }

      updateProgress();
    };

    window.completeScan = function() {
      // Hide progress, show results
      document.getElementById('scanProgress').style.display = 'none';
      document.getElementById('scanResults').style.display = 'block';
      document.getElementById('exportScanBtn').style.display = 'inline-block';

      // Simulate scan results
      const results = {
        compliant: 156,
        warnings: 8,
        violations: 3
      };

      document.getElementById('compliantCount').textContent = results.compliant;
      document.getElementById('warningCount').textContent = results.warnings;
      document.getElementById('violationCount').textContent = results.violations;

      // Generate findings
      const findings = [
        { type: 'violation', message: 'Financial records accessible to unauthorized roles', severity: 'high' },
        { type: 'violation', message: 'Student SSN data not properly encrypted', severity: 'high' },
        { type: 'violation', message: 'Missing audit trail for data exports', severity: 'medium' },
        { type: 'warning', message: 'GDPR consent forms require review', severity: 'medium' },
        { type: 'warning', message: 'Data retention policy approaching limits', severity: 'low' },
        { type: 'warning', message: 'Access logs show unusual patterns', severity: 'medium' }
      ];

      const findingsHtml = findings.map(finding => `
        <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; background: ${
          finding.type === 'violation' ? '#fef2f2' : '#fef3c7'
        }; border-left: 4px solid ${finding.type === 'violation' ? '#dc2626' : '#f59e0b'};">
          <div style="font-size: 1.25rem;">${finding.type === 'violation' ? '🚫' : '⚠️'}</div>
          <div style="flex: 1;">
            <div style="font-weight: 500; color: #1f2937;">${finding.message}</div>
            <div style="font-size: 0.875rem; color: #6b7280;">Severity: ${finding.severity}</div>
          </div>
        </div>
      `).join('');

      document.getElementById('findingsList').innerHTML = findingsHtml;

      showToast('Compliance scan completed! Review findings for action items.', 'success', 4000);
    };

    window.closeScanModal = function() {
      const modal = document.getElementById('scanModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    };

    window.exportScanResults = function() {
      const scanData = {
        scanDate: new Date().toISOString(),
        summary: {
          compliant: 156,
          warnings: 8,
          violations: 3
        },
        findings: [
          { type: 'violation', message: 'Financial records accessible to unauthorized roles', severity: 'high' },
          { type: 'violation', message: 'Student SSN data not properly encrypted', severity: 'high' },
          { type: 'violation', message: 'Missing audit trail for data exports', severity: 'medium' },
          { type: 'warning', message: 'GDPR consent forms require review', severity: 'medium' },
          { type: 'warning', message: 'Data retention policy approaching limits', severity: 'low' },
          { type: 'warning', message: 'Access logs show unusual patterns', severity: 'medium' }
        ]
      };

      const jsonContent = JSON.stringify(scanData, null, 2);
      const blob = new Blob([jsonContent], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `compliance_scan_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      showToast('Scan results exported successfully!', 'success', 2000);
    };

    // Audit Trail Functions
    window.exportAuditLog = function() {
      const auditData = [
        ['Timestamp', 'User', 'Action', 'Target', 'IP Address', 'Status'],
        [new Date().toLocaleString(), 'current.user@university.edu', 'Export Audit Log', 'Audit Trail', '192.168.1.100', 'success']
      ];

      const csvContent = auditData.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      showToast('Audit log exported successfully!', 'success', 2000);
    };

    window.generateAuditReport = function() {
      showToast('Generating comprehensive audit report...', 'info', 3000);
      setTimeout(() => {
        showToast('Audit report generated! Check your downloads.', 'success', 3000);
      }, 3000);
    };

    // Initialize analytics state and auto-restore
    initializeAnalyticsState();
    document.addEventListener('DOMContentLoaded', autoRestoreAnalyticsDashboard);


  </script>

  <!-- Flow Cookie Consent System -->
  <script src="/assets/js/cookie-consent.js"></script>
</body>
</html>